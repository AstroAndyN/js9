var $jscomp={scope:{}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,d,c){if(c.get||c.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[d]=c.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(a){return $jscomp.SYMBOL_PREFIX+(a||"")+$jscomp.symbolCounter_++};
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(a){var d=0;return $jscomp.iteratorPrototype(function(){return d<a.length?{done:!1,value:a[d++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};$jscomp.makeIterator=function(a){$jscomp.initSymbolIterator();$jscomp.initSymbol();$jscomp.initSymbolIterator();var d=a[Symbol.iterator];return d?d.call(a):$jscomp.arrayIterator(a)};$jscomp.arrayFromIterator=function(a){for(var d,c=[];!(d=a.next()).done;)c.push(d.value);return c};$jscomp.arrayFromIterable=function(a){return a instanceof Array?a:$jscomp.arrayFromIterator($jscomp.makeIterator(a))};
$jscomp.array=$jscomp.array||{};$jscomp.iteratorFromArray=function(a,d){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var c=0,b={next:function(){if(c<a.length){var e=c++;return{value:d(e,a[e]),done:!1}}b.next=function(){return{done:!0,value:void 0}};return b.next()}};b[Symbol.iterator]=function(){return b};return b};
$jscomp.polyfill=function(a,d,c,b){if(d){c=$jscomp.global;a=a.split(".");for(b=0;b<a.length-1;b++){var e=a[b];e in c||(c[e]={});c=c[e]}a=a[a.length-1];b=c[a];d=d(b);d!=b&&null!=d&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:d})}};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6-impl","es3");
$jscomp.polyfill("Math.asinh",function(a){return a?a:function(a){a=Number(a);if(0===a)return a;var c=Math.log(Math.abs(a)+Math.sqrt(a*a+1));return 0>a?-c:c}},"es6-impl","es3");$jscomp.polyfill("Math.sinh",function(a){if(a)return a;var d=Math.exp;return function(a){a=Number(a);return 0===a?a:(d(a)-d(-a))/2}},"es6-impl","es3");$jscomp.findInternal=function(a,d,c){a instanceof String&&(a=String(a));for(var b=a.length,e=0;e<b;e++){var f=a[e];if(d.call(c,f,e,a))return{i:e,v:f}}return{i:-1,v:void 0}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,c){return $jscomp.findInternal(this,a,c).v}},"es6-impl","es3");$jscomp.polyfill("Array.prototype.fill",function(a){return a?a:function(a,c,b){var d=this.length||0;0>c&&(c=Math.max(0,d+c));if(null==b||b>d)b=d;b=Number(b);0>b&&(b=Math.max(0,d+b));for(c=Number(c||0);c<b;c++)this[c]=a;return this}},"es6-impl","es3");$jscomp.polyfill("Math.log10",function(a){return a?a:function(a){return Math.log(a)/Math.LN10}},"es6-impl","es3");
var Module;"object"!==typeof Module&&(Module={});
var JS9=function(){var a={NAME:"JS9",VERSION:"2.4",COPYRIGHT:"Copyright (c) 2012-2019 Smithsonian Institution",DEFID:"JS9",WIDTH:512,HEIGHT:512,ANON:"Anonymous",PREFSFILE:"js9Prefs.json",WORKERFILE:"js9worker.js",ZINDEX:0,SHAPEZINDEX:4,MESSZINDEX:80,BTNZINDEX:90,MENUZINDEX:1E3,COLORSIZE:1024,SCALESIZE:16384,INVSIZE:1024,HISTSIZE:16384,INSTALLDIR:"",TOROOT:"",PLUGINS:"",LIGHTWIN:"dhtml",ANTIALIAS:!1,SCALEIREG:!0,NOMOVE:3,DBLCLICK:300,TIMEOUT:250,SPINOUT:250,SUPERMENU:/^SUPERMENU_/,RESIZEDIST:20,RESIZEFUDGE:5,
RAWID0:"raw0",RAWIDX:"alt",IDFMT:"  (%s)",MINZOOM:.125,MAXZOOM:32,ADDZOOM:.1,CHROMEFILEWARNING:!0,CLIPBOARDERROR:"the local clipboard (which only holds data copied from within JS9) does not contain any content. Were you trying to paste something copied outside JS9?",CLIPBOARDERROR2:"the local clipboard (which only holds data copied from within JS9) does not contain any regions",URLEXP:/^(https?|ftp):\/\//};a.TOUCHSUPPORTED=window.hasOwnProperty("ontouchstart")||0<navigator.maxTouchPoints||0<navigator.msMaxTouchPoints;
a.BROWSER=function(){var a=navigator.platform,c=navigator.appName,b=navigator.userAgent,e=b.match(/version\/([.\d]+)/i),f=b.match(/(opera|chrome|safari|firefox|msie)\/?\s*(\.?\d+(\.\d+)*)/i);f&&null!==e&&(f[2]=e[1]);f=f?[f[1],f[2],a]:[c,navigator.appVersion,"-?",a];f.push(/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(b));return f}();a.PIXEL_RATIO=function(){var a=document.createElement("canvas").getContext("2d");return(window.devicePixelRatio||1)/(a.webkitBackingStorePixelRatio||a.mozBackingStorePixelRatio||
a.msBackingStorePixelRatio||a.oBackingStorePixelRatio||a.backingStorePixelRatio||1)}();a.globalOpts={helperType:"none",helperPort:2718,requireHelper:!1,allinoneHelper:!1,requireFits2Fits:!1,quietReturn:!1,useWasm:!0,allowFileWasm:!1,winType:"light",rgb:{active:!1,rim:null,gim:null,bim:null},defcolor:"#00FF00",pngisfits:!0,fits2fits:"never",fits2png:!1,localAccess:!0,prependJS9Dir:!0,dataDir:null,alerts:!0,valposTarget:null,valposWidth:"medium",internalValPos:!0,internalContrastBias:!0,containContrastBias:!1,
wcsCrosshair:!1,regionsToClipboard:!0,magnifierRegions:!0,pannerDirections:!0,htimeout:1E4,lhtimeout:1E4,ehtimeout:500,ehretries:20,xtimeout:18E4,extlist:"EVENTS STDEVT",imopts:"IMOPTS",imcmap:"IMCMAP",table:{xdim:4096,ydim:4096,bin:1},image:{xdim:4096,ydim:4096,bin:1},reproj:{xdim:4096,ydim:4096},reprojSwitches:"",binMode:"s",clearImageMemory:"heap",helperProtocol:location.protocol,reloadRefresh:!1,reloadRefreshReg:!0,panWithinDisplay:!1,svgBorder:!0,unremoveReg:100,maxMemory:1E9,corsURL:"params/loadcors.html",
proxyURL:"params/loadproxy.html",loadProxy:!1,imsectionURL:"params/imsection.html",postMessage:!1,localStorage:!0,waitType:"spinner",spinColor:"#FF0000",spinOpacity:.35,resize:!0,resizeHandle:!0,resizeRedisplay:!0,cloneNewDisplay:!0,logoDisplay:!1,lightWinClose:"ask",regionDisplay:"lightwin",regionConfigSize:"medium",refreshDragDrop:!0,reduceMosaic:"js9",internalRegcnts:!0,reduceRegcnts:!0,plot3d:{cube:"*:*:all",mode:"avg",areaunits:"pixels",color:"green"},imexamLineHeight:1,copyWcsPosFormat:"$ra $dec $sys",
floatPrecision:6,mouseActions:["display value/position","change contrast/bias","pan the image"],touchActions:["display value/position","change contrast/bias","pan the image"],keyboardActions:{b:"toggle selected region: source/background",c:"toggle crosshair",d:"send selected region to back",e:"toggle selected region: include/exclude","M-e":"edit selected region",i:"refresh image",I:"display full image","M-i":"display selected cutouts","M-k":"toggle keyboard actions plugin",l:"toggle active shape layers",
"M-l":"new JS9 light window","M-m":"toggle mouse/touch plugin","M-o":"open local file",P:"paste regions from local clipboard",p:"paste regions to current position",u:"undo remove of region(s)","M-,":"toggle preferences plugin","M-p":"toggle preferences plugin",r:"copy selected region to clipboard",R:"copy all regions to clipboard",s:"select region",S:"select all regions","M-s":"toggle shape layers plugin","/":"copy wcs position to clipboard","?":"copy value and position to clipboard",0:"reset zoom",
"=":"zoom in","+":"zoom in","-":"zoom out","^":"raise region layer to top",">":"display next image","<":"display previous image","delete":"remove selected region",leftArrow:"move region/position left",upArrow:"move region/position up",rightArrow:"move region/position right",downArrow:"move region/position down"},mousetouchZoom:!1,toolbarTooltips:!1,centerDivs:["JS9Menubar"],resizeDivs:["JS9Menubar","JS9Colorbar","JS9Toolbar"],pinchWait:8,pinchThresh:6,xeqPlugins:!0,extendedPlugins:!0,intensivePlugins:!1,
dynamicSelect:"click",dynamicHighlight:!0,corsProxy:"https://js9.si.edu/cgi-bin/CORS-proxy.cgi",simbadProxy:"https://js9.si.edu/cgi-bin/simbad-proxy.cgi",catalogs:{ras:["RA","_RAJ2000","RAJ2000"],decs:["Dec","_DEJ2000","DEJ2000"],shape:"circle",color:"yellow",width:7,height:7,radius:3.5,r1:5,r2:3.5,wcssys:"ICRS",skip:"#\n",save:!0,tooltip:"$xreg.data.ra $xreg.data.dec"},topColormaps:"grey heat cool viridis magma sls red green blue".split(" "),infoBox:"file object wcsfov wcscen wcspos impos physpos value regions progress".split(" "),
infoBoxResize:!0,menuBar:"file edit view zoom scale color region wcs analysis help".split(" "),menubarStyle:"classic",userMenus:!1,userMenuDivider:"&nbsp;&nbsp;&nbsp;",imagesFileSubmenu:5,toolBar:"annulus box circle ellipse line polygon text linear log zoom+ zoom- zoom1".split(" "),syncOps:"colormap contrastbias pan regions scale wcs zoom".split(" "),syncReciprocate:!0,hiddenPluginDivs:[],separate:{layout:"auto",leftMargin:10,topMargin:10},imageTemplates:".fits,.fts,.png,.jpg,.jpeg,.fz",wcsUnits:{FK4:"sexagesimal",
FK5:"sexagesimal",ICRS:"sexagesimal",galactic:"degrees",ecliptic:"degrees",linear:"degrees",physical:"pixels",image:"pixels"},regionTemplates:".reg",sessionTemplates:".ses,.js9ses",colormapTemplates:".cmap",catalogTemplates:".cat,.tab",localTemplates:".fits,.fts",controlsMatchRegion:!1,internalColorPicker:!0,newWindowWidth:530,newWindowHeight:625,debug:0};a.desktopOpts={currentPath:!0,sessionPath:!0};a.imageOpts={inherit:!1,contrast:1,bias:.5,invert:!1,exp:1E3,colormap:"grey",scale:"linear",scaleclipping:"dataminmax",
scalemin:Number.NaN,scalemax:Number.NaN,zscalecontrast:.25,zscalesamples:600,zscaleline:120,wcssys:"native",lcs:"physical",valpos:!0,opacity:1,sigma:"none",maskOpacity:.4,alpha:255,alpha1:100,zoom:1,zooms:5,nancolor:"#000000",wcsalign:!0,rotationMode:"relative",crosshair:!1,disable:[],ltvbug:!0,listonchange:!1,whichonchange:"selected"};a.regionOpts={};a.catalogOpts={};a.crosshairOpts={};a.gridOpts={};a.emscriptenOpts={};a.blendOpts={active:!0,mode:"screen",opacity:1};a.analOpts={epattern:/^(ERROR:[^\n]*)\n/,
dpathURL:"params/datapath.html",fpathURL:"params/filepath.html"};a.lightOpts={nclick:0,dhtml:{top:".dhtmlwindow",drag:".drag-contentarea",dragBar:"drag-handle",format:"width=%spx,height=%spx,center=1,resize=%s,scrolling=0",textWin:"width=830px,height=400px,center=1,resize=1,scrolling=1",plotWin:"width=830px,height=420px,center=1,resize=1,scrolling=1",dpathWin:"width=830px,height=175px,center=1,resize=1,scrolling=1",lcloseWin:"width=512px,height=190px,center=1,resize=1,scrolling=1",paramWin:"width=830px,height=235px,center=1,resize=1,scrolling=1",
regWin0:"width=600px,height=72px,center=1,resize=1,scrolling=1",regWin:"width=600px,height=235px,center=1,resize=1,scrolling=1",imageWin:"width=512px,height=598px,center=1,resize=1,scrolling=1",lineWin:"width=400px,height=60px,center=1,resize=1,scrolling=1"},lcloseURL:"params/lightclose.html"};a.textColorOpts={regions:"#00FF00",info:"#00FF00",inimage:"#000000"};a.plotOpts={annotate:!1,annotateColor:"#FF0000",color:"blue",zoomStack:{enabled:!0},selection:{mode:"xy"},series:{clickable:!0,hoverable:!0,
lines:{show:!0},points:{show:!1}},legend:{backgroundColor:null,backgroundOpacity:0},xaxis:{autorange:!0},yaxis:{autorange:!0}};a.helpOpts={user:{heading:"JS9Help",type:"help",url:"user.html",title:"User Manual"},install:{heading:"JS9Help",type:"help",url:"install.html",title:"Installing JS9"},webpage:{heading:"JS9Help",type:"help",url:"webpage.html",title:"Adding JS9 to a Web Page"},yourdata:{heading:"JS9Help",type:"help",url:"yourdata.html",title:"Adding Data to a Web Page"},localtasks:{heading:"JS9Help",
type:"help",url:"localtasks.html",title:"Adding Local Analysis Tasks and Plugins"},helper:{heading:"JS9Help",type:"help",url:"helper.html",title:"Adding Server-side Analysis Tasks"},serverside:{heading:"JS9Help",type:"help",url:"serverside.html",title:"Server-side Analysis with JS9"},publicapi:{heading:"JS9Help",type:"help",url:"publicapi.html",title:"The JS9 Public API"},extmsg:{heading:"JS9Help",type:"help",url:"extmsg.html",title:"External Messaging"},desktop:{heading:"JS9Help",type:"help",url:"desktop.html",
title:"JS9 on the Desktop"},python:{heading:"JS9Help",type:"help",url:"python.html",title:"JS9 with Python and Jupyter"},archives:{heading:"JS9Help",type:"help",url:"archives.html",title:"Accessing Data Archives"},preferences:{heading:"JS9Help",type:"help",url:"preferences.html",title:"Setting Site Preferences"},regions:{heading:"JS9Help",type:"help",url:"regions.html",title:"Regions Format"},changelog:{heading:"JS9Help",type:"help",url:"changelog.html",title:"ChangeLog"},repfile:{heading:"JS9Help",
type:"help",url:"repfile.html",title:"Dealing with Large Files"},memory:{heading:"JS9Help",type:"help",url:"memory.html",title:"Dealing with Memory Limitations"},issues:{heading:"JS9Help",type:"help",url:"knownissues.html",title:"Known Issues"}};a.images=[];a.displays=[];a.colormaps=[];a.commands=[];a.plugins=[];a.preloads=[];a.auxFiles=[];a.supermenus=[];a.publics={};a.helper={};a.fits={};a.userOpts={};a.preloadwaiting={};a.scales="linear log histeq power sqrt squared asinh sinh".split(" ");a.wcssyss=
"FK4 FK5 ICRS galactic ecliptic native image physical".split(" ");a.wcsunitss=["degrees","sexagesimal","pixels"];a.bugs={};a.bugs.hide_menu=!1;"Firefox"===a.BROWSER[0]&&0<=a.BROWSER[2].search(/Linux/)&&(a.bugs.firefox_linux=!0);if("Chrome"===a.BROWSER[0]||"Safari"===a.BROWSER[0])a.bugs.webkit_resize=!0;"Chrome"!==a.BROWSER[0]&&(a.globalOpts.imageTemplates+=",.gz");/iPad|iPhone|iPod/.test(navigator.platform)&&/11_2_(?:[2-9])/.test(navigator.userAgent)&&(a.globalOpts.useWasm=!1);a.BROWSER[3]&&(a.globalOpts.maxMemory=
Math.min(a.globalOpts.maxMemory,35E7),a.globalOpts.table.xdim=2048,a.globalOpts.table.ydim=2048,a.globalOpts.image.xdim=2048,a.globalOpts.image.ydim=2048,a.imageOpts.crosshair=!1,a.globalOpts.reproj={xdim:2048,ydim:2048});window.hasOwnProperty("Jupyter")&&(a.globalOpts.useWasm=!1);if(window.isElectron){"Chrome"===a.BROWSER[0]&&66<=parseFloat(a.BROWSER[1])&&(a.globalOpts.allowFileWasm=!0);if(!window.electronVersion||5>parseInt(window.electronVersion,10))a.globalOpts.internalColorPicker=!1;a.hasNode=
"object"===typeof process&&"function"===typeof require;a.hasNode&&(a.localMount=require("os").hostname()||"localAccess");window.multiElectron&&(a.globalOpts.localStorage=!1)}a.Image=function(d,c,b){var e,f,g=null,h=0,k=0,l=this,n=function(b){b=b||{};a.isNull(b.scaleclipping)?"zscale"===this.params.scaleclipping?this.zscale(!0):"zmax"===this.params.scaleclipping&&this.zscale("zmax"):"zscale"===b.scaleclipping?this.zscale(!0):"zmax"===b.scaleclipping&&this.zscale("zmax");a.notNull(b.scalemin)&&(this.params.scalemin=
b.scalemin);a.notNull(b.scalemax)&&(this.params.scalemax=b.scalemax)},m=function(b){var c,d,e,f,k=a.globalOpts.imopts,h=a.globalOpts.imcmap,l=a.globalOpts.alerts;this.display.clearMessage();a.images.push(this);this.notifyHelper();this.showShapeLayer("regions",!0,{local:!0});g&&g.regions&&this.addShapes("regions",g.regions);a.globalOpts.alerts=!1;if(this.raw&&this.raw.header&&this.raw.header[h]){try{e=JSON.parse(this.raw.header[h])}catch(A){e=null}if(e)try{a.AddColormap(e)}catch(A){}}if(this.raw&&
this.raw.header&&this.raw.header[h+"1"]){c=1;for(d="";100>c;c++)if(f=h+String(c),this.raw.header[f])d+=this.raw.header[f];else break;if(d){try{e=JSON.parse(d)}catch(A){e=null}if(e)try{a.AddColormap(e)}catch(A){}}}if(this.raw&&this.raw.header&&this.raw.header[k]){try{e=JSON.parse(this.raw.header[k])}catch(A){e=null}if(e)try{this.setParam("all",e)}catch(A){}}if(this.raw&&this.raw.header&&this.raw.header[k+"1"]){c=1;for(d="";100>c;c++)if(f=k+String(c),this.raw.header[f])d+=this.raw.header[f];else break;
if(d){try{e=JSON.parse(d)}catch(A){e=null}if(e)try{this.setParam("all",e)}catch(A){}}}a.globalOpts.alerts=l;this.xeqPlugins("image","onimageload");this.updateshapes&&this.updateShapes("regions","all","update");this.status.load="complete";a.waiting(!1);if(b)try{a.xeqByName(b,window,this)}catch(A){a.error("in image onload callback",A,!1)}d=this.proxyURL||this.file;b=d.replace(/\[.*\]/,"");if(a.preloadwaiting[d]||a.preloadwaiting[b])if(delete a.preloadwaiting[d],delete a.preloadwaiting[b],!Object.keys(a.preloadwaiting).length&&
a.notNull(a.globalOpts.onpreload))try{a.xeqByName(a.globalOpts.onpreload,window,this)}catch(A){a.error("in onpreload callback",A,!1)}g&&g.allext&&this.hdus&&0<this.hdus.length&&this.displayExtension("all")};c&&("object"===typeof c?(g=c,g.display&&(e=g.display)):e=c);e||(e=0<a.displays.length?a.displays[0].id:a.DEFID);this.type="image";this.display=a.lookupDisplay(e);this.params={};this.regstack=[];this.tmp={};this.params.xeqonchange=!0;this.params=$.extend(!0,this.params,a.imageOpts,g);this.display.image&&
(this.params.inherit=this.display.image.params.inherit,this.params.inherit&&(this.params=$.extend(!0,this.params,this.display.image.params)));c=a.globalOpts.xeqPlugins;a.globalOpts.xeqPlugins=!1;this.setColormap(this.params.colormap);a.globalOpts.xeqPlugins=c;this.displayMode=!0;this.clickState=0;this.clickInRegion=!1;this.clickInLayer=null;this.queried=!1;g&&g.proxyFile&&(this.proxyFile=g.proxyFile);g&&g.proxyURL&&(this.proxyURL=g.proxyURL);g&&g.parentFile&&(this.parentFile=g.parentFile);if(g&&g.parent&&
(this.parent=g.parent,this.parent.cardstr&&this.parent.ncard)){this.parent.raw={header:{},history:[],comments:[]};for(c=0;c<this.parent.ncard;c++)e=this.parent.cardstr.slice(80*c,80*(c+1)),e=a.cardpars(e),void 0!==e&&("HISTORY"===e[0]?this.parent.raw.header[e[0]+"__"+h++]=e[1]:"COMMENT"===e[0]?this.parent.raw.header[e[0]+"__"+k++]=e[1]:this.parent.raw.header[e[0]]=e[1]);this.parent.lcs={};a.Image.prototype.initLCS.call(this.parent,this.parent.raw.header)}g&&g.id&&(this.id=g.id);this.iy=this.ix=0;
this.png={};this.png.image=new Image;this.status={};this.rgb={};this.rgb.sect={zoom:1,ozoom:1};this.layers={};this.zlayer=a.SHAPEZINDEX;this.lcs={};this.aux={};this.binning={bin:1,obin:1};this.raws=[];this.blend=$.extend(!0,{},a.blendOpts);this.updateshapes=!1;if(d)switch(a.waiting(!0,this.display),typeof d){case "object":this.source=g.source||"fits";this.mkRawDataFromHDU(d,$.extend({},{file:d.filename},g));n.call(this,g);this.params.zoom&&(f=this.parseZoom(this.params.zoom),this.rgb.sect.zoom=f,
this.rgb.sect.ozoom=f);this.mkSection();g&&g.rgbFile?(this.rgbFile=g.rgbFile,$(this.png.image).on("load",function(){var c;if(l.png.image.width!==l.raw.width||l.png.image.height!==l.raw.height)c=sprintf("rgb dims [%s,%s] don't match image [%s,%s]",l.png.image.width,l.png.image.height,l.raw.width,l.raw.height),a.error(c);l.mkOffScreenCanvas();l.displayImage("all",g);m.call(l,b)}).on("error",function(){a.waiting(!1);l.status.load="error";a.error("could not load image: "+l.id)}),this.png.image.src=this.rgbFile):
(this.displayImage("all",g),m.call(this,b));break;case "string":this.source=g.source||"fits2png";this.imtab="image";this.file=a.cleanPath(d);this.id0=this.file.split("/").reverse()[0];this.id=a.getImageID(this.id0,this.display.id);this.status.load="loading";$(this.png.image).on("load",function(){l.mkOffScreenCanvas();l.mkRawDataFromPNG();l.params.zoom&&(f=l.parseZoom(l.params.zoom),l.rgb.sect.zoom=f,l.rgb.sect.ozoom=f);n.call(l,g);l.mkSection();l.displayImage("all",g);m.call(l,b);a.DEBUG&&a.log("JS9 image: %s dims(%d,%d) min/max(%d,%d)",
l.file,l.raw.width,l.raw.height,l.raw.dmin,l.raw.dmax)}).on("error",function(){a.waiting(!1);l.status.load="error";a.error("could not load image: "+l.id)});this.png.image.src=d;break;default:a.error("unknown specification type for Load: "+typeof d)}};a.Image.prototype.getImageData=function(a){var c=null,b=this.fileDimensions();if(a)if("array"===a)c=Array.prototype.slice.call(this.raw.data);else if("base64"===a){var c="",d=new Uint8Array(this.raw.data.buffer),f=d.byteLength;for(a=0;a<f;a++)c+=String.fromCharCode(d[a]);
c=window.btoa(c)}else a&&"false"!==a&&(c=this.raw.data);return{id:this.id,file:this.file,fits:this.fitsFile||"",source:this.source,imtab:this.imtab,width:this.raw.width,height:this.raw.height,bitpix:this.raw.bitpix,bin:this.binning.bin,header:this.raw.header,hdus:this.hdus,fwidth:b.xdim,fheight:b.ydim,dwidth:this.display.width,dheight:this.display.height,data:c}};a.Image.prototype.closeImage=function(d){var c,b,e,f,g=!1;b=a.images.length;f=a.Dysel.getDisplayOr(this.display);d=d||{};if("string"===
typeof d)try{d=JSON.parse(d)}catch(h){a.error("can't parse closeImage opts: "+d,h)}for(c=0;c<b;c++)if(this===a.images[c]){b=a.images[c];b===b.display.image&&(g=c+1);if(g)for(e in!1!==d.clear&&(b.display.clearMessage(),b.display.context.clear()),b.layers)b.layers.hasOwnProperty(e)&&("main"!==b.layers[e].dlayer.dtype&&b.display!==f||b.showShapeLayer(e,!1,{local:!0}));b.xeqPlugins("image","onimageclose");g&&(b.display.image=null);switch(b.cmapObj.name){case "red":a.globalOpts.rgb.rim=null;break;case "green":a.globalOpts.rgb.gim=
null;break;case "blue":a.globalOpts.rgb.bim=null}for(d=0;d<b.raws.length;d++)e=b.raws[d],e.hdu&&e.hdu.fits&&(f=a.lookupVfile(e.hdu.fits.vfile),1>=f.length&&a.cleanupFITSFile(e,!0)),e.altwcs&&this.freeWCS(e);b.removeProxyFile();b.rgb=null;b.offscreen=null;b.raw=null;b.colorData=null;b.colorCells=null;b.psColors=null;b.psInverse=null;a.images.splice(c,1);break}if(g){for(c=g-=2;0<=c;c--)if(b=a.images[c],this.display===b.display){b.displayImage("all");b.refreshLayers();g=a.images.length;break}for(c=a.images.length-
1;c>g;c--)if(b=a.images[c],this.display===b.display){b.displayImage("all");b.refreshLayers();break}}};a.Image.prototype.mkOffScreenCanvas=function(){if(!this.png||!this.png.image)return this;this.offscreen={};this.offscreen.canvas=document.createElement("canvas");this.offscreen.canvas.setAttribute("width",this.png.image.width);this.offscreen.canvas.setAttribute("height",this.png.image.height);this.offscreen.context=this.offscreen.canvas.getContext("2d");a.ANTIALIAS||(this.offscreen.context.imageSmoothingEnabled=
!1,this.offscreen.context.webkitImageSmoothingEnabled=!1,this.offscreen.context.msImageSmoothingEnabled=!1);this.offscreen.context.drawImage(this.png.image,0,0);try{this.offscreen.img=this.offscreen.context.getImageData(0,0,this.png.image.width,this.png.image.height)}catch(d){a.CHROMEFILEWARNING&&"Chrome"===a.BROWSER[0]&&""===document.domain?alert("When using the file:// URI, Chrome must be run with the --allow-file-access-from-files switch to permit JS9 to access data."):alert("could not read off-screen image data [same-origin policy violation?]")}return this};
a.Image.prototype.initLCS=function(d){var c,b,e=[[0,0,0],[0,0,0],[0,0,0]];d=d||this.raw.header;var f=d.CRPIX1||1,g=d.CRPIX2||1,h=-(d.CROTA2||0)*Math.PI/180,k=Math.sin(h),l=Math.cos(h);h&&(b=[[0,0,0],[0,0,0],[0,0,0]],b[0][0]=l,b[0][1]=-k,b[0][2]=0,b[1][0]=k,b[1][1]=l,b[1][2]=0,(c=a.invertMatrix3(b))||(b=null));e[0][0]=d.LTM1_1||1;e[1][0]=d.LTM2_1||0;e[0][1]=d.LTM1_2||0;e[1][1]=d.LTM2_2||1;e[2][0]=d.LTV1||0;e[2][1]=d.LTV2||0;"image"===this.imtab&&this.params.ltvbug&&(void 0!==d.LTV1&&1>e[0][0]&&(e[2][0]+=
.5*e[0][0]),void 0!==d.LTV2&&1>e[1][1]&&(e[2][1]+=.5*e[1][1]));this.lcs.physical={forward:$.extend(!0,[],e),reverse:a.invertMatrix3(e)};this.lcs.physical.reverse?b&&(this.lcs.physical.frot=$.extend(!0,[],b),this.lcs.physical.rrot=$.extend(!0,[],c),this.lcs.physical.cx=f-e[2][0]-1,this.lcs.physical.cy=g-e[2][1]-1):delete this.lcs.physical;e[0][0]=d.DTM1_1||1;e[1][0]=d.DTM2_1||0;e[0][1]=d.DTM1_2||0;e[1][1]=d.DTM2_2||1;e[2][0]=d.DTV1||0;e[2][1]=d.DTV2||0;this.lcs.detector={forward:$.extend(!0,[],e),
reverse:a.invertMatrix3(e)};this.lcs.detector.reverse?b&&(this.lcs.detector.frot=$.extend(!0,[],b),this.lcs.detector.rrot=$.extend(!0,[],c),this.lcs.detector.cx=f-e[2][0]-1,this.lcs.detector.cy=g-e[2][1]-1):delete this.lcs.detector;e[0][0]=d.ATM1_1||1;e[1][0]=d.ATM2_1||0;e[0][1]=d.ATM1_2||0;e[1][1]=d.ATM2_2||1;e[2][0]=d.ATV1||0;e[2][1]=d.ATV2||0;this.lcs.amplifier={forward:$.extend(!0,[],e),reverse:a.invertMatrix3(e)};this.lcs.amplifier.reverse?b&&(this.lcs.amplifier.frot=$.extend(!0,[],b),this.lcs.amplifier.rrot=
$.extend(!0,[],c),this.lcs.amplifier.cx=f-e[2][0]-1,this.lcs.amplifier.cy=g-e[2][1]-1):delete this.lcs.amplifier;this.params&&!this.lcs[this.params.lcs]&&(this.params.lcs="image");this.params&&!this.params.wcssys0&&(this.setWCSSys("physical"),this.params.wcssys0=this.params.lcs);this.lcs.physical&&!this.lcs.ophysical&&(this.lcs.ophysical=$.extend(!0,{},this.lcs.physical));return this};a.Image.prototype.mkRawDataFromIMG=function(d){var c,b,e,f,g,h;if(d){c=d.height;b=d.width;e=d.data;this.raws.push({from:"img"});
this.raw=this.raws[this.raws.length-1];this.raw.id=a.RAWID0;this.raw.data=new Float32Array(c*b);for(g=d=0;g<c;g++)for(f=0;f<b;f++)h=.299*e[d]+.587*e[d+1]+.114*e[d+2],this.raw.data[(c-g)*b+f]=h,d+=4;this.raw.width=b;this.raw.height=c;this.raw.bitpix=-32;this.dataminmax();this.source="png";this.raw.header={SIMPLE:!0,NAXIS:2,NAXIS1:this.raw.width,NAXIS2:this.raw.height,BITPIX:this.raw.bitpix};this.initWCS();this.initLCS();this.xeqPlugins("image","onrawdata");return this}};a.Image.prototype.mkRawDataFromPNG=
function(){var d,c,b,e,f,g,h,k,l;g=f=0;var n=[];b=new ArrayBuffer(8);var m=new Uint8Array(b),r=new DataView(b);if(!this.offscreen.img)return this;this.raws.push({from:"png"});this.raw=this.raws[this.raws.length-1];this.raw.id=a.RAWID0;e=this.offscreen.img.data;for(d=b=0;b<e.length&&0!==e[b];b++)if(255!==e[b]&&(n[d]=String.fromCharCode(e[b]),d++),15===d&&'{"js9Protocol":'!==n.join("")){l=!0;break}if(15>d||l)this.mkRawDataFromIMG(this.offscreen.img);else{d=n.join("");2<a.DEBUG&&a.log("jsonHeader: %s",
d);try{c=JSON.parse(d)}catch(q){a.error("can't read FITS header from PNG file: "+d,q)}if(1===c.js9Protocol)this.raw.header=c,this.raw.endian=this.raw.header.js9Endian,this.raw.protocol=this.raw.header.js9Protocol;else for(this.raw.endian=c.js9Endian,this.raw.protocol=c.js9Protocol,this.raw.cardstr=c.cardstr,this.raw.ncard=c.ncard,this.raw.header={},c=this.raw.ncard,d=0;d<c;d++)l=this.raw.cardstr.slice(80*d,80*(d+1)),l=a.cardpars(l),void 0!==l&&("HISTORY"===l[0]?this.raw.header[l[0]+"__"+f++]=l[1]:
"COMMENT"===l[0]?this.raw.header[l[0]+"__"+g++]=l[1]:this.raw.header[l[0]]=l[1]);b+=1;this.raw.header.NAXIS1?this.raw.width=this.raw.header.NAXIS1:a.error("NAXIS1 missing from PNG-based FITS header");this.raw.header.NAXIS2?this.raw.height=this.raw.header.NAXIS2:a.error("NAXIS2 missing from PNG-based FITS header");this.raw.header.BITPIX?this.raw.bitpix=this.raw.header.BITPIX:a.error("BITPIX missing from PNG-based FITS header");"little"===this.raw.endian?k=!0:"big"===this.raw.endian?k=!1:a.error("js9Endian missing from PNG-based FITS header");
this.object=this.raw.header.OBJECT;this.telescope=this.raw.header.TELESCOP;this.instrument=this.raw.header.INSTRUME;f=this.raw.width*this.raw.height;g=b%4;switch(this.raw.bitpix){case 8:this.raw.data=new Uint8Array(f);for(d=0;d<f;d++){switch(g){case 0:h=e[b];b+=1;g=1;break;case 1:h=e[b];b+=1;g=2;break;case 2:h=e[b];b+=2;g=0;break;case 3:h=e[b+1],b+=2,g=1}this.raw.data[d]=h}break;case 16:case -16:16===this.raw.bitpix?(this.raw.data=new Int16Array(f),c=DataView.prototype.getInt16):(this.raw.data=new Uint16Array(f),
c=DataView.prototype.getUint16);for(d=0;d<f;d++){switch(g){case 0:m[0]=e[b];m[1]=e[b+1];h=c.call(r,0,k);b+=2;g=2;break;case 1:m[0]=e[b];m[1]=e[b+1];h=c.call(r,0,k);b+=3;g=0;break;case 2:m[0]=e[b];m[1]=e[b+2];h=c.call(r,0,k);b+=3;g=1;break;case 3:m[0]=e[b+1],m[1]=e[b+2],h=c.call(r,0,k),b+=3,g=2}this.raw.data[d]=h}break;case 32:case -32:32===this.raw.bitpix?(this.raw.data=new Int32Array(f),c=DataView.prototype.getInt32):(this.raw.data=new Float32Array(f),c=DataView.prototype.getFloat32);for(d=0;d<f;d++){switch(g){case 0:m[0]=
e[b];m[1]=e[b+1];m[2]=e[b+2];m[3]=e[b+4];h=c.call(r,0,k);b+=5;g=1;break;case 1:m[0]=e[b];m[1]=e[b+1];m[2]=e[b+3];m[3]=e[b+4];h=c.call(r,0,k);b+=5;g=2;break;case 2:m[0]=e[b];m[1]=e[b+2];m[2]=e[b+3];m[3]=e[b+4];h=c.call(r,0,k);b+=6;g=0;break;case 3:m[0]=e[b+1],m[1]=e[b+2],m[2]=e[b+3],m[3]=e[b+5],h=c.call(r,0,k),b+=6,g=1}this.raw.data[d]=h}break;case -64:this.raw.data=new Float64Array(f);for(d=0;d<f;d++){switch(g){case 0:case 4:m[0]=e[b];m[1]=e[b+1];m[2]=e[b+2];m[3]=e[b+4];m[4]=e[b+5];m[5]=e[b+6];m[6]=
e[b+8];m[7]=e[b+9];h=r.getFloat64(0,k);b+=10;g=2;break;case 1:case 5:m[0]=e[b];m[1]=e[b+1];m[2]=e[b+3];m[3]=e[b+4];m[4]=e[b+5];m[5]=e[b+7];m[6]=e[b+8];m[7]=e[b+9];h=r.getFloat64(0,k);b+=11;g=0;break;case 2:case 6:m[0]=e[b];m[1]=e[b+2];m[2]=e[b+3];m[3]=e[b+4];m[4]=e[b+6];m[5]=e[b+7];m[6]=e[b+8];m[7]=e[b+10];h=r.getFloat64(0,k);b+=11;g=1;break;case 3:case 7:m[0]=e[b+1],m[1]=e[b+2],m[2]=e[b+3],m[3]=e[b+5],m[4]=e[b+6],m[5]=e[b+7],m[6]=e[b+9],m[7]=e[b+10],h=r.getFloat64(0,k),b+=11,g=2}this.raw.data[d]=
h}break;default:a.error("unsupported bitpix in PNG file: "+this.raw.bitpix)}this.dataminmax();this.offscreen.img=null;this.initWCS();this.initLCS();this.xeqPlugins("image","onrawdata");return this}};a.Image.prototype.mkRawDataFromHDU=function(d,c){var b,e,f,g,h,k,l,n,m,r,q,t,u,v;v=u=0;var p=this;c=c||{};$.isArray(d)||a.isTypedArray(d)||d instanceof ArrayBuffer?($.isArray(d[0])&&(d=d.reduce(function(a,b){return a.concat(b)})),g={image:d}):"object"===typeof d?g=d:a.error("unknown or missing input for HDU creation");
g.data&&!g.image&&(g.image=g.data);g.image||a.error("data missing from JS9 FITS object"+JSON.stringify(g));2>g.naxis&&a.error("can't image a FITS file with less than 2 dimensions");this.raw&&(k=this.raw,m=this.raw.width,r=this.raw.height,q=this.raw.bitpix,l=this.raw.header.LTM1_1||1,n=this.params.wcssys,t=this.params.wcsunits,this.freeWCS());this.raws=this.raws||[];if(h=this.raws.length){c.rawid=c.rawid||a.RAWIDX;for(b=f=0;b<h;b++)if(c.rawid===this.raws[b].id){e=this.raws[b].from;this.raws[b]={from:e,
id:c.rawid};this.raw=this.raws[b];f++;break}f||(this.raws.push({from:"hdu",id:c.rawid}),this.raw=this.raws[h],k=null)}else this.raws.push({from:"hdu"}),this.raw=this.raws[h],this.raw.id=a.RAWID0;this.raw.hdu=g;g.axis?(this.raw.width=g.axis[1],this.raw.height=g.axis[2]):g.naxis1&&g.naxis2?(this.raw.width=g.naxis1,this.raw.height=g.naxis2):m&&r&&(this.raw.width=m,this.raw.height=r);g.bitpix?this.raw.bitpix=g.bitpix:q&&(this.raw.bitpix=q);if("base64"===g.encoding)for(e=window.atob(g.image),g.image=new ArrayBuffer(e.length),
f=new Uint8Array(g.image),b=0;b<e.length;b++)f[b]=e.charCodeAt(b);$.isArray(g.image[0])&&(g.image=g.image.reduce(function(a,b){return a.concat(b)}));switch(this.raw.bitpix){case 8:this.raw.data=new Uint8Array(g.image);break;case 16:this.raw.data=new Int16Array(g.image);break;case -16:this.raw.data=new Uint16Array(g.image);break;case 32:this.raw.data=new Int32Array(g.image);break;case -32:this.raw.data=new Float32Array(g.image);break;case -64:this.raw.data=new Float64Array(g.image)}this.raw.card=g.card;
this.raw.cardstr=g.cardstr;this.raw.ncard=g.ncard;if(g.head)this.raw.header=g.head;else if(this.raw.card)for(this.raw.header={},f=this.raw.card.length,b=0;b<f;b++)h=a.cardpars(this.raw.card[b]),void 0!==h&&("HISTORY"===h[0]?this.raw.header[h[0]+"__"+u++]=h[1]:"COMMENT"===h[0]?this.raw.header[h[0]+"__"+v++]=h[1]:this.raw.header[h[0]]=h[1]);else if(this.raw.cardstr)for(this.raw.header={},f=this.raw.ncard,b=0;b<f;b++)h=this.raw.cardstr.slice(80*b,80*(b+1)),h=a.cardpars(h),void 0!==h&&("HISTORY"===h[0]?
this.raw.header[h[0]+"__"+u++]=h[1]:"COMMENT"===h[0]?this.raw.header[h[0]+"__"+v++]=h[1]:this.raw.header[h[0]]=h[1]);else this.raw.header={},this.raw.header.SIMPLE=!0,this.raw.header.NAXIS=2,this.raw.header.NAXIS1=this.raw.width,this.raw.header.NAXIS2=this.raw.height,this.raw.header.BITPIX=this.raw.bitpix;b=this.raw.header;k||this.parentFile||this.parent||void 0===b.LTV1&&void 0===b.LTV2&&void 0===b.LTM1_1&&void 0===b.LTM2_2||(this.parent={},this.parent.raw={header:$.extend(!0,{},b)},this.parent.lcs=
{},a.Image.prototype.initLCS.call(this.parent,this.parent.raw.header));if("image"===g.imtab&&void 0!==g.x1&&1!==g.x1||void 0!==g.y1&&1!==g.y1||void 0===g.bin||1!==g.bin)f=g.bin||1,u=void 0!==g.x1?g.x1:0,v=void 0!==g.y1?g.y1:0,void 0!==b.CRPIX1&&(b.CRPIX1=(b.CRPIX1-u)/f+.5),void 0!==b.CRPIX2&&(b.CRPIX2=(b.CRPIX2-v)/f+.5),void 0!==b.CDELT1&&(b.CDELT1*=f),void 0!==b.CDELT2&&(b.CDELT2*=f),void 0!==b.CD1_1&&(b.CD1_1*=f),void 0!==b.CD1_2&&(b.CD1_2*=f),void 0!==b.CD2_1&&(b.CD2_1*=f),void 0!==b.CD2_2&&(b.CD2_2*=
f),b.LTM1_1=b.LTM1_1||1,b.LTM1_1/=f,b.LTM2_1=b.LTM2_1||0,b.LTM2_1/=f,b.LTM1_2=b.LTM1_2||0,b.LTM1_2/=f,b.LTM2_2=b.LTM2_2||1,b.LTM2_2/=f,b.LTV1=b.LTV1||0,b.LTV1=(b.LTV1-u)/f+.5,b.LTV2=b.LTV2||0,b.LTV2=(b.LTV2-v)/f+.5;c.file&&c.file!==this.file?(this.file=c.file,this.id=null):c.filename&&c.filename!==this.file?(this.file=c.filename,this.id=null):g.filename&&g.filename!==this.file&&(this.file=g.filename,this.id=null);this.file0=this.file=this.file||a.ANON+a.uniqueID();c.id&&(this.id0=c.id,this.id=a.getImageID(c.id,
this.display.id,this));this.id||!this.file||this.file.match(/\[.*[^a-zA-Z0-9_].*\]/)||(c.extname||c.extnum?(c.extname?(this.file=this.file.replace(/\[.*\]/,""),this.file+=sprintf("[%s]",c.extname)):c.extnum&&0<c.extnum&&(this.file=this.file.replace(/\[.*\]/,""),this.file+=sprintf("[%s]",c.extnum)),g&&g.fits&&(c.extname&&(g.fits.extname=c.extname),c.extnum&&0<c.extnum&&(g.fits.extnum=c.extnum))):g.fits?g.fits.extname?(this.file=this.file.replace(/\[.*\]/,""),this.file+=sprintf("[%s]",g.fits.extname)):
g.fits.extnum&&0<g.fits.extnum&&(this.file=this.file.replace(/\[.*\]/,""),this.file+=sprintf("[%s]",g.fits.extnum)):this.raw.header&&this.raw.header.EXTNAME&&(this.file=this.file.replace(/\[.*\]/,""),this.file+=sprintf("[%s]",this.raw.header.EXTNAME)));this.id||(this.id0=(this.parentFile||this.file).split("/").reverse()[0],this.id=a.getImageID(this.id0,this.display.id,this));c.proxyFile&&(this.proxyFile=c.proxyFile);this.raw.filter=c.filter||"";this.imtab=g.imtab?g.imtab:g.table?"table":"image";this.raw.imtab=
this.imtab;void 0!==g.dmin&&void 0!==g.dmax?this.dataminmax(g.dmin,g.dmax):this.dataminmax();this.object=this.raw.header.OBJECT;this.telescope=this.raw.header.TELESCOP;this.instrument=this.raw.header.INSTRUME;this.binning.bin="table"===this.imtab&&g.table?g.table.bin||1:g.bin?g.bin:1;c.ltm2obin&&b.LTM1_1?this.binning.obin=b.LTM1_1/l:k||(this.binning.obin=this.binning.bin);this.initWCS();n&&this.setWCSSys(n);t&&this.setWCSUnits(t);this.initLCS();try{c.hdus?p.hdus=c.hdus:this.parentFile&&a.helper.connected&&
a.helper.js9helper?(d={id:this.expandMacro("$id"),cmd:this.expandMacro("js9Xeq listhdus $filename"),image:this.file,fits:this.parentFile,rtype:"text"},a.helper.send("listhdus",d,function(a){a.stderr||a.errcode||!a.stdout||(p.hdus=JSON.parse(a.stdout))})):this.raw&&this.raw.hdu&&this.raw.hdu.fits&&(e=a.listhdu(this.raw.hdu.fits.vfile),this.hdus=JSON.parse(e))}catch(w){}if(this.raw.hdu.fits&&this.raw.hdu.fits.vfile){e=a.globalOpts.clearImageMemory;e=!1===e?["never"]:!0===e?["always"]:e.toLowerCase().split(/[,>]/);
n=k=!1;b=0;for(l=!1;b<e.length&&!l;b++)switch(e[b]){case "never":k=!1;l=!0;break;case "always":l=k=!0;break;case "heap":n=!0;break;case "auto":2>=this.raw.header.NAXIS&&(!this.hdus||1===this.hdus.length)?k=!0:(k=!1,l=!0);break;case "nocube":2>=this.raw.header.NAXIS?k=!0:(k=!1,l=!0);break;case "noext":this.hdus&&1!==this.hdus.length?(k=!1,l=!0):k=!0;break;case "size":e[b+1]?a.vsize(g.fits.vfile)>1E6*e[b+1]?k=!0:(k=!1,l=!0):(k=!1,l=!0)}k?(2<a.DEBUG&&a.log("removing underlying FITS vfile for %s: %s",
this.id,this.raw.hdu.fits.vfile),a.cleanupFITSFile(this.raw,!0)):n&&(2<a.DEBUG&&a.log("freeing heap space for %s: %s",this.id,this.raw.hdu.fits.vfile),a.cleanupFITSFile(this.raw,!1))}this.xeqPlugins("image","onrawdata");return this};a.Image.prototype.mkSection=function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];b=this.rgb.sect;b.ozoom=b.zoom;switch(c.length){case 0:b.xcen=Math.floor(this.raw.width/2);b.ycen=Math.floor(this.raw.height/2);b.width=Math.min(this.raw.width,this.display.canvas.width);
b.height=Math.min(this.raw.height,this.display.canvas.height);break;case 1:a.isNumber(c[0])||a.error("invalid input for generating section");b.zoom=parseFloat(c[0]);b.width=Math.min(this.raw.width*b.zoom,this.display.canvas.width);b.height=Math.min(this.raw.height*b.zoom,this.display.canvas.height);break;case 2:a.isNumber(c[0])&&a.isNumber(c[1])||a.error("invalid input for generating section");b.xcen=parseFloat(c[0]);b.ycen=parseFloat(c[1]);a.notNull(b.ix)&&(b.width=Math.min(this.raw.width*b.zoom,
this.display.canvas.width));a.notNull(b.iy)&&(b.height=Math.min(this.raw.height*b.zoom,this.display.canvas.height));break;case 3:a.isNumber(c[0])&&a.isNumber(c[1])&&a.isNumber(c[2])||a.error("invalid input for generating section"),b.xcen=parseFloat(c[0]),b.ycen=parseFloat(c[1]),b.zoom=parseFloat(c[2]),b.width=Math.min(this.raw.width*b.zoom,this.display.canvas.width),b.height=Math.min(this.raw.height*b.zoom,this.display.canvas.height)}delete b.ix;delete b.iy;b.width=Math.floor(b.width);b.height=Math.floor(b.height);
b.x0=Math.floor(b.xcen-b.width/(2*b.zoom));b.y0=Math.floor(b.ycen-b.height/(2*b.zoom));b.x1=Math.floor(b.xcen+b.width/(2*b.zoom));b.y1=Math.floor(b.ycen+b.height/(2*b.zoom));0>b.x0&&(a.globalOpts.panWithinDisplay?b.x1-=b.x0:b.ix=b.x0*b.zoom,b.x0=0);0>b.y0&&(a.globalOpts.panWithinDisplay?b.y1-=b.y0:b.iy=b.y0*b.zoom,b.y0=0);b.x1>this.raw.width&&(a.globalOpts.panWithinDisplay?b.x0-=b.x1-this.raw.width:b.ix=(b.x1-this.raw.width)*b.zoom,b.x1=this.raw.width);b.y1>this.raw.height&&(a.globalOpts.panWithinDisplay?
b.y0-=b.y1-this.raw.height:b.iy=(b.y1-this.raw.height)*b.zoom,b.y1=this.raw.height);b.ix&&1>b.zoom&&(0<b.x0&&(c=b.x0,b.x0-=c,b.ix+=c*b.zoom),b.x1<this.raw.width&&(c=this.raw.height-b.x1,b.x1+=c,b.ix-=c*b.zoom));b.iy&&1>b.zoom&&(0<b.y0&&(c=b.y0,b.y0-=c,b.iy+=c*b.zoom),b.y1<this.raw.height&&(c=this.raw.height-b.y1,b.y1+=c,b.iy-=c*b.zoom));b.x0=Math.max(0,b.x0);b.x1=Math.min(this.raw.width,b.x1);b.y0=Math.max(0,b.y0);b.y1=Math.min(this.raw.height,b.y1);b.width=Math.ceil((b.x1-b.x0)*b.zoom);b.height=
Math.ceil((b.y1-b.y0)*b.zoom);if(0>=b.width||0>=b.height)c=sprintf("invalid image section: %s,%s [%s,%s, %s,%s, %s]",b.width,b.height,b.x0,b.y0,b.x1,b.y1,b.zoom),a.error(c);this.offscreenRGB=null;this.params.zoom=b.zoom;return this};a.Image.prototype.mkColorData=function(){var d,c,b=a.SCALESIZE,e=this.params.scalemin,f=this.params.scalemax,g=this.raw.width*this.raw.height,h=(b-1)/(f-e);if(!this.colorData||this.colorData.length<g)this.colorData=new Int32Array(g);for(d=0;d<g;d++)c=this.raw.data[d],
this.colorData[d]=c<=e?0:c>=f?b-1:Math.floor((c-e)*h+.5);return this};a.Image.prototype.calcContrastBias=function(d){var c=this.params.bias,b=a.COLORSIZE,e=this.params.contrast;if(1E-4>c-.5&&1E-4>e-1)return d;this.params.invert&&(c=1-c);d=Math.floor(((d/b-c)*e+.5)*b);return 0>d?0:d>=b?b-1:d};a.Image.prototype.mkColorCells=function(){var d,c,b=a.COLORSIZE;this.colorCells||(this.colorCells=[]);for(d=0;d<b;d++)c=this.params.invert?b-d-1:d,c=this.calcContrastBias(c),this.colorCells[d]=this.cmapObj.mkColorCell(c);
return this};a.Image.prototype.mkScaledCells=function(){var d,c,b,e,f,g,h,k,l,n,m,r;h=a.COLORSIZE;var q=a.SCALESIZE,t=a.INVSIZE;f=a.HISTSIZE;if(!this.colorCells)return this;if(!this.psColors){b=this.psColors=[];c=this.params.nancolor;k=[];"#"===c.charAt(0)&&(c=c.slice(1));c=c.toUpperCase();for(d=g=0;6>g;g+=2,d++)r="0123456789ABCDEF".indexOf(c.charAt(g)),e="0123456789ABCDEF".indexOf(c.charAt(g+1)),k[d]=16*r+e;b[NaN]=k}this.psInverse||(this.psInverse=[],this.psInverse[NaN]=0);c=this.params.scalemax-
this.params.scalemin;g=this.params.scalemin;switch(this.params.scale){case "linear":for(b=0;b<q;b++)d=b/q,d=Math.floor(d*h),this.psColors[b]=this.colorCells[d];for(b=0;b<t;b++)d=b/t,this.psInverse[b]=d*c+g;break;case "log":f=this.params.exp;for(b=0;b<q;b++)d=Math.log(f*b/q+1)/Math.log(f),d=Math.floor(d*h),d>=h&&(d=h-1),this.psColors[b]=this.colorCells[d];for(b=0;b<t;b++)d=(Math.pow(f,b/t)-1)/f,this.psInverse[b]=d*c+g;break;case "power":f=this.params.exp;for(b=0;b<q;b++)d=(Math.pow(f,b/q)-1)/f,d=Math.floor(d*
h),d>=h&&(d=h-1),this.psColors[b]=this.colorCells[d];for(b=0;b<t;b++)d=Math.log(f*b/t+1)/Math.log(f),this.psInverse[b]=d*c+g;break;case "sqrt":for(b=0;b<q;b++)d=b/q,d=Math.floor(Math.sqrt(d)*h),d>=h&&(d=h-1),this.psColors[b]=this.colorCells[d];for(b=0;b<t;b++)d=b/t,this.psInverse[b]=d*d*c+g;break;case "squared":for(b=0;b<q;b++)d=b/q,d=Math.floor(d*d*h),d>=h&&(d=h-1),this.psColors[b]=this.colorCells[d];for(b=0;b<t;b++)d=Math.sqrt(b/t),this.psInverse[b]=d*c+g;break;case "asinh":for(b=0;b<q;b++)d=b/
q,d=Math.floor(Math.asinh(10*d)/3*h),d>=h&&(d=h-1),this.psColors[b]=this.colorCells[d];for(b=0;b<t;b++)d=b/t,d=Math.sinh(3*d)/10,this.psInverse[b]=d*c+g;break;case "sinh":for(b=0;b<q;b++)d=b/q,d=Math.floor(Math.sinh(3*d)/10*h),d>=h&&(d=h-1),this.psColors[b]=this.colorCells[d];for(b=0;b<t;b++)d=b/t,d=Math.asinh(10*d)/3,this.psInverse[b]=d*c+g;break;case "histeq":k=this.raw.data;l=this.raw.width*this.raw.height;c=this.raw.dmax-this.raw.dmin;m=this.raw.dmax;g=this.raw.dmin;n=d=0;r=[];if(!this.hist||
!this.hist.length){this.hist=[];for(b=0;b<f;b++)r[b]=0;for(b=0;b<l;b++)k[b]>=g&&k[b]<=m&&(e=Math.floor((k[b]-g)/c*f+.5),e<f&&(r[e]+=1));for(b=0;b<f;b++)n+=r[b];e=n/f;for(b=k=0;b<f&&k<f;b++)for(this.hist[b]=k/f,d+=r[b];d>=e&&k<f;)d-=e,k++;for(d=(f-1)/f;b<f;)this.hist[b++]=d}for(b=0;b<q;b++)d=this.hist[b*f/q],d=Math.floor(d*h),this.psColors[b]=this.colorCells[d];for(b=0;b<t;b++){h=b/t;for(e=0;e<f-1&&!(this.hist[e]>h);e++);d=e/f;this.psInverse[b]=d*c+g}break;default:a.error("unknown scale '"+this.params.scale+
"'")}return this};a.Image.prototype.mkRGBImage=function(){var d,c,b,e,f,g,h,k,l,n,m,r,q,t,u,v,p,w,x,A,z,C,D=null,y=null,B=null,F=!1;if(!this.rgb)return this;!a.globalOpts.rgb.active||this!==a.globalOpts.rgb.rim&&this!==a.globalOpts.rgb.gim&&this!==a.globalOpts.rgb.bim||(F=!0,a.globalOpts.rgb.rim&&(D=a.globalOpts.rgb.rim),a.globalOpts.rgb.gim&&(y=a.globalOpts.rgb.gim),a.globalOpts.rgb.bim&&(B=a.globalOpts.rgb.bim));h=this.display.context;d=this.rgb;c=d.sect;if(this.MakeRGBImage&&"function"===typeof this.MakeRGBImage&&
this.MakeRGBImage()||this.MakePrimaryImage&&"function"===typeof this.MakePrimaryImage&&this.MakePrimaryImage())return this;if(this.rgbFile){f=c.width/c.zoom;g=c.height/c.zoom;b=c.x0;e=this.offscreen.canvas.height-1-(c.y0+g);e=this.offscreen.context.getImageData(b,e,f,g);if(1===c.zoom)d.img=e;else for(d.img=h.createImageData(c.width,c.height),d=d.img,r=n=0;n<e.height;n++,r++)for(w=n*e.width,t=r*c.zoom,m=h=0;h<e.width;h++,m++)for(b=4*(w+h),q=m*c.zoom,u=0;u<c.zoom;u++)for(v=Math.floor(t+u),x=v*c.width,
v=0;v<c.zoom;v++)p=Math.floor(q+v),p=4*(x+p),d.data[p]=e.data[b],d.data[p+1]=e.data[b+1],d.data[p+2]=e.data[b+2],d.data[p+3]=e.data[b+3];return this}d.img&&d.img.width===c.width&&d.img.height===c.height||(d.img=h.createImageData(c.width,c.height));d=d.img;if(!this.psColors)return this;A=void 0!==this.params.opacity?255*this.params.opacity:void 0!==this.params.alpha?this.params.alpha:255;this.maskData&&(this.params.maskInvert?void 0!==this.params.opacity&&void 0!==this.params.maskOpacity?(e=255*this.params.opacity,
f=255*this.params.maskOpacity):void 0!==this.params.alpha1&&void 0!==this.params.alpha2?(e=this.params.alpha2,f=this.params.alpha1):(e=0,f=255):void 0!==this.params.opacity&&void 0!==this.params.maskOpacity?(e=255*this.params.maskOpacity,f=255*this.params.opacity):void 0!==this.params.alpha1&&void 0!==this.params.alpha2?(e=this.params.alpha1,f=this.params.alpha2):(e=255,f=0));k=Math.max(1,Math.floor(1/c.zoom));l=c.zoom*k;n=c.y1-1;for(r=0;n>=c.y0;n-=k,r++)for(w=n*this.raw.width,t=r*l,h=c.x0,m=0;h<
c.x1;h+=k,m++){if(F){if(g=D?D.colorData[w+h]:0,z=y?y.colorData[w+h]:0,C=B?B.colorData[w+h]:0,void 0===g||void 0===z||void 0===C)return a.globalOpts.rgb.active=!1,a.error("RGB images are incompatible. Turning off RGB mode.","",!1),this.mkRGBImage(),this}else b=this.colorData[w+h];this.maskData&&(A=0<this.maskData[w+h]?e:f);q=m*l;for(u=0;u<c.zoom;u++)for(v=Math.ceil(t+u),x=v*c.width,v=0;v<c.zoom;v++)p=Math.ceil(q+v),p=4*(x+p),p<d.data.length&&(F?(d.data[p]=D?D.psColors[g][0]:0,d.data[p+1]=y?y.psColors[z][1]:
0,d.data[p+2]=B?B.psColors[C][2]:0):(d.data[p]=this.psColors[b][0],d.data[p+1]=this.psColors[b][1],d.data[p+2]=this.psColors[b][2]),d.data[p+3]=A)}return this};a.Image.prototype.blendImage=function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e=$jscomp.makeIterator(c),b=e.next().value,f=e.next().value,e=e.next().value,g=/normal|multiply|screen|overlay|darken|lighten|color-dodge|color-burn|hard-light|soft-light|difference|exclusion|hue|saturation|color|luminosity|clear|copy|source-over|destination-over|source-in|destination-in|source-out|destination-out|source-atop|destination-atop|xor|lighter/i;
if(0===c.length)return this.blend;if(!0===b||!1===b||"true"===b||"false"===b)return"true"===b?b=!0:"false"===b&&(b=!1),this.blend.active=b,this.xeqPlugins("image","onimageblend"),this.display.blendMode&&this.displayImage(),this;if(a.notNull(b)||a.notNull(f))a.notNull(b)&&(g.test(b)||a.error("invalid composite/blend operation: "+b),this.blend.mode=b),a.notNull(f)&&("string"===typeof f?f=parseFloat(f):"number"!==typeof f&&a.error("invalid opacity: "+f),this.blend.opacity=Math.min(Math.max(f,0),1)),
a.notNull(e)&&("true"===e?e=!0:"false"===e&&(e=!1),this.blend.active=e),this.xeqPlugins("image","onimageblend"),this.display.blendMode&&this.blend.active&&this.displayImage();return this};a.Image.prototype.calcDisplayOffsets=function(d){var c,b,e=this.rgb.sect;this.ix=Math.floor((this.display.canvas.width-this.rgb.img.width)/2);this.iy=Math.floor((this.display.canvas.height-this.rgb.img.height)/2);a.notNull(e.ix)&&(this.ix-=e.ix/2);a.notNull(e.iy)&&(this.iy+=e.iy/2);d&&this.wcsAlign()&&(c=this.wcsim,
d=c.rgb.sect,c=a.pix2pix(c,this,c.getPan()),b=a.globalOpts.panWithinDisplay,a.globalOpts.panWithinDisplay=!0,this.mkSection(c.x,c.y,d.zoom),a.globalOpts.panWithinDisplay=b,this.ix-=(e.xcen-(e.x0+e.x1)/2)*d.zoom,this.iy+=(e.ycen-(e.y0+e.y1)/2)*d.zoom);return this};a.Image.prototype.putImage=function(d){var c=this.rgb,b=this.display.context,e=function(b,c){var d,e;b.offscreenRGB||(e=document.createElement("canvas"),d=e.getContext("2d"),e.width=c.width,e.height=c.height,a.ANTIALIAS||(d.imageSmoothingEnabled=
!1,d.webkitImageSmoothingEnabled=!1,d.msImageSmoothingEnabled=!1),d.putImageData(c,0,0),b.offscreenRGB={canvas:e,context:d});return b.offscreenRGB.canvas};d=d||{};"reproject"===this.rawDataLayer()&&d.wcsim&&(this.wcsim=d.wcsim);this.calcDisplayOffsets(!0);a.notNull(d.opacity)||a.notNull(d.blend)?(b.save(),void 0!==d.opacity&&(b.globalAlpha=d.opacity),void 0!==d.blend&&(b.globalCompositeOperation=d.blend),b.drawImage(e(this,c.img),this.ix,this.iy),b.restore()):b.putImageData(c.img,this.ix,this.iy);
return this};a.Image.prototype.displayImage=function(d,c){var b,e,f;f=0;var g=[],h={};if(!1===d)return this.displayMode=!1,this;!0===d&&(this.displayMode=!0,d="all");if(!this.displayMode)return this;"object"===typeof d&&(c=d,d=null);d?"all"===d?(d="colors,scaled,rgb,display,plugins",h.notify=!0):"rgbonly"===d?(d="rgb,nodisplay",h.notify=!0):"display"===d&&(h.notify=!0):d="rgb";d.split(",").forEach(function(a,b,c){a=a.trim();h[a]=!0;switch(a){case "colors":h.scaled=!0;h.rgb=!0;break;case "scaled":h.rgb=
!0}});h.display=!0;h.plugins=!0;this.rgbFile&&(h.colors=!1,h.scaled=!1);if("string"===typeof c)try{c=JSON.parse(c)}catch(k){a.error("can't parse displayImage opts: "+c,k)}c=c||{};if(this.display.blendMode&&!1!==c.blendMode)for(b=0;b<a.images.length;b++)e=a.images[b],e.display===this.display&&e.blend.active&&(g.push(e),f++);h.colors&&(this.mkColorData(),this.offscreenRGB=null);h.scaled&&(this.mkColorCells(),this.mkScaledCells(),this.offscreenRGB=null);if(h.rgb&&(this.mkRGBImage(),this.offscreenRGB=
null,f))for(b=g.length-1;0<=b;b--)e=g[b],e.mkRGBImage(),e.offscreenRGB=null;if(h.nodisplay)return this;if(h.display){this.display.context.clear();if(f){for(b=g.length-1;0<=b;b--)g[b].calcDisplayOffsets(!1);for(b=g.length-1;0<=b;b--)e=g[b],f={wcsim:c.wcsim,blend:e.blend.mode,opacity:e.blend.opacity},e.putImage(f),e===this&&e.displayShapeLayers()}else this.putImage(c),this.displayShapeLayers();this.display.image=this;if(this.delayedShapes&&this.delayedShapes.length){for(;this.delayedShapes.length;)b=
this.delayedShapes.shift(),this.addShapes(b.layer,b.shape,b.opts);delete this.delayedShapes}}this.xeqPlugins("image","onimagedisplay");return this};a.Image.prototype.refreshImage=function(d,c){var b,e,f,g;if("string"===typeof c)try{c=JSON.parse(c)}catch(h){a.error("can't parse refresh opts: "+c,h)}c=c||{};if(d&&"string"!==typeof d){c.rawid=c.rawid||a.RAWID0;"function"===typeof c&&(c={onrefresh:c});!c.onrefresh&&a.imageOpts.onrefresh&&(c.onrefresh=a.imageOpts.onrefresh);c.resetSection||(g=this.imageToLogicalPos({x:this.rgb.sect.xcen,
y:this.rgb.sect.ycen}),this.raw.wcs&&0<this.raw.wcs&&(b=a.pix2wcs(this.raw.wcs,this.rgb.sect.xcen,this.rgb.sect.ycen),e=b.trim().split(/\s+/),f=a.saostrtod(e[0]),":"===String.fromCharCode(a.saodtype())&&"galactic"!==this.params.wcssys&&"ecliptic"!==this.params.wcssys&&(f*=15),e=a.saostrtod(e[1])));b=this.rgb.sect.zoom;this.binning.obin=this.binning.bin;this.mkRawDataFromHDU(d,c);c.resetSection?(this.mkSection(),this.mkSection(b)):(this.raw.wcs&&0<this.raw.wcs&&a.notNull(f)&&a.notNull(e)?(e=a.wcs2pix(this.raw.wcs,
f,e).trim().split(/ +/),g={x:parseFloat(e[0]),y:parseFloat(e[1])}):g=this.logicalToImagePos({x:g.x,y:g.y}),0<g.x&&g.x<this.raw.width&&0<g.y&&g.y<this.raw.height?this.mkSection(g.x,g.y,b):(this.mkSection(),this.mkSection(b)));this.displayImage("colors",c);this.notifyHelper();if(c.refreshRegions||c.resetSection||this.binning.obin!==this.binning.bin)this.refreshLayers(),this.updateShapes("regions","all","binning");this.xeqPlugins("image","onimagerefresh");a.waiting(!1);if(c.onrefresh)try{a.xeqByName(c.onrefresh,
window,this)}catch(h){a.error("in image refresh callback",h)}return this}c.onrefresh&&(c.onload=c.onrefresh,delete c.onrefresh);c.refresh=this;b=document.domain?d||this.file:d||this.fitsFile||this.file;a.Load(b,c,{display:this.display})};a.Image.prototype.fileDimensions=function(){var a,c;this.parent&&"BINTABLE"!==this.parent.raw.header.XTENSION?(a=this.parent.raw.header.TABDIM1?this.parent.raw.header.TABDIM1:this.parent.raw.header.NAXIS1,c=this.parent.raw.header.TABDIM2?this.parent.raw.header.TABDIM2:
this.parent.raw.header.NAXIS2):(a=this.raw.header.TABDIM1?this.raw.header.TABDIM1:this.raw.header.NAXIS1,c=this.raw.header.TABDIM2?this.raw.header.TABDIM2:this.raw.header.NAXIS2);return{xdim:a,ydim:c}};a.Image.prototype.maybePhysicalToImage=function(d){var c;"image"===this.imtab&&this.parent&&this.parent.lcs&&d.x&&d.y&&(d={x:d.x,y:d.y},d=a.Image.prototype.logicalToImagePos.call(this.parent,d,"ophysical"),c={x:Math.floor(d.x+.5),y:Math.floor(d.y+.5)});return c};a.Image.prototype.displaySection=function(d,
c){var b,e,f,g,h,k,l,n,m,r,q,t,u=this,v=function(b,c,d){var e;a.isNull(b)?a.isNull(c)||(e=c):e=b;return e||d},p=function(b,d){var e,g;e="";l=$.extend(!0,{},d||{});a.isNull(l.refreshRegions)&&(l.refreshRegions=!0);a.isNull(l.resetSection)&&(l.resetSection=!0);!1!==l.waiting&&a.waiting(!0,u.display);b.fits.extname?e=sprintf("[%s]",b.fits.extname):b.fits.extnum&&0<b.fits.extnum?e=sprintf("[%s]",b.fits.extnum):u.parent&&(u.parent.extname?e=sprintf("[%s]",u.parent.extname):u.parent.extnum&&0<u.parent.extnum&&
(e=sprintf("[%s]",u.parent.extnum)));e&&(l.id=u.id.replace(/\[.*\]/,"")+e,l.file=u.file.replace(/\[.*\]/,"")+e);if(l.separate){delete l.xcen;delete l.ycen;if("string"===typeof l.separate){g=l.separate.split(":");switch(g.length){case 1:e=g[0];break;default:e=g[0],l.id=g[1]}l.display=a.lookupDisplay(e)}else l.display=u.display;"parentFile"===f&&u.fitsFile&&(e=a.lookupImage(u.fitsFile),l.parentFile=e&&e.parentFile?e.parentFile:u.fitsFile);h=u.listRegions("all",{mode:1});c=l.ondisplaysection||l.onrefresh||
c;k=new a.Image(b,l,c);k.binning.obin=k.binning.bin;h&&!1!==l.refreshRegions&&k.addShapes("regions",h)}else if("string"===typeof l.refresh){delete l.xcen;delete l.ycen;g=l.refresh.split(":");switch(g.length){case 1:e=g[0];break;default:e=g[0],l.id=g[1]}l.display=a.lookupDisplay(e);l.display.image?(l.rawid=u.raw.id,l.onrefresh=l.ondisplaysection||l.onrefresh||c,l.display.image.refreshImage(b,l)):("parentFile"===f&&u.fitsFile&&(e=a.lookupImage(u.fitsFile),l.parentFile=e&&e.parentFile?e.parentFile:u.fitsFile),
h=u.listRegions("all",{mode:1}),c=l.ondisplaysection||l.onrefresh||c,k=new a.Image(b,l,c),k.binning.obin=k.binning.bin,h&&k.addShapes("regions",h))}else l.rawid=u.raw.id,l.onrefresh=l.ondisplaysection||l.onrefresh||c,u.refreshImage(b,l);a.waiting(!1)};this.raw&&this.raw.hdu&&this.raw.hdu.fits||a.error("invalid image for displaySection");if("full"===d)n=this.fileDimensions(),d={xdim:n.xdim,ydim:n.ydim,xcen:0,ycen:0};else{if("selected"===d){this.selectShapes("regions","selected",function(a){a=a.pub;
var b,d,e=0,f=0,g=1E6,k=0,h=1E6,n=0,m=a.shape;a.lcs&&(a=a.lcs);switch(m){case "annulus":b=2*a.radii[a.radii.length-1];d=2*a.radii[a.radii.length-1];break;case "box":b=a.width;d=a.height;break;case "circle":b=2*a.radius;d=2*a.radius;break;case "ellipse":b=2*a.r1;d=2*a.r2;break;case "polygon":case "line":for(b=0;b<a.pts.length;b++)e+=a.pts[b].x,f+=a.pts[b].y,a.pts[b].x>k&&(k=a.pts[b].x),a.pts[b].x<g&&(g=a.pts[b].x),a.pts[b].y>n&&(n=a.pts[b].y),a.pts[b].y<h&&(h=a.pts[b].y);a.x=e/a.pts.length;a.y=f/a.pts.length;
"line"===a.shape&&2===a.pts.length?(b=Math.sqrt((a.pts[0].x-a.pts[1].x)*(a.pts[0].x-a.pts[1].x)+(a.pts[0].y-a.pts[1].y)*(a.pts[0].y-a.pts[1].y)),d=1):(b=k-g,d=n-h);break;case "text":d=b=10}l={xcen:a.x,ycen:a.y,xdim:b,ydim:d,separate:!0,refreshRegions:!1,resetSection:!0};this.displaySection(l,c)});return}if("string"===typeof d)try{d=JSON.parse(d)}catch(w){a.error("can't parse section opts: "+d,w)}}d=d||{};e=d.separate?$.extend(!0,{},this.raw.hdu):this.raw.hdu;(f=d.from)||(f=this.parentFile&&a.helper.connected&&
a.helper.js9helper?"parentFile":"virtualFile");if(e.table)n=e.table;else{"parentFile"===f&&this.raw.header&&a.notNull(this.raw.header.LTM1_1)?(r=1,q=this.raw.header.LTM1_1):(r=e.bin||1,q=1);n={x:this.raw.width/2,y:this.raw.height/2};m=this.imageToLogicalPos(n);n={};n.bin=Math.floor(r/q+.5);n.xcen=Math.floor(m.x+.5*(n.bin-1));n.ycen=Math.floor(m.y+.5*(n.bin-1));if(r=this.maybePhysicalToImage({x:n.xcen,y:n.ycen}))n.xcen=r.x,n.ycen=r.y;n.xdim=Math.floor(e.naxis1*n.bin);n.ydim=Math.floor(e.naxis2*n.bin);
n.filter=this.raw.filter||""}if("string"===typeof d.bin)switch(d.bin.match(/[as]$/)&&(d.binMode=d.bin.slice(-1),d.bin=d.bin.slice(0,-1)),r=n.bin||this.binning.bin,d.bin.charAt(0)){case "*":case "x":case "X":d.bin=r*parseInt(d.bin.slice(1),10);break;case "/":d.bin=r/parseInt(d.bin.slice(1),10);break;case "+":d.bin=r+parseInt(d.bin.slice(1),10);break;case "-":d.bin=r-parseInt(d.bin.slice(1),10);break;case "i":case "I":d.bin=2*r;break;case "o":case "O":d.bin=r/2;break;default:a.isNumber(d.bin)?d.bin=
parseInt(d.bin,10):a.error("invalid bin for displaySection: "+d.bin)}d.xcen=v(d.xcen,n.xcen,0);d.ycen=v(d.ycen,n.ycen,0);switch(this.imtab){case "table":d.xdim=v(d.xdim,n.xdim,a.fits.options.table.xdim);d.ydim=v(d.ydim,n.ydim,a.fits.options.table.ydim);d.bin=v(d.bin,n.bin,a.fits.options.table.bin);break;default:d.xdim=v(d.xdim,n.xdim,a.fits.options.image.xdim),d.ydim=v(d.ydim,n.ydim,a.fits.options.image.ydim),d.bin=v(d.bin,n.bin,a.fits.options.image.bin)}d.binMode=v(d.binMode,n.binMode,a.globalOpts.binMode);
"string"===typeof d.bin&&(d.bin.match(/[as]$/)&&(d.binMode=d.bin.slice(-1)),d.bin=parseInt(d.bin,10));d.bin=Math.max(1,d.bin||1);d.filter=v(d.filter,n.filter,"");this.raw.filter=d.filter||"";!1!==d.waiting&&a.waiting(!0,u.display);window.setTimeout(function(){switch(f){case "parentFile":b=u.proxyFile;t=[];t.push({name:"xcen",value:d.xcen});delete d.xcen;t.push({name:"ycen",value:d.ycen});delete d.ycen;t.push({name:"xdim",value:d.xdim});t.push({name:"ydim",value:d.ydim});void 0!==d.xdim&&(d.xdim=0);
void 0!==d.ydim&&(d.ydim=0);d.binMode&&(d.bin=sprintf("%s%s",d.bin,d.binMode),delete d.binMode);t.push({name:"bin",value:d.bin});delete d.bin;t.push({name:"filter",value:d.filter||""});t.push({name:"slice",value:d.slice||""});delete d.slice;g={id:u.expandMacro("$id"),image:u.file,fits:u.parentFile,rtype:"text"};g.cmd="js9Xeq imsection "+u.parentFile;d.extension&&(g.cmd=g.cmd.replace(/\[.*\]/,""),g.cmd+="["+d.extension+"]",delete d.extension);g.cmd+=u.expandMacro(" $xdim@$xcen,$ydim@$ycen,$bin $filter $slice",
t);a.helper.send("imsection",g,function(c){var e,f;c="object"===typeof c?c:0<=c.search(a.analOpts.epattern)?{stderr:c}:{stdout:c};if(c.stderr)a.error(c.stderr);else if(c.errcode)a.error("in displaySection: "+c.errcode);else{f=c.stdout.split(/\n/);c=a.cleanPath(f[0]);"/"!==c.charAt(0)&&(c=a.InstallDir(c));d.proxyFile=c;b&&b!==d.proxyFile&&u.removeProxyFile(b);if(f[1]){try{e=JSON.parse(f[1])}catch(z){a.log("couldn't parse imsection as JSON: %s",c),e=null}e&&(d.extname=e.extname,d.extnum=e.extnum,d.hdus=
e.hdus,d.parent=e)}f[2]&&(e=a.cleanPath(f[2]),d.parentFile=e);d.ltm2obin=!0;a.fetchURL(c,c,d,function(b){a.cleanupFITSFile(u.raw,!0);!1!==d.waiting&&a.waiting(!0,u.display);a.fits.handleFITSFile(b,d,p)})}});break;case "virtualFile":a.cleanupFITSFile(u.raw,!1);a.getFITSImage(e.fits,e,d,function(a){p(a,d)});break;default:a.error("image section cannot be extracted from this data file")}},a.SPINOUT)};a.Image.prototype.displayExtension=function(d,c,b){var e,f,g,h,k=this,l=function(d){var e,f=$.extend(!0,
{},c);f.separate=!0;if(d===k.hdus.length){if(b)try{a.xeqByName(b,window,k)}catch(q){a.error("in displayExtension callback",q,!1)}}else e=k.hdus[d],"image"===e.type&&2<=e.naxis?k.displayExtension(e.hdu,f,function(){l(d+1)}):l(d+1)};if("string"===typeof c)try{c=JSON.parse(c)}catch(n){a.error("can't parse extension opts: "+c,n)}c=c||{};c.waiting=!1;this.hdus||a.error("no FITS HDUs found for displayExtension()");a.isNull(d)&&a.error("missing extname/extnum for displayExtension()");if("all"===d)l(0);else{if("string"===
typeof d){c.extension=d;g=d.toLowerCase();for(f=e=0;e<this.hdus.length;e++)if(this.hdus[e].name&&this.hdus[e].name.toLowerCase()===g){f++;break}f||a.error(sprintf("no FITS HDU %s for displayExtension()",d))}else"number"===typeof d&&(c.extension=d,this.hdus[d]?g=this.hdus[d].name||d.toString():a.error(sprintf("no FITS HDU %s for displayExtension()",d)));if(c.separate){e=sprintf("[%s]",g);d=this.id.replace(/\[.*\]/,"")+e;for(f=e=0;e<a.images.length;e++)if(h=a.images[e],d===h.id&&0<$("#"+h.display.id).length&&
this.display.id===h.display.id){f++;break}if(f){h.displayImage("display",c);h.display.clearMessage();if(b)try{a.xeqByName(b,window,k)}catch(n){a.error("in displayExtension callback",n,!1)}return}}c.separate||a.cleanupFITSFile(this.raw,!1);this.displaySection(c,b);return this}};a.Image.prototype.displaySlice=function(d,c,b){var e;if("string"===typeof c)try{c=JSON.parse(c)}catch(f){a.error("can't parse slice opts: "+c,f)}c=c||{};c.waiting=!1;void 0===d&&a.error("missing slice for displaySlice()");if("all"===
d&&3===this.raw.header.NAXIS)for(this.displaySlice(1,e,b),d=2;d<=this.raw.header.NAXIS3;d++)e=$.extend(!0,{},c,{separate:!0}),this.displaySlice(d,e,b);else a.isNumber(d)?c.slice=sprintf("*:*:%s",d):c.slice=d,a.cleanupFITSFile(this.raw,!1),this.displaySection(c,b);return this};a.Image.prototype.toArray=function(d){var c,b,e,f,g,h,k,l,n=this.raw.data.buffer;d=d||{};d.simple=!0;d=a.raw2FITS(this.raw,d);h=2880-d.length%2880;2880===h&&(h=0);for(c=0;c<h;c++)d+=" ";h=2880-n.byteLength%2880;2880===h&&(h=
0);c=new ArrayBuffer(d.length+n.byteLength+h);k=new Uint8Array(c);for(c=0;c<d.length;c++)k[c]=d.charCodeAt(c);if(0<(new Int8Array((new Int16Array([1])).buffer))[0])for(g=d.length,f=Math.abs(this.raw.bitpix)/8,l=new Uint8Array(n),c=0;c<l.byteLength;c+=f)for(b=c+f-1,e=0;e<f;b--,e++)k[g++]=l[b];else k.set(new Uint8Array(n),d.length);g=d.length+n.byteLength;for(c=0;c<h;c++)k[g++]=0;return k};a.Image.prototype.wcsAlign=function(){return this.wcsim&&this.params.wcsalign&&this.display===this.wcsim.display};
a.Image.prototype.getPan=function(){var d=this.rgb.sect,c=(d.x0+d.x1)/2,b=(d.y0+d.y1)/2;a.notNull(d.ix)&&(c+=d.ix/(2*d.zoom));a.notNull(d.iy)&&(b+=d.iy/(2*d.zoom));return{x:c,y:b,ox:d.xcen,oy:d.ycen,x0:d.x0,y0:d.y0,x1:d.x1,y1:d.y1,ix:d.ix||0,iy:d.iy||0}};a.Image.prototype.setPan=function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e,f,g,h,k,l;h=$jscomp.makeIterator(c);b=h.next().value;h=h.next().value;if(!(0<=$.inArray("pan",this.params.disable))){0===c.length&&(b=this.raw.width/
2,h=this.raw.height/2);if(1===c.length&&"string"===typeof b)try{b=JSON.parse(b)}catch(n){a.error("can't parse setPan JSON: "+b,n)}"object"===typeof b&&(c=b,a.notNull(c.x)&&a.notNull(c.y)&&(b=c.x,h=c.y),a.notNull(c.px)&&a.notNull(c.py)&&(h=this.logicalToImagePos({x:c.px,y:c.py}),b=h.x,h=h.y),"string"===typeof c.wcs&&(k=c.wcs.trim().split(/ +/),c.ra=k[0],c.dec=k[1],3<=k.length&&(c.wcssys=k[2])),a.notNull(c.ra)&&a.notNull(c.dec)&&0<this.raw.wcs&&(c.wcssys&&(e=this.getWCSSys(),g=a.globalOpts.xeqPlugins,
a.globalOpts.xeqPlugins=!1,this.setWCSSys(c.wcssys)),"string"===typeof c.ra&&(c.ra=a.saostrtod(c.ra),":"===String.fromCharCode(a.saodtype())&&"galactic"!==this.params.wcssys&&"ecliptic"!==this.params.wcssys&&(c.ra*=15)),"string"===typeof c.dec&&(c.dec=a.saostrtod(c.dec)),k=a.wcs2pix(this.raw.wcs,c.ra,c.dec).trim().split(/ +/),b=parseFloat(k[0]),h=parseFloat(k[1]),e&&(this.setWCSSys(e),a.globalOpts.xeqPlugins=g)));a.isNumber(b)&&a.isNumber(h)||a.error("invalid input for setPan: "+b+" "+h);this.wcsAlign()&&
(l=a.globalOpts.panWithinDisplay,a.globalOpts.panWithinDisplay=!0);this.mkSection(b,h);if(this.display.blendMode)for(e=0;e<a.images.length;e++)g=a.images[e],g!==this&&g.display===this.display&&g.blend.active&&(g.wcsim===this||this.wcsim===g||g.wcsim&&g.wcsim===this.wcsim)&&(g.params.wcsalign||this.params.wcsalign)&&(c=a.pix2pix(this,g,{x:b,y:h}),g.mkSection(c.x,c.y));this.wcsAlign()&&(a.globalOpts.panWithinDisplay=l);this.displayImage("rgb");for(f in this.layers)this.layers.hasOwnProperty(f)&&this.layers[f].show&&
this.layers[f].opts.panzoom&&this.refreshShapes(f);a.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetpan");return this}};a.Image.prototype.getZoom=function(){return this.rgb.sect.zoom};a.Image.prototype.parseZoom=function(a){var c;c=this.rgb.sect.zoom;switch(typeof a){case "string":switch(a.charAt(0)){case "*":case "x":case "X":a=c*parseFloat(a.slice(1));break;case "/":a=c/parseFloat(a.slice(1));break;case "I":case "i":a=2*c;break;case "O":case "o":a=c/2;break;case "T":case "t":a=Math.min(this.display.width/
this.raw.width,this.display.height/this.raw.height);a=Math.round(1E6*(a+1E-7))/1E6;break;default:a=parseFloat(a)}break;case "number":break;default:return}return a};a.Image.prototype.setZoom=function(d){var c,b,e,f,g;if(!(0<=$.inArray("zoom",this.params.disable))){(c=this.parseZoom(d))||a.error("invalid input for setZoom: "+d);this.wcsAlign()&&(g=a.globalOpts.panWithinDisplay,a.globalOpts.panWithinDisplay=!0);this.mkSection(c);if(this.display.blendMode)for(d=0;d<a.images.length;d++)e=a.images[d],e!==
this&&e.display===this.display&&e.blend.active&&(e.wcsim===this||this.wcsim===e||e.wcsim&&e.wcsim===this.wcsim)&&(e.params.wcsalign||this.params.wcsalign)&&(f=a.pix2pix(this,e,this.getPan()),e.mkSection(f.x,f.y,c));this.wcsAlign()&&(a.globalOpts.panWithinDisplay=g);this.displayImage("rgb");for(b in this.layers)this.layers.hasOwnProperty(b)&&this.layers[b].show&&this.layers[b].opts.panzoom&&this.refreshShapes(b);a.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetzoom");return this}};a.Image.prototype.alignPanZoom=
function(d,c){var b,e,f;if(d)return"string"===typeof d&&((b=a.getImage(d))?d=b:a.error("unknown image for alignPanZoom: "+d)),f=this.raw.wcsinfo||{cdelt1:1},e=d.raw.wcsinfo||{cdelt1:1},b=d.getPan(),this.setPan(a.pix2pix(d,this,{x:b.ox,y:b.oy})),this.setZoom((d.rgb.sect.zoom||1)*f.cdelt1/e.cdelt1),this};a.Image.prototype.refreshLayers=function(){this.setZoom(this.getZoom());this.binning.obin=this.binning.bin;this.rgb.sect.ozoom=this.rgb.sect.zoom};a.Image.prototype.imageToLogicalPos=function(a,c){var b,
d,f,g,h,k="image",l=a.x;f=a.y;c=c||this.params.lcs||"image";switch(c){case "physical":this.lcs.physical&&(k=c,b=this.lcs.physical.reverse,d=this.lcs.physical.rrot,g=this.lcs.physical.cx,h=this.lcs.physical.cy);break;case "detector":this.lcs.detector&&(k=c,b=this.lcs.detector.reverse,d=this.lcs.detector.rrot,g=this.lcs.detector.cx,h=this.lcs.detector.cy);break;case "amplifier":this.lcs.amplifier&&(k=c,b=this.lcs.amplifier.reverse,d=this.lcs.amplifier.rrot,g=this.lcs.amplifier.cx,h=this.lcs.amplifier.cy)}b&&
(l=a.x*b[0][0]+a.y*b[1][0]+b[2][0],f=a.x*b[0][1]+a.y*b[1][1]+b[2][1],d&&(b=g+(l-g)*d[0][0]+(f-h)*d[1][0]+d[2][0],f=h+(l-g)*d[0][1]+(f-h)*d[1][1]+d[2][1],l=b),"table"===this.imtab&&(d=0>this.raw.bitpix?.5:1,void 0!==this.raw.header.TABMIN1&&(l=l-d+this.raw.header.TABMIN1),void 0!==this.raw.header.TABMIN2&&(f=f-d+this.raw.header.TABMIN2)));return{x:l,y:f,sys:k}};a.Image.prototype.logicalToImagePos=function(a,c){var b,d,f,g,h,k={x:a.x,y:a.y};f=this.raw.header.CRPIX1||1;g=this.raw.header.CRPIX2||1;c=
c||this.params.lcs||"image";switch(c){case "ophysical":this.lcs.ophysical?(b=this.lcs.ophysical.forward,d=this.lcs.ophysical.frot):this.lcs.physical&&(b=this.lcs.physical.forward,d=this.lcs.physical.frot);break;case "physical":this.lcs.physical&&(b=this.lcs.physical.forward,d=this.lcs.physical.frot);break;case "detector":this.lcs.detector&&(b=this.lcs.detector.forward,d=this.lcs.detector.frot);break;case "amplifier":this.lcs.amplifier&&(b=this.lcs.amplifier.forward,d=this.lcs.amplifier.frot)}b&&("table"===
this.imtab&&(h=0>this.raw.bitpix?.5:1,void 0!==this.raw.header.TABMIN1&&(a.x=a.x-this.raw.header.TABMIN1+h),void 0!==this.raw.header.TABMIN2&&(a.y=a.y-this.raw.header.TABMIN2+h)),k.x=a.x*b[0][0]+a.y*b[1][0]+b[2][0],k.y=a.x*b[0][1]+a.y*b[1][1]+b[2][1],d&&(b=f+(k.x-f)*d[0][0]+(k.y-g)*d[1][0]+d[2][0],d=g+(k.x-f)*d[0][1]+(k.y-g)*d[1][1]+d[2][1],k.x=b,k.y=d));return k};a.Image.prototype.displayToImagePos=function(a){var c=this.rgb.sect;return{x:(a.x-this.ix+.5)/c.zoom+c.x0+.5,y:(this.rgb.img.height-(a.y-
this.iy+.5))/c.zoom+c.y0+.5}};a.Image.prototype.imageToDisplayPos=function(a){var c=this.rgb.sect;return{x:(a.x-.5-c.x0)*c.zoom+this.ix-.5,y:(c.y0-(a.y-.5))*c.zoom+this.rgb.img.height+this.iy-.5}};a.Image.prototype.logicalToDisplayPos=function(a,c,b){return this.imageToDisplayPos(this.logicalToImagePos(a,c,b))};a.Image.prototype.displayToLogicalPos=function(a){return this.imageToLogicalPos(this.displayToImagePos(a))};a.Image.prototype.getWCSSys=function(){if(this.params.wcssys)return this.params.wcssys};
a.Image.prototype.setWCSSys=function(d){if(!(0<=$.inArray("wcs",this.params.disable)))return"image"===d?(this.params.wcssys="image",this.params.wcsunits="pixels",a.wcsunits.image="pixels"):"physical"===d?(this.params.wcssys="physical",this.params.wcsunits="pixels",a.globalOpts.wcsUnits.physical="pixels"):this.raw.wcs&&0<this.raw.wcs&&("native"===d&&(d=this.params.wcssys0),d=a.wcssys(this.raw.wcs,d))&&(this.params.wcssys=d.trim(),d=a.globalOpts.wcsUnits[this.params.wcssys]||"sexagesimal",this.setWCSUnits(d)),
a.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetwcssys"),this};a.Image.prototype.initWCS=function(d){var c,b,e,f=/(WCSNAME|WCSAXES|CRVAL[0-9]|CRPIX[0-9]|PC[0-9]_[0-9]|CDELT[0-9]|CD[0-9]_[0-9]|CTYPE[0-9]|CUNIT[0-9]|CRVAL[0-9]|PV[0-9]_[0-9]|PS[0-9]_[0-9]|RADESYS|LONPOLE|LATPOLE)([A-Z])/;if(!this.raw.header)return this;d=d||this.raw.header;this.freeWCS();this.raw.altwcs={};c="default";this.raw.altwcs[c]={};this.raw.altwcs[c].header=d;for(b in d)d.hasOwnProperty(b)&&(e=b.match(f))&&e.length&&
(c=e[2],this.raw.altwcs[c]||(this.raw.altwcs[c]={},this.raw.altwcs[c].header=$.extend({},d)),"RADESYS"===e[1]&&(e[1]="RADECSYS"),this.raw.altwcs[c].header[e[1]]=d[e[0]]);for(b in this.raw.altwcs)if(this.raw.altwcs.hasOwnProperty(b)&&(d=a.raw2FITS(this.raw.altwcs[b].header),this.raw.altwcs[b].wcs=a.initwcs(d),0<this.raw.altwcs[b].wcs))try{this.raw.altwcs[b].wcsinfo=JSON.parse(a.wcsinfo(this.raw.altwcs[b].wcs))}catch(g){}this.setWCS("default");return this};a.Image.prototype.freeWCS=function(d){var c;
d=d||this.raw;if(d.altwcs)for(c in d.altwcs)d.altwcs.hasOwnProperty(c)&&0<d.altwcs[c].wcs&&(a.freewcs(d.altwcs[c].wcs),d.altwcs[c].wcs=null)};a.Image.prototype.getWCS=function(){var a,c;for(a in this.raw.altwcs)if(this.raw.altwcs.hasOwnProperty(a)&&this.raw.wcs===this.raw.altwcs[a].wcs)return c=$.extend(!0,{},this.raw.altwcs[a].wcsinfo),c.version=a,c.wcsname=this.raw.altwcs[a].header.WCSNAME,c;return null};a.Image.prototype.setWCS=function(d){var c,b;d=d||"default";if(!this.raw||!this.raw.altwcs)return this;
for(c in this.raw.altwcs)if(this.raw.altwcs.hasOwnProperty(c)&&(b=this.raw.altwcs[c].header.WCSNAME,d===c||d===b))return 0>=this.raw.altwcs[c].wcs&&a.error("invalid WCS for version: %s",d),this.raw.wcs=this.raw.altwcs[c].wcs,this.raw.wcsinfo=this.raw.altwcs[c].wcsinfo,d=this.raw.wcsinfo&&this.raw.wcsinfo.radecsys?this.raw.wcsinfo.radecsys:"native"!==this.params.wcssys?this.params.wcssys.trim():this.params.lcs,this.setWCSSys(d),this.params.wcssys0||(this.params.wcssys0=d),this.setWCSUnits(this.params.wcsunits),
this;a.error("could not find WCS version: "+d)};a.Image.prototype.getWCSUnits=function(){return this.params.wcsunits?this.params.wcsunits:"pixels"};a.Image.prototype.setWCSUnits=function(d){var c;if(!(0<=$.inArray("wcs",this.params.disable))){if("pixels"===d)this.params.wcssys="physical",this.params.wcsunits="pixels",a.globalOpts.wcsUnits[this.params.wcssys]="pixels";else if(this.raw.wcs&&0<this.raw.wcs){if("image"===this.params.wcssys||"physical"===this.params.wcssys)c=a.imageOpts.wcssys,this.setWCSSys(this.raw.wcs,
c);if(d=a.wcsunits(this.raw.wcs,d))this.params.wcsunits=d.trim(),a.globalOpts.wcsUnits[this.params.wcssys]=this.params.wcsunits}a.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetwcsunits");return this}};a.Image.prototype.notifyHelper=function(){var d,c,b;c=new RegExp("^"+a.ANON+"[0-9]*");var e=a.INSTALLDIR?new RegExp("^"+a.INSTALLDIR):null,f=this;if(a.helper.connected&&!this.file.match(c)){switch(a.helper.type){case "get":case "post":a.helper.pageid||a.helper.send("pageid",null,function(b){b&&
b.trim().match(/^[a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12}$/)&&(a.helper.pageid=b,a.helper.js9helper="js9helper")})}c=this.file;"/"!==c.charAt(0)&&e&&(b=this.file.replace(e,""));a.helper.send("image",{image:c,image2:b},function(b){var c;"object"===typeof b?(c=b.stdout,b.stderr&&1<a.DEBUG&&a.log(b.stderr)):c=b;c&&(b=c.trim().match(/(?:[^\s[]+|\[[^\]]*\])+/g),f&&(b=b[1],"?"!==b&&(a.globalOpts.dataDir?(c=b.lastIndexOf("/")+1,f.fitsFile=a.globalOpts.dataDir+"/"+b.slice(c)):
(f.fitsFile=b,0>f.fitsFile.indexOf("/")&&(d=f.file.match(/.*\//))&&d.length&&(b=new RegExp("^"+a.INSTALLDIR),d=d[0].replace(b,""),f.fitsFile=d+f.fitsFile),a.globalOpts.prependJS9Dir&&(f.fitsFile&&!f.fitsFile.match(/^\${JS9_DIR}/)&&"/"!==f.fitsFile.charAt(0)&&(f.fitsFile="${JS9_DIR}/"+f.fitsFile),f.parentFile&&!f.parentFile.match(/^\${JS9_DIR}/)&&"/"!==f.parentFile.charAt(0)&&(f.parentFile="${JS9_DIR}/"+f.parentFile))),1<a.DEBUG&&a.log("JS9 fitsFile: %s %s",f.file,f.fitsFile))),f&&f.fitsFile&&(f.fitsFile=
a.cleanPath(f.fitsFile)),f&&f.parentFile&&(f.parentFile=a.cleanPath(f.parentFile)),f.queried||(f.queryHelper("all"),f.queried=!0))})}return this};a.Image.prototype.queryHelper=function(d){var c=this;d=d||"all";!a.helper.connected||"all"!==d&&"getAnalysis"!==d||this.analysisPackages||a.helper.send("getAnalysis",{fits:this.fitsFile},function(b){if(b)try{c.analysisPackages=JSON.parse(b)}catch(e){a.log("can't get analysis",e)}});return this};a.Image.prototype.expandMacro=function(d,c){var b,e=this;if(d)return d.replace(/\${?([a-zA-Z][a-zA-Z0-9_()]+)}?/g,
function(d,g,h){var f;h=function(a,b){var c=a.params.wcssys;if(b)switch(b){case "wcs":if("physical"===c||"image"===c)a.params.wcssys=a.params.wcssys0;break;case "physical":case "image":a.params.wcssys=b}return c};var l=function(a,b){var c;"table"===a.imtab?a.raw.hdu.table.filter&&!b.match(a.raw.hdu.table.filter)&&(b=b.match(/\]\[/)?b.slice(0,-1)+"&&"+a.raw.hdu.table.filter+"]":b+("["+a.raw.hdu.table.filter+"]")):"image"===a.imtab&&(c=a.file.match(/\[.*\]/))&&(b=b.match(/\[.*\]/)?b.replace(/\[.*\]/,
c):b+c);return b},n=g.split("(");n[1]&&(n[1]=n[1].replace(/\)$/,""));switch(n[0]){case "id":f=e.display.divjq.attr("id");break;case "image":case "png":f=e.id;break;case "filename":e.parentFile&&"this"!==n[1]?e.raw&&e.raw.filter?(f=e.parentFile,f.match(/\[.*\]/)||(f+="[EVENTS]"),f+="["+e.raw.filter+"]"):f=l(e,e.parentFile):e.fitsFile?f=l(e,e.fitsFile):a.error("no FITS file for "+e.id);break;case "fits":e.fitsFile||a.error("no FITS file for "+e.id);f=l(e,e.fitsFile);break;case "parent":e.parentFile||
a.error("no parent FITS file for "+e.id);f=e.parentFile;break;case "ext":e.fitsFile?(f=e.fitsFile.match(/\[.*\]/),null===f&&(f="")):a.error("no FITS file for "+e.id);break;case "imcenter":f=e.displayToLogicalPos({x:e.display.width/2,y:e.display.height/2});f=sprintf("%s,%s",f.x,f.y);break;case "wcscenter":f=e.displayToImagePos({x:e.display.width/2,y:e.display.height/2});f=a.pix2wcs(e.raw.wcs,f.x,f.y).replace(/\s+/g,",");break;case "sregions":d=h(e,n[1]);f=e.listRegions("source",{mode:0}).replace(/\s+/g,
"");d&&(e.params.wcssys=d);break;case "bregions":d=h(e,n[1]);f=e.listRegions("background",{mode:0}).replace(/\s+/g,"");d&&(e.params.wcssys=d);break;case "regions":d=h(e,n[1]);f=e.listRegions("all",{mode:0}).replace(/\s+/g,"");d&&(e.params.wcssys=d);break;default:if(c)for(b=c.length,h=0;h<b;h++)if(c[h].name===g){f=c[h].value;break}void 0===f&&(f=d)}return f})};a.Image.prototype.lookupAnalysis=function(a){var c,b,d,f=null;if(this.analysisPackages){for(b=0;b<this.analysisPackages.length&&!f;b++)for(d=
this.analysisPackages[b],c=0;c<d.length;c++){f=d[c];if(f.xclass&&f.xclass+":"+f.name===a)break;f=null}if(f)return f;for(b=0;b<this.analysisPackages.length&&!f;b++)for(d=this.analysisPackages[b],c=0;c<d.length;c++){f=d[c];if(f.name===a)break;f=null}}return f};a.Image.prototype.validateAnalysis=function(d){var c,b,e=/imVar\((.*),(.*)\)/,f=/js9Var\((.*),(.*)\)/;c=/fitsHeader\(([A-Za-z0-9_]+),(.*)\)/;var g=/winVar\((.*),(.*)\)/,h=function(a,b){return a&&b?String(a).toUpperCase()===String(b).toUpperCase():
!1};if(!d.title||!d.name||d.hidden)return!1;if(d.files){if(d.files.match(/^fits$/)&&!this.fitsFile||d.files.match(/^png$/)&&"fits2png"!==this.source||d.files.match(/^table$/)&&"table"!==this.imtab||d.files.match(/^image$/)&&"image"!==this.imtab)return!1;if(b=d.files.match(c))if(c=this.raw.header[b[1].toUpperCase()],!h(c,b[2]))return!1;if(b=d.files.match(g))if(c=a.varByName(b[1],window),!h(c,b[2]))return!1;if(b=d.files.match(f))if(c=a.varByName(b[1],a),!h(c,b[2]))return!1;if(b=d.files.match(e))if(c=
a.varByName(b[1],this),!h(c,b[2]))return!1}return!0};a.Image.prototype.getAnalysis=function(){var a,c,b,e,f=[];if(!this.analysisPackages)return f;for(c=0;c<this.analysisPackages.length;c++)for(e=this.analysisPackages[c],a=0;a<e.length;a++)b=e[a],this.validateAnalysis(b)&&f.push(b);return f};a.Image.prototype.runAnalysis=function(d,c,b){var e,f,g={},h=this,k=function(b,c){a.helper||a.error(b,c);switch(a.helper.type){case "nodejs":case "socket.io":a.helper.socket&&"polling"===a.helper.socket.io.engine.transport.name?
window.setTimeout(function(){a.error(b,c)},0):a.error(b,c);break;default:a.error(b,c)}};if("string"===typeof c)try{c=JSON.parse(c)}catch(l){a.error("can't parse analysis opts: "+c,l)}b=b||a.globalOpts.analysisFunc;if(a.helper.connected&&this.analysisPackages){if(e=this.lookupAnalysis(d)){e.action&&(g.cmd=this.expandMacro(e.action,c));if(e.keys)for(g.keys={},d=0;d<e.keys.length;d++)g.keys[e.keys[d]]=this.expandMacro("$"+e.keys[d],c);g.id=this.expandMacro("$id");g.image=this.file;g.fits=this.fitsFile;
g.rtype=e.rtype;switch(a.helper.type){case "nodejs":case "socket.io":d=e.xclass?e.xclass+":"+e.name:e.name;break;default:d="runAnalysis"}a.waiting(!0,this.display);a.helper.send(d,g,function(d){var l,m;a.waiting(!1);l="object"===typeof d?d:0<=d.search(a.analOpts.epattern)?{stderr:d}:{stdout:d};l.errcode=l.errcode||0;if(b)b.call(h,l.stdout,l.stderr,l.errcode,e);else{if(l.stderr)if(d=l.stderr,0<=d.search(/WARNING:/i)&&0>d.search(/ERROR:/i))a.log(d);else{k(d,a.analOpts.epattern);return}else if(l.errcode)if(d=
sprintf("ERROR: running %s [%s]",e.name,l.errcode),l.stdout)a.log(d);else{k(d,a.analOpts.epattern);return}switch(e.rtype){case "text":case void 0:h.displayAnalysis("text",l.stdout,{divid:a.globalOpts.analysisDiv});break;case "plot":h.displayAnalysis("plot",l.stdout,{divid:a.globalOpts.analysisDiv});break;case "alert":l.stdout&&alert(l.stdout);break;case "fits":case "png":(m=l.stdout.split(/\s+/))&&m[0]&&(d=a.cleanPath(m[0]),"/"!==d.charAt(0)&&(d=a.InstallDir(d)),l={proxyFile:d},m[1]&&(m=a.cleanPath(m[1]),
l.parentFile=m),l.fits2fits=!1,l.fixpath=!1,a.Load(d,l,{display:h.display}));break;case "regions":if((m=l.stdout.split(/\s+/))&&m[0]){if(1<m.length)try{f=JSON.parse(m[1])}catch(r){f=null}f=f||{};"boolean"===typeof f.remove&&(f.remove="all");"string"===f.type?(f.remove&&h.removeShapes("regions",f.remove),h.addShapes("regions",m[0],c)):(d=a.cleanPath(m[0]),"/"!==d.charAt(0)&&(d=a.InstallDir(d)),g={responseType:"text"},a.fetchURL(null,d,g,function(a,b){f.remove&&h.removeShapes("regions",f.remove);h.addShapes("regions",
a,b)}))}break;case "catalog":(m=l.stdout.split(/\s+/))&&m[0]&&(d=a.cleanPath(m[0]),g={responseType:"text"},a.fetchURL(null,d,g,function(a,b){h.loadCatalog(null,a,b)}));break;case "none":break;default:a.error("unknown analysis result type: "+e.rtype)}}});return this}a.error("could not find analysis task: "+d)}};a.Image.prototype.displayAnalysis=function(d,c,b){var e,f,g,h,k,l,n,m,r,q={x:"linear",y:"linear"};m=a.lightOpts[a.LIGHTWIN];var t=function(a){return 0===a?a:Math.log(a)},u=function(a){return 0===
a?a:Math.exp(a)},v=function(a,b){var c,d,e;if(!a.text)return null;d=a.x||0;if("%Y"===a.y.toUpperCase())for(c=1;c<b.length-1;c++){if(b[c][0]>d){e=Math.max(b[c-1][1],b[c][1],b[c+1][1]);break}}else e=a.y;return{x:d,y:e}},p=function(a,b,c,d){switch(c){case "x":c=b.getAxes().xaxis;break;case "y":c=b.getAxes().yaxis}switch(d){case "linear":c.options.transform=null;c.options.inverseTransform=null;break;case "log":c.options.transform=t,c.options.inverseTransform=u}q[c]=d;b.setupGrid();b.draw()},w=function(b,
c,d){var e,f,g,h=d.data,k=d.annotations.color||a.plotOpts.annotateColor;b.find(".plotAnnotation").remove();for(e=0;e<d.annotations.data.length;e++)f=d.annotations.data[e],g=v(f,h),g=c.pointOffset({x:g.x,y:g.y}),0>g.left||g.left>b.width()||(f=sprintf("<div class='plotAnnotation' style='position: absolute; left: %spx; top:%spx; color: %s; font-size: small'>%s</div>",g.left,g.top+-25,k,"&darr;"+f.text),b.append(f))},x=function(a,b,c,d){var e;switch(c){case "x":e={xaxis:{type:d,autorange:!0}};break;case "y":e=
{yaxis:{type:d,autorange:!0}}}Plotly.restyle(a.attr("id"),e)},A=function(b){var c,d,e,f=b.data,g=b.annotations.color||a.plotOpts.annotateColor,h=[];for(c=0;c<b.annotations.data.length;c++)if(d=b.annotations.data[c],e=v(d,f))d={x:e.x,y:e.y,xref:"x",yref:"y",text:d.text,arrowcolor:g,font:{color:g},showarrow:!0,arrowhead:2,ax:0,ay:-30},h.push(d);return h};if("string"===typeof b)try{b=JSON.parse(b)}catch(z){a.error("can't parse display opts: "+b,z)}b=b||{};e=b.winformat;b.divid&&0<$("#"+b.divid).length&&
(l=$("#"+b.divid));k=b.title||"";this&&!k&&(b=this.fitsFile||this.id||"",b=b.split("/").reverse()[0],k="AnalysisResults: "+b+sprintf(a.IDFMT,this.display.id));b="Analysis_"+a.uniqueID();switch(d){case "text":c="<div class='JS9Analysis'></div>"+("<pre class='JS9AnalysisText'>"+(c||"")+"</pre>")+"</div>";l?l.html(c):(e=e||m.textWin,f=a.lightWin(b,"inline",c,k,e));break;case "plot":if("string"===typeof c)try{g=JSON.parse(c)}catch(z){a.error("can't plot return data: "+c,z)}else"object"===typeof c&&(g=
c);if(!g)return;c=sprintf("<div id='%s' class='JS9Analysis'><div id='%sPlot' class='JS9Plot' ></div></div>",b,b);l?l.html(c):(e=e||m.plotWin,f=a.lightWin(b,"inline",c,k,e));h=$("#"+b+" #"+b+"Plot");l&&(h.css("width",l.css("width")),h.css("height",l.css("height")),h.css("margin",0));if(g.data){switch(a.globalOpts.plotLibrary){case "plotly":r=x;m=$.extend(!0,{},a.plotOpts,g.opts);g.label&&(m.title=g.label);c={x:[],y:[],type:"scatter"};3<=g.data[0].length&&(c.error_y={type:"data",array:[],visible:!0},
g.points&&g.points.yerr&&g.points.yerr.color&&(c.error_y.color=g.points.yerr.color));for(e=0;e<g.data.length;e++)c.x.push(g.data[e][0]),c.y.push(g.data[e][1]),c.error_y&&c.error_y.array&&c.error_y.array.push(g.data[e][2]);a.plotOpts.annotate&&g.annotations&&(m.annotations=A(g));"log"===m.xscale&&(m.xaxis=m.xaxis||{},m.xaxis.type="log",m.xaxis.autorange=!0,q.x="log");"log"===m.yscale&&(m.yaxis=m.yaxis||{},m.yaxis.type="log",m.yaxis.autorange=!0,q.y="log");try{Plotly.newPlot(h.attr("id"),[c],m)}catch(z){a.error("can't plot data (plotly)",
z)}break;default:r=p;m=$.extend(!0,{},a.plotOpts,g.opts);a.plotOpts.annotate&&g.annotations&&(m.zoomStack.func=function(a,b){w(h,a,g)});g.color=g.color||m.color;"log"===g.xscale&&(m.xaxis=m.xaxis||{},m.xaxis.transform=t,m.xaxis.inverseTransform=u,q.x="log");"log"===g.yscale&&(m.yaxis=m.yaxis||{},m.yaxis.transform=t,m.yaxis.inverseTransform=u,q.y="log");try{n=$.plot(h,[g],m)}catch(z){a.error("can't plot data (flot)",z)}a.plotOpts.annotate&&g.annotations&&w(h,n,g)}h.css("outline","none");h.attr("tabindex",
0);h.on("keypress",function(a){a=String.fromCharCode(a.which||a.keyCode);if("linear"===q[a])q[a]="log";else if("log"===q[a])q[a]="linear";else return;r(h,n,a,q[a])})}break;case "params":case "regions":case "textline":l?a.allinone?l.html(c):$.ajax({url:c,cache:!1,dataType:"text",success:function(a){l.html(a)}}):(e="params"===d?e||m.paramWin:"regions"===d?"small"===a.globalOpts.regionConfigSize?e||m.regWin0:e||m.regWin:e||m.dpathWin,f=a.allinone?"inline":"ajax",f=a.lightWin(b,f,c,k,e))}return f};a.Image.prototype.loadAuxFile=
function(d,c){var b,e,f,g,h=a.auxFiles.length,k=[],l=this,n=function(){l.aux[e.name]=e;a.Image.prototype.mkOffScreenCanvas.call(g);a.Image.prototype.mkRawDataFromPNG.call(g);if(c)try{a.xeqByName(c,window,l,e)}catch(t){a.error("in aux mask onload callback",t)}a.DEBUG&&a.log("JS9 %s: %s dims(%d,%d) min/max(%d,%d)",g.type,g.file,g.raw.width,g.raw.height,g.raw.dmin,g.raw.dmax)},m=function(b){l.aux[e.name]=e;e.regions=b;if(c)try{a.xeqByName(c,window,l,e)}catch(u){a.error("in aux region onload callback",
u)}},r=function(b){l.aux[e.name]=e;e.text=b;if(c)try{a.xeqByName(c,window,l,e)}catch(u){a.error("in aux text onload callback",u)}},q=function(b,c,d){a.log(sprintf("could not load auxiliary file: %s [%s]",e.url,c))};if(d&&h){for(b=0;b<h;b++)e=a.auxFiles[b],e.image&&!e.regex&&(e.regex=new RegExp(e.image));f=d.split(":");for(b=0;b<h;b++)if(e=a.auxFiles[b],f[0]===e.name&&this.id.match(e.regex)&&(1===f.length||f[1]===e.type))switch(e.type){case "mask":if(e.im){if(this.aux[e.name]=e,c)try{a.xeqByName(c,
window,this,e)}catch(t){a.error("in aux mask callback",t)}}else k.push(e);break;case "regions":if(e.layer){if(this.aux[e.name]=e,c)try{a.xeqByName(c,window,this,e)}catch(t){a.error("in aux regions callback",t)}}else k.push(e);break;case "text":if(e.text){if(this.aux[e.name]=e,c)try{a.xeqByName(c,window,this,e)}catch(t){a.error("in aux text callback",t)}}else k.push(e)}for(b=0;b<k.length;b++)switch(e=k[b],e.type){case "mask":e.im=Object.create(a.Image);g=e.im;g.type="aux";g.file=e.url;g.id=g.file.split("/").reverse()[0];
g.params={};g.params.scalemin=Number.NaN;g.params.scalemax=Number.NaN;g.raws=[];g.png={};g.png.image=new Image;$(g.png.image).on("load",n).on("error",q);g.png.image.src=a.InstallDir(e.url);break;case "regions":e.layer=this.display.newShapeLayer(d,a.Regions.opts);f=a.InstallDir(e.url);$.ajax({url:f,cache:!1,dataType:"json",mimeType:"application/json",success:m,error:q});break;case "text":f=a.InstallDir(e.url),$.ajax({url:f,cache:!1,dataType:"text",success:r,error:q})}}};a.Image.prototype.saveFITS=
function(d){var c;window.hasOwnProperty("saveAs")?(d=d?d.replace(/\.fz$/i,"").replace(/(png|jpg|jpeg)$/i,"fits"):"js9.fits",c=this.toArray({notab:!0,twoaxes:!0}),c=new Blob([c],{type:"application/octet-binary"}),saveAs(c,d)):a.error("no saveAs function available to save FITS file");return d};a.Image.prototype.saveIMG=function(d,c,b){var e,f,g,h,k,l;if(window.hasOwnProperty("saveAs")){if("number"===typeof b)l=b,b=null;else if("string"===typeof b){if(a.isNumber(b))l=parseFloat(b),b=null;else try{b=
JSON.parse(b)}catch(n){b=null}b&&(l=b.quality)}d=d||"js9.png";c=c||"image/png";b=b||{};h=this.display.width;k=this.display.height;f=document.createElement("canvas");f.setAttribute("width",h);f.setAttribute("height",k);g=f.getContext("2d");"image"===b.source?g.putImageData(this.rgb.img,0,0):g.drawImage(this.display.canvas,0,0);if(!1!==b.layers)for(e in this.layers)this.layers.hasOwnProperty(e)&&"main"===this.layers[e].dlayer.dtype&&this.layers[e].show&&(b=this.layers[e].dlayer.canvasjq[0],g.drawImage(b,
0,0,h,k));a.notNull(l)&&(0>l||1<l)&&(l=.95);f.toBlob(function(a){saveAs(a,d)},c,l)}else a.error("no saveAs function available for saving image");return d};a.Image.prototype.savePNG=function(a,c){a=a||"js9.png";a.match(/\.png$/)||(a+=".png");return this.saveIMG(a,"image/png",c)};a.Image.prototype.saveJPEG=function(a,c){a=a||"js9.jpg";a.match(/\.jpg$/)||a.match(/\.jpeg$/)||(a+=".jpg");return this.saveIMG(a,"image/jpeg",c)};a.Image.prototype.updateValpos=function(d,c){var b,e,f,g,h,k,l,n,m,r;b=null;
var q=a.floatPrecision(this.params.scalemin,this.params.scalemax);f=function(a,b){var c,d="";b=b||3;0>a&&(a=Math.abs(a),d="-");for(c=""+a;c.length<b;)c="0"+c;return d+c};if(this.params.valpos){void 0===c&&(c=!0);if(this.valpos)return c&&this.display.displayMessage("info",this.valpos,a.globalOpts.valposTarget),this.valpos;k={x:d.x,y:d.y,sys:"image"};l="image"===this.params.wcssys?k:this.imageToLogicalPos(d);b=this.raw.data[Math.floor(d.y-.5)*this.raw.width+Math.floor(d.x-.5)];switch(this.raw.bitpix){case 8:case 16:case -16:case 32:h=
f(b);break;case -32:case -64:h=a.floatFormattedString(b,q,3);break;default:h=f(b)}f=h;g=l.x.toFixed(3)+" "+l.y.toFixed(3)+" ("+l.sys+")";e=f+"&nbsp;&nbsp;&nbsp;&nbsp;"+g;b={ix:k.x,iy:k.y,ipos:k.x.toFixed(2)+"\t\t "+k.y.toFixed(2),isys:"image",px:l.x,py:l.y,ppos:l.x.toFixed(2)+"\t\t "+l.y.toFixed(2),psys:l.sys,ra:"",dec:"",wcspos:"",wcssys:"",racen:"",deccen:"",wcsfov:"",wcspix:"",val:b,val3:h,id:this.id,file:this.file,object:this.object};if(this.telescope||this.instrument)b.object+="  (",this.telescope&&
(b.object+=this.telescope,this.instrument&&(b.object+=", ")),this.instrument&&(b.object+=this.instrument),b.object+=")";0<this.raw.wcs&&"image"!==this.params.wcssys&&"physical"!==this.params.wcssys&&(k=a.pix2wcs(this.raw.wcs,d.x,d.y).trim().split(/\s+/),e=k[0]+" "+k[1]+" ("+(k[2]||"wcs")+")",e=f+"&nbsp;&nbsp;&nbsp;&nbsp;"+e+"&nbsp;&nbsp;&nbsp;&nbsp;"+g,b.ra=k[0],b.dec=k[1],b.wcspos=k[0]+"\t "+k[1],b.wcssys=k[2],this.raw.wcsinfo&&(k=Math.abs(this.raw.wcsinfo.cdelt1),n=Math.abs(this.raw.wcsinfo.cdelt2),
l=1/60,1<=k||1<=n?h="deg":k>=l||n>=l?(h="'",k*=60,n*=60):(h='"',k*=3600,n*=3600),m=this.rgb.sect,r=this.binning.bin,l=((m.x1-m.x0)*k).toFixed(0),n=((m.y1-m.y0)*n).toFixed(0),b.wcsfov=l+h+" x "+n+h,l=a.floatFormattedString(k*r/m.zoom,q,3),b.wcspix=l+h+" / pixel",b.wcsfovpix=b.wcsfov+"  ("+b.wcspix+")",k=a.pix2wcs(this.raw.wcs,(m.x1+m.x0)/2,(m.y1+m.y0)/2).trim().split(/\s+/),b.racen=k[0],b.deccen=k[1],b.wcscen=k[0]+"\t "+k[1]));b.vstrsmall=f+"&nbsp;&nbsp;&nbsp;&nbsp;"+g;b.vstr=e;b.vstrmedium=e;b.vstrlarge=
e+"&nbsp;&nbsp;&nbsp;&nbsp;"+this.file;c&&this.display.displayMessage("info",b,a.globalOpts.valposTarget)}return b};a.Image.prototype.toggleValpos=function(){this.params.valpos=!this.params.valpos;this.params.valpos||this.display.clearMessage()};a.Image.prototype.getColormap=function(){if(this.cmapObj)return{colormap:this.cmapObj.name,contrast:this.params.contrast,bias:this.params.bias}};a.Image.prototype.setColormap=function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e=$jscomp.makeIterator(c),
b=e.next().value,f=e.next().value,e=e.next().value;if(!(0<=$.inArray("colormap",this.params.disable)&&this.cmapObj)){switch(c.length){case 1:case 3:switch(b){case "rgb":a.globalOpts.rgb.active=!a.globalOpts.rgb.active;break;case "invert":this.params.invert=!this.params.invert;break;case "reset":this.params.invert=a.imageOpts.invert;this.params.contrast=a.imageOpts.contrast;this.params.bias=a.imageOpts.bias;break;default:if(this.cmapObj)switch(this.cmapObj.name){case "red":this===a.globalOpts.rgb.rim&&
(a.globalOpts.rgb.rim=null);break;case "green":this===a.globalOpts.rgb.gim&&(a.globalOpts.rgb.gim=null);break;case "blue":this===a.globalOpts.rgb.bim&&(a.globalOpts.rgb.bim=null)}this.cmapObj=a.lookupColormap(b);this.params.colormap=this.cmapObj.name;switch(b){case "red":a.globalOpts.rgb.rim=this;break;case "green":a.globalOpts.rgb.gim=this;break;case "blue":a.globalOpts.rgb.bim=this}}3===c.length&&(isNaN(f)||(this.params.contrast=f),isNaN(e)||(this.params.bias=e));break;case 2:isNaN(b)||(this.params.contrast=
b),isNaN(f)||(this.params.bias=f)}this.displayImage("colors");this.xeqstash&&this.xeqstash.filterRGBImage&&delete this.xeqstash.filterRGBImage;a.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetcolormap");return this}};a.Image.prototype.getScale=function(){if(this.params.scale)return{scale:this.params.scale,scalemin:this.params.scalemin,scalemax:this.params.scalemax,scaleclipping:this.params.scaleclipping}};a.Image.prototype.setScale=function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-
0]=arguments[b];var e=$jscomp.makeIterator(c),b=e.next().value,f=e.next().value,e=e.next().value,g=this,h=function(b){0<=a.scales.indexOf(b)?g.params.scale=b:"dataminmax"===b?(g.params.scaleclipping="dataminmax",g.params.scalemin=g.raw.dmin,g.params.scalemax=g.raw.dmax):"zscale"===b?(void 0!==g.params.z1&&void 0!==g.params.z2||g.zscale(!1),g.params.scaleclipping="zscale",g.params.scalemin=g.params.z1,g.params.scalemax=g.params.z2):"zmax"===b?(void 0===g.params.z1&&g.zscale(!1),g.params.scaleclipping=
"zmax",g.params.scalemin=g.params.z1,g.params.scalemax=g.raw.dmax):"user"===b?g.params.scaleclipping="user":a.error("unknown scale: "+b)};if(!(0<=$.inArray("scale",this.params.disable))){if(c.length){switch(c.length){case 1:h(b);break;case 2:this.params.scalemin=parseFloat(b);this.params.scalemax=parseFloat(f);this.params.scaleclipping="user";break;default:h(b),"zscale"!==b&&"zmax"!==b&&(this.params.scalemin=parseFloat(f),this.params.scalemax=parseFloat(e),this.params.scaleclipping="user")}this.displayImage("colors")}a.globalOpts.extendedPlugins&&
this.xeqPlugins("image","onsetscale");return this}};a.Image.prototype.getParam=function(a){return a?"all"===a?this.params:this.params[a]:null};a.Image.prototype.setParam=function(a,c){var b,d;if(!a)return null;if("all"===a&&"object"===typeof c){$.extend(!0,this.params,c);if(c.colormap||c.contrast||c.bias)d=this.getColormap(),c.colormap=c.colormap||d.colormap,c.contrast=c.contrast||d.contrast,c.bias=c.bias||d.bias,this.setColormap(c.colormap,c.contrast,c.bias);if(c.scale||c.scalemin||c.scalemax)d=
this.getScale(),c.scale=c.scale||d.scale,c.scalemin=c.scalemin||d.scalemin,c.scalemax=c.scalemax||d.scalemax,this.setScale(c.scale,c.scalemin,c.scalemax);c.invert&&(this.params.invert=c.invert,this.displayImage("colors"));c.zoom&&this.setZoom(c.zoom);c.wcssys&&this.setWCSSys(c.wcssys);c.wcsunits&&this.setWCSUnits(c.wcsunits);return this.params}if("disable"===a){$.isArray(c)||(c=[c]);for(b=0;b<c.length;b++)d=$.inArray(c[b],this.params.disable),0>d&&this.params.disable.push(c[b]);return this.params.disable}if("enable"===
a){$.isArray(c)||(c=[c]);for(b=0;b<c.length;b++)d=$.inArray(c[b],this.params.disable),0<=d&&this.params.disable.splice(d,1);return this.params.disable}b=this.params[a];this.params[a]=c;switch(a){case "colormap":this.setColormap(c);break;case "invert":this.displayImage("colors");break;case "contrast":d=this.getColormap();this.setColormap(d.colormap,c,d.bias);break;case "bias":d=this.getColormap();this.setColormap(d.colormap,d.contrast,c);break;case "scale":this.setScale(c);break;case "scalemin":d=
this.getScale();this.setScale("user",c,d.scalemax);break;case "scalemax":d=this.getScale();this.setScale("user",d.scalemin,c);break;case "scaleclipping":d=this.getScale();this.setScale(c,d.scalemin,d.scalemax);break;case "wcssys":this.setWCSSys(c);break;case "wcsunits":this.setWCSUnits(c);break;case "zoom":this.setZoom(c)}return b};a.Image.prototype.dataminmax=function(a,c){var b,d,f=isNaN(this.params.scalemin)||void 0===this.params.scalemin,g=isNaN(this.params.scalemax)||void 0===this.params.scalemax;
if("dataminmax"===this.params.scaleclipping){if(this.raw.dmin===this.params.scalemin||void 0===this.raw.dmin)f=!0;if(this.raw.dmax===this.params.scalemax||void 0===this.raw.dmax)g=!0}if(void 0!==a&&void 0!==c)this.raw.dmin=a,this.raw.dmax=c;else if(this.raw.dmin=Number.MAX_VALUE,this.raw.dmax=Number.MIN_VALUE,0<this.raw.bitpix)if(void 0!==this.raw.header.BLANK)for(d=this.raw.header.BLANK,b=0;b<this.raw.data.length;b++)this.raw.data[b]!==d&&(this.raw.dmin=Math.min(this.raw.dmin,this.raw.data[b]),this.raw.dmax=
Math.max(this.raw.dmax,this.raw.data[b]));else for(b=0;b<this.raw.data.length;b++)this.raw.dmin=Math.min(this.raw.dmin,this.raw.data[b]),this.raw.dmax=Math.max(this.raw.dmax,this.raw.data[b]);else for(b=0;b<this.raw.data.length;b++)isNaN(this.raw.data[b])||(this.raw.dmin=Math.min(this.raw.dmin,this.raw.data[b]),this.raw.dmax=Math.max(this.raw.dmax,this.raw.data[b]));f&&(this.params.scalemin=this.raw.dmin);g&&(this.params.scalemax=this.raw.dmax);return this};a.Image.prototype.zscale=function(d){var c,
b,e;if(!a.zscale||!this.raw||!this.raw.data)return this;c=this.raw.data;b=c.length*c.BYTES_PER_ELEMENT;try{e=a.vmalloc(b)}catch(f){a.error("image too large for zscale malloc: "+b,f)}try{a.vmemcpy(new Uint8Array(c.buffer),e)}catch(f){a.error("can't copy image to zscale heap: "+b,f)}c=a.zscale(e,this.raw.width,this.raw.height,this.raw.bitpix,this.params.zscalecontrast,this.params.zscalesamples,this.params.zscaleline);a.vfree(e);e=c.trim().split(/\s+/);this.params.z1=parseFloat(e[0]);this.params.z2=
parseFloat(e[1]);"zmax"===d?(this.params.scalemin=this.params.z1,this.params.scalemax=this.raw.dmax):d&&(this.params.scalemin=this.params.z1,this.params.scalemax=this.params.z2);return this};a.Image.prototype.countsInRegions=function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e,f,g,h,b="field",k="",l=this,n=function(b,c,d){var e,f;e=/(annulus|box|circle|ellipse|line|polygon|point|text) *\(/;if(!b)return d;if("string"===typeof b){c=l.expandMacro(b);if(!c)return d;if(c.match(e))return c}(e=
l.getShapes("regions",b))&&e.length||a.error("no regions found: "+b);c="";for(b=0;b<e.length;b++)f=e[b],l.params.wcssys?(c||(c=f.wcssys||""),c+=sprintf("; %s",f.wcsstr)):(c||(c=f.imsys||""),c+=sprintf("; %s",f.imstr));return c||d};this.raw.hdu&&this.raw.hdu.fits&&this.raw.hdu.fits.vfile||a.error("no virtual file available for regcnts: "+this.id);for(e=0;e<c.length;e++)if(f=c[e],"string"===typeof f&&"{"===f.charAt(0))try{c[e]=JSON.parse(f)}catch(m){a.error("can't parse json arg in regcnts: "+f,m)}switch(c.length){case 0:break;
case 1:"object"===typeof c[0]?h=c[0]:b=n(c[0],"$sregions","field");break;case 2:b=n(c[0],"$sregions","field");"object"===typeof c[1]?h=c[1]:k=n(c[1],"$bregions","");break;default:b=n(c[0],"$sregions","field"),k=n(c[1],"$bregions",""),h=c[2]}h=h||{};h.reduce=h.reduce||a.globalOpts.reduceRegcnts;h.dim=h.dim||Math.max(a.globalOpts.image.xdim,a.globalOpts.image.ydim);e=h.cmdswitches||"";c=this.raw.hdu.fits.vfile;(f=this.file.match(/\[.*\]/))&&(c+=f);"table"===this.imtab?(f=this.raw.hdu.table.filter)&&
!c.match(f)&&(c=c.match(/\]\[/)?c.slice(0,-1)+"&&"+f+"]":c+("["+f+"]")):3===this.raw.header.NAXIS&&0>e.search(/(^| )-c/)&&(e+=sprintf(" -c %s",this.raw.hdu.slice||1));h.reduce&&!this.parentFile&&(f=this.fileDimensions(),f=Math.floor(Math.max(f.xdim,f.ydim)/h.dim+.5),1<f&&("table"===this.imtab?e+=sprintf(" -b %s",f):(g=sprintf("bin%s_%s",f,c.split("/").reverse()[0]),f=sprintf("0@0,0@0,%s",f),a.imsection(c,g,f,""),c=g)));a.waiting(!0,this.display);f=a.regcnts(c,b,k,e);a.waiting(!1);g&&a.vunlink(g);
(f.match(/^ERROR/)||f.match(/FITSIO status/))&&a.error(f);h.lightwin&&this.displayAnalysis("text",f,{divid:a.globalOpts.analysisDiv});return f};a.Image.prototype.radialProfile=function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e,f,g,h;h=[];for(var k={cmdswitches:"-j -r"},b=0;b<c.length;b++)"object"===typeof c[b]?(f=$.extend(!0,{},c[b],k),h.push(f),g=f):h.push(c[b]);f||h.push(k);g=g||{};b=this.countsInRegions.apply(this,[].concat($jscomp.arrayFromIterable(h)));try{e=JSON.parse(b)}catch(l){a.error("can't parse regcnts JSON",
l)}e.columnUnits.radii||a.error("no radii available for radial profile");b=e.columnUnits.radii;c=e.columnUnits.surfBrightness;f=g.color||"green";h=g.errorcolor||"red";g=a.isNull(g.errorbars)||g.errorbars?"y":"n";g={color:sprintf("%s",f),label:sprintf("surface brightness(%s) vs. radius(%s)",c,b),points:{errorbars:sprintf("%s",g),yerr:{show:"true",color:sprintf("%s",h)}},data:[]};for(b=0;b<e.backgroundSubtractedResults.length;b++)c=e.backgroundSubtractedResults[b],("undefined"===c.radius2||"NA"===c.radius2||
c.radius1>c.radius2)&&a.error("radial profile source region must be an annulus"),c=[(c.radius1+c.radius2)/2,c.surfBrightness,c.surfError],g.data.push(c);return this.displayAnalysis("plot",g,{divid:a.globalOpts.analysisDiv})};a.Image.prototype.plot3d=function(d,c,b){var e,f,g,h,k,l,n=[];this.raw.header&&3===this.raw.header.NAXIS||a.error("plot3d requires a data cube with 3 dimensions");b=$.extend(!0,{},b,a.globalOpts.plot3d);b.cube=b.cube||"*:*:all";g=b.cube.split(":");for(e=0;e<g.length;e++)if("all"===
g[e]){k=e+1;break}k||a.error("plot3d requires specification of cube's third index");b.cmdswitches=sprintf("-j -c %s",b.cube);g=b.mode||"avg";b.areaunits?b.areaunits.match(/^p/)?(b.areaunits="pixels",b.cmdswitches+=" -p"):b.areaunits.match(/^a/)?b.areaunits="arcsec":(b.areaunits="pixels",b.cmdswitches+=" -p"):(b.areaunits="pixels",b.cmdswitches+=" -p");e=b.color||"green";d=this.countsInRegions(d,c,b);try{h=JSON.parse(d)}catch(m){a.error("can't parse regcnts results: "+d,m)}d=(d=this.raw.header["CTYPE"+
String(k)])?sprintf("%s",d.toLowerCase()):"slice";c="avg"===g?"pixels"===b.areaunits?"counts/pixel**2":"counts/arcsec**2":sprintf("summed counts");c={color:sprintf("%s",e),label:sprintf("%s vs %s ",c,d),data:[]};l=this.raw.header["CRVAL"+String(k)]||0;k=this.raw.header["CDELT"+String(k)]||1;for(e=0;e<h.source.cubeSlices;e++){d="backgroundSubtractedResults"+String(e+1);for(f=n[e]=0;f<h[d].length;f++)n[e]="avg"===g?n[e]+h[d][f].surfBrightness:n[e]+h[d][f].netCounts;d=[e*k+l,n[e]];c.data.push(d)}return this.displayAnalysis("plot",
c,{divid:b.divid||a.globalOpts.analysisDiv})};a.Image.prototype.rawDataLayer=function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e,f,g,h,k,l=$jscomp.makeIterator(c),b=l.next().value,l=l.next().value;if(!c.length)return this.raw.id;if("string"===typeof b)if("function"===typeof l)b={rawid:b};else{f=b;for(c=0;c<this.raws.length;c++)if(g=this.raws[c],f===g.id){if("remove"===l){f===a.RAWID0&&a.error("can't remove primary (raw0) data layer");g.hdu&&g.hdu.fits&&(e=a.lookupVfile(g.hdu.fits.vfile),
1>=e.length&&a.cleanupFITSFile(g,!0));this.raw=this.raws[0];if(g.current0&&g.current0.id)for(e=0;e<this.raws.length;e++)if(g.current0.id===this.raws[e].id){this.raw=this.raws[e];break}for(e=0;e<a.images.length;e++)if(b=a.images[e],b.xeqstash)for(h in b.xeqstash)b.xeqstash.hasOwnProperty(h)&&b.xeqstash[h].id===f&&delete b.xeqstash[h];this.raws.splice(c,1)}else this.raw=g;this.raw.header.BITPIX&&(this.raw.bitpix=this.raw.header.BITPIX);this.imtab=this.raw.imtab||this.imtab;this.dataminmax();this.mkSection();
this.initWCS();this.initLCS();this.displayImage("all");this.refreshLayers();a.globalOpts.extendedPlugins&&this.xeqPlugins("image","onrawdatalayer");return!0}return!1}if("function"!==typeof l)return!1;if("string"===typeof b)try{b=JSON.parse(b)}catch(n){a.error("can't parse rawData opts: "+b,n)}b=b||{};h=b.rawid||a.RAWIDX;void 0===b.oraw&&(b.oraw="current0");if("current"===b.oraw)f=this.raw;else if("current0"===b.oraw)f=this.raw.id===h?this.raw.current0:this.raw;else for(c=0;c<this.raws.length;c++)if(g=
this.raws[c],b.oraw===g.id){f=g;break}f||(f=this.raws[0]);g=-1;for(c=0;c<this.raws.length;c++)if(h===this.raws[c].id){e=this.raws[c];g=c;break}if(0>g||b.alwaysCopy){e=$.extend(!0,{},f);e.current0=f;if(b.bitpix){switch(b.bitpix){case 8:e.data=new Uint8Array(f.height*f.width);break;case 16:e.data=new Int16Array(f.height*f.width);break;case -16:e.data=new Uint16Array(f.height*f.width);break;case 32:e.data=new Int32Array(f.height*f.width);break;case -32:e.data=new Float32Array(f.height*f.width);break;
case -64:e.data=new Float64Array(f.height*f.width)}k=e.width*e.height;for(c=0;c<k;c++)e.data[c]=f.data[c];e.bitpix=b.bitpix}else switch(f.bitpix){case 8:e.data=new Uint8Array(f.data);break;case 16:e.data=new Int16Array(f.data);break;case -16:e.data=new Uint16Array(f.data);break;case 32:e.data=new Int32Array(f.data);break;case -32:e.data=new Float32Array(f.data);break;case -64:e.data=new Float64Array(f.data)}e.id=h;e.from=b.from||e.from||"func"}l.call(this,f,e,b)&&(0<=g?this.raws[g]=e:this.raws.push(e),
this.raw=e,this.raw.header.bitpix&&(this.raw.bitpix=this.raw.header.bitpix),!1!==b.dataminmax&&this.dataminmax(),this.displayImage("all",b));return!0};a.Image.prototype.gaussBlurData=function(d){var c={};void 0===d&&a.error("missing sigma value for gaussBlurData");this.params.sigma=d;if("string"===typeof c)try{c=JSON.parse(c)}catch(b){a.error("can't parse gaussBlur opts: "+c,b)}c=c||{};c.bitpix=-64===this.raw.bitpix?-64:-32;c.oraw="current0";c.alwaysCopy=!0;c.rawid=c.rawid||"gaussBlur";c.sigma=d;
this.xeqStashSave("gaussBlurData",[d],c.rawid);this.rawDataLayer(c,function(b,c){var e;switch(c.bitpix){case -32:e=new Float32Array(c.data);break;case -64:e=new Float64Array(c.data);break;default:a.error("invalid temp bitpix for gaussBlur: "+c.bitpix)}gaussBlur(e,c.data,c.width,c.height,d);return!0});return this};a.Image.prototype.imarithData=function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e=$jscomp.makeIterator(c),f=e.next().value,b=e.next().value,e=e.next().value;if(!c.length)return"add sub mul div min max reset".split(" ");
if("string"===typeof e)try{e=JSON.parse(e)}catch(g){a.error("can't parse imarith opts: "+e,g)}e=e||{};e.rawid=e.rawid||"imarith";if("reset"===f||"remove"===f)this.rawDataLayer(e.rawid,"remove");else{void 0!==f&&void 0!==b||a.error("missing arg(s) for image arithmetic");this.xeqStashSave("imarithData",c,e.rawid);switch(f){case "add":case "sub":case "mul":case "div":case "min":case "max":e.op=f;break;default:a.error("invalid operator for image arithmetic: "+f)}"object"===typeof b?(this.raw.width===
b.raw.width&&this.raw.height===b.raw.height||a.error("images must be the same size for image arithmetic"),e.argtype="image",e.argval=b):a.isNumber(b)?(e.argtype="value",e.argval=b):((c=a.lookupImage(b))||a.error("imarith arg1 must be an image or a constant: "+b),e.argval=c,e.argtype="image");"div"===e.op&&"value"===e.argtype&&0===e.argval&&a.error("imarith can't divide by zero (nor can anyone else)");if(!e.bitpix)switch(e.argtype){case "image":e.bitpix=0<this.raw.bitpix&&0<e.argval.raw.bitpix?Math.max(this.raw.bitpix,
e.argval.raw.bitpix):0>this.raw.bitpix&&0>e.argval.raw.bitpix?Math.min(this.raw.bitpix,e.argval.raw.bitpix):0>this.raw.bitpix&&0<e.argval.raw.bitpix?this.raw.bitpix:e.argval.raw.bitpix;break;case "value":e.bitpix=-64===this.raw.bitpix?-64:-32}e.alwaysCopy=!0;e.oraw="current";this.rawDataLayer(e,function(b,c,d){switch(d.argtype){case "image":b=d.argval.raw.data;switch(d.op){case "add":for(d=0;d<c.data.length;d++)c.data[d]+=b[d];break;case "sub":for(d=0;d<c.data.length;d++)c.data[d]-=b[d];break;case "mul":for(d=
0;d<c.data.length;d++)c.data[d]*=b[d];break;case "div":for(d=0;d<c.data.length;d++)c.data[d]=0===b[d]?0:c.data[d]/b[d];break;case "min":for(d=0;d<c.data.length;d++)c.data[d]=Math.min(c.data[d],b[d]);break;case "max":for(d=0;d<c.data.length;d++)c.data[d]=Math.max(c.data[d],b[d]);break;default:a.error("unknown operation for imarith: "+d.op)}break;case "value":b=d.argval;switch(d.op){case "add":for(d=0;d<c.data.length;d++)c.data[d]+=b;break;case "sub":for(d=0;d<c.data.length;d++)c.data[d]-=b;break;case "mul":for(d=
0;d<c.data.length;d++)c.data[d]*=b;break;case "div":for(d=0;d<c.data.length;d++)c.data[d]=0===b?0:c.data[d]/b;break;case "min":for(d=0;d<c.data.length;d++)c.data[d]=Math.min(c.data[d],b);break;case "max":for(d=0;d<c.data.length;d++)c.data[d]=Math.max(c.data[d],b);break;default:a.error("unknown op for imarith: "+d.op)}break;default:a.error("unknown arg type for imarith: "+d.argtype)}return!0});return this}};a.Image.prototype.shiftData=function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];
var e=$jscomp.makeIterator(c),b=e.next().value,f=e.next().value,e=e.next().value;void 0!==b&&void 0!==f||a.error("missing translation value(s) for shiftData");if("string"===typeof e)try{e=JSON.parse(e)}catch(g){a.error("can't parse shift opts: "+e,g)}e=e||{};e.rawid=e.rawid||"shift";e.x=b;e.y=f;this.xeqStashSave("shiftData",c,e.rawid);this.rawDataLayer(e,function(a,b,c){var d,e,f,g,h=a.data.BYTES_PER_ELEMENT;void 0===b.xoff&&(b.xoff=0);void 0===b.yoff&&(b.yoff=0);b.xoff+=c.x;b.yoff+=c.y;if(!c.fill||
"clear"===c.fill)if(0<b.bitpix?(g=c.blank||b.header.BLANK||0,b.header.BLANK=g):g=NaN,"function"===typeof b.data.fill)b.data.fill(g);else for(c=0;c<b.data.length;c++)b.data[c]=g;for(c=0;c<a.height;c++)if(f=c+b.yoff,!(0>f||f>=a.height)){d=0;e=d+b.xoff;g=a.width;0>e&&(d-=e,g+=e,e=0);e+g>a.width&&(g-=e+g-a.width);if(0>=g)return!1;d=(c*a.width+d)*h;d=new Uint8Array(a.data.buffer,d,g*h);e=(f*a.width+e)*h;g=new Uint8Array(b.data.buffer,e,g*h);g.set(d)}return!0});return this};a.Image.prototype.rotateData=
function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e,f,g,h,k,l,n=b=0;e=$jscomp.makeIterator(c);h=e.next().value;var m=e.next().value;this.raws&&this.raws[0]||a.error("no raw data for reprojection");e=this.raws[0];e.header&&e.wcsinfo||a.error("no WCS info available for reprojection");if("string"===typeof m)try{m=JSON.parse(m)}catch(r){a.error("can't parse rotate opts: "+m,r)}m=m||{};m.stash="rotateData";m.rawid="rotate";m.oraw=a.RAWID0;!0!==m.resetSection&&(m.resetSection=
!1);f=e.header;g=$.extend(!0,{},f);e.width&&e.height&&(g.NAXIS1=e.width,g.NAXIS2=e.height);e.wcsinfo&&(b=e.wcsinfo.cdelt1||0,n=e.wcsinfo.cdelt2||0);if("string"===typeof h)switch(h.toLowerCase()){case "northisup":case "northup":h=0,0<b&&(b=-b),0>n&&(n=-n)}k=-(h*Math.PI/180);l=Math.sin(k);k=Math.cos(k);a.isNull(f.CD1_1)?(g.CROTA2=h,g.CDELT1=b,g.CDELT2=n):(g.CD1_1=b*k,g.CD1_2=-n*l,g.CD2_1=b*l,g.CD2_2=n*k);e.wcsinfo&&(g.ptype=e.wcsinfo.ptype);this.xeqStashSave("rotateData",c,m.rawid);return this.reprojectData(g,
m)};a.Image.prototype.reproject=function(d,c){var b,e,f,g,h,k,l,n,m,r,q,t,u,v,p,w,x,A,z=!1;k={};x=/SIMPLE|BITPIX|NAXIS|NAXIS[1-4]|AMDX|AMDY|CD[1-2]_[1-2]|CDELT[1-4]|CNPIX[1-4]|CO1_[1-9][0-9]|CO2_[1-9][0-9]|CROTA[1-4]|CRPIX[1-4]|CRVAL[1-4]|CTYPE[1-4]|CUNIT[1-4]|DATE|DATE_OBS|DC-FLAG|DEC|DETSEC|DETSIZE|EPOCH|EQUINOX|EQUINOX[a-z]|IMAGEH|IMAGEW|LATPOLE|LONGPOLE|MJD-OBS|PC00[1-4]00[1-4]|PC[1-4]_[1-4]|PIXSCALE|PIXSCAL[1-2]|PLTDECH|PLTDECM|PLTDECS|PLTDECSN|PLTRAH|PLTRAM|PLTRAS|PPO|PROJP[1-9]|PROJR0|PV[1-3]_[1-3]|PV[1-4]_[1-4]|RA|RADECSYS|SECPIX|SECPIX|SECPIX[1-2]|UT|UTMID|VELOCITY|VSOURCE|WCSAXES|WCSDEP|WCSDIM|WCSNAME|XPIXSIZE|YPIXSIZE|ZSOURCE|LTM|LTV/;
q=/TAN|SIN|ZEA|STG|ARC/;var C=function(b,c){var d;if(!c)return b;d=$.extend(!0,{},b);a.isNull(d.CRVAL1)&&!a.isNull(c.crval1)&&(d.CRVAL1=c.crval1);a.isNull(d.CRVAL2)&&!a.isNull(c.crval2)&&(d.CRVAL2=c.crval2);a.isNull(d.CRPIX1)&&!a.isNull(c.crpix1)&&(d.CRPIX1=c.crpix1);a.isNull(d.CRPIX2)&&!a.isNull(c.crpix2)&&(d.CRPIX2=c.crpix2);a.isNull(d.CDELT1)&&!a.isNull(c.cdelt1)&&(d.CDELT1=c.cdelt1);a.isNull(d.CDELT2)&&!a.isNull(c.cdelt2)&&(d.CDELT2=c.cdelt2);a.isNull(d.CROTA2)&&!a.isNull(c.crot)&&(d.CROTA2=c.crot);
return d};if(a.reproject&&d&&this!==d){this.raws&&this.raws[0]||a.error("no raw data for reprojection");t=this.raws[0];t.header&&t.wcsinfo||a.error("no WCS info available for reprojection");c=c||{};f=$.extend(!0,{},t.header);for(h in f)f.hasOwnProperty(h)&&x.test(h)&&delete f[h];if("object"===typeof d){d.raw&&d.raw.header?l=d.raw.header:d.BITPIX&&d.NAXIS1&&d.NAXIS2?l=d:a.error("invalid wcs object input to reproject()");for(h in l)l.hasOwnProperty(h)&&x.test(h)&&(k[h]=l[h]);h=$.extend(!0,{},k,f);if(!h.NAXIS||
!h.NAXIS1||!h.NAXIS2)return;k=a.raw2FITS(h,{addcr:!0});f="wcs_"+a.uniqueID()+".txt";a.vfile(f,k);k=a.globalOpts.reproj.xdim||a.globalOpts.image.xdim;x=a.globalOpts.reproj.ydim||a.globalOpts.image.ydim;A=k*x*32;(h.NAXIS1*h.NAXIS2*Math.abs(h.BITPIX)>A||t.header.NAXIS1*t.header.NAXIS2*Math.abs(t.header.BITPIX)>A)&&a.error("the max reproject size is "+k+" * "+x+" * 4 bytes/pixel. You can use the Bin/Filter/Section plugin to extract a section, then save it as FITS and reproject the smaller image.")}else f=
d;try{if(q.test(t.wcsinfo.ptype)||(n=C(t.header,t.wcsinfo),g="owcs_"+a.uniqueID()+".txt",a.vfile(g,a.raw2FITS(n,{addcr:!0})),b="awcs_"+a.uniqueID()+".txt",r=a.tanhdr(g,b,""),1<a.DEBUG&&a.log("tanhdr (input): %s %s -> %s",g,b,r),a.vunlink(g),0<=r.search(/\[struct stat="OK"/)&&(c.cmdswitches=c.cmdswitches||"",c.cmdswitches+=" -i "+b)),d.raw&&!q.test(d.raw.wcsinfo.ptype)||d.ptype&&!q.test(d.ptype))n=C(l,d.raw.wcsinfo),g="owcs_"+a.uniqueID()+".txt",a.vfile(g,a.raw2FITS(n,{addcr:!0})),e="awcs_"+a.uniqueID()+
".txt",r=a.tanhdr(g,e,""),1<a.DEBUG&&a.log("tanhdr (reproj): %s %s -> %s",g,e,r),a.vunlink(g),0<=r.search(/\[struct stat="OK"/)&&(a.vunlink(f),f=e)}catch(D){}t.hdu&&t.hdu.fits.vfile?(e=t.hdu.fits.vfile,t.hdu.fits.extname?e+=sprintf("[%s]",t.hdu.fits.extname):t.hdu.fits.extnum&&0<t.hdu.fits.extnum&&(e+=sprintf("[%s]",t.hdu.fits.extnum))):(m=this.toArray(),e=this.id.replace(/\.png$/,"_png.fits"),a.vfile(e,m));g=this.id.replace(/\[.*\]/,"").replace(/\.png$/i,".fits").replace(/\.fz$/i,"").replace(/\.gz$/i,
"");g="reproj_"+a.uniqueID()+"_"+g;n=c.rawid||"reproject";for(l=0;l<this.raws.length&&(q=this.raws[l],q.id!==n||!a.cleanupFITSFile(q,!0));l++);t.hdu&&"table"===t.hdu.imtab&&t.hdu.table&&!e.match(/\[bin /)&&(e.match(/\[EVENTS\]/)||(e+="[EVENTS]"),q=t.hdu.table,t=Math.floor(q.xcen-q.xdim/2+1),l=Math.floor(q.xcen+q.xdim/2),n=Math.floor(q.ycen-q.ydim/2+1),q=Math.floor(q.ycen+q.ydim/2),e+=sprintf("[bin X=%s:%s,Y=%s:%s]",t,l,n,q));try{u=g.lastIndexOf("."),0<=u&&(v=g.substring(0,u)+"_area"+g.substring(u)),
w=c.cmdswitches||"",w+=" -a 0 "+a.globalOpts.reprojSwitches,r=a.reproject(e,g,f,w),1<a.DEBUG&&a.log("reproject: %s %s %s [%s] -> %s",e,g,f,w,r),a.vunlink(v),a.vunlink(f),b&&a.vunlink(b),m&&a.vunlink(e),0>r.search(/\[struct stat="OK"/)&&(z=!0,(p=r.match(/msg="(.*)"/))&&p[1]?a.error(p[1]+" (from mProjectPP)"):a.error(r))}catch(D){if(z)return;a.vunlink(v);a.vunlink(f);r?a.error(r):a.error("WCS reproject failed",D)}return g}};a.Image.prototype.reprojectData=function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-
0]=arguments[b];var e,b=$jscomp.makeIterator(c),f=b.next().value,g=b.next().value,h=this;if(f&&a.reproject&&("string"===typeof f&&((b=a.getImage(f))?f=b:a.error("unknown WCS for reproject: "+f)),this!==f)){g=g||{};if("string"===typeof g)try{g=JSON.parse(g)}catch(k){a.error("can't parse reproject opts: "+g,k)}g.rawid||this.xeqStashSave("reprojectData",c,"reproject");g.stash||(g.stash="reprojectData");a.waiting(!0,this.display);window.setTimeout(function(){var b,c;c=function(a){h.xeqPlugins("image",
"onreprojectdata");b=b||{};b.refreshRegions=!0;!1!==g.resetSection&&(b.resetSection=!0);h.refreshImage(a,b);h.xeqStashCall(h.xeqstash,[g.stash,"reprojectData"])};g=g||{};c=g.reprojHandler||c;if(e=h.reproject(f,g)){b=$.extend(!0,{},a.fits.options,g);b.rawid=b.rawid||"reproject";f.raw&&f.raw.header&&(b.wcsim=f);try{a.handleFITSFile(e,b,c)}catch(n){a.error("can't process reprojected FITS file",n)}}},a.SPINOUT);return this}};a.Image.prototype.filterRGBImage=function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-
0]=arguments[b];var e,b=$jscomp.makeIterator(c).next().value,f=[];if(!b){for(e in a.ImageFilters)a.ImageFilters.hasOwnProperty(e)&&f.push(e);return f}"reset"===b||a.ImageFilters[b]||a.error("JS9 image filter '"+b+"' not available");if("reset"===b)return this.setColormap("reset"),this;this.xeqStashSave("filterRGBImage",c);c.shift();c.unshift(this.display.context,this.rgb.img);try{a.ImageFilters[b].apply(null,[].concat($jscomp.arrayFromIterable(c)))}catch(g){a.error("JS9 image filter '"+b+"' failed",
g)}this.displayImage("display");a.globalOpts.extendedPlugins&&this.xeqPlugins("image","onfilterrgbimage");return this};a.Image.prototype.moveToDisplay=function(d){var c,b,e,f=0,g=this.display;b=a.lookupDisplay(d);if(!d||!b)return a.error("could not find display: "+d),null;this.display.clearMessage();this.display.context.clear();this.xeqPlugins("image","onimageclear");for(c in g.layers)g.layers.hasOwnProperty(c)&&("main"!==g.layers[c].dtype||b.layers[c]||b.newShapeLayer(c,g.layers[c].opts));if(b.image)for(c in b.layers)b.layers.hasOwnProperty(c)&&
"main"===b.layers[c].dtype&&b.image.showShapeLayer(c,!1,{local:!0});for(c in this.layers)this.layers.hasOwnProperty(c)&&(d=this.layers[c],(e=b.layers[c])?(this.showShapeLayer(c,!1,{local:!0}),d.dlayer=e,d.divjq=e.divjq,d.canvasjq=e.canvasjq,d.canvas=e.canvas):delete this.layers[c]);this.display=b;this.display.image=this;this.mkSection();this.displayImage("all");for(c in this.layers)this.layers.hasOwnProperty(c)&&this.showShapeLayer(c,!0,{local:!0});this.refreshLayers();g.image=null;for(c=0;c<a.images.length;c++)if(b=
a.images[c],g===b.display){b.display.image=null;b.displayImage("all");b.refreshLayers();f++;break}!f&&g.winid&&g.winid.close&&(c=$.inArray(g,a.displays),0<=c&&a.displays.splice(c,1),g.winid.close());return this};a.Image.prototype.saveSession=function(d,c){var b,e,f,g,h,k,l,n,m,r,q=function(){var a={};a.file=this.file;a.dwidth=this.display.width;a.dheight=this.display.height;a.params=$.extend(!0,{},this.params);a.tmp={};"active"===this.tmp.gridStatus&&(a.tmp.gridStatus="active");m=this.imageToLogicalPos({x:this.rgb.sect.xcen,
y:this.rgb.sect.ycen});(r=this.maybePhysicalToImage(m))&&(m=r);a.sect={};a.sect.xcen=m.x;a.sect.ycen=m.y;a.sect.xdim=this.raw.width;a.sect.ydim=this.raw.height;a.sect.zoom=this.rgb.sect.zoom;a.layers=[];for(l in this.layers)this.layers.hasOwnProperty(l)&&(g=this.layers[l],h=g.dlayer,"main"===h.dtype&&"crosshair"!==l&&"grid"!==l&&(k={},k.name=l,k.json=h.canvas.toJSON(h.el),k.dopts=$.extend(!0,{},h.opts),g.catalog&&(k.catalog=g.catalog),g.starbase&&(k.starbase=JSON.stringify(g.starbase)),a.layers.push(k)));
a.blend=this.blend;a.xeqstash=this.xeqstash;this.wcsim&&this.wcsim.id&&(a.wcsim=this.wcsim.id);a.params.display&&delete a.params.display;a.params.crosshair=!1;return a};window.hasOwnProperty("saveAs")||a.error("no saveAs function available to save session");d=d||"js9.ses";d.match(/\.ses$/)||(d+=".ses");if("string"===typeof c)try{c=JSON.parse(c)}catch(t){a.error("can't parse session opts: "+c,t)}c=c||{};a.waiting(!0,this.display);e={images:[]};if("display"===c.mode)for(b=0;b<a.images.length;b++)n=
a.images[b],n.display.id===this.display.id&&e.images.push(q.call(n));else e.images.push(q.call(this));e.display={blendMode:this.display.blendMode};e.globals=$.extend(!0,{},a.globalOpts);delete e.globals.rgb;e.cmaps=[];for(b=0;b<a.colormaps.length;b++)"user"===a.colormaps[b].source&&e.cmaps.push(a.colormaps[b]);try{f=JSON.stringify(e,null,4)}catch(t){a.error("can't create json file for save session",t)}b=new Blob([f],{type:"application/json"});saveAs(b,d);a.waiting(!1);return d};a.Image.prototype.xeqStashSave=
function(d,c,b,e){var f,g;e=e||"image";this.xeqstash=this.xeqstash||{};for(f=0;f<c.length;f++)"object"===typeof c[f]&&(c[f]instanceof a.Image?c[f]=c[f].id:c[f]instanceof a.Display&&(c[f]=c[f].id));for(f=0;f<this.xeqstash.length;f++)if(g=this.xeqstash[f],g.func===d&&g.context===e)return g.args=c,this;this.xeqstash[d]={args:c,id:b,context:e};return this};a.Image.prototype.xeqStashCall=function(d,c){var b,e;d=d||this.xeqstash;for(b in d)if(d.hasOwnProperty(b)&&!(0<=$.inArray(b,c))){e=d[b];e.context=
e.context||"image";try{switch(e.context){case "image":this[b].apply(null,[].concat($jscomp.arrayFromIterable(e.args)));break;case "display":this.display[b].apply(null,[].concat($jscomp.arrayFromIterable(e.args)));break;default:this[b].apply(null,[].concat($jscomp.arrayFromIterable(e.args)))}}catch(f){a.error("error executing stash: "+b,f,!1)}}};a.Image.prototype.xeqPlugins=function(d,c,b){var e,f,g,h,k,l=function(a,b){var c="JS9:"+a;$(document).trigger(c,b)};if(d&&c&&a.globalOpts.xeqPlugins){h=this.display.pluginInstances;
for(e in h)if(h.hasOwnProperty(e)&&(f=h[e],g=f.plugin.opts,f.isActive(c)&&"function"===typeof g[c])){this.callingPlugin=c;switch(d){case "image":try{g[c].call(f,this),l(c,{im:this})}catch(n){f.errLog(c,n)}break;case "region":case "shape":try{g[c].call(f,this,b),l(c,{im:this,xreg:b})}catch(n){f.errLog(c,n)}break;case "keypress":k=b.originalEvent||b;try{g[c].call(f,this,this.ipos,k),l(c,{im:this,ipos:this.ipos,evt:k})}catch(n){f.errLog(c,n)}break;case "mouse":if(!this.clickInRegion||g[c+"_inRegion"]){k=
b.originalEvent||b;try{g[c].call(f,this,this.ipos,k),l(c,{im:this,ipos:this.ipos,evt:k})}catch(n){f.errLog(c,n)}}}delete this.callingPlugin}return this}};a.Image.prototype.uploadFITSFile=function(){var d,c,b=this,e=function(c){delete b.tmp.upload;window.setTimeout(function(){a.progress(!1)},1E3);c.stderr?a.error(c.stderr):c.stdout&&(b.fitsFile=c.stdout.trim(),b.proxyFile=b.fitsFile,a.globalOpts.prependJS9Dir&&!b.fitsFile.match(/^\${JS9_DIR}/)&&"/"!==b.fitsFile.charAt(0)&&(b.fitsFile="${JS9_DIR}/"+
b.fitsFile),b.queryHelper("all"))};if(a.worker&&("nodejs"===a.helper.type||"socket.io"===a.helper.type)&&this.raw.hdu&&this.raw.hdu.fits&&this.raw.hdu.fits.vfile)return this.tmp.upload&&a.error("only one upload allowed at a time"),d=this.raw.hdu.fits.vfile,a.helper.send("quotacheck",null,function(f){(f.stderr||f.errcode)&&a.error(f.stderr||"from quotacheck: "+f.errcode);c=a.vread(d,"binary");a.worker.socketio(function(){b.tmp.upload=!0;a.progress(!0,b.display);a.worker.postMessage("uploadFITS",[d,
c],e,[c.buffer])})}),this};a.Image.prototype.removeProxyFile=function(d){var c,b,e=this;if("boolean"===typeof d)b=d;else if("string"===typeof d){if(d.match(/^\//))return;c=new RegExp("^"+a.INSTALLDIR);c=d.replace(c,"");if(c.match(/\.\./))return;c=d}else{if(!this.proxyFile)return;c=this.proxyFile}c&&a.Send("removeproxy",{cmd:"js9Xeq removeproxy "+c},function(a){b&&a&&"OK"===a.stdout.trim()&&(e.proxyFile=null,e.fitsFile=null,e.analysisPackages=null,e.queryHelper("all"))})};a.Image.prototype.starbaseToShapes=
function(d,c){var b,e,f,g,h,k,l,n,m,r,q,t,u,v,p,w,x;r=a.globalOpts.catalogs.ras;b=a.globalOpts.catalogs.decs;var A=[],z=a.globalOpts.catalogs,C=function(b,c,d){return(b=a.wcs2pix(b.raw.wcs,c,d).trim().split(/ +/))&&b.length?{x:parseFloat(b[0]),y:parseFloat(b[1])}:null};e=function(a,b,c,d){var e,f;if(void 0!==d)f=d;else{f=-1;for(e=0;e<c.length;e++){for(d=0;d<b.length;d++)if(c[e].toLowerCase()===b[d].toLowerCase()){f=a[b[d]];break}if(0<=f)break}if(0>f)for(w=c[0],x=new RegExp("^"+w,"i"),d=0;d<b.length;d++)if(b[d].match(x)){f=
a[b[d]];break}if(0>f)for(w=c[0],x=new RegExp(".*"+w+".*","i"),d=0;d<b.length;d++)if(b[d].match(x)){f=a[b[d]];break}}return f};if(d&&d.data&&d.headline){k=d.data;l=d.headline;n=d.delims;c=c||{};r=e(d,l,r,c.xcol);0>r&&a.error("can't find an RA column (see Preferences:catalogs)");q=e(d,l,b,c.ycol);0>q&&a.error("can't find a Dec column (see Preferences:catalogs)");g=c.shape||z.shape||"circle";switch(g){case "box":m=function(a,b,d){return{width:c.width||z.width||7,height:c.height||z.height||7}};break;
case "circle":m=function(a,b,d){return{radius:c.radius||z.radius||3.5}};break;case "ellipse":m=function(a,b,d){return{r1:c.r1||z.r1||3.5,r2:c.r2||z.r2||3.5}};break;default:m=function(a,b,d){return{width:c.width||7,height:c.height||7}}}v=this.getWCSSys();p=c.wcssys?c.wcssys:z.wcssys?z.wcssys:"ICRS";this.setWCSSys(p);for(e=b=0;b<k.length;b++)if(t=k[b][r],u=k[b][q],"\x00"!==n[r]&&0<=":h ".indexOf(n[r])&&"galactic"!==p&&"ecliptic"!==p&&(t*=15),f=C(this,t,u)){h=m.call(this,k[b][1],k[b][1]);h={id:b.toString(),
shape:g,x:f.x,y:f.y,width:h.width,height:h.height,radius:h.radius,r1:h.r1,r2:h.r2,angle:0,data:{ra:t,dec:u}};if(!1!==c.save&&!1!==a.globalOpts.catalogs.save)for(f=0;f<=l.length;f++)l[f]&&(h.data[l[f]]=k[b][f]);c.color&&(h.color=c.color);A[e++]=h}this.setWCSSys(v);return A}};a.Image.prototype.loadCatalog=function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e=$jscomp.makeIterator(c),b=e.next().value,f=e.next().value,e=e.next().value,g,h=$.extend(!0,{},a.Catalogs.opts),k=a.globalOpts.catalogs;
1===c.length&&"string"!==typeof b&&(f=b,b=null);2===c.length&&"string"!==typeof b&&(e=f,f=b,b=null);if(f){k.tooltip&&(h.tooltip=k.tooltip);if("string"===typeof e)try{e=JSON.parse(e)}catch(l){a.error("can't parse catalog opts: "+e,l)}e=e||{};e.color=e.color||k.color||"#00FF00";e.wcssys=e.wcssys||k.wcssys;e.updateWCS=!0;c={convFuncs:{def:function(b){var c={};c.val=a.saostrtod(b);c.delim=String.fromCharCode(a.saodtype());if("\x00"!==c.delim&&0<=" \t-.:hdmsr'\"".indexOf(c.delim)||a.isNumber(b))return c;
c.val=b;return c}},units:e.units||k.units,skip:e.skip||k.skip};try{g=new a.Starbase(f,c)}catch(l){a.error("could not parse catalog. Is it in tab-separated column format?")}g&&g.data&&g.data.length||a.error("no objects found in catalog");c=this.starbaseToShapes(g,e);c.length?(b=b||"catalog_"+a.uniqueID(),this.display.newShapeLayer(b,h),this.removeShapes(b),this.layers[b].catalog=f,this.layers[b].starbase=g,this.addShapes(b,c,e)):a.error("no catalog objects found");return this}};a.Image.prototype.saveCatalog=
function(d,c){var b,e;b=c||this.activeShapeLayer();this.layers[b]&&this.layers[b].catalog||(b&&"undefined"!==b?a.error("no catalog available: "+b):a.error("no active catalog available"));e=new Blob([this.layers[b].catalog],{type:"text/plain;charset=utf-8"});d=d||b+".cat";d.match(/\.cat$/)||(d+=".cat");window.hasOwnProperty("saveAs")?saveAs(e,d):a.error("no saveAs function available to save catalog");return d};a.Image.prototype.wcs2wcs=function(d,c,b,e){var f,g,h;f=this.getWCSSys();g=this.getWCSUnits();
d=d||f;c=c||f;"string"===typeof b&&(h=a.strtoscaled(b),":"===h.dtype&&"galactic"!==d&&"ecliptic"!==d&&(h.dval*=15),b=h.dval);"string"===typeof e&&(h=a.strtoscaled(e),e=h.dval);h=this.setWCSSys(d).getWCSSys();"native"!==d&&h!==d&&a.error("unknown or invalid wcs: "+d);b=a.wcs2pix(this.raw.wcs,b,e).trim().split(/ +/);d=parseFloat(b[0]);b=parseFloat(b[1]);this.setWCSSys(c);this.setWCSUnits("degrees");d=a.pix2wcs(this.raw.wcs,d,b).trim();this.setWCSUnits(g);f!==c&&this.setWCSSys(f);return d};a.Image.prototype.wcs2imlen=
function(d){var c,b=1;if(d){d=a.strtoscaled(d);c=this.raw.wcsinfo||{cdelt1:1,cdelt2:1};void 0!==c.cdelt1?b=c.cdelt1:void 0!==c.cdelt2&&(b=c.cdelt2);switch(this.params.wcssys){case "image":break;case "physical":this.lcs&&this.lcs.physical&&(d.dval*=this.lcs.physical.forward[0][0]);break;default:d.dtype&&"."!==d.dtype&&"\x00"!==d.dtype&&(d.dval=Math.abs(d.dval/b))}return d.dval}};a.Colormap=function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e=$jscomp.makeIterator(c),b=e.next().value,
f=e.next().value,g=e.next().value,e=e.next().value,h;if(b){this.name=b;switch(c.length){case 2:this.type="lut";this.colors=f;break;case 4:this.type="sao";this.vertices=[f,g,e];break;default:a.error("colormap requires a colormap name and 1 or 3 array args")}this.source=a.inited?"user":"core";for(c=0;c<a.colormaps.length;c++)if(a.colormaps[c].name===this.name){a.colormaps[c]=this;h=!0;break}h||a.colormaps.push(this);1<a.DEBUG&&a.log("JS9 colormap:  %s",this.name)}};a.Colormap.prototype.mkColorCell=
function(d){var c,b,e,f;e=a.COLORSIZE;var g=[0,0,0];switch(this.type){case "sao":b=d/e;for(d=0;3>d;d++){f=this.vertices[d];c=f.length;for(e=0;e<c&&!(f[e][0]>b);e++);e=0===e?f[0][1]:e===c?f[c-1][1]:(c=(f[e][1]-f[e-1][1])/(f[e][0]-f[e-1][0]))?c*(b-f[e-1][0])+f[e-1][1]:f[e][1];g[d]=255*e}break;case "lut":b=this.colors.length;d=Math.floor(d*b/e);0>d?(g[0]=255*this.colors[0][0],g[1]=255*this.colors[0][1],g[2]=255*this.colors[0][2]):d<b?(g[0]=255*this.colors[d][0],g[1]=255*this.colors[d][1],g[2]=255*this.colors[d][2]):
(g[0]=255*this.colors[b-1][0],g[1]=255*this.colors[b-1][1],g[2]=255*this.colors[b-1][2]);break;default:a.error("unknown colormap type")}return g};a.Display=function(d){var c=this;this.divjq=d instanceof jQuery?d:"object"===typeof d?$(d):$("#"+d);this.divjq.attr("id")||this.divjq.attr("id",a.DEFID);this.id=this.divjq.attr("id");this.tmp={};this.divjq.addClass("JS9");this.width=this.divjq.attr("data-width");this.width||(this.width=a.WIDTH);this.divjq.css("width",this.width);this.width=parseInt(this.divjq.css("width"),
10);this.height=this.divjq.attr("data-height");this.height||(this.height=a.HEIGHT);this.divjq.css("height",this.height);this.height=parseInt(this.divjq.css("height"),10);this.width0=this.width;this.height0=this.height;this.canvas=document.createElement("canvas");this.canvasjq=$(this.canvas).addClass("JS9Image").attr("id",this.id+"Image").attr("width",this.width).attr("height",this.height).css("z-index",a.ZINDEX);this.displayConjq=$("<div>").addClass("JS9Container").css("z-index",a.ZINDEX).attr("tabindex",
"0").append(this.canvasjq).appendTo(this.divjq);a.allinone||(this.iconjq=$("<div>").addClass("JS9Logo").css("display","none").css("z-index",a.ZINDEX+1).appendTo(this.divjq),this.iconimgjs=$("<img>").addClass("JS9Logo").attr("src",a.InstallDir("images/js9logo.png")).attr("alt","js9").attr("title","js9").appendTo(this.iconjq),a.globalOpts.logoDisplay&&this.iconjq.css("display","block"));a.globalOpts.resizeHandle&&window.hasOwnProperty("ResizeSensor")&&(this.divjq.css("resize","both").css("overflow",
"hidden"),a.bugs.webkit_resize&&(this.owidth=parseInt(this.divjq.css("width"),10),this.oheight=parseInt(this.divjq.css("height"),10),this.divjq.css("width",this.width+a.RESIZEFUDGE).css("height",this.height+a.RESIZEFUDGE)),this.resizeSensor=new ResizeSensor(this.divjq,function(){var b=c.divjq.width(),d=c.divjq.height();a.bugs.webkit_resize&&(b-=a.RESIZEFUDGE,d-=a.RESIZEFUDGE);c.resize(b,d)}));this.context=this.canvas.getContext("2d");a.ANTIALIAS||(this.context.imageSmoothingEnabled=!1,this.context.webkitImageSmoothingEnabled=
!1,this.context.msImageSmoothingEnabled=!1);this.tooltip=$("<div>").attr("id","tooltip_"+this.id).addClass("JS9Tooltip").appendTo(this.divjq);this.image=null;this.pluginInstances={};this.layers={};this.initMessages();this.blendMode=!1;this.mouseActions=a.globalOpts.mouseActions.slice(0);this.touchActions=a.globalOpts.touchActions.slice(0);this.mousetouchZoom=a.globalOpts.mousetouchZoom;this.divjq.on("mouseenter",this,function(b){return a.mouseEnterCB(b)});this.divjq.on("mouseover",this,function(b){return a.mouseOverCB(b)});
this.divjq.on("mousedown touchstart",this,function(b){return a.mouseDownCB(b)});this.divjq.on("mousemove touchmove",this,function(b){return a.mouseMoveCB(b)});this.divjq.on("mouseup touchend",this,function(b){return a.mouseUpCB(b)});this.divjq.on("mouseout",this,function(b){return a.mouseOutCB(b)});this.divjq.on("keypress",this,function(b){return a.keyPressCB(b)});this.divjq.on("keydown",this,function(b){return a.keyDownCB(b)});this.divjq.on("keyup",this,function(b){return a.keyUpCB(b)});this.divjq.on("wheel",
this,function(b){return a.wheelCB(b)});this.divjq.on("dragenter",this,function(b){return a.dragenterCB(this.id,b)});this.divjq.on("dragover",this,function(b){return a.dragoverCB(this.id,b)});this.divjq.on("dragexit",this,function(b){return a.dragexitCB(this.id,b)});this.divjq.on("drop",this,function(b){return a.dragdropCB(this.id,b)});this.divjq.on("contextmenu",this,function(){return!1});this.addFileDialog("Load",a.globalOpts.imageTemplates);this.addFileDialog("RefreshImage",a.globalOpts.imageTemplates);
this.addFileDialog("LoadRegions",a.globalOpts.regionTemplates);this.addFileDialog("LoadSession",a.globalOpts.sessionTemplates);this.addFileDialog("LoadColormap",a.globalOpts.colormapTemplates);this.addFileDialog("LoadCatalog",a.globalOpts.catalogTemplates);a.displays.push(this);a.DEBUG&&a.log("JS9 display:  %s",this.id)};a.Display.prototype.addFileDialog=function(d,c){var b,e,f=this;d&&a.publics[d]&&(e="openLocal"+d+"-"+f.id,b=$("<div>").css("visibility","hidden").css("position","relative").css("top",
-50).css("left",-50).appendTo(f.divjq),b=$("<input>").attr("type","file").attr("id",e).attr("multiple",!0).appendTo(b),c&&b.attr("accept",c),b.on("change",function(){var b,c;if(this.files.length)switch(d){case "Load":case "RefreshImage":c={localAccess:!0},a.waiting(!0,f)}for(b=0;b<this.files.length;b++)a.publics[d](this.files[b],c,{display:f.id});this.value=null;return!1}))};a.Display.prototype.initMessages=function(){this.messageContainer=$("<div>").addClass("JS9Container").css("z-index",a.MESSZINDEX).appendTo(this.divjq);
this.infoArea=$("<div>").addClass("JS9Message").appendTo(this.messageContainer);this.regionsArea=$("<div>").addClass("JS9Message").appendTo(this.messageContainer);this.progressArea=$("<div>").addClass("JS9Progress").addClass("JS9Message").appendTo(this.messageContainer);this.progressBar=$("<progress>").addClass("JS9ProgressBar").attr("value",0).attr("max",100).attr("name","progress").appendTo(this.progressArea);try{this.messageContainer.draggable({start:function(d,c){this.oicb=a.globalOpts.internalContrastBias;
a.globalOpts.internalContrastBias=!1},stop:function(d,c){a.globalOpts.internalContrastBias=this.oicb}})}catch(d){}return this};a.Display.prototype.displayPlugin=function(d){var c,b,e,f,g,h,k,l,n=this;if("string"===typeof d)for(c=0;c<a.plugins.length;c++)if(g=a.plugins[c],g.name===d){d=g;break}"object"===typeof d&&d.name||a.error("unknown plugin type for displayPlugin");l=this.pluginInstances[d.name];switch(a.globalOpts.winType){case "light":b=a.lightOpts[a.LIGHTWIN];if(!l||!l.status){if(k=d.name.replace(/\s/g,
"_"),c=this.id+"_"+k+"_lightDiv",g=this.id+"_"+k+"_outerDiv",k=this.id+"_"+k+"_innerDiv",l||(e=$("<div>").attr("id",g).css("display","none").appendTo($(this.divjq)),$("<div>").addClass(d.name).attr("id",k).attr("data-js9id",this.divjq.attr("id")).css("height","100%").css("width","100%").appendTo(e)),e=d.opts.winDims[0]||a.WIDTH,f=d.opts.winDims[1]||a.HEIGHT,h=d.opts.winResize?"1":"0",b=sprintf(b.format,e,f,h),e=d.opts.toolbarHTML&&0<=d.opts.toolbarHTML.search(/\$title/)?"":d.opts.winTitle||"",e+=
sprintf(a.IDFMT,this.id),g=a.lightWin(c,"div",g,e,b),c=$("#"+c+" #"+k),l=a.instantiatePlugin(c,d,g),l.winHandle.onclose=function(){l.winHandle.hide();l.status="inactive";if(d.opts.onpluginclose)try{d.opts.onpluginclose.call(l,n.image)}catch(m){a.log("onplugincloseCB: %s [%s]\n%s",d.name,m.message,a.strace(m))}return!1},l.status="active",d.opts.onplugindisplay)try{d.opts.onplugindisplay.call(l,this.image)}catch(m){a.log("onplugindisplayCB: %s [%s]\n%s",d.name,m.message,a.strace(m))}}else if("inactive"===
l.status){if(l.winHandle&&(l.winHandle.show(),l.status="active",d.opts.onplugindisplay))try{d.opts.onplugindisplay.call(l,this.image)}catch(m){a.log("onplugindisplayCB: %s [%s]\n%s",d.name,m.message,a.strace(m))}}else if("active"===l.status&&l.winHandle&&(l.winHandle.hide(),l.status="inactive",d.opts.onpluginclose))try{d.opts.onpluginclose.call(l,n.image)}catch(m){a.log("onplugincloseCB: %s [%s]\n%s",d.name,m.message,a.strace(m))}break;case "new":a.error("external window support for plugins not yet implemented")}};
a.Display.prototype.resize=function(d,c,b){var e,f,g,h,k,l=function(a){a.left+=h;a.top+=k;a.setCoords()};a.globalOpts.resize||a.error("display resize not enabled");if(!d&&!c)return{width:this.width,height:this.height};if("full"===d){if(b=c,window.innerWidth&&(d=window.innerWidth),window.innerHeight)for(c=window.innerHeight,e=0;e<a.globalOpts.centerDivs.length;e++)f=a.globalOpts.centerDivs[e],this.pluginInstances[f]&&(c-=this.pluginInstances[f].divjq.height())}else"image"===d?(this.image||a.error("can't resize display to 'image' without an image"),
b=c,d=this.image.raw.width,c=this.image.raw.height):"reset"===d&&(b=c,d=this.width0||d,c=this.height0||c);d=Math.floor(d);c=c?Math.floor(c):d;(10>d||10>c)&&a.error("invalid dimension(s) passed to display resize");if(d===this.width&&c===this.height)return this;b=b||{};e=d;d=c;h=(e-this.width)/2;k=(d-this.height)/2;this.width=e;this.height=d;this.divjq.css("width",e);this.divjq.css("height",d);this.canvasjq.attr("width",e);this.canvasjq.attr("height",d);a.bugs.webkit_resize&&!this.resizing&&(this.owidth=
Math.min(this.owidth,e),this.oheight=Math.min(this.oheight,d));0<=$.inArray("JS9Menubar",a.globalOpts.resizeDivs)&&(a.isNull(b.resizeMenubar)||b.resizeMenubar)&&(c=this.pluginInstances.JS9Menubar)&&$("#"+this.id+"Menubar").css("width",e);0<=$.inArray("JS9Toolbar",a.globalOpts.resizeDivs)&&(a.isNull(b.resizeToolbar)||b.resizeToolbar)&&(c=this.pluginInstances.JS9Toolbar)&&(c.divjq.attr("data-width",String(e)+"px"),a.Toolbar.init.call(c));0<=$.inArray("JS9Colorbar",a.globalOpts.resizeDivs)&&(a.isNull(b.resizeColorbar)||
b.resizeColorbar)&&(c=this.pluginInstances.JS9Colorbar)&&(c.divjq.attr("data-width",String(e)+"px"),a.Colorbar.init.call(c));for(g in this.layers)this.layers.hasOwnProperty(g)&&(c=this.layers[g],"main"===c.dtype&&(c.divjq.css("width",e),c.divjq.css("height",d),c.canvasjq.attr("width",e),c.canvasjq.attr("height",d),c.canvas.setWidth(e),c.canvas.setHeight(d),c.canvas.calcOffset()));for(e=0;e<a.images.length;e++)if(d=a.images[e],d.mkSection(),d.display&&this===d.display&&(d.resize?(d.resize.left+=h,
d.resize.top+=k):d.resize={left:h,top:k},d===d.display.image))for(g in d.layers)d.layers.hasOwnProperty(g)&&(c=d.layers[g],"main"!==c.dlayer.type||c.json||(c.canvas.getObjects().forEach(l),c.canvas.renderAll()));a.bugs.webkit_resize&&this.divjq.css("width",this.width+a.RESIZEFUDGE).css("height",this.height+a.RESIZEFUDGE);!this.image||!a.globalOpts.resizeRedisplay&&this.resizing||(this.image.displayImage("all",b),this.image.refreshLayers());b.center&&this.center();return this};a.Display.prototype.inResize=
function(d){return a.globalOpts.resizeHandle&&d.x+a.RESIZEDIST>=this.divjq.width()&&d.y+a.RESIZEDIST>=this.divjq.height()?!0:!1};a.Display.prototype.center=function(){var d=this.divjq,c,b,e,f;e=d.offset().top;var g=d.height(),h=$(window).height();f=d.offset().left;var d=d.width(),k=$(window).width();for(c=0;c<a.globalOpts.centerDivs.length;c++)b=a.globalOpts.centerDivs[c],this.pluginInstances[b]&&(b=this.pluginInstances[b].divjq,g+=b.height(),e=Math.min(b.offset().top,e));e=g<h?e-(h/2-g/2):e;f=d<
k?f-(k/2-d/2):f;$("html, body").animate({scrollTop:e,scrollLeft:f},250);return this};a.Display.prototype.gather=function(d){var c,b;if("string"===typeof d)try{d=JSON.parse(d)}catch(e){a.error("can't parse gather opts: "+d,e)}d=d||{};c=d.images||a.images;for(d=0;d<c.length;d++)(b="number"===typeof c[d]?a.images[c[d]]:c[d])&&b.display!==this&&b.moveToDisplay(this);a.globalOpts.extendedPlugins&&this.image&&this.image.xeqPlugins("image","ongatherdisplay")};a.Display.prototype.separate=function(d){var c,
b,e=0,f=0,g=0,h=1,k,l,n,m,r,q,t,u,v,p,w,x,A,z={},C=/_sep[0-9][0-9]*/,D=a.globalOpts.separate,y=a.bugs.webkit_resize?a.RESIZEFUDGE:0,B=this,F=function(b,c){b||a.error("can't init seapration ops: no from id");k=c.layout||a.globalOpts.separate.layout||"auto";l=c.leftMargin||D.leftMargin||0;n=c.topMargin||D.topMargin||0;switch(k){case "auto":g=1;f=0;break;case "horizontal":g=1;f=0;break;case "vertical":g=0;f=1;break;default:g=1,f=0}m=43;r=0;q=$("#"+b);t=$("#"+b+"Menubar");0<t.length&&(t.isactive="visible"===
t.closest(".JS9PluginContainer").css("visibility"));u=$("#"+b+"Toolbar");0<u.length&&(u.isactive="visible"===u.closest(".JS9PluginContainer").css("visibility"));v=$("#"+b+"Colorbar");0<v.length&&(v.isactive="visible"===v.closest(".JS9PluginContainer").css("visibility"));0<q.length&&(p=q.width(),w=q.height(),x=q.offset().top-$(window).scrollTop(),A=q.offset().left-$(document).scrollLeft(),t.isactive&&(w+=t.height(),x-=t.height()),u.isactive&&(w+=u.height(),x-=u.height()),v.isactive&&(w+=v.height(),
x-=v.height(),x+=7))},H=function(a,b){var c,d;a&&(0<q.length&&(c="",t.isactive&&(c+=sprintf("<div class='JS9Menubar' id='%sMenubar' data-width=%s></div>",b,q.width())),u.isactive&&(c+=sprintf("<div class='JS9Toolbar' id='%sToolbar' data-width=%s></div>",b,q.width())),c+=sprintf("<div class='JS9' id='%s' data-width=%s data-height=%s></div>",b,q.width()-y,q.height()-y),v.isactive&&(c+=sprintf("<div style='margin-top: 2px;'><div class='JS9Colorbar' id='%sColorbar' data-width=%s></div></div>",b,q.width()))),
"auto"===k&&A+p*(g+.5)>window.innerWidth&&(f++,g=0),d=sprintf("width=%s,height=%s,top=%s,left=%s,resize=1,scolling=1",p,w,x+(w+n+m)*f,A+(p+l+r)*g),"auto"===k||"horizontal"===k?g++:"vertical"===k&&f++);return{id:b,html:c,winopts:d}},G=function(f){var g,k;g=e++;f.length>g?(g="number"===typeof f[g]?a.images[f[g]]:f[g])&&g.display===B?(g.displayImage("all"),void 0===c?(c=g.display.id,F(c,d),G(f)):(b="string"===typeof d.idbase?k=d.idbase+h++:c.replace(C,"")+"_sep"+a.uniqueID(),z[b]=g,$("#dhtmlwindowholder").arrive("#"+
b,{onceOnly:!0},function(){k=$(this).attr("id");window.setTimeout(function(){z[k].moveToDisplay(k);G(f)},0)}),g=H(c,b),k&&(g.id=k),a.LoadWindow(null,{id:g.id},"light",g.html,g.winopts))):G(f):a.globalOpts.extendedPlugins&&B.image&&B.image.xeqPlugins("image","onseparatedisplay")};if("string"===typeof d)try{d=JSON.parse(d)}catch(E){a.error("can't parse separate opts: "+d,E)}d=d||{};G(d.images||a.images)};a.Display.prototype.nextImage=function(d){var c,b,e;d=d||1;if(this.image){e=this.image.pos;for(c=
0;c<a.images.length&&this.image!==a.images[c];c++);for(b=c+d;b!==c&&(b>=a.images.length&&(b=0),0>b&&(b=a.images.length-1),a.images[b].display!==this);b+=d);c!==b&&(d=a.images[b],d.displayImage("all"),d.refreshLayers(),d.display.clearMessage(),e&&(e=d.displayToImagePos(e),d.valpos=null,d.valpos=d.updateValpos(e,!0)));return this}};a.Display.prototype.loadSession=function(d,c){var b,e,f={},g=this,h=function(b){var c,d,h,k,l,n=function(){var c=this.canvas.getObjects();c&&"undefined"!==typeof c.length&&
(b.layers[this.layerName].nshape=c.length+1);a.Fabric.updateChildren(this,null,"objects");b.refreshLayers()};l=f[b.file]||{};l.blend&&(b.blend=$.extend(!0,{},l.blend));l.tmp&&(b.tmp=$.extend(!0,{},l.tmp));l.wcsim&&(b.wcsim=a.lookupImage(l.wcsim));if(l.layers&&l.layers.length)for(c=0;c<l.layers.length;c++)if(h=l.layers[c],k=h.name,!(0<=$.inArray("regions",b.params.disable)&&"regions"===k)&&"crosshair"!==k&&"grid"!==k&&(d=g.newShapeLayer(k,h.dopts),b.addShapes(k,[]),d.canvas.loadFromJSON(h.json,n.bind(d)),
h.catalog&&(b.layers[k].catalog=h.catalog),h.starbase))try{b.layers[k].starbase=JSON.parse(h.starbase)}catch(p){}b.tmp&&"active"===b.tmp.gridStatus&&b.displayCoordGrid(!0);a.notNull(e)&&(--e,0===e&&a.images.sort(function(a,b){var c=0,d=0;f[a.file]&&(c=f[a.file].i);f[b.file]&&(d=f[b.file].i);return c-d}));l.xeqstash&&b.xeqStashCall(l.xeqstash);a.globalOpts.extendedPlugins&&a.images[0].xeqPlugins("image","onsessionload")},k=function(d){d.file||a.error("session does not contain a filename");b=$.extend(!0,
{},d);delete b.params.display;b.params.crosshair=!1;b.params.onload=h;d=b.file;b.sect&&(b.params.xcen=b.sect.xcen,b.params.ycen=b.sect.ycen,b.params.xdim=b.sect.xdim,b.params.ydim=b.sect.ydim,b.params.zoom=b.sect.zoom,delete b.sect);window.isElectron&&a.desktopOpts.sessionPath&&c.sessionPath&&"/"!==b.file.charAt(0)&&!b.file.match(a.URLEXP)&&(d=a.fixPath(c.sessionPath+b.file));f[d]=b;a.Load(d,b.params,{display:g.id})},l=function(b){var c,d;b.globalOpts&&($.extend(!0,a.globalOpts,b.globalOpts),delete b.globalOpts);
if(b.cmaps)for(c=0;c<b.cmaps.length;c++)a.AddColormap(b.cmaps[c]);if(b.images)for(e=b.images.length,c=0;c<b.images.length;c++)b.images[c].i=c,k(b.images[c]);else k(b);if(b.display)for(d in b.display)if(b.display.hasOwnProperty(d))switch(d){case "blendMode":a.BlendDisplay(b.display[d],{display:g});break;default:g[d]=b.display[d]}};c=c||{};a.waiting(!0,this);"object"===typeof d?l(d):$.ajax({url:d,cache:!1,dataType:"json",mimeType:"application/json",async:!1,success:function(a){l(a)},error:function(b,
c,e){a.error("could not load session: "+d,e)}});return this};a.Display.prototype.displayMessage=function(a,c,b){};a.Display.prototype.clearMessage=function(a){};a.Display.prototype.createMosaic=function(d,c){var b,e,f,g,h=this,k=function(){var b;for(b=0;b<g.length;b++)a.vunlink(g[b])},l=function(b,c){var d;0>c.search(/\[struct stat="OK"/)&&(a.waiting(!1),k(),(d=c.match(/msg="(.*)"/))&&d[1]?a.error(d[1]+" (from "+b+")"):a.error(c||"unknown "+b+" failure"))},n=function(b,c){var d;c=c||{};d=$.extend(!0,
{},c);!1!==c.waiting&&a.waiting(!0,h);d.display=h.id;a.checkNew(new a.Image(b,d));a.waiting(!1)},m=function(b){for(var d=[],e=0;e<arguments.length;++e)d[e-0]=arguments[e];if(c.verbose||1<a.DEBUG)d=sprintf.apply(null,[].concat($jscomp.arrayFromIterable(d))),a.log(d)};c=c||{};c.reduce=c.reduce||a.globalOpts.reduceMosaic;c.dim=c.dim||Math.max(a.globalOpts.image.xdim,a.globalOpts.image.ydim);if(d)if("string"===typeof d)if("current"===d)d=this.image?[this.image]:[];else if("all"===d)for(d=[],b=0;b<a.images.length;b++)a.images[b].display.id===
h.id&&d.push(a.images[b]);else d=[d];else $.isArray(d)||a.error("unknown input type for createMosaic()");else d=this.image?[this.image]:[];d.length||a.error("no images specified for createMosaic()");for(b=0;b<d.length;b++)"string"===typeof d[b]&&((e=a.lookupImage(d[b]))?d[b]=e:a.error("unknown image for mosaic: "+d[b])),e=d[b],e.raw.hdu&&e.raw.hdu.fits&&e.raw.hdu.fits.vfile||a.error("no virtual file available for mosaic: "+e.id);a.waiting(!0,h);window.setTimeout(function(){var e,h,t,u,v,p,w,x,A,z,
C,D=a.uniqueID();C=function(a){return"mosaic_"+D+"_"+a};h=C("in.lst");v=C("in.tbl");u=C("in.hdr");t=C("bin.lst");w=C("bin.tbl");x=C("out.lst");A=C("out.tbl");z=C("out.hdr");C=d[0].id.replace(/\[.*\]/,"").replace(/\.fz$/i,"").replace(/\.gz$/i,"").replace(/\.fits$/i,"_mosaic.fits");e=C.replace(/\.fits$/,"_area.fits");g=[h,v,u,t,w,x,A,z,e];e=sprintf("%s\n%s\n","|                                                    fname|","|                                                     char|");for(b=0;b<d.length;b++)e+=
sprintf("%s\n",d[b].raw.hdu.fits.vfile);a.vfile(h,e);h=a.imgtbl(h,".",v,"-C");l("mImgtbl",h);a.vsize(v)||a.error("no image data found with which to construct a mosaic");h=a.makehdr(v,u,"");l("mMakeHdr",h);if("js9"===c.reduce){e=a.vread(u).split("\n");for(b=u=0;b<e.length;b++)switch(h=e[b].split("="),h[0].trim()){case "NAXIS1":u=Math.max(u,parseFloat(h[1].trim()));break;case "NAXIS2":u=Math.max(u,parseFloat(h[1].trim()))}f=Math.max(1,Math.floor(u/c.dim+.5));e=sprintf("%s\n%s\n","|                                                    fname|",
"|                                                     char|");v=a.vread(v);v=v.trim().split("\n");v.splice(0,3);for(b=0;b<v.length;b++)h=v[b].trim().split(/\s+/),u=h[h.length-2],h=h[h.length-1],u&&h&&(p=sprintf("%s[%s]",h,u),u=sprintf("bin_%s_%s",u,h.split("/").reverse()[0].replace(/\.(g|f)z$/,"")),g.push(u),h=sprintf("0@0,0@0,%s",f),m("bin %s [%s]",p,f),a.imsection(p,u,h,""),e+=sprintf("%s\n",u));a.vfile(t,e);h=a.imgtbl(t,".",w,"-C");l("mImgtbl",h);a.vsize(w)||a.error("no image data found to construct a mosaic");
h=a.makehdr(w,z,"");l("mMakeHdr",h);v=a.vread(w)}else h=a.shrinkhdr(c.dim,u,z),l("mShrinkHdr",h),v=a.vread(v);v=v.trim().split("\n");v.splice(0,3);e=sprintf("%s\n%s\n","|                                                    fname|","|                                                     char|");for(b=0;b<v.length;b++)h=v[b].trim().split(/\s+/),u=h[h.length-2],h=h[h.length-1],u&&h&&(t="-a 1","shrink"===c.reduce&&(t+=sprintf(" -h %s",u)),t+=" "+a.globalOpts.reprojSwitches,w=sprintf("reproj_%s_%s",u,h.split("/").reverse()[0].replace(/\.(g|f)z$/,
"")),e+=sprintf("%s\n",w),g.push(w),g.push(w.replace(/\.fits$/i,"_area.fits")),m("reproject: %s [%s] -> %s",h,u,w),h=a.reproject(h,w,z,t),l("mProjectPP",h));a.vfile(x,e);h=a.imgtbl(x,".",A,"");l("mImgtbl",h);a.vsize(A)||a.error("no FITS files were added to output table for mosaic");m("create mosaic: %s",C);h=a.madd(A,z,C,"");l("mAdd",h);k();x=$.extend(!0,{},a.fits.options,c);x.image={xdim:0,ydim:0};x.file=C;a.fits.handleFITSFile(C,x,n)},a.SPINOUT);return this};a.Command=function(d){for(var c in d)d.hasOwnProperty(c)&&
(this[c]=d[c]);d.name||a.error("command has no name");d.get||d.set||a.error("command requires get and/or set routine");a.commands.push(this);1<a.DEBUG&&a.log("JS9 command:  %s",this.name)};a.Command.prototype.getDisplayInfo=function(a){a&&a.id&&(this.display=a,this.image=a.image);return this};a.Command.prototype.getWhich=function(a){return this.get&&!this.set?"get":this.set&&!this.get?"set":this.which?this.which(a):0===a.length?"get":"set"};a.Helper=function(){"file:"===a.globalOpts.helperProtocol&&
(a.globalOpts.helperProtocol="http:");document.domain&&"localhost"!==document.domain||(a.globalOpts.htimeout=a.globalOpts.lhtimeout);a.globalOpts.helperProtocol+="//";this.helper=this.connected=!1;this.type=a.allinone&&!a.globalOpts.allinoneHelper?"none":a.globalOpts.helperType||"sock.io";this.pageid=null;this.connect()};a.Helper.prototype.connectinfo=function(){var d;return null===a.helper.connected?"notConfigured":a.helper.connected?(d=sprintf("connected %s %s",a.helper.type,a.helper.url),a.helper.pageid&&
(d+="<p>"+a.helper.pageid),d):sprintf("notConnected %s",a.helper.type)};a.Helper.prototype.connect=function(d){var c=a.globalOpts.ehretries,b=a.globalOpts.ehtimeout,e=this,f=function(b,c,d){e.connected=!1;e.helper=!1;e.ready=!0;$(document).trigger("JS9:helperReady",{type:"socket.io",status:"error"});c=c||"timeout";d&&"timeout"!==d||(d="or connection refused");d===c&&(c="");"error"===d&&(d="is the helper running?");a.globalOpts.requireHelper?a.error("helper connect error: "+c+" "+d):a.DEBUG&&a.log(sprintf("JS9 helper connect error: %s (%s)",
c,d))},g=function(b){$.ajax({url:b,dataType:"script",timeout:a.globalOpts.htimeout,success:function(){var b={reconnection:!0,reconnectionDelay:1E3,reconnectionDelayMax:1E4,reconnectionAttempts:100,timeout:a.globalOpts.htimeout};"undefined"===typeof io?f(null,"socket io object is undefined",null):(e.socket=io.connect(e.url,b),e.socket.on("connect",function(){var b,c;e.connected=!0;e.helper=!0;c=[];for(b=0;b<a.displays.length;b++)c.push(a.displays[b].id);e.socket.emit("initialize",{displays:c,pageid:e.pageid},
function(b){e.pageid=b.pageid;e.js9helper=b.js9helper;a.globalOpts.dataPathModify=b.dataPathModify;e.ready=!0;$(document).trigger("JS9:helperReady",{type:"socket.io",status:"OK"});a.DEBUG&&a.log("JS9 helper: connect: "+e.type)});$(document).trigger("JS9:connected",{type:"socket.io",status:"OK"})}),e.socket.on("connect_error",function(){e.connected=!1;e.helper=!1;1<a.DEBUG&&a.log("JS9 helper: connect error")}),e.socket.on("connect_timeout",function(){e.connected=!1;e.helper=!1;1<a.DEBUG&&a.log("JS9 helper: connect timeout")}),
e.socket.on("disconnect",function(b){e.connected=!1;e.helper=!1;1<a.DEBUG&&a.log("JS9 helper: disconnect: "+b);"io server disconnect"===b&&(1<a.DEBUG&&a.log("JS9 helper: manual reconnect"),e.socket.connect())}),e.socket.on("reconnect",function(){e.connected=!0;e.helper=!0;1<a.DEBUG&&a.log("JS9 helper: reconnect")}),e.socket.on("msg",a.msgHandler))},error:function(a,b,c){f(a,b,c)}})},h=function(a,c,d){$.ajax({url:a,dataType:"jsonp",success:function(){g(c)},error:function(){0<--d?window.setTimeout(function(){h(a,
c,d)},b):f()}})};d&&(this.type=d);if(this.socket){try{this.socket.disconnect()}catch(k){a.log("warning: can't disconnect from socket")}this.socket=null}a.globalOpts.helperURL?0<=a.globalOpts.helperURL.search(/:\/\//)?this.url=a.globalOpts.helperURL:this.url=a.globalOpts.helperProtocol+a.globalOpts.helperURL:this.url=document.domain?location.origin?location.origin:a.globalOpts.helperProtocol+document.domain:a.globalOpts.helperProtocol+"localhost";this.baseurl=this.url;switch(this.type){case "none":this.connected=
null;this.ready=!0;$(document).trigger("JS9:helperReady",{type:"none",status:"OK"});break;case "get":case "post":a.globalOpts.helperCGI||a.error("cgi script name missing for helper");this.url+="/"+a.globalOpts.helperCGI;this.helper=this.connected=!0;a.DEBUG&&a.log("JS9 helper: connect: "+this.type);this.ready=!0;$(document).trigger("JS9:helperReady",{type:"get",status:"OK"});break;case "sock.io":case "nodejs":a.globalOpts.helperPort||a.error("port missing for helper");this.url=this.url.replace(/:[0-9][0-9]*$/,
"")+":"+a.globalOpts.helperPort;this.sockurl=window.multiElectron?this.url+"/socket.io/socket.io.slim.js":this.url+"/socket.io/socket.io.js";window.isElectron?(this.aliveurl=this.url+"/alive",h(this.aliveurl,this.sockurl,c)):g(this.sockurl);break;default:a.error("unknown helper type: "+this.type)}};a.Helper.prototype.send=function(d,c,b){if(!this.connected)return null;if(c&&"object"===typeof c){try{c.cookie=document.cookie}catch(e){delete c.cookie}a.globalOpts.dataPath&&!c.dataPath&&(c.dataPath=a.globalOpts.dataPath+
":.")}else c={dataPath:"."};a.TOROOT&&(c.dataPath+=":"+a.TOROOT);switch(this.type){case "get":case "post":c.key=d;a.helper.pageid&&(c.pageid=a.helper.pageid);a.DEBUG&&a.log("JS9 cgi helper [%s, %s]: %s",this.type,JSON.stringify(c),this.url);$.ajax({url:this.url,type:this.type.toUpperCase(),data:c,dataType:"text",success:function(c){"string"===typeof c&&0<=c.search(a.analOpts.epattern)&&a.log(c);b&&b(c)},error:function(b,c,d){a.DEBUG&&a.log("JS9 helper: "+this.type+" failure: "+c+" "+d)}});break;case "sock.io":case "nodejs":a.helper.socket.emit(d,
c,b)}return this};a.WebWorker=function(d){this.worker=new Worker(d);this.worker.onmessage=a.WebWorker.prototype.msgHandler.bind(this);this.handlers=[]};a.WebWorker.prototype.msgHandler=function(d){var c,b=d.data;switch(b.cmd){case "progress":a.progress(b.result.value,b.result.max);break;case "initsocketio":this.sockinit=!0;for(d=0;d<this.handlers.length;d++)if(c=this.handlers[d],c.id===b.id){c.func(b.result);this.handlers.splice(d,1);break}break;case "uploadFITS":for(d=0;d<this.handlers.length;d++)if(c=
this.handlers[d],c.id===b.id){c.func(b.result);this.handlers.splice(d,1);break}break;case "connect_error":case "connect_timeout":1<a.DEBUG&&a.log("JS9 worker socketio: "+b.cmd);break;case "disconnect":a.waiting(!1);b.result?a.worker.postMessage("initsocketio",[a.helper.url,a.helper.pageid],function(){a.error(b.result)}):1<a.DEBUG&&a.log("JS9 worker socketio: disconnect");break;case "error":a.error(b.result||"in web worker")}};a.WebWorker.prototype.postMessage=function(d,c,b,e){var f=d+a.uniqueID(),
g={id:f,cmd:d,args:c};b&&(c=c||[],this.handlers.push({id:f,cmd:d,args:c,func:b}));e?this.worker.postMessage(g,e):this.worker.postMessage(g)};a.WebWorker.prototype.socketio=function(d){var c=a.helper;a.worker.sockinit?d&&d():a.worker.postMessage("initsocketio",[c.url,c.pageid],function(b){"OK"===b?d&&d():a.error("can't init  socket.io for JS9 worker: "+b)})};a.WebWorker.prototype.terminate=function(){this.worker.terminate()};fabric.major_version=parseFloat(fabric.version.split(".")[0]);fabric.minor_version=
parseFloat(fabric.version.split(".")[1]);a.Fabric={};a.Fabric.elements="cornerSize cornerColor cornerStyle borderColor transparentCorners selectionLineWidth centeredScaling hasControls hasRotatingPoint lockMovementX lockMovementY lockRotation lockScalingX lockScalingY lockUniScaling selectable hasBorders params pub".split(" ");a.Fabric.opts={originX:"center",originY:"center",strokeWidth:2,selectionLineWidth:2,borderColor:"#00EEFF",cornerColor:"#00EEFF",cornerSize:fabric.isTouchSupported?10:6,cornerStyle:"circle",
hasControls:!0,hasRotatingPoint:!0,hasBorders:!0,transparentCorners:!1,centeredScaling:!0,selectable:!0,padding:0,canvas:{selection:!0},fill:"transparent",objectCaching:!1};a.Fabric.rescaleStrokeWidth=function(d,c){var b=(this.scaleX+this.scaleY)/2;d=d||1;d*=b;!c&&this.params&&(c=this.params.sw1);c&&("group"===this.type?this.forEachObject(function(b){a.Fabric.rescaleStrokeWidth.call(b,d,c)}):this.set("strokeWidth",c/d))};a.Fabric.rescaleEvenly=function(){var a;if(this.params&&this.scaleX!==this.scaleY)switch(this.params.shape){case "annulus":case "circle":a=
this.params.lastscale||1,this.scaleX!==a?this.scaleY=this.scaleX:this.scaleY!==a&&(this.scaleX=this.scaleY),this.params.lastscale=this.scaleX}};fabric.Object.prototype.rescaleBorder=a.Fabric.rescaleStrokeWidth;fabric.Object.prototype.rescaleEvenly=a.Fabric.rescaleEvenly;a.Fabric.newShapeLayer=function(d,c,b){var e,f,g=function(b,c){b.params.sel=null;b.display.image&&(b.display.image.layer=null);if(c)switch(c.type){case "polyline":case "polygon":a.Fabric.removePolygonAnchors(b,c),b.canvas.renderAll()}c&&
b.display.image&&b.display.image.updateShapes(d,c,"unselect")},h=function(b,c){b.params.sel&&c.params&&b.params.sel!==c&&g(b,b.params.sel);if(c){switch(c.type){case "polyline":case "polygon":a.Fabric.addPolygonAnchors(b,c),b.canvas.renderAll()}c.polyparams?b.params.sel=c.polyparams.polygon:c.params&&(b.params.sel=c)}b.display.image&&(b.display.image.layer=d);c&&b.display.image&&b.display.image.updateShapes(d,c,"select")};if(this&&d){if(this.layers[d])return this.layers[d];this.layers[d]={};f=this.layers[d];
f.layerName=d;f.params=[];f.params.sel=null;f.params.sellayer=null;b?f.dtype="other":(f.dtype="main",b=this.divjq);e=b.attr("id")+"-"+d.replace(/\s+/,"_")+"-shapeLayer";f.display=this;f.opts=$.extend(!0,{},c);f.opts.canvas=f.opts.canvas||{};void 0===f.opts.canvas.selection&&(f.opts.canvas.selection=!0);f.el=a.Fabric.elements;f.divjq=$("<div>").addClass("JS9Container").css("z-index",0).appendTo(b);f.canvasjq=$("<canvas>").addClass("JS9Layer").attr("id",e).attr("width",b.css("width")).attr("height",
b.css("height")).appendTo(f.divjq);a.bugs.webkit_resize&&"main"===f.dtype&&f.canvasjq.attr("width",this.width).attr("height",this.height);f.canvas=new fabric.Canvas(f.canvasjq[0]);f.canvas.renderOnAddRemove=!1;f.canvas.preserveObjectStacking=!0;f.opts.movable?(f.opts.lockMovementX=!1,f.opts.lockMovementY=!1,f.opts.selectable=!0,f.opts.evented=!0):!1===f.opts.movable&&(f.opts.lockMovementX=!0,f.opts.lockMovementY=!0,f.opts.selectable=!1,f.opts.evented=!1);void 0===f.opts.changeable&&void 0!==f.opts.fixinplace&&
(f.opts.changeable=!f.opts.fixinplace);f.opts.changeable?(f.opts.hasControls=!0,f.opts.hasRotatingPoint=!0,f.opts.hasBorders=!0,f.opts.lockMovementX=!1,f.opts.lockMovementY=!1,f.opts.lockRotation=!1,f.opts.lockScalingX=!1,f.opts.lockScalingY=!1,f.opts.lockUniScaling=!1,f.opts.selectable=!0,f.opts.evented=!0,f.opts.usekeyboard=!0):!1===f.opts.changeable&&(f.opts.hasControls=!1,f.opts.hasRotatingPoint=!1,f.opts.hasBorders=!1,f.opts.lockMovementX=!0,f.opts.lockMovementY=!0,f.opts.lockRotation=!0,f.opts.lockScalingX=
!0,f.opts.lockScalingY=!0,f.opts.lockUniScaling=!0,f.opts.selectable=!1,f.opts.evented=!1,f.opts.usekeyboard=!1);f.opts.selectable&&(f.opts.canvas.selection=!0);if(f.opts.onmousedown||f.opts.onmouseup||f.opts.onmousemove||f.opts.tooltip||f.opts.onmouseover||f.opts.onmouseout){f.opts.evented=!0;if(f.opts.onmousedown)f.canvas.on("mouse:down",function(b){if(f.display.image&&b.target)"main"===f.dtype&&(f.display.image.clickInRegion=!0,f.display.image.clickInLayer=d),f.opts.onmousedown.call(this,f.display.image,
b.target.pub,b.e,b.target);else if(this._selection=this.selection)this.selection=a.specialKey(b.e)});else f.canvas.on("mouse:down",function(b){if(this._selection=this.selection)this.selection=a.specialKey(b.e)});if(f.opts.onmouseup)f.canvas.on("mouse:up",function(a){f.display.image&&a.target&&f.opts.onmouseup.call(this,f.display.image,a.target.pub,a.e,a.target);this.selection=this._selection||this.selection});else f.canvas.on("mouse:up",function(){this.selection=this._selection||this.selection});
if(f.opts.onmousemove)f.canvas.on("mouse:move",function(a){f.display.image&&a.target&&f.opts.onmousemove.call(this,f.display.image,a.target.pub,a.e,a.target)});if(f.opts.onmouseover)f.canvas.on("mouse:over",function(a){f.display.image&&a.target&&f.opts.onmouseover.call(this,f.display.image,a.target.pub,a.e,a.target)});if(f.opts.onmouseout)f.canvas.on("mouse:out",function(a){f.display.image&&a.target&&f.opts.onmouseout.call(this,f.display.image,a.target.pub,a.e,a.target)});f.opts.tooltip&&(f.canvas.on("mouse:over",
function(b){f.display.image&&b.target&&a.tooltip(b.target.left+b.target.width+2,b.target.top+b.target.height+2,f.opts.tooltip,f.display.image,b.target.pub,b.e,b.target)}),f.canvas.on("mouse:out",function(b){f.display.image&&b.target&&a.tooltip(b.target.left,b.target.top,null,f.display.image,b.target.pub,b.e,b.target)}))}else f.canvas.on("mouse:down",function(b){if(this._selection=this.selection)this.selection=a.specialKey(b.e)}),f.canvas.on("mouse:up",function(){this.selection=this._selection||this.selection});
"function"===typeof f.opts.ongroupcreate&&(f.opts.canvas.selection=!0,f.opts.selectable=!0,f.canvas.on("selection:created",function(a){var b=[],c=[];f.display.image&&a.target&&"group"===a.target.type&&(a.target.forEachObject(function(a){a.pub&&(c.push(a),b.push(a.pub))}),f.opts.ongroupcreate.call(this,f.display.image,b,a.e,c))}));f.canvas.on("object:modified",function(b){var c,d,e,g,h=[];if(b.target&&(c=b.target,a.Fabric.updateChildren(f,c,"deltas"),f.opts.sortOverlapping&&(c.setCoords(),f.canvas.forEachObject(function(a){a!==
c&&c.intersectsWithObject(a)&&(1===fabric.major_version?(e=a.getWidth(),g=a.getHeight()):(e=a.getScaledWidth(),g=a.getScaledHeight()),h.push({obj:a,siz:e*g}))}),h.length)))for(1===fabric.major_version?(e=c.getWidth(),g=c.getHeight()):(e=c.getScaledWidth(),g=c.getScaledHeight()),h.push({obj:c,siz:e*g}),h.sort(function(a,b){return a.siz<b.siz?-1:a.siz>b.siz?1:0}),d=h.length,b=0;b<d;b++)try{h[b].obj.sendToBack()}catch(t){}});f.canvas.on("object:scaling",function(b){b.target&&(b=b.target,b.rescaleEvenly(),
b.rescaleBorder(),a.Fabric.updateChildren(f,b,"scaling"))});f.canvas.on("object:moving",function(b){b.target&&a.Fabric.updateChildren(f,b.target,"moving")});f.canvas.on("object:rotating",function(b){b.target&&a.Fabric.updateChildren(f,b.target,"rotating")});1===fabric.major_version?(f.canvas.on("object:selected",function(a){a.target&&h(f,a.target)}),f.canvas.on("before:selection:cleared",function(a){a.target&&g(f,a.target)})):(f.canvas.on("selection:created",function(a){a.target&&h(f,a.target)}),
f.canvas.on("selection:updated",function(b){var c=f.canvas.getActiveObject();if("activeSelection"===c.type){var e,g,k,q=f.canvas.getActiveObjects(b);for(b=0;b<q.length;b++)if(g=q[b],g.params){g.params.parent&&g.params.parent.obj&&(e=g.params.parent.obj,0>$.inArray(e,q)&&c.addWithUpdate(e));if(g.params.children)for(e=0;e<g.params.children.length;e++)k=g.params.children[e].obj,0>$.inArray(k,q)&&c.addWithUpdate(k);switch(g.type){case "polyline":case "polygon":a.Fabric.removePolygonAnchors(f,g)}g&&f.display.image&&
f.display.image.updateShapes(d,g,"select")}f.canvas.renderAll()}else h(f,c)}),f.canvas.on("before:selection:cleared",function(a){var b=f.canvas.getActiveObject();if("activeSelection"===b.type){var c=f.canvas.getActiveObjects(a);for(a=0;a<c.length;a++)b=c[a],g(f,b)}else g(f,b)}));if(f.divjq.closest(a.lightOpts[a.LIGHTWIN].drag).length)if(fabric.isTouchSupported)f.divjq.on("touchstart",function(){f.canvas.calcOffset()});else f.divjq.on("mouseenter",function(){f.canvas.calcOffset()});return f}};a.Fabric.showShapeLayer=
function(d,c,b){var e,f,g,h,k;k=0;var l=this;if(f=this.getShapeLayer(d)){b=b||{};h=f.canvas;g=this.display.layers[d];if(c){b.local||(f.show=!0);f.show&&(h.selection=f.opts.canvas.selection);f.json&&f.show&&h.loadFromJSON(f.json,function(){var b,c,e;a.Fabric.updateChildren(f.dlayer,null,"objects");l.resize&&(h.getObjects().forEach(function(a){a.left+=l.resize.left;a.top+=l.resize.top;a.setCoords()}),h.calcOffset());l.layers[d].opts.panzoom?(l.binning.obin=l.binning.bin,l.rgb.sect.ozoom=l.rgb.sect.zoom,
l.refreshShapes(d)):h.renderAll();f.zindex=Math.abs(f.zindex);g.divjq.css("z-index",f.zindex);for(b in l.layers)l.layers.hasOwnProperty(b)&&d!==b&&l.layers[b].show&&(c=l.display.layers[b],c.divjq.css("z-index")<f.zindex&&(e=c.canvas.getActiveObject()))&&(a.Fabric.removePolygonAnchors(c,e),c.canvas.discardActiveObject())});for(e in this.layers)this.layers.hasOwnProperty(e)&&this.layers[e].json&&k++;k||(this.resize=null);this.xeqPlugins("shape","onshapelayershow",d)}else{if(f.show){c=h.getObjects();
for(e=c.length;e--;)k=c[e],k.params&&(k.params.winid&&(k.params.winid.close(),k.params.winid=null),k.params.anchors&&a.Fabric.removePolygonAnchors(f.dlayer,k));c=h.toJSON(f.dlayer.el);f.json=JSON.stringify(c);h.selection=!1;g&&(f.zindex=-Math.abs(f.zindex),g.divjq.css("z-index",f.zindex));h.clear()}b.local||(f.show=!1);this.xeqPlugins("shape","onshapelayerhide",d)}return this}};a.Fabric.displayShapeLayers=function(){var a;if(this!==this.display.image){if(this.display.image&&this.display.image.layers)for(a in this.display.image.layers)this.display.image.layers.hasOwnProperty(a)&&
this.display.image.showShapeLayer(a,!1,{local:!0});if(this.layers)for(a in this.layers)this.layers.hasOwnProperty(a)&&this.showShapeLayer(a,!0,{local:!0})}};a.Fabric.toggleShapeLayers=function(){var a,c;if(this.toggleLayers){for(a in this.layers)this.layers.hasOwnProperty(a)&&(c=this.layers[a])&&this.toggleLayers[a]&&this.showShapeLayer(a,!0);delete this.toggleLayers}else for(a in this.toggleLayers={},this.layers)this.layers.hasOwnProperty(a)&&"crosshair"!==a&&(c=this.layers[a])&&c.show&&"main"===
c.dlayer.dtype&&(this.toggleLayers[a]=!0,this.showShapeLayer(a,!1))};a.Fabric.getShapeLayer=function(a,c){var b,d;if(!a)return null;d=this.layers[a];if(!d){b=this.display.layers[a];if(!b)return null;this.layers[a]={};d=this.layers[a];d.show=!0;d.nshape=0;d.dlayer=b;d.opts=d.dlayer.opts;d.canvas=d.dlayer.canvas;d.canvas.calcOffset()}return d};a.Fabric.activeShapeLayer=function(a){var c,b,d,f;if(a)if($.isArray(a)){c=0;for(b=this.zlayer-1;c<a.length;c++)f=this.layers[a[c]],"main"===f.dlayer.dtype&&(f.zindex=
b--,f.show?d||(d=a[c]):f.zindex=-f.zindex,f.dlayer.divjq.css("z-index",f.zindex));a=d}else{if((f=this.layers[a])&&f.show){d=f.zindex;f.zindex=this.zlayer-1;f.dlayer.divjq.css("z-index",f.zindex);for(c in this.layers)this.layers.hasOwnProperty(c)&&(b=this.layers[c],b!==f&&b.zindex===f.zindex&&"main"===b.dlayer.dtype&&(b.zindex=d,b.dlayer.divjq.css("z-index",b.zindex)));this.xeqPlugins("shape","onshapelayeractive",a)}a=this}else{for(c in this.layers)this.layers.hasOwnProperty(c)&&(b=this.layers[c],
"main"===b.dlayer.dtype&&(void 0===f||b.zindex>f)&&(f=b.zindex,d=c));a=d}return a};a.Fabric._parseShapeOptions=function(d,c,b){var e,f,g,h,k,l,n={},m={};h="main"===this.display.layers[d].dtype?this.rgb.sect.zoom:1;if(c.remove)return{remove:c.remove};m.tags=[];delete c.parent;delete c.id;if(c.tags)if("string"===typeof c.tags)for(f=c.tags.toLowerCase().split(","),d=0;d<f.length;d++)m.tags[d]=f[d].trim();else if($.isArray(c.tags))for(d=0;d<c.tags.length;d++)m.tags[d]=c.tags[d].trim();void 0!==c.angle&&
(n.angle=-c.angle);void 0!==c.x&&void 0!==c.y&&(f=this.imageToDisplayPos(c),n.left=f.x,n.top=f.y);void 0!==c.px&&void 0!==c.py&&(f=this.logicalToDisplayPos({x:c.px,y:c.py}),n.left=f.x,n.top=f.y);"string"===typeof c.wcs&&(f=c.wcs.trim().split(/ +/),c.ra=f[0],c.dec=f[1],3<=f.length&&(c.wcssys=f[2]));void 0!==c.ra&&void 0!==c.dec&&0<this.raw.wcs&&(c.wcssys?(g=this.getWCSSys(),e=a.globalOpts.xeqPlugins,a.globalOpts.xeqPlugins=!1,this.setWCSSys(c.wcssys)):c._wcssys&&(g=this.getWCSSys(),e=a.globalOpts.xeqPlugins,
a.globalOpts.xeqPlugins=!1,this.setWCSSys(c._wcssys),delete c._wcssys),"string"===typeof c.ra&&(c.ra=a.saostrtod(c.ra),":"===String.fromCharCode(a.saodtype())&&"galactic"!==this.params.wcssys&&"ecliptic"!==this.params.wcssys&&(c.ra*=15)),"string"===typeof c.dec&&(c.dec=a.saostrtod(c.dec)),f=a.wcs2pix(this.raw.wcs,c.ra,c.dec).trim().split(/ +/),g&&(this.setWCSSys(g),a.globalOpts.xeqPlugins=e),f=this.imageToDisplayPos({x:parseFloat(f[0]),y:parseFloat(f[1])}),n.left=f.x,n.top=f.y);void 0!==c.left&&(n.left=
c.left);void 0!==c.top&&(n.top=c.top);void 0===n.left&&!0!==c.noLeftTop&&(n.left=b&&void 0!==b.left?b.left:this.display.canvasjq.attr("width")/2-1);void 0===n.top&&!0!==c.noLeftTop&&(n.top=b&&void 0!==b.top?b.top:this.display.canvasjq.attr("height")/2-1+1);c.dx&&(n.left+=c.dx);c.dy&&(n.top-=c.dy);switch(c.shape){case "annulus":m.radii=[];if(void 0!==c.radii)if("string"===typeof c.radii)for(m.radii=c.radii.replace(/ /g,"").split(","),e=d=0;d<m.radii.length;d++)""!==m.radii[d]&&(c.sizeScale&&(m.radii[d]*=
c.sizeScale),m.radii[e++]=this.wcs2imlen(m.radii[d]));else{if(m.radii=c.radii,c.sizeScale)for(d=0;d<m.radii.length;d++)m.radii[d]*=c.sizeScale}else for(c.ireg&&a.SCALEIREG&&(a.notNull(c.iradius)&&(c.iradius/=h),a.notNull(c.oradius)&&(c.oradius/=h)),c.sizeScale&&(a.notNull(c.iradius)&&(c.iradius*=c.sizeScale),a.notNull(c.oradius)&&(c.oradius*=c.sizeScale)),h=(c.oradius-c.iradius)/c.nannuli,g=c.nannuli+1,d=0;d<g;d++)e=c.iradius+h*d,c.sizeScale&&(e*=c.sizeScale),m.radii.push(e);break;case "box":c.ireg&&
a.SCALEIREG&&(a.notNull(c.width)&&(c.width/=h),a.notNull(c.height)&&(c.height/=h));c.sizeScale&&(a.notNull(c.width)&&(c.width*=c.sizeScale),a.notNull(c.height)&&(c.height*=c.sizeScale));break;case "circle":c.ireg&&a.SCALEIREG&&a.notNull(c.radius)&&(c.radius/=h);c.sizeScale&&a.notNull(c.radius)&&(c.radius*=c.sizeScale);break;case "ellipse":c.ireg&&a.SCALEIREG&&(a.notNull(c.r1)&&(c.r1/=h),a.notNull(c.r2)&&(c.r2/=h));c.sizeScale&&(a.notNull(c.r1)&&(c.r1*=c.sizeScale),a.notNull(c.r2)&&(c.r2*=c.sizeScale));
break;case "point":switch(c.ptshape){case "box":c.width=2*c.ptsize;c.height=2*c.ptsize;break;case "circle":c.radius=c.ptsize;break;case "ellipse":c.rx=c.ptsize,c.ry=c.ptsize/2}c.lockRotation=!0;c.lockScalingX=!0;c.lockScalingY=!0;c.lockUniScaling=!0;c.hasControls=!1;c.hasRotatingPoint=!1;c.hasBorders=!0;break;case "line":case "polygon":if(void 0!==c.wcspts&&0<this.raw.wcs){c.pts=[];c.wcssys&&(g=this.getWCSSys(),e=a.globalOpts.xeqPlugins,a.globalOpts.xeqPlugins=!1,this.setWCSSys(c.wcssys));for(d=0;d<
c.wcspts.length;d++)f=a.wcs2pix(this.raw.wcs,c.wcspts[d].ra,c.wcspts[d].dec).trim().split(/ +/),c.pts.push({x:parseFloat(f[0]),y:parseFloat(f[1])});g&&(this.setWCSSys(g),a.globalOpts.xeqPlugins=e)}if(c.pts&&c.pts.length){if("string"===typeof c.pts){f=c.pts.replace(/ /g,"").split(",");g=f.length;if("string"===typeof f[0])for(d=0;d<g;d++)f[d]=parseFloat(f[d]);c.pts=[];for(e=d=0;d<g;d+=2,e++)c.pts[e]={x:f[d],y:f[d+1]}}g=c.pts.length;for(d=0;d<g;d++)c.pts[d]=this.imageToDisplayPos(c.pts[d]);c.left&&c.top?
e={x:c.left,y:c.top}:(e=a.centerPolygon(c.pts),n.left=e.x,n.top=e.y);c.points=[];for(d=0;d<g;d++)f={x:(c.pts[d].x-e.x)/h,y:(c.pts[d].y-e.y)/h},c.points.push(f)}else b&&b.points&&b.points.length||("polygon"===c.shape&&c.polypoints?c.points=c.polypoints:"line"===c.shape&&c.linepoints&&(c.points=c.linepoints));if(c.ireg&&a.SCALEIREG)for(g=c.points.length,d=0;d<g;d++)c.points[d].x/=h,c.points[d].y/=h}for(k in c)if(c.hasOwnProperty(k))switch(k){case "tags":case "x":case "y":case "px":case "py":case "dx":case "dy":case "ra":case "dec":case "pts":case "left":case "top":case "angle":case "radii":case "ireg":break;
case "type":case "originX":case "originY":case "width":case "height":case "scaleX":case "scaleY":case "flipX":case "flipY":case "opacity":case "cornerSize":case "transparentCorners":case "hoverCursor":case "padding":case "borderColor":case "cornerColor":case "centeredScaling":case "centeredRotation":case "fill":case "fillRule":case "backgroundColor":case "stroke":case "strokeWidth":case "strokeDashArray":case "strokeLineCap":case "strokeLineJoin":case "strokeMiterLimit":case "shadow":case "borderOpacityWhenMoving":case "borderScaleFactor":case "borderDashArray":case "transformMatrix":case "minScaleLimit":case "selectable":case "evented":case "visible":case "hasControls":case "hasBorders":case "hasRotatingPoint":case "rotatingPointOffset":case "perPixelTargetFind":case "includeDefaultValues":case "clipTo":case "lockMovementX":case "lockMovementY":case "lockRotation":case "lockScalingX":case "lockScalingY":case "lockUniScaling":case "send":case "radius":case "rx":case "ry":case "points":case "selectionLineWidth":case "fontFamily":case "fontSize":case "fontStyle":case "fontWeight":case "text":case "textDecoration":case "textAlign":case "lineHeight":case "textBackgroundColor":case "textOpts":n[k]=
c[k];break;case "shape":l=c[k];break;default:m[k]=c[k]}if(!(c=m.color||n.stroke)){c=m.tags;k=m.tagcolors;var r,q;k=k||{};for(r in k)if(k.hasOwnProperty(r)&&(d=r.split("_"),0===$(c).not(d).length&&0===$(d).not(c).length)){q=k[r];break}if(!q)for(r in k)if(k.hasOwnProperty(r)&&(d=r.split("_"),0===$(c).not(d).length)){q=k[r];break}if(!q)for(r in k)if(k.hasOwnProperty(r)&&(d=r.split("_"),0===$(d).not(c).length)){q=k[r];break}c=q=q||b&&b.get("stroke")||k.defcolor||a.globalOpts.defcolor||"#000000"}n.stroke=
c;n.selectColor=n.stroke;if(!0===a.globalOpts.controlsMatchRegion||"corner"===a.globalOpts.controlsMatchRegion)n.cornerColor=n.stroke;if(!0===a.globalOpts.controlsMatchRegion||"border"===a.globalOpts.controlsMatchRegion)n.borderColor=n.stroke;void 0===m.changeable&&void 0!==m.fixinplace&&(m.changeable=!m.fixinplace);void 0!==m.changeable&&(b=!m.changeable,n.lockMovementX=b,n.lockMovementY=b,n.lockRotation=b,n.lockScalingX=b,n.lockScalingY=b,n.hasControls=!b,n.hasRotatingPoint=!b,n.hasBorders=!b);
void 0!==m.movable&&(b=!m.movable,n.lockMovementX=b,n.lockMovementY=b);void 0!==m.resizable&&(b=m.resizable,n.hasControls=b,n.hasBorders=b);void 0!==m.rotatable&&(b=!m.rotatable,void 0===n.lockRotation&&(n.lockRotation=b,n.hasRotatingPoint=!b));return{shape:l,opts:n,params:m}};a.Fabric._exportShapeOptions=function(a){return"object"!==typeof a?[]:Object.keys(a).filter(function(c){switch(c){case "top":case "left":case "width":case "height":case "radius":case "rx":case "ry":case "angle":case "panzoom":case "iradius":case "oradius":case "nannuli":case "aradius1":case "aradius2":case "configURL":case "sortOverlapping":case "tagcolors":case "pts":case "ptshape":case "ptsize":case "linepoints":case "polypoints":case "responseType":case "display":case "tags":case "r1":case "r2":case "x":case "y":case "dx":case "dy":case "px":case "py":case "shape":case "parent":case "rtn":case "_wcssys":case "file":return!1;
case "text":return"text"===a.shape?!1:!0;default:return!0}})};a.Fabric._handleChildText=function(d,c,b){var e,f,g;if("regions"===d)if(b=b||{},"text"!==c.params.shape&&b.text&&(!c.params.children||!c.params.children.length)){f=c.height*c.scaleX/2-12;f=1E-6>Math.abs(c.angle)?{x:c.left,y:c.top-f}:a.rotatePoint({x:c.left,y:c.top-f},c.angle,{x:c.left,y:c.top});g=this.displayToImagePos(f);f={x:g.x,y:g.y,angle:-c.angle,color:c.stroke,text:b.text,parent:"TBD",rtn:"object"};b.textOpts&&(f=$.extend(!0,{},f,
b.textOpts));e=a.Fabric.addShapes.call(this,d,"text",f);e.params.parent={id:c.params.id,obj:c,dleft:c.left-e.left,dtop:c.top-e.top,lastscalex:c.scaleX,lastscaley:c.scaleY,lastangle:c.angle,textheight:12};a.Fabric._updateShape.call(this,d,e,null,"child",e.params);void 0!==b.strokeWidth&&(e.params.parent.strokeWidth=b.strokeWidth);if(g.x!==f.x||g.y!==f.y)e.params.parent.moved=!0;b.textOpts&&void 0!==b.textOpts.ra&&void 0!==b.textOpts.dec&&(e.params.hasTextOpts=!0);c.params.children.push({id:e.params.id,
obj:e});a.Fabric._updateShape.call(this,d,c,null,"addchild",c.params)}else if(c.params.children&&(b.text||b.textOpts))for(e=0;e<c.params.children.length;e++)g=c.params.children[e].obj,f=$.extend(!0,{},b.textOpts||{}),b.text&&(f.text=b.text),this.changeShapes(d,g.params.id,f)};a.Fabric.addShapes=function(d,c,b){var e,f,g,h,k,l,n,m,r,q={},t=[],u=[];if(!(0<=$.inArray("regions",this.params.disable)&&"regions"===d)){if("string"===typeof b)try{b=JSON.parse(b)}catch(v){a.error("can't parse shape opts: "+
b,v)}b=b||{};if(this.display.image!==this)this.delayedShapes=this.delayedShapes||[],this.delayedShapes.push({layer:d,shape:c,opts:b});else if((l=this.getShapeLayer(d))&&l.show){n=l.canvas;m="main"===this.display.layers[d].dtype?this.rgb.sect.zoom:1;if("string"===typeof c)e=this.parseRegions(c,b),c="string"===typeof e?[{shape:e}]:e;else if(!$.isArray(c))if("object"===typeof c)c=[c];else return;if(!n.size()){if("main"===this.display.layers[d].dtype)switch(d){case a.Crosshair.LAYERNAME:case a.Grid.LAYERNAME:l.zindex=
1;break;default:l.zindex=this.zlayer++}else l.zindex=a.SHAPEZINDEX;g=this.display.layers[d];g.divjq.css("z-index",l.zindex);this.xeqPlugins("shape","onshapelayercreate",d)}h=$.extend(!0,{},a.Fabric.opts,l.opts,b);for(g=0;g<c.length;g++){k=$.extend(!0,{},h,c[g]);f=a.Fabric._parseShapeOptions.call(this,d,k);if(f.remove){if(!0===f.remove||"true"===f.remove)f.remove="all";if(!1!==f.remove&&"false"!==f.remove){this.removeShapes(d,f.remove);continue}}if(f.shape){k=f.opts;q=f.params;void 0===q.id&&(q.id=
++l.nshape);q.exports=a.Fabric._exportShapeOptions.call(this,b).concat(a.Fabric._exportShapeOptions.call(this,c[g]));q.parent=null;q.children=[];k.stroke&&(k.color=k.stroke,k.stroke=a.colorToHex(k.stroke));switch(f.shape){case "annulus":q.shape="annulus";f=k.top;r=k.left;k.top=0;k.left=0;if(q.radii)for(e=0;e<q.radii.length;e++)k.radius=q.radii[e],t.push(new fabric.Circle(k));k.top=f;k.left=r;k.width=2*k.radius;k.height=2*k.radius;e=new fabric.Group(t,k);break;case "box":q.shape="box";e=new fabric.Rect(k);
break;case "circle":q.shape="circle";e=new fabric.Circle(k);break;case "ellipse":q.shape="ellipse";k.rx=q.r1;k.ry=q.r2;e=new fabric.Ellipse(k);break;case "point":q.shape="point";switch(q.ptshape){case "box":e=new fabric.Rect(k);break;case "circle":e=new fabric.Circle(k);break;case "ellipse":e=new fabric.Ellipse(k);break;default:e=new fabric.Rect(k)}break;case "line":q.shape="line";e=new fabric.Polyline(k.points,k);break;case "polygon":q.shape="polygon";e=new fabric.Polygon(k.points,k,!0);break;case "text":q.shape=
"text";q.text=k.text||"Double-click to add text here";k.fill=k.stroke;k.strokeWidth=0;e=new fabric.Text(q.text,k);break;default:a.error("unknown shape: "+f.shape)}n.add(e);q.layerName=d;q.sw1=Math.max(1,Math.floor(e.strokeWidth+.5));q.listonchange=!1;e.params=q;if(l.opts.panzoom)switch(q.shape){case "point":case "text":break;default:e.scale(m)}e.rescaleBorder();a.Fabric._handleChildText.call(this,d,e,k);"TBD"!==b.parent&&a.Fabric._updateShape.call(this,d,e,null,"add",q);if(b.onaddshapes&&e.pub)try{a.xeqByName(b.onaddshapes,
this,this,e.pub)}catch(v){a.error("in onaddshapes callback",v,!1)}u.push(e)}}(void 0===q.redraw||q.redraw)&&n.renderAll();return"object"===b.rtn?e:"objs"===b.rtn?u:q.id}}};a.Fabric.selectShapes=function(d,c,b){var e,f,g,h,k,l;if(!this.layers||!d||!this.layers[d])return null;c=c||"all";"string"===typeof c&&/^[1-9]\d*$/.test(c)&&(c=parseInt(c,10));g=this.layers[d].canvas;f=1===fabric.major_version?g.getActiveGroup():(d=g.getActiveObject())&&"activeSelection"===d.type?d:null;d={group:null};switch(typeof c){case "object":c.params&&
(f&&f.contains(c)&&(d.group=f),b.call(this,c,d));break;case "number":g=g.getObjects();for(h=g.length;h--;)k=g[h],k.params&&c===k.params.id&&(f&&f.contains(k)?d.group=f:d.group=null,b.call(this,k,d));break;case "string":if("selected"===c)if(1===fabric.major_version)if(g.getActiveObject())c=g.getActiveObject(),c.params&&(d.group=null,b.call(this,c,d));else{if(f)for(d.group=f,g=f.getObjects(),h=g.length;h--;)k=g[h],k.params&&!k.params.parent&&b.call(this,k,d)}else for(d.group=f,g=g.getActiveObjects(),
h=g.length;h--;)k=g[h],k.params&&!k.params.parent&&b.call(this,k,d);else for(g=g.getObjects(),h=g.length;h--;)if(k=g[h],k.params&&(!k.params.parent||"child"===c||"All"===c)&&("child"!==c||k.params.parent))if(e=k.stroke.toLowerCase(),f&&f.contains(k)?d.group=f:d.group=null,"all"===c.toLowerCase())b.call(this,k,d);else if(c.toLowerCase()===e||a.colorToHex(c).toLowerCase()===e)b.call(this,k,d);else if(c===k.params.shape)b.call(this,k,d);else if(c===k.params.file)b.call(this,k,d);else if("child"===c&&
k.params.parent)b.call(this,k,d);else if("parent"===c&&k.params.children&&k.params.children.length)b.call(this,k,d);else if(k.params.tags)for(e=0;e<k.params.tags.length;e++)l=k.params.tags[e],c.match(/^\/.*\/$/)&&l.match(new RegExp(c.slice(1,-1)))?b.call(this,k,d):c===l&&b.call(this,k,d)}return this};a.Fabric.updateShapes=function(d,c,b,e){var f=this;this.selectShapes(d,c,function(c,h){a.Fabric._updateShape.call(f,d,c,h,b,e)});return this};a.Fabric._updateShape=function(d,c,b,e,f){var g,h,k,l,n,m,
r,q,t,u,v,p={},w=this.layers[d];m=function(a){return a.toFixed(2)};b=b||{};f=f||{};e=e||"update";k="main"===this.display.layers[d].dtype?this.rgb.sect.zoom:1;p.mode=e;p.id=c.params.id;p.shape=c.params.shape;p.layer=d;p.color=c.color||c.stroke;p.tags=c.params.tags;p.parent=c.params.parent?c.params.parent.obj.params.id:null;p.child=c.params.children&&c.params.children.length?c.params.children[0].id:null;r=c.getCenterPoint();b.group&&(h=b.group.getCenterPoint(),r={x:r.x+h.x,y:r.y+h.y},b.group.angle&&
(r=a.rotatePoint(r,b.group.angle,h)));r=this.displayToImagePos(r);p.x=r.x;p.y=r.y;p.lcs=this.imageToLogicalPos(r);"image"===this.params.wcssys?(p.imsys="image",l=p.x,n=p.y,u=1):(p.imsys=p.lcs.sys,l=p.lcs.x,n=p.lcs.y,u=this.lcs.physical.reverse[0][0]);p.angle=-c.angle;b.group&&(p.angle-=b.group.angle);v=p.angle;this.raw.wcsinfo&&this.raw.wcsinfo.crot&&(p.angle-=this.raw.wcsinfo.crot);for(;0>p.angle;)p.angle+=360;for(;360<p.angle;)p.angle-=360;h=c.scaleX/k;k=c.scaleY/k;b.group&&(h*=b.group.scaleX,k*=
b.group.scaleY);switch(p.shape){case "annulus":p.shape="annulus";p.radii=[];"image"!==p.imsys&&(p.lcs.radii=[]);p.imstr="annulus("+m(l)+", "+m(n)+", ";t="annulus "+p.x+" "+p.y+" ";v=c.getObjects();k=v.length;for(b=0;b<k;b++)l=v[b].radius*h,q=l*u,p.imstr+=m(q),t+=p.x+" "+p.y+" "+(p.x+l)+" "+p.y+" ",p.imstr=b===k-1?p.imstr+")":p.imstr+", ",p.radii.push(l),"image"!==p.imsys&&p.lcs.radii.push(q);break;case "box":p.shape="box";p.width=c.width*h;p.height=c.height*k;q=p.width*u;t=p.height*u;"image"!==p.imsys&&
(p.lcs.width=q,p.lcs.height=t);p.imstr="box("+m(l)+", "+m(n)+", "+m(q)+", "+m(t)+", "+p.angle.toFixed(4)+")";t="box "+p.x+" "+p.y+" "+p.x+" "+p.y+" "+(p.x+p.width)+" "+p.y+" "+p.x+" "+p.y+" "+p.x+" "+(p.y+p.height)+" "+p.angle*Math.PI/180;break;case "circle":p.radius=c.radius*h;q=p.radius*u;"image"!==p.imsys&&(p.lcs.radius=q);p.imstr="circle("+m(l)+", "+m(n)+", "+m(q)+")";t="circle "+p.x+" "+p.y+" "+p.x+" "+p.y+" "+(p.x+p.radius)+" "+p.y;break;case "ellipse":p.r1=c.width*h/2;p.r2=c.height*k/2;q=p.r1*
u;t=p.r2*u;"image"!==p.imsys&&(p.lcs.r1=q,p.lcs.r2=t);p.imstr="ellipse("+m(l)+", "+m(n)+", "+m(q)+", "+m(t)+", "+p.angle.toFixed(4)+")";t="ellipse "+p.x+" "+p.y+" "+p.x+" "+p.y+" "+(p.x+p.r1)+" "+p.y+" "+p.x+" "+p.y+" "+p.x+" "+(p.y+p.r2)+" "+p.angle*Math.PI/180;break;case "point":p.width=c.width*h;p.height=c.height*k;q=p.width*u;t=p.height*u;"image"!==p.imsys&&(p.lcs.width=q,p.lcs.height=t);p.imstr="point("+m(l)+", "+m(n)+")";t="point "+p.x+" "+p.y;break;case "line":case "polygon":p.imstr=p.shape+
"(";t=p.shape+" ";p.pts=[];"image"!==p.imsys&&(p.lcs.pts=[]);for(b=0;b<c.points.length;b++)0<b&&(p.imstr+=", ",t+=" "),u={x:p.x+c.points[b].x*h,y:p.y-c.points[b].y*k},u=a.rotatePoint(u,v,{x:p.x,y:p.y}),"image"===this.params.wcssys?p.imstr+=m(u.x)+", "+m(u.y):(l=this.imageToLogicalPos(u),p.imstr+=m(l.x)+", "+m(l.y),p.lcs.pts.push({x:l.x,y:l.y})),t+=u.x+" "+u.y,p.pts.push(u),"line"===p.shape&&(0===b?q=0:(l=p.pts[b-1],q+=Math.sqrt((u.x-l.x)*(u.x-l.x)+(u.y-l.y)*(u.y-l.y))));"line"===p.shape&&a.notNull(q)?
p.imstr+=') {"size":'+m(q)+',"units":"pixels"}':p.imstr+=")";p.angle=0;break;case "text":p.imstr="text("+m(l)+", "+m(n)+', "'+c.text+'", '+p.angle.toFixed(4)+")",t="text "+p.x+" "+p.y+' "'+c.text+'" '+p.angle*Math.PI/180,p.text=c.text}if(this.raw.wcs&&0<this.raw.wcs&&(g=a.pix2wcs(this.raw.wcs,r.x,r.y).trim().split(/\s+/),p.rastr=g[0],p.decstr=g[1],p.wcssys=g[2],m=a.strtoscaled(g[0]),":"===m.dtype&&"galactic"!==g[2]&&"ecliptic"!==g[2]&&(m.dval*=15),r=a.strtoscaled(g[1]),p.ra=m.dval,p.dec=r.dval,!1!==
f.updateWCS&&(f.updateWCS||w.opts.updateWCS))){p.wcsstr=a.reg2wcs(this.raw.wcs,t).replace(/;$/,"");g=p.wcsstr.replace(/.*\(/,"").replace(/\).*/,"").split(",");for(b=0;b<g.length;b++)g[b]=g[b].trim();p.wcsposstr=[g[0],g[1]];switch(p.shape){case "annulus":p.wcssizestr=[g[g.length-1]];break;case "box":p.wcssizestr=[g[2],g[3]];break;case "circle":p.wcssizestr=[g[2]];break;case "ellipse":p.wcssizestr=[g[2],g[3]];break;case "line":case "polygon":for(p.wcspts=[],b=0;b<g.length;b+=2)m=a.strtoscaled(g[b]),
":"===m.dtype&&"galactic"!==p.wcssys&&"ecliptic"!==p.wcssys&&(m.dval*=15),r=a.strtoscaled(g[b+1]),p.wcspts.push({ra:m.dval,dec:r.dval})}}p.data=c.params.data;c.set("pub",p);c.params.winid&&($(c.params.winid).is(":visible")?a.Regions.initConfigForm.call(this,c):c.params.winid=null);if(f.nocb)return p;if(!c.params.parent&&"child"!==e&&"move"!==e&&"mouseout"!==e){if(this.params.xeqonchange&&w.show&&w.opts.onchange)try{this.params.xeqonchange=!1,a.xeqByName(w.opts.onchange,window,this,p)}catch(x){a.log("error in onchange: %s [%s]\n%s",
this.id,x.message,a.strace(x))}finally{this.params.xeqonchange=!0}this.xeqPlugins("shape","on"+d+"change",p)}if("regions"===d&&a.globalOpts.regionsToClipboard){switch(e){case "add":case "select":case "update":b=p.parent||p.id;break;default:b=null}if(a.notNull(b)){try{g=this.listRegions(b,{mode:1})}catch(x){g=null}g&&(a.clipboard=g)}}return p};a.Fabric.removeShapes=function(d,c,b){var e=[],f=this;if(b=this.getShapeLayer(d)){b=b.canvas;"regions"===d&&a.globalOpts.unremoveReg&&(this.regstack.push(this.listRegions(c,
{mode:1},d)),this.regstack.length>a.globalOpts.unremoveReg&&(this.regstack=this.regstack.slice(0,a.globalOpts.unremoveReg)));this.selectShapes(d,c,function(b,c){var g,h;if(!1!==b.params.removable){a.Fabric._updateShape.call(f,d,b,c,"remove");b.params.winid&&b.params.winid.close();if(b.params.parent)for(h=b.params.parent.obj,g=h.params.children.length-1;0<=g;g--)if(b===h.params.children[g].obj){h.params.children.splice(g,1);break}for(g=0;g<b.params.children.length;g++)h=b.params.children[g].obj,e.push(h);
e.push(b)}});for(c=0;c<e.length;c++)b.remove(e[c]);1===fabric.major_version?b.getActiveGroup()&&b.discardActiveGroup():b.discardActiveObject();b.renderAll();return this}};a.Fabric.getShapes=function(d,c,b){var e={},f=[];if("string"===typeof b)try{b=JSON.parse(b)}catch(g){a.error("can't parse getShapes opts: "+b,g)}b=b||{};if("regions"===d&&"text"===b.format)return this.listRegions(c,{mode:b.mode||1});this.selectShapes(d,c,function(a){e=a.pub||{};b.includeObj&&(e.obj=a);f.push(e)});return f};a.Fabric.changeShapes=
function(d,c,b){var e,f,g,h,k,l,n,m,r,q,t,u,v=[],p=this;if((k=this.getShapeLayer(d))&&b){if("string"===typeof b)try{b=JSON.parse(b)}catch(w){a.error("can't parse shape opts: "+b,w)}l=k.canvas;t="main"===this.display.layers[d].dtype?this.rgb.sect.zoom:1;n=l.getActiveObject();this.selectShapes(d,c,function(c,x){b.radii&&(c.params.radii=[]);h=$.extend(!0,{},c.params,b);g=a.Fabric._parseShapeOptions.call(this,d,h,c);if(g.remove){if(!0===g.remove||"true"===g.remove)g.remove="all";if(!1!==g.remove&&"false"!==
g.remove){this.removeShapes(d,g.remove||"all");return}}if(g.opts.send)switch(g.opts.send){case "front":l.sendToFront(n);l.discardActiveObject();break;case "back":l.sendToBack(n),l.discardActiveObject()}u=a.Fabric._exportShapeOptions.call(this,b).filter(function(a){return!c.params.exports.hasOwnProperty(a)});g.params.exports=c.params.exports.concat(u);g.opts.stroke&&(g.opts.color=g.opts.stroke,g.opts.stroke=a.colorToHex(g.opts.stroke));switch(c.params.shape){case "text":g.opts.stroke&&(g.opts.fill=
g.opts.stroke),g.opts.strokeWidth=0}c.set(g.opts);c.params=$.extend(!1,{},c.params,g.params);b.strokeWidth&&(c.params.sw1=b.strokeWidth);switch(c.params.shape){case "annulus":if(b.radii&&b.radii.length){r=c.get("stroke");c.forEachObject(function(a){v.push(a)});m=v.length;for(e=0;e<m;e++)c.remove(v[e]),l.remove(v[e]);m=c.params.radii.length;for(e=q=0;e<m;e++)f=new fabric.Circle({radius:c.params.radii[e],stroke:r}),q=Math.max(q,c.params.radii[e]),c.add(f);c.scaleX=t;c.scaleY=t;c.width=2*q;c.height=
2*q;n===c&&l.setActiveObject(c)}break;case "box":b.width&&(c.scaleX=t);b.height&&(c.scaleY=t);break;case "circle":b.radius&&(c.scaleX=t,c.scaleY=t);break;case "ellipse":b.r1&&(c.rx=c.params.r1,c.scaleX=t,c.width=2*c.rx);b.r2&&(c.ry=c.params.r2,c.scaleY=t,c.height=2*c.ry);break;case "line":case "polygon":if(b.points&&b.points.length||b.pts&&b.pts.length)c.scaleX=t,c.scaleY=t;n===c&&(a.Fabric.removePolygonAnchors(k.dlayer,c),a.Fabric.addPolygonAnchors(k.dlayer,c));a.resetPolygonCenter(c);break;case "text":b.text&&
(c.params.text=b.text)}c.rescaleBorder();a.Fabric.updateChildren(k.dlayer,c,"moving");a.Fabric.updateChildren(k.dlayer,c,"scaling");a.Fabric.updateChildren(k.dlayer,c,"rotating");a.Fabric.updateChildren(k.dlayer,c,"deltas");c.setCoords();a.Fabric._handleChildText.call(p,d,c,b);a.Fabric._updateShape.call(p,d,c,x,"update");if(b.onchangeshapes&&c.pub)try{a.xeqByName(b.onchangeshapes,this,this,c.pub)}catch(A){a.error("in onchangeshapes callback",A,!1)}});(void 0===b.redraw||b.redraw)&&l.renderAll();return this}};
a.Fabric.refreshShapes=function(d){var c,b,e,f,g,h,k,l,n=!1,m=this,r=this.raw.wcs;if(l=this.getShapeLayer(d))return"main"===this.display.layers[d].dtype&&(n=!0),n?(b=this.binning.bin,e=this.rgb.sect.zoom,f=this.binning.obin/this.rgb.sect.ozoom*e/b,g=this.binning.obin/this.rgb.sect.ozoom*e/b):(b=1,g=f=e=this.rgb.sect.zoom),b=l.canvas,1===fabric.major_version?b.getActiveGroup()&&b.discardActiveGroup():b.discardActiveObject(),c=b.getActiveObject(),this.selectShapes(d,"all",function(b){var d,e,q,p;0<
r&&b.pub.ra&&b.pub.dec?("string"===typeof b.pub.ra&&(b.pub.ra=a.saostrtod(b.pub.ra),":"===String.fromCharCode(a.saodtype())&&"galactic"!==this.params.wcssys&&"ecliptic"!==this.params.wcssys&&(b.pub.ra*=15)),"string"===typeof b.pub.dec&&(b.pub.dec=a.saostrtod(b.pub.dec)),e=a.wcs2pix(r,b.pub.ra,b.pub.dec).trim().split(/ +/),e=this.imageToDisplayPos({x:parseFloat(e[0]),y:parseFloat(e[1])})):e=m.logicalToDisplayPos(b.pub.lcs);b.set("left",e.x);b.set("top",e.y);if("box"===b.params.shape||"ellipse"===b.params.shape||
"text"===b.params.shape&&!b.params.parent)m.raw.wcsinfo&&m.raw.wcsinfo.crot?b.set("angle",-(b.pub.angle+m.raw.wcsinfo.crot)):b.set("angle",-b.pub.angle);if(!1!==b.params.zoomable)switch(b.params.shape){case "point":case "text":break;default:if(h=f,k=g,n&&(h*=b.scaleX,k*=b.scaleY),b.scaleX=h,b.scaleY=k,b.rescaleBorder(),b.points)if(q=b.getCenterPoint(),0<r&&b.pub.wcspts)for(p=b.pub.wcspts,d=0;d<p.length;d++)e=a.wcs2pix(r,p[d].ra,p[d].dec).trim().split(/ +/),e=this.imageToDisplayPos({x:parseFloat(e[0]),
y:parseFloat(e[1])}),b.angle&&(e=a.rotatePoint(e,-b.angle,q)),b.points[d]={x:(e.x-q.x)/b.scaleX,y:(e.y-q.y)/b.scaleY};else if(b.pub.lcs.pts)for(p=b.pub.lcs.pts,d=0;d<p.length;d++)e=m.logicalToDisplayPos(b.pub.lcs.pts[d]),b.angle&&(e=a.rotatePoint(e,-b.angle,q)),b.points[d]={x:(e.x-q.x)/b.scaleX,y:(e.y-q.y)/b.scaleY}}b.setCoords();switch(b.type){case "polyline":case "polygon":c===b&&(a.Fabric.removePolygonAnchors(l.dlayer,b),a.Fabric.addPolygonAnchors(l.dlayer,b))}a.Fabric.updateChildren(l.dlayer,
b,"moving");a.Fabric.updateChildren(l.dlayer,b,"scaling");a.Fabric.updateChildren(l.dlayer,b,"rotating")}),b&&b.renderAll(),this};a.Fabric.addPolygonPoint=function(d,c,b){var e,f,g,h,k,l,n,m,r,q,t,u=Number.MAX_VALUE,v,p,w,x;if(c&&c.points){b=a.eventToDisplayPos(b);n=c.getCenterPoint().x;l=c.getCenterPoint().y;n=(b.x-n)/c.get("scaleX");v=(b.y-l)/c.get("scaleY");for(l=-c.get("angle")*Math.PI/180;l>2*Math.PI;)l-=2*Math.PI;b=Math.cos(l)*n-Math.sin(l)*v;v=Math.sin(l)*n+Math.cos(l)*v;n=c.points;for(l=0;l<
n.length;l++)k=n[l],f=n[(l+1)%n.length],m=k.x<f.x?k.x:f.x,r=k.y<f.y?k.y:f.y,q=k.x>f.x?k.x:f.x,t=k.y>f.y?k.y:f.y,e=k.x-f.x,k=k.y-f.y,g=Math.sqrt(e*e+k*k),0!==g&&(e/=g,k/=g),g=b-f.x,h=v-f.y,g=g*e+h*k,e=f.x+e*g,f=f.y+k*g,e<m?e=m:e>q&&(e=q),f<r?f=r:f>t&&(f=t),m=(e-b)*(e-b)+(f-v)*(f-v),m<u&&(u=m,p=e,w=f,x=l===n.length?0:l);d=this.getShapeLayer(d);a.Fabric.removePolygonAnchors(d.dlayer,c);n.splice(x+1,0,{x:p,y:w});if(1===fabric.major_version)d.canvas.setActiveObject(c);else{switch(c.type){case "polyline":case "polygon":a.Fabric.addPolygonAnchors(d.dlayer,
c),d.dlayer.canvas.renderAll()}c.polyparams?d.dlayer.params.sel=c.polyparams.polygon:c.params&&(d.dlayer.params.sel=c)}}};a.Fabric.removePolygonPoint=function(d,c){var b,e,f,g;c&&c.polyparams&&(e=c.polyparams.polygon,f=e.points,"polygon"===e.type&&3>=f.length||"polyline"===e.type&&2>=f.length||(g=c.polyparams.point,delete c.polyparams.point,b=this.getShapeLayer(d),a.Fabric.removePolygonAnchors(b.dlayer,e),f.splice(g,1),a.resetPolygonCenter(e),b.canvas.setActiveObject(e)))};a.Fabric.addPolygonAnchors=
function(d,c){var b,e,f={},g=d.canvas,h=function(){var b=this.polyparams.polygon,c=this.polyparams.point,e=b.get("points"),h=d.display.image;void 0!==c&&!1!==b.params.changeable&&(b.angle?f=a.rotatePoint({x:this.left,y:this.top},-b.angle,{x:b.left,y:b.top}):(f.x=this.left,f.y=this.top),e[c].x=(f.x-b.left)/b.scaleX,e[c].y=(f.y-b.top)/b.scaleY,a.resetPolygonCenter(b),a.Fabric._updateShape.call(h,b.params.layerName,b,null,"update"),h&&(h.params.listonchange||b.params.listonchange)&&h.listRegions(b,{mode:2}),
g.renderAll())},k=function(b){var c,d={};for(c=0;c<b.params.anchors.length;c++)d.x=b.left+b.points[c].x*b.scaleX,d.y=b.top+b.points[c].y*b.scaleY,b.angle&&(d=a.rotatePoint(d,b.angle,{x:b.left,y:b.top})),b.params.anchors[c].set({left:d.x,top:d.y,angle:b.angle}),b.params.anchors[c].setCoords();b._calcDimensions(!0);g.renderAll()};if(!c.params.anchors&&!1!==c.params.changeable){c.params.anchors=[];for(b=0;b<c.points.length;b++)f.x=c.left+c.points[b].x*c.scaleX,f.y=c.top+c.points[b].y*c.scaleY,c.angle&&
(f=a.rotatePoint(f,c.angle,c.getCenterPoint())),e=new fabric.Rect({left:f.x,top:f.y,hasControls:!1,hasRotatingPoint:!1,hasBorders:!1,selectable:!0,fill:c.get("stroke"),hoverCursor:"pointer",width:a.Fabric.opts.cornerSize+2,height:a.Fabric.opts.cornerSize+2,padding:2}),e.on("moving",h),e.polyparams={},e.polyparams.polygon=c,e.polyparams.point=b,c.params.anchors[b]=e,g.add(e);c.on("moving",function(){k(c)});c.on("rotating",function(){k(c)});c.on("scaling",function(){k(c)});c.setCoords()}};a.Fabric.removePolygonAnchors=
function(a,c){var b,d=a.canvas;if(c&&c.params&&c.params.anchors&&!1!==c.params.changeable){for(b=0;b<c.params.anchors.length;b++)d.remove(c.params.anchors[b]);delete c.params.anchors}};a.Fabric.updateChildren=function(d,c,b){var e,f,g,h,k,l;if("regions"===d.layerName)if("objects"===b)g={},d.canvas.getObjects().forEach(function(a){a.params&&(a.params.parent||a.params.children.length)&&(g[a.params.id]=a)}),d.canvas.getObjects().forEach(function(a){if(a.params)for(a.params.parent&&(a.params.parent.obj=
g[a.params.parent.id]),e=0;e<a.params.children.length;e++)a.params.children[e].obj=g[a.params.children[e].id]});else if(c&&c.params)if("deltas"===b)c.params.parent&&(f=c.params.parent,f.dleft=f.obj.left-c.left,f.dtop=f.obj.top-c.top,f.moved=!0);else for(e=0;e<c.params.children.length;e++){h=c.params.children[e].obj;f=h.params.parent;switch(b){case "moving":h.left=c.left-f.dleft;h.top=c.top-f.dtop;break;case "rotating":for(;0>c.angle;)c.angle+=360;for(;360<c.angle;)c.angle-=360;k=c.angle-f.lastangle;
l=a.rotatePoint({x:h.left,y:h.top},k,{x:c.left,y:c.top});h.left=l.x;h.top=l.y;f.dleft=c.left-h.left;f.dtop=c.top-h.top;for(h.angle+=k;0>h.angle;)h.angle+=360;for(;360<h.angle;)h.angle-=360;f.lastangle=c.angle;break;case "scaling":f.dleft*=c.scaleX/f.lastscalex,f.dtop=c.scaleY/f.lastscaley*(f.dtop-f.textheight)+f.textheight,f.lastscalex=c.scaleX,f.lastscaley=c.scaleY,f.moved=!0,h.left=c.left-f.dleft,h.top=c.top-f.dtop}h.setCoords();d.display.image&&d.display.image.updateShapes(d.layerName,h,"updatechild")}};
a.resetPolygonCenter=function(d){var c,b,e,f;f={};1===fabric.major_version?(d._calcDimensions(),b=(d.minX+d.width/2)*d.scaleX,c=(d.minY+d.height/2)*d.scaleY):(c=d._calcDimensions(),b=(c.left+c.width/2)*d.scaleX,c=(c.top+c.height/2)*d.scaleY);d.angle?f=a.rotatePoint({x:d.left+b,y:d.top+c},d.angle,{x:d.left,y:d.top}):(f.x=d.left+b,f.y=d.top+c);if(1<fabric.major_version||5<=fabric.minor_version)for(b/=d.scaleX,e=c/d.scaleY,c=0;c<d.points.length;c++)d.points[c].x-=b,d.points[c].y-=e;d.left=f.x;d.top=
f.y;1<fabric.major_version&&(f=d._calcDimensions(),d.width=f.width,d.height=f.height,d.pathOffset={x:f.left+d.width/2,y:f.top+d.height/2});d.setCoords()};a.Fabric.print=function(d){var c,b,e,f,g,h,k=0,l=sprintf("width=%s,height=%s,menubar=1,toolbar=1,status=0,scrollbars=1,resizable=1",this.display.canvasjq.attr("width"),this.display.canvasjq.attr("height"));if("string"===typeof d)try{d=JSON.parse(d)}catch(n){a.error("can't parse print opts: "+d,n)}d=d||{};f=this.display.canvas.toDataURL("image/png");
c="<html><body style='padding: 0px; margin: 0px' onload='window.print(); return false'>";g=sprintf("<div style='position:absolute; left:%spx; top:%spx'>",0,k);c+=sprintf("%s<img src='%s'></div>",g,f);for(b in this.layers)this.layers.hasOwnProperty(b)&&(f=this.layers[b],"main"===f.dlayer.dtype&&f.show&&(c+=sprintf("%s%s</div>",g,f.dlayer.canvas.toSVG())));(void 0===d.colorbar||d.colorbar)&&(d=this.display.pluginInstances.JS9Colorbar)&&d.isActive()&&(k+=2,f=d.colorbarjq[0].toDataURL("image/png"),k+=
this.display.height,g=sprintf("<div style='position:absolute; left:%spx; top:%spx'>",0,k),c+=sprintf("%s<img src='%s'></div>",g,f),d.textjq&&d.textjq[0]&&(f=d.textjq[0].toDataURL("image/png"),k+=d.colorbarjq.height()+1,g=sprintf("<div style='position:absolute; left:%spx; top:%spx'>",0,k),c+=sprintf("%s<img style='width:%spx;'src='%s'></div>",g,this.display.width,f)));c+="</body></html>";window.isElectron&&(h="data:text/html,<html><body><script>window.addEventListener('message', function(ev){document.documentElement.innerHTML=ev.data; window.setTimeout(function(){window.print()}, 250);},false)\x3c/script><p>waiting for image ...</body></html>");
(e=window.open(h,this.id,l))?e.document?(e.document.open(),e.document.write(c),e.document.close()):e.postMessage?window.setTimeout(function(){e.postMessage(c,"*")},250):a.error("no method available for drawing image into print window"):a.error("could not create print window (check your pop-up blockers)")};a.Fabric.initGraphics=function(){var d;a.Display.prototype.newShapeLayer=a.Fabric.newShapeLayer;a.Image.prototype.addShapes=a.Fabric.addShapes;a.Image.prototype.selectShapes=a.Fabric.selectShapes;
a.Image.prototype.updateShapes=a.Fabric.updateShapes;a.Image.prototype.updateShape=a.Fabric._updateShape;a.Image.prototype.getShapes=a.Fabric.getShapes;a.Image.prototype.changeShapes=a.Fabric.changeShapes;a.Image.prototype.removeShapes=a.Fabric.removeShapes;a.Image.prototype.refreshShapes=a.Fabric.refreshShapes;a.Image.prototype.getShapeLayer=a.Fabric.getShapeLayer;a.Image.prototype.showShapeLayer=a.Fabric.showShapeLayer;a.Image.prototype.activeShapeLayer=a.Fabric.activeShapeLayer;a.Image.prototype.displayShapeLayers=
a.Fabric.displayShapeLayers;a.Image.prototype.toggleShapeLayers=a.Fabric.toggleShapeLayers;a.Image.prototype.print=a.Fabric.print;for(d in a.Fabric.opts)a.Fabric.opts.hasOwnProperty(d)&&(fabric.Object.prototype[d]=a.Fabric.opts[d])};a.Fabric.initGraphics();a.MouseTouch={};a.MouseTouch.CLASS="JS9";a.MouseTouch.NAME="MouseTouch";a.MouseTouch.WIDTH=512;a.MouseTouch.HEIGHT=220;a.MouseTouch.BASE=a.MouseTouch.CLASS+a.MouseTouch.NAME;a.MouseTouch.mouseText=[];a.MouseTouch.mouseText[0]="move mouse, no buttons pressed:";
a.MouseTouch.mouseText[1]="move mouse, primary button pressed:";a.MouseTouch.mouseText[2]="move mouse, secondary button pressed:";a.MouseTouch.touchText=[];a.MouseTouch.touchText[0]="touch move, with one finger:";a.MouseTouch.touchText[1]="touch move, with two fingers:";a.MouseTouch.touchText[2]="touch move, with three fingers:";a.MouseTouch.textHTML="<div style='float: left'>%s</div>";a.MouseTouch.actionHTML="<div style='float: left'><b>%s</b></div>";a.MouseTouch.actionid=function(a,c){return(a+
"_"+c).replace(/[^A-Za-z0-9_]/g,"_")};a.MouseTouch.addText=function(d,c){var b;b=sprintf(a.MouseTouch.textHTML,c);return $("<div>").addClass(a.MouseTouch.BASE+"Text").html(b).appendTo(d)};a.MouseTouch.addAction=function(d,c,b){c=a.MouseTouch.actionid(c,b);b=sprintf(a.MouseTouch.actionHTML,b);return $("<div>").addClass(a.MouseTouch.BASE+"Action").attr("id",c).html(b).appendTo(d)};a.MouseTouch.isPinch=function(d,c){var b,e,f,g,h=a.globalOpts.pinchWait,k=a.globalOpts.pinchThresh;if(!d)return-1;e=d.display;
if(!e.mousetouchZoom||2!==d.pos.touches.length)return-1;switch(e.ispinch){case -1:case 1:return e.ispinch}b=Math.sqrt((d.pos.touches[0].x-d.pos.touches[1].x)*(d.pos.touches[0].x-d.pos.touches[1].x)+(d.pos.touches[0].y-d.pos.touches[1].y)*(d.pos.touches[0].y-d.pos.touches[1].y));e.dist0||(e.dist0=b);e.deltas.push(Math.floor(b-e.dist0));if(e.deltas.length>=h){b=1;for(g=f=0;b<h;b++)e.deltas[b]>e.deltas[b-1]?f++:e.deltas[b]<e.deltas[b-1]&&g++;e.ispinch=f>=k||g>=k?1:-1;e.lastzoom=0;return e.ispinch}return 0};
a.MouseTouch.Actions={};a.MouseTouch.Actions["display value/position"]=function(d,c,b){!a.specialKey(b)&&a.globalOpts.internalValPos&&d&&c&&0<c.x&&0<c.y&&c.x<d.raw.width&&c.y<d.raw.height&&(d.valpos=d.updateValpos(c,!0))};a.MouseTouch.Actions["change contrast/bias"]=function(d,c,b){var e=d.display;a.globalOpts.internalContrastBias&&d&&c&&!(d.pos0&&d.pos&&Math.abs(d.pos0.x-d.pos.x)<a.NOMOVE&&Math.abs(d.pos0.y-d.pos.y)<a.NOMOVE||d.clickInRegion||a.specialKey(b)||d.rgbFile)&&(b=a.eventToDisplayPos(b,
d.posOffset),c=Math.floor(b.x+.5),b=Math.floor(b.y+.5),a.globalOpts.containContrastBias&&(0>c||0>b||c>=e.canvas.width||b>=e.canvas.height)||(d.params.bias=c/e.canvas.width,d.params.contrast=b/e.canvas.height*10,a.bugs.firefox_linux?window.setTimeout(function(){d.displayImage("scaled",{blendMode:!1})},0):d.displayImage("scaled",{blendMode:!1}),d.xeqstash&&d.xeqstash.filterRGBImage&&delete d.xeqstash.filterRGBImage,a.globalOpts.extendedPlugins&&d.xeqPlugins("image","onchangecontrastbias")))};a.MouseTouch.Actions["change contrast/bias"].stop=
function(a,c,b){a.display.blendMode&&a.displayImage("rgb")};a.MouseTouch.Actions["wheel zoom"]=function(d,c){var b;d&&d.display.mousetouchZoom&&(b=0<c.originalEvent.deltaY?Math.min(a.MAXZOOM,d.getZoom()+a.ADDZOOM):Math.max(a.MINZOOM,d.getZoom()-a.ADDZOOM),b=Math.round(100*(b+1E-5))/100,d.setZoom(b))};a.MouseTouch.Actions["pan the image"]=function(a,c,b){var d;a&&(d=a.rgb.sect,c=(a.pos0.x-a.pos.x)/d.zoom,b=(a.pos0.y-a.pos.y)/d.zoom,1<=Math.abs(c)||1<=Math.abs(b))&&(a.setPan(d.xcen+c,d.ycen-b),a.pos0=
a.pos)};a.MouseTouch.Actions.pinch=function(d,c,b){d&&(c=d.display,b=c.zoom0*Math.sqrt((d.pos.touches[0].x-d.pos.touches[1].x)*(d.pos.touches[0].x-d.pos.touches[1].x)+(d.pos.touches[0].y-d.pos.touches[1].y)*(d.pos.touches[0].y-d.pos.touches[1].y))/c.dist0,b=Math.max(a.MINZOOM,Math.min(a.MAXZOOM,Math.round(100*(b+1E-5))/100)),b!==c.lastzoom&&d.setZoom(b),c.lastzoom=b)};a.MouseTouch.Actions.start=function(d,c,b){d&&(c=d.display,c.ispinch=0,c.dist0=0,c.zoom0=d.rgb.sect.zoom,c.deltas=[]);c=a.MouseTouch.getAction(d,
b);a.MouseTouch.Actions[c]&&a.MouseTouch.Actions[c].start&&a.MouseTouch.Actions[c].start(d,d.ipos,b)};a.MouseTouch.Actions.stop=function(d,c,b){c=a.MouseTouch.getAction(d,b);a.MouseTouch.Actions[c]&&a.MouseTouch.Actions[c].stop&&a.MouseTouch.Actions[c].stop(d,d.ipos,b)};a.MouseTouch.getAction=function(d,c){var b,e;if(!d)return b;e=d.display;switch(d.clickState){case 0:b=e.mouseActions[0];break;case 1:b=e.mouseActions[1];break;case 2:b=e.mouseActions[2];break;case -1:b=e.touchActions[0];break;case -2:switch(a.MouseTouch.isPinch(d,
c)){case -1:b=e.touchActions[1];break;case 1:b="pinch"}break;case -3:b=e.touchActions[2]}return b};a.MouseTouch.action=function(d,c,b){if((b=b||a.MouseTouch.getAction(d,c))&&a.MouseTouch.Actions[b])a.MouseTouch.Actions[b](d,d.ipos,c)};a.MouseTouch.mousetouchzoom=function(d,c){var b=a.lookupDisplay(d),e=c.checked;b&&(b.mousetouchZoom=e)};a.MouseTouch.init=function(){var d,c,b=this;this.divjq.html("");this.divjq.addClass("JS9PluginScrolling");this.mousetouchContainer=$("<div>").addClass(a.MouseTouch.BASE+
"Container").attr("id",this.id+"MouseTouchContainer").appendTo(this.divjq);c=sprintf("<div class='%s'><span><b>Drag an action to reconfigure JS9 mouse/touch events:</b></span><p>",a.MouseTouch.BASE+"Header");this.mousetouchHeadContainer=$("<span style='float: left'>").addClass(a.MouseTouch.BASE+"Container").attr("id",this.id+"MouseTouchHeadContainer").html(c).appendTo(this.mousetouchContainer);this.mousetouchTextContainer=$("<span style='float: left'>").addClass(a.MouseTouch.BASE+"Container").attr("id",
this.id+"MouseTouchTextContainer").appendTo(this.mousetouchContainer);this.mousetouchActionContainer=$("<span style='float: left'>").addClass(a.MouseTouch.BASE+"Container").attr("id",this.id+"MouseTouchActionContainer").appendTo(this.mousetouchContainer);if(a.TOUCHSUPPORTED){this.mousetouchTouchTextContainer=$("<div>").addClass(a.MouseTouch.BASE+"TextContainer").attr("id",this.id+"TouchTextContainer").html("").appendTo(this.mousetouchTextContainer);for(d=0;d<a.MouseTouch.touchText.length;d++)a.MouseTouch.addText.call(this,
this.mousetouchTouchTextContainer,a.MouseTouch.touchText[d]);for(d=a.MouseTouch.touchText.length;d<this.display.touchActions.length;d++)a.MouseTouch.addText.call(this,this.mousetouchMouseTextContainer,"&nbsp;");this.mousetouchTouchContainer=$("<div>").addClass(a.MouseTouch.BASE+"ActionContainer").attr("id",this.id+"TouchContainer").html("").appendTo(this.mousetouchActionContainer);for(d=0;d<this.display.touchActions.length;d++)c=this.display.touchActions[d],a.MouseTouch.addAction.call(this,this.mousetouchTouchContainer,
"touch",c);this.mousetouchTouchContainer.sortable({start:function(a,b){this.oidx=b.item.index()},stop:function(a,c){var d=c.item.index(),e=b.display.touchActions.splice(this.oidx,1)[0];b.display.touchActions.splice(d,0,e)}})}if(!/iPad|iPhone|iPod/.test(navigator.platform)){this.mousetouchMouseTextContainer=$("<div>").addClass(a.MouseTouch.BASE+"TextContainer").attr("id",this.id+"MouseTextContainer").appendTo(this.mousetouchTextContainer);for(d=0;3>d;d++)a.MouseTouch.addText.call(this,this.mousetouchMouseTextContainer,
a.MouseTouch.mouseText[d]);for(d=3;d<this.display.mouseActions.length;d++)a.MouseTouch.addText.call(this,this.mousetouchMouseTextContainer,"&nbsp;");this.mousetouchMouseContainer=$("<div>").addClass(a.MouseTouch.BASE+"ActionContainer").attr("id",this.id+"MouseContainer").html("").appendTo(this.mousetouchActionContainer);for(d=0;d<this.display.mouseActions.length;d++)c=this.display.mouseActions[d],a.MouseTouch.addAction.call(this,this.mousetouchMouseContainer,"mouse",c);this.mousetouchMouseContainer.sortable({start:function(a,
b){this.oidx=b.item.index()},stop:function(a,c){var d=c.item.index(),e=b.display.mouseActions.splice(this.oidx,1)[0];b.display.mouseActions.splice(d,0,e)}})}c=sprintf("<p><div class='%s'>use mouse wheel or pinch to zoom:&nbsp;&nbsp;<input type='checkbox' value='1' onclick='javascript:JS9.MouseTouch.mousetouchzoom(\"%s\", this);'></div>",a.MouseTouch.BASE+"Footer",this.display.id);this.mousetouchFootContainer=$("<span style='float: left'>").addClass(a.MouseTouch.BASE+"Container").attr("id",this.id+
"MouseTouchFootContainer").html(c).appendTo(this.mousetouchContainer);this.display.mousetouchZoom&&this.mousetouchContainer.find("input").attr("checked",!0)};a.Regions={};a.Regions.CLASS="JS9";a.Regions.NAME="Regions";a.Regions.opts={updateWCS:!0,panzoom:!0,tags:"source,include",strokeWidth:2,iradius:0,oradius:30,nannuli:10,width:60,height:60,radius:30,r1:30,r2:20,ptshape:"box",ptsize:2,linepoints:[{x:-30,y:30},{x:30,y:-30}],polypoints:[{x:-30,y:30},{x:30,y:30},{x:0,y:-30}],fontFamily:"Helvetica",
fontSize:14,fontStyle:"normal",fontWeight:300,textAlign:"left",angle:0,aradius1:4,aradius2:8,configURL:"./params/regionsconfig.html",sortOverlapping:!0,title:"Region Configuration",tagcolors:{include_source:"#00FF00",exclude_source:"#FF0000",include_background:"#FFD700",exclude_background:"#FF8C00",source:"#00FF00",background:"#FFD700",defcolor:"#00FF00"},onmousedown:function(d,c,b,e){var f;!a.specialKey(b)&&e.params&&(c=(new Date).getTime(),e.params.lasttime&&c-e.params.lasttime<a.DBLCLICK&&(f=!0),
e.params.lasttime=c);f?e.params.winid||!1===e.params.changeable||a.Regions.displayConfigForm.call(d,e):a.specialKey(b)&&("polygon"===e.type||"polyline"===e.type?(a.Fabric.addPolygonPoint.call(d,e.params.layerName,e,b),a.Fabric._updateShape.call(d,e.params.layerName,e,null,"update")):e.polyparams&&e.polyparams.polygon&&(b=e.polyparams.polygon,a.Fabric.removePolygonPoint.call(d,b.params.layerName,e),a.Fabric._updateShape.call(d,b.params.layerName,b,null,"update")))},onmouseup:function(){var a,c=[];
this.getActiveObject()&&c.push(this.getActiveObject());1===fabric.major_version?this.getActiveGroup()&&(c=this.getActiveGroup().getObjects()):c.push(this.getActiveObjects());for(a=0;a<c.length;a++)c[a].polyparams&&this.setActiveObject(c[a].polyparams.polygon)},onchange:null};a.Regions.init=function(d){var c;a.Image.prototype.parseRegions=a.Regions.parseRegions;a.Image.prototype.saveRegions=a.Regions.saveRegions;a.Image.prototype.listRegions=a.Regions.listRegions;a.Image.prototype.copyRegions=a.Regions.copyRegions;
a.Image.prototype.editRegionTags=a.Regions.editRegionTags;a.Image.prototype.toggleRegionTags=a.Regions.toggleRegionTags;a.Image.prototype.unremoveRegions=a.Regions.unremoveRegions;c=this.display.newShapeLayer(d||"regions",a.Regions.opts);c.canvas.on("mouse:up",function(){var a,d,f=[];if(c.display.image)for(d=c.display.image,1===fabric.major_version?(this.getActiveObject()&&f.push(this.getActiveObject()),this.getActiveGroup()&&(f=this.getActiveGroup().getObjects())):f.push(this.getActiveObjects()),
a=0;a<f.length;a++)if(f[a].params){d.params.listonchange?"all"===d.params.whichonchange?d.listRegions("all",{mode:2}):d.listRegions("selected",{mode:2}):f[a].params.listonchange&&d.listRegions("selected",{mode:2});break}});return this};a.Regions.displayConfigForm=function(d){var c,b=this,e=a.Regions.opts.title;d&&($("#dhtmlwindowholder").arrive("#regionsConfigForm",{onceOnly:!0},function(){d.pub&&a.Regions.initConfigForm.call(b,d)}),c=a.allinone?a.allinone.regionsConfigHTML:a.InstallDir(a.Regions.opts.configURL),
d.params.winid=b.displayAnalysis("regions",c,{title:e}))};a.Regions.initConfigForm=function(d){var c,b,e,f,g,h,k,l,n,m;n=d.params;m=n.winid;var r="#"+$(m).attr("id")+" #regionsConfigForm ",q=this,t=function(a){if(void 0!==a)return"number"===typeof a&&0!==a%1&&(a=Math.round(1E4*(a+1E-5))/1E4),String(a)},u=function(a){return(a||"").replace(/\n/g,"\\n")};b=$(r).data("wcssys");$(r+"."+d.pub.shape).each(function(){$(this).removeClass("nodisplay")});$(r+".val").each(function(){f="";e=$(this).attr("name");
switch(e){case "x":case "y":void 0!==d.pub.lcs&&void 0!==d.pub.lcs[e]?f=t(d.pub.lcs[e]):void 0!==d.pub[e]&&(f=t(d.pub[e]));break;case "radii":d.pub.radii&&(f="image"!==q.params.wcssys&&"physical"!==q.params.wcssys&&d.pub.wcsstr?d.pub.wcsstr.replace(/^annulus\(/,"").replace(/\)$/,"").split(",").slice(2).join(","):d.pub.imstr.replace(/^annulus\(/,"").replace(/\)$/,"").split(",").slice(2).join(","));break;case "pts":d.pub.pts?d.pub.pts.forEach(function(a){f&&(f+=", ");f+=sprintf("%s, %s",a.x.toFixed(2),
a.y.toFixed(2))}):d.pub.imstr&&(f=d.pub.imstr.replace(/^.*\(/,"").replace(/\)$/,""));break;case "fontFamily":d.getFontFamily&&(f=d.getFontFamily());break;case "fontSize":d.getFontSize&&(f=d.getFontSize());break;case "fontStyle":d.getFontStyle&&(f=d.getFontStyle());break;case "fontWeight":d.getFontWeight&&(f=d.getFontWeight());break;case "strokeWidth":f=d.params.sw1;break;case "strokeDashes":d.strokeDashArray?(f=d.strokeDashArray.join(" "),f.match(/NaN/)&&(f="")):f="";break;case "regstr":f="image"!==
q.params.wcssys&&"physical"!==q.params.wcssys&&d.pub.wcsstr?d.pub.wcssys+"; "+d.pub.wcsstr:d.pub.imsys+"; "+d.pub.imstr;break;case "xpos":switch(q.params.wcssys){case "image":f=sprintf("%.1f",d.pub.x);break;case "physical":f=d.pub.lcs?sprintf("%.1f",d.pub.lcs.x):sprintf("%.1f",d.pub.x);break;default:f=void 0!==d.pub.ra?sprintf("%.6f",d.pub.ra):sprintf("%.1f",d.pub.x)}k=f;break;case "ypos":switch(q.params.wcssys){case "image":f=sprintf("%.1f",d.pub.y);break;case "physical":f=d.pub.lcs?sprintf("%.1f",
d.pub.lcs.y):sprintf("%.1f",d.pub.y);break;default:f=void 0!==d.pub.dec?sprintf("%.6f",d.pub.dec):sprintf("%.1f",d.pub.y)}l=f;break;case "radius":case "oradius":case "length":case "width":case "r1":switch(q.params.wcssys){case "image":void 0!==d.pub[e]&&(f=t(d.pub[e]));break;case "physical":void 0!==d.pub.lcs[e]&&(f=t(d.pub.lcs[e]));break;default:f=d.pub.wcssizestr?t(d.pub.wcssizestr[0]):t(d.pub[e])}break;case "height":case "r2":switch(q.params.wcssys){case "image":void 0!==d.pub[e]&&(f=t(d.pub[e]));
break;case "physical":void 0!==d.pub.lcs[e]&&(f=t(d.pub.lcs[e]));break;default:f=d.pub.wcssizestr?t(d.pub.wcssizestr[1]):t(d.pub[e])}break;case "wcssys":g=$(r).find("[name='"+e+"']");if(!g.find("option").length)for(c=0;c<a.wcssyss.length;c++)h=a.wcssyss[c],g.append("<option>"+h+"</option>");g.find("option").each(function(a,b){q.params.wcssys===b.value&&(f=b.value)});break;case "altwcssys":g=$(r).find("[name='"+e+"']");if(!g.find("option").length)for(c=0;c<a.wcssyss.length;c++)h=a.wcssyss[c],"image"!==
h&&"physical"!==h&&g.append("<option>"+h+"</option>");(f=$(r).data("wcssys"))||g.find("option").each(function(a,b){q.params.wcssys===b.value&&(f=b.value)});break;case "wcsunits":d.pub.wcsunits&&(f=d.pub.wcsunits);break;case "childtext":0<d.params.children.length&&(f=u(d.params.children[0].obj.text));break;case "text":void 0!==d.pub[e]&&(f=u(t(d.pub[e])));break;case "id":f=d.pub.id;break;default:void 0!==d.pub[e]&&(f=t(d.pub[e]))}$(this).val(f)});(!this.raw.wcs||0>this.raw.wcs)&&$(r).find("[name='wcssys']").hide();
"image"===this.params.wcssys||"physical"===this.params.wcssys||!this.raw.wcs||0>this.raw.wcs?$(r).find("[name='altwcssys']").hide():($(r).find("[name='altwcssys']").show(),b&&q.params.wcssys!==b&&(b=q.wcs2wcs(null,b,k,l).split(/\s+/),$(r).find("[name='xpos']").val(b[0]),$(r).find("[name='ypos']").val(b[1])));"text"!==d.type&&($(r+".childtext").removeClass("nodisplay"),$(r+"[name='childtext']").prop("readonly",0<n.children.length));void 0===n.listonchange&&(n.listonchange=!1);n.listonchange?$(r+"[name='listonchange']").prop("checked",
!0):$(r+"[name='listonchange']").prop("checked",!1);void 0===n.changeable&&void 0!==n.fixinplace&&(n.changeable=!n.fixinplace);void 0===n.changeable&&(n.changeable=!0);n.changeable?$(r+"[name='changeable']").prop("checked",!0):$(r+"[name='changeable']").prop("checked",!1);$(r).find("input:text[readonly]").css("border-color","A5A5A5").css("background","#E9E9E9");switch(d.pub.shape){case "box":case "ellipse":$(r+".angle").removeClass("nodisplay");break;case "text":$(r+".textangle").removeClass("nodisplay")}$(r).data("im",
this);$(r).data("shape",d);$(r).data("winid",m);$(r).data("tooltipInit")||($(r).data("tooltipInit",!0),a.BROWSER[3]?(n="touchstart",m="touchend"):(n="mouseover",m="mouseout"),$(".col_R").on(n,function(){var b;b=$(this).find("input").data("tooltip");var c=$(this).closest(".dhtmlwindow").find(".drag-handle");b&&c.length&&(b=a.Regions.opts.title+": "+b,$(c)[0].childNodes[0].nodeValue=b)}),$(".col_R").on(m,function(){var b=$(this).closest(".dhtmlwindow").find(".drag-handle");b.length&&($(b)[0].childNodes[0].nodeValue=
a.Regions.opts.title)}))};a.Regions.processConfigForm=function(d,c,b,e){var f,g,h,k,l=1,n=e.length,m={},r=this.raw.wcsinfo||{cdelt1:1,cdelt2:1},q=function(a){if(void 0!==a)return"number"===typeof a&&0!==a%1&&(a=Math.round(1E4*(a+1E-5))/1E4),String(a)},t=function(a,b){return void 0===a?!1:q(a)!==q(b)},u=function(b,c,d){return"remove"===c?"selected"===d:"childtext"===c?0<b.params.children.length?!1:""!==d:"strokeDashes"===c?JSON.stringify(b.strokeDashArray)!==JSON.stringify(d):"tags"!==c&&""===d?!1:
"misc"===c&&""!==d?!0:"angle"===c?b.angle!==-parseFloat(d):"ix"===c?t(b.pub.x,a.saostrtod(d)):"iy"===c?t(b.pub.y,a.saostrtod(d)):"px"===c?t(b.pub.lcs.x,a.saostrtod(d)):"py"===c?t(b.pub.lcs.y,a.saostrtod(d)):"ra"===c?t(a.saostrtod(b.pub.wcsposstr[0]),a.saostrtod(d)):"dec"===c?t(a.saostrtod(b.pub.wcsposstr[1]),a.saostrtod(d)):void 0!==b.pub.lcs[c]?t(b.pub.lcs[c],d)?!0:!1:t(b.pub[c],d)||t(b.params[c],d)||t(b[c],d)?!0:!1},v=function(b){return"true"===b?!0:"false"===b?!1:a.isNumber(b)?parseFloat(b):b},
p=function(a){var b=String.fromCharCode(13,10);return(a||"").replace(/\\n/g,b)};this.lcs&&this.lcs.physical&&(l=this.lcs.physical.forward[0][0]||1);for(f=0;f<n;f++){g=e[f].name;h=e[f].value;if("xpos"===g||"ypos"===g)switch(this.params.wcssys){case "image":g="i"+g.charAt(0);break;case "physical":g="p"+g.charAt(0);break;default:g=this.raw.wcs&&0<this.raw.wcs?"xpos"===g?"ra":"dec":"xpos"===g?"ix":"iy"}switch(g){case "text":"text"===c.type&&u(c,g,h)&&(m[g]=p(v(h)));break;case "strokeDashes":h=h.trim().split(/\s+/);
u(c,g,h)&&(m.strokeDashArray=0===h.length?[]:h.map(function(a){return parseInt(a,10)}));break;case "childtext":"text"!==c.type&&u(c,g,h)&&(m.text=p(v(h)));break;case "ix":u(c,g,h)&&(m.x=v(h),void 0===m.y&&(m.y=c.pub.y));break;case "iy":u(c,g,h)&&(m.y=v(h),void 0===m.x&&(m.x=c.pub.x));break;case "px":u(c,g,h)&&(m.px=v(h),void 0===m.py&&(m.py=c.pub.lcs.y));break;case "py":u(c,g,h)&&(m.py=v(h),void 0===m.px&&(m.px=c.pub.lcs.x));break;case "ra":u(c,g,h)&&(m.ra=h,void 0===m.dec&&(m.dec=c.pub.wcsposstr[1]));
break;case "dec":u(c,g,h)&&(m.dec=h,void 0===m.ra&&(m.ra=c.pub.wcsposstr[0]));break;case "wcssys":break;case "radius":case "length":case "width":case "r1":switch(this.params.wcssys){case "image":u(c,g,h)&&(m[g]=v(h));break;case "physical":u(c,g,h)&&(m[g]=v(h)*l);break;default:h=a.strtoscaled(h),h="."===h.dtype?h.dval:Math.abs(h.dval/r.cdelt1),g=g.replace("wcs",""),u(c,g,h)&&(m[g]=v(h))}break;case "height":case "r2":switch(this.params.wcssys){case "image":u(c,g,h)&&(m[g]=v(h));break;case "physical":u(c,
g,h)&&(m[g]=v(h)*l);break;default:h=a.strtoscaled(h),h="."===h.dtype?h.dval:Math.abs(h.dval/r.cdelt2),g=g.replace("wcs",""),u(c,g,h)&&(m[g]=v(h))}break;case "remove":u(c,g,h)&&(m[g]=c.pub.id);break;case "misc":if(h.trim())try{k=JSON.parse(h),$.extend(m,k)}catch(w){a.error("invalid json: "+h)}break;default:u(c,g,h)&&(m[g]=v(h))}}m.ra&&m.dec&&(d=$(d).data("wcssys"))&&this.params.wcssys!==d&&(d=this.wcs2wcs(d,null,m.ra,m.dec).split(/\s+/),m.ra=d[0],m.dec=d[1]);this.changeShapes(c.pub.layer,c,m);a.Regions.initConfigForm.call(this,
c,b)};a.Regions.pasteFromClipboard=function(d){var c,b,e,f,g,h,k=0,l=0;if(this){(c=a.CopyFromClipboard().trim())||a.error(a.CLIPBOARDERROR);if(c.match(/(annulus|box|circle|ellipse|line|polygon|point|text) *\(/)){g=a.globalOpts.regionsToClipboard;a.globalOpts.regionsToClipboard=!1;h=this.addShapes("regions",c,{rtn:"objs"});if(d){b=h.length;for(d=0;d<b;d++)k+=h[d].pub.x,l+=h[d].pub.y;k/=b;l/=b;for(d=0;d<b;d++)e=h[d].pub.x-k+this.ipos.x,f=h[d].pub.y-l+this.ipos.y,this.changeShapes("regions",h[d].pub.id,
{x:e,y:f})}a.globalOpts.regionsToClipboard=g}else a.error(a.CLIPBOARDERROR2);return c}};a.Regions.listRegions=function(d,c,b){var e,f,g,h,k,l="",n="none",m=!1,r=[];g={};var q=[],t=function(a,b){var c,d,e,f={},g=a.params,h=g.children,k=g.exports;for(c=0;c<k.length;c++)if(e=k[c],("text"!==e||"text"===a.type)&&"textOpts"!==e){if("strokeDashArray"===e&&(d=a.strokeDashArray.join(""),""===d||d.match(/NaN/)))continue;if("data"!==e||"object"!==typeof g.data||!1!==g.data.doexport)"strokeWidth"===e&&g.sw1?
f[e]=g.sw1:void 0!==a[e]?f[e]=a[e]:void 0!==g[e]?f[e]=g[e]:b&&void 0!==b[e]&&(f[e]=b[e])}if(0<h.length&&h[0].obj.text){c=h[0].obj;f.text=c.text;f.textOpts=t(c);if(a.angle!==c.angle){if(f.textOpts.angle=-c.angle,"circle"===a.params.shape||"annulus"===a.params.shape)c.params.hasTextOpts=!0}else if(0!==c.angle){if("circle"===a.params.shape||"annulus"===a.params.shape)f.textOpts.angle=-c.angle,c.params.hasTextOpts=!0}else 0!==a.angle||0===a.pub.angle||"circle"!==a.params.shape&&"annulus"!==a.params.shape||
(f.textOpts.angle=a.pub.angle,c.params.hasTextOpts=!0);if(c.params.parent.moved||c.params.hasTextOpts)c.pub.ra&&c.pub.dec?(f.textOpts.ra=c.pub.ra,f.textOpts.dec=c.pub.dec):c.pub.lcs?(f.textOpts.px=c.pub.lcs.x,f.textOpts.py=c.pub.lcs.y):(f.textOpts.x=c.pub.x,f.textOpts.y=c.pub.y);f.textOpts.color===a.stroke&&delete f.textOpts.color;f.textOpts.text&&delete f.textOpts.text;Object.keys(f.textOpts).length||delete f.textOpts}return f};if("string"===typeof c)try{c=JSON.parse(c)}catch(u){a.error("can't parse listRegions opts: "+
c,u)}c=c||{};c=c.mode;a.isNull(c)&&(c=3);a.isNull(b)&&(b="regions");r=this.getShapes(b,d,{includeObj:!0});e=r.length;if(c)for(d=0;d<e;d++)if(b=r[d],(h=b.tags.join(","))&&"source,include"!==h&&"include,source"!==h){m=!0;break}for(f in a.Regions.opts.tagcolors)a.Regions.opts.tagcolors.hasOwnProperty(f)&&q.push(a.Regions.opts.tagcolors[f]);for(d=0;d<e;d++)b=r[d],g=b.obj,h=b.tags.join(","),f=0<=h.indexOf("exclude")?"-":"",g=t(g,b),b.color&&-1===q.indexOf(b.color)&&(g.color=b.color),m&&(k=" # "+h),b.wcsstr&&
"image"!==this.params.wcssys&&"physical"!==this.params.wcssys?("wcs"!==n&&("none"!==n&&(l+="; "),l+=this.params.wcssys,n="wcs"),l+="; "+f+b.wcsstr):b.imstr&&(n!==b.imsys&&("none"!==n&&(l+="; "),l+=b.imsys,n=b.imsys),l+="; "+f+b.imstr),1===c%2&&0<Object.keys(g).length&&("line"===b.shape&&(l=l.replace(/ *{[^{}]*}$/,"")),l+=" "+JSON.stringify(g)),k&&(l+=k);1<c&&this.display.displayMessage("regions",l);return l};a.Regions.copyRegions=function(d,c){var b,e,f=[];if("object"===typeof d)f.push(d);else if("all"===
d)for(b=0;b<a.images.length;b++)this!==a.images[b]&&f.push(a.images[b]);else(b=a.lookupImage(d))&&f.push(b);if(f.length){c||(e=this.listRegions("selected",{mode:1}));e||(e=this.listRegions(c,{mode:1}));for(b=0;b<f.length;b++)f[b].addShapes("regions",e);return this}};a.Regions.parseRegions=function(d,c){var b,e,f,g,h,k,l,n,m,r,q,t,u,v=[],p=/^(annulus|box|circle|ellipse|line|polygon|point|text)$/,w=/^(fk4|fk5|icrs|galactic|ecliptic|image|physical|linear)$/,x=/^(image|physical)$/,A=/[dr:]/,z=/\(\s*([^)]+?)\s*\)/,
C=/(\{.*\})/,D=/\s*,\s*/,y=/#(?![a-zA-Z0-9]{6}['"])/,B=function(a){return"0"===a||"false"===a.toLowerCase()?!1:!0},F=function(a){for(var b,c,d,e={},f=/([a-zA-Z][a-zA-Z0-9_]*)\s*=\s*(\d+(\s*\d+)*|[^ '"{]+|['"{][^'"}]*['"}])/g,g={color:function(a){return{color:a}},dash:function(a){if(a)return{strokeDashArray:[3,1]}},dashlist:function(a){var b;if(a){b=a.split(" ");for(a=0;a<b.length;a++)b[a]=parseFloat(b[a]);return{strokeDashArray:b}}},"delete":function(a){return{removable:B(a)}},edit:function(a){return{selectable:B(a)}},
fixed:function(a){return{zoomable:!B(a)}},font:function(a){var b={};a=a.split(" ");var c=a.length;1<=c&&(b.fontFamily=a[0]);2<=c&&(b.fontSize=parseFloat(a[1]));3<=c&&(b.fontStyle=a[2]);4<=c&&(b.fontWeight=a[3]);return b},highlite:function(a){return{hasControls:B(a),hasBorders:B(a),hasRotatingPoint:B(a)}},move:function(a){return{movable:B(a)}},rotate:function(a){return{rotatable:B(a)}},resize:function(a){return{resizable:B(a)}},changeable:function(a){return{changeable:B(a)}},select:function(a){return{selectable:B(a)}},
text:function(a){return{text:a}},tag:function(a){return{tags:a}},width:function(a){return{strokeWidth:parseFloat(a)}}};null!==(b=f.exec(a));)if(c=b[1].toLowerCase(),b=b[2].replace(/^['"{]|['"}]$/g,""),g.hasOwnProperty(c)&&"function"===typeof g[c])for(d in c=g[c](b),c)c.hasOwnProperty(d)&&("tags"===d&&e.hasOwnProperty(d)?e[d]+=","+c[d]:e[d]=c[d]);else e[c]=b;if(a=a.replace(f,""))e._comment=a.trim();return e},H=function(a){var b,c,d,e={opts:{},args:[],isregion:0};0<=a.indexOf("(")?e.cmd=a.split("(")[0].trim().toLowerCase():
0<=a.indexOf("{")?e.cmd=a.split("{")[0].trim().toLowerCase():0<=a.indexOf("#")?e.cmd=a.split("#")[0].trim().toLowerCase():e.cmd=a.trim().toLowerCase();e.cmd&&(e.isregion=0<=e.cmd.search(p));b=a.trim().split(y);if((c=C.exec(b[0]))&&c[0])try{e.opts=JSON.parse(c[0].trim())}catch(J){e.opts={}}e.comment=b[1];e.comment&&(d=F(e.comment.trim()),void 0!==d._comment&&(e.comment=d._comment,delete d._comment));d&&(e.opts=$.extend({},d,e.opts));(c=z.exec(a))&&c[1]&&(e.args=c[1].split(D));e.isregion&&0===e.cmd.indexOf("-")&&
(e.cmd=e.cmd.slice(1),e.comment=e.comment?e.comment+",exclude":"exclude");return e},G=function(b,c){var d,e;e=a.strtoscaled(b);d=a.strtoscaled(c);!e.dtype.match(A)&&!d.dtype.match(A)||l.match(x)||(q=!0,m=l);r||q?(":"===e.dtype&&"galactic"!==m&&"ecliptic"!==m&&(e.dval*=15),"r"===e.dtype&&(e.dval=180*e.dval/Math.PI),"r"===d.dtype&&(d.dval=180*d.dval/Math.PI),d=a.wcs2pix(this.raw.wcs,e.dval,d.dval).split(/ +/),e=parseFloat(d[0]),d=parseFloat(d[1])):"physical"===m?(d=this.logicalToImagePos({x:e.dval,
y:d.dval}),e=d.x,d=d.y):(e=e.dval,d=d.dval);return[e,d]},E=function(b,c){var d=a.strtoscaled(b),e=this.raw.wcsinfo||{cdelt1:1,cdelt2:1};d.dtype.match(A)&&!l.match(x)&&(q=!0,m=l);r||q?("r"===d.dtype&&(d.dval=180*d.dval/Math.PI),d.dval=Math.abs(d.dval/e["cdelt"+c])):"physical"===m&&this.lcs&&this.lcs.physical&&(d.dval*=this.lcs.physical.forward[0][0]);return d.dval},I=function(b){b=a.strtoscaled(b);var c=this.raw.wcsinfo||{crot:0};c.crot&&(b.dval+=c.crot);return b.dval};d=d.trim();if(!d.match(/(\(|\{|#|;|\n)/))return d;
l=this.getWCSSys();n=this.getWCSUnits();m="physical";r="image"!==m&&"physical"!==m;g=d.split(/\n|;/);for(b=0;b<g.length;b++)if("#"!==g[b].trim().substr(0,1))if(q=!1,k=H(g[b]),u=k.args.length,k.isregion){h=$.extend(!0,{},k.opts);h.shape=k.cmd;2<=u&&(t=G.call(this,k.args[0],k.args[1]),h.x=t[0],h.y=t[1]);h.textOpts&&void 0!==h.textOpts.ra&&void 0!==h.textOpts.dec&&(h.textOpts._wcssys=m);switch(k.cmd){case "annulus":h.radii=[];for(e=2;e<u;e++)h.radii.push(E.call(this,k.args[e],1));break;case "box":3<=
u&&(h.width=E.call(this,k.args[2],1));4<=u&&(h.height=E.call(this,k.args[3],2));5<=u&&(h.angle=I.call(this,k.args[4]));break;case "circle":3<=u&&(h.radius=E.call(this,k.args[2],1));break;case "ellipse":3<=u&&(h.r1=E.call(this,k.args[2],1));4<=u&&(h.r2=E.call(this,k.args[3],2));5<=u&&(h.angle=I.call(this,k.args[4]));break;case "line":case "polygon":h.pts=[];for(f=e=0;e<u;e+=2,f++)t=G.call(this,k.args[e],k.args[e+1]),h.pts[f]={x:t[0],y:t[1]};delete h.x;delete h.y;break;case "text":3<=u&&(h.text=k.args[2].replace(/^['"]/,
"").replace(/["']$/,"")),4<=u&&(h.angle=I.call(this,k.args[3]))}k.comment&&(h.tags=k.comment);v.push(h)}else k.cmd.match(w)?(e=a.globalOpts.xeqPlugins,a.globalOpts.xeqPlugins=!1,this.setWCSSys(k.cmd),a.globalOpts.xeqPlugins=e,m=this.getWCSSys(),r="image"!==m&&"physical"!==m):"remove"!==k.cmd&&"delete"!==k.cmd||v.push({remove:!0});e=a.globalOpts.xeqPlugins;a.globalOpts.xeqPlugins=!1;this.setWCSSys(l);this.setWCSUnits(n);a.globalOpts.xeqPlugins=e;return v};a.Regions.saveRegions=function(d,c,b){var e,
f,g,h,k,l,n;d&&(l=d.match(/\.([^.]*)$/))&&2<=l.length&&("reg"===l[1]||"svg"===l[1])&&(h=l[1]);if("object"===typeof b)k=b,b=null;else if("string"===typeof b){try{k=JSON.parse(b)}catch(m){k=null}k&&(b=null)}k&&(a.notNull(k.layer)&&(b=k.layer),a.notNull(k.type)&&(h=k.type));b=b||"regions";h=h||"reg";this.layers[b]||a.error("can't find layer for saveRegions: "+b);switch(h){case "svg":try{a.globalOpts.svgBorder&&(n=this.addShapes(b,"box",{left:this.rgb.img.width/2,top:this.rgb.img.height/2,width:this.rgb.img.width,
height:this.rgb.img.height,color:"black",strokeWidth:1,tags:"SVGBorder"})),g=this.layers[b].dlayer.canvas.toSVG(),a.globalOpts.svgBorder&&this.removeShapes(b,n)}catch(m){a.error("can't convert layer to SVG: "+b)}break;default:try{e=sprintf("# Region file format: JS9 version 1.0"),f=this.listRegions(c,{mode:1},b),g=sprintf("%s\n%s\n",e,f.replace(/; */g,"\n"))}catch(m){a.error("can't convert layer to region: "+b)}}c=new Blob([g],{type:"text/plain;charset=utf-8"});d||(d=b&&"regions"!==b?"js9_"+b+"."+
h:"js9."+h);window.hasOwnProperty("saveAs")?saveAs(c,d):a.error("no saveAs function available to save region file");return d};a.Regions.editRegionTags=function(a,c,b){var d,f,g,h,k=[];g=this.getShapes("regions",a);if(g.length){for(d=0;d<g.length;d++)for(h=g[d].tags,k.push(c),f=0;f<h.length;f++)h[f]!==b&&k.push(h[f]);this.changeShapes("regions",a,{tags:k})}};a.Regions.toggleRegionTags=function(a,c,b){var d,f,g,h,k;g=this.getShapes("regions",a);if(g.length){for(d=0;d<g.length;d++)for(h=g[d].tags,k=
"",f=0;f<h.length;f++)if(h[f]===c){k=h[f]=b;break}else if(h[f]===b){k=h[f]=c;break}k&&this.changeShapes("regions",a,{tags:h})}};a.Regions.unremoveRegions=function(){var a=this.regstack.pop();return a?this.addShapes("regions",a):null};a.Catalogs={};a.Catalogs.CLASS="JS9";a.Catalogs.NAME="Catalogs";a.Catalogs.opts={hasControls:!1,hasRotatingPoint:!1,hasBorders:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,lockUniScaling:!0,selectable:!1,canvas:{selection:!1},updateWCS:!1,
panzoom:!0,shape:"circle",strokeWidth:2,width:10,height:10,radius:5,eradius:{x:5,y:3},angle:0,tagcolors:{defcolor:"#00FF00"},sortOverlapping:!1};a.Crosshair={};a.Crosshair.CLASS="JS9";a.Crosshair.NAME="Crosshair";a.Crosshair.LAYERNAME="crosshair";a.Crosshair.opts={hasControls:!1,hasRotatingPoint:!1,hasBorders:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,lockUniScaling:!0,selectable:!1,canvas:{selection:!1},updateWCS:!1,panzoom:!1,arrowSize:20,strokeWidth:1,
color:"#00FF00",sortOverlapping:!1,hiddenPts:{pts:[{x:-9999,y:-9999},{x:-9999,y:-9900}]}};a.Crosshair.display=function(d,c,b){var e,f,g,h,k,l,n,m=a.Crosshair.LAYERNAME;b=/iPad|iPhone|iPod/.test(navigator.platform)?!0:b.shiftKey;if(d.tmp.arrowCrosshair||b&&d&&!d.tmp.shiftKey&&d.crosshair&&d.params.crosshair)if(d.tmp.arrowCrosshair&&!d.params.crosshair?(g=a.Crosshair.opts.arrowSize/d.rgb.sect.zoom,b=c.x-g,l=c.x+g,f=c.y-g,n=c.y+g):(b=0,l=d.raw.width,f=0,n=d.raw.height),l={pts:[{x:b,y:c.y},{x:l,y:c.y}],
redraw:!1},d.changeShapes(m,d.crosshair.h,l),b={pts:[{x:c.x,y:f},{x:c.x,y:n}],redraw:!0},d.changeShapes(m,d.crosshair.v,b),d.crosshair.visible=!0,a.globalOpts.wcsCrosshair&&d&&d.raw.wcs&&0<d.raw.wcs)for(f=a.pix2wcs(d.raw.wcs,c.x,c.y).trim().split(/\s+/),h=a.saostrtod(f[0]),":"===String.fromCharCode(a.saodtype())&&"galactic"!==d.params.wcssys&&"ecliptic"!==d.params.wcssys&&(h*=15),k=a.saostrtod(f[1]),c=0;c<a.displays.length;c++)if((g=a.displays[c].image)&&g!==d&&g.crosshair&&g.params.crosshair&&0<
g.raw.wcs){l=g.raw.width;n=g.raw.height;try{e=a.wcs2pix(g.raw.wcs,h,k)}catch(r){e=null}e&&(f=e.trim().split(/\s+/),b=parseFloat(f[0]),f=parseFloat(f[1]),0<b&&b<l&&0<f&&f<n&&(l={pts:[{x:0,y:f},{x:l,y:f}],redraw:!1},g.changeShapes(m,g.crosshair.h,l),b={pts:[{x:b,y:0},{x:b,y:n}],redraw:!0},g.changeShapes(m,g.crosshair.v,b),g.crosshair.visible=!0))}};a.Crosshair.hide=function(d,c,b){c=a.Crosshair.LAYERNAME;b=a.Crosshair.opts.hiddenPts;if(d&&d.crosshair&&d.crosshair.visible||d.tmp.arrowCrosshairVisible)d.changeShapes(c,
d.crosshair.h,b),d.changeShapes(c,d.crosshair.v,b),d.crosshair.visible=!1,delete d.tmp.arrowCrosshairVisible};a.Crosshair.create=function(d){var c=a.Crosshair.opts.hiddenPts,b=a.Crosshair.LAYERNAME;d&&!d.crosshair&&(d.crosshair={},d.crosshair.h=d.addShapes(b,"line",c),d.crosshair.v=d.addShapes(b,"line",c),d.crosshair.visible=!1)};a.Crosshair.keyaction=function(a,c,b){a&&b&&b.shiftKey&&(a.tmp.shiftKey=!0)};a.Crosshair.keyup=function(a,c,b){a&&a.tmp.shiftKey&&b&&!b.shiftKey&&delete a.tmp.shiftKey};
a.Crosshair.init=function(){var d,c=a.Crosshair.LAYERNAME;for(d=0;d<a.displays.length;d++)a.displays[d].layers.crosshair||a.displays[d].newShapeLayer(c,a.Crosshair.opts);return this};a.Image.prototype.toggleCrosshair=function(){this.params.crosshair=!this.params.crosshair;this.params.crosshair||a.Crosshair.hide(this)};a.Image.prototype.toggleWCSCrosshair=function(){a.globalOpts.wcsCrosshair=!a.globalOpts.wcsCrosshair};a.Grid={};a.Grid.CLASS="JS9";a.Grid.NAME="Grid";a.Grid.LAYERNAME="grid";a.Grid.opts=
{movable:!1,cover:"display",reduceDims:!0,strokeWidth:1,margin:0,labelMargin:10,stride:32,raLines:8,raSkip:0,raAngle:0,decLines:8,decSkip:0,decAngle:90,sexaPrec:1,degPrec:3,lineColor:"#00FFFF",labelColor:"#00FFFF",labelFontFamily:"Helvetica, sans-serif",labelFontSize:11,labelFontStyle:"normal",labelFontWeight:300,labelRAOffx:3,labelRAOffy:-1,labelDecOffx:-14,labelDecOffy:6};a.Grid.limits=function(a,c,b,e){a=b-c;a=1<a?10:.1<a?100:.01<a?1E3:.001<a?1E4:1E-4<a?1E5:1E6;c=Math.floor(c*a)/a;b=Math.ceil(b*
a)/a;return{lo:c,hi:b,inc:Math.ceil((b-c)/e*a)/a}};a.Grid.getLabel=function(d,c,b){var e,f,g=!1;switch(d.wcsunits){case "sexagesimal":"ra"===b&&"galactic"!==d.wcssys&&"ecliptic"!==d.wcssys&&(c/=15);c=a.saodtostr(c,":",d.sexaPrec);f=c.split(":");if(d.last[b])for(c="",e=0;e<f.length;e++)if(c&&(c+=":"),g||f[e]!==d.last[b][e])c+=f[e],g=!0;d.last[b]=$.extend({},f);break;default:c=c.toFixed(d.degPrec)}c=c.replace(/0+$/,"");d=c.indexOf(".");0>d?c+=".0":d===c.length-1&&(c+="0");return c=c.replace(/:\.0/,
":0.0")};a.Grid.display=function(d,c){var b,e,f,g,h,k,l,n,m,r,q,t,u,v,p,w,x,A,z,C,D,y;q=this.display;var B=this.raw;v=[{ra:0,dec:0},{ra:0,dec:0},{ra:0,dec:0},{ra:0,dec:0}];if(a.isNull(d))switch(this.tmp.gridStatus){case "inactive":case void 0:return!1;case "active":case "processing":return!0;default:return!0}this.removeShapes(a.Grid.LAYERNAME);if(!1===d||!this.raw.wcs||0>=this.raw.wcs)this.tmp.gridStatus="inactive";else{c=c||{};if("string"===typeof c)try{c=JSON.parse(c)}catch(F){a.error("can't parse displayCoordGrid JSON",
F)}this.tmp.gridStatus="processing";y=$.extend(!0,{},a.Grid.opts,c);y.wcsunits=this.getWCSUnits();y.wcssys=this.getWCSSys();y.last={};a.wcsunits(this.raw.wcs,"degrees");"image"===y.cover?(g=[Math.max(1,Math.floor(B.width/q.width)),Math.max(1,Math.floor(B.height/q.height))],r=[{x:0,y:0},{x:B.width-1,y:B.height-1}]):(g=y.reduceDims?B.width<B.height?[B.width/B.height,1]:B.height<B.width?[1,B.height/B.width]:[1,1]:[1,1],r=[],e={x:this.ix+y.margin,y:this.iy-y.margin},t=this.displayToImagePos(e),r[0]={x:t.x,
y:t.y},e={x:q.width-1-this.ix-y.margin,y:q.height-1-this.iy-y.margin},t=this.displayToImagePos(e),r[1]={x:t.x,y:t.y});b=a.pix2wcs(B.wcs,r[0].x,r[0].y).trim().split(/\s+/);v[0].ra=a.saostrtod(b[0]);v[0].dec=a.saostrtod(b[1]);b=a.pix2wcs(B.wcs,r[0].x,r[1].y).trim().split(/\s+/);v[1].ra=a.saostrtod(b[0]);v[1].dec=a.saostrtod(b[1]);b=a.pix2wcs(B.wcs,r[1].x,r[0].y).trim().split(/\s+/);v[2].ra=a.saostrtod(b[0]);v[2].dec=a.saostrtod(b[1]);b=a.pix2wcs(B.wcs,r[1].x,r[1].y).trim().split(/\s+/);v[3].ra=a.saostrtod(b[0]);
v[3].dec=a.saostrtod(b[1]);r=v[0].ra;t=v[0].dec;q=v[0].ra;u=v[0].dec;for(b=1;4>b;b++)r=Math.min(r,v[b].ra),t=Math.min(t,v[b].dec),q=Math.max(q,v[b].ra),u=Math.max(u,v[b].dec);b=a.Grid.limits.call(this,y,r,q,y.raLines*g[0]);r=b.lo;q=b.hi;v=b.inc;b=a.Grid.limits.call(this,y,t,u,y.decLines*g[1]);t=b.lo;u=b.hi;p=b.inc;a.wcsunits(this.raw.wcs,y.wcsunits);w=Math.abs(this.raw.wcsinfo.cdelt1);x=w*a.Grid.opts.stride;A=q-x;z=Math.abs(this.raw.wcsinfo.cdelt2);C=z*a.Grid.opts.stride;D=u-C;b="image;";for(n=r;n<=
q;n+=v){f="line(";l=z;e=k=0;for(m=t;m<=u;m+=l)(h=a.wcs2pix(B.wcs,n,m).trim().split(/ +/))&&h.length&&(g=parseFloat(h[0]),h=parseFloat(h[1]),g>=-y.margin&&g<=B.width+y.margin&&h>=-y.margin&&h<=B.height+y.margin?(f+=String(g+1+","+h+1+", "),e++,0===k?(k=1,m<D&&(l=C)):1===k&&m>D&&(k=2,l=z)):1===k&&(k=2,m-=l,l=z));1<e&&(b+=f.replace(/,\s+$/,") "),b+=sprintf(' {"color": "%s"};',y.lineColor))}for(m=t;m<=u;m+=p){f="line(";l=w;e=k=0;for(n=r;n<=q;n+=l)(h=a.wcs2pix(B.wcs,n,m).trim().split(/ +/))&&h.length&&
(g=parseFloat(h[0]),h=parseFloat(h[1]),g>=-y.margin&&g<=B.width+y.margin&&h>=-y.margin&&h<=B.height+y.margin?(f+=String(g+1+","+h+1+", "),e++,0===k?(k=1,n<A&&(l=x)):1===k&&n>A&&(k=2,l=w)):1===k&&(k=2,n-=l,l=w));1<e&&(b+=f.replace(/,\s+$/,") "),b+=sprintf(' {"color": "%s"};',y.lineColor))}k=y.labelDecOffx/this.rgb.sect.zoom;l=y.labelDecOffy/this.rgb.sect.zoom;w=0;n=x=r;for(f=0;n<=q;n+=v){for(m=t;m<=u;m+=p)(h=a.wcs2pix(B.wcs,n,m).trim().split(/ +/))&&h.length&&(g=parseFloat(h[0]),h=parseFloat(h[1]),
e=this.imageToDisplayPos({x:g,y:h}),e.x>this.ix+y.labelMargin&&e.x<this.rgb.img.width+this.ix-y.labelMargin&&e.y>this.iy+y.labelMargin&&e.y<this.rgb.img.height+this.iy-y.labelMargin&&(w>=y.decSkip?(b+=sprintf('text(%s,%s,%s,%s) {"color":"%s", "fontFamily":"%s", "fontSize":%s, "fontStyle":"%s", "fontWeight":"%s", "originX":"left", "originY":"top"};',g+k,h+l,a.Grid.getLabel.call(this,y,m,"dec"),y.decAngle,y.labelColor,y.labelFontFamily,y.labelFontSize,y.labelFontStyle,y.labelFontWeight),f++):(n!==x&&
w++,x=n)));if(f)break}k=y.labelRAOffx/this.rgb.sect.zoom;l=y.labelRAOffy/this.rgb.sect.zoom;w=0;m=x=t;for(f=0;m<=u;m+=p){for(n=r;n<=q;n+=v)(h=a.wcs2pix(B.wcs,n,m).trim().split(/ +/))&&h.length&&(g=parseFloat(h[0]),h=parseFloat(h[1]),e=this.imageToDisplayPos({x:g,y:h}),e.x>this.ix+y.labelMargin&&e.x<this.rgb.img.width+this.ix-y.labelMargin&&e.y>this.iy+y.labelMargin&&e.y<this.rgb.img.height+this.iy-y.labelMargin&&(w>=y.raSkip?(b+=sprintf('text(%s,%s,%s,%s) {"color":"%s", "fontFamily":"%s", "fontSize":%s, "fontStyle":"%s", "fontWeight":"%s", "originX":"left", "originY":"top"};',
g+k,h+l,a.Grid.getLabel.call(this,y,n,"ra"),y.raAngle,y.labelColor,y.labelFontFamily,y.labelFontSize,y.labelFontStyle,y.labelFontWeight),f++):(m!==x&&w++,x=m)));if(f)break}this.addShapes(a.Grid.LAYERNAME,b,y);this.tmp.gridStatus="active"}};a.Grid.toggle=function(a){if(a)switch(a.tmp.gridStatus){case void 0:case null:case "inactive":a.displayCoordGrid(!0);break;case "active":a.displayCoordGrid(!1)}};a.Grid.regrid=function(a){a&&"active"===a.tmp.gridStatus&&"complete"===a.status.load&&a.displayCoordGrid(!0)};
a.Grid.init=function(d){d=$.extend(!0,{},a.Catalogs.opts,a.Grid.opts,d);this.display.newShapeLayer(a.Grid.LAYERNAME,d).canvas.on("mouse:up",function(){return!1})};a.Image.prototype.displayCoordGrid=a.Grid.display;a.Dysel={};a.Dysel.CLASS="JS9";a.Dysel.NAME="Dysel";a.Dysel.display=null;a.Dysel.plugins=[];a.Dysel.init=function(a){};a.Dysel.unhighlightSelection=function(){a.bugs.webkit_resize?$(".JS9").find(".JS9Image").removeClass("JS9Highlight"):$(".JS9").removeClass("JS9Highlight")};a.Dysel.highlightSelection=
function(d){d&&a.Dysel.retrievePlugins().length&&1!==a.displays.length&&(a.Dysel.unhighlightSelection(),d=d.display,a.bugs.webkit_resize?$(d.divjq).find(".JS9Image").addClass("JS9Highlight"):$(d.divjq).addClass("JS9Highlight"))};a.Dysel.addPlugins=function(d){a.Dysel.plugins.push(d)};a.Dysel.retrievePlugins=function(){return a.Dysel.plugins};a.Dysel.getDisplay=function(d){return a.Dysel.retrievePlugins().length?"previous"===d?a.Dysel.odisplay:a.Dysel.display:null};a.Dysel.getDisplayOr=function(d){return"previous"===
d?a.Dysel.getDisplay(d):a.Dysel.getDisplay()||d};a.Dysel.select=function(d){d&&a.Dysel.retrievePlugins().length&&(a.Dysel.odisplay=a.Dysel.display,a.Dysel.display=d,d.image&&(a.Dysel.highlightSelection(d.image),d.image.xeqPlugins("image","ondynamicselect",null)))};a.Dysel.imageload=function(d){d&&a.Dysel.select(d.display)};a.Dysel.imageclose=function(d){var c,b;if(d&&(b=a.Dysel.getDisplay())&&b.image===d){for(b=c=0;c<a.images.length;c++)d.display===a.images[c].display&&b++;if(1>=b)for(c=0;c<a.displays.length;c++)if(b=
a.displays[c],d.display!==b&&b.image){a.Dysel.select(a.displays[c]);break}}};a.getDynamicDisplayOr=a.Dysel.getDisplayOr;Math.log10=Math.log10||function(a){return Math.log(a)/Math.LN10};"function"!==typeof Object.create&&(Object.create=function(a){var c=function(){};c.prototype=a;return new c});Math.asinh=Math.asinh||function(a){return-Infinity===a?a:Math.log(a+Math.sqrt(a*a+1))};Math.sinh=Math.sinh||function(a){return(Math.exp(a)-Math.exp(-a))/2};a.jupyterFocus=function(a,c){var b;window.hasOwnProperty("Jupyter")&&
(b=a instanceof jQuery?a:$(a),b.find(c||"input, textarea").each(function(){Jupyter.keyboard_manager.register_events($(this))}))};a.getImageID=function(d,c,b){var e,f,g=0,h=1,k=a.images.length,l=/.*<([0-9][0-9]*)>$/,n=/<[0-9][0-9]*>/;d=d.replace(n,"");for(e=0;e<k;e++)f=a.images[e],f.display.id===c&&f!==b&&d===f.id0.replace(n,"")&&(f.id&&0<=f.id.search(l)&&(f=f.id.replace(l,"$1"),h=Math.max(h,parseInt(f,10))),g++);return g?d+"<"+String(h+1)+">":d};a.uniqueID=function(){var a=1;return function(){return a++}}();
a.waiting=function(d,c){var b,e;switch(d){case !0:window.hasOwnProperty("Spinner")&&"spinner"===a.globalOpts.waitType?(c&&("object"===typeof c?b=c.divjq[0]:"string"===typeof c&&(e=a.lookupDisplay(c))&&(b=e.divjq[0])),b||(b=$("body").get(0)),a.spinner||(a.spinner={},e={color:a.globalOpts.spinColor,opacity:a.globalOpts.spinOpacity},a.spinner.spinner=new Spinner(e)),a.spinner.spinner.spin(b)):$("body").addClass("waiting");break;case !1:window.hasOwnProperty("Spinner")&&"spinner"===a.globalOpts.waitType?
a.spinner&&a.spinner.spinner.stop():$("body").removeClass("waiting")}};a.progress=function(d,c){if("boolean"===typeof d||"string"===typeof d)switch(d){case !0:case "indeterminate":c&&(a.progress.display=c,a.progress.display.displayMessage("progress",d));break;case !1:case "":a.progress.display&&(a.progress.display.clearMessage("progress"),delete a.progress.display)}else"number"===typeof d&&a.progress.display&&a.progress.display.displayMessage("progress",[d,c])};a.msgHandler=function(d,c){var b,e,
f,g=[],h=d.cmd,k=d.id,l=a.globalOpts.alerts,n=a.globalOpts.quietReturn?"":"OK";c&&(a.globalOpts.alerts=!1);if(a.publics[h]){$.isArray(d.args)||(d.args=[d.args]);g=$.extend(!0,[],d.args);if(k)if(0<g.length){b=g[g.length-1];if("string"===typeof b)try{e=JSON.parse(b)}catch(m){e=null}else"object"===typeof b&&(e=b);e&&"object"===typeof e&&e.hasOwnProperty("display")&&1===Object.keys(e).length?"string"===typeof b&&(g.pop(),g.push(e)):g.push({display:k})}else g.push({display:k});"RunAnalysis"===h&&c&&(1===
g.length&&g.push(null),g.push(c),c=null);try{f=a.publics[h].apply(null,[].concat($jscomp.arrayFromIterable(g)))}catch(m){f=sprintf("ERROR: %s",m.message)}if(c){a.globalOpts.alerts=l;if(f instanceof a.Display||f instanceof a.Image)f=f.id;c(f)}return f}if(h&&"#"!==h){e=a.lookupCommand(h);b=a.lookupDisplay(k);if(e&&b)switch(e.getDisplayInfo(b),d.args?g=$.extend(!0,[],d.args):d.paramlist&&(g=d.paramlist.split(/ +/)),e.getWhich(g)){case "get":try{f=e.get(g)||""}catch(m){f="ERROR: "+m.message}break;case "set":try{f=
e.set(g)||n}catch(m){f="ERROR: "+m.message}break;default:f=sprintf("ERROR: unknown cmd type for '%s'",h)}else e||(f=sprintf("ERROR: unknown cmd '%s'",h)),b||(f=sprintf("ERROR: unknown display (%s)",k));if(c){a.globalOpts.alerts=l;if(f instanceof a.Display||f instanceof a.Image)f=f.id;c(f)}return f}c&&c("");c&&(a.globalOpts.alerts=l)};a.lightWin=function(d,c,b,e,f){var g;switch(a.LIGHTWIN){case "dhtml":g=dhtmlwindow.open(d,c,b,e,f),/iPad|iPhone|iPod/.test(navigator.platform)&&$("#"+d+" "+a.lightOpts.dhtml.drag).css("-webkit-overflow-scrolling",
"touch").css("overflow-y","scroll"),$("#"+d+" ."+a.lightOpts.dhtml.dragBar).on("mouseup touchend",this,function(){var b=(new Date).getTime(),c=$(this).data("lasttime");c&&b-c<a.DBLCLICK&&g.close();$(this).data("lasttime",b)}),$("#"+d+" ."+a.lightOpts.dhtml.dragBar).on("touchend",this,function(){dhtmlwindow.distancex||dhtmlwindow.distancey?0<a.lightOpts.nclick&&(a.lightOpts.nclick=0):2<=a.lightOpts.nclick?(alert("trouble closing this window? double-tap the window handle"),a.lightOpts.nclick=-1):0<=
a.lightOpts.nclick&&a.lightOpts.nclick++})}return g};a.checkNew=function(d){d||a.error("internal failure in a JS9 constructor")};a.specialKey=function(a){return a.metaKey||a.ctrlKey};a.strace=function(d){var c="";1<a.DEBUG&&(c=d.stack||d.stacktrace||"");return c};a.floatToString=function(d){return sprintf("%g",parseFloat(d.toFixed(a.globalOpts.floatPrecision)))};a.floatPrecision=function(a,c){var b=Math.floor(Math.log10(Math.abs(a))),d=Math.floor(Math.log10(Math.abs(c)));return b!==d?b>d?b:d:1};a.floatFormattedString=
function(a,c,b){var d="";if(void 0===a)return d;-2>c?(c="%."+String(2+b)+"e",d=sprintf(c,a)):0>c?d=a.toFixed(Math.abs(c)+3+b):2>c?(c="%."+String(c+b)+"f",d=sprintf(c,a)):5>c?d=a.toFixed(0+b):(c="%."+String(2+b)+"e",d=sprintf(c,a));return d};a.centerPolygon=function(a){var c,b,d,f,g,h;if(a&&a.length){b=a.length;for(c=0;c<b;c++){if(void 0===d||a[c].x<d)d=a[c].x;if(void 0===f||a[c].x>f)f=a[c].x;if(void 0===g||a[c].y<g)g=a[c].y;if(void 0===h||a[c].y>h)h=a[c].y}return{x:(d+f)/2,y:(g+h)/2}}};a.centroidPolygon=
function(a){var c,b,d=0,f=0;if(a&&a.length){b=a.length;for(c=0;c<b;c++)d+=a[c].x,f+=a[c].y;return{x:d/b,y:f/b}}};a.lookupImage=function(d,c){var b,e,f,g=a.images.length;if(!d)return null;for(b=0;b<g;b++)if(e=a.images[b],(d===e||d===e.id||d===e.id0||d===e.id0.replace(/\[.*\]$/,"")||d===e.file||d===e.file.replace(/\[.*\]$/,"")||d===e.file0||d===a.TOROOT+e.file||e.fitsFile&&d===e.fitsFile)&&0<$("#"+e.display.id).length&&(f=e.display.id,!c||"string"===typeof c&&c===f||"object"===typeof c&&c.id===f))return e;
return null};a.lookupDisplay=function(d,c){var b,e=new RegExp(sprintf("[-_]?(%s)$",a.PLUGINS));void 0===c&&(c=!0);if(d&&0>d.toString().search(a.SUPERMENU)){for(b=0;b<a.displays.length;b++)if(d===a.displays[b]||d===a.displays[b].id||d===a.displays[b].oid)return a.displays[b];if("string"===typeof d)for(d=d.replace(e,""),b=0;b<a.displays.length;b++)if(d===a.displays[b]||d===a.displays[b].id||d===a.displays[b].oid)return a.displays[b];if(c)a.error("can't find JS9 display with id: "+d);else return null}return a.displays[0]};
a.getImage=function(d){var c;c=a.lookupImage(d);!c&&(d=a.lookupDisplay(d))&&(c=d.image);return c};a.lookupVfile=function(d){var c,b,e,f,g=[];if(!d)return g;for(c=0;c<a.images.length;c++)for(e=a.images[c],b=0;b<e.raws.length;b++)f=e.raws[b],f.hdu&&f.hdu.fits&&d===f.hdu.fits.vfile&&g.push({im:e,raw:f,idx:b});return g};a.loadScript=function(a,c,b){var d=document.getElementsByTagName("head")[0],f=document.createElement("script");f.type="text/javascript";c&&(f.onload=c);b&&(f.onerror=b);f.src=a;d.appendChild(f)};
a.fetchURL=function(d,c,b,e){var f,g=new XMLHttpRequest;b=b||{};d||c||a.error("invalid url specification for fetchURL");c||(c=d,d=/([^\\/]+)$/.exec(c)[1]);d||(d=/([^\\/]+)$/.exec(c)[1]);f=b.allowCache||c.match(/\?/)?c:c+"?r="+Math.random();f=f.replace(/^\${JS9_DIR}\//,a.INSTALLDIR);g.open("GET",f,!0);g.responseType=b.responseType?b.responseType:"blob";a.globalOpts.xtimeout&&(g.timeout=a.globalOpts.xtimeout);g.onload=function(){var f;4===this.readyState&&(200===this.status||0===this.status?"blob"===
g.responseType?(f=new Blob([this.response]),d.match("://")?f.name=d.split("/").reverse()[0].replace(/\?.*$/,""):f.name=d,"uc"===f.name&&(f.name="google_"+a.uniqueID()+".fits"),e?e(f,b):a.Load(f,b)):b.display?e(this.response,b,{display:b.display}):e(this.response,b):404===this.status?a.error("could not find "+c):a.error(sprintf("can't load: %s %s (%s)  ",c,g.statusText,g.status)))};g.onerror=function(){a.error(sprintf("cannot load: %s %s .. please check the url/pathname",c,g.statusText))};g.ontimeout=
function(){a.error("timeout awaiting response from server: "+c)};try{g.send()}catch(h){a.error("request to load "+c+" failed",h)}};a.fitsLibrary=function(d){var c;if(!d)return a.fits.name;c=d.toLowerCase();switch(c){case "fitsy":a.fits=Fitsy;a.fits.datahandler(a.NewFitsImage);a.fits.options=a.userOpts.fits||a.fits.options||{};break;case "astroem":case "cfitsio":a.fits=Astroem;a.fits.options=a.fits.options||{};a.fits.options.handler=a.NewFitsImage;a.fits.options.error=a.error;a.userOpts.fits?(a.fits.options.extlist=
a.userOpts.fits.extlist,a.fits.options.table={xdim:a.userOpts.fits.xdim,ydim:a.userOpts.fits.ydim,bin:a.userOpts.fits.bin||1},a.fits.options.image={xdim:a.userOpts.fits.ixdim||a.userOpts.fits.xmax,ydim:a.userOpts.fits.iydim||a.userOpts.fits.ymax,bin:a.userOpts.fits.ibin||1}):(a.fits.options.extlist=a.globalOpts.extlist,a.fits.options.table={bin:a.globalOpts.table.bin||1},a.notNull(a.globalOpts.table.xdim)?a.fits.options.table.xdim=a.globalOpts.table.xdim:a.notNull(a.globalOpts.dims)&&(a.fits.options.table.xdim=
a.globalOpts.dims[0]),a.notNull(a.globalOpts.table.ydim)?a.fits.options.table.ydim=a.globalOpts.table.ydim:a.notNull(a.globalOpts.dims)&&(a.fits.options.table.ydim=a.globalOpts.dims[1]),a.fits.options.image={bin:a.globalOpts.image.bin||1},a.notNull(a.globalOpts.image.xdim)?a.fits.options.image.xdim=a.globalOpts.image.xdim:a.notNull(a.globalOpts.xmax)&&(a.fits.options.image.xdim=a.globalOpts.xmax),a.notNull(a.globalOpts.image.ydim)?a.fits.options.image.ydim=a.globalOpts.image.ydim:a.notNull(a.globalOpts.ymax)&&
(a.fits.options.image.ydim=a.globalOpts.ymax));a.fits.maxFITSMemory&&a.globalOpts.maxMemory&&a.fits.maxFITSMemory(a.globalOpts.maxMemory);break;default:a.error("unknown fits library: "+d)}a.fits.ready=!0;a.fits.name=c;a.fits.options.error=a.error;a.fits.options.waiting=a.waiting;return c};a.handleFITSFile=function(d,c,b){a.fits.handleFITSFile?a.fits.handleFITSFile(d,c,b):a.error("no FITS module available to process FITS file")};a.cleanupFITSFile=function(d,c){var b;a.localMount&&(b=new RegExp("^"+
a.localMount));return a.fits.cleanupFITSFile&&d&&d.hdu&&d.hdu.fits?(b&&d.hdu.fits.vfile&&d.hdu.fits.vfile.match(b)&&(c=!1),a.fits.cleanupFITSFile(d.hdu.fits,c),!0):!1};a.handleImageFile=function(d,c,b){var e=new FileReader;c=$.extend(!0,{},a.fits.options,c);b=b||a.Load;e.onload=function(a){var e,f,k,l=new Image;l.onload=function(){var a,g,h,q=0;a=document.createElement("canvas");g=a.getContext("2d");var t=l.height,u=l.width;a.width=u;a.height=t;g.drawImage(l,0,0);e=g.getImageData(0,0,u,t).data;f=
new Float32Array(t*u);for(g=0;g<t;g++)for(a=0;a<u;a++)h=.299*e[q]+.587*e[q+1]+.114*e[q+2],f[(t-g)*u+a]=h,q+=4;k={head:{SIMPLE:!0,BITPIX:-32,NAXIS:2,NAXIS1:u,NAXIS2:t},filename:d.name,filedata:f,naxis:2,axis:[0,u,t],bitpix:-32,bin:1,data:f};k.dmin=Number.MAX_VALUE;k.dmax=Number.MIN_VALUE;for(q=0;q<t*u;q++)isNaN(k.data[q])||(k.dmin=Math.min(k.dmin,k.data[q]),k.dmax=Math.max(k.dmax,k.data[q]));b(k,c)};l.src=a.target.result};e.readAsDataURL(d)};a.getFITSImage=function(d,c,b,e){a.fits.getFITSImage?a.fits.getFITSImage(d,
c,b,e):a.error("no FITS module available to process FITS image")};a.fits2RepFile=function(d,c,b,e,f){var g,h,k,l,n,m={},r="fits2"+e;g=b[r]||void 0===b[r]&&a.globalOpts[r];!0===g?g="always":!1===g&&(g="never");if(g.match(/never/i))return!1;if(!a.helper.connected||"nodejs"!==a.helper.type&&"socket.io"!==a.helper.type)return"always"===g&&a.globalOpts.requireFits2Fits&&a.error("can't run fits2fits without connected JS9 helper"),!1;if(!a.helper.js9helper)if(a.globalOpts.requireFits2Fits)a.error("js9helper not found for fits2fits processing");
else return!1;switch(r){case "fits2png":break;case "fits2fits":if(!a.globalOpts.workDir)return a.globalOpts.requireFits2Fits&&a.error("can't run fits2fits without a workdir"),!1;e=b.xdim||a.fits.options.image.xdim||a.fits.options.table.xdim;h=b.ydim||a.fits.options.image.ydim||a.fits.options.table.ydim;k=b.bin||a.fits.options.image.bin||a.fits.options.table.bin;l=b.binMode||a.globalOpts.binMode;l="a"===l?"a":"";"string"===typeof k&&(k.match(/[as]$/)&&(l=k.slice(-1)),k=parseInt(k,10));k=Math.max(1,
k||1);m.sect=void 0!==b.xcen&&void 0!==b.ycen?sprintf("%s@%s,%s@%s,%s%s",e,b.xcen,h,b.ycen,k,l):sprintf("%s,%s,%s%s",e,h,k,l);e=g.toLowerCase().split(/[>,]/);for(g=0;g<e.length;g++)switch(e[g]){case "size":e[g+1]&&(a.isNumber(e[g+1])&&(m.maxsize=1E6*parseFloat(e[g+1])),g++)}break;default:a.error("unknown FITS representation type: "+e)}m.fits=a.cleanPath(c);m.parent=!0;a.waiting(!0,d);a.helper.send(r,m,function(c){var e,g;c="object"===typeof c?c:0<=c.search(a.analOpts.epattern)?{stderr:c}:{stdout:c};
c.stderr&&a.error(c.stderr,a.analOpts.epattern);if(c.stdout)switch(r){case "fits2png":c=c.stdout.replace(/\n*$/,"").split("\n").pop();e=c.split(".").pop().toLowerCase();"png"===e?(b.source="fits2png",a.checkNew(new a.Image(c,b,f))):a.error("fits2png conversion failed: "+c);break;case "fits2fits":c.stdout.match(/^ERROR:/)&&(a.globalOpts.requireFits2Fits?a.error(c.stdout):c.stdout=m.fits);g=c.stdout.split(/\n/);c=a.cleanPath(g[0]);if(c===m.fits)e=$.extend(!0,{},b);else{"/"!==c.charAt(0)&&(c=a.InstallDir(c));
e=$.extend(!0,{},b);delete e.xcen;delete e.ycen;delete e.bin;void 0!==e.xdim&&(e.xdim=0);void 0!==e.ydim&&(e.ydim=0);e.source="fits2fits";e.proxyFile=c;if(g[1]){try{n=JSON.parse(g[1])}catch(v){}n&&(e.extname=n.extname,e.extnum=n.extnum,e.hdus=n.hdus,e.parent=n)}g[2]&&(g=a.cleanPath(g[2]),e.parentFile=g,e.extname?(e.parentFile=e.parentFile.replace(/\[.*\]/,""),e.parentFile+=sprintf("[%s]",e.extname)):e.extnum&&0<e.extnum&&(e.parentFile=e.parentFile.replace(/\[.*\]/,""),e.parentFile.file+=sprintf("[%s]",
e.extnum)));f&&(e.onload=f)}e.fits2fits=!1;a.Load(c,e,{display:d})}});return!0};a.lookupColormap=function(d,c){var b;void 0===c&&(c=!0);d||(d=a.imageOpts.colormap);if(d)for(b=0;b<a.colormaps.length;b++)if(a.colormaps[b].name===d)return a.colormaps[b];if(c)a.error("unknown colormap '"+d+"'");else return null};a.lookupCommand=function(d){var c,b;if(d)for(b=d.toLowerCase(),c=0;c<a.commands.length;c++)if(d=a.commands[c],d.name===b||d.alias===b||d.alias2===b)return d;return null};a.error=function(d){for(var c=
[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e=$jscomp.makeIterator(c),b=e.next().value,f=e.next().value,e=e.next().value,g,h="",k="",l=!0;a.waiting(!1);"string"===typeof f?(f=b.match(f))?f[1]?b=f[1]:f[0]&&(b=f[0]):l=!1:"object"===typeof f&&(g=f);3>c.length&&(e=!0);if(l&&(g&&g.message?b+=sprintf(" (%s)",g.message):b&&(g=Error(b)),(c=a.strace(g))&&(k="\n\nStacktrace:\n"+c),a.globalOpts.alerts&&(b&&"string"===typeof b&&0>b.search(/ERROR/)&&(h="JS9 ERROR: "),alert(h+(b+k))),e))throw g;};a.eventToCharStr=
function(d){var c,b,e={37:"leftArrow",38:"upArrow",39:"rightArrow",40:"downArrow",8:"delete",46:"delete"},f={188:"44",109:"45",190:"46",191:"47",192:"96",220:"92",222:"39",221:"93",219:"91",173:"45",187:"61",186:"59",189:"45"},g={96:"~",49:"!",50:"@",51:"#",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",48:")",45:"_",61:"+",91:"{",93:"}",92:"|",59:":",39:'"',44:"<",46:">",47:"?"};c="number"===typeof d?d:d.which||d.keyCode;b=String(c);f.hasOwnProperty(b)&&(c=f[b]);c=!d.shiftKey&&65<=c&&90>=c?String.fromCharCode(c+
32):!d.shiftKey&&e.hasOwnProperty(c)?e[c]:d.shiftKey&&g.hasOwnProperty(c)?g[c]:String.fromCharCode(c);a.specialKey(d)&&(c="M-"+c);return c};a.eventToDisplayPos=function(a,c){var b,d,f,g,h;a||(a=window.event);a.target?d=a.target:a.srcElement&&(d=a.srcElement);3===d.nodeType&&(d=d.parentNode);c=c||$(d).offset();a.originalEvent?a.originalEvent.touches&&a.originalEvent.touches.length?(h=a.originalEvent.touches,b=h[0].pageX,f=h[0].pageY):a.originalEvent.changedTouches&&a.originalEvent.changedTouches.length?
(h=a.originalEvent.changedTouches,b=h[0].pageX,f=h[0].pageY):(b=a.pageX,f=a.pageY):(b=a.pageX,f=a.pageY);d=c.left+1;g=c.top+1;f={x:Math.floor(b-d),y:Math.floor(f-g)};if(h&&h.length)for(f.touches=[{x:f.x,y:f.y}],b=1;b<h.length;b++)f.touches[b]={x:Math.floor(h[b].pageX-d),y:Math.floor(h[b].pageY-g)};return f};a.pix2pix=function(d,c,b){var e,f,g;if(!(d&&c&&d.raw.wcs&&c.raw.wcs))return b;g=b.x;b=b.y;e=a.pix2wcs(d.raw.wcs,g,b).trim().split(/\s+/);f=a.saostrtod(e[0]);":"===String.fromCharCode(a.saodtype())&&
"galactic"!==d.params.wcssys&&"ecliptic"!==d.params.wcssys&&(f*=15);d=a.saostrtod(e[1]);e=a.wcs2pix(c.raw.wcs,f,d).trim().split(/\s+/);c=parseFloat(e[0]);d=parseFloat(e[1]);.5>Math.abs(c-g)&&(c=g);.5>Math.abs(d-b)&&(d=b);return{x:c,y:d}};a.rotatePoint=function(a,c,b){var d;b=b||{x:0,y:0};c=Math.PI*c/180;d=Math.cos(c);c=Math.sin(c);return{x:d*(a.x-b.x)-c*(a.y-b.y)+b.x,y:c*(a.x-b.x)+d*(a.y-b.y)+b.y}};a.invertMatrix3=function(a){var c,b,d=0,f=0,g=a[0][0]*a[1][1],h=[[0,0,0],[0,0,0],[0,0,0]];for(c=0;3>
c;c++)for(b=0;2>b;b++)if(void 0===a[c][b]||isNaN(a[c][b]))return null;0<=g?d+=g:f+=g;g=-a[0][1]*a[1][0];0<=g?d+=g:f+=g;c=d+f;if(0===c||1E-15>Math.abs(c/(d-f)))return null;c=1/c;h[0][0]=a[1][1]*c;h[1][0]=-a[1][0]*c;h[0][1]=-a[0][1]*c;h[1][1]=a[0][0]*c;h[2][0]=-(a[2][0]*h[0][0]+a[2][1]*h[1][0]);h[2][1]=-(a[2][0]*h[0][1]+a[2][1]*h[1][1]);return h};a.log=function(a){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];if(void 0!==window.console&&void 0!==window.console.log)try{console.log.apply(console,
[].concat($jscomp.arrayFromIterable(c)))}catch(e){b=Function.prototype.bind.call(console.log,console),b.apply(console,c)}};a.isNumber=function(a){return!isNaN(parseFloat(a))&&isFinite(a)};a.notNull=function(a){return void 0!==a&&null!==a};a.isNull=function(a){return void 0===a||null===a};a.cardpars=function(d){var c=d.slice(0,8).trim();if("HISTORY"===c||"COMMENT"===c)return[c,d.slice(9).trim()];if("="===d[8])return d=d.slice(10).replace(/'/g," ").replace(/ \/.*/,"").trim(),"T"===d?d=!0:"F"===d?d=
!1:a.isNumber(d)&&(d=parseFloat(d)),[c,d]};a.raw2FITS=function(d,c){var b,e,f,g,h,k=!1,l="",n={};f=function(a,b,c,d){var e,f=a;"XTENSION"!==b||c?(e=new RegExp(b+" *= *(-?[-+]?[0-9]*.?[0-9]*([eE][-+]?[0-9]+)?) *"),a?(a=a.replace(e,"$1"),a=parseFloat(a)):a=void 0,a!==c&&(f=sprintf("%-8s= %20s / %-47s",b,c,d||""))):f=sprintf("%s  = %20s / %-47s","SIMPLE","T","file does conform to FITS standard");n[b]=!0;return f};if(!d)return l;c=c||{};"boolean"===typeof c&&(c={addcr:c});if(d.card||d.cardstr)for(h=d.header||
{},e=d.card?d.card.length:d.ncard,b=0;b<e;b++){if(g=d.card?d.card[b].slice(0,80):d.cardstr.slice(80*b,80*(b+1)),!c.notab||!g.match(/^TAB(TYP|MIN|MAX|DIM)[1,2]/)){if(g.match(/^XTENSION/)&&0===b&&c.simple)l+=f(g,"XTENSION");else if(g.match(/^BITPIX /)&&d.bitpix)l+=f(g,"BITPIX",d.bitpix,"bits/pixel");else if(g.match(/^NAXIS1 /)&&d.width)l+=f(g,"NAXIS1",d.width,"x image dim");else if(g.match(/^NAXIS2 /)&&d.height)l+=f(g,"NAXIS2",d.height,"y image dim");else if(g.match(/^CRPIX1 /)&&a.notNull(h.CRPIX1))l+=
f(g,"CRPIX1",h.CRPIX1,"ref point");else if(g.match(/^CRPIX2 /)&&a.notNull(h.CRPIX2))l+=f(g,"CRPIX2",h.CRPIX2,"ref point");else if(g.match(/^CDELT1 /)&&a.notNull(h.CDELT1))l+=f(g,"CDELT1",h.CDELT1,"deg/pixel");else if(g.match(/^CDELT2 /)&&a.notNull(h.CDELT2))l+=f(g,"CDELT2",h.CDELT2,"deg/pixel");else if(g.match(/^CD1_1 /)&&a.notNull(h.CD1_1))l+=f(g,"CD1_1",h.CD1_1,"WCS matrix value");else if(g.match(/^CD1_2 /)&&a.notNull(h.CD1_2))l+=f(g,"CD1_2",h.CD1_2,"WCS matrix value");else if(g.match(/^CD2_1 /)&&
a.notNull(h.CD2_1))l+=f(g,"CD2_1",h.CD2_1,"WCS matrix value");else if(g.match(/^CD2_2 /)&&a.notNull(h.CD2_2))l+=f(g,"CD2_2",h.CD2_2,"WCS matrix value");else if(g.match(/^LTV1 /)&&a.notNull(h.LTV1))l+=f(g,"LTV1",h.LTV1,"IRAF ref. point");else if(g.match(/^LTV2 /)&&a.notNull(h.LTV2))l+=f(g,"LTV2",h.LTV2,"IRAF ref. point");else if(g.match(/^LTM1_1 /)&&a.notNull(h.LTM1_1))l+=f(g,"LTM1_1",h.LTM1_1,"IRAF matrix value");else if(g.match(/^LTM1_2 /)&&a.notNull(h.LTM1_2))l+=f(g,"LTM1_2",h.LTM1_2,"IRAF matrix value");
else if(g.match(/^LTM2_1 /)&&a.notNull(h.LTM2_1))l+=f(g,"LTM2_1",h.LTM2_1,"IRAF matrix value");else if(g.match(/^LTM2_2 /)&&a.notNull(h.LTM2_2))l+=f(g,"LTM2_2",h.LTM2_2,"IRAF matrix value");else if(c.twoaxes&&g.match(/^NAXIS /))l+=f(g,"NAXIS",2,"number of data axes");else if(c.twoaxes&&g.match(/^(NAXIS|CRPIX|CRVAL|CTYPE|CUNIT|CDELT)[34567]/))continue;else if(c.twoaxes&&g.match(/^(DATASUM|CHECKSUM)/))continue;else"END "===g.substring(0,4)?(a.notNull(h.LTV1)&&!n.LTV1&&(l+=f(null,"LTV1",h.LTV1,"IRAF ref. point"),
c.addcr&&(l+="\n")),a.notNull(h.LTV2)&&!n.LTV2&&(l+=f(null,"LTV2",h.LTV2,"IRAF ref. point"),c.addcr&&(l+="\n")),a.notNull(h.LTM1_1)&&!n.LTM1_1&&(l+=f(null,"LTM1_1",h.LTM1_1,"IRAF matrix value"),c.addcr&&(l+="\n")),a.notNull(h.LTM1_2)&&!n.LTM1_2&&(l+=f(null,"LTM1_2",h.LTM1_2,"IRAF matrix value"),c.addcr&&(l+="\n")),a.notNull(h.LTM2_1)&&!n.LTM2_1&&(l+=f(null,"LTM2_1",h.LTM2_1,"IRAF matrix value"),c.addcr&&(l+="\n")),a.notNull(h.LTM2_2)&&!n.LTM2_2&&(l+=f(null,"LTM2_2",h.LTM2_2,"IRAF matrix value"),c.addcr&&
(l+="\n")),l+=g,k=!0):l+=g;c.addcr&&(l+="\n")}}else if(d.header||d.BITPIX){f=d.header?d.header:d;if(void 0!==f.SIMPLE||void 0!==f.simple)b=void 0!==f.SIMPLE?f.SIMPLE:f.simple,!0===b?b="T":!1===b&&(b="F"),l+=sprintf("%-8s= %20s / %-47s","SIMPLE",b,"conforms to FITS standard"),c.addcr&&(l+="\n");if(void 0!==f.BITPIX||void 0!==f.bitpix)b=void 0!==f.BITPIX?f.BITPIX:f.bitpix,l+=sprintf("%-8s= %20s / %-47s","BITPIX",b,"bits/pixel"),c.addcr&&(l+="\n");for(g in f)if(f.hasOwnProperty(g)&&"js9Protocol"!==g&&
"js9Endian"!==g&&"SIMPLE"!==g&&"simple"!==g&&"BITPIX"!==g&&"bitpix"!==g){"END"===g&&(k=!0);if(g.match(/HISTORY__[0-9]+/))l+=sprintf("HISTORY %-72s",f[g]);else if(g.match(/COMMENT__[0-9]+/))l+=sprintf("COMMENT %-72s",f[g]);else{b=f[g];!0===b?b="T":!1===b?b="F":""===b?b="' '":a.isNumber(b)||"'"===b.charAt(0)||(b="'"+b+"'");e=sprintf("%-8s= %20s",g,b);h=80-e.length;if(0<h)for(b=0;b<h;b++)e+=" ";l+=e}c.addcr&&(l+="\n")}}k||(l+=sprintf("%-8s%-72s","END"," "),c.addcr&&(l+="\n"));return l};a.hdus2Str=function(a){var c,
b,d,f="";if(!a)return f;for(c=0;c<a.length;c++){d=a[c];b=d.name?d.name:0===c?"Primary":"N/A";f+=sprintf("<b>#%d</b>:&#09;<b>name</b>: %s&#09;<b>type</b>: %s",d.hdu,b,d.type);switch(d.type){case "image":f+=sprintf("&#09;<b>bitpix</b>: %d&#09;<b>naxis</b>: %d",d.bitpix,d.naxis);if(d.naxes.length){f+="&#09;<b>axes</b>: [";for(b=0;b<d.naxes.length;b++)f+=sprintf("%d",d.naxes[b]),b!==d.naxes.length-1&&(f+=", ");f+="]"}break;case "table":case "ascii":b="&#09;";9>=d.rows&&(b+="&#09;");f+=sprintf("&#09;<b>rows</b>: %d%s<b>cols</b>: [",
d.rows,b);for(b=0;b<d.cols.length;b++)f+=sprintf("%s",d.cols[b].name),b!==d.cols.length-1&&(f+=", ");f+="]"}f+="\n\n"}return f};CanvasRenderingContext2D.prototype.clear=CanvasRenderingContext2D.prototype.clear||function(a){a&&(this.save(),this.setTransform(1,0,0,1,0,0));this.clearRect(0,0,this.canvas.width,this.canvas.height);a&&this.restore()};a.tooltip=function(d,c,b,e,f,g){var h;h=function(b){return b.replace(/\$([a-zA-Z0-9_./]+)/g,function(b,c,d){c=c.split(".");switch(c[0]){case "im":d=e;break;
case "xreg":d=f;break;case "evt":d=g;break;default:return b}for(b=1;b<c.length;b++)d=d[c[b]],d=a.isNumber(d)?d.toFixed(6):d;void 0===d&&(d="");return d})};b?(b=h(b),e.display.tooltip.html(b),h=e.display.tooltip.width(),b=e.display.tooltip.height(),d=Math.max(2,Math.min(d,e.display.width-(h+10))),c=Math.max(2,Math.min(c,e.display.height-(b+10))),e.display.tooltip.css({left:d,top:c,display:"inline-block"})):e.display.tooltip.html("").css({left:-9999,display:"none"})};a.xeqByName=function(d){for(var c=
[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e,f,g,b=$jscomp.makeIterator(c);e=b.next().value;b=b.next().value;c=c.slice(2);f=typeof e;switch(f){case "function":return e.apply(b,c);case "string":f=e.split(".");g=f.pop();for(e=0;e<f.length;e++)b=b[f[e]];return b[g].apply(null,[].concat($jscomp.arrayFromIterable(c)));default:a.error("unknown function type: "+f)}};a.varByName=function(d,c){var b,e,f;c=c||a;e=d.split(".");f=e.pop();for(b=0;b<e.length;b++)if(c=c[e[b]],!c)return null;return c[f]};
a.mergePrefs=function(d){var c,b,e;for(e in d)if(d.hasOwnProperty(e)&&a.hasOwnProperty(e)&&(b=typeof a[e],c=typeof d[e],b===c||"string"===c))switch(b){case "object":$.isArray(d[e])?a[e]=d[e]:$.extend(a[e],d[e]);break;case "number":case "string":a[e]=d[e]}};a.loadPrefs=function(d,c){$.ajax({url:d,cache:!1,dataType:"json",mimeType:"application/json",async:!1,success:function(b){a.mergePrefs(b)},error:function(b,e,f){c&&(a.CHROMEFILEWARNING&&"Chrome"===a.BROWSER[0]&&""===document.domain&&f&&f.message&&
f.message.match(/Failed to execute 'send' on 'XMLHttpRequest'/)?(alert("When using the file:// URI, Chrome must be run with the --allow-file-access-from-files switch to permit JS9 to access the preference file (and data files)."),a.CHROMEFILEWARNING=!1):a.log("JS9 prefs file not available: %s",d))}})};a.isTypedArray=function(a){a=Object.prototype.toString.call(a);return{"[object Int8Array]":!0,"[object Uint8Array]":!0,"[object Uint8ClampedArray]":!0,"[object Int16Array]":!0,"[object Uint16Array]":!0,
"[object Int32Array]":!0,"[object Uint32Array]":!0,"[object Float32Array]":!0,"[object Float64Array]":!0}.hasOwnProperty(a)};a.Starbase=function(a,c){var b,d,f,g,h,k=0;h=function(a){var b;for(b=0;b<a.length;b++)if(null===a[b].match(/^-+$/))return 0;return b};d=function(a){return a};this.head={};this.convFuncs=[];this.data=[];this.delims=[];if(a){c=c||{};g=a.replace(/\s+$/,"").split("\n");if(c.skip&&(f=c.skip.split(""))&&f.length)for(;k<g.length&&(f[0]===g[k][0]||"\n"===f[1]&&""===g[k]);k++);if(void 0!==
g[k]&&void 0!==g[k+1]){this.headline=g[k++].trim().split(/ *\t */);c.units&&(this.unitline=g[k++].trim().split(/ *\t */));this.dashline=g[k++].trim().split(/ *\t */);for(b=h(this.dashline);0===b||b!==this.headline.length;)c.units?(this.headline=this.unitline,this.unitline=this.dashline):this.headline=this.dashline,this.dashline=g[k++].trim().split(/ *\t */),b=h(this.dashline);for(b=0;b<this.headline.length;b++)this.headline[b]=this.headline[b].replace(/\./g,"_"),this.convFuncs[b]=c.convFuncs&&c.convFuncs[this.headline[b]]?
c.convFuncs[this.headline[b]]:c.convFuncs&&c.convFuncs.def?c.convFuncs.def:d;for(d=0;k<g.length&&(!f||!f.length||f[0]!==g[k][0]&&("\n"!==f[1]||""!==g[k]));k++,d++)for(this.data[d]=g[k].split("\t"),b=0;b<this.data[d].length;b++)h=this.convFuncs[b](this.data[d][b]),this.data[d][b]=h.val,this.delims[b]=h.delim||null;for(b=0;b<this.headline.length;b++)this[this.headline[b]]=b}}};a.colorToHex=function(a){var c;c={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",
beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",
darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4","indianred ":"#cd5c5c",
indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",
mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",
palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",
thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd3",antiquewhite1:"#ffefdb",antiquewhite2:"#eedfcc",antiquewhite3:"#cdc0b0",antiquewhite4:"#8b8378",cadetblue1:"#98f5ff",cadetblue2:"#8ee5ee",cadetblue3:"#7ac5cd",cadetblue4:"#53868b",darkgoldenrod1:"#ffb90f",darkgoldenrod2:"#eead0e",darkgoldenrod3:"#cd950c",darkgoldenrod4:"#8b6508",darkgrey:"#a9a9a9",darkolivegreen1:"#caff70",darkolivegreen2:"#bcee68",
darkolivegreen3:"#a2cd5a",darkolivegreen4:"#6e8b3d",darkorange1:"#ff7f00",darkorange2:"#ee7600",darkorange3:"#cd6600",darkorange4:"#8b4500",darkorchid1:"#bf3eff",darkorchid2:"#b23aee",darkorchid3:"#9a32cd",darkorchid4:"#68228b",darkseagreen1:"#c1ffc1",darkseagreen2:"#b4eeb4",darkseagreen3:"#9bcd9b",darkseagreen4:"#698b69",darkslategray1:"#97ffff",darkslategray2:"#8deeee",darkslategray3:"#79cdcd",darkslategray4:"#528b8b",darkslategrey:"#2f4f4f",deeppink1:"#ff1493",deeppink2:"#ee1289",deeppink3:"#cd1076",
deeppink4:"#8b0a50",deepskyblue1:"#00bfff",deepskyblue2:"#00b2ee",deepskyblue3:"#009acd",deepskyblue4:"#00688b",dimgrey:"#696969",dodgerblue1:"#1e90ff",dodgerblue2:"#1c86ee",dodgerblue3:"#1874cd",dodgerblue4:"#104e8b",hotpink1:"#ff6eb4",hotpink2:"#ee6aa7",hotpink3:"#cd6090",hotpink4:"#8b3a62",indianred:"#cd5c5c",indianred1:"#ff6a6a",indianred2:"#ee6363",indianred3:"#cd5555",indianred4:"#8b3a3a",lavenderblush1:"#fff0f5",lavenderblush2:"#eee0e5",lavenderblush3:"#cdc1c5",lavenderblush4:"#8b8386",lemonchiffon1:"#fffacd",
lemonchiffon2:"#eee9bf",lemonchiffon3:"#cdc9a5",lemonchiffon4:"#8b8970",lightblue1:"#bfefff",lightblue2:"#b2dfee",lightblue3:"#9ac0cd",lightblue4:"#68838b",lightcyan1:"#e0ffff",lightcyan2:"#d1eeee",lightcyan3:"#b4cdcd",lightcyan4:"#7a8b8b",lightgoldenrod:"#eedd82",lightgoldenrod1:"#ffec8b",lightgoldenrod2:"#eedc82",lightgoldenrod3:"#cdbe70",lightgoldenrod4:"#8b814c",lightgray:"#d3d3d3",lightpink1:"#ffaeb9",lightpink2:"#eea2ad",lightpink3:"#cd8c95",lightpink4:"#8b5f65",lightsalmon1:"#ffa07a",lightsalmon2:"#ee9572",
lightsalmon3:"#cd8162",lightsalmon4:"#8b5742",lightskyblue1:"#b0e2ff",lightskyblue2:"#a4d3ee",lightskyblue3:"#8db6cd",lightskyblue4:"#607b8b",lightslateblue:"#8470ff",lightslategrey:"#778899",lightsteelblue1:"#cae1ff",lightsteelblue2:"#bcd2ee",lightsteelblue3:"#a2b5cd",lightsteelblue4:"#6e7b8b",lightyellow1:"#ffffe0",lightyellow2:"#eeeed1",lightyellow3:"#cdcdb4",lightyellow4:"#8b8b7a",mediumorchid1:"#e066ff",mediumorchid2:"#d15fee",mediumorchid3:"#b452cd",mediumorchid4:"#7a378b",mediumpurple1:"#ab82ff",
mediumpurple2:"#9f79ee",mediumpurple3:"#8968cd",mediumpurple4:"#5d478b",mistyrose1:"#ffe4e1",mistyrose2:"#eed5d2",mistyrose3:"#cdb7b5",mistyrose4:"#8b7d7b",navajowhite1:"#ffdead",navajowhite2:"#eecfa1",navajowhite3:"#cdb38b",navajowhite4:"#8b795e",navyblue:"#000080",olivedrab1:"#c0ff3e",olivedrab2:"#b3ee3a",olivedrab3:"#9acd32",olivedrab4:"#698b22",orangered1:"#ff4500",orangered2:"#ee4000",orangered3:"#cd3700",orangered4:"#8b2500",palegreen1:"#9aff9a",palegreen2:"#90ee90",palegreen3:"#7ccd7c",palegreen4:"#548b54",
paleturquoise1:"#bbffff",paleturquoise2:"#aeeeee",paleturquoise3:"#96cdcd",paleturquoise4:"#668b8b",palevioletred1:"#ff82ab",palevioletred2:"#ee799f",palevioletred3:"#cd6889",palevioletred4:"#8b475d",peachpuff1:"#ffdab9",peachpuff2:"#eecbad",peachpuff3:"#cdaf95",peachpuff4:"#8b7765",rosybrown1:"#ffc1c1",rosybrown2:"#eeb4b4",rosybrown3:"#cd9b9b",rosybrown4:"#8b6969",royalblue1:"#4876ff",royalblue2:"#436eee",royalblue3:"#3a5fcd",royalblue4:"#27408b",seagreen1:"#54ff9f",seagreen2:"#4eee94",seagreen3:"#43cd80",
seagreen4:"#2e8b57",skyblue1:"#87ceff",skyblue2:"#7ec0ee",skyblue3:"#6ca6cd",skyblue4:"#4a708b",slateblue1:"#836fff",slateblue2:"#7a67ee",slateblue3:"#6959cd",slateblue4:"#473c8b",slategray1:"#c6e2ff",slategray2:"#b9d3ee",slategray3:"#9fb6cd",slategray4:"#6c7b8b",slategrey:"#708090",springgreen1:"#00ff7f",springgreen2:"#00ee76",springgreen3:"#00cd66",springgreen4:"#008b45",steelblue1:"#63b8ff",steelblue2:"#5cacee",steelblue3:"#4f94cd",steelblue4:"#36648b",violetred:"#d02090",violetred1:"#ff3e96",
violetred2:"#ee3a8c",violetred3:"#cd3278",violetred4:"#8b2252",webgray:"#808080",webgreen:"#008000",webgrey:"#808080",webmaroon:"#800000",webpurple:"#800080",x11gray:"#bebebe",x11green:"#00ff00",x11grey:"#bebebe",x11maroon:"#b03060",x11purple:"#a020f0",aquamarine1:"#7fffd4",aquamarine2:"#76eec6",aquamarine3:"#66cdaa",aquamarine4:"#458b74",azure1:"#f0ffff",azure2:"#e0eeee",azure3:"#c1cdcd",azure4:"#838b8b",bisque1:"#ffe4c4",bisque2:"#eed5b7",bisque3:"#cdb79e",bisque4:"#8b7d6b",blue1:"#0000ff",blue2:"#0000ee",
blue3:"#0000cd",blue4:"#00008b",brown1:"#ff4040",brown2:"#ee3b3b",brown3:"#cd3333",brown4:"#8b2323",burlywood1:"#ffd39b",burlywood2:"#eec591",burlywood3:"#cdaa7d",burlywood4:"#8b7355",chartreuse1:"#7fff00",chartreuse2:"#76ee00",chartreuse3:"#66cd00",chartreuse4:"#458b00",chocolate1:"#ff7f24",chocolate2:"#ee7621",chocolate3:"#cd661d",chocolate4:"#8b4513",coral1:"#ff7256",coral2:"#ee6a50",coral3:"#cd5b45",coral4:"#8b3e2f",cornsilk1:"#fff8dc",cornsilk2:"#eee8cd",cornsilk3:"#cdc8b1",cornsilk4:"#8b8878",
cyan1:"#00ffff",cyan2:"#00eeee",cyan3:"#00cdcd",cyan4:"#008b8b",firebrick1:"#ff3030",firebrick2:"#ee2c2c",firebrick3:"#cd2626",firebrick4:"#8b1a1a",gold1:"#ffd700",gold2:"#eec900",gold3:"#cdad00",gold4:"#8b7500",goldenrod1:"#ffc125",goldenrod2:"#eeb422",goldenrod3:"#cd9b1d",goldenrod4:"#8b6914",gray0:"#000000",gray1:"#030303",gray10:"#1a1a1a",gray100:"#ffffff",gray11:"#1c1c1c",gray12:"#1f1f1f",gray13:"#212121",gray14:"#242424",gray15:"#262626",gray16:"#292929",gray17:"#2b2b2b",gray18:"#2e2e2e",gray19:"#303030",
gray2:"#050505",gray20:"#333333",gray21:"#363636",gray22:"#383838",gray23:"#3b3b3b",gray24:"#3d3d3d",gray25:"#404040",gray26:"#424242",gray27:"#454545",gray28:"#474747",gray29:"#4a4a4a",gray3:"#080808",gray30:"#4d4d4d",gray31:"#4f4f4f",gray32:"#525252",gray33:"#545454",gray34:"#575757",gray35:"#595959",gray36:"#5c5c5c",gray37:"#5e5e5e",gray38:"#616161",gray39:"#636363",gray4:"#0a0a0a",gray40:"#666666",gray41:"#696969",gray42:"#6b6b6b",gray43:"#6e6e6e",gray44:"#707070",gray45:"#737373",gray46:"#757575",
gray47:"#787878",gray48:"#7a7a7a",gray49:"#7d7d7d",gray5:"#0d0d0d",gray50:"#7f7f7f",gray51:"#828282",gray52:"#858585",gray53:"#878787",gray54:"#8a8a8a",gray55:"#8c8c8c",gray56:"#8f8f8f",gray57:"#919191",gray58:"#949494",gray59:"#969696",gray6:"#0f0f0f",gray60:"#999999",gray61:"#9c9c9c",gray62:"#9e9e9e",gray63:"#a1a1a1",gray64:"#a3a3a3",gray65:"#a6a6a6",gray66:"#a8a8a8",gray67:"#ababab",gray68:"#adadad",gray69:"#b0b0b0",gray7:"#121212",gray70:"#b3b3b3",gray71:"#b5b5b5",gray72:"#b8b8b8",gray73:"#bababa",
gray74:"#bdbdbd",gray75:"#bfbfbf",gray76:"#c2c2c2",gray77:"#c4c4c4",gray78:"#c7c7c7",gray79:"#c9c9c9",gray8:"#141414",gray80:"#cccccc",gray81:"#cfcfcf",gray82:"#d1d1d1",gray83:"#d4d4d4",gray84:"#d6d6d6",gray85:"#d9d9d9",gray86:"#dbdbdb",gray87:"#dedede",gray88:"#e0e0e0",gray89:"#e3e3e3",gray9:"#171717",gray90:"#e5e5e5",gray91:"#e8e8e8",gray92:"#ebebeb",gray93:"#ededed",gray94:"#f0f0f0",gray95:"#f2f2f2",gray96:"#f5f5f5",gray97:"#f7f7f7",gray98:"#fafafa",gray99:"#fcfcfc",green1:"#00ff00",green2:"#00ee00",
green3:"#00cd00",green4:"#008b00",grey:"#bebebe",grey0:"#000000",grey1:"#030303",grey10:"#1a1a1a",grey100:"#ffffff",grey11:"#1c1c1c",grey12:"#1f1f1f",grey13:"#212121",grey14:"#242424",grey15:"#262626",grey16:"#292929",grey17:"#2b2b2b",grey18:"#2e2e2e",grey19:"#303030",grey2:"#050505",grey20:"#333333",grey21:"#363636",grey22:"#383838",grey23:"#3b3b3b",grey24:"#3d3d3d",grey25:"#404040",grey26:"#424242",grey27:"#454545",grey28:"#474747",grey29:"#4a4a4a",grey3:"#080808",grey30:"#4d4d4d",grey31:"#4f4f4f",
grey32:"#525252",grey33:"#545454",grey34:"#575757",grey35:"#595959",grey36:"#5c5c5c",grey37:"#5e5e5e",grey38:"#616161",grey39:"#636363",grey4:"#0a0a0a",grey40:"#666666",grey41:"#696969",grey42:"#6b6b6b",grey43:"#6e6e6e",grey44:"#707070",grey45:"#737373",grey46:"#757575",grey47:"#787878",grey48:"#7a7a7a",grey49:"#7d7d7d",grey5:"#0d0d0d",grey50:"#7f7f7f",grey51:"#828282",grey52:"#858585",grey53:"#878787",grey54:"#8a8a8a",grey55:"#8c8c8c",grey56:"#8f8f8f",grey57:"#919191",grey58:"#949494",grey59:"#969696",
grey6:"#0f0f0f",grey60:"#999999",grey61:"#9c9c9c",grey62:"#9e9e9e",grey63:"#a1a1a1",grey64:"#a3a3a3",grey65:"#a6a6a6",grey66:"#a8a8a8",grey67:"#ababab",grey68:"#adadad",grey69:"#b0b0b0",grey7:"#121212",grey70:"#b3b3b3",grey71:"#b5b5b5",grey72:"#b8b8b8",grey73:"#bababa",grey74:"#bdbdbd",grey75:"#bfbfbf",grey76:"#c2c2c2",grey77:"#c4c4c4",grey78:"#c7c7c7",grey79:"#c9c9c9",grey8:"#141414",grey80:"#cccccc",grey81:"#cfcfcf",grey82:"#d1d1d1",grey83:"#d4d4d4",grey84:"#d6d6d6",grey85:"#d9d9d9",grey86:"#dbdbdb",
grey87:"#dedede",grey88:"#e0e0e0",grey89:"#e3e3e3",grey9:"#171717",grey90:"#e5e5e5",grey91:"#e8e8e8",grey92:"#ebebeb",grey93:"#ededed",grey94:"#f0f0f0",grey95:"#f2f2f2",grey96:"#f5f5f5",grey97:"#f7f7f7",grey98:"#fafafa",grey99:"#fcfcfc",honeydew1:"#f0fff0",honeydew2:"#e0eee0",honeydew3:"#c1cdc1",honeydew4:"#838b83",ivory1:"#fffff0",ivory2:"#eeeee0",ivory3:"#cdcdc1",ivory4:"#8b8b83",khaki1:"#fff68f",khaki2:"#eee685",khaki3:"#cdc673",khaki4:"#8b864e",magenta1:"#ff00ff",magenta2:"#ee00ee",magenta3:"#cd00cd",
magenta4:"#8b008b",maroon1:"#ff34b3",maroon2:"#ee30a7",maroon3:"#cd2990",maroon4:"#8b1c62",orange1:"#ffa500",orange2:"#ee9a00",orange3:"#cd8500",orange4:"#8b5a00",orchid1:"#ff83fa",orchid2:"#ee7ae9",orchid3:"#cd69c9",orchid4:"#8b4789",pink1:"#ffb5c5",pink2:"#eea9b8",pink3:"#cd919e",pink4:"#8b636c",plum1:"#ffbbff",plum2:"#eeaeee",plum3:"#cd96cd",plum4:"#8b668b",purple1:"#9b30ff",purple2:"#912cee",purple3:"#7d26cd",purple4:"#551a8b",red1:"#ff0000",red2:"#ee0000",red3:"#cd0000",red4:"#8b0000",salmon1:"#ff8c69",
salmon2:"#ee8262",salmon3:"#cd7054",salmon4:"#8b4c39",seashell1:"#fff5ee",seashell2:"#eee5de",seashell3:"#cdc5bf",seashell4:"#8b8682",sienna1:"#ff8247",sienna2:"#ee7942",sienna3:"#cd6839",sienna4:"#8b4726",snow1:"#fffafa",snow2:"#eee9e9",snow3:"#cdc9c9",snow4:"#8b8989",tan1:"#ffa54f",tan2:"#ee9a49",tan3:"#cd853f",tan4:"#8b5a2b",thistle1:"#ffe1ff",thistle2:"#eed2ee",thistle3:"#cdb5cd",thistle4:"#8b7b8b",tomato1:"#ff6347",tomato2:"#ee5c42",tomato3:"#cd4f39",tomato4:"#8b3626",turquoise1:"#00f5ff",turquoise2:"#00e5ee",
turquoise3:"#00c5cd",turquoise4:"#00868b",wheat1:"#ffe7ba",wheat2:"#eed8ae",wheat3:"#cdba96",wheat4:"#8b7e66",yellow1:"#ffff00",yellow2:"#eeee00",yellow3:"#cdcd00",yellow4:"#8b8b00"};var b;if(!a)return"";b=a.toLowerCase();return"undefined"!==typeof c[b]?c[b]:(c=a.match(/rgb\((\d+)[,\s]+(\d+)[,\s]+(\d+)\)/i))?sprintf("#%02x%02x%02x",c[1],c[2],c[3]):a};a.strtoscaled=function(d){d=a.saostrtod(d);var c=String.fromCharCode(a.saodtype());switch(c){case '"':d/=3600;break;case "'":d/=60;break;case "r":d*=
180/Math.PI}return{dval:d,dtype:c}};a.cleanPath=function(a){return a?a.trim().replace(/\/\.\//,"/").replace(/^\.\//,""):""};a.fixPath=function(d,c){c=c||{};window.isElectron&&window.currentDir&&a.desktopOpts.currentPath&&!1!==c.fixpath&&!d.match(a.URLEXP)&&(d.match(/^\${JS9_DIR}/)&&(d=d.replace(/^\${JS9_DIR}\//,a.INSTALLDIR)),"/"!==d.charAt(0)&&(d=window.currentDir+"/"+d));return d};a.localAccess=function(d){var c;if(!d||!a.globalOpts.localAccess||!a.localMount)return null;d=d.replace(/\[.*\]/,"");
c="."+d.split(".").pop().toLowerCase();d=a.localMount+"/"+d;return 0<=a.vsize(d)&&0<=$.inArray(c,a.globalOpts.localTemplates.split(","))?(2<a.DEBUG&&a.log("local access file: %s",d),d):null};a.dirname=function(a){return a&&-1!==a.indexOf("/")?a.match(/.*\//)[0]:""};a.mouseDownCB=function(d){var c=d.data,b=c.image;if(b){d.target&&(b.posOffset=$(d.target).offset());b.pos0=a.eventToDisplayPos(d,b.posOffset);b.pos=b.pos0;b.ipos0=b.displayToImagePos(b.pos);b.ipos=b.ipos0;c.resizing=c.inResize(b.pos);if(!c.resizing){d.preventDefault();
a.hasOwnProperty("MouseTouch")&&a.MouseTouch.action(b,d,"start");if(b.clickInRegion&&"regions"===b.clickInLayer){b.display.clearMessage("regions");return}a.specialKey(d)||b.xeqPlugins("mouse","onmousedown",d)}b.clickState=d.which;switch(d.which){case 3:b.clickState=2}d.originalEvent&&d.originalEvent.touches&&d.originalEvent.touches.length&&(b.clickState=-d.originalEvent.touches.length);$(document).on("mousemove."+c.id,c,function(b){return a.mouseMoveCB(b)});$(document).on("mouseup."+c.id,c,function(b){return a.mouseUpCB(b)})}};
a.mouseUpCB=function(d){var c,b,e=d.data;if(c=e.image){c.pos=a.eventToDisplayPos(d,c.posOffset);c.ipos=c.displayToImagePos(c.pos);b=Math.abs(c.pos0.x-c.pos.x)<a.NOMOVE&&Math.abs(c.pos0.y-c.pos.y)<a.NOMOVE;e.inResize(c.pos)||d.preventDefault();a.hasOwnProperty("MouseTouch")&&a.MouseTouch.action(c,d,"stop");c.clickInRegion&&c.clickInLayer&&(b?1===fabric.major_version&&c.updateShapes(c.clickInLayer,"selected","select"):c.updateShapes(c.clickInLayer,"selected","update"));if(!a.specialKey(d)){c.xeqPlugins("mouse",
"onmouseup",d);if(b&&(c.xeqPlugins("mouse","onclick",d),a.hasOwnProperty("Menubar")))a.Menubar.onclick(c.display);"click"===a.globalOpts.dynamicSelect&&a.Dysel.getDisplayOr(e)!==e&&a.Dysel.select(e)}c.clickInRegion=!1;c.clickInLayer=null;c.clickState=0;c.posOffset=null;e.resizing&&(e.resizing=!1,a.bugs.webkit_resize&&(d=parseInt(e.divjq.css("width"),10),b=parseInt(e.divjq.css("height"),10),d<e.owidth&&e.divjq.css("width",e.owidth+a.RESIZEFUDGE),b<e.oheight&&e.divjq.css("height",e.oheight+a.RESIZEFUDGE)),
a.globalOpts.resizeRedisplay||(c.displayImage("all"),c.refreshLayers()));$(document).off("mouseup."+e.id);$(document).off("mousemove."+e.id);for(c=0;c<a.displays.length;c++)d=a.displays[c],d!==e&&d.image&&d.image.clickState&&d.divjq.trigger("mouseup")}else if(a.hasOwnProperty("Menubar"))a.Menubar.onclick(d.data)};a.mouseMoveCB=function(d){var c;c=d.data;var b=c.image;!b||a.specialKey(d)||(b.pos=a.eventToDisplayPos(d,b.posOffset),b.ipos=b.displayToImagePos(b.pos),b.pos0||(b.pos0=b.pos),b.ipos0||(b.ipos0=
b.ipos),c.resizing)||(d.preventDefault(),b.valpos=null,b.clickInRegion&&"regions"===b.clickInLayer&&(c=b.display.layers.regions.params.sel)&&((b.params.listonchange||c.params.listonchange||a.globalOpts.intensivePlugins)&&b.updateShape("regions",c,null,"move"),(b.params.listonchange||c.params.listonchange)&&b.listRegions("selected",{mode:2}),a.globalOpts.intensivePlugins&&b.xeqPlugins("region","onregionsmove",c.pub)),a.hasOwnProperty("MouseTouch")&&a.MouseTouch.action(b,d),a.hasOwnProperty("Crosshair")&&
b.tmp.arrowCrosshairVisible&&!b.params.crosshair&&a.Crosshair.hide(b,b.ipos,d),b.valpos||(b.valpos=b.updateValpos(b.ipos,!1)),a.specialKey(d)||b.xeqPlugins("mouse","onmousemove",d))};a.mouseEnterCB=function(d){var c=d.data,b=c.image;d.preventDefault();b&&(a.specialKey(d)||"move"===a.globalOpts.dynamicSelect&&a.Dysel.getDisplayOr(c)!==c&&a.Dysel.select(c))};a.mouseOverCB=function(d){var c=d.data.image,b=$(document).scrollLeft(),e=$(document).scrollTop();d.preventDefault();c&&(c.display.displayConjq.focus(),
window.scrollTo(b,e),a.specialKey(d)||(c.pos=a.eventToDisplayPos(d),c.ipos=c.displayToImagePos(c.pos),a.specialKey(d)||c.xeqPlugins("mouse","onmouseover",d)))};a.mouseOutCB=function(d){var c=d.data.image;d.preventDefault();c&&(c.display.displayConjq.blur(),c.clickInRegion&&c.clickInLayer&&c.updateShapes(c.clickInLayer,"selected","mouseout"),a.specialKey(d)||(c.pos=a.eventToDisplayPos(d),c.ipos=c.displayToImagePos(c.pos),a.specialKey(d)||c.xeqPlugins("mouse","onmouseout",d)))};a.wheelCB=function(d){var c=
d.data,b=c.image;c.mousetouchZoom&&b&&a.hasOwnProperty("MouseTouch")&&a.MouseTouch.Actions["wheel zoom"]&&(a.MouseTouch.Actions["wheel zoom"](b,d),d.preventDefault())};a.keyPressCB=function(a){var c=a.data.image;a.preventDefault();c&&c.xeqPlugins("keypress","onkeypress",a)};a.keyDownCB=function(d){var c,b=d.data.image;d.preventDefault();a.hasOwnProperty("Keyboard")&&(c=b?b.ipos:{x:null,y:null},a.Keyboard.action(b,c,d));b&&b.xeqPlugins("keypress","onkeydown",d)};a.keyUpCB=function(a){var c=a.data.image;
c&&c.xeqPlugins("keypress","onkeyup",a)};a.dragenterCB=function(a,c){c.stopPropagation();c.preventDefault()};a.dragoverCB=function(a,c){c.stopPropagation();c.preventDefault()};a.dragexitCB=function(a,c){c.stopPropagation();c.preventDefault()};a.dragdropCB=function(d,c){var b,e,f,g,h;c.originalEvent&&(c=c.originalEvent);c.stopPropagation();c.preventDefault();f=$.extend(!0,{},a.fits.options);f.display=f.display||d;f.extlist=f.extlist||a.globalOpts.extlist;g=c.target.files||c.dataTransfer.files;h=a.lookupDisplay(f.display);
g.length?window.setTimeout(function(){var c,d;for(b=0;b<g.length;b++)c=g[b],d=c.path||c.name||"",d.match(/\.reg$/)?a.LoadRegions(c,{display:f.display}):d.match(/\.cat$/)?a.LoadCatalog(null,c,{display:f.display}):d.match(/\.ses$/)?a.LoadSession(c,{display:f.display}):d.match(/\.js9ses$/)?a.LoadSession(c,{display:f.display}):d.match(/\.cmap$/)?a.LoadColormap(c):(a.waiting(!0,h),f.refresh=a.globalOpts.refreshDragDrop,f.localAccess=!0,a.Load(c,f,{display:f.display}))},a.SPINOUT):(e=c.dataTransfer.getData("text"),
e.match(a.URLEXP)&&a.globalOpts.loadProxy&&a.LoadProxy(e,{display:f.display}))};a.RegisterPlugin=function(d,c,b,e){var f,g;d&&c&&b&&(f=d+c,e?(e.viewMenuItem&&(e.menuItem=e.viewMenuItem),e.menuItem&&!e.menu&&(e.menu="view"),e.menu&&(e.menu=e.menu.toLowerCase())):e=[],a.PLUGINS&&(a.PLUGINS+="|"),a.PLUGINS+=f.replace(/JS9/,""),a.PLUGINS+="|",a.PLUGINS+=c,a.plugins.push({xclass:d,xname:c,name:f,opts:e,func:b,instances:[]}),e.help&&(b=e.help.match(/^.*[\\/]/),b[0]&&(g="plugins/"+b[0].replace(/[\\/]+$/,
"")),b=e.help.replace(/^.*[\\/]/,""),e=e.menuItem?e.menuItem:f,a.helpOpts[c]={type:g,url:b,heading:d,title:e}),a.inited&&a.instantiatePlugins())};a.instantiatePlugin=function(d,c,b,e){var f,g,h,k,l="visible";if("string"===typeof c){for(f=0;f<a.plugins.length;f++)if(g=a.plugins[f],g.name===c){c=g;break}"string"===typeof c&&a.error("unknown plugin: "+c)}g=Object.create(c.func.prototype);g.name=c.name;g.isActive=function(a){if("active"!==this.status||a&&!this.plugin.opts.hasOwnProperty(a))return!1;switch(this.winType){case "virtual":return!0;
default:return this.divjq.is(":visible")}};g.errLog=function(b,c){a.log("error in %s: %s [%s]\n%s",b,this.name,c.message,a.strace(c))};if(d)for(h=d instanceof jQuery?d:"object"===typeof d?$(d):$("#"+d),f=0;f<c.instances.length;f++){if(h.is(c.instances[f].odivjq))return c.instances[f]}else h=$("div");d?b?(g.id=h.attr("id")||c.name,g.winType="light",g.winHandle=b,g.odivjq=h,g.divjq=h,g.outerdivjq=g.divjq.closest(a.lightOpts[a.LIGHTWIN].top)):(g.id=h.attr("id")||c.name,g.winType="div",0<=$.inArray(g.name,
a.globalOpts.hiddenPluginDivs)&&(l="hidden"),h.wrap(sprintf("<div class='JS9PluginContainer' style='visibility: %s'>",l)),g.odivjq=h,g.divjq=h,g.divjq.addClass(c.xclass+"Plugin").addClass("JS9Plugin"),g.odivjq.attr("id")||g.odivjq.attr("id",g.id),g.outerdivjq=g.divjq.closest(".JS9PluginContainer"),!1!==h.data("toolbarseparate")&&(c.opts.toolbarSeparate||h.data("toolbarseparate"))&&(b="<div class='"+a.lightOpts[a.LIGHTWIN].dragBar+"'>",$(b).insertBefore(g.divjq))):(g.id=c.name,g.winType="virtual");
g.plugin=c;g.el=d;g.status="active";c.instances.push(g);if("virtual"===g.winType)for(f=0;f<a.displays.length;f++)a.displays[f].pluginInstances[c.name]||(g.div=null,g.display=a.displays[f],c.func.apply(g,e),a.displays[f].pluginInstances[c.name]=g);else{g.div=g.divjq[0];g.outerdiv=g.outerdivjq[0];!c.opts.winDims||g.divjq.width()&&g.divjq.height()||(g.divjq.css("width",c.opts.winDims[0]),g.divjq.css("height",c.opts.winDims[1]));d=g.divjq.data("js9id")||g.id;"*"===d?c.opts.dynamicSelect?(g.display=a.displays[0],
g.isDynamic=!0,a.Dysel.addPlugins(c.name),k="*"):a.error(c.name+" is not a dynamically selectable plugin"):(g.display=a.lookupDisplay(d),k=g.display.id);if(h=h.data("toolbarhtml")||c.opts.toolbarHTML)h=a.Image.prototype.expandMacro.call(null,h,[{name:"title",value:c.opts.winTitle||""}]),d=g.divjq.closest(a.lightOpts[a.LIGHTWIN].drag),0===d.length&&(d=g.divjq),$("<div class='JS9PluginToolbar-"+g.winType+"'>").css("z-index",a.BTNZINDEX).html(h).data("displayid",k).insertAfter(d);g.display.pluginInstances[c.name]=
g;c.func.apply(g,e);if("*"===k)for(f=0;f<a.displays.length;f++)a.displays[f].pluginInstances[c.name]?g.display=a.displays[f]:a.displays[f].pluginInstances[c.name]=g}return g};a.instantiatePlugins=function(){var d,c=function(b){var c,d,g;$("div."+b.name).each(function(){a.instantiatePlugin($(this),b,null,b.opts.divArgs)});b.opts.menuItem||!b.opts.winDims||b.opts.winDims[0]||b.opts.winDims[1]||a.instantiatePlugin(null,b,null,b.opts.divArgs);for(c=0;c<b.instances.length;c++)if(g=b.instances[c],g.isDynamic)for(d=
0;d<a.displays.length;d++)a.displays[d].pluginInstances[b.name]||(a.displays[d].pluginInstances[b.name]=g)};for(d=0;d<a.plugins.length;d++)c(a.plugins[d])};a.initEmscripten=function(){var d;if(!window.hasOwnProperty("Astroem"))if(d={responseType:"arraybuffer",allowCache:!0},a.globalOpts.useWasm&&"object"===typeof WebAssembly&&("file:"!==location.protocol||a.globalOpts.allowFileWasm))a.globalOpts.astroemWasm=a.InstallDir(Module.wasmBinaryFile||"astroemw.wasm"),a.fetchURL(a.globalOpts.astroemWasm,null,
d,function(c){Module.wasmBinary=c;a.globalOpts.astroemURL=a.InstallDir("astroemw.js");try{a.loadScript(a.globalOpts.astroemURL)}catch(b){a.error("can't find "+a.globalOpts.astroemURL)}});else{a.globalOpts.astroemURL=a.InstallDir("astroem.js");try{a.loadScript(a.globalOpts.astroemURL)}catch(c){a.error("can't find "+a.globalOpts.astroemURL)}}};a.initFITS=function(){window.hasOwnProperty("Astroem")?(a.vmalloc=Astroem.vmalloc,a.vfree=Astroem.vfree,a.vheap=Astroem.vheap,a.vmemcpy=Astroem.vmemcpy,a.vfile=
Astroem.vfile,a.vread=Astroem.vread,a.vunlink=Astroem.vunlink,a.vsize=Astroem.vsize,a.vmount=Astroem.vmount,a.arrfile=Astroem.arrfile,a.listhdu=Astroem.listhdu,a.initwcs=Astroem.initwcs,a.freewcs=Astroem.freewcs,a.wcsinfo=Astroem.wcsinfo,a.wcssys=Astroem.wcssys,a.wcsunits=Astroem.wcsunits,a.pix2wcs=Astroem.pix2wcs,a.wcs2pix=Astroem.wcs2pix,a.reg2wcs=Astroem.reg2wcs,a.saostrtod=Astroem.saostrtod,a.saodtostr=Astroem.saodtostr,a.saodtype=Astroem.saodtype,a.zscale=Astroem.zscale,a.tanhdr=Astroem.tanhdr,
a.reproject=Astroem.reproject,a.madd=Astroem.madd,a.imgtbl=Astroem.imgtbl,a.makehdr=Astroem.makehdr,a.shrinkhdr=Astroem.shrinkhdr,a.imsection=Astroem.imsection,a.regcnts=Astroem.regcnts,a.fitsLibrary("cfitsio")):window.hasOwnProperty("Fitsy")&&a.fitsLibrary("fitsy")};a.initColormaps=function(){a.hasOwnProperty("Colormap")&&(a.checkNew(new a.Colormap("grey",[[0,0],[1,1]],[[0,0],[1,1]],[[0,0],[1,1]])),a.checkNew(new a.Colormap("red",[[0,0],[1,1]],[[0,0],[0,0]],[[0,0],[0,0]])),a.checkNew(new a.Colormap("green",
[[0,0],[0,0]],[[0,0],[1,1]],[[0,0],[0,0]])),a.checkNew(new a.Colormap("blue",[[0,0],[0,0]],[[0,0],[0,0]],[[0,0],[1,1]])),a.checkNew(new a.Colormap("heat",[[0,0],[.34,1],[1,1]],[[0,0],[1,1]],[[0,0],[.65,0],[.98,1],[1,1]])),a.checkNew(new a.Colormap("cool",[[0,0],[.29,0],[.76,.1],[1,1]],[[0,0],[.22,0],[.96,1],[1,1]],[[0,0],[.53,1],[1,1]])),a.checkNew(new a.Colormap("viridis",[[.267004,.004874,.329415],[.26851,.009605,.335427],[.269944,.014625,.341379],[.271305,.019942,.347269],[.272594,.025563,.353093],
[.273809,.031497,.358853],[.274952,.037752,.364543],[.276022,.044167,.370164],[.277018,.050344,.375715],[.277941,.056324,.381191],[.278791,.062145,.386592],[.279566,.067836,.391917],[.280267,.073417,.397163],[.280894,.078907,.402329],[.281446,.08432,.407414],[.281924,.089666,.412415],[.282327,.094955,.417331],[.282656,.100196,.42216],[.28291,.105393,.426902],[.283091,.110553,.431554],[.283197,.11568,.436115],[.283229,.120777,.440584],[.283187,.125848,.44496],[.283072,.130895,.449241],[.282884,.13592,
.453427],[.282623,.140926,.457517],[.28229,.145912,.46151],[.281887,.150881,.465405],[.281412,.155834,.469201],[.280868,.160771,.472899],[.280255,.165693,.476498],[.279574,.170599,.479997],[.278826,.17549,.483397],[.278012,.180367,.486697],[.277134,.185228,.489898],[.276194,.190074,.493001],[.275191,.194905,.496005],[.274128,.199721,.498911],[.273006,.20452,.501721],[.271828,.209303,.504434],[.270595,.214069,.507052],[.269308,.218818,.509577],[.267968,.223549,.512008],[.26658,.228262,.514349],[.265145,
.232956,.516599],[.263663,.237631,.518762],[.262138,.242286,.520837],[.260571,.246922,.522828],[.258965,.251537,.524736],[.257322,.25613,.526563],[.255645,.260703,.528312],[.253935,.265254,.529983],[.252194,.269783,.531579],[.250425,.27429,.533103],[.248629,.278775,.534556],[.246811,.283237,.535941],[.244972,.287675,.53726],[.243113,.292092,.538516],[.241237,.296485,.539709],[.239346,.300855,.540844],[.237441,.305202,.541921],[.235526,.309527,.542944],[.233603,.313828,.543914],[.231674,.318106,.544834],
[.229739,.322361,.545706],[.227802,.326594,.546532],[.225863,.330805,.547314],[.223925,.334994,.548053],[.221989,.339161,.548752],[.220057,.343307,.549413],[.21813,.347432,.550038],[.21621,.351535,.550627],[.214298,.355619,.551184],[.212395,.359683,.55171],[.210503,.363727,.552206],[.208623,.367752,.552675],[.206756,.371758,.553117],[.204903,.375746,.553533],[.203063,.379716,.553925],[.201239,.38367,.554294],[.19943,.387607,.554642],[.197636,.391528,.554969],[.19586,.395433,.555276],[.1941,.399323,
.555565],[.192357,.403199,.555836],[.190631,.407061,.556089],[.188923,.41091,.556326],[.187231,.414746,.556547],[.185556,.41857,.556753],[.183898,.422383,.556944],[.182256,.426184,.55712],[.180629,.429975,.557282],[.179019,.433756,.55743],[.177423,.437527,.557565],[.175841,.44129,.557685],[.174274,.445044,.557792],[.172719,.448791,.557885],[.171176,.45253,.557965],[.169646,.456262,.55803],[.168126,.459988,.558082],[.166617,.463708,.558119],[.165117,.467423,.558141],[.163625,.471133,.558148],[.162142,
.474838,.55814],[.160665,.47854,.558115],[.159194,.482237,.558073],[.157729,.485932,.558013],[.15627,.489624,.557936],[.154815,.493313,.55784],[.153364,.497,.557724],[.151918,.500685,.557587],[.150476,.504369,.55743],[.149039,.508051,.55725],[.147607,.511733,.557049],[.14618,.515413,.556823],[.144759,.519093,.556572],[.143343,.522773,.556295],[.141935,.526453,.555991],[.140536,.530132,.555659],[.139147,.533812,.555298],[.13777,.537492,.554906],[.136408,.541173,.554483],[.135066,.544853,.554029],[.133743,
.548535,.553541],[.132444,.552216,.553018],[.131172,.555899,.552459],[.129933,.559582,.551864],[.128729,.563265,.551229],[.127568,.566949,.550556],[.126453,.570633,.549841],[.125394,.574318,.549086],[.124395,.578002,.548287],[.123463,.581687,.547445],[.122606,.585371,.546557],[.121831,.589055,.545623],[.121148,.592739,.544641],[.120565,.596422,.543611],[.120092,.600104,.54253],[.119738,.603785,.5414],[.119512,.607464,.540218],[.119423,.611141,.538982],[.119483,.614817,.537692],[.119699,.61849,.536347],
[.120081,.622161,.534946],[.120638,.625828,.533488],[.12138,.629492,.531973],[.122312,.633153,.530398],[.123444,.636809,.528763],[.12478,.640461,.527068],[.126326,.644107,.525311],[.128087,.647749,.523491],[.130067,.651384,.521608],[.132268,.655014,.519661],[.134692,.658636,.517649],[.137339,.662252,.515571],[.14021,.665859,.513427],[.143303,.669459,.511215],[.146616,.67305,.508936],[.150148,.676631,.506589],[.153894,.680203,.504172],[.157851,.683765,.501686],[.162016,.687316,.499129],[.166383,.690856,
.496502],[.170948,.694384,.493803],[.175707,.6979,.491033],[.180653,.701402,.488189],[.185783,.704891,.485273],[.19109,.708366,.482284],[.196571,.711827,.479221],[.202219,.715272,.476084],[.20803,.718701,.472873],[.214,.722114,.469588],[.220124,.725509,.466226],[.226397,.728888,.462789],[.232815,.732247,.459277],[.239374,.735588,.455688],[.24607,.73891,.452024],[.252899,.742211,.448284],[.259857,.745492,.444467],[.266941,.748751,.440573],[.274149,.751988,.436601],[.281477,.755203,.432552],[.288921,
.758394,.428426],[.296479,.761561,.424223],[.304148,.764704,.419943],[.311925,.767822,.415586],[.319809,.770914,.411152],[.327796,.77398,.40664],[.335885,.777018,.402049],[.344074,.780029,.397381],[.35236,.783011,.392636],[.360741,.785964,.387814],[.369214,.788888,.382914],[.377779,.791781,.377939],[.386433,.794644,.372886],[.395174,.797475,.367757],[.404001,.800275,.362552],[.412913,.803041,.357269],[.421908,.805774,.35191],[.430983,.808473,.346476],[.440137,.811138,.340967],[.449368,.813768,.335384],
[.458674,.816363,.329727],[.468053,.818921,.323998],[.477504,.821444,.318195],[.487026,.823929,.312321],[.496615,.826376,.306377],[.506271,.828786,.300362],[.515992,.831158,.294279],[.525776,.833491,.288127],[.535621,.835785,.281908],[.545524,.838039,.275626],[.555484,.840254,.269281],[.565498,.84243,.262877],[.575563,.844566,.256415],[.585678,.846661,.249897],[.595839,.848717,.243329],[.606045,.850733,.236712],[.616293,.852709,.230052],[.626579,.854645,.223353],[.636902,.856542,.21662],[.647257,
.8584,.209861],[.657642,.860219,.203082],[.668054,.861999,.196293],[.678489,.863742,.189503],[.688944,.865448,.182725],[.699415,.867117,.175971],[.709898,.868751,.169257],[.720391,.87035,.162603],[.730889,.871916,.156029],[.741388,.873449,.149561],[.751884,.874951,.143228],[.762373,.876424,.137064],[.772852,.877868,.131109],[.783315,.879285,.125405],[.79376,.880678,.120005],[.804182,.882046,.114965],[.814576,.883393,.110347],[.82494,.88472,.106217],[.83527,.886029,.102646],[.845561,.887322,.099702],
[.85581,.888601,.097452],[.866013,.889868,.095953],[.876168,.891125,.09525],[.886271,.892374,.095374],[.89632,.893616,.096335],[.906311,.894855,.098125],[.916242,.896091,.100717],[.926106,.89733,.104071],[.935904,.89857,.108131],[.945636,.899815,.112838],[.9553,.901065,.118128],[.964894,.902323,.123941],[.974417,.90359,.130215],[.983868,.904867,.136897],[.993248,.906157,.143936]])),a.checkNew(new a.Colormap("magma",[[.001462,4.66E-4,.013866],[.002258,.001295,.018331],[.003279,.002305,.023708],[.004512,
.00349,.029965],[.00595,.004843,.03713],[.007588,.006356,.044973],[.009426,.008022,.052844],[.011465,.009828,.06075],[.013708,.011771,.068667],[.016156,.01384,.076603],[.018815,.016026,.084584],[.021692,.01832,.09261],[.024792,.020715,.100676],[.028123,.023201,.108787],[.031696,.025765,.116965],[.03552,.028397,.125209],[.039608,.03109,.133515],[.04383,.03383,.141886],[.048062,.036607,.150327],[.05232,.039407,.158841],[.056615,.04216,.167446],[.060949,.044794,.176129],[.06533,.047318,.184892],[.069764,
.049726,.193735],[.074257,.052017,.20266],[.078815,.054184,.211667],[.083446,.056225,.220755],[.088155,.058133,.229922],[.092949,.059904,.239164],[.097833,.061531,.248477],[.102815,.06301,.257854],[.107899,.064335,.267289],[.113094,.065492,.276784],[.118405,.066479,.286321],[.123833,.067295,.295879],[.12938,.067935,.305443],[.135053,.068391,.315],[.140858,.068654,.324538],[.146785,.068738,.334011],[.152839,.068637,.343404],[.159018,.068354,.352688],[.165308,.067911,.361816],[.171713,.067305,.370771],
[.178212,.066576,.379497],[.184801,.065732,.387973],[.19146,.064818,.396152],[.198177,.063862,.404009],[.204935,.062907,.411514],[.211718,.061992,.418647],[.218512,.061158,.425392],[.225302,.060445,.431742],[.232077,.059889,.437695],[.238826,.059517,.443256],[.245543,.059352,.448436],[.25222,.059415,.453248],[.258857,.059706,.45771],[.265447,.060237,.46184],[.271994,.060994,.46566],[.278493,.061978,.46919],[.284951,.063168,.472451],[.291366,.064553,.475462],[.29774,.066117,.478243],[.304081,.067835,
.480812],[.310382,.069702,.483186],[.316654,.07169,.48538],[.322899,.073782,.487408],[.329114,.075972,.489287],[.335308,.078236,.491024],[.341482,.080564,.492631],[.347636,.082946,.494121],[.353773,.085373,.495501],[.359898,.087831,.496778],[.366012,.090314,.49796],[.372116,.092816,.499053],[.378211,.095332,.500067],[.384299,.097855,.501002],[.390384,.100379,.501864],[.396467,.102902,.502658],[.402548,.10542,.503386],[.408629,.10793,.504052],[.414709,.110431,.504662],[.420791,.11292,.505215],[.426877,
.115395,.505714],[.432967,.117855,.50616],[.439062,.120298,.506555],[.445163,.122724,.506901],[.451271,.125132,.507198],[.457386,.127522,.507448],[.463508,.129893,.507652],[.46964,.132245,.507809],[.47578,.134577,.507921],[.481929,.136891,.507989],[.488088,.139186,.508011],[.494258,.141462,.507988],[.500438,.143719,.50792],[.506629,.145958,.507806],[.512831,.148179,.507648],[.519045,.150383,.507443],[.52527,.152569,.507192],[.531507,.154739,.506895],[.537755,.156894,.506551],[.544015,.159033,.506159],
[.550287,.161158,.505719],[.556571,.163269,.50523],[.562866,.165368,.504692],[.569172,.167454,.504105],[.57549,.16953,.503466],[.581819,.171596,.502777],[.588158,.173652,.502035],[.594508,.175701,.501241],[.600868,.177743,.500394],[.607238,.179779,.499492],[.613617,.181811,.498536],[.620005,.18384,.497524],[.626401,.185867,.496456],[.632805,.187893,.495332],[.639216,.189921,.49415],[.645633,.191952,.49291],[.652056,.193986,.491611],[.658483,.196027,.490253],[.664915,.198075,.488836],[.671349,.200133,
.487358],[.677786,.202203,.485819],[.684224,.204286,.484219],[.690661,.206384,.482558],[.697098,.208501,.480835],[.703532,.210638,.479049],[.709962,.212797,.477201],[.716387,.214982,.47529],[.722805,.217194,.473316],[.729216,.219437,.471279],[.735616,.221713,.46918],[.742004,.224025,.467018],[.748378,.226377,.464794],[.754737,.228772,.462509],[.761077,.231214,.460162],[.767398,.233705,.457755],[.773695,.236249,.455289],[.779968,.238851,.452765],[.786212,.241514,.450184],[.792427,.244242,.447543],
[.798608,.24704,.444848],[.804752,.249911,.442102],[.810855,.252861,.439305],[.816914,.255895,.436461],[.822926,.259016,.433573],[.828886,.262229,.430644],[.834791,.26554,.427671],[.840636,.268953,.424666],[.846416,.272473,.421631],[.852126,.276106,.418573],[.857763,.279857,.415496],[.86332,.283729,.412403],[.868793,.287728,.409303],[.874176,.291859,.406205],[.879464,.296125,.403118],[.884651,.30053,.400047],[.889731,.305079,.397002],[.8947,.309773,.393995],[.899552,.314616,.391037],[.904281,.31961,
.388137],[.908884,.324755,.385308],[.913354,.330052,.382563],[.917689,.3355,.379915],[.921884,.341098,.377376],[.925937,.346844,.374959],[.929845,.352734,.372677],[.933606,.358764,.370541],[.937221,.364929,.368567],[.940687,.371224,.366762],[.944006,.377643,.365136],[.94718,.384178,.363701],[.95021,.39082,.362468],[.953099,.397563,.361438],[.955849,.4044,.360619],[.958464,.411324,.360014],[.960949,.418323,.35963],[.96331,.42539,.359469],[.965549,.432519,.359529],[.967671,.439703,.35981],[.96968,.446936,
.360311],[.971582,.45421,.36103],[.973381,.46152,.361965],[.975082,.468861,.363111],[.97669,.476226,.364466],[.97821,.483612,.366025],[.979645,.491014,.367783],[.981,.498428,.369734],[.982279,.505851,.371874],[.983485,.51328,.374198],[.984622,.520713,.376698],[.985693,.528148,.379371],[.9867,.535582,.38221],[.987646,.543015,.38521],[.988533,.550446,.388365],[.989363,.557873,.391671],[.990138,.565296,.395122],[.990871,.572706,.398714],[.991558,.580107,.402441],[.992196,.587502,.406299],[.992785,.594891,
.410283],[.993326,.602275,.41439],[.993834,.609644,.418613],[.994309,.616999,.42295],[.994738,.62435,.427397],[.995122,.631696,.431951],[.99548,.639027,.436607],[.99581,.646344,.441361],[.996096,.653659,.446213],[.996341,.660969,.45116],[.99658,.668256,.456192],[.996775,.675541,.461314],[.996925,.682828,.466526],[.997077,.690088,.471811],[.997186,.697349,.477182],[.997254,.704611,.482635],[.997325,.711848,.488154],[.997351,.719089,.493755],[.997351,.726324,.499428],[.997341,.733545,.505167],[.997285,
.740772,.510983],[.997228,.747981,.516859],[.997138,.75519,.522806],[.997019,.762398,.528821],[.996898,.769591,.534892],[.996727,.776795,.541039],[.996571,.783977,.547233],[.996369,.791167,.553499],[.996162,.798348,.55982],[.995932,.805527,.566202],[.99568,.812706,.572645],[.995424,.819875,.57914],[.995131,.827052,.585701],[.994851,.834213,.592307],[.994524,.841387,.598983],[.994222,.84854,.605696],[.993866,.855711,.612482],[.993545,.862859,.619299],[.99317,.870024,.626189],[.992831,.877168,.633109],
[.99244,.88433,.640099],[.992089,.89147,.647116],[.991688,.898627,.654202],[.991332,.905763,.661309],[.99093,.912915,.668481],[.99057,.920049,.675675],[.990175,.927196,.682926],[.989815,.934329,.690198],[.989434,.94147,.697519],[.989077,.948604,.704863],[.988717,.955742,.712242],[.988367,.962878,.719649],[.988033,.970012,.727077],[.987691,.977154,.734536],[.987387,.984288,.742002],[.987053,.991438,.749504]])),a.checkNew(new a.Colormap("inferno",[[.001462,4.66E-4,.013866],[.002267,.00127,.01857],[.003299,
.002249,.024239],[.004547,.003392,.030909],[.006006,.004692,.038558],[.007676,.006136,.046836],[.009561,.007713,.055143],[.011663,.009417,.06346],[.013995,.011225,.071862],[.016561,.013136,.080282],[.019373,.015133,.088767],[.022447,.017199,.097327],[.025793,.019331,.10593],[.029432,.021503,.114621],[.033385,.023702,.123397],[.037668,.025921,.132232],[.042253,.028139,.141141],[.046915,.030324,.150164],[.051644,.032474,.159254],[.056449,.034569,.168414],[.06134,.03659,.177642],[.066331,.038504,.186962],
[.071429,.040294,.196354],[.076637,.041905,.205799],[.081962,.043328,.215289],[.087411,.044556,.224813],[.09299,.045583,.234358],[.098702,.046402,.243904],[.104551,.047008,.25343],[.110536,.047399,.262912],[.116656,.047574,.272321],[.122908,.047536,.281624],[.129285,.047293,.290788],[.135778,.046856,.299776],[.142378,.046242,.308553],[.149073,.045468,.317085],[.15585,.044559,.325338],[.162689,.043554,.333277],[.169575,.042489,.340874],[.176493,.041402,.348111],[.183429,.040329,.354971],[.190367,.039309,
.361447],[.197297,.0384,.367535],[.204209,.037632,.373238],[.211095,.03703,.378563],[.217949,.036615,.383522],[.224763,.036405,.388129],[.231538,.036405,.3924],[.238273,.036621,.396353],[.244967,.037055,.400007],[.25162,.037705,.403378],[.258234,.038571,.406485],[.26481,.039647,.409345],[.271347,.040922,.411976],[.27785,.042353,.414392],[.284321,.043933,.416608],[.290763,.045644,.418637],[.297178,.04747,.420491],[.303568,.049396,.422182],[.309935,.051407,.423721],[.316282,.05349,.425116],[.32261,
.055634,.426377],[.328921,.057827,.427511],[.335217,.06006,.428524],[.3415,.062325,.429425],[.347771,.064616,.430217],[.354032,.066925,.430906],[.360284,.069247,.431497],[.366529,.071579,.431994],[.372768,.073915,.4324],[.379001,.076253,.432719],[.385228,.078591,.432955],[.391453,.080927,.433109],[.397674,.083257,.433183],[.403894,.08558,.433179],[.410113,.087896,.433098],[.416331,.090203,.432943],[.422549,.092501,.432714],[.428768,.09479,.432412],[.434987,.097069,.432039],[.441207,.099338,.431594],
[.447428,.101597,.43108],[.453651,.103848,.430498],[.459875,.106089,.429846],[.4661,.108322,.429125],[.472328,.110547,.428334],[.478558,.112764,.427475],[.484789,.114974,.426548],[.491022,.117179,.425552],[.497257,.119379,.424488],[.503493,.121575,.423356],[.50973,.123769,.422156],[.515967,.12596,.420887],[.522206,.12815,.419549],[.528444,.130341,.418142],[.534683,.132534,.416667],[.54092,.134729,.415123],[.547157,.136929,.413511],[.553392,.139134,.411829],[.559624,.141346,.410078],[.565854,.143567,
.408258],[.572081,.145797,.406369],[.578304,.148039,.404411],[.584521,.150294,.402385],[.590734,.152563,.40029],[.59694,.154848,.398125],[.603139,.157151,.395891],[.60933,.159474,.393589],[.615513,.161817,.391219],[.621685,.164184,.388781],[.627847,.166575,.386276],[.633998,.168992,.383704],[.640135,.171438,.381065],[.64626,.173914,.378359],[.652369,.176421,.375586],[.658463,.178962,.372748],[.66454,.181539,.369846],[.670599,.184153,.366879],[.676638,.186807,.363849],[.682656,.189501,.360757],[.688653,
.192239,.357603],[.694627,.195021,.354388],[.700576,.197851,.351113],[.7065,.200728,.347777],[.712396,.203656,.344383],[.718264,.206636,.340931],[.724103,.20967,.337424],[.729909,.212759,.333861],[.735683,.215906,.330245],[.741423,.219112,.326576],[.747127,.222378,.322856],[.752794,.225706,.319085],[.758422,.229097,.315266],[.76401,.232554,.311399],[.769556,.236077,.307485],[.775059,.239667,.303526],[.780517,.243327,.299523],[.785929,.247056,.295477],[.791293,.250856,.29139],[.796607,.254728,.287264],
[.801871,.258674,.283099],[.807082,.262692,.278898],[.812239,.266786,.274661],[.817341,.270954,.27039],[.822386,.275197,.266085],[.827372,.279517,.26175],[.832299,.283913,.257383],[.837165,.288385,.252988],[.841969,.292933,.248564],[.846709,.297559,.244113],[.851384,.30226,.239636],[.855992,.307038,.235133],[.860533,.311892,.230606],[.865006,.316822,.226055],[.869409,.321827,.221482],[.873741,.326906,.216886],[.878001,.33206,.212268],[.882188,.337287,.207628],[.886302,.342586,.202968],[.890341,.347957,
.198286],[.894305,.353399,.193584],[.898192,.358911,.18886],[.902003,.364492,.184116],[.905735,.37014,.17935],[.90939,.375856,.174563],[.912966,.381636,.169755],[.916462,.387481,.164924],[.919879,.393389,.16007],[.923215,.399359,.155193],[.92647,.405389,.150292],[.929644,.411479,.145367],[.932737,.417627,.140417],[.935747,.423831,.13544],[.938675,.430091,.130438],[.941521,.436405,.125409],[.944285,.442772,.120354],[.946965,.449191,.115272],[.949562,.45566,.110164],[.952075,.462178,.105031],[.954506,
.468744,.099874],[.956852,.475356,.094695],[.959114,.482014,.089499],[.961293,.488716,.084289],[.963387,.495462,.079073],[.965397,.502249,.073859],[.967322,.509078,.068659],[.969163,.515946,.063488],[.970919,.522853,.058367],[.97259,.529798,.053324],[.974176,.53678,.048392],[.975677,.543798,.043618],[.977092,.55085,.03905],[.978422,.557937,.034931],[.979666,.565057,.031409],[.980824,.572209,.028508],[.981895,.579392,.02625],[.982881,.586606,.024661],[.983779,.593849,.02377],[.984591,.601122,.023606],
[.985315,.608422,.024202],[.985952,.61575,.025592],[.986502,.623105,.027814],[.986964,.630485,.030908],[.987337,.63789,.034916],[.987622,.64532,.039886],[.987819,.652773,.045581],[.987926,.66025,.05175],[.987945,.667748,.058329],[.987874,.675267,.065257],[.987714,.682807,.072489],[.987464,.690366,.07999],[.987124,.697944,.087731],[.986694,.70554,.095694],[.986175,.713153,.103863],[.985566,.720782,.112229],[.984865,.728427,.120785],[.984075,.736087,.129527],[.983196,.743758,.138453],[.982228,.751442,
.147565],[.981173,.759135,.156863],[.980032,.766837,.166353],[.978806,.774545,.176037],[.977497,.782258,.185923],[.976108,.789974,.196018],[.974638,.797692,.206332],[.973088,.805409,.216877],[.971468,.813122,.227658],[.969783,.820825,.238686],[.968041,.828515,.249972],[.966243,.836191,.261534],[.964394,.843848,.273391],[.962517,.851476,.285546],[.960626,.859069,.29801],[.95872,.866624,.31082],[.956834,.874129,.323974],[.954997,.881569,.337475],[.953215,.888942,.351369],[.951546,.896226,.365627],[.950018,
.903409,.380271],[.948683,.910473,.395289],[.947594,.917399,.410665],[.946809,.924168,.426373],[.946392,.930761,.442367],[.946403,.937159,.458592],[.946903,.943348,.47497],[.947937,.949318,.491426],[.949545,.955063,.50786],[.95174,.960587,.524203],[.954529,.965896,.540361],[.957896,.971003,.556275],[.961812,.975924,.571925],[.966249,.980678,.587206],[.971162,.985282,.602154],[.976511,.989753,.61676],[.982257,.994109,.631017],[.988362,.998364,.644924]])),a.checkNew(new a.Colormap("plasma",[[.050383,
.029803,.527975],[.063536,.028426,.533124],[.075353,.027206,.538007],[.086222,.026125,.542658],[.096379,.025165,.547103],[.10598,.024309,.551368],[.115124,.023556,.555468],[.123903,.022878,.559423],[.132381,.022258,.56325],[.140603,.021687,.566959],[.148607,.021154,.570562],[.156421,.020651,.574065],[.16407,.020171,.577478],[.171574,.019706,.580806],[.17895,.019252,.584054],[.186213,.018803,.587228],[.193374,.018354,.59033],[.200445,.017902,.593364],[.207435,.017442,.596333],[.21435,.016973,.599239],
[.221197,.016497,.602083],[.227983,.016007,.604867],[.234715,.015502,.607592],[.241396,.014979,.610259],[.248032,.014439,.612868],[.254627,.013882,.615419],[.261183,.013308,.617911],[.267703,.012716,.620346],[.274191,.012109,.622722],[.280648,.011488,.625038],[.287076,.010855,.627295],[.293478,.010213,.62949],[.299855,.009561,.631624],[.30621,.008902,.633694],[.312543,.008239,.6357],[.318856,.007576,.63764],[.32515,.006915,.639512],[.331426,.006261,.641316],[.337683,.005618,.643049],[.343925,.004991,
.64471],[.35015,.004382,.646298],[.356359,.003798,.64781],[.362553,.003243,.649245],[.368733,.002724,.650601],[.374897,.002245,.651876],[.381047,.001814,.653068],[.387183,.001434,.654177],[.393304,.001114,.655199],[.399411,8.59E-4,.656133],[.405503,6.78E-4,.656977],[.41158,5.77E-4,.65773],[.417642,5.64E-4,.65839],[.423689,6.46E-4,.658956],[.429719,8.31E-4,.659425],[.435734,.001127,.659797],[.441732,.00154,.660069],[.447714,.00208,.66024],[.453677,.002755,.66031],[.459623,.003574,.660277],[.46555,
.004545,.660139],[.471457,.005678,.659897],[.477344,.00698,.659549],[.48321,.00846,.659095],[.489055,.010127,.658534],[.494877,.01199,.657865],[.500678,.014055,.657088],[.506454,.016333,.656202],[.512206,.018833,.655209],[.517933,.021563,.654109],[.523633,.024532,.652901],[.529306,.027747,.651586],[.534952,.031217,.650165],[.54057,.03495,.64864],[.546157,.038954,.64701],[.551715,.043136,.645277],[.557243,.047331,.643443],[.562738,.051545,.641509],[.568201,.055778,.639477],[.573632,.060028,.637349],
[.579029,.064296,.635126],[.584391,.068579,.632812],[.589719,.072878,.630408],[.595011,.07719,.627917],[.600266,.081516,.625342],[.605485,.085854,.622686],[.610667,.090204,.619951],[.615812,.094564,.61714],[.620919,.098934,.614257],[.625987,.103312,.611305],[.631017,.107699,.608287],[.636008,.112092,.605205],[.640959,.116492,.602065],[.645872,.120898,.598867],[.650746,.125309,.595617],[.65558,.129725,.592317],[.660374,.134144,.588971],[.665129,.138566,.585582],[.669845,.142992,.582154],[.674522,.147419,
.578688],[.67916,.151848,.575189],[.683758,.156278,.57166],[.688318,.160709,.568103],[.69284,.165141,.564522],[.697324,.169573,.560919],[.701769,.174005,.557296],[.706178,.178437,.553657],[.710549,.182868,.550004],[.714883,.187299,.546338],[.719181,.191729,.542663],[.723444,.196158,.538981],[.72767,.200586,.535293],[.731862,.205013,.531601],[.736019,.209439,.527908],[.740143,.213864,.524216],[.744232,.218288,.520524],[.748289,.222711,.516834],[.752312,.227133,.513149],[.756304,.231555,.509468],[.760264,
.235976,.505794],[.764193,.240396,.502126],[.76809,.244817,.498465],[.771958,.249237,.494813],[.775796,.253658,.491171],[.779604,.258078,.487539],[.783383,.2625,.483918],[.787133,.266922,.480307],[.790855,.271345,.476706],[.794549,.27577,.473117],[.798216,.280197,.469538],[.801855,.284626,.465971],[.805467,.289057,.462415],[.809052,.293491,.45887],[.812612,.297928,.455338],[.816144,.302368,.451816],[.819651,.306812,.448306],[.823132,.311261,.444806],[.826588,.315714,.441316],[.830018,.320172,.437836],
[.833422,.324635,.434366],[.836801,.329105,.430905],[.840155,.33358,.427455],[.843484,.338062,.424013],[.846788,.342551,.420579],[.850066,.347048,.417153],[.853319,.351553,.413734],[.856547,.356066,.410322],[.85975,.360588,.406917],[.862927,.365119,.403519],[.866078,.36966,.400126],[.869203,.374212,.396738],[.872303,.378774,.393355],[.875376,.383347,.389976],[.878423,.387932,.3866],[.881443,.392529,.383229],[.884436,.397139,.37986],[.887402,.401762,.376494],[.89034,.406398,.37313],[.89325,.411048,
.369768],[.896131,.415712,.366407],[.898984,.420392,.363047],[.901807,.425087,.359688],[.904601,.429797,.356329],[.907365,.434524,.35297],[.910098,.439268,.34961],[.9128,.444029,.346251],[.915471,.448807,.34289],[.918109,.453603,.339529],[.920714,.458417,.336166],[.923287,.463251,.332801],[.925825,.468103,.329435],[.928329,.472975,.326067],[.930798,.477867,.322697],[.933232,.48278,.319325],[.93563,.487712,.315952],[.93799,.492667,.312575],[.940313,.497642,.309197],[.942598,.502639,.305816],[.944844,
.507658,.302433],[.947051,.512699,.299049],[.949217,.517763,.295662],[.951344,.52285,.292275],[.953428,.52796,.288883],[.95547,.533093,.28549],[.957469,.53825,.282096],[.959424,.543431,.278701],[.961336,.548636,.275305],[.963203,.553865,.271909],[.965024,.559118,.268513],[.966798,.564396,.265118],[.968526,.5697,.261721],[.970205,.575028,.258325],[.971835,.580382,.254931],[.973416,.585761,.25154],[.974947,.591165,.248151],[.976428,.596595,.244767],[.977856,.602051,.241387],[.979233,.607532,.238013],
[.980556,.613039,.234646],[.981826,.618572,.231287],[.983041,.624131,.227937],[.984199,.629718,.224595],[.985301,.63533,.221265],[.986345,.640969,.217948],[.987332,.646633,.214648],[.98826,.652325,.211364],[.989128,.658043,.2081],[.989935,.663787,.204859],[.990681,.669558,.201642],[.991365,.675355,.198453],[.991985,.681179,.195295],[.992541,.68703,.19217],[.993032,.692907,.189084],[.993456,.69881,.186041],[.993814,.704741,.183043],[.994103,.710698,.180097],[.994324,.716681,.177208],[.994474,.722691,
.174381],[.994553,.728728,.171622],[.994561,.734791,.168938],[.994495,.74088,.166335],[.994355,.746995,.163821],[.994141,.753137,.161404],[.993851,.759304,.159092],[.993482,.765499,.156891],[.993033,.77172,.154808],[.992505,.777967,.152855],[.991897,.784239,.151042],[.991209,.790537,.149377],[.990439,.796859,.14787],[.989587,.803205,.146529],[.988648,.809579,.145357],[.987621,.815978,.144363],[.986509,.822401,.143557],[.985314,.828846,.142945],[.984031,.835315,.142528],[.982653,.841812,.142303],[.98119,
.848329,.142279],[.979644,.854866,.142453],[.977995,.861432,.142808],[.976265,.868016,.143351],[.974443,.874622,.144061],[.97253,.88125,.144923],[.970533,.887896,.145919],[.968443,.894564,.147014],[.966271,.901249,.14818],[.964021,.90795,.14937],[.961681,.914672,.15052],[.959276,.921407,.151566],[.956808,.928152,.152409],[.954287,.934908,.152921],[.951726,.941671,.152925],[.949151,.948435,.152178],[.946602,.95519,.150328],[.944152,.961916,.146861],[.941896,.96859,.140956],[.940015,.975158,.131326]])),
a.checkNew(new a.Colormap("i8",[[0,0,0],[0,1,0],[0,0,1],[0,1,1],[1,0,0],[1,1,0],[1,0,1],[1,1,1]])),a.checkNew(new a.Colormap("aips0",[[.196,.196,.196],[.475,0,.608],[0,0,.785],[.373,.655,.925],[0,.596,0],[0,.965,0],[1,1,0],[1,.694,0],[1,0,0]])),a.checkNew(new a.Colormap("sls",[[0,0,0],[.043442,0,.052883],[.086883,0,.105767],[.130325,0,.15865],[.173767,0,.211533],[.217208,0,.264417],[.26065,0,.3173],[.304092,0,.370183],[.347533,0,.423067],[.390975,0,.47595],[.434417,0,.528833],[.477858,0,.581717],
[.5213,0,.6346],[.506742,0,.640217],[.492183,0,.645833],[.477625,0,.65145],[.463067,0,.657067],[.448508,0,.662683],[.43395,0,.6683],[.419392,0,.673917],[.404833,0,.679533],[.390275,0,.68515],[.375717,0,.690767],[.361158,0,.696383],[.3466,0,.702],[.317717,0,.712192],[.288833,0,.722383],[.25995,0,.732575],[.231067,0,.742767],[.202183,0,.752958],[.1733,0,.76315],[.144417,0,.773342],[.115533,0,.783533],[.08665,0,.793725],[.057767,0,.803917],[.028883,0,.814108],[0,0,.8243],[0,.019817,.838942],[0,.039633,
.853583],[0,.05945,.868225],[0,.079267,.882867],[0,.099083,.897508],[0,.1189,.91215],[0,.138717,.926792],[0,.158533,.941433],[0,.17835,.956075],[0,.198167,.970717],[0,.217983,.985358],[0,.2378,1],[0,.268533,1],[0,.299267,1],[0,.33,1],[0,.360733,1],[0,.391467,1],[0,.4222,1],[0,.452933,1],[0,.483667,1],[0,.5144,1],[0,.545133,1],[0,.575867,1],[0,.6066,1],[0,.631733,.9753],[0,.656867,.9506],[0,.682,.9259],[0,.707133,.9012],[0,.732267,.8765],[0,.7574,.8518],[0,.782533,.8271],[0,.807667,.8024],[0,.8328,
.7777],[0,.857933,.753],[0,.883067,.7283],[0,.9082,.7036],[0,.901908,.676675],[0,.895617,.64975],[0,.889325,.622825],[0,.883033,.5959],[0,.876742,.568975],[0,.87045,.54205],[0,.864158,.515125],[0,.857867,.4882],[0,.851575,.461275],[0,.845283,.43435],[0,.838992,.407425],[0,.8327,.3805],[0,.832308,.354858],[0,.831917,.329217],[0,.831525,.303575],[0,.831133,.277933],[0,.830742,.252292],[0,.83035,.22665],[0,.829958,.201008],[0,.829567,.175367],[0,.829175,.149725],[0,.828783,.124083],[0,.828392,.098442],
[0,.828,.0728],[.033167,.834167,.066733],[.066333,.840333,.060667],[.0995,.8465,.0546],[.132667,.852667,.048533],[.165833,.858833,.042467],[.199,.865,.0364],[.232167,.871167,.030333],[.265333,.877333,.024267],[.2985,.8835,.0182],[.331667,.889667,.012133],[.364833,.895833,.006067],[.398,.902,0],[.43095,.902,0],[.4639,.902,0],[.49685,.902,0],[.5298,.902,0],[.56275,.902,0],[.5957,.902,0],[.62865,.902,0],[.6616,.902,0],[.69455,.902,0],[.7275,.902,0],[.76045,.902,0],[.7934,.902,0],[.810617,.897133,.003983],
[.827833,.892267,.007967],[.84505,.8874,.01195],[.862267,.882533,.015933],[.879483,.877667,.019917],[.8967,.8728,.0239],[.913917,.867933,.027883],[.931133,.863067,.031867],[.94835,.8582,.03585],[.965567,.853333,.039833],[.982783,.848467,.043817],[1,.8436,.0478],[.995725,.824892,.0516],[.99145,.806183,.0554],[.987175,.787475,.0592],[.9829,.768767,.063],[.978625,.750058,.0668],[.97435,.73135,.0706],[.970075,.712642,.0744],[.9658,.693933,.0782],[.961525,.675225,.082],[.95725,.656517,.0858],[.952975,
.637808,.0896],[.9487,.6191,.0934],[.952975,.600408,.085617],[.95725,.581717,.077833],[.961525,.563025,.07005],[.9658,.544333,.062267],[.970075,.525642,.054483],[.97435,.50695,.0467],[.978625,.488258,.038917],[.9829,.469567,.031133],[.987175,.450875,.02335],[.99145,.432183,.015567],[.995725,.413492,.007783],[1,.3948,0],[.998342,.3619,0],[.996683,.329,0],[.995025,.2961,0],[.993367,.2632,0],[.991708,.2303,0],[.99005,.1974,0],[.988392,.1645,0],[.986733,.1316,0],[.985075,.0987,0],[.983417,.0658,0],[.981758,
.0329,0],[.9801,0,0],[.955925,0,0],[.93175,0,0],[.907575,0,0],[.8834,0,0],[.859225,0,0],[.83505,0,0],[.810875,0,0],[.7867,0,0],[.762525,0,0],[.73835,0,0],[.714175,0,0],[.69,0,0],[.715833,.083333,.083333],[.741667,.166667,.166667],[.7675,.25,.25],[.793333,.333333,.333333],[.819167,.416667,.416667],[.845,.5,.5],[.870833,.583333,.583333],[.896667,.666667,.666667],[.9225,.75,.75],[.948333,.833333,.833333],[.974167,.916667,.916667],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1]])),a.checkNew(new a.Colormap("a",
[[0,0],[.25,0],[.5,1],[1,1]],[[0,0],[.25,1],[.5,0],[.77,0],[1,1]],[[0,0],[.125,0],[.5,1],[.64,.5],[.77,0],[1,0]])),a.checkNew(new a.Colormap("b",[[0,0],[.25,0],[.5,1],[1,1]],[[0,0],[.5,0],[.75,1],[1,1]],[[0,0],[.25,1],[.5,0],[.75,0],[1,1]])),a.checkNew(new a.Colormap("bb",[[0,0],[.5,1],[1,1]],[[0,0],[.25,0],[.75,1],[1,1]],[[0,0],[.5,0],[1,1]])),a.checkNew(new a.Colormap("he",[[0,0],[.015,.5],[.25,.5],[.5,.75],[1,1]],[[0,0],[.065,0],[.125,.5],[.25,.75],[.5,.81],[1,1]],[[0,0],[.015,.125],[.03,.375],
[.065,.625],[.25,.25],[1,1]])),a.checkNew(new a.Colormap("hsv",function(){var a,c,b,e,f,g,h,k=0,l=[];for(a=0;200>a;a++,k++){c=1-a/199;b=360*c+270;e=Math.abs(Math.sin(3.1416*c));for(c=Math.pow(1-c,1/3);360<=b;)b-=360;b/=60;h=Math.floor(b);f=b-h;b=c*(1-e);g=c*(1-e*f);e=c*(1-e*(1-f));l[k]=[];switch(h){case 0:l[k].push(c);l[k].push(e);l[k].push(b);break;case 1:l[k].push(g);l[k].push(c);l[k].push(b);break;case 2:l[k].push(b);l[k].push(c);l[k].push(e);break;case 3:l[k].push(b);l[k].push(g);l[k].push(c);
break;case 4:l[k].push(e);l[k].push(b);l[k].push(c);break;case 5:l[k].push(c),l[k].push(b),l[k].push(g)}}return l}())),a.checkNew(new a.Colormap("rainbow",[[0,1],[.2,0],[.6,0],[.8,1],[1,1]],[[0,0],[.2,0],[.4,1],[.8,1],[1,0]],[[0,1],[.4,1],[.6,0],[1,0]])),a.checkNew(new a.Colormap("standard",[[0,0],[.333,.3],[.333,0],[.666,.3],[.666,.3],[1,1]],[[0,0],[.333,.3],[.333,.3],[.666,1],[.666,0],[1,.3]],[[0,0],[.333,1],[.333,0],[.666,.3],[.666,0],[1,.3]])),a.checkNew(new a.Colormap("staircase",function(){var a,
c,b=0,e=[];for(a=1;5>=a;a++,b++)c=a/5,e[b]=[],e[b].push(.3*c),e[b].push(.3*c),e[b].push(c);for(a=1;5>=a;a++,b++)c=a/5,e[b]=[],e[b].push(.3*c),e[b].push(c),e[b].push(.3*c);for(a=1;5>=a;a++,b++)c=a/5,e[b]=[],e[b].push(c),e[b].push(.3*c),e[b].push(.3*c);return e}())),a.checkNew(new a.Colormap("color",[[0,0,0],[.18431,.18431,.18431],[.37255,.37255,.37255],[.56078,.56078,.56078],[.74902,.74902,.74902],[.93725,.93725,.93725],[0,.18431,.93725],[0,.37255,.74902],[0,.49804,.49804],[0,.74902,.3098],[0,.93725,
0],[.3098,.62353,0],[.49804,.49804,0],[.62353,.3098,0],[.93725,0,0],[.74902,0,.3098]])))};a.initCommands=function(){a.hasOwnProperty("Command")&&(a.checkNew(new a.Command({name:"analysis",alias:"run",help:"list/run analysis for current image",get:function(){var a,c,b,e,f,g="",h=this.image;if(h&&h.analysisPackages)for(c=0;c<h.analysisPackages.length;c++){f=h.analysisPackages[c];for(a=0;a<f.length;a++)e=f[a],g&&(g+=", "),b=e.xclass?e.xclass+":"+e.name:e.name,g+=sprintf("%s (%s)",e.title,b);c<h.analysisPackages.length-
1&&(g+="\n")}return g},set:function(d){var c,b=this.image;b&&((c=b.lookupAnalysis(d[0]))?c.purl?(d=b.displayAnalysis("params",a.InstallDir(c.purl),{title:c.title+": "+b.fitsFile}),$(d).data("dispid",b.display.id).data("aname",c.name)):b.runAnalysis(c.name):a.error("unknown analysis command '"+d[0]+"'"))}})),a.checkNew(new a.Command({name:"colormap",alias:"cmap",help:"set/get colormap for current image",get:function(){var a;if(a=this.image)return a=a.getColormap(),sprintf("%s %s %s",a.colormap,a.contrast,
a.bias)},set:function(a){var c=this.image;c&&c.setColormap.apply(c,[].concat($jscomp.arrayFromIterable(a)))}})),a.checkNew(new a.Command({name:"colormaps",alias:"cmaps",help:"get list of available colormaps",get:function(){var d,c="";for(d=0;d<a.colormaps.length;d++)c&&(c+=", "),c+=a.colormaps[d].name;return c}})),a.checkNew(new a.Command({name:"grid",help:"set/get coordinate grid for current image",get:function(){var a,c=this.image;c&&(a=c.displayCoordGrid());return a?"true":"false"},set:function(a){var c,
b=this.image;b&&(c=a[0].match(/true/i)?!0:!1,b.displayCoordGrid(c,a[1]))}})),a.checkNew(new a.Command({name:"help",help:"get list of available commmands",get:function(){var d,c,b="<table>";for(d=0;d<a.commands.length;d++)c=a.commands[d],b+="<tr><td>"+c.name+"</td><td>"+c.help,c.alias&&(b+=" ("+c.alias,c.alias2&&(b+=", "+c.alias2),b+=")"),b+="</td></tr>";return b+"</table>"}})),a.checkNew(new a.Command({name:"helper",help:"get/set helper connection",get:function(){return a.helper.connectinfo()},set:function(d){a.helper.connect(d[0].trim())}})),
a.checkNew(new a.Command({name:"image",help:"get name of currently loaded image or display specified image",get:function(){var a=this.image;if(a)return a.file},set:function(d){var c,b;for(c=0;c<a.images.length;c++)if(b=a.images[c],0<=b.file.search(d[0])&&b.display===this.display){b.displayImage("display");break}}})),a.checkNew(new a.Command({name:"images",help:"get list of currently loaded images",get:function(){var d,c,b="";for(d=0;d<a.images.length;d++)c=a.images[d],c.display===this.display&&(b&&
(b+=", "),b+=c.file);return b}})),a.checkNew(new a.Command({name:"load",help:"load image(s)",set:function(d){var c,b,e,f=d.length;for(c=0;c<f;c++){e=null;b=c+1;if(b<f&&0===d[b].indexOf("{"))try{e=JSON.parse(d[b])}catch(g){e=null}e?(a.Load(d[c],e,{display:this.display.id}),c++):a.Load(d[c],{display:this.display.id})}}})),a.checkNew(new a.Command({name:"pan",help:"set/get pan location for current image",get:function(){var a;if(a=this.image)return a=a.getPan(),sprintf("%s %s",a.x,a.y)},set:function(a){var c=
this.image;c&&c.setPan.apply(c,[].concat($jscomp.arrayFromIterable(a)))}})),a.checkNew(new a.Command({name:"pix2wcs",help:"get image pixel value for specified wcs position",set:function(d){var c=this.image;if(c)return d=a.Pix2WCS(parseFloat(d[0]),parseFloat(d[1]),{display:c}),d.str}})),a.checkNew(new a.Command({name:"print",help:"print image window",get:function(){var a=this.image;a&&a.print()}})),a.checkNew(new a.Command({name:"refresh",help:"refresh current image using specified file (def: use last file)",
set:function(d){var c,b,e,f=d.length;c=this.image;if(0===f)e={refresh:c},a.Load(c.file,e,{display:this.display.id});else for(c=0;c<f;c++){e=null;b=c+1;if(b<f&&0===d[b].indexOf("{"))try{e=JSON.parse(d[b])}catch(g){e=null}e?(e.refresh=!0,a.Load(d[c],e,{display:this.display.id}),c++):(e={refresh:!0},a.Load(d[c],e,{display:this.display.id}))}}})),a.checkNew(new a.Command({name:"regcnts",help:"counts in regions for current image",get:function(){var a=this.image;a&&a.countsInRegions("$sregions","$bregions",
{lightwin:!0})},set:function(a){var c=this.image;if(c)return c.countsInRegions.apply(c,[].concat($jscomp.arrayFromIterable(a)))}})),a.checkNew(new a.Command({name:"regions",alias:"reg",alias2:"region",help:"add region to current image or list all regions",get:function(){var a=this.image;if(a)return a.listRegions("all",{mode:0})||""},set:function(a){var c=this.image;c&&("delete"===a[0]||"remove"===a[0]?(a=a.slice(1).join(" "),c.removeShapes("regions",a)):(a=a.join(" "),c.addShapes("regions",a)))}})),
a.checkNew(new a.Command({name:"resize",help:"get/set display size for current image",get:function(){var a;if(a=this.image)return a=a.display,sprintf("%s %s",a.width,a.height)},set:function(a){var c,b;(c=this.image)&&a.length&&(c=c.display,b=parseInt(a[0],10),a=1<a.length?parseInt(a[1],10):b,c.resize(b,a))}})),a.checkNew(new a.Command({name:"scale",help:"set/get scaling for current image",get:function(){var a;if(a=this.image)return a=a.getScale(),sprintf("%s %s %s",a.scale,a.scalemin,a.scalemax)},
set:function(a){var c=this.image;c&&c.setScale.apply(c,[].concat($jscomp.arrayFromIterable(a)))}})),a.checkNew(new a.Command({name:"scales",help:"get list of available scales",get:function(){return a.scales.join(", ")}})),a.checkNew(new a.Command({name:"section",help:"display section of current image",set:function(d){var c,b=this.image;if(1===d.length&&"full"===d[0])b.displaySection("full");else{d=d.join(" ");try{c=JSON.parse(d)}catch(e){a.error("invalid JSON section")}b.displaySection(c)}}})),a.checkNew(new a.Command({name:"status",
help:"get status for specified (or current) image",get:function(d){var c,b,e,f="";for(c=0;c<a.images.length;c++)if(b=a.images[c],0<=b.file.search(d[0])){e=b;break}e?c=1:(c=0,e=this.image);if(e){if(c>d.length)return e.status.load;for(;c<d.length;c++)switch(b=d[c].toLowerCase().trim(),b){case "load":f&&(f+="\n"),f+=e.status.load}}return f}})),a.checkNew(new a.Command({name:"url",help:"display a url",set:function(d){a.DisplayHelp(d[0])}})),a.checkNew(new a.Command({name:"wcssys",help:"set/get wcs system for current image",
get:function(){var a=this.image;if(a)return a.getWCSSys()},set:function(a){var c=this.image;c&&c.setWCSSys(a[0])}})),a.checkNew(new a.Command({name:"wcsu",help:"set/get wcs units used for current image",get:function(){var a=this.image;if(a)return a.getWCSUnits()},set:function(a){var c=this.image;c&&c.setWCSUnits(a[0])}})),a.checkNew(new a.Command({name:"wcssystems",help:"get list of available wcs systems",get:function(){return a.wcssyss.join(", ")}})),a.checkNew(new a.Command({name:"wcsunits",help:"get list of available wcs units",
get:function(){return a.wcsunitss.join(", ")}})),a.checkNew(new a.Command({name:"wcs2pix",help:"get wcs position for specified image pixel",set:function(d){var c=this.image;if(c)return d=a.WCS2Pix(parseFloat(d[0]),parseFloat(d[1]),{display:c}),d.str}})),a.checkNew(new a.Command({name:"zoom",help:"set/get zoom for current image",get:function(){var a=this.image;if(a)return a.getZoom()},set:function(a){var c=this.image;c&&c.setZoom(a[0])}})))};a.initAnalysis=function(){$(document).on("keyup keypress",
".js9AnalysisForm",function(a){var c=$(this);if(13===(a.which||a.keyCode))return a.preventDefault(),(a=$(this).data("enterfunc"))&&c.find("[name='"+a+"']").click(),!1})};a.init=function(){var d;window.HTMLCanvasElement&&JSON||a.error("your browser does not support JS9 (no HTML5 canvas and/or JSON). Please try a modern version of Firefox, Chrome, Safari, Opera, or Edge.");window.hasOwnProperty("JS9Prefs")&&"object"===typeof JS9Prefs&&JS9Prefs.globalOpts&&JS9Prefs.globalOpts.installDir&&(a.INSTALLDIR=
JS9Prefs.globalOpts.installDir);if(!a.INSTALLDIR){try{$('link[href$="js9.css"]').each(function(){var c=$(this).attr("href");c&&"js9.css"===c.split("/").reverse()[0]&&(a.INSTALLDIR=c.replace(/js9\.css$/,""))})}catch(c){a.INSTALLDIR=""}a.INSTALLDIR&&(a.INSTALLDIR=a.cleanPath(a.INSTALLDIR))}a.INSTALLDIR&&"/"!==a.INSTALLDIR.slice(-1)&&(a.INSTALLDIR+="/");a.TOROOT=a.INSTALLDIR.replace(/([^/.])+/g,"..");window.hasOwnProperty("JS9Inline")&&"object"===typeof JS9Inline&&(a.inline=$.extend(!0,{},JS9Inline));
"dhtml"===a.LIGHTWIN&&($("<div>").attr("id","dhtmlwindowholder").appendTo($(document.body)).append("<span style='display:none'>.</span>"),dhtmlwindow.imagefiles=a.inline?[a.inline["images/min.gif"],a.inline["images/close.gif"],a.inline["images/restore.gif"],a.inline["images/resize.gif"]]:a.allinone?[a.allinone.min,a.allinone.close,a.allinone.restore,a.allinone.resize]:[a.InstallDir("images/min.gif"),a.InstallDir("images/close.gif"),a.InstallDir("images/restore.gif"),a.InstallDir("images/resize.gif")],
window.hasOwnProperty("Jupyter")&&$("#dhtmlwindowholder").arrive("input",function(){a.jupyterFocus($(this).parent())}));a.globalOpts.plotLibrary=a.globalOpts.plotLibrary||"flot";"plotly"!==a.globalOpts.plotLibrary||window.hasOwnProperty("Plotly")||(a.globalOpts.plotLibrary="flot");window.hasOwnProperty("JS9Prefs")&&"object"===typeof JS9Prefs?a.mergePrefs(JS9Prefs):a.PREFSFILE&&(a.loadPrefs(a.InstallDir(a.PREFSFILE),1),a.loadPrefs(a.PREFSFILE,0));a.hasOwnProperty("Regions")&&$.extend(!0,a.Regions.opts,
a.regionOpts);delete a.regionOpts;a.hasOwnProperty("Catalogs")&&$.extend(!0,a.Catalogs.opts,a.catalogOpts);delete a.catalogOpts;a.hasOwnProperty("Crosshair")&&$.extend(!0,a.Crosshair.opts,a.crosshairOpts);delete a.crosshairOpts;a.hasOwnProperty("Grid")&&$.extend(!0,a.Grid.opts,a.gridOpts);delete a.gridOpts;a.hasOwnProperty("Module")&&$.extend(!0,Module,a.emscriptenOpts);delete a.emscriptenOpts;a.globalOpts.resize||(a.globalOpts.resizeHandle=!1);void 0!==a.analOpts.prependJS9Dir&&(a.globalOpts.prependJS9Dir=
a.analOpts.prependJS9Dir,delete a.analOpts.prependJS9Dir);void 0!==a.analOpts.dataDir&&(a.globalOpts.dataDir=a.analOpts.dataDir,delete a.analOpts.dataDir);a.BROWSER[3]&&(a.globalOpts.resizeHandle=!1);if(window.hasOwnProperty("localStorage")&&a.globalOpts.localStorage){try{d=localStorage.getItem("globals")}catch(c){d=null}if(d){try{a.userOpts.displays=JSON.parse(d)}catch(c){}a.userOpts.displays&&$.extend(!0,a.globalOpts,a.userOpts.displays)}try{d=localStorage.getItem("images")}catch(c){d=null}if(d){try{a.userOpts.images=
JSON.parse(d)}catch(c){}a.userOpts.images&&$.extend(!0,a.imageOpts,a.userOpts.images)}try{d=localStorage.getItem("fits")}catch(c){d=null}if(d)try{a.userOpts.fits=JSON.parse(d)}catch(c){}try{d=localStorage.getItem("regions")}catch(c){d=null}if(d){try{a.userOpts.regions=JSON.parse(d)}catch(c){}a.userOpts.regions&&$.extend(!0,a.Regions.opts,a.userOpts.regions)}try{d=localStorage.getItem("grid")}catch(c){d=null}if(d){try{a.userOpts.images=JSON.parse(d)}catch(c){}a.userOpts.images&&$.extend(!0,a.Grid.opts,
a.userOpts.images)}try{d=localStorage.getItem("catalog")}catch(c){d=null}if(d){try{a.userOpts.images=JSON.parse(d)}catch(c){}a.userOpts.images&&$.extend(!0,a.Catalogs.Opts,a.userOpts.images)}}a.DEBUG=a.DEBUG||a.globalOpts.debug||0;$("div.JS9").each(function(){a.checkNew(new a.Display($(this)))});if(window.Worker&&!a.allinone)try{a.worker=new a.WebWorker(a.InstallDir(a.WORKERFILE))}catch(c){}a.allinone?a.initFITS():a.initEmscripten();a.helper=new a.Helper;window.addEventListener("message",function(c){var b,
d;b=c.origin||c.originalEvent.origin;c=c.data;"null"===b&&(b="unknown");if(a.globalOpts.postMessage){if("string"===typeof c)try{d=JSON.parse(c)}catch(f){a.error("can't parse msg: "+c,f)}else"object"===typeof c?d=c:a.error("invalid msg from postMessage");a.msgHandler(d,function(a,b,c,e){e=e||{};parent.postMessage({cmd:d.cmd,res:{name:e.name,rtype:e.rtype,rdata:a,stdout:a,stderr:b,errcode:c}},"*")})}else a.DEBUG&&(b=sprintf("JS9 ignoring postMessage, origin: %s",b),b="string"===typeof c?b+sprintf(" data: %s",
c):"object"===typeof c?b+sprintf(" obj: %s",JSON.stringify(Object.keys(c))):b+sprintf(" typeof: %s",typeof c),a.log(b))},!1);window.hasOwnProperty("ImageFilters")&&(a.ImageFilters=ImageFilters);a.initColormaps();a.initCommands();a.initAnalysis();a.RegisterPlugin(a.MouseTouch.CLASS,a.MouseTouch.NAME,a.MouseTouch.init,{menuItem:"Mouse/Touch",onplugindisplay:a.MouseTouch.init,help:"help/mousetouch.html",winTitle:"Mouse/Touch Actions",winResize:!0,winDims:[a.MouseTouch.WIDTH,a.MouseTouch.HEIGHT]});a.RegisterPlugin(a.Regions.CLASS,
a.Regions.NAME,a.Regions.init,{divArgs:["regions"],winDims:[0,0]});a.RegisterPlugin(a.Crosshair.CLASS,a.Crosshair.NAME,a.Crosshair.init,{onmousemove:a.Crosshair.display,onkeyboardaction:a.Crosshair.keyaction,onkeyup:a.Crosshair.keyup,onimageload:a.Crosshair.create,winDims:[0,0]});a.RegisterPlugin(a.Grid.CLASS,a.Grid.NAME,a.Grid.init,{onsetpan:a.Grid.regrid,onsetzoom:a.Grid.regrid,onsetwcssys:a.Grid.regrid,onsetwcsunits:a.Grid.regrid,onimageload:a.Grid.regrid,onupdateprefs:a.Grid.regrid,winDims:[0,
0]});a.RegisterPlugin(a.Dysel.CLASS,a.Dysel.NAME,a.Dysel.init,{onimageload:a.Dysel.imageload,onimageclose:a.Dysel.imageclose,winDims:[0,0]});a.instantiatePlugins();a.plugins.sort(function(a,b){var c=a.opts.menuItem,d=b.opts.menuItem;return c?!d||c<d?-1:c>d?1:0:1});$(document).scrollTop(0);a.inited=!0;$(document).trigger("JS9:init")};a.parsePublicArgs=function(a){var c=null;a=a.slice();var b=a[a.length-1];b&&"object"===typeof b&&b.hasOwnProperty("display")&&1===Object.keys(b).length&&(c=b.display,
a.pop());return{argv:a,display:c}};a.mkPublic=function(d,c){"string"===typeof c?a.Image.prototype[c]?(a[d]=function(b){for(var d=[],f=0;f<arguments.length;++f)d[f-0]=arguments[f];f=a.parsePublicArgs(d);if(d=a.getImage(f.display))return f=d[c].apply(null,[].concat($jscomp.arrayFromIterable(f.argv))),f===d||f===d.display?a.globalOpts.quietReturn?"":"OK":f},a.publics[d]=a[d]):a.error("unknown image function for mkPublic: "+c):"function"===typeof c?(a[d]=c,a.publics[d]=a[d]):a.error("unsupported type for mkPublic: "+
typeof c)};a.mkPublic("CloseImage","closeImage");a.mkPublic("DisplayImage","displayImage");a.mkPublic("DisplayExtension","displayExtension");a.mkPublic("DisplaySlice","displaySlice");a.mkPublic("DisplaySection","displaySection");a.mkPublic("BlendImage","blendImage");a.mkPublic("GetColormap","getColormap");a.mkPublic("SetColormap","setColormap");a.mkPublic("GetZoom","getZoom");a.mkPublic("SetZoom","setZoom");a.mkPublic("GetPan","getPan");a.mkPublic("SetPan","setPan");a.mkPublic("AlignPanZoom","alignPanZoom");
a.mkPublic("GetScale","getScale");a.mkPublic("SetScale","setScale");a.mkPublic("GetParam","getParam");a.mkPublic("SetParam","setParam");a.mkPublic("GetValPos","updateValpos");a.mkPublic("ImageToDisplayPos","imageToDisplayPos");a.mkPublic("DisplayToImagePos","displayToImagePos");a.mkPublic("ImageToLogicalPos","imageToLogicalPos");a.mkPublic("LogicalToImagePos","logicalToImagePos");a.mkPublic("GetWCSUnits","getWCSUnits");a.mkPublic("SetWCSUnits","setWCSUnits");a.mkPublic("GetWCS","getWCS");a.mkPublic("SetWCS",
"setWCS");a.mkPublic("GetWCSSys","getWCSSys");a.mkPublic("SetWCSSys","setWCSSys");a.mkPublic("ShowShapeLayer","showShapeLayer");a.mkPublic("ActiveShapeLayer","activeShapeLayer");a.mkPublic("ToggleShapeLayers","toggleShapeLayers");a.mkPublic("AddShapes","addShapes");a.mkPublic("RemoveShapes","removeShapes");a.mkPublic("GetShapes","getShapes");a.mkPublic("ChangeShapes","changeShapes");a.mkPublic("DisplayCoordGrid","displayCoordGrid");a.mkPublic("Print","print");a.mkPublic("SavePNG","savePNG");a.mkPublic("SaveJPEG",
"saveJPEG");a.mkPublic("SaveFITS","saveFITS");a.mkPublic("UploadFITSFile","uploadFITSFile");a.mkPublic("CountsInRegions","countsInRegions");a.mkPublic("RadialProfile","radialProfile");a.mkPublic("Plot3D","plot3d");a.mkPublic("RunAnalysis","runAnalysis");a.mkPublic("GetAnalysis","getAnalysis");a.mkPublic("RawDataLayer","rawDataLayer");a.mkPublic("GaussBlurData","gaussBlurData");a.mkPublic("ImarithData","imarithData");a.mkPublic("RotateData","rotateData");a.mkPublic("ReprojectData","reprojectData");
a.mkPublic("ShiftData","shiftData");a.mkPublic("FilterRGBImage","filterRGBImage");a.mkPublic("MoveToDisplay","moveToDisplay");a.mkPublic("LookupImage",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];c=a.parsePublicArgs(c);return a.lookupImage(c.argv[0],c.display)});a.mkPublic("LookupDisplay",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];c=a.parsePublicArgs(c);return a.lookupDisplay(c.argv[0]||c.display,c.argv[1])});a.mkPublic("RenameDisplay",function(d){for(var c=
[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e,b=a.parsePublicArgs(c);switch(b.argv.length){case 0:return;case 1:c=b.display;b=b.argv[0];break;default:c=b.argv[0],b=b.argv[1]}(e=a.lookupDisplay(c))&&e.id&&(c=e.id,e.oid||(e.oid=c),e.id=b,a.helper.send("renameDisplay",{odisplay:c,ndisplay:e.id}))});a.mkPublic("CloseDisplay",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e,c=a.parsePublicArgs.apply(a,[].concat($jscomp.arrayFromIterable(c)));e=a.lookupDisplay(c.argv[0]||
c.display);for(c=a.images.length-1;0<=c;c--)b=a.images[c],b.display===e&&b.closeImage()});a.mkPublic("AddColormap",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e,f,g,h,k=a.parsePublicArgs(c),l=function(b,c){var d,e;"object"!==typeof b&&a.error("invalid colormap object for JS9.AddColormap()");$.isArray(b)||(b=[b]);for(d=0;d<b.length;d++)e=b[d],e.name||a.error("missing name for colormap in JS9.AddColormap()"),e.vertices?a.AddColormap(e.name,e.vertices[0],e.vertices[1],
e.vertices[2],c):e.colors?a.AddColormap(e.name,e.colors,c):a.error("unknown colormap type for JS9.AddColormap()")},c=k.argv[0];e=k.argv[1];b=k.argv[2];f=k.argv[3];g=k.argv[4];if(c instanceof Blob)b=new FileReader,b.onload=function(b){try{h=JSON.parse(b.target.result)}catch(m){a.error("can't parse json colormap",m)}l(h,e)},b.readAsText(c);else if("object"===typeof c)l(c,e);else switch(k.argv.length){case 1:try{h=JSON.parse(c)}catch(n){a.error("can't parse JSON colormap",n)}l(h);break;case 2:case 3:if("string"===
typeof e)try{e=JSON.parse(e)}catch(n){a.error("can't parse JSON colormap",n)}a.checkNew(new a.Colormap(c,e));2===k.argv.length?a.globalOpts.topColormaps.push(c):"object"===typeof b&&!1===b.toplevel||a.globalOpts.topColormaps.push(c);break;case 4:case 5:if("string"===typeof e)try{e=JSON.parse(e)}catch(n){a.error("can't parse JSON colormap",n)}if("string"===typeof b)try{b=JSON.parse(b)}catch(n){a.error("can't parse JSON colormap",n)}if("string"===typeof f)try{f=JSON.parse(f)}catch(n){a.error("can't parse JSON colormap",
n)}a.checkNew(new a.Colormap(c,e,b,f));4===k.argv.length?a.globalOpts.topColormaps.push(c):g&&"object"===typeof g&&!1===g.toplevel||a.globalOpts.topColormaps.push(c);break;default:a.error("AddColormap() requires a colormap name and 1 or 3 args")}});a.mkPublic("LoadColormap",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e,b=a.parsePublicArgs(c),c=b.argv[0];e=b.argv[1];c||a.error("JS9.LoadColormap: no file specified for colormap load");"object"===typeof c?a.AddColormap(c,
e):"string"===typeof c?(c=a.fixPath(c),a.fetchURL(null,c,null,function(b){a.AddColormap(b,e)})):a.error("unknown file type for LoadColormap: "+typeof c)});a.mkPublic("SetRGBMode",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e,f,g=a.parsePublicArgs(c),h=["red","green","blue"],k=["rid","gid","bid"];e=g.argv[0];f=g.argv[1];void 0===e&&(e=!a.globalOpts.rgb.active);if(f)for(c=0;3>c;c++)b=f[k[c]],"string"===typeof b&&(b=a.LookupImage(b)),b&&b.setColormap(h[c]);"true"===e?
e=!0:"false"===e&&(e=!1);a.globalOpts.rgb.active=!!e;a.DisplayImage({display:g.display});return a.globalOpts.rgb.active});a.mkPublic("GetRGBMode",function(){return{active:a.globalOpts.rgb.active,rid:a.globalOpts.rgb.rim?a.globalOpts.rgb.rim.id:null,gid:a.globalOpts.rgb.gim?a.globalOpts.rgb.gim.id:null,bid:a.globalOpts.rgb.bim?a.globalOpts.rgb.bim.id:null}});a.mkPublic("SetValPos",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e,b=null;e=a.parsePublicArgs(c);c=a.getImage(e.display);
e=e.argv[0];c&&(b=c.params.valpos,c.params.valpos=e);return b});a.mkPublic("SetImageInherit",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e,b=null;e=a.parsePublicArgs(c);c=a.getImage(e.display);e=e.argv[0];c&&(b=c.params.inherit,c.params.inherit=e);return b});a.mkPublic("GetImageInherit",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];b=null;c=a.parsePublicArgs(c);if(c=a.getImage(c.display))b=c.params.inherit;return b});a.mkPublic("Load",function(d){for(var c=
[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e,f,g,h,k,b="fits";f=a.parsePublicArgs(c);k=f.argv[0];c=f.argv[1];if(k){f=f.display?f.display:0<a.displays.length?a.displays[0].id:a.DEFID;if("object"===typeof c)c=$.extend(!0,{},c);else if("string"===typeof c)try{c=JSON.parse(c)}catch(l){c={}}else c={};c.display=c.display||f;c.onload?g=c.onload:a.imageOpts.onload&&(g=a.imageOpts.onload,c.onload=g);if(k instanceof Blob){if(k.path||k.name)if(c.filename=k.path||k.name,f="object"===typeof c.refresh?
c.refresh:a.lookupImage(c.filename,c.display))if(a.isNull(c.refresh)&&(c.refresh=a.globalOpts.reloadRefresh),c.refresh)c.refresh=f;else{f.displayImage("display",c);f.refreshLayers();f.display.clearMessage();a.waiting(!1);return}else delete c.refresh;else delete c.refresh;c.filename||(c.filename=a.ANON+a.uniqueID());if(k.type&&-1!==k.type.indexOf("image/"))switch(k.type){case "image/fits":break;default:b="img"}else c.filename.split(".").pop().match(/(png|jpg|jpeg)/i)&&(b="img");switch(b){case "fits":h=
$.extend(!0,{},a.fits.options,c);k.path&&c.localAccess&&(g=a.localAccess(k.path))&&(k=k.path,h.file=k,h.vfile=g);try{a.handleFITSFile(k,h,a.NewFitsImage)}catch(l){a.error("can't process FITS file",l)}break;case "img":try{a.handleImageFile(k,c,a.Load)}catch(l){a.error("can't process IMG file",l)}}}else if("object"===typeof k)a.checkNew(new a.Image(k,c,g));else if("string"!==typeof k&&a.error("unknown file type for Load: "+typeof k),"U0lNUExFICA9"===k.slice(0,12)&&(k=window.atob(k)),"SIMPLE  ="===k.slice(0,
9)){g=[];for(e=0;e<k.length;e++)g[e]=k.charCodeAt(e);e=new Blob([new Uint8Array(g)]);c.filename||(c.filename=a.ANON+a.uniqueID());e.name=c.filename;h=$.extend(!0,{},a.fits.options,c);try{a.handleFITSFile(e,h,a.NewFitsImage)}catch(l){a.error("can't process FITS file",l)}}else{a.isNull(c.refresh)&&(c.refresh=a.globalOpts.reloadRefresh);if(c.refresh)if("object"===typeof c.refresh)f=c.refresh;else{if(b=k.split("/").reverse()[0],f=a.lookupImage(b,c.display))c.refresh=f}else b=k.split("/").reverse()[0],
f=a.lookupImage(b,c.display);f&&!c.refresh?(f.displayImage("all",c),f.display.clearMessage(),a.waiting(!1)):(k=a.cleanPath(k),"png"===k.split(".").pop().toLowerCase()?a.globalOpts.pngisfits?a.checkNew(new a.Image(k,c,g)):(k=a.fixPath(k,c),a.fetchURL(null,k,c,a.NewFitsImage)):a.fits2RepFile(c.display,k,c,"fits")||a.fits2RepFile(c.display,k,c,"png",g)||(c.display&&(e=a.lookupDisplay(c.display)),a.waiting(!0,e),f&&c.refresh&&a.cleanupFITSFile(f.raw,!0),k=a.fixPath(k,c),e=k.replace(/\[.*\]/,""),(g=a.localAccess(k))?
(h=$.extend(!0,{},a.fits.options,c),h.file=k,h.vfile=g,window.setTimeout(function(){try{a.handleFITSFile(k,h,a.NewFitsImage)}catch(l){a.error("can't process FITS file",l)}},0)):a.fetchURL(k,e,c)))}}else a.error("JS9.Load: no file specified for image load")});a.mkPublic("LoadWindow",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e,f,g,h,k,l,n,m,r,q,t,u,v,p,w,x,A,z,C=a.lightOpts[a.LIGHTWIN];z=a.parsePublicArgs(c);var D=function(b){b=$.inArray(b,a.displays);0<=b&&a.displays.splice(b,
1)};l=function(b,c,d){var f,g;c=c||{};c.clone&&(g=a.lookupDisplay(c.clone,!1));d&&(v=d.match(/(.*width=)([0-9]+)(px,height=)([0-9]+)(px.*)/,"$1@@H@@$3"),p=parseInt(v[2],10),w=parseInt(v[4],10));f=sprintf("<hr class='hline0'>");!g||0<$("#"+c.clone+"Menubar").length&&!g.pluginInstances.JS9Menubar.isDynamic?f+=sprintf("<div class='JS9Menubar' id='%sMenubar'></div>",b):d&&(w-=40);f+=sprintf("<div class='JS9' id='%s'></div>",b);!g||0<$("#"+c.clone+"Colorbar").length&&!g.pluginInstances.JS9Colorbar.isDynamic?
(e=g&&g.pluginInstances.JS9Colorbar?sprintf("data-showTicks='%s'",g.pluginInstances.JS9Colorbar.showTicks):"",f+=sprintf("<div style='margin-top: 2px;'><div class='JS9Colorbar' id='%sColorbar' %s></div></div>",b,e),g&&g.pluginInstances.JS9Colorbar&&!g.pluginInstances.JS9Colorbar.showTicks&&(w-=15)):d&&(w-=44);return d?(a.Dysel.retrievePlugins().length&&(p+=2,w+=2),{html:f,winopts:v[1]+String(p)+v[3]+String(w)+v[5]}):f};k=function(b,c){var d;d=new a.Display(f);d.winid=m;a.helper.send("addDisplay",
{display:f});a.instantiatePlugins();c.display=f;b&&a.Load(b,c);return d};var y=function(b){var c,d;d=0;var e=[];for(c=0;c<a.images.length;c++)d=a.images[c],d.display.id===f&&e.push(d);if(!e.length)return D(b),!0;if("move"===a.globalOpts.lightWinClose){if(a.isNull(a.globalOpts.lightWinMoveTo)||a.globalOpts.lightWinMoveTo===f)d=0;else for(d=c=0;c<a.displays.length;c++)if(a.displays[c].id===a.globalOpts.lightWinMoveTo){d++;break}d||(a.globalOpts.lightWinClose="ask",delete a.globalOpts.lightWinMoveTo)}switch(a.globalOpts.lightWinClose){case "close":D(b);
for(c=0;c<e.length;c++)try{e[c].closeImage()}catch(E){}return!0;case "move":D(b);for(c=0;c<e.length;c++)try{e[c].moveToDisplay(a.globalOpts.lightWinMoveTo)}catch(E){}return!0;default:return r="lightCloseID"+a.uniqueID(),a.allinone?(q="inline",t=a.allinone.lightCloseHTML):(q="ajax",t=a.InstallDir(a.lightOpts.lcloseURL)),$("#dhtmlwindowholder").arrive("#lightWinCloseForm",{onceOnly:!0},function(){var b,c;c=$("#lightWinCloseForm").find("#lightWinCloseSel");for(b=0;b<a.displays.length;b++)a.displays[b].id!==
f&&c.append($("<option>",{value:a.displays[b].id,text:a.displays[b].id}))}),h=a.lightWin(r,q,t,"Closing a light window",C.lcloseWin),$(h).data("dispid",f),$(h).data("winid",m),!1}},b=z.argv[0];x=z.argv[1];A=z.argv[2];c=z.argv[3];z=z.argv[4];if("object"===typeof x)x=$.extend(!0,{},x);else if("string"===typeof x)try{x=JSON.parse(x)}catch(B){x={}}else x={};A=A||"light";u=(A||"")+"win";switch(A){case "light":return x.id?(f=x.id,delete x.id):f=u+a.uniqueID(),h="d"+f,c?z=z||C.imageWin:(n=l(f,x,C.imageWin),
c=n.html,z=z||n.winopts),n=sprintf("JS9 Display"+a.IDFMT,f),m=a.lightWin(h,"inline",c,n,z),g=k(b,x),m.onclose=function(){return y(g)},f;case "new":x.id?(f=x.id,delete x.id):f=u+a.uniqueID();z=z||sprintf("width=%s, height=%s",a.globalOpts.newWindowWidth,a.globalOpts.newWindowHeight);k=document.getElementsByTagName("head")[0].innerHTML;k=k.replace(/src=['"].*astroemw?\.js['"]/,"");k.match(/src=["'].*js9\.js/)||k.match(/src=["'].*js9\.min\.js/)||(k+=sprintf('<%s type="text/javascript" src="js9.min.js"></%s>',
"script","script"));l=c||l(f,x);c=sprintf("<html><head>%s</head><body",k);b&&(c+=sprintf(" onload='JS9.Preload(\"%s\",%s);'",b,JSON.stringify(x)));c+=sprintf(">%s</body></html>\n",l);window.isElectron&&(n="data:text/html,<html><body><script>window.addEventListener('message', function(ev){document.documentElement.innerHTML=ev.data\x3c/script><p></body></html>");if(n=window.open(n,f,z))return n.document?(n.document.open(),n.document.write(c),n.document.close()):n.postMessage?a.error("LoadWindow('new') is disabled on the Desktop for security reasons"):
a.error("no method available for drawing image into window"),f;a.error("could not create window (check your pop-up blockers)")}});a.mkPublic("LoadProxy",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e,f,g,h,k=a.parsePublicArgs(c);g=k.argv[0];h=k.argv[1];a.globalOpts.loadProxy||a.error("proxy load not available for this server");a.globalOpts.workDir||a.error("proxy load requires a temp workDir this server");g||a.error("no url specified for proxy load");g=g.trim();g.match(/dropbox\.com/)?
(g=g.replace("www.dropbox.com","dl.dropboxusercontent.com"),g=g.replace("?dl=0","")+"?raw=1"):g.match(/drive\.google\.com/)&&(g=g.replace(/\/file\/d\/(\w+)\/\w+\?usp=sharing/,"/uc?export=download&id=$1"));k.display&&(f=a.lookupDisplay(k.display));if("object"===typeof h)h=$.extend(!0,{},h);else if("string"===typeof h)try{h=JSON.parse(h)}catch(l){h={}}else h={};a.waiting(!0,f);a.Send("loadproxy",{cmd:"js9Xeq loadproxy "+g},function(b){b="object"===typeof b?b:0<=b.search(a.analOpts.epattern)?{stderr:b}:
{stdout:b};b.errcode=b.errcode||0;b.stderr?a.error(b.stderr):b.stdout?(void 0===h.fits2png&&(h.fits2png=!1),e=a.cleanPath(b.stdout),h.proxyFile=e,"/"!==e.charAt(0)&&(e=a.InstallDir(e)),h.fixpath=!1,h.proxyURL=g,a.Load(e,h,{display:k.display})):a.error("internal error: no return from load proxy command")})});a.mkPublic("Preload",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e,f,g,h,b="",k=null,l=null,n=c.length,m=a.globalOpts.alerts;f=a.parsePublicArgs(c);var r=a.URLEXP,
q=/\.ses$/,t=/\.cmap$/;e=f.argv[0];a.globalOpts.loadProxy&&a.helper.baseurl&&(g=new RegExp("^"+a.helper.baseurl));f.display&&(l={display:f.display},--n);switch(n){case 0:e=(null===a.helper.connected||a.helper.connected)&&a.fits.name&&0<a.preloads.length?2:3;break;case 1:e="boolean"===typeof e?e&&0<a.preloads.length?2:3:(null===a.helper.connected||a.helper.connected)&&a.fits.name?1:0;break;default:e=(null===a.helper.connected||a.helper.connected)&&a.fits.name?1:0}switch(e){case 0:for(e=0;e<n;e++)if(f=
e+1,f<n&&"object"===typeof c[f])k=$.extend(!0,{},c[f]),a.preloads.push([c[e],k,l]),e++;else if(f<n&&0===c[f].indexOf("{")){try{k=JSON.parse(c[f])}catch(u){k=null}a.preloads.push([c[e],k,l]);e++}else a.preloads.push([c[e],null,l]);break;case 1:a.globalOpts.alerts=!1;for(e=0;e<n;e++)if(h=g&&c[e].match(r)&&!c[e].match(g)?a.LoadProxy:c[e].match(q)?a.LoadSession:c[e].match(t)?a.LoadColormap:a.Load,f=e+1,f<n&&"object"===typeof c[f]){if(h===a.Load||h===a.LoadProxy)a.preloadwaiting[a.cleanPath(c[e])]=!0;
try{l?h(c[e],c[f],l):h(c[e],c[f])}catch(u){b=b+" "+c[e]}e++}else if(f<n&&0===c[f].indexOf("{")){try{k=JSON.parse(c[f])}catch(u){k=null}if(h===a.Load||h===a.LoadProxy)a.preloadwaiting[a.cleanPath(c[e])]=!0;try{l?h(c[e],k,l):h(c[e],k)}catch(u){b=b+" "+c[e]}e++}else{if(h===a.Load||h===a.LoadProxy)a.preloadwaiting[a.cleanPath(c[e])]=!0;try{l?h(c[e],null,l):h(c[e],null)}catch(u){b=b+" "+c[e]}}a.globalOpts.alerts=m;b&&a.error("could not preload image(s): "+b);break;case 2:a.globalOpts.alerts=!1;for(e=0;e<
a.preloads.length;e++){h=g&&a.preloads[e][0].match(r)&&!a.preloads[e][0].match(g)?a.LoadProxy:a.preloads[e][0].match(q)?a.LoadSession:a.preloads[e][0].match(t)?a.LoadColormap:a.Load;if(h===a.Load||h===a.LoadProxy)a.preloadwaiting[a.cleanPath(a.preloads[e][0])]=!0;try{a.preloads[e][2]?h(a.preloads[e][0],a.preloads[e][1],a.preloads[e][2]):h(a.preloads[e][0],a.preloads[e][1])}catch(u){b=b+" "+a.preloads[e][0]}}a.globalOpts.alerts=m;b&&a.error("could not preload image(s): "+b);a.preloads=[]}});a.mkPublic("RefreshImage",
function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e,f=a.parsePublicArgs(c),g=a.getImage(f.display),h=function(a){g.refreshImage(a,e)},b=f.argv[0];e=f.argv[1]||{};if(g)if(e.id=g.id,b instanceof Blob){e.rawid&&e.rawid!==g.raw.id||a.cleanupFITSFile(g.raw,!0);try{a.handleFITSFile(b,a.fits.options,h)}catch(k){a.error("can't refresh FITS file",k)}}else g.refreshImage(b,e);else b instanceof Blob&&a.Load.apply(a,[].concat($jscomp.arrayFromIterable(c)))});a.mkPublic("GetLoadStatus",
function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e,f,b=a.parsePublicArgs(c),c=a.getImage(b.display),b=b.argv[0];return c?(b&&"object"===typeof b&&b.hasOwnProperty("id")&&(b=b.id),"string"===typeof b&&(f=b.split("/").reverse()[0]),c.file0&&(e=c.file0.split("/").reverse()[0],f&&!f.match(/\[.*\]/)&&(e=e.replace(/\[.*\]/,""))),!b||c.id0===b||c.file0===b||e&&f&&e===f?c.status.load:"other"):"none"});a.mkPublic("CopyToClipboard",function(d,c){var b,e,f;a.clipboard=d;f=document.createElement("textarea");
f.style.position="fixed";f.style.top=0;f.style.left=0;f.style.width="2em";f.style.height="2em";f.style.padding=0;f.style.border="none";f.style.outline="none";f.style.boxShadow="none";f.style.background="transparent";f.value=d;document.body.appendChild(f);f.select();try{(e=document.execCommand("copy"))?b="OK":(b="MANUAL",a.BROWSER[2].match(/Mac/)?window.prompt("copy to clipboard: Cmd+C",d):window.prompt("copy to clipboard: Ctrl+C",d))}catch(g){b="ERROR"}document.body.removeChild(f);c&&c.display&&(c.display.divjq.trigger("mouseout"),
c.display.divjq.trigger("mouseenter"));return b});a.mkPublic("CopyFromClipboard",function(){return a.clipboard||""});a.mkPublic("OpenFileMenu",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];c=a.parsePublicArgs(c);(c=a.lookupDisplay(c.display))&&$("#openLocalLoad-"+c.id).click()});a.mkPublic("OpenRegionsMenu",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];c=a.parsePublicArgs(c);(c=a.lookupDisplay(c.display))&&$("#openLocalLoadRegions-"+c.id).click()});
a.mkPublic("OpenSessionMenu",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];c=a.parsePublicArgs(c);(c=a.lookupDisplay(c.display))&&$("#openLocalLoadSession-"+c.id).click()});a.mkPublic("OpenCatalogsMenu",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];c=a.parsePublicArgs(c);(c=a.lookupDisplay(c.display))&&$("#openLocalLoadCatalog-"+c.id).click()});a.mkPublic("OpenColormapMenu",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];
c=a.parsePublicArgs(c);(c=a.lookupDisplay(c.display))&&$("#openLocalLoadColormap-"+c.id).click()});a.mkPublic("SaveColormap",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e,f,g;f=a.parsePublicArgs(c);var c=f.argv[0],b=f.argv[1],h=function(a){var b=a;if("string"===typeof a)try{b=JSON.parse(a)}catch(m){}return b},k=function(b){var c,d,e=[];for(c=0;c<b.length;c++)if(d=a.lookupColormap(b[c]))d=$.extend(!0,{},d),delete d.type,e.push(d);return 1===e.length?e[0]:e};if(window.hasOwnProperty("saveAs")){if(f=
a.getImage(f.display))c=h(c),b=h(b),c?"string"===typeof c?(e=c,"string"===typeof b?g=k([b]):$.isArray(b)?g=k(b):(g=$.extend(!0,{},f.cmapObj),delete g.type)):$.isArray(c)&&(e="js9.cmap",g=k(c)):(e="js9.cmap",g=$.extend(!0,{},f.cmapObj),delete g.type),g=JSON.stringify(g),g=new Blob([g],{type:"text/plain"}),saveAs(g,e)}else a.error("no saveAs function available to save colormap");return e});a.mkPublic("NewFitsImage",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e,f,g;f=
a.parsePublicArgs(c);c=f.argv[0];b=f.argv[1]||{};f=a.lookupDisplay(f.display||b.display||a.DEFID);b.refresh?("object"===typeof b.refresh?g=b.refresh:f&&f.image&&(g=f.image),g?(b.onload&&(b.onrefresh=b.onload,delete b.onload),g.refreshImage(c,b)):(b.onload&&(e=b.onload),a.checkNew(new a.Image(c,b,e)))):(b.onload&&(e=b.onload),a.checkNew(new a.Image(c,b,e)))});a.mkPublic("GetImage",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];c=a.parsePublicArgs(c);(b=c.argv[0])&&"string"!==
typeof b&&(b=c.display);return a.getImage(b)});a.mkPublic("GetImageData",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];b=a.parsePublicArgs(c);c=a.getImage(b.display);b=b.argv[0];return c?c.getImageData(b):null});a.mkPublic("GetDisplayData",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e,f,g,b=[];e=a.parsePublicArgs(c);c=e.display||a.displays[0].id;g=e.argv[0];for(e=0;e<a.images.length;e++)f=a.images[e],f.display.id===c&&b.push(f.getImageData(g));
return b});a.mkPublic("GetFITSHeader",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e,b="";e=a.parsePublicArgs(c);c=a.getImage(e.display);e=e.argv[0];c&&c.raw&&(b=a.raw2FITS(c.raw,{addcr:e}));return b});a.mkPublic("BlendDisplay",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e,f,b=[];f=a.parsePublicArgs(c);c=f.display||a.DEFID;e=a.lookupDisplay(c);f=f.argv[0];e||a.error("no JS9 display found: "+c);if(void 0===f||"mode"===f)return e.blendMode;
if("list"===f){for(e=0;e<a.images.length;e++)f=a.images[e],f.display.id===c&&f.blend.active&&b.push(f.id);return b}"true"===f?f=!0:"false"===f&&(f=!1);e.blendMode=!!f;e.image&&(e.image.xeqPlugins("image","ondisplayblend"),e.image.displayImage());return e.blendMode});a.mkPublic("LoadAuxFile",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e;e=a.parsePublicArgs(c);b=a.getImage(e.display);c=e.argv[0];e=e.argv[1];b?b.loadAuxFile(c,e):a.error("could not find image for aux file: "+
c)});a.mkPublic("SubmitAnalysis",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e,f,g,h,c=a.parsePublicArgs(c);f=c.argv[0];var b=c.argv[1],k=c.argv[2];e=a.lightOpts[a.LIGHTWIN];b?e=a.lookupDisplay(c.display).id:(e=$(f).closest(e.top),b=e.data("aname"),e=e.data("dispid"));b?e&&(g=a.getImage(e)):h="internal error: could not find analysis task name";if(g){f=$(f).closest("form");try{c=f.serializeArray(),c=c.concat($("#"+f.attr("id")+" input[type=checkbox]:not(:checked)").map(function(){return{name:this.name,
value:"false"}}).get())}catch(l){c=null}g.runAnalysis(b,c,k)}else h="internal error: could not find image";h&&a.error(h);return!1});a.mkPublic("Send",function(d,c,b){a.helper.connected?a.helper.send(d,c,b):a.error("no JS9 helper available")});a.mkPublic("EventToDisplayPos",function(d){return a.eventToDisplayPos(d)});a.mkPublic("PixToWCS",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e,f,b=1,g=a.parsePublicArgs(c);if(c=a.getImage(g.display))if(f=g.argv[0],"object"===typeof f&&
a.notNull(f.x)&&a.notNull(f.y)?(e=f.x,f=f.y):(e=g.argv[0],f=g.argv[1]),a.isNumber(e)&&a.isNumber(f)||a.error("invalid input for PixToWCS"),0<c.raw.wcs)return e=a.pix2wcs(c.raw.wcs,e,f).trim(),f=e.split(/ +/),"sexagesimal"===c.params.wcsunits&&"galactic"!==c.params.wcssys&&"ecliptic"!==c.params.wcssys&&(b=15),{ra:a.saostrtod(f[0])*b,dec:a.saostrtod(f[1]),sys:f[2],str:e}});a.Pix2WCS=a.PixToWCS;a.mkPublic("WCSToPix",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e,f=a.parsePublicArgs(c);
if(b=a.getImage(f.display))if(e=f.argv[0],"object"===typeof e&&a.notNull(e.ra)&&a.notNull(e.dec)?(c=e.ra,e=e.dec):(c=f.argv[0],e=f.argv[1]),a.isNumber(c)&&a.isNumber(e)||a.error("invalid input for WCSToPix"),0<b.raw.wcs)return b=a.wcs2pix(b.raw.wcs,c,e).trim().split(/ +/),c=parseFloat(b[0]),e=parseFloat(b[1]),b=sprintf("%f %f",c,e),{x:c,y:e,str:b};return null});a.WCS2Pix=a.WCSToPix;a.mkPublic("NewShapeLayer",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e;e=a.parsePublicArgs(c);
b=a.getImage(e.display);c=e.argv[0];e=e.argv[1];return b?b.display.newShapeLayer(c,e):null});a.mkPublic("AddRegions",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e;e=a.parsePublicArgs(c);b=a.getImage(e.display);c=e.argv[0];e=e.argv[1];return b?(c||a.error("no region specified for AddRegions"),b.addShapes("regions",c,e)):null});a.mkPublic("RemoveRegions",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];b=a.parsePublicArgs(c);c=a.getImage(b.display);
b=b.argv[0];return c?(c.removeShapes("regions",b),c.display.clearMessage("regions"),a.globalOpts.quietReturn?"":"OK"):null});a.mkPublic("CopyRegions",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e=a.parsePublicArgs(c),c=a.getImage(e.display),b=e.argv[0],e=e.argv[1];return c?(c.copyRegions(b,e),a.globalOpts.quietReturn?"":"OK"):null});a.mkPublic("GetRegions",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];c=a.parsePublicArgs(c);return(b=a.getImage(c.display))?
(c.argv.unshift("regions"),b.getShapes.apply(b,[].concat($jscomp.arrayFromIterable(c.argv)))):null});a.mkPublic("ChangeRegions",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e=a.parsePublicArgs(c),c=a.getImage(e.display),b=e.argv[0],e=e.argv[1];c&&(b||a.error("no regions specified for ChangeRegions"),c.changeShapes("regions",b,e));return null});a.mkPublic("SaveRegions",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e=a.parsePublicArgs(c),
c=a.getImage(e.display),b=e.argv[0],f=e.argv[1],e=e.argv[2];return c?c.saveRegions(b,f,e):null});a.mkPublic("EditRegionTags",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e=a.parsePublicArgs(c),c=a.getImage(e.display),b=e.argv[0],f=e.argv[1],e=e.argv[2];return c?c.editRegionTags(b,f,e):null});a.mkPublic("ToggleRegionTags",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e=a.parsePublicArgs(c),c=a.getImage(e.display),b=e.argv[0],f=e.argv[1],
e=e.argv[2];return c?c.toggleRegionTags(b,f,e):null});a.mkPublic("UnremoveRegions",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];c=a.parsePublicArgs(c);return(c=a.getImage(c.display))?c.unremoveRegions():null});a.mkPublic("LoadRegions",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e,b=a.parsePublicArgs(c),f=a.getImage(b.display),g=function(b,c){c&&void 0!==c.display&&delete c.display;if(a.globalOpts.reloadRefreshReg&&c.file)try{f.removeShapes("regions",
c.file)}catch(l){}f.addShapes("regions",b,c);if(e&&e.onload)e.onload(f)},c=b.argv[0];e=b.argv[1];c||a.error("JS9.LoadRegions: no file specified for regions load");if(f){if("object"===typeof e)e=$.extend(!0,{},e);else if("string"===typeof e)try{e=JSON.parse(e)}catch(h){e={}}else e={};if("object"===typeof c){if(b=c.path||c.name)e.file=b.split("/").reverse()[0];b=new FileReader;b.onload=function(a){g(a.target.result,e)};b.readAsText(c)}else"string"===typeof c?(e.responseType="text",c=a.fixPath(c),e.file=
c.split("/").reverse()[0],a.fetchURL(null,c,e,g)):a.error("unknown file type for LoadRegions: "+typeof c)}});a.mkPublic("InstallDir",function(d){return d?a.cleanPath(a.INSTALLDIR+d):""});a.mkPublic("AddDivs",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];for(var e,f,g,h=a.parsePublicArgs(c),c=0;c<h.argv.length;c++)if(g=h.argv[c])if(0===$("#"+g).length)a.DEBUG&&a.log("warning: can't find div, skipping AddDivs(): %s",g);else{for(b=0;b<a.displays.length;b++)if(e=a.displays[b],
e.id===g){f=!0;break}f?a.DEBUG&&a.log("warning: div already added, skipping AddDivs(): %s",g):(a.checkNew(new a.Display(g)),a.helper.send("addDisplay",{display:g}))}a.instantiatePlugins()});a.mkPublic("InstantiatePlugins",function(){a.instantiatePlugins()});a.mkPublic("ResizeDisplay",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];b=a.parsePublicArgs(c);"string"!==typeof b.argv[0]||a.isNumber(b.argv[0])||"full"===b.argv[0]||"reset"===b.argv[0]||"image"===b.argv[0]?c=a.lookupDisplay(b.display):
(c=a.lookupDisplay(b.argv[0]||b.display),b.argv.splice(0,1));c||a.error("invalid display for resize");b=c.resize.apply(c,[].concat($jscomp.arrayFromIterable(b.argv)));return b===c?a.globalOpts.quietReturn?"":"OK":b});a.mkPublic("SelectDisplay",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];c=a.parsePublicArgs(c);(c=a.lookupDisplay(c.argv[0]||c.display))||a.error("invalid display for select");a.hasOwnProperty("Menubar")||a.error("Menubar is required for display selection");
a.Menubar.onclick(c)});a.mkPublic("GatherDisplay",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e,b=a.parsePublicArgs(c);switch(b.argv.length){case 0:c=b.display;e=null;break;case 1:"object"===typeof b.argv[0]||"string"===typeof b.argv[0]&&"{"===b.argv[0].charAt(0)?(c=b.display,e=b.argv[0]):c=b.argv[0]||b.display;break;default:c=b.argv[0]||b.display,e=b.argv[1]}(c=a.lookupDisplay(c))||a.error("invalid display for gather");c.gather(e)});a.mkPublic("SeparateDisplay",function(d){for(var c=
[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e,b=a.parsePublicArgs(c);switch(b.argv.length){case 0:c=b.display;e=null;break;case 1:"object"===typeof b.argv[0]||"string"===typeof b.argv[0]&&"{"===b.argv[0].charAt(0)?(c=b.display,e=b.argv[0]):c=b.argv[0]||b.display;break;default:c=b.argv[0]||b.display,e=b.argv[1]}(c=a.lookupDisplay(c))||a.error("invalid display for separate");c.separate(c,e)});a.mkPublic("CenterDisplay",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];
c=a.parsePublicArgs(c);(c=a.lookupDisplay(c.argv[0]||c.display))||a.error("invalid display for center");c.center()});a.mkPublic("SaveSession",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e,f,b={},g=a.parsePublicArgs(c),c=g.argv[0];f=g.argv[1];if("object"===typeof c)b=$.extend(!0,{},c);else if("string"===typeof c)try{b=JSON.parse(c)}catch(h){if(e=c,f)if("object"===typeof f)b=$.extend(!0,{},f);else try{b=JSON.parse(f)}catch(k){b={}}}b.mode||(b.mode="display");c=a.lookupDisplay(g.display?
g.display:b.display?b.display:0<a.displays.length?a.displays[0].id:a.DEFID);if(!c.image)return null;e||(e="display"===b.mode?"js9-"+(new Date).toISOString().slice(0,10)+".ses":c.image.id+".ses");return c.image.saveSession(e,b)});a.mkPublic("LoadSession",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e,f,g,c=a.parsePublicArgs(c);f=c.argv[0];g=c.argv[1];f||a.error("JS9.LoadSession: no file specified for load");if("object"===typeof g)g=$.extend(!0,{},g);else if("string"===
typeof g)try{g=JSON.parse(g)}catch(h){g={}}else g={};e=a.lookupDisplay(c.display?c.display:g.display?g.display:0<a.displays.length?a.displays[0].id:a.DEFID);g.display=e.id;"object"===typeof f?(c=new FileReader,c.onload=function(b){b=JSON.parse(b.target.result);g.sessionPath=a.dirname(f.path||f.name||"");e.loadSession(b,g)},c.readAsText(f)):"string"===typeof f?(g.responseType="text",g.display=e.id,f=a.fixPath(f),a.fetchURL(null,f,g,function(b,c){var d=JSON.parse(b);c.sessionPath=a.dirname(f);e.loadSession(d,
c)})):a.error("unknown file type for LoadSession: "+typeof f)});a.mkPublic("SaveCatalog",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e=a.parsePublicArgs(c),c=a.getImage(e.display),b=e.argv[0],e=e.argv[1];if(c)return c.saveCatalog(b,e)});a.mkPublic("LoadCatalog",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e,f,g,h,c=a.parsePublicArgs(c);f=c.argv[0];g=c.argv[1];h=c.argv[2];f instanceof Blob&&(h=g,g=f,f=null);g||a.error("JS9.LoadCatalog: no file specified for catalog load");
if(e=a.getImage(c.display)){if("object"===typeof h)h=$.extend(!0,{},h);else if("string"===typeof h)try{h=JSON.parse(h)}catch(k){h={}}else h={};if(g instanceof Blob)c=new FileReader,c.onload=function(a){!f&&g.name&&(f=g.name.replace(/\.[^.]*$/,""));e.loadCatalog(f,a.target.result,h);if(h&&h.onload)h.onload(e)},c.readAsText(g);else if("string"===typeof g)if(g.match(/\t/)){if(e.loadCatalog(f,g,h),h&&h.onload)h.onload(e)}else h.responseType="text",g=a.fixPath(g),a.fetchURL(null,g,h,function(a){e.loadCatalog(f,
a,h);if(h&&h.onload)h.onload(e)});else a.error("unknown file type for LoadCatalog: "+typeof g)}});a.mkPublic("CreateMosaic",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e=a.parsePublicArgs(c),c=a.lookupDisplay(e.display),b=e.argv[0],e=e.argv[1];if(c)return c.createMosaic(b,e)});a.mkPublic("DisplayPlugin",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var e,f,g,h;e=a.parsePublicArgs(c);b=a.lookupDisplay(e.display);c=e.argv[0];if(b&&e.argv[0]){h=
c.toLowerCase();for(e=0;e<a.plugins.length;e++)if(f=a.plugins[e],g=f.name,g===c||g.toLowerCase().substr(-h.length)===h){b.displayPlugin(f);return}a.error("can't find plugin: "+c)}});a.mkPublic("DisplayHelp",function(d){var c,b,e,f=a.lightOpts.dhtml.textWin;d&&(b=d.split("/").reverse()[0],c="help_"+a.uniqueID(),(e=a.helpOpts[d])?(d=a.InstallDir(e.type+"/"+e.url),a.lightWin(c,"iframe",d,e.title||b,f)):a.lightWin(c,"iframe",d,b,f))});a.mkPublic("LightWindow",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-
0]=arguments[b];var e=a.parsePublicArgs(c),c=e.argv[0]||"lightWindow"+a.uniqueID(),b=e.argv[1]||"inline",f=e.argv[2],g=e.argv[3]||"JS9 light window",e=e.argv[4]||a.lightOpts.dhtml.textWin;f||a.error("no content specified for LightWindow");return a.lightWin(c,b,f,g,e)});a.mkPublic("WindowPrint",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var c=a.parsePublicArgs(c),e={cmd:"print"};c.argv[0]&&(e.opts=c.argv[0]);window.isElectron&&window.electronIPC?window.setTimeout(function(){try{window.electronIPC.send("msg",
e)}catch(f){a.error("could not print window",f)}},a.TIMEOUT):a.error("WindowPrint is only available for the JS9 desktop app")});a.mkPublic("WindowToPDF",function(d){d=a.parsePublicArgs(d);var c={cmd:"pdf"};c.filename=d.argv[0]||"js9.pdf";d.argv[1]&&(c.opts=d.argv[1]);window.isElectron&&window.electronIPC?window.setTimeout(function(){try{window.electronIPC.send("msg",c)}catch(b){a.error("could not create window pdf",b)}},a.TIMEOUT):a.error("WindowToPDF is only available for the JS9 desktop app")});
a.mkPublic("SaveDir",function(d){for(var c=[],b=0;b<arguments.length;++b)c[b-0]=arguments[b];var c=a.parsePublicArgs(c),e={cmd:"savedir"};c.argv[0]?e.opts=c.argv[0]:a.error("SaveDir requires a directory name");window.isElectron&&window.electronIPC?window.setTimeout(function(){try{window.electronIPC.send("msg",e)}catch(f){a.error("could not set save directory",f)}},a.TIMEOUT):a.error("SaveDir is only available for the JS9 desktop app")});return a}();
$(document).ready(function(){$(document).on("JS9:ready",function(){JS9.readied||(JS9.readied=!0,JS9.Preload(!0))});$(document).on("JS9:init",function(){JS9.helper.ready&&JS9.fits.ready&&$(document).trigger("JS9:ready",{status:"OK"})});$(document).on("astroem:ready",function(){JS9.initFITS();if(window.isElectron&&JS9.hasNode)try{JS9.vmount("/",JS9.localMount)||delete JS9.localMount}catch(a){delete JS9.localMount}JS9.helper.ready&&JS9.inited&&$(document).trigger("JS9:ready",{status:"OK"})});$(document).on("JS9:helperReady",
function(){JS9.fits.ready&&JS9.inited&&!JS9.readied&&$(document).trigger("JS9:ready",{status:"OK"})});0===$('div[data-js9init="false"]').length&&JS9.init()});
