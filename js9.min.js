var JS9=function(){var a={NAME:"JS9",VERSION:"1.9",COPYRIGHT:"Copyright (c) 2012-2016 Smithsonian Institution",DEFID:"JS9",WIDTH:512,HEIGHT:512,ANON:"Anonymous",PREFSFILE:"js9Prefs.json",ZINDEX:0,SHAPEZINDEX:7,MESSZINDEX:8,BTNZINDEX:10,MENUZINDEX:1E3,COLORSIZE:1024,SCALESIZE:16384,INVSIZE:1024,HISTSIZE:16384,INSTALLDIR:"",TOROOT:"",PLUGINS:"",LIGHTWIN:"dhtml",ANTIALIAS:!1,SCALEIREG:!0,NOMOVE:3,DBLCLICK:500,TIMEOUT:250,SPINOUT:250,SUPERMENU:/^SUPERMENU_/,RESIZEDIST:20,RESIZEFUDGE:5,RAWID0:"raw0",RAWIDX:"alt",
REPROJDIM:2300,IDFMT:"  (%s)",MINZOOM:0.125,MAXZOOM:16,ADDZOOM:0.05,CHROMEFILEWARNING:!0};a.TOUCHSUPPORTED=window.hasOwnProperty("ontouchstart")||0<navigator.maxTouchPoints||0<navigator.msMaxTouchPoints;var A=navigator.platform,F=navigator.appName,D=navigator.userAgent,E,B=D.match(/(opera|chrome|safari|firefox|msie)\/?\s*(\.?\d+(\.\d+)*)/i);E=D.match(/version\/([\.\d]+)/i);B&&null!==E&&(B[2]=E[1]);B=B?[B[1],B[2],A]:[F,navigator.appVersion,"-?",A];B.push(/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(D));
a.BROWSER=B;A=document.createElement("canvas").getContext("2d");a.PIXEL_RATIO=(window.devicePixelRatio||1)/(A.webkitBackingStorePixelRatio||A.mozBackingStorePixelRatio||A.msBackingStorePixelRatio||A.oBackingStorePixelRatio||A.backingStorePixelRatio||1);a.globalOpts={helperType:"none",helperPort:2718,winType:"light",rgb:{active:!1,rim:null,gim:null,bim:null},defcolor:"#00FF00",pngisfits:!0,fits2png:!1,alerts:!0,internalValPos:!0,internalContrastBias:!0,containContrastBias:!1,htimeout:1E4,xtimeout:18E4,
extlist:"EVENTS STDEVT",dims:[1024,1024],helperProtocol:location.protocol,maxMemory:75E7,corsURL:"params/loadcors.html",proxyURL:"params/loadproxy.html",loadProxy:!1,archivesURL:"help/archives.html",imsectionURL:"params/imsection.html",postMessage:!1,waitType:"spinner",spinColor:"#FF0000",spinOpacity:0.35,resize:!0,resizeHandle:!0,resizeRedisplay:!0,mouseActions:["display value/position","change contrast/bias","pan the image"],touchActions:["display value/position","change contrast/bias","pan the image"],
keyboardActions:{b:"tag selected region as 'background'",e:"tag selected region as 'exclude'",f:"toggle full screen mode",i:"tag selected region as 'include'",l:"list regions",n:"display next image",o:"open a local FITS file",p:"copy physical coords to clipboard",s:"tag selected region as 'source'",v:"copy pixel value to clipboard",w:"copy wcs coords to clipboard","+":"zoom in","-":"zoom out",">":"zoom in","<":"zoom out","delete":"remove selected region",leftArrow:"move selected region",upArrow:"move selected region",
rightArrow:"move selected region",downArrow:"move selected region"},mousetouchZoom:!1,pinchWait:8,pinchThresh:6,extendedPlugins:!0,corsProxy:"http://js9.si.edu/cgi-bin/CORS-proxy.cgi",simbadProxy:"http://js9.si.edu/cgi-bin/simbad-proxy.cgi",debug:0};a.imageOpts={contrast:1,bias:0.5,invert:!1,exp:1E3,colormap:"grey",scale:"linear",scaleclipping:"dataminmax",zscalecontrast:0.25,zscalesamples:600,zscaleline:120,wcssys:"native",wcsunits:"sexagesimal",lcs:"physical",valpos:!0,opacity:1,sigma:"none",maskOpacity:0.4,
alpha:255,alpha1:100,zoom:1,zooms:5,nancolor:"#000000",wcsalign:!0,listonchange:!1};a.regionOpts={};a.analOpts={epattern:/^(ERROR:[^\n]*)\n/,dpathURL:"params/datapath.html",prependJS9Dir:!0,dataDir:null};a.lightOpts={nclick:0,dhtml:{top:".dhtmlwindow",drag:".drag-contentarea",dragBar:"drag-handle",format:"width=%spx,height=%spx,center=1,resize=%s,scrolling=0",textWin:"width=830px,height=400px,center=1,resize=1,scrolling=1",plotWin:"width=830px,height=420px,center=1,resize=1,scrolling=1",dpathWin:"width=830px,height=175px,center=1,resize=1,scrolling=1",
paramWin:"width=830px,height=230px,center=1,resize=1,scrolling=1",imageWin:"width=512px,height=590px,center=1,resize=1,scrolling=1",lineWin:"width=400px,height=60px,center=1,resize=1,scrolling=1"}};a.textColorOpts={regions:"#00FF00",info:"#00FF00",inimage:"#000000"};a.plotOpts={annotate:!1,annotateColor:"#FF0000",color:"blue",zoomStack:{enabled:!0},selection:{mode:"xy"},series:{clickable:!0,hoverable:!0,lines:{show:!0},points:{show:!1}},legend:{backgroundColor:null,backgroundOpacity:0},xaxis:{autorange:!0},
yaxis:{autorange:!0}};a.helpOpts={user:{heading:"JS9Help",type:"help",url:"user.html",title:"User Manual"},install:{heading:"JS9Help",type:"help",url:"install.html",title:"Installing JS9"},webpage:{heading:"JS9Help",type:"help",url:"webpage.html",title:"Adding JS9 To A Web Page"},yourdata:{heading:"JS9Help",type:"help",url:"yourdata.html",title:"Adding Data To A Web Page"},localtasks:{heading:"JS9Help",type:"help",url:"localtasks.html",title:"Adding Local Analysis Tasks and Plugins"},helper:{heading:"JS9Help",
type:"help",url:"helper.html",title:"Adding Server-side Analysis Tasks"},serverside:{heading:"JS9Help",type:"help",url:"serverside.html",title:"Server-side Analysis with JS9"},publicapi:{heading:"JS9Help",type:"help",url:"publicapi.html",title:"The JS9 Public API"},repfile:{heading:"JS9Help",type:"help",url:"repfile.html",title:"Dealing with Large Files"},regions:{heading:"JS9Help",type:"help",url:"regions.html",title:"Regions Format"},extmsg:{heading:"JS9Help",type:"help",url:"extmsg.html",title:"External Messaging"},
python:{heading:"JS9Help",type:"help",url:"python.html",title:"JS9 with Python and Jupyter"},preferences:{heading:"JS9Help",type:"help",url:"preferences.html",title:"Setting Site Preferences"},changelog:{heading:"JS9Help",type:"help",url:"changelog.html",title:"ChangeLog"},issues:{heading:"JS9Help",type:"help",url:"knownissues.html",title:"Known Issues"}};a.images=[];a.displays=[];a.colormaps=[];a.commands=[];a.plugins=[];a.preloads=[];a.auxFiles=[];a.publics={};a.helper={};a.fits={};a.userOpts={};
a.scales="linear log histeq power sqrt squared asinh sinh".split(" ");a.wcssyss="FK4 FK5 ICRS galactic ecliptic native image physical".split(" ");a.wcsunitss=["degrees","sexagesimal","pixels"];a.bugs={};a.bugs.hide_menu=!1;"Firefox"===a.BROWSER[0]&&0<=a.BROWSER[2].search(/Linux/)&&(a.bugs.firefox_linux=!0);if("Chrome"===a.BROWSER[0]||"Safari"===a.BROWSER[0])a.bugs.webkit_resize=!0;"Chrome"===a.BROWSER[0]&&(a.globalOpts.maxMemory=Math.min(a.globalOpts.maxMemory,45E7));a.Image=function(d,b,c){var e,
f,g=this,h=null,j=function(a,d){var c,b=[];d&&void 0!==d.xcen&&b.push(d.xcen);d&&void 0!==d.ycen&&b.push(d.ycen);d&&void 0!==d.zoom&&(c=a.parseZoom(d.zoom))&&b.push(c);return b},k=function(d){this.clearMessage();a.images.push(this);if(d)try{a.xeqByName(d,window,this)}catch(c){a.error("in image onload callback",c,!1)}this.xeqPlugins("image","onimageload");this.updateshapes&&this.updateShapes("regions","all","update");this.status.load="complete";a.waiting(!1)};b&&("object"===typeof b?(h=b,h.display&&
(f=h.display)):f=b);f||(f=0<a.displays.length?a.displays[0].id:a.DEFID);this.type="image";this.display=a.lookupDisplay(f);this.params={};this.tmp={};this.params.scalemin=Number.Nan;this.params.scalemax=Number.Nan;this.params.xeqonchange=!0;this.params=$.extend(!0,this.params,a.imageOpts,h);this.setColormap(this.params.colormap);this.displayMode=!0;this.clickState=0;this.queried=this.clickInRegion=!1;h&&h.proxyFile&&(this.proxyFile=h.proxyFile);h&&h.parentFile&&(this.parentFile=h.parentFile);h&&h.id&&
(this.id=h.id);this.iy=this.ix=0;this.png={};this.png.image=new Image;this.status={};this.rgb={};this.rgb.sect={zoom:1,ozoom:1};this.layers={};this.lcs={};this.aux={};this.binning={bin:1,obin:1};this.raws=[];this.blend={active:void 0,mode:"normal",opacity:1};this.updateshapes=!1;a.waiting(!0,this.display.divjq[0]);switch(typeof d){case "object":this.source="fits";this.mkRawDataFromHDU(d,$.extend({},{file:d.filename},h));"zscale"===this.params.scaleclipping&&this.zscale(!0);this.mkSection();e=j(this,
h);e.length&&this.mkSection.apply(this,e);h&&h.rgbFile?(this.rgbFile=h.rgbFile,$(this.png.image).on("load",function(){var d;if(g.png.image.width!==g.raw.width||g.png.image.height!==g.raw.height)d=sprintf("rgb dims [%s,%s] don't match image [%s,%s]",g.png.image.width,g.png.image.height,g.raw.width,g.raw.height),a.error(d);g.mkOffScreenCanvas();g.displayImage("all",h);k.call(g,c)}).on("error",function(){a.waiting(!1);g.status.load="error";a.error("could not load image: "+g.id)}),this.png.image.src=
this.rgbFile):(this.displayImage("all",h),k.call(this,c));break;case "string":this.source="fits2png";this.imtab="image";this.file=d.replace(/\/\.\//,"/");this.id0=this.file.split("/").reverse()[0];this.id=a.getImageID(this.id0,this.display.id);this.status.load="loading";$(this.png.image).on("load",function(){g.mkOffScreenCanvas();g.mkRawDataFromPNG();"zscale"===g.params.scaleclipping&&g.zscale(!0);g.mkSection();e=j(g,h);e.length&&g.mkSection.apply(g,e);g.displayImage("all",h);k.call(g,c);a.DEBUG&&
a.log("JS9 image: %s dims(%d,%d) min/max(%d,%d)",g.file,g.raw.width,g.raw.height,g.raw.dmin,g.raw.dmax)}).on("error",function(){a.waiting(!1);g.status.load="error";a.error("could not load image: "+g.id)});this.png.image.src=d;break;default:a.log("unknown specification type for Load: "+typeof d)}};a.Image.prototype.getImageData=function(a){var b=null;if(a)if("array"===a)b=Array.prototype.slice.call(this.raw.data);else if("base64"===a){var b="",c=new Uint8Array(this.raw.data.buffer),e=c.byteLength;
for(a=0;a<e;a++)b+=String.fromCharCode(c[a]);b=window.btoa(b)}else a&&"false"!==a&&(b=this.raw.data);return{id:this.id,file:this.file,fits:this.fitsFile||"",source:this.source,imtab:this.imtab,width:this.raw.width,height:this.raw.height,bitpix:this.raw.bitpix,header:this.raw.header,hdus:this.hdus,data:b}};a.Image.prototype.closeImage=function(){var d,b,c,e,f,g=!1;c=a.images.length;var h=this.display,j=function(d){d.stderr?a.error(d.stderr):d.stdout&&a.log(d.stdout)};for(d=0;d<c;d++)if(this===a.images[d]){c=
a.images[d];c===c.display.image&&(g=!0);if(g){c.clearMessage();c.display.context.clear();for(b in c.layers)c.layers.hasOwnProperty(b)&&c.layers[b].canvas.clear();c.display.image=null}c.xeqPlugins("image","onimageclose");switch(c.cmapObj.name){case "red":a.globalOpts.rgb.rim=null;break;case "green":a.globalOpts.rgb.gim=null;break;case "blue":a.globalOpts.rgb.bim=null}if(a.fits.cleanupFITSFile)for(b=0;b<c.raws.length;b++)e=c.raws[b],e.hdu&&e.hdu.fits&&(f=a.lookupVfile(e.hdu.fits.vfile),1>=f.length&&
a.fits.cleanupFITSFile(e.hdu.fits,!0));c.proxyFile&&a.Send("removeproxy",{cmd:"js9Xeq removeproxy "+c.proxyFile},j);c.rgb=null;c.offscreen=null;c.raw=null;c.colorData=null;c.colorCells=null;c.psColors=null;c=c.psInverse=null;a.images.splice(d,1);break}if(g)for(d=0;d<a.images.length;d++)if(c=a.images[d],h===c.display){c.displayImage("all");c.refreshLayers();break}};a.Image.prototype.mkOffScreenCanvas=function(){if(!this.png||!this.png.image)return this;this.offscreen={};this.offscreen.canvas=document.createElement("canvas");
this.offscreen.canvas.setAttribute("width",this.png.image.width);this.offscreen.canvas.setAttribute("height",this.png.image.height);this.offscreen.context=this.offscreen.canvas.getContext("2d");a.ANTIALIAS||(this.offscreen.context.imageSmoothingEnabled=!1,this.offscreen.context.mozImageSmoothingEnabled=!1,this.offscreen.context.webkitImageSmoothingEnabled=!1,this.offscreen.context.msImageSmoothingEnabled=!1);this.offscreen.context.drawImage(this.png.image,0,0);try{this.offscreen.img=this.offscreen.context.getImageData(0,
0,this.png.image.width,this.png.image.height)}catch(d){a.CHROMEFILEWARNING&&"Chrome"===a.BROWSER[0]&&""===document.domain?alert("When using the file:// URI, Chrome must be run with the --allow-file-access-from-files switch to permit JS9 to access data."):alert("could not read off-screen image data [same-origin policy violation?]")}return this};a.Image.prototype.initLCS=function(a){var b=[[0,0,0],[0,0,0],[0,0,0]],c=function(a){var d,c,b=0,j=0,k=[[0,0,0],[0,0,0],[0,0,0]],m=a[0][0]*a[1][1];for(d=0;3>
d;d++)for(c=0;2>c;c++)if(void 0===a[d][c]||isNaN(a[d][c]))return null;0<=m?b+=m:j+=m;m=-a[0][1]*a[1][0];0<=m?b+=m:j+=m;d=b+j;if(0===d||1E-15>Math.abs(d/(b-j)))return null;d=1/d;k[0][0]=a[1][1]*d;k[1][0]=-a[1][0]*d;k[0][1]=-a[0][1]*d;k[1][1]=a[0][0]*d;k[2][0]=-(a[2][0]*k[0][0]+a[2][1]*k[1][0]);k[2][1]=-(a[2][0]*k[0][1]+a[2][1]*k[1][1]);return k};a=a||this.raw.header;b[0][0]=a.LTM1_1||1;b[1][0]=a.LTM2_1||0;b[0][1]=a.LTM1_2||0;b[1][1]=a.LTM2_2||1;b[2][0]=a.LTV1||0;b[2][1]=a.LTV2||0;this.lcs.physical=
{forward:$.extend(!0,[],b),reverse:c(b)};this.lcs.physical.reverse||delete this.lcs.physical;b[0][0]=a.DTM1_1||1;b[1][0]=a.DTM2_1||0;b[0][1]=a.DTM1_2||0;b[1][1]=a.DTM2_2||1;b[2][0]=a.DTV1||0;b[2][1]=a.DTV2||0;this.lcs.detector={forward:$.extend(!0,[],b),reverse:c(b)};this.lcs.detector.reverse||delete this.lcs.detector;b[0][0]=a.ATM1_1||1;b[1][0]=a.ATM2_1||0;b[0][1]=a.ATM1_2||0;b[1][1]=a.ATM2_2||1;b[2][0]=a.ATV1||0;b[2][1]=a.ATV2||0;this.lcs.amplifier={forward:$.extend(!0,[],b),reverse:c(b)};this.lcs.amplifier.reverse||
delete this.lcs.amplifier;this.lcs[this.params.lcs]||(this.params.lcs="image");this.params.wcssys0||(this.setWCSSys("physical"),this.params.wcssys0=this.params.lcs);return this};a.Image.prototype.mkRawDataFromIMG=function(d){var b,c,e,f,g,h;if(d){b=d.height;c=d.width;e=d.data;this.raws.push({from:"img"});this.raw=this.raws[this.raws.length-1];this.raw.id=a.RAWID0;this.raw.data=new Float32Array(b*c);for(g=d=0;g<b;g++)for(f=0;f<c;f++)h=0.299*e[d]+0.587*e[d+1]+0.114*e[d+2],this.raw.data[(b-g)*c+f]=h,
d+=4;this.raw.width=c;this.raw.height=b;this.raw.bitpix=-32;this.dataminmax();this.source="png";this.raw.header={SIMPLE:!0,NAXIS:2,NAXIS1:this.raw.width,NAXIS2:this.raw.height,BITPIX:this.raw.bitpix};return this}};a.Image.prototype.mkRawDataFromPNG=function(){var d,b,c,e,f,g,h,j;h=[];c=new ArrayBuffer(8);var k=new Uint8Array(c),m=new DataView(c);if(!this.offscreen.img)return this;this.raws.push({from:"png"});this.raw=this.raws[this.raws.length-1];this.raw.id=a.RAWID0;e=this.offscreen.img.data;for(d=
c=0;c<e.length&&0!==e[c];c++)if(255!==e[c]&&(h[d]=String.fromCharCode(e[c]),d++),15===d&&'{"js9Protocol":'!==h.join("")){f=!0;break}if(15>d||f)this.mkRawDataFromIMG(this.offscreen.img);else{d=h.join("");2<a.DEBUG&&a.log("jsonHeader: %s",d);try{b=JSON.parse(d)}catch(n){a.error("can't read FITS header from PNG file: "+d,n)}if(1===b.js9Protocol)this.raw.header=b,this.raw.endian=this.raw.header.js9Endian,this.raw.protocol=this.raw.header.js9Protocol;else{this.raw.endian=b.js9Endian;this.raw.protocol=
b.js9Protocol;this.raw.cardstr=b.cardstr;this.raw.ncard=b.ncard;this.raw.header={};b=this.raw.ncard;for(d=0;d<b;d++)f=this.raw.cardstr.slice(80*d,80*(d+1)),f=a.cardpars(f),void 0!==f&&(this.raw.header[f[0]]=f[1])}c+=1;this.raw.header.NAXIS1?this.raw.width=this.raw.header.NAXIS1:a.error("NAXIS1 missing from PNG-based FITS header");this.raw.header.NAXIS2?this.raw.height=this.raw.header.NAXIS2:a.error("NAXIS2 missing from PNG-based FITS header");this.raw.header.BITPIX?this.raw.bitpix=this.raw.header.BITPIX:
a.error("BITPIX missing from PNG-based FITS header");"little"===this.raw.endian?j=!0:"big"===this.raw.endian?j=!1:a.error("js9Endian missing from PNG-based FITS header");this.object=this.raw.header.OBJECT;b=this.raw.width*this.raw.height;f=c%4;switch(this.raw.bitpix){case 8:this.raw.data=new Uint8Array(b);for(d=0;d<b;d++){switch(f){case 0:g=e[c];c+=1;f=1;break;case 1:g=e[c];c+=1;f=2;break;case 2:g=e[c];c+=2;f=0;break;case 3:g=e[c+1],c+=2,f=1}this.raw.data[d]=g}break;case 16:case -16:16===this.raw.bitpix?
(this.raw.data=new Int16Array(b),h=DataView.prototype.getInt16):(this.raw.data=new Uint16Array(b),h=DataView.prototype.getUint16);for(d=0;d<b;d++){switch(f){case 0:k[0]=e[c];k[1]=e[c+1];g=h.call(m,0,j);c+=2;f=2;break;case 1:k[0]=e[c];k[1]=e[c+1];g=h.call(m,0,j);c+=3;f=0;break;case 2:k[0]=e[c];k[1]=e[c+2];g=h.call(m,0,j);c+=3;f=1;break;case 3:k[0]=e[c+1],k[1]=e[c+2],g=h.call(m,0,j),c+=3,f=2}this.raw.data[d]=g}break;case 32:case -32:32===this.raw.bitpix?(this.raw.data=new Int32Array(b),h=DataView.prototype.getInt32):
(this.raw.data=new Float32Array(b),h=DataView.prototype.getFloat32);for(d=0;d<b;d++){switch(f){case 0:k[0]=e[c];k[1]=e[c+1];k[2]=e[c+2];k[3]=e[c+4];g=h.call(m,0,j);c+=5;f=1;break;case 1:k[0]=e[c];k[1]=e[c+1];k[2]=e[c+3];k[3]=e[c+4];g=h.call(m,0,j);c+=5;f=2;break;case 2:k[0]=e[c];k[1]=e[c+2];k[2]=e[c+3];k[3]=e[c+4];g=h.call(m,0,j);c+=6;f=0;break;case 3:k[0]=e[c+1],k[1]=e[c+2],k[2]=e[c+3],k[3]=e[c+5],g=h.call(m,0,j),c+=6,f=1}this.raw.data[d]=g}break;case -64:this.raw.data=new Float64Array(b);for(d=
0;d<b;d++){switch(f){case 0:case 4:k[0]=e[c];k[1]=e[c+1];k[2]=e[c+2];k[3]=e[c+4];k[4]=e[c+5];k[5]=e[c+6];k[6]=e[c+8];k[7]=e[c+9];g=m.getFloat64(0,j);c+=10;f=2;break;case 1:case 5:k[0]=e[c];k[1]=e[c+1];k[2]=e[c+3];k[3]=e[c+4];k[4]=e[c+5];k[5]=e[c+7];k[6]=e[c+8];k[7]=e[c+9];g=m.getFloat64(0,j);c+=11;f=0;break;case 2:case 6:k[0]=e[c];k[1]=e[c+2];k[2]=e[c+3];k[3]=e[c+4];k[4]=e[c+6];k[5]=e[c+7];k[6]=e[c+8];k[7]=e[c+10];g=m.getFloat64(0,j);c+=11;f=1;break;case 3:case 7:k[0]=e[c+1],k[1]=e[c+2],k[2]=e[c+
3],k[3]=e[c+5],k[4]=e[c+6],k[5]=e[c+7],k[6]=e[c+9],k[7]=e[c+10],g=m.getFloat64(0,j),c+=11,f=2}this.raw.data[d]=g}break;default:a.error("unsupported bitpix in PNG file: "+this.raw.bitpix)}this.dataminmax();this.offscreen.img=null;this.initWCS();this.initLCS();return this}};a.Image.prototype.mkRawDataFromHDU=function(d,b){var c,e,f,g,h,j,k,m;b=b||{};$.isArray(d)||a.isTypedArray(d)||d instanceof ArrayBuffer?($.isArray(d[0])&&(d=d.reduce(function(a,d){return a.concat(d)})),g={image:d}):"object"===typeof d?
g=d:a.error("unknown or missing input for HDU creation");g.data&&!g.image&&(g.image=g.data);g.image||a.error("data missing from JS9 FITS object"+JSON.stringify(g));2>g.naxis&&a.error("can't image a FITS file with less than 2 dimensions");this.raw&&(j=this.raw.width,k=this.raw.height,m=this.raw.bitpix);if(h=this.raws.length){b.rawid=b.rawid||a.RAWIDX;for(c=f=0;c<h;c++)if(b.rawid===this.raws[c].id){e=this.raws[c].from;this.raws[c]={from:e,id:b.rawid};this.raw=this.raws[c];f++;break}f||(this.raws.push({from:"hdu",
id:b.rawid}),this.raw=this.raws[h])}else this.raws.push({from:"hdu"}),this.raw=this.raws[h],this.raw.id=a.RAWID0;this.raw.hdu=g;g.axis?(this.raw.width=g.axis[1],this.raw.height=g.axis[2]):g.naxis1&&g.naxis2?(this.raw.width=g.naxis1,this.raw.height=g.naxis2):j&&k&&(this.raw.width=j,this.raw.height=k);g.bitpix?this.raw.bitpix=g.bitpix:m&&(this.raw.bitpix=m);if("base64"===g.encoding){e=window.atob(g.image);g.image=new ArrayBuffer(e.length);f=new Uint8Array(g.image);for(c=0;c<e.length;c++)f[c]=e.charCodeAt(c)}$.isArray(g.image[0])&&
(g.image=g.image.reduce(function(a,d){return a.concat(d)}));switch(this.raw.bitpix){case 8:this.raw.data=new Uint8Array(g.image);break;case 16:this.raw.data=new Int16Array(g.image);break;case -16:this.raw.data=new Uint16Array(g.image);break;case 32:this.raw.data=new Int32Array(g.image);break;case -32:this.raw.data=new Float32Array(g.image);break;case -64:this.raw.data=new Float64Array(g.image)}this.raw.card=g.card;this.raw.cardstr=g.cardstr;this.raw.ncard=g.ncard;if(g.head)this.raw.header=g.head;
else if(this.raw.card){this.raw.header={};f=this.raw.card.length;for(c=0;c<f;c++)h=a.cardpars(this.raw.card[c]),void 0!==h&&(this.raw.header[h[0]]=h[1])}else if(this.raw.cardstr){this.raw.header={};f=this.raw.ncard;for(c=0;c<f;c++)h=this.raw.cardstr.slice(80*c,80*(c+1)),h=a.cardpars(h),void 0!==h&&(this.raw.header[h[0]]=h[1])}else this.raw.header={},this.raw.header.SIMPLE=!0,this.raw.header.NAXIS=2,this.raw.header.NAXIS1=this.raw.width,this.raw.header.NAXIS2=this.raw.height,this.raw.header.BITPIX=
this.raw.bitpix;b.file?this.file=b.file:g.filename&&(this.file=g.filename);this.file0=this.file=this.file||a.ANON+a.uniqueID();b.id&&(this.id0=b.id,this.id=a.getImageID(b.id,this.display.id,this));!this.id&&(this.file&&!this.file.match(/\[.*[^a-zA-Z0-9_].*\]/))&&(this.raw.hdu.fits?this.raw.hdu.fits.extname?(this.file=this.file.replace(/\[.*\]/,""),this.file+=sprintf("[%s]",this.raw.hdu.fits.extname)):this.raw.hdu.fits.extnum&&0<this.raw.hdu.fits.extnum&&(this.file=this.file.replace(/\[.*\]/,""),this.file+=
sprintf("[%s]",this.raw.hdu.fits.extnum)):this.raw.header&&this.raw.header.EXTNAME&&(this.file=this.file.replace(/\[.*\]/,""),this.file+=sprintf("[%s]",this.raw.header.EXTNAME)));this.id||(this.id0=this.file.split("/").reverse()[0],this.id=a.getImageID(this.id0,this.display.id));g.dmin&&g.dmax?(this.raw.dmin=g.dmin,this.raw.dmax=g.dmax):this.dataminmax();this.imtab=g.imtab?g.imtab:g.table?"table":"image";this.object=this.raw.header.OBJECT;this.binning.bin="table"===this.imtab&&g.table?Number(g.table.bin)||
1:1;this.initWCS();this.initLCS();try{e=a.listhdu(this.raw.hdu.fits.vfile),this.hdus=JSON.parse(e)}catch(n){}return this};a.Image.prototype.mkSection=function(a,b,c){var e=this.rgb.sect;e.ozoom=e.zoom;switch(arguments.length){case 0:e.xcen=Math.floor(this.raw.width/2);e.ycen=Math.floor(this.raw.height/2);e.width=Math.min(this.raw.width,this.display.canvas.width);e.height=Math.min(this.raw.height,this.display.canvas.height);break;case 1:e.zoom=a;e.width=Math.min(this.raw.width*e.zoom,this.display.canvas.width);
e.height=Math.min(this.raw.height*e.zoom,this.display.canvas.height);break;case 2:e.xcen=parseInt(a,10);e.ycen=parseInt(b,10);break;case 3:e.xcen=parseInt(a,10),e.ycen=parseInt(b,10),e.zoom=c,e.width=Math.min(this.raw.width*e.zoom,this.display.canvas.width),e.height=Math.min(this.raw.height*e.zoom,this.display.canvas.height)}e.width=Math.floor(e.width);e.height=Math.floor(e.height);e.x0=Math.floor(e.xcen-(e.width+1)/(2*e.zoom)+1);e.y0=Math.floor(e.ycen-(e.height+1)/(2*e.zoom)+1);e.x1=Math.floor(e.xcen+
e.width/(2*e.zoom));e.y1=Math.floor(e.ycen+e.height/(2*e.zoom));0>e.x0&&(e.x1-=e.x0,e.x0=0);0>e.y0&&(e.y1-=e.y0,e.y0=0);e.x1>this.raw.width&&(e.x0-=e.x1-this.raw.width,e.x1=this.raw.width);e.y1>this.raw.height&&(e.y0-=e.y1-this.raw.height,e.y1=this.raw.height);e.x0=Math.max(0,e.x0);e.y0=Math.max(0,e.y0);this.offscreenRGB=null;return this};a.Image.prototype.mkColorData=function(){var d,b,c=a.SCALESIZE,e=this.params.scalemin,f=this.params.scalemax,g=this.raw.width*this.raw.height,h=(c-1)/(f-e);this.colorData||
(this.colorData=[]);for(d=0;d<g;d++)b=this.raw.data[d],this.colorData[d]=b<=e?0:b>=f?c-1:Math.floor((b-e)*h+0.5);return this};a.Image.prototype.calcContrastBias=function(d){var b=a.COLORSIZE,c=this.params.bias,e=this.params.contrast;if(1E-4>c-0.5&&1E-4>e-1)return d;this.params.invert&&(c=1-c);d=Math.floor(((d/b-c)*e+0.5)*b);return 0>d?0:d>=b?b-1:d};a.Image.prototype.mkColorCells=function(){var d,b,c=a.COLORSIZE;this.colorCells||(this.colorCells=[]);for(d=0;d<c;d++)b=this.params.invert?c-d-1:d,b=this.calcContrastBias(b),
this.colorCells[d]=this.cmapObj.mkColorCell(b);return this};a.Image.prototype.mkScaledCells=function(){var d,b,c,e,f,g,h,j,k,m,n,q;h=a.COLORSIZE;var l=a.SCALESIZE,p=a.INVSIZE;f=a.HISTSIZE;if(!this.colorCells)return this;if(!this.psColors){c=this.psColors=[];b=this.params.nancolor;j=[];"#"===b.charAt(0)&&(b=b.slice(1));b=b.toUpperCase();for(d=g=0;6>g;g+=2,d++)q="0123456789ABCDEF".indexOf(b.charAt(g)),e="0123456789ABCDEF".indexOf(b.charAt(g+1)),j[d]=16*q+e;c[NaN]=j}this.psInverse||(this.psInverse=[],
this.psInverse[NaN]=0);b=this.params.scalemax-this.params.scalemin;g=this.params.scalemin;switch(this.params.scale){case "linear":for(c=0;c<l;c++)d=c/l,d=Math.floor(d*h),this.psColors[c]=this.colorCells[d];for(c=0;c<p;c++)d=c/p,this.psInverse[c]=d*b+g;break;case "log":f=this.params.exp;for(c=0;c<l;c++)d=Math.log(f*c/l+1)/Math.log(f),d=Math.floor(d*h),d>=h&&(d=h-1),this.psColors[c]=this.colorCells[d];for(c=0;c<p;c++)d=(Math.pow(f,c/p)-1)/f,this.psInverse[c]=d*b+g;break;case "power":f=this.params.exp;
for(c=0;c<l;c++)d=(Math.pow(f,c/l)-1)/f,d=Math.floor(d*h),d>=h&&(d=h-1),this.psColors[c]=this.colorCells[d];for(c=0;c<p;c++)d=Math.log(f*c/p+1)/Math.log(f),this.psInverse[c]=d*b+g;break;case "sqrt":for(c=0;c<l;c++)d=c/l,d=Math.floor(Math.sqrt(d)*h),d>=h&&(d=h-1),this.psColors[c]=this.colorCells[d];for(c=0;c<p;c++)d=c/p,this.psInverse[c]=d*d*b+g;break;case "squared":for(c=0;c<l;c++)d=c/l,d=Math.floor(d*d*h),d>=h&&(d=h-1),this.psColors[c]=this.colorCells[d];for(c=0;c<p;c++)d=Math.sqrt(c/p),this.psInverse[c]=
d*b+g;break;case "asinh":for(c=0;c<l;c++)d=c/l,d=Math.floor(Math.asinh(10*d)/3*h),d>=h&&(d=h-1),this.psColors[c]=this.colorCells[d];for(c=0;c<p;c++)d=c/p,d=Math.sinh(3*d)/10,this.psInverse[c]=d*b+g;break;case "sinh":for(c=0;c<l;c++)d=c/l,d=Math.floor(Math.sinh(3*d)/10*h),d>=h&&(d=h-1),this.psColors[c]=this.colorCells[d];for(c=0;c<p;c++)d=c/p,d=Math.asinh(10*d)/3,this.psInverse[c]=d*b+g;break;case "histeq":j=this.raw.data;k=this.raw.width*this.raw.height;b=this.raw.dmax-this.raw.dmin;n=this.raw.dmax;
g=this.raw.dmin;m=d=0;q=[];if(!this.hist||!this.hist.length){this.hist=[];for(c=0;c<f;c++)q[c]=0;for(c=0;c<k;c++)j[c]>=g&&j[c]<=n&&(e=Math.floor((j[c]-g)/b*f+0.5),e<f&&(q[e]+=1));for(c=0;c<f;c++)m+=q[c];e=m/f;for(c=j=0;c<f&&j<f;c++){this.hist[c]=j/f;for(d+=q[c];d>=e&&j<f;)d-=e,j++}for(d=(f-1)/f;c<f;)this.hist[c++]=d}for(c=0;c<l;c++)d=this.hist[c*f/l],d=Math.floor(d*h),this.psColors[c]=this.colorCells[d];for(c=0;c<p;c++){h=c/p;for(e=0;e<f-1&&!(this.hist[e]>h);e++);d=e/f;this.psInverse[c]=d*b+g}break;
default:a.log("unknown scale '"+this.params.scale+"'")}return this};a.Image.prototype.mkRGBImage=function(){var d,b,c,e,f,g,h,j,k,m,n,q,l,p,r,s,t,w,u,y,v=null,x=null,z=null,C=!1;if(!this.rgb)return this;if(a.globalOpts.rgb.active&&(this===a.globalOpts.rgb.rim||this===a.globalOpts.rgb.gim||this===a.globalOpts.rgb.bim))C=!0,a.globalOpts.rgb.rim&&(v=a.globalOpts.rgb.rim),a.globalOpts.rgb.gim&&(x=a.globalOpts.rgb.gim),a.globalOpts.rgb.bim&&(z=a.globalOpts.rgb.bim);h=this.display.context;d=this.rgb;b=
d.sect;if(this.MakeRGBImage&&"function"===typeof this.MakeRGBImage&&this.MakeRGBImage()||this.MakePrimaryImage&&"function"===typeof this.MakePrimaryImage&&this.MakePrimaryImage())return this;if(this.rgbFile){f=b.width/b.zoom;g=b.height/b.zoom;c=b.x0;e=this.offscreen.canvas.height-1-(b.y0+g);e=this.offscreen.context.getImageData(c,e,f,g);if(1===b.zoom)d.img=e;else{d.img=h.createImageData(b.width,b.height);d=d.img;for(m=j=0;j<e.height;j++,m++){s=j*e.width;q=m*b.zoom;for(k=h=0;h<e.width;h++,k++){c=4*
(s+h);n=k*b.zoom;for(l=0;l<b.zoom;l++){p=Math.floor(q+l);t=p*b.width;for(p=0;p<b.zoom;p++)r=Math.floor(n+p),r=4*(t+r),d.data[r]=e.data[c],d.data[r+1]=e.data[c+1],d.data[r+2]=e.data[c+2],d.data[r+3]=e.data[c+3]}}}}return this}if(!d.img||d.img.width!==b.width||d.img.height!==b.height)d.img=h.createImageData(b.width,b.height);d=d.img;if(!this.psColors)return this;w=void 0!==this.params.opacity?255*this.params.opacity:void 0!==this.params.alpha?this.params.alpha:255;this.maskData&&(this.params.maskInvert?
void 0!==this.params.opacity&&void 0!==this.params.maskOpacity?(e=255*this.params.opacity,f=255*this.params.maskOpacity):void 0!==this.params.alpha1&&void 0!==this.params.alpha2?(e=this.params.alpha2,f=this.params.alpha1):(e=0,f=255):void 0!==this.params.opacity&&void 0!==this.params.maskOpacity?(e=255*this.params.maskOpacity,f=255*this.params.opacity):void 0!==this.params.alpha1&&void 0!==this.params.alpha2?(e=this.params.alpha1,f=this.params.alpha2):(e=255,f=0));j=b.y1-1;for(m=0;j>=b.y0;j--,m++){s=
j*this.raw.width;q=m*b.zoom;h=b.x0;for(k=0;h<b.x1;h++,k++){if(C){if(g=v?v.colorData[s+h]:0,u=x?x.colorData[s+h]:0,y=z?z.colorData[s+h]:0,void 0===g||void 0===u||void 0===y)return a.globalOpts.rgb.active=!1,a.error("RGB images are incompatible. Turning off RGB mode.","",!1),a.Image.prototype.mkRGBImage.call(this),this}else c=this.colorData[s+h];this.maskData&&(w=0<this.maskData[s+h]?e:f);n=k*b.zoom;for(l=0;l<b.zoom;l++){p=Math.floor(q+l);t=p*b.width;for(p=0;p<b.zoom;p++)r=Math.floor(n+p),r=4*(t+r),
C?(d.data[r]=v?v.psColors[g][0]:0,d.data[r+1]=x?x.psColors[u][1]:0,d.data[r+2]=z?z.psColors[y][2]:0):(d.data[r]=this.psColors[c][0],d.data[r+1]=this.psColors[c][1],d.data[r+2]=this.psColors[c][2]),d.data[r+3]=w}}}return this};a.Image.prototype.blendImage=function(d,b,c){var e=/normal|multiply|screen|overlay|darken|lighten|color-dodge|color-burn|hard-light|soft-light|difference|exclusion|hue|saturation|color|luminosity|clear|copy|source-over|destination-over|source-in|destination-in|source-out|destination-out|source-atop|destination-atop|xor|lighter/i;
if(0===arguments.length)return this.blend;if(!0===d||!1===d)return this.blend.active=d,this.display.blendMode&&this.displayImage(),this;if(a.notNull(d)||a.notNull(b))a.notNull(d)&&(e.test(d)||a.error("invalid composite/blend operation: "+d),this.blend.mode=d),a.notNull(b)&&(this.blend.opacity=b),a.notNull(c)&&(this.blend.active=c),this.display.blendMode&&this.blend.active&&this.displayImage();return this};a.Image.prototype.putImage=function(d){var b=this.rgb,c=this.display,e=c.context,f=function(d,
c){var b,e;d.offscreenRGB||(e=document.createElement("canvas"),b=e.getContext("2d"),e.width=c.width,e.height=c.height,a.ANTIALIAS||(b.imageSmoothingEnabled=!1,b.mozImageSmoothingEnabled=!1,b.webkitImageSmoothingEnabled=!1,b.msImageSmoothingEnabled=!1),b.putImageData(c,0,0),d.offscreenRGB={canvas:e,context:b});return d.offscreenRGB.canvas};d=d||{};this.ix=Math.floor((c.canvas.width-b.img.width)/2);this.iy=Math.floor((c.canvas.height-b.img.height)/2);"reproject"===this.rawDataLayer()&&d.wcsim&&(this.wcsix=
d.wcsim.ix+d.wcsim.raw.wcsinfo.crpix1-this.raw.wcsinfo.crpix1,this.wcsiy=d.wcsim.iy+d.wcsim.raw.wcsinfo.crpix2-this.raw.wcsinfo.crpix2);this.params.wcsalign&&(void 0!==this.wcsix&&void 0!==this.wcsiy)&&(this.ix=this.wcsix,this.iy=this.wcsiy);a.notNull(d.opacity)||a.notNull(d.blend)?(e.save(),void 0!==d.opacity&&(e.globalAlpha=d.opacity),void 0!==d.blend&&(e.globalCompositeOperation=d.blend),e.drawImage(f(this,b.img),this.ix,this.iy),e.restore()):e.putImageData(b.img,this.ix,this.iy);return this};
a.Image.prototype.displayImage=function(d,b){var c,e,f;f=0;var g=[],h={};if(!1===d)return this.displayMode=!1,this;!0===d&&(this.displayMode=!0,d="all");if(!this.displayMode)return this;"object"===typeof d&&(b=d,d=null);d?"all"===d?(d="colors,scaled,rgb,display,plugins",h.notify=!0):"rgbonly"===d?(d="rgb,nodisplay",h.notify=!0):"display"===d&&(h.notify=!0):d="rgb";d.split(",").forEach(function(a){a=a.trim();h[a]=!0;switch(a){case "colors":h.scaled=!0;h.rgb=!0;break;case "scaled":h.rgb=!0}});h.display=
!0;h.plugins=!0;this.rgbFile&&(d.colors=!1,d.scaled=!1);b=b||{};if(this.display.blendMode&&!1!==b.blendMode)for(c=0;c<a.images.length;c++)e=a.images[c],e.display===this.display&&e.blend.active&&(g.push(e),f++);h.colors&&(this.mkColorData(),this.offscreenRGB=null);h.scaled&&(this.mkColorCells(),this.mkScaledCells(),this.offscreenRGB=null);if(h.rgb&&(this.mkRGBImage(),this.offscreenRGB=null,f))for(c=g.length-1;0<=c;c--)e=g[c],e.mkRGBImage(),e.offscreenRGB=null;if(h.nodisplay)return this;if(h.display){this.display.context.clear();
if(f)for(c=g.length-1;0<=c;c--)e=g[c],f={blend:e.blend.mode,opacity:e.blend.opacity},e.putImage(f),e===this&&(e.displayShapeLayers(),h.notify&&e.notifyHelper());else this.putImage(b),this.displayShapeLayers(),h.notify&&this.notifyHelper();this.display.image=this;if(this.delayedShapes&&this.delayedShapes.length){for(;this.delayedShapes.length;)c=this.delayedShapes.shift(),this.addShapes(c.layer,c.shape,c.opts);delete this.delayedShapes}}this.xeqPlugins("image","onimagedisplay");return this};a.Image.prototype.refreshImage=
function(d,b){var c,e,f,g,h,j;b=b||{};b.rawid=b.rawid||a.RAWID0;"function"===typeof b&&(b={onrefresh:b});!b.onrefresh&&a.imageOpts.onrefresh&&(b.onrefresh=a.imageOpts.onrefresh);c=this.rgb.sect.xcen;e=this.rgb.sect.ycen;h=this.rgb.sect.zoom;f=this.raw.width;g=this.raw.height;this.binning.obin=this.binning.bin;this.mkRawDataFromHDU(d,b);j=this.binning.obin!==this.binning.bin;this.raw.width===f&&this.raw.height===g?this.mkSection(c,e,h):(this.mkSection(),this.mkSection(h),j=!0);this.displayImage("colors",
b);j&&(this.refreshLayers(),this.updateShapes("regions","all","binning"));if(b.onrefresh)try{a.xeqByName(b.onrefresh,window,this)}catch(k){a.error("in image refresh callback",k)}this.xeqPlugins("image","onimagerefresh");return this};a.Image.prototype.displayExtension=function(d,b){var c,e,f,g,h,j=this,k=function(d){var c;c="";var e={};d.fits.extname?c=sprintf("[%s]",d.fits.extname):d.fits.extnum&&(c=0<d.fits.extnum?sprintf("[%s]",d.fits.extnum):"");c=j.id.replace(/\[.*\]/,"")+c;b.separate?(e.id=c,
e.display=j.display,a.checkNew(new a.Image(d,e))):(e.file=c,e.id=c,j.refreshImage(d,e))};void 0===d&&a.error("missing extname/extnum for displayExtension()");b=b||{};this.hdus||a.error("no FITS HDUs found for displayExtension()");if(this.raw.hdu&&this.raw.hdu.fits&&this.raw.hdu.fits.fptr){f={fptr:this.raw.hdu.fits.fptr,vfile:this.raw.hdu.vfile};if("string"===typeof d){f.extname=d;g=d.toLowerCase();for(e=c=0;c<this.hdus.length;c++)if(this.hdus[c].name&&this.hdus[c].name.toLowerCase()===g){e++;break}e||
a.error(sprintf("no FITS HDU %s for displayExtension()",d))}else"number"===typeof d&&(f.extnum=d,this.hdus[d]?g=this.hdus[d].name||d.toString():a.error(sprintf("no FITS HDU %s for displayExtension()",d)));if(b.separate){c=sprintf("[%s]",g);g=this.id.replace(/\[.*\]/,"")+c;for(e=c=0;c<a.images.length;c++)if(h=a.images[c],g===h.id&&0<$("#"+h.display.id).length&&this.display.id===h.display.id){e++;break}if(e){h.displayImage("display",b);h.clearMessage();return}}a.fits.handleFITSFile("",f,k)}else a.error("virtual FITS file is missing for displayExtension()");
return this};a.Image.prototype.displaySlice=function(d,b){var c,e=this,f=function(d){var f;b.separate?(f=sprintf("[%s]",c.slice),f=f.replace(/([0-9][0-9]*)/,"$1:$1"),b.id=e.id.replace(/\[.*\]/,"")+f,d.filename=e.file.replace(/\[.*\]/,"")+f,(f=a.lookupImage(b.id,e.display.id))?(f.slice=c.slice,f.displayImage("display",b),f.clearMessage()):a.Load(d,b,{display:b.display||e.display})):(e.slice=c.slice,e.refreshImage(d,a.fits.options))};void 0===d&&a.error("missing slice for displaySlice()");b=b||{};this.raw.hdu&&
this.raw.hdu.fits&&this.raw.hdu.fits.fptr?(c={fptr:this.raw.hdu.fits.fptr,vfile:this.raw.hdu.vfile},c.slice=a.isNumber(d)?sprintf("*,*,%s",d):d,a.fits.handleFITSFile("",c,f)):a.error("virtual FITS file is missing for displaySlice()");return this};a.Image.prototype.toArray=function(){var d,b,c,e,f,g,h,j,k,m;k=this.raw.data.buffer;g=a.raw2FITS(this.raw);h=2880-g.length%2880;2880===h&&(h=0);for(d=0;d<h;d++)g+=" ";h=2880-k.byteLength%2880;2880===h&&(h=0);d=new ArrayBuffer(g.length+k.byteLength+h);j=new Uint8Array(d);
for(d=0;d<g.length;d++)j[d]=g.charCodeAt(d);if(0<(new Int8Array((new Int16Array([1])).buffer))[0]){f=g.length;e=Math.abs(this.raw.bitpix)/8;m=new Uint8Array(k);for(d=0;d<m.byteLength;d+=e){b=d+e-1;for(c=0;c<e;b--,c++)j[f++]=m[b]}}else j.set(new Uint8Array(k),g.length);f=g.length+k.byteLength;for(d=0;d<h;d++)j[f++]=0;return j};a.Image.prototype.getPan=function(){return{x:(this.rgb.sect.x0+this.rgb.sect.x1)/2+1,y:(this.rgb.sect.y0+this.rgb.sect.y1)/2+1}};a.Image.prototype.setPan=function(d,b){var c,
e,f,g,h,j=this.raw.width/2,k=this.raw.height/2;0===arguments.length&&(d=j,b=k);this.mkSection(d,b);if(this.display.blendMode)for(c=0;c<a.images.length;c++)h=a.images[c],h!==this&&(h.display===this.display&&h.blend.active)&&(f=h.raw.width/2,g=h.raw.height/2,0!==arguments.length&&(f-=j-d,g-=k-b),a.Image.prototype.mkSection.call(h,f,g));this.displayImage("rgb");for(e in this.layers)this.layers.hasOwnProperty(e)&&this.layers[e].show&&this.layers[e].opts.panzoom&&this.refreshShapes(e);a.globalOpts.extendedPlugins&&
this.xeqPlugins("image","onsetpan");return this};a.Image.prototype.getZoom=function(){return this.rgb.sect.zoom};a.Image.prototype.parseZoom=function(a){var b;b=this.rgb.sect.zoom;switch(typeof a){case "string":switch(a.charAt(0)){case "*":case "x":case "X":a=b*parseFloat(a.slice(1));break;case "/":a=b/parseFloat(a.slice(1));break;case "I":case "i":a=2*b;break;case "O":case "o":a=b/2;break;case "T":case "t":a=Math.min(this.display.width,this.display.height)/Math.max(this.raw.width,this.raw.height);
a=Math.round(100*(a+1E-5))/100;break;default:a=parseFloat(a)}break;case "number":break;default:return}return a};a.Image.prototype.setZoom=function(d){var b,c,e;if(b=this.parseZoom(d)){this.mkSection(b);if(this.display.blendMode)for(d=0;d<a.images.length;d++)e=a.images[d],e!==this&&(e.display===this.display&&e.blend.active)&&a.Image.prototype.mkSection.call(e,b);this.displayImage("rgb");for(c in this.layers)this.layers.hasOwnProperty(c)&&this.layers[c].show&&this.layers[c].opts.panzoom&&this.refreshShapes(c);
a.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetzoom");return this}};a.Image.prototype.refreshLayers=function(){this.setZoom(this.getZoom())};a.Image.prototype.imageToLogicalPos=function(a,b){var c,e=a.x,f=a.y,g="image";b=b||this.params.lcs||"image";switch(b){case "physical":this.lcs.physical&&(g=b,c=this.lcs.physical.reverse);break;case "detector":this.lcs.detector&&(g=b,c=this.lcs.detector.reverse);break;case "amplifier":this.lcs.amplifier&&(g=b,c=this.lcs.amplifier.reverse)}c&&(e=a.x*
c[0][0]+a.y*c[1][0]+c[2][0],f=a.x*c[0][1]+a.y*c[1][1]+c[2][1]);return{x:e,y:f,sys:g}};a.Image.prototype.logicalToImagePos=function(a,b){var c,e={x:a.x,y:a.y};b=b||this.params.lcs||"image";switch(b){case "physical":this.lcs.physical&&(c=this.lcs.physical.forward);break;case "detector":this.lcs.detector&&(c=this.lcs.detector.forward);break;case "amplifier":this.lcs.amplifier&&(c=this.lcs.amplifier.forward)}c&&(e.x=a.x*c[0][0]+a.y*c[1][0]+c[2][0],e.y=a.x*c[0][1]+a.y*c[1][1]+c[2][1]);return e};a.Image.prototype.displayToImagePos=
function(a){var b=this.rgb,c=this.rgb.sect,e={};1>=c.zoom?(e.x=(a.x-this.ix)/c.zoom+c.x0+1,e.y=(b.img.height-1-(a.y-this.iy))/c.zoom+c.y0+1):(e.x=(a.x-this.ix)/c.zoom+c.x0+1-0.5,e.y=(b.img.height-1-(a.y-this.iy))/c.zoom+c.y0+1-0.5);return e};a.Image.prototype.imageToDisplayPos=function(a){var b=this.rgb,c=this.rgb.sect,e={};1>=c.zoom?(e.x=(a.x-1-c.x0)*c.zoom+this.ix,e.y=(c.y0-(a.y-1))*c.zoom+(b.img.height-1)+this.iy):(e.x=(a.x-1+0.5-c.x0)*c.zoom+this.ix,e.y=(c.y0-(a.y-1+0.5))*c.zoom+(b.img.height-
1)+this.iy);return e};a.Image.prototype.logicalToDisplayPos=function(a){return this.imageToDisplayPos(this.logicalToImagePos(a))};a.Image.prototype.displayToLogicalPos=function(a){return this.imageToLogicalPos(this.displayToImagePos(a))};a.Image.prototype.getWCSSys=function(){if(this.params.wcssys)return this.params.wcssys};a.Image.prototype.setWCSSys=function(d){if("image"===d)this.params.wcssys="image",this.params.wcsunits="pixels";else if("physical"===d)this.params.wcssys="physical",this.params.wcsunits=
"pixels";else if(this.raw.wcs&&0<this.raw.wcs&&("native"===d&&(d=this.params.wcssys0),d=a.wcssys(this.raw.wcs,d)))this.params.wcssys=d.trim(),d="pixels"===this.params.wcsunits?a.imageOpts.wcsunits:this.params.wcsunits,this.setWCSUnits(d),this.updateShapes("regions","all","update");a.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetwcssys");return this};a.Image.prototype.initWCS=function(d){var b,c,e,f=/(WCSNAME|WCSAXES|CRVAL[0-9]|CRPIX[0-9]|PC[0-9]_[0-9]|CDELT[0-9]|CD[0-9]_[0-9]|CTYPE[0-9]|CUNIT[0-9]|CRVAL[0-9]|PV[0-9]_[0-9]|PS[0-9]_[0-9]|RADESYS|LONPOLE|LATPOLE)([A-Z])/;
if(!this.raw.header)return this;d=d||this.raw.header;this.raw.altwcs={};b="default";this.raw.altwcs[b]={};this.raw.altwcs[b].header=this.raw.header;for(c in d)if(d.hasOwnProperty(c)&&(e=c.match(f))&&e.length)b=e[2],this.raw.altwcs[b]||(this.raw.altwcs[b]={},this.raw.altwcs[b].header=$.extend({},this.raw.header)),"RADESYS"===e[1]&&(e[1]="RADECSYS"),this.raw.altwcs[b].header[e[1]]=d[e[0]];for(c in this.raw.altwcs)if(this.raw.altwcs.hasOwnProperty(c)){d=a.raw2FITS(this.raw.altwcs[c].header);this.raw.altwcs[c].wcs=
a.initwcs(d);try{this.raw.altwcs[c].wcsinfo=JSON.parse(a.wcsinfo(this.raw.altwcs[c].wcs))}catch(g){}}this.setWCS("default");return this};a.Image.prototype.getWCS=function(){var a,b;for(a in this.raw.altwcs)if(this.raw.altwcs.hasOwnProperty(a)&&this.raw.wcs===this.raw.altwcs[a].wcs)return b=$.extend(!0,{},this.raw.altwcs[a].wcsinfo),b.version=a,b.wcsname=this.raw.altwcs[a].header.WCSNAME,b;return null};a.Image.prototype.setWCS=function(d){var b,c;d=d||"default";if(!this.raw||!this.raw.altwcs)return this;
for(b in this.raw.altwcs)if(this.raw.altwcs.hasOwnProperty(b)&&(c=this.raw.altwcs[b].header.WCSNAME,d===b||d===c))return 0>=this.raw.altwcs[b].wcs&&a.error("invalid WCS for version: %s",d),this.raw.wcs=this.raw.altwcs[b].wcs,this.raw.wcsinfo=this.raw.altwcs[b].wcsinfo,d=this.raw.wcsinfo&&this.raw.wcsinfo.radecsys?this.raw.wcsinfo.radecsys:this.params.wcssys.trim(),this.setWCSSys(d),this.params.wcssys0||(this.params.wcssys0=d),this.setWCSUnits(this.params.wcsunits),this;a.error("could not find WCS version: "+
d)};a.Image.prototype.getWCSUnits=function(){return this.params.wcsunits?this.params.wcsunits:"pixels"};a.Image.prototype.setWCSUnits=function(d){var b;if("pixels"===d)this.params.wcssys="physical",this.params.wcsunits="pixels";else if(this.raw.wcs&&0<this.raw.wcs){if("image"===this.params.wcssys||"physical"===this.params.wcssys)b=a.imageOpts.wcssys,this.setWCSSys(this.raw.wcs,b);if(d=a.wcsunits(this.raw.wcs,d))this.params.wcsunits=d.trim(),this.updateShapes("regions","all","update")}a.globalOpts.extendedPlugins&&
this.xeqPlugins("image","onsetwcsunits");return this};a.Image.prototype.notifyHelper=function(){var d,b=this,c=RegExp("^"+a.ANON+"[0-9]*");a.helper.connected&&!this.file.match(c)&&a.helper.send("image",{image:this.file},function(c){var f,g;"object"===typeof c?(f=c.stdout,c.stderr&&1<a.DEBUG&&a.log(c.stderr)):f=c;if(f){f=f.trim().split(/ +/);if((c=a.lookupImage(f[0],b.display.id||a.DEFID))&&!c.fitsFile)if(f=f[1],"?"!==f){if(a.analOpts.dataDir)g=f.lastIndexOf("/")+1,c.fitsFile=a.analOpts.dataDir+"/"+
f.slice(g);else{c.fitsFile=f;if(0>c.fitsFile.indexOf("/")&&(d=c.file.match(/.*\//))&&d.length)f=RegExp("^"+a.INSTALLDIR),d=d[0].replace(f,""),c.fitsFile=d+c.fitsFile;a.analOpts.prependJS9Dir&&(c.fitsFile&&"/"!==c.fitsFile.charAt(0)&&(c.fitsFile="${JS9_DIR}/"+c.fitsFile),c.parentFile&&"/"!==c.parentFile.charAt(0)&&(c.parentFile="${JS9_DIR}/"+c.parentFile))}1<a.DEBUG&&a.log("JS9 fitsFile: %s %s",c.file,c.fitsFile)}c&&c.fitsFile&&(c.fitsFile=c.fitsFile.replace(/\/\.\//g,"/"));c&&c.parentFile&&(c.parentFile=
c.parentFile.replace(/\/\.\//g,"/"));b.queried||(b.queryHelper("all"),b.queried=!0)}});return this};a.Image.prototype.queryHelper=function(d){var b=this;d=d||"all";if(a.helper.connected&&("all"===d||"getAnalysis"===d))this.analysisPackages||a.helper.send("getAnalysis",{fits:this.fitsFile},function(d){if(d)try{b.analysisPackages=JSON.parse(d)}catch(e){a.log("can't get analysis",e)}});return this};a.Image.prototype.expandMacro=function(d,b){var c,e,f=this;if(d)return c=d.replace(/\$([a-zA-Z0-9_()]+)/g,
function(d,c){var j,k;j=function(a,d){var c=a.params.wcssys;if(d)switch(d){case "wcs":if("physical"===c||"image"===c)a.params.wcssys=a.params.wcssys0;break;case "physical":case "image":a.params.wcssys=d}return c};var m=function(a,d){var c;"table"===a.imtab?a.raw.hdu.table.filter&&!d.match(a.raw.hdu.table.filter)&&(d=d.match(/\]\[/)?d.slice(0,-1)+"&&"+a.raw.hdu.table.filter+"]":d+("["+a.raw.hdu.table.filter+"]")):"image"===a.imtab&&(c=a.file.match(/\[.*\]/))&&(d=d.match(/\[.*\]/)?d.replace(/\[.*\]/,
c):d+c);return d},n=c.split("(");n[1]&&(n[1]=n[1].replace(/\)$/,""));switch(n[0]){case "id":k=f.display.divjq.attr("id");break;case "image":case "png":k=f.id;break;case "filename":f.parentFile&&"this"!==n[1]?k=f.parentFile:f.fitsFile?k=m(f,f.fitsFile):a.error("no FITS file for "+f.id);break;case "fits":f.fitsFile||a.error("no FITS file for "+f.id);k=m(f,f.fitsFile);break;case "parent":f.parentFile||a.error("no parent FITS file for "+f.id);k=f.parentFile;break;case "ext":f.fitsFile?(k=f.fitsFile.match(/\[.*\]/),
null===k&&(k="")):a.error("no FITS file for "+f.id);break;case "imcenter":k=f.displayToLogicalPos({x:f.display.width/2,y:f.display.height/2});k=sprintf("%s,%s",k.x,k.y);break;case "wcscenter":k=f.displayToImagePos({x:f.display.width/2,y:f.display.height/2});k=a.pix2wcs(f.raw.wcs,k.x,k.y).replace(/\s+/g,",");break;case "sregions":j=j(f,n[1]);k=f.listRegions("source",0).replace(/\s+/g,"");j&&(f.params.wcssys=j);break;case "bregions":j=j(f,n[1]);k=f.listRegions("background",0).replace(/\s+/g,"");j&&
(f.params.wcssys=j);break;case "regions":j=j(f,n[1]);k=f.listRegions("all",0).replace(/\s+/g,"");j&&(f.params.wcssys=j);break;default:if(b){e=b.length;for(j=0;j<e;j++)if(b[j].name===c){k=b[j].value;break}k||(k="false")}k||(k=d)}return k})};a.Image.prototype.lookupAnalysis=function(a){var b,c,e,f=null;if(this.analysisPackages){for(c=0;c<this.analysisPackages.length&&!f;c++){e=this.analysisPackages[c];for(b=0;b<e.length;b++){f=e[b];if(f.xclass&&f.xclass+":"+f.name===a)break;f=null}}if(f)return f;for(c=
0;c<this.analysisPackages.length&&!f;c++){e=this.analysisPackages[c];for(b=0;b<e.length;b++){f=e[b];if(f.name===a)break;f=null}}}return f};a.Image.prototype.runAnalysis=function(d,b,c){var e,f=this,g={};c=c||a.globalOpts.analysisFunc;if(a.helper.connected&&this.analysisPackages){if(e=this.lookupAnalysis(d)){e.action&&(g.cmd=this.expandMacro(e.action,b));if(e.keys){g.keys={};for(d=0;d<e.keys.length;d++)g.keys[e.keys[d]]=this.expandMacro("$"+e.keys[d],b)}g.id=this.expandMacro("$id");g.image=this.file;
g.fits=this.fitsFile;g.rtype=e.rtype;switch(a.helper.type){case "nodejs":case "socket.io":b=e.xclass?e.xclass+":"+e.name:e.name;break;default:b="runAnalysis"}a.waiting(!0,this.display.divjq[0]);a.helper.send(b,g,function(d){var b,g;a.waiting(!1);b="object"===typeof d?d:0<=d.search(a.analOpts.epattern)?{stderr:d}:{stdout:d};b.errcode=b.errcode||0;if(c)c(b.stdout,b.stderr,b.errcode,e);else{if(b.errcode||b.stderr)d=b.stderr?b.stderr:sprintf("ERROR: while executing %s [%s]",e.name,b.errcode),0<=d.search(/WARNING/i)?
a.log(d):a.error(d,a.analOpts.epattern);switch(e.rtype){case "text":case void 0:f.displayAnalysis("text",b.stdout,{divid:a.globalOpts.analysisDiv});break;case "plot":f.displayAnalysis("plot",b.stdout,{divid:a.globalOpts.analysisDiv});break;case "alert":b.stdout&&alert(b.stdout);break;case "fits":case "png":g=b.stdout.split(/\s+/);d=g[0].trim().replace(/\/\.\//,"/");"/"!==d.charAt(0)&&(d=a.InstallDir(d));b={proxyFile:d};g[1]&&(g=g[1].trim().replace(/\/\.\//,"/"),b.parentFile=g);a.Load(d,b,{display:f.display});
break;case "none":break;default:a.error("unknown analysis result type: "+e.rtype)}}});return this}a.error("could not find analysis task: "+d)}};a.Image.prototype.displayAnalysis=function(d,b,c){var e,f,g,h,j,k,m,n,q,l={x:"linear",y:"linear"};e=a.lightOpts[a.LIGHTWIN];var p=function(a){return 0===a?a:Math.log(a)},r=function(a){return 0===a?a:Math.exp(a)},s=function(a,d){var c,b,e;if(!a.text)return null;b=a.x||0;if("%Y"===a.y.toUpperCase())for(c=1;c<d.length-1;c++){if(d[c][0]>b){e=Math.max(d[c-1][1],
d[c][1],d[c+1][1]);break}}else e=a.y;return{x:b,y:e}},t=function(a,d,c,b){switch(c){case "x":c=d.getAxes().xaxis;break;case "y":c=d.getAxes().yaxis}switch(b){case "linear":c.options.transform=null;c.options.inverseTransform=null;break;case "log":c.options.transform=p,c.options.inverseTransform=r}l[c]=b;d.setupGrid();d.draw()},w=function(d,c,b){var e,f,g,h=b.data,k=b.annotations.color||a.plotOpts.annotateColor;d.find(".plotAnnotation").remove();for(e=0;e<b.annotations.data.length;e++)f=b.annotations.data[e],
g=s(f,h),g=c.pointOffset({x:g.x,y:g.y}),0>g.left||g.left>d.width()||(f=sprintf("<div class='plotAnnotation' style='position: absolute; left: %spx; top:%spx; color: %s; font-size: small'>%s</div>",g.left,g.top+-25,k,"&darr;"+f.text),d.append(f))},u=function(a,d,c,b){var e;switch(c){case "x":e={xaxis:{type:b,autorange:!0}};break;case "y":e={yaxis:{type:b,autorange:!0}}}Plotly.restyle(a.attr("id"),e)};c=c||{};k=c.winformat;c.divid&&0<$("#"+c.divid).length&&(m=$("#"+c.divid));j=c.title||"";this&&!j&&
(c=this.fitsFile||this.id,c=c.split("/").reverse()[0],j="AnalysisResults: "+c+sprintf(a.IDFMT,this.display.id));c="Analysis_"+a.uniqueID();switch(d){case "text":b="<div class='JS9Analysis'></div>"+("<pre class='JS9AnalysisText'>"+(b||"")+"</pre>");b+="</div>";m?m.html(b):(k=k||e.textWin,f=a.lightWin(c,"inline",b,j,k));break;case "plot":try{g=JSON.parse(b)}catch(y){a.error("can't plot return data: "+b,y)}if(!g)return;b=sprintf("<div id='%s' class='JS9Analysis'><div id='%sPlot' class='JS9Plot' ></div></div>",
c,c);m?m.html(b):(k=k||e.plotWin,f=a.lightWin(c,"inline",b,j,k));h=$("#"+c+" #"+c+"Plot");m&&(h.css("width",m.css("width")),h.css("height",m.css("height")),h.css("margin",0));if(g.data){switch(a.globalOpts.plotLibrary){case "plotly":q=u;b=$.extend(!0,{},a.plotOpts,g.opts);g.label&&(b.title=g.label);k={x:[],y:[],type:"scatter"};3<=g.data[0].length&&(k.error_y={type:"data",array:[],visible:!0},g.points&&g.points.yerr&&g.points.yerr.color&&(k.error_y.color=g.points.yerr.color));for(e=0;e<g.data.length;e++)k.x.push(g.data[e][0]),
k.y.push(g.data[e][1]),k.error_y&&k.error_y.array&&k.error_y.array.push(g.data[e][2]);if(a.plotOpts.annotate&&g.annotations){e=b;var t=g,v,x;d=t.data;c=t.annotations.color||a.plotOpts.annotateColor;j=[];for(u=0;u<t.annotations.data.length;u++)if(v=t.annotations.data[u],x=s(v,d))v={x:x.x,y:x.y,xref:"x",yref:"y",text:v.text,arrowcolor:c,font:{color:c},showarrow:!0,arrowhead:2,ax:0,ay:-30},j.push(v);e.annotations=j}"log"===b.xscale&&(b.xaxis=b.xaxis||{},b.xaxis.type="log",b.xaxis.autorange=!0,l.x="log");
"log"===b.yscale&&(b.yaxis=b.yaxis||{},b.yaxis.type="log",b.yaxis.autorange=!0,l.y="log");try{Plotly.newPlot(h.attr("id"),[k],b)}catch(z){a.error("can't plot data (plotly)",z)}break;default:q=t;b=$.extend(!0,{},a.plotOpts,g.opts);a.plotOpts.annotate&&g.annotations&&(b.zoomStack.func=function(a){w(h,a,g)});g.color=g.color||b.color;"log"===g.xscale&&(b.xaxis=b.xaxis||{},b.xaxis.transform=p,b.xaxis.inverseTransform=r,l.x="log");"log"===g.yscale&&(b.yaxis=b.yaxis||{},b.yaxis.transform=p,b.yaxis.inverseTransform=
r,l.y="log");try{n=$.plot(h,[g],b)}catch(C){a.error("can't plot data (flot)",C)}a.plotOpts.annotate&&g.annotations&&w(h,n,g)}h.css("outline","none");h.attr("tabindex",0);h.on("keypress",function(a){a=String.fromCharCode(a.which||a.keyCode);l[a]="linear"===l[a]?"log":"linear";q(h,n,a,l[a])})}break;case "params":case "textline":m?a.allinone?m.html(b):$.ajax({url:b,cache:!1,dataType:"text",success:function(a){m.html(a)}}):(k="params"===d?k||e.paramWin:k||e.dpathWin,f=a.allinone?"inline":"ajax",f=a.lightWin(c,
f,b,j,k))}return f};a.Image.prototype.loadAuxFile=function(d,b){var c=this,e,f,g,h,j=a.auxFiles.length,k=[],m=function(){c.aux[f.name]=f;a.Image.prototype.mkOffScreenCanvas.call(h);a.Image.prototype.mkRawDataFromPNG.call(h);if(b)try{a.xeqByName(b,window,c,f)}catch(d){a.error("in aux mask onload callback",d)}a.DEBUG&&a.log("JS9 %s: %s dims(%d,%d) min/max(%d,%d)",h.type,h.file,h.raw.width,h.raw.height,h.raw.dmin,h.raw.dmax)},n=function(d){c.aux[f.name]=f;f.regions=d;if(b)try{a.xeqByName(b,window,c,
f)}catch(e){a.error("in aux region onload callback",e)}},q=function(d){c.aux[f.name]=f;f.text=d;if(b)try{a.xeqByName(b,window,c,f)}catch(e){a.error("in aux text onload callback",e)}},l=function(d,c){a.log(sprintf("could not load auxiliary file: %s [%s]",f.url,c))};if(d&&j){for(e=0;e<j;e++)f=a.auxFiles[e],f.image&&!f.regex&&(f.regex=RegExp(f.image));g=d.split(":");for(e=0;e<j;e++)if(f=a.auxFiles[e],g[0]===f.name&&this.id.match(f.regex)&&(1===g.length||g[1]===f.type))switch(f.type){case "mask":if(f.im){if(this.aux[f.name]=
f,b)try{a.xeqByName(b,window,this,f)}catch(p){a.error("in aux mask callback",p)}}else k.push(f);break;case "regions":if(f.layer){if(this.aux[f.name]=f,b)try{a.xeqByName(b,window,this,f)}catch(r){a.error("in aux regions callback",r)}}else k.push(f);break;case "text":if(f.text){if(this.aux[f.name]=f,b)try{a.xeqByName(b,window,this,f)}catch(s){a.error("in aux text callback",s)}}else k.push(f)}for(e=0;e<k.length;e++)switch(f=k[e],f.type){case "mask":f.im={};h=f.im;h.type="aux";h.file=f.url;h.id=h.file.split("/").reverse()[0];
h.params={};h.params.scalemin=Number.Nan;h.params.scalemax=Number.Nan;h.png={};h.png.image=new Image;$(h.png.image).on("load",m).on("error",l);h.png.image.src=a.InstallDir(f.url);break;case "regions":f.layer=this.display.newShapeLayer(d,a.Regions.opts);g=a.InstallDir(f.url);$.ajax({url:g,cache:!1,dataType:"json",mimeType:"application/json",success:n,error:l});break;case "text":g=a.InstallDir(f.url),$.ajax({url:g,cache:!1,dataType:"text",success:q,error:l})}}};a.Image.prototype.saveFITS=function(d){var b;
window.hasOwnProperty("saveAs")?(d=d||"js9.fits",b=this.toArray(),b=new Blob([b],{type:"application/octet-binary"}),saveAs(b,d)):a.error("no saveAs function available to save FITS file");return d};a.Image.prototype.saveIMG=function(d,b,c){var e,f,g,h,j,k;if(window.hasOwnProperty("saveAs")){d=d||"js9.png";j=this.display.width;k=this.display.height;f=document.createElement("canvas");f.setAttribute("width",j);f.setAttribute("height",k);g=f.getContext("2d");g.drawImage(this.display.canvas,0,0);for(e in this.layers)this.layers.hasOwnProperty(e)&&
("main"===this.layers[e].dlayer.dtype&&this.layers[e].show)&&(h=this.layers[e].dlayer.canvasjq[0],g.drawImage(h,0,0,j,k));if(void 0!==c&&(0>c||1<c))c=0.95;f.toBlob(function(a){saveAs(a,d)},b||"image/png",c)}else a.error("no saveAs function available for saving image");return d};a.Image.prototype.savePNG=function(a){return this.saveIMG(a||"js9.png","image/png")};a.Image.prototype.saveJPEG=function(a,b){return this.saveIMG(a||"js9.jpeg","image/jpeg",b)};a.Image.prototype.updateValpos=function(d,b){var c,
e,f,g,h,j;c=null;e=a.floatPrecision(this.params.scalemin,this.params.scalemax);f=function(a,d){return a.toFixed(d||3)};h=function(a,d){var c="",b="";d=d||3;0>a&&(a=Math.abs(a),b="-");for(c+=a;c.length<d;)c="0"+c;return b+c};if(this.params.valpos){void 0===b&&(b=!0);if(this.valpos)return b&&this.displayMessage("info",this.valpos),this.valpos;g={x:d.x,y:d.y,sys:"image"};j="image"===this.params.wcssys?g:this.imageToLogicalPos(d);c=this.raw.data[Math.floor(d.y-0.5)*this.raw.width+Math.floor(d.x-0.5)];
switch(this.raw.bitpix){case 8:case 16:case -16:case 32:h=h(c);break;case -32:case -64:h=a.floatFormattedString(c,e,3);break;default:h=h(c)}e=h;f=f(j.x,3)+" "+f(j.y,3)+" ("+j.sys+")";c={ix:g.x,iy:g.y,isys:"image",px:j.x,py:j.y,psys:j.sys,ra:"",dec:"",wcssys:"",val:c,val3:h,vstr:e+"&nbsp;&nbsp;&nbsp;&nbsp;"+f,id:this.id,file:this.file,object:this.object};0<this.raw.wcs&&("image"!==this.params.wcssys&&"physical"!==this.params.wcssys)&&(j=a.pix2wcs(this.raw.wcs,d.x,d.y).trim().split(/\s+/),g=j[0]+" "+
j[1]+" ("+(j[2]||"wcs")+")",c.ra=j[0],c.dec=j[1],c.wcssys=j[2],c.vstr=e+"&nbsp;&nbsp;&nbsp;&nbsp;"+g+"&nbsp;&nbsp;&nbsp;&nbsp;"+f);b&&this.displayMessage("info",c)}return c};a.Image.prototype.getColormap=function(){if(this.cmapObj)return{colormap:this.cmapObj.name,contrast:this.params.contrast,bias:this.params.bias}};a.Image.prototype.setColormap=function(d,b,c){switch(arguments.length){case 1:case 3:switch(d){case "rgb":a.globalOpts.rgb.active=!a.globalOpts.rgb.active;break;case "invert":this.params.invert=
!this.params.invert;break;case "reset":this.params.invert=a.imageOpts.invert;this.params.contrast=a.imageOpts.contrast;this.params.bias=a.imageOpts.bias;break;default:if(this.cmapObj)switch(this.cmapObj.name){case "red":a.globalOpts.rgb.rim=null;break;case "green":a.globalOpts.rgb.gim=null;break;case "blue":a.globalOpts.rgb.bim=null}this.cmapObj=a.lookupColormap(d);this.params.colormap=this.cmapObj.name;switch(d){case "red":a.globalOpts.rgb.rim=this;break;case "green":a.globalOpts.rgb.gim=this;break;
case "blue":a.globalOpts.rgb.bim=this}}3===arguments.length&&(isNaN(b)||(this.params.contrast=b),isNaN(c)||(this.params.bias=c));break;case 2:isNaN(d)||(this.params.contrast=d),isNaN(b)||(this.params.bias=b)}this.displayImage("colors");a.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetcolormap");return this};a.Image.prototype.getScale=function(){if(this.params.scale)return{scale:this.params.scale,scalemin:this.params.scalemin,scalemax:this.params.scalemax}};a.Image.prototype.setScale=function(d,
b,c){var e=this,f=function(d){0<=a.scales.indexOf(d)?e.params.scale=d:a.error("unknown scale: "+d)};if(arguments.length){switch(arguments.length){case 1:f(d);break;case 2:this.params.scalemin=parseInt(d,10);this.params.scalemax=parseInt(b,10);this.mkColorData();break;default:f(d),this.params.scalemin=parseInt(b,10),this.params.scalemax=parseInt(c,10),this.mkColorData()}this.displayImage("scaled")}a.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetscale");return this};a.Image.prototype.dataminmax=
function(){var a,b,c=isNaN(this.params.scalemin)||void 0===this.params.scalemin,e=isNaN(this.params.scalemax)||void 0===this.params.scalemax;if("dataminmax"===this.params.scaleclipping){if(this.raw.dmin===this.params.scalemin||void 0===this.raw.dmin)c=!0;if(this.raw.dmax===this.params.scalemax||void 0===this.raw.dmax)e=!0}this.raw.dmin=Number.MAX_VALUE;this.raw.dmax=Number.MIN_VALUE;if(0<this.raw.bitpix)if(void 0!==this.raw.header.BLANK){b=this.raw.header.BLANK;for(a=0;a<this.raw.data.length;a++)this.raw.data[a]!==
b&&(this.raw.dmin=Math.min(this.raw.dmin,this.raw.data[a]),this.raw.dmax=Math.max(this.raw.dmax,this.raw.data[a]))}else for(a=0;a<this.raw.data.length;a++)this.raw.dmin=Math.min(this.raw.dmin,this.raw.data[a]),this.raw.dmax=Math.max(this.raw.dmax,this.raw.data[a]);else for(a=0;a<this.raw.data.length;a++)isNaN(this.raw.data[a])||(this.raw.dmin=Math.min(this.raw.dmin,this.raw.data[a]),this.raw.dmax=Math.max(this.raw.dmax,this.raw.data[a]));c&&(this.params.scalemin=this.raw.dmin);e&&(this.params.scalemax=
this.raw.dmax);return this};a.Image.prototype.zscale=function(d){var b,c,e;if(!a.zscale||!this.raw||!this.raw.data)return this;b=this.raw.data;c=b.length*b.BYTES_PER_ELEMENT;try{e=a.vmalloc(c)}catch(f){a.error("image too large for zscale malloc: "+c,f)}try{a.vmemcpy(new Uint8Array(b.buffer),e)}catch(g){a.error("can't copy image to zscale heap: "+c,g)}b=a.zscale(e,this.raw.width,this.raw.height,this.raw.bitpix,this.params.zscalecontrast,this.params.zscalesamples,this.params.zscaleline);a.vfree(e);
e=b.trim().split(/\s+/);this.params.z1=parseFloat(e[0]);this.params.z2=parseFloat(e[1]);d&&(this.params.scalemin=this.params.z1,this.params.scalemax=this.params.z2);return this};a.Image.prototype.rawDataLayer=function(d,b){var c,e,f,g,h,j;if(!arguments.length)return this.raw.id;if("string"===typeof d)if("function"===typeof b)d={rawid:d};else{for(c=0;c<this.raws.length;c++)if(f=this.raws[c],d===f.id){if("remove"===b){"raw0"===d&&a.error("can't remove primary (raw0) data layer");f.hdu&&f.hdu.fits&&
(e=a.lookupVfile(f.hdu.fits.vfile),1>=e.length&&a.fits.cleanupFITSFile(f.hdu.fits,!0));this.raw=this.raws[0];if(f.current0&&f.current0.id)for(e=0;e<this.raws.length;e++)if(f.current0.id===this.raws[e].id){this.raw=this.raws[e];break}this.raws.splice(c,1);this.raw.header.bitpix&&(this.raw.bitpix=this.raw.header.bitpix);this.dataminmax();this.mkSection();this.displayImage("all",d);return!0}this.raw=f;this.raw.header.bitpix&&(this.raw.bitpix=this.raw.header.bitpix);this.dataminmax();this.mkSection();
this.displayImage("all",d);a.globalOpts.extendedPlugins&&this.xeqPlugins("image","onrawdatalayer");return!0}return!1}if("function"!==typeof b)return!1;d=d||{};h=d.rawid||a.RAWIDX;void 0===d.oraw&&(d.oraw="current0");if("current"===d.oraw)e=this.raw;else if("current0"===d.oraw){for(c=0;c<this.raws.length;c++)if(f=this.raws[c],h===f.id){e=f.current0;break}e||(e=this.raw)}else for(c=0;c<this.raws.length;c++)if(f=this.raws[c],d.oraw===f.id){e=f;break}e||(e=this.raws[0]);f=-1;for(c=0;c<this.raws.length;c++)if(h===
this.raws[c].id){g=this.raws[c];f=c;break}if(0>f||d.alwaysCopy){g=$.extend(!0,{},e);g.current0=e;if(d.bitpix){switch(d.bitpix){case 8:g.data=new Uint8Array(e.height*e.width);break;case 16:g.data=new Int16Array(e.height*e.width);break;case -16:g.data=new Uint16Array(e.height*e.width);break;case 32:g.data=new Int32Array(e.height*e.width);break;case -32:g.data=new Float32Array(e.height*e.width);break;case -64:g.data=new Float64Array(e.height*e.width)}j=g.width*g.height;for(c=0;c<j;c++)g.data[c]=e.data[c];
g.bitpix=d.bitpix}else switch(e.bitpix){case 8:g.data=new Uint8Array(e.data);break;case 16:g.data=new Int16Array(e.data);break;case -16:g.data=new Uint16Array(e.data);break;case 32:g.data=new Int32Array(e.data);break;case -32:g.data=new Float32Array(e.data);break;case -64:g.data=new Float64Array(e.data)}g.id=h;g.from=d.from||g.from||"func"}b.call(this,e,g,d)&&(0<=f?this.raws[f]=g:this.raws.push(g),this.raw=g,this.raw.header.bitpix&&(this.raw.bitpix=this.raw.header.bitpix),!1!==d.dataminmax&&this.dataminmax(),
this.displayImage("all",d));return!0};a.Image.prototype.gaussBlurData=function(d){var b={};void 0===d&&a.error("missing sigma value for gaussBlurData");b=b||{};b.bitpix=-64===this.raw.bitpix?-64:-32;b.oraw="current0";b.alwaysCopy=!0;b.rawid=b.rawid||"gaussBlur";b.sigma=d;this.rawDataLayer(b,function(c,b){var f;switch(b.bitpix){case -32:f=new Float32Array(b.data);break;case -64:f=new Float64Array(b.data);break;default:a.error("invalid temp bitpix for gaussBlur: "+b.bitpix)}gaussBlur(f,b.data,b.width,
b.height,d);return!0});return this};a.Image.prototype.imarithData=function(d,b,c){var e;if(!arguments.length)return"add sub mul div min max reset".split(" ");c=c||{};c.rawid=c.rawid||"imarith";if("reset"===d||"remove"===d)this.rawDataLayer(c.rawid,"remove");else{(void 0===d||void 0===b)&&a.error("missing arg(s) for image arithmetic");switch(d){case "add":case "sub":case "mul":case "div":case "min":case "max":c.op=d;break;default:a.error("invalid operator for image arithmetic: "+d)}"object"===typeof b?
(!b.raw.hdu||!b.raw.hdu.fits||!b.raw.hdu.fits.vfile?a.error("no virtual FITS file for image arithmetic: "+b.id):(c.argtype="image",c.argval=b),(this.raw.width!==b.raw.width||this.raw.height!==b.raw.height)&&a.error("images must be the same size for image arithmetic")):a.isNumber(b)?(c.argtype="value",c.argval=b):((e=a.lookupImage(b))||a.error("imarith arg1 must be an image or a constant: "+b),c.argval=e,c.argtype="image");"div"===c.op&&("value"===c.argtype&&0===c.argval)&&a.error("imarith can't divide by zero (nor can anyone else)");
if(!c.bitpix)switch(c.argtype){case "image":c.bitpix=0<this.raw.bitpix&&0<c.argval.raw.bitpix?Math.max(this.raw.bitpix,c.argval.raw.bitpix):0>this.raw.bitpix&&0>c.argval.raw.bitpix?Math.min(this.raw.bitpix,c.argval.raw.bitpix):0>this.raw.bitpix&&0<c.argval.raw.bitpix?this.raw.bitpix:c.argval.raw.bitpix;break;case "value":c.bitpix=-64===this.raw.bitpix?-64:-32}c.alwaysCopy=!0;c.oraw="current";this.rawDataLayer(c,function(d,c,b){switch(b.argtype){case "image":d=b.argval.raw.data;switch(b.op){case "add":for(b=
0;b<c.data.length;b++)c.data[b]+=d[b];break;case "sub":for(b=0;b<c.data.length;b++)c.data[b]-=d[b];break;case "mul":for(b=0;b<c.data.length;b++)c.data[b]*=d[b];break;case "div":for(b=0;b<c.data.length;b++)c.data[b]=0===d[b]?0:c.data[b]/d[b];break;case "min":for(b=0;b<c.data.length;b++)c.data[b]=Math.min(c.data[b],d[b]);break;case "max":for(b=0;b<c.data.length;b++)c.data[b]=Math.max(c.data[b],d[b]);break;default:a.error("unknown operation for imarith: "+b.op)}break;case "value":d=b.argval;switch(b.op){case "add":for(b=
0;b<c.data.length;b++)c.data[b]+=d;break;case "sub":for(b=0;b<c.data.length;b++)c.data[b]-=d;break;case "mul":for(b=0;b<c.data.length;b++)c.data[b]*=d;break;case "div":for(b=0;b<c.data.length;b++)c.data[b]=0===d?0:c.data[b]/d;break;case "min":for(b=0;b<c.data.length;b++)c.data[b]=Math.min(c.data[b],d);break;case "max":for(b=0;b<c.data.length;b++)c.data[b]=Math.max(c.data[b],d);break;default:a.error("unknown op for imarith: "+b.op)}break;default:a.error("unknown argument type for imarith: "+b.argtype)}return!0});
return this}};a.Image.prototype.shiftData=function(d,b,c){(void 0===d||void 0===b)&&a.error("missing translation value(s) for shiftData");c=c||{};c.rawid=c.rawid||"shift";c.x=d;c.y=b;this.rawDataLayer(c,function(a,d,c){var b,j,k,m,n=a.data.BYTES_PER_ELEMENT;void 0===d.xoff&&(d.xoff=0);void 0===d.yoff&&(d.yoff=0);d.xoff+=c.x;d.yoff+=c.y;if(!c.fill||"clear"===c.fill)if(0<d.bitpix?(m=c.blank||d.header.BLANK||0,d.header.BLANK=m):m=NaN,"function"===typeof d.data.fill)d.data.fill(m);else for(c=0;c<d.data.length;c++)d.data[c]=
m;for(c=0;c<a.height;c++)if(k=c+d.yoff,!(0>k||k>=a.height)){b=0;j=b+d.xoff;m=a.width;0>j&&(b-=j,m+=j,j=0);j+m>a.width&&(m-=j+m-a.width);if(0>=m)return!1;b=(c*a.width+b)*n;b=new Uint8Array(a.data.buffer,b,m*n);j=(k*a.width+j)*n;m=new Uint8Array(d.data.buffer,j,m*n);m.set(b)}return!0});return this};a.Image.prototype.reprojectData=function(d,b){var c=this;a.waiting(!0,this.display.divjq[0]);window.setTimeout(function(){var e={},f=!1,g,h,j,k,m,n,q,l,p,r,s,t,w,u;p=/SIMPLE|BITPIX|NAXIS|NAXIS[1-4]|AMDX|AMDY|CD[1-2]_[1-2]|CDELT[1-4]|CNPIX[1-4]|CO1_[1-9][0-9]|CO2_[1-9][0-9]|CROTA[1-4]|CRPIX[1-4]|CRVAL[1-4]|CTYPE[1-4]|CUNIT[1-4]|DATE|DATE_OBS|DC-FLAG|DEC|DETSEC|DETSIZE|EPOCH|EQUINOX|EQUINOX[a-z]|IMAGEH|IMAGEW|LATPOLE|LONGPOLE|MJD-OBS|PC00[1-4]00[1-4]|PC[1-4]_[1-4]|PIXSCALE|PIXSCAL[1-2]|PLTDECH|PLTDECM|PLTDECS|PLTDECSN|PLTRAH|PLTRAM|PLTRAS|PPO|PROJP[1-9]|PROJR0|PV[1-3]_[1-3]|PV[1-4]_[1-4]|RA|RADECSYS|SECPIX|SECPIX|SECPIX[1-2]|UT|UTMID|VELOCITY|VSOURCE|WCSAXES|WCSDEP|WCSDIM|WCSNAME|XPIXSIZE|YPIXSIZE|ZSOURCE|LTM|LTV/;
r=/TAN|SIN|ZEA|STG|ARC/;var y=function(d){c.refreshImage(d,l);a.waiting(!1)};if(c.raw.wcs&&d&&a.reproject&&a.fits.handleFITSFile){b=b||{};"string"===typeof d&&((m=a.getImage(d))?d=m:a.error("unknown WCS for reproject: "+d));m=$.extend(!0,{},c.raw.header);for(k in m)m.hasOwnProperty(k)&&p.test(k)&&delete m[k];d.raw&&d.raw.header?n=d.raw.header:d.BITPIX&&d.NAXIS1&&d.NAXIS2?n=d:a.error("invalid wcs object input to reproject()");for(k in n)n.hasOwnProperty(k)&&p.test(k)&&(e[k]=n[k]);e=$.extend(!0,{},
e,m);(!e.NAXIS||!e.NAXIS1||!e.NAXIS2)&&a.error("invalid FITS image header");e.NAXIS1*e.NAXIS2>a.REPROJDIM*a.REPROJDIM&&a.error("for now, the max image size for reprojection is approximately "+a.REPROJDIM+" * "+a.REPROJDIM);k=a.raw2FITS(e,!0);e="wcs_"+a.uniqueID()+".txt";a.vfile(e,k);try{r.test(c.raw.wcsinfo.ptype)||(j="owcs_"+a.uniqueID()+".txt",a.vfile(j,a.raw2FITS(c.raw.header,!0)),g="awcs_"+a.uniqueID()+".txt",q=a.tanhdr(j,g,""),1<a.DEBUG&&a.log("tanhdr (input): %s %s -> %s",j,g,q),a.vunlink(j),
0<=q.search(/\[struct stat="OK"/)&&(b.cmdswitches=b.cmdswitches||"",b.cmdswitches+=" -i "+g)),r.test(d.raw.wcsinfo.ptype)||(j="owcs_"+a.uniqueID()+".txt",a.vfile(j,a.raw2FITS(n,!0)),h="awcs_"+a.uniqueID()+".txt",q=a.tanhdr(j,h,""),1<a.DEBUG&&a.log("tanhdr (reproj): %s %s -> %s",j,h,q),a.vunlink(j),0<=q.search(/\[struct stat="OK"/)&&(a.vunlink(e),e=h))}catch(v){}c.raw.hdu&&c.raw.hdu.vfile?(h=c.raw.hdu.vfile,c.raw.hdu.fits.extname?h+=sprintf("[%s]",c.raw.hdu.fits.extname):c.raw.hdu.fits.extnum&&0<c.raw.hdu.fits.extnum&&
(h+=sprintf("[%s]",c.raw.hdu.fits.extnum))):(j=c.toArray(),h=c.id.replace(/\.png$/,"_png.fits"),a.vfile(h,j));n=c.id.replace(/\[.*\]/,"").replace(/\.png$/,".fits").replace(/\.gz$/,"");j="reproj_"+a.uniqueID()+"_"+n;"table"===c.imtab&&(p=c.raw.hdu.table,n=Math.floor(p.cx-(p.nx+1)/2+1),r=Math.floor(p.cx+p.nx/2),k=Math.floor(p.cy-(p.ny+1)/2+1),p=Math.floor(p.cy+p.ny/2),n=sprintf("[EVENTS][bin X=%s:%s,Y=%s:%s]",n,r,k,p),h+=n);try{s=j.lastIndexOf("."),0<=s&&(t=j.substring(0,s)+"_area"+j.substring(s)),
u=b.cmdswitches||"",q=a.reproject(h,j,e,u),1<a.DEBUG&&a.log("reproject: %s %s %s [%s] -> %s",h,j,e,u,q),a.vunlink(t),a.vunlink(e),g&&a.vunlink(g),0>q.search(/\[struct stat="OK"/)&&(f=!0,(w=q.match(/msg="(.*)"/))&&w[1]?a.error(w[1]+" (from mProjectPP)"):a.error(q))}catch(x){if(f)return;a.vunlink(t);a.vunlink(e);q?a.error(q):a.error("WCS reproject failed",x)}l=$.extend(!0,{},b||{},a.fits.options);l.rawid=l.rawid||"reproject";l.wcsim=d;try{a.fits.handleFITSFile(j,l,y)}catch(z){a.error("can't process reprojected FITS file",
z)}}},a.SPINOUT);return this};a.Image.prototype.filterRGBImage=function(d){var b,c=[],e=Array.prototype.slice.call(arguments);if(!d){for(b in a.ImageFilters)a.ImageFilters.hasOwnProperty(b)&&c.push(b);return c}"reset"!==d&&!a.ImageFilters[d]&&a.error("JS9 image filter '"+d+"' not available");if("reset"===d)return this.setColormap("reset"),this;e.shift();e.unshift(this.display.context,this.rgb.img);try{a.ImageFilters[d].apply(null,e)}catch(f){a.error("JS9 image filter '"+d+"' failed",f)}this.displayImage("display");
a.globalOpts.extendedPlugins&&this.xeqPlugins("image","onfilterrgbimage");return this};a.Image.prototype.moveToDisplay=function(d){var b,c,e,f=this.display;c=a.lookupDisplay(d);if(!d||!c)return a.error("could not find display: "+d),null;this.clearMessage();this.display.context.clear();for(b in f.layers)f.layers.hasOwnProperty(b)&&"main"===f.layers[b].dtype&&!c.layers[b]&&c.newShapeLayer(b,f.layers[b].opts);for(b in this.layers)this.layers.hasOwnProperty(b)&&(d=this.layers[b],(e=c.layers[b])&&"main"===
e.dtype?(c.image&&c.image.showShapeLayer(b,!1),this.showShapeLayer(b,!1),d.dlayer=e,d.divjq=e.divjq,d.canvasjq=e.canvasjq,d.canvas=e.canvas,this.showShapeLayer(b,!0)):delete this.layers[b]);this.display=c;this.display.image=this;this.mkSection();this.displayImage("all");this.refreshLayers();f.image=null;for(b=0;b<a.images.length;b++)if(c=a.images[b],f===c.display){c.display.image=null;c.displayImage("all");c.refreshLayers();break}return this};a.Image.prototype.saveSession=function(d){var b,c,e,f;
d=d||"js9.ses";window.hasOwnProperty("saveAs")||a.error("no saveAs function available to save session");a.waiting(!0,this.display.divjq[0]);b={};b.file=this.file;b.params=$.extend(!0,{},this.params);b.params.xcen=this.rgb.sect.xcen;b.params.ycen=this.rgb.sect.ycen;b.params.zoom=this.rgb.sect.zoom;b.layers=[];for(f in this.layers)this.layers.hasOwnProperty(f)&&(c=this.layers[f],c=c.dlayer,"main"===c.dtype&&(e={},e.name=f,e.json=c.canvas.toJSON(c.el),e.dopts=$.extend(!0,{},c.opts),b.layers.push(e)));
b.dwidth=this.display.width;b.dheight=this.display.height;b.params.display&&delete b.params.display;b=JSON.stringify(b,null,4);b=new Blob([b],{type:"application/json"});saveAs(b,d);a.waiting(!1);return d};a.Image.prototype.xeqPlugins=function(a,b,c){var e,f,g,h,j,k=function(a,d){$(document).trigger("JS9:"+a,d)};if(a&&b){h=this.display.pluginInstances;for(e in h)if(h.hasOwnProperty(e)&&(f=h[e],f.isActive(b)))switch(g=f.plugin.opts,a){case "image":try{g[b].call(f,this),k(b,{im:this})}catch(m){f.errLog(b,
m)}break;case "region":case "shape":try{g[b].call(f,this,c),k(b,{im:this,xreg:c})}catch(n){f.errLog(b,n)}break;case "keypress":j=c.originalEvent||c;try{g[b].call(f,this,this.ipos,j),k(b,{im:this,ipos:this.ipos,evt:j})}catch(q){f.errLog(b,q)}break;case "mouse":if(!this.clickInRegion||g[b+"_inRegion"]){j=c.originalEvent||c;try{g[b].call(f,this,this.ipos,j),k(b,{im:this,ipos:this.ipos,evt:j})}catch(l){f.errLog(b,l)}}}return this}};a.Image.prototype.displayMessage=function(){};a.Image.prototype.clearMessage=
function(){};a.Colormap=function(d,b,c,e){this.name=d;switch(arguments.length){case 2:this.type="lut";this.colors=b;break;case 4:this.type="sao";this.vertices=[b,c,e];break;default:a.error("colormap requires a colormap name and 1 or 3 array args")}a.colormaps.push(this);1<a.DEBUG&&a.log("JS9 colormap:  %s",this.name)};a.Colormap.prototype.mkColorCell=function(d){var b,c=a.COLORSIZE,e=[0,0,0],f,g;switch(this.type){case "sao":f=d/c;for(d=0;3>d;d++){g=this.vertices[d];b=g.length;for(c=0;c<b&&!(g[c][0]>
f);c++);c=0===c?g[0][1]:c===b?g[b-1][1]:(b=(g[c][1]-g[c-1][1])/(g[c][0]-g[c-1][0]))?b*(f-g[c-1][0])+g[c-1][1]:g[c][1];e[d]=255*c}break;case "lut":f=this.colors.length;d=Math.floor(d*f/c);0>d?(e[0]=255*this.colors[0][0],e[1]=255*this.colors[0][1],e[2]=255*this.colors[0][2]):d<f?(e[0]=255*this.colors[d][0],e[1]=255*this.colors[d][1],e[2]=255*this.colors[d][2]):(e[0]=255*this.colors[f-1][0],e[1]=255*this.colors[f-1][1],e[2]=255*this.colors[f-1][2]);break;default:a.error("unknown colormap type")}return e};
a.Display=function(d){var b=this;this.divjq=d instanceof jQuery?d:"object"===typeof d?$(d):$("#"+d);this.divjq.attr("id")||this.divjq.attr("id",a.DEFID);this.id=this.divjq.attr("id");this.divjq.addClass("JS9");this.width=this.divjq.attr("data-width");this.width||(this.width=a.WIDTH);this.divjq.css("width",this.width);this.width=parseInt(this.divjq.css("width"),10);this.height=this.divjq.attr("data-height");this.height||(this.height=a.HEIGHT);this.divjq.css("height",this.height);this.height=parseInt(this.divjq.css("height"),
10);this.width0=this.width;this.height0=this.height;this.canvas=document.createElement("canvas");this.canvasjq=$(this.canvas).addClass("JS9Image").attr("id",this.id+"Image").attr("width",this.width).attr("height",this.height).css("z-index",a.ZINDEX);this.displayConjq=$("<div>").addClass("JS9Container").css("z-index",a.ZINDEX).attr("tabindex","0").append(this.canvasjq).appendTo(this.divjq);a.globalOpts.resizeHandle&&window.hasOwnProperty("ResizeSensor")&&(this.divjq.css("resize","both").css("overflow",
"hidden"),a.bugs.webkit_resize&&(this.owidth=parseInt(this.divjq.css("width"),10),this.oheight=parseInt(this.divjq.css("height"),10),this.divjq.css("width",this.width+a.RESIZEFUDGE).css("height",this.height+a.RESIZEFUDGE)),this.resizeSensor=new ResizeSensor(this.divjq,function(){var d=b.divjq.width(),e=b.divjq.height();a.bugs.webkit_resize&&(d-=a.RESIZEFUDGE,e-=a.RESIZEFUDGE);b.resize(d,e)}));this.context=this.canvas.getContext("2d");a.ANTIALIAS||(this.context.imageSmoothingEnabled=!1,this.context.mozImageSmoothingEnabled=
!1,this.context.webkitImageSmoothingEnabled=!1,this.context.msImageSmoothingEnabled=!1);this.tooltip=$("<div>").attr("id","tooltip_"+this.id).addClass("JS9Tooltip").appendTo(this.divjq);this.image=null;this.pluginInstances={};this.layers={};this.initMessages();this.blendMode=!1;this.mouseActions=a.globalOpts.mouseActions.slice(0);this.touchActions=a.globalOpts.touchActions.slice(0);this.keyboardActions=$.extend(!0,{},a.globalOpts.keyboardActions);this.mousetouchZoom=a.globalOpts.mousetouchZoom;this.divjq.on("mouseover",
this,function(d){return a.mouseOverCB(d)});this.divjq.on("mousedown touchstart",this,function(d){return a.mouseDownCB(d)});this.divjq.on("mousemove touchmove",this,function(d){return a.mouseMoveCB(d)});this.divjq.on("mouseup touchend",this,function(d){return a.mouseUpCB(d)});this.divjq.on("mouseout",this,function(d){return a.mouseOutCB(d)});this.divjq.on("keypress",this,function(d){return a.keyPressCB(d)});this.divjq.on("keydown",this,function(d){return a.keyDownCB(d)});this.divjq.on("wheel",this,
function(d){return a.wheelCB(d)});this.divjq.on("dragenter",this,function(d){return a.dragenterCB(this.id,d)});this.divjq.on("dragover",this,function(d){return a.dragoverCB(this.id,d)});this.divjq.on("dragexit",this,function(d){return a.dragexitCB(this.id,d)});this.divjq.on("drop",this,function(d){return a.dragdropCB(this.id,d,a.NewFITSImage)});this.divjq.on("contextmenu",this,function(){return!1});this.divjq.append('<div style="visibility:hidden; position:relative; top:-50;left:-50"> <input type="file" id="openLocalFile-'+
this.id+'" multiple="true" onchange="javascript:for(var i=0; i<this.files.length; i++){JS9.Load(this.files[i], {display:\''+this.id+"'});};this.value=null;return false;\"> </div>");this.divjq.append('<div style="visibility:hidden; position:relative; top:-50;left:-50"> <input type="file" id="refreshLocalFile-'+this.id+'" multiple="true" onchange="javascript:for(var i=0; i<this.files.length; i++){JS9.RefreshImage(this.files[i], {display:\''+this.id+"'});};this.value=null;return false;\"> </div>");this.divjq.append('<div style="visibility:hidden; position:relative; top:-50;left:-50"> <input type="file" id="openLocalRegions-'+
this.id+'" multiple="true" onchange="javascript:for(var i=0; i<this.files.length; i++){JS9.LoadRegions(this.files[i], {display:\''+this.id+"'}); };this.value=null;return false;\"> </div>");this.divjq.append('<div style="visibility:hidden; position:relative; top:-50;left:-50"> <input type="file" id="openLocalSession-'+this.id+'" multiple="true" onchange="javascript:for(var i=0; i<this.files.length; i++){JS9.LoadSession(this.files[i], {display:\''+this.id+"'});};this.value=null;return false;\"> </div>");
this.divjq.append('<div style="visibility:hidden; position:relative; top:-50;left:-50"> <input type="file" id="openLocalColormap-'+this.id+'" multiple="true" onchange="javascript:for(var i=0; i<this.files.length; i++){JS9.AddColormap(this.files[i], {display:\''+this.id+"'});};this.value=null;return false;\"> </div>");a.displays.push(this);a.DEBUG&&a.log("JS9 display:  %s",this.id)};a.Display.prototype.initMessages=function(){this.messageContainer=$("<div>").addClass("JS9Container").css("z-index",
a.MESSZINDEX).appendTo(this.divjq);this.infoArea=$("<div>").addClass("JS9Message").appendTo(this.messageContainer);this.regionsArea=$("<div>").addClass("JS9Message").appendTo(this.messageContainer);return this};a.Display.prototype.displayPlugin=function(d){var b,c,e,f,g,h,j,k;h=this.pluginInstances[d.name];switch(a.globalOpts.winType){case "light":b=a.lightOpts[a.LIGHTWIN];if(!h||!h.status){if(c=d.name.replace(/\s/g,"_"),e=this.id+"_"+c+"_lightDiv",f=this.id+"_"+c+"_outerDiv",c=this.id+"_"+c+"_innerDiv",
h||(g=$("<div>").attr("id",f).css("display","none").appendTo($(this.divjq)),$("<div>").addClass(d.name).attr("id",c).attr("data-js9id",this.divjq.attr("id")).css("height","100%").css("width","100%").appendTo(g)),g=d.opts.winDims[0]||a.WIDTH,j=d.opts.winDims[1]||a.HEIGHT,k=d.opts.winResize?"1":"0",b=sprintf(b.format,g,j,k),g=d.opts.toolbarHTML&&0<=d.opts.toolbarHTML.search(/\$title/)?"":d.opts.winTitle||"",g+=sprintf(a.IDFMT,this.id),f=a.lightWin(e,"div",f,g,b),e=$("#"+e+" #"+c),h=a.instantiatePlugin(e,
d,f),h.winHandle.onclose=function(){h.winHandle.hide();h.status="inactive";return!1},h.status="active",d.opts.onplugindisplay)try{d.opts.onplugindisplay.call(h,this.image)}catch(m){a.log("onplugindisplayCB: %s [%s]\n%s",d.name,m.message,a.strace(m))}}else if("inactive"===h.status){if(h.winHandle&&(h.winHandle.show(),h.status="active",d.opts.onplugindisplay))try{d.opts.onplugindisplay.call(h,this.image)}catch(n){a.log("onplugindisplayCB: %s [%s]\n%s",d.name,n.message,a.strace(n))}}else"active"===h.status&&
h.winHandle&&(h.winHandle.hide(),h.status="inactive");break;case "new":a.error("external window support for plugins not yet implemented")}};a.Display.prototype.resize=function(d,b,c){var e,f,g,h,j=function(a){a.left+=g;a.top+=h;a.setCoords()};a.globalOpts.resize||a.error("display resize not enabled");if(!d&&!b)return{width:this.width,height:this.height};"full"===d?(c=b,d=window.innerWidth||d,b=window.innerHeight||b):"reset"===d&&(c=b,d=this.width0||d,b=this.height0||b);d=Math.floor(d);b=b?Math.floor(b):
d;(10>d||10>b)&&a.error("invalid dimension(s) passed to display resize");if(d===this.width&&b===this.height)return this;c=c||{};e=b;g=(d-this.width)/2;h=(e-this.height)/2;this.width=d;this.height=e;this.divjq.css("width",d);this.divjq.css("height",e);this.canvasjq.attr("width",d);this.canvasjq.attr("height",e);a.bugs.webkit_resize&&!this.resizing&&(this.owidth=Math.min(this.owidth,d),this.oheight=Math.min(this.oheight,e));if(void 0===c.resizeMenubar||c.resizeMenubar)(b=this.pluginInstances.JS9Menubar)&&
$("#"+this.id+"Menubar").css("width",d);if(void 0===c.resizeColorbar||c.resizeColorbar)if(b=this.pluginInstances.JS9Colorbar)b.divjq.html(""),a.Colorbar.init.call(b,d,e);for(f in this.layers)this.layers.hasOwnProperty(f)&&(b=this.layers[f],"main"===b.dtype&&(b.divjq.css("width",d),b.divjq.css("height",e),b.canvasjq.attr("width",d),b.canvasjq.attr("height",e),b.canvas.setWidth(d),b.canvas.setHeight(e),b.canvas.calcOffset()));for(d=0;d<a.images.length;d++)if(e=a.images[d],e.mkSection(),e.display&&this===
e.display&&(e.resize?(e.resize.left+=g,e.resize.top+=h):e.resize={left:g,top:h},e===e.display.image))for(f in e.layers)e.layers.hasOwnProperty(f)&&(b=e.layers[f],"main"===b.dlayer.type&&!b.json&&(b.canvas.getObjects().forEach(j),b.canvas.renderAll()));a.bugs.webkit_resize&&this.divjq.css("width",this.width+a.RESIZEFUDGE).css("height",this.height+a.RESIZEFUDGE);if(this.image&&(a.globalOpts.resizeRedisplay||!this.resizing))this.image.displayImage("all",c),this.image.refreshLayers();c.center&&this.center();
return this};a.Display.prototype.inResize=function(d){return a.globalOpts.resizeHandle&&d.x+a.RESIZEDIST>=this.divjq.width()&&d.y+a.RESIZEDIST>=this.divjq.height()?!0:!1};a.Display.prototype.center=function(){var a=this.divjq,b,c;b=a.offset().top;var e=a.height(),f=$(window).height();c=a.offset().left;var a=a.width(),g=$(window).width();b=e<f?b-(f/2-e/2):b;c=a<g?c-(g/2-a/2):c;$("html, body").animate({scrollTop:b,scrollLeft:c},250);return this};a.Display.prototype.nextImage=function(d){var b,c;d=d||
1;if(this.image){for(b=0;b<a.images.length&&this.image!==a.images[b];b++);for(c=b+1;c!==b&&!(c>=a.images.length&&(c=0),a.images[c].display===this);c+=d);b!==c&&(d=a.images[c],d.displayImage("all"),d.refreshLayers(),d.clearMessage());return this}};a.Display.prototype.loadSession=function(d){var b=this,c,e=function(a){var d,e,f,m=function(){a.refreshLayers()};if(c.layers&&c.layers.length)for(d=0;d<c.layers.length;d++)f=c.layers[d],e=b.newShapeLayer(f.name,f.dopts),a.addShapes(f.name,[]),e.canvas.loadFromJSON(f.json,
m)},f=function(d){d.file||a.error("session does not contain a filename");c=d;c.params.onload=e;c.params.display&&delete c.params.display;a.Load(c.file,c.params,{display:b.id})};a.waiting(!0,this.divjq[0]);"object"===typeof d?f(d):$.ajax({url:d,cache:!1,dataType:"json",mimeType:"application/json",async:!1,success:function(a){f(a)},error:function(b,c,e){a.error("could not load session: "+d,e)}});return this};a.Command=function(d){for(var b in d)d.hasOwnProperty(b)&&(this[b]=d[b]);d.name||a.error("command has no name");
!d.get&&!d.set&&a.error("command requires get and/or set routine");a.commands.push(this);1<a.DEBUG&&a.log("JS9 command:  %s",this.name)};a.Command.prototype.getDisplayInfo=function(a){a&&a.id&&(this.display=a,this.image=a.image);return this};a.Command.prototype.getWhich=function(a){return this.get&&!this.set?"get":this.set&&!this.get?"set":this.which?this.which(a):0===a.length?"get":"set"};a.Helper=function(){this.helper=this.connected=!1;this.type=a.globalOpts.helperType||"sock.io";this.pageid=null;
this.connect()};a.Helper.prototype.connectinfo=function(){var d;return null===a.helper.connected?"notConfigured":a.helper.connected?(d=sprintf("connected %s %s",a.helper.type,a.helper.url),a.helper.pageid&&(d+="<p>"+a.helper.pageid),d):sprintf("notConnected %s",a.helper.type)};a.Helper.prototype.connect=function(d){var b=this;d&&(this.type=d);if(this.socket){try{this.socket.disconnect()}catch(c){a.log("warning: can't disconnect from socket")}this.socket=null}this.url=a.globalOpts.helperURL?0<=a.globalOpts.helperURL.search(/:\/\//)?
a.globalOpts.helperURL:a.globalOpts.helperProtocol+a.globalOpts.helperURL:document.domain?a.globalOpts.helperProtocol+document.domain:a.globalOpts.helperProtocol+"localhost";switch(this.type){case "none":this.connected=null;$(document).trigger("JS9:ready",{type:"none",status:"OK"});a.Preload(!0);break;case "get":case "post":a.globalOpts.helperCGI||a.error("cgi script name missing for helper");this.url+="/"+a.globalOpts.helperCGI;this.helper=this.connected=!0;a.DEBUG&&a.log("JS9 helper: connect: "+
this.type);$(document).trigger("JS9:ready",{type:"get",status:"OK"});a.Preload(!0);break;case "sock.io":case "nodejs":a.globalOpts.helperPort||a.error("port missing for helper");this.url+=":"+a.globalOpts.helperPort;this.sockurl=this.url+"/socket.io/socket.io.js";$.ajax({url:this.sockurl,dataType:"script",timeout:a.globalOpts.htimeout,success:function(){var d,c;b.socket=io.connect(b.url,{reconnection:!0,reconnectionDelay:1E4,reconnectionDelayMax:1E4,reconnectionAttempts:6,timeout:a.globalOpts.htimeout});
b.socket.on("connect",function(){b.connected=!0;b.helper=!0;c=[];for(d=0;d<a.displays.length;d++)c.push(a.displays[d].id);b.socket.emit("displays",{displays:c},function(a){b.pageid=a});$(document).trigger("JS9:ready",{type:"socket.io",status:"OK"});a.Preload(!0);a.DEBUG&&a.log("JS9 helper: connect: "+b.type)});b.socket.on("connect_error",function(){b.connected=!1;b.helper=!1;a.Preload(!0);1<a.DEBUG&&a.log("JS9 helper: connect error")});b.socket.on("connect_timeout",function(){b.connected=!1;b.helper=
!1;a.Preload(!0);1<a.DEBUG&&a.log("JS9 helper: connect timeout")});b.socket.on("disconnect",function(){b.connected=!1;b.helper=!1;1<a.DEBUG&&a.log("JS9 helper: disconnect")});b.socket.on("reconnect",function(){b.connected=!0;b.helper=!0;1<a.DEBUG&&a.log("JS9 helper: reconnect")});b.socket.on("msg",a.msgHandler)},error:function(d,c,g){b.connected=!1;b.helper=!1;$(document).trigger("JS9:ready",{type:"socket.io",status:"error"});a.Preload(!0);a.DEBUG&&a.log("JS9 helper: connect failure: "+c+" "+g)}});
break;default:a.error("unknown helper type: "+this.type)}};a.Helper.prototype.send=function(d,b,c){if(!this.connected)return null;b&&"object"===typeof b?(b.cookie=document.cookie,a.globalOpts.dataPath&&!b.dataPath&&(b.dataPath=a.globalOpts.dataPath+":.")):b={dataPath:"."};a.TOROOT&&(b.dataPath+=":"+a.TOROOT);switch(this.type){case "get":case "post":b.key=d;a.DEBUG&&a.log("JS9 cgi helper [%s, %s]: %s",this.type,JSON.stringify(b),this.url);$.ajax({url:this.url,type:this.type.toUpperCase(),data:b,dataType:"text",
success:function(d){"string"===typeof d&&0<=d.search(a.analOpts.epattern)&&a.log(d);c&&c(d)},error:function(d,b,c){a.DEBUG&&a.log("JS9 helper: "+this.type+" failure: "+b+" "+c)}});break;case "sock.io":case "nodejs":a.helper.socket.emit(d,b,c)}return this};a.Fabric={};a.Fabric.elements="cornerSize cornerColor borderColor transparentCorners selectionLineWidth centeredScaling hasControls hasRotatingPoint hasBorders params pub".split(" ");a.Fabric.opts={originX:"center",originY:"center",strokeWidth:2,
selectionLineWidth:2,borderColor:"#00FF00",cornerColor:"#00FF00",cornerSize:fabric.isTouchSupported?12:8,hasControls:!0,hasRotatingPoint:!0,hasBorders:!0,transparentCorners:!1,centeredScaling:!0,selectable:!0,padding:0,canvas:{selection:!0,zindex:a.SHAPEZINDEX},fill:"transparent"};a.Fabric.rescaleStrokeWidth=function(d,b){var c=(this.scaleX+this.scaleY)/2;d=d||1;d*=c;!b&&this.params&&(b=this.params.sw1);b&&("group"===this.type?this.forEachObject(function(c){a.Fabric.rescaleStrokeWidth.call(c,d,b)}):
this.setStrokeWidth(b/d))};a.Fabric.rescaleEvenly=function(){var a;if(this.params&&this.scaleX!==this.scaleY)switch(this.params.shape){case "annulus":case "circle":a=this.params.lastscale||1,this.scaleX!==a?this.scaleY=this.scaleX:this.scaleY!==a&&(this.scaleX=this.scaleY),this.params.lastscale=this.scaleX}};fabric.Object.prototype.rescaleBorder=a.Fabric.rescaleStrokeWidth;fabric.Object.prototype.rescaleEvenly=a.Fabric.rescaleEvenly;a.Fabric.newShapeLayer=function(d,b,c){var e,f;if(this&&d){if(this.layers[d])return this.layers[d];
this.layers[d]={};f=this.layers[d];f.params=[];f.params.sel=null;f.params.sellayer=null;c?f.dtype="other":(f.dtype="main",c=this.divjq);e=c.attr("id")+"-"+d.replace(/\s+/,"_")+"-shapeLayer";f.display=this;f.opts=$.extend(!0,{},b);f.opts.canvas=f.opts.canvas||{};void 0===f.opts.canvas.selection&&(f.opts.canvas.selection=!0);f.opts.canvas.zindex=f.opts.canvas.zindex||a.SHAPEZINDEX;f.el=a.Fabric.elements;f.divjq=$("<div>").addClass("JS9Container").css("z-index",0).appendTo(c);f.canvasjq=$("<canvas>").addClass("JS9Layer").attr("id",
e).attr("width",c.css("width")).attr("height",c.css("height")).appendTo(f.divjq);a.bugs.webkit_resize&&"main"===f.dtype&&f.canvasjq.attr("width",this.width).attr("height",this.height);f.canvas=new fabric.Canvas(f.canvasjq[0]);f.canvas.renderOnAddRemove=!1;f.opts.movable&&(f.opts.hasControls=!0,f.opts.hasRotatingPoint=!0,f.opts.hasBorders=!0,f.opts.lockMovementX=!1,f.opts.lockMovementY=!1,f.opts.lockRotation=!1,f.opts.lockScalingX=!1,f.opts.lockScalingY=!1,f.opts.lockUniScaling=!1,f.opts.selectable=
!0,f.opts.evented=!0,f.opts.usekeyboard=!0);f.opts.selectable&&(f.opts.canvas.selection=!0);if(f.opts.onmousedown||f.opts.onmouseup||f.opts.onmousemove||f.opts.tooltip||f.opts.onmouseover||f.opts.onmouseout){f.opts.evented=!0;if(f.opts.onmousedown)f.canvas.on("mouse:down",function(d){if(f.display.image&&d.target)"main"===f.dtype&&(f.display.image.clickInRegion=!0),f.opts.onmousedown.call(this,f.display.image,d.target.pub,d.e,d.target);else if(this._selection=this.selection)this.selection=a.specialKey(d.e)});
else f.canvas.on("mouse:down",function(d){if(this._selection=this.selection)this.selection=a.specialKey(d.e)});if(f.opts.onmouseup)f.canvas.on("mouse:up",function(a){f.display.image&&a.target&&f.opts.onmouseup.call(this,f.display.image,a.target.pub,a.e,a.target);this.selection=this._selection||this.selection});else f.canvas.on("mouse:up",function(){this.selection=this._selection||this.selection});if(f.opts.onmousemove)f.canvas.on("mouse:move",function(a){f.display.image&&a.target&&f.opts.onmousemove.call(this,
f.display.image,a.target.pub,a.e,a.target)});if(f.opts.onmouseover)f.canvas.on("mouse:over",function(a){f.display.image&&a.target&&f.opts.onmouseover.call(this,f.display.image,a.target.pub,a.e,a.target)});if(f.opts.onmouseout)f.canvas.on("mouse:out",function(a){f.display.image&&a.target&&f.opts.onmouseout.call(this,f.display.image,a.target.pub,a.e,a.target)});f.opts.tooltip&&(f.canvas.on("mouse:over",function(d){f.display.image&&d.target&&a.tooltip(d.target.left,d.target.top,f.opts.tooltip,f.display.image,
d.target.pub,d.e,d.target)}),f.canvas.on("mouse:out",function(d){f.display.image&&d.target&&a.tooltip(d.target.left,d.target.top,null,f.display.image,d.target.pub,d.e,d.target)}))}else f.canvas.on("mouse:down",function(d){if(this._selection=this.selection)this.selection=a.specialKey(d.e)}),f.canvas.on("mouse:up",function(){this.selection=this._selection||this.selection});if(f.opts.ongroupcreate&&(f.opts.canvas.selection=!0,f.opts.selectable=!0,f.opts.ongroupcreate))f.canvas.on("selection:created",
function(a){var d=[],b=[];f.display.image&&"group"===a.target.type&&(a.target.forEachObject(function(a){a.pub&&(b.push(a),d.push(a.pub))}),f.opts.ongroupcreate.call(this,f.display.image,d,a.e,b))});f.canvas.on("object:scaling",function(a){a.target.rescaleEvenly();a.target.rescaleBorder()});f.canvas.on("object:selected",function(b){f.params.sel&&(b.target.params&&f.params.sel!==b.target)&&f.canvas.fire("before:selection:cleared",{target:f.params.sel});switch(b.target.type){case "polyline":case "polygon":a.Fabric.addPolygonAnchors(f,
b.target),f.canvas.renderAll()}b.target.polyparams?f.params.sel=b.target.polyparams.polygon:b.target.params&&(f.params.sel=b.target);f.display.image&&(f.display.image.layer=d)});f.canvas.on("before:selection:cleared",function(d){f.params.sel=null;f.display.image&&(f.display.image.layer=null);switch(d.target.type){case "polyline":case "polygon":a.Fabric.removePolygonAnchors(f,d.target),f.canvas.renderAll()}});if(f.divjq.closest(a.lightOpts[a.LIGHTWIN].drag).length)if(fabric.isTouchSupported)f.divjq.on("touchstart",
function(){f.canvas.calcOffset()});else f.divjq.on("mouseenter",function(){f.canvas.calcOffset()});return f}};a.Fabric.showShapeLayer=function(d,b){var c=this,e=0,f,g,h,j;if(g=this.getShapeLayer(d)){j=g.canvas;h=this.display.layers[d];if("show"===b||!0===b){"show"===b&&(g.show=!0);g.json&&g.show&&j.loadFromJSON(g.json,function(){var b,e,f,q;c.resize&&(j.getObjects().forEach(function(a){a.left+=c.resize.left;a.top+=c.resize.top;a.setCoords()}),j.calcOffset());j.renderAll();j.selection=g.opts.canvas.selection;
e=h.opts.canvas.zindex;h.divjq.css("z-index",e);for(b in c.layers)if(c.layers.hasOwnProperty(b)&&(d!==b&&c.layers[b].show)&&(f=c.display.layers[b],f.divjq.css("z-index")<e&&(q=f.canvas.getActiveObject())))a.Fabric.removePolygonAnchors(f,q),f.canvas.discardActiveObject()});for(f in this.layers)this.layers.hasOwnProperty(f)&&this.layers[f].json&&e++;e||(this.resize=null)}else if("hide"===b||!1===b)g.show&&(j.forEachObject(function(d){a.Fabric.removePolygonAnchors(h,d);d.params&&d.params.winid&&(d.params.winid.close(),
d.params.winid=null)}),e=j.toJSON(g.dlayer.el),g.json=JSON.stringify(e),j.selection=!1,h&&h.divjq.css("z-index",0),j.clear()),"hide"===b&&(g.show=!1);return this}};a.Fabric.displayShapeLayers=function(){var a;if(this!==this.display.image){if(this.display.image&&this.display.image.layers)for(a in this.display.image.layers)this.display.image.layers.hasOwnProperty(a)&&this.display.image.showShapeLayer(a,!1);if(this.layers)for(a in this.layers)this.layers.hasOwnProperty(a)&&this.showShapeLayer(a,!0)}};
a.Fabric.getShapeLayer=function(a){var b,c;if(!a)return null;c=this.layers[a];if(!c){b=this.display.layers[a];if(!b)return null;this.layers[a]={};c=this.layers[a];c.show=!0;c.nshape=0;c.dlayer=b;c.opts=c.dlayer.opts;c.canvas=c.dlayer.canvas;c.canvas.calcOffset()}return c};a.Fabric._parseShapeOptions=function(d,b,c){var e,f,g,h,j,k,m,n={},q={};h="main"===this.display.layers[d].dtype?this.rgb.sect.zoom:1;j=h/("main"===this.display.layers[d].dtype?this.binning.bin||1:1);if(b.remove)return{remove:b.remove};
q.tags=[];if(b.tags)if("string"===typeof b.tags){f=b.tags.toLowerCase().split(",");for(d=0;d<f.length;d++)q.tags[d]=f[d].trim()}else if($.isArray(b.tags))for(d=0;d<b.tags.length;d++)q.tags[d]=b.tags[d].trim();void 0!==b.angle&&(n.angle=-b.angle);void 0!==b.x&&void 0!==b.y&&(e=this.imageToDisplayPos(b),n.left=e.x,n.top=e.y);void 0!==b.left&&(n.left=b.left);void 0!==b.top&&(n.top=b.top);void 0===n.left&&(n.left=c&&void 0!==c.left?c.left:this.display.canvasjq.attr("width")/2-1);void 0===n.top&&(n.top=
c&&void 0!==c.top?c.top:this.display.canvasjq.attr("height")/2-1+1);b.dx&&(n.left+=b.dx);b.dy&&(n.top-=b.dy);switch(b.shape){case "annulus":q.radii=[];if(void 0!==b.radii)if("string"===typeof b.radii){q.radii=b.radii.replace(/ /g,"").split(",");for(e=d=0;d<q.radii.length;d++)""!==q.radii[d]&&(q.radii[e++]=parseInt(q.radii[d],10))}else q.radii=b.radii;else{b.ireg&&a.SCALEIREG&&(b.iradius&&(b.iradius/=j),b.oradius&&(b.oradius/=j));h=(b.oradius-b.iradius)/b.nannuli;j=b.nannuli+1;for(d=0;d<j;d++)f=b.iradius+
h*d,q.radii.push(f)}break;case "box":b.ireg&&a.SCALEIREG&&(b.width&&(b.width/=j),b.height&&(b.height/=j));break;case "circle":b.ireg&&a.SCALEIREG&&b.radius&&(b.radius/=j);break;case "ellipse":b.ireg&&a.SCALEIREG&&(b.r1&&(b.r1/=j),b.r2&&(b.r2/=j));break;case "point":switch(b.ptshape){case "box":b.width=2*b.ptsize;b.height=2*b.ptsize;break;case "circle":b.radius=b.ptsize;break;case "ellipse":b.rx=b.ptsize,b.ry=b.ptsize/2}b.lockRotation=!0;b.lockScalingX=!0;b.lockScalingY=!0;b.lockUniScaling=!0;b.hasControls=
!1;b.hasRotatingPoint=!1;b.hasBorders=!0;break;case "line":case "polygon":if(b.pts&&b.pts.length){if("string"===typeof b.pts){g=b.pts.replace(/ /g,"").split(",");f=g.length;if("string"===typeof g[0])for(d=0;d<f;d++)g[d]=parseFloat(g[d]);b.pts=[];for(e=d=0;d<f;d+=2,e++)b.pts[e]={x:g[d],y:g[d+1]}}f=b.pts.length;for(d=0;d<f;d++)b.pts[d]=this.imageToDisplayPos(b.pts[d]);b.left&&b.top?g={x:b.left,y:b.top}:(g=a.centerPolygon(b.pts),n.left=g.x,n.top=g.y);b.points=[];for(d=0;d<f;d++)e={x:(b.pts[d].x-g.x)/
h,y:(b.pts[d].y-g.y)/h},b.points.push(e)}else"polygon"===b.shape&&b.polypoints?b.points=b.polypoints:"line"===b.shape&&b.linepoints&&(b.points=b.linepoints);if(b.ireg&&a.SCALEIREG){f=b.points.length;for(d=0;d<f;d++)b.points[d].x/=j,b.points[d].y/=j}}for(k in b)if(b.hasOwnProperty(k))switch(k){case "tags":case "x":case "y":case "dx":case "dy":case "pts":case "left":case "top":case "angle":case "radii":case "ireg":break;case "type":case "originX":case "originY":case "width":case "height":case "scaleX":case "scaleY":case "flipX":case "flipY":case "opacity":case "cornerSize":case "transparentCorners":case "hoverCursor":case "padding":case "borderColor":case "cornerColor":case "centeredScaling":case "centeredRotation":case "fill":case "fillRule":case "backgroundColor":case "stroke":case "strokeWidth":case "strokeDashArray":case "strokeLineCap":case "strokeLineJoin":case "strokeMiterLimit":case "shadow":case "borderOpacityWhenMoving":case "borderScaleFactor":case "transformMatrix":case "minScaleLimit":case "selectable":case "evented":case "visible":case "hasControls":case "hasBorders":case "hasRotatingPoint":case "rotatingPointOffset":case "perPixelTargetFind":case "includeDefaultValues":case "clipTo":case "lockMovementX":case "lockMovementY":case "lockRotation":case "lockScalingX":case "lockScalingY":case "lockUniScaling":case "radius":case "rx":case "ry":case "points":case "selectionLineWidth":case "fontFamily":case "fontSize":case "fontStyle":case "fontWeight":case "text":case "textDecoration":case "textAlign":case "lineHeight":case "textBackgroundColor":n[k]=
b[k];break;case "shape":m=b[k];break;default:q[k]=b[k]}if(!(b=q.color)){b=q.tags;k=q.tagcolors;var l,p;k=k||{};for(l in k)if(k.hasOwnProperty(l)&&(d=l.split("_"),0===$(b).not(d).length&&0===$(d).not(b).length)){p=k[l];break}if(!p)for(l in k)if(k.hasOwnProperty(l)&&(d=l.split("_"),0===$(b).not(d).length)){p=k[l];break}if(!p)for(l in k)if(k.hasOwnProperty(l)&&(d=l.split("_"),0===$(d).not(b).length)){p=k[l];break}b=p=p||c&&c.get("stroke")||k.defcolor||a.globalOpts.defcolor||"#000000"}n.stroke=b;n.selectColor=
n.stroke;n.cornerColor=n.stroke;n.borderColor=n.stroke;void 0!==q.fixinplace&&(c=q.fixinplace,void 0===n.lockMovementX&&(n.lockMovementX=c),void 0===n.lockMovementY&&(n.lockMovementY=c),void 0===n.lockRotation&&(n.lockRotation=c),void 0===n.lockScalingX&&(n.lockScalingX=c),void 0===n.lockScalingY&&(n.lockScalingY=c),void 0===n.hasControls&&(n.hasControls=!c),void 0===n.hasRotatingPoint&&(n.hasRotatingPoint=!c),void 0===n.hasBorders&&(n.hasBorders=!c));return{shape:m,opts:n,params:q}};a.Fabric.addShapes=
function(d,b,c){var e,f,g,h,j,k,m,n,q,l=[],p={};if(this.display.image!==this)this.delayedShapes=this.delayedShapes||[],this.delayedShapes.push({layer:d,shape:b,opts:c});else if((j=this.getShapeLayer(d))&&j.show){k=j.canvas;"main"===this.display.layers[d].dtype?(m=this.rgb.sect.zoom,n=this.binning.bin||1):n=m=1;if("string"===typeof b)e=this.parseRegions(b),b="string"===typeof e?[{shape:e}]:e;else if(!$.isArray(b))if("object"===typeof b)b=[b];else return;if("string"===typeof c)try{g=JSON.parse(c)}catch(r){return a.error("can't parse shape opts: "+
c,r),null}else g=c;k.size()||(c=this.display.layers[d],"regions"===d&&c.opts.canvas.zindex++,c.divjq.css("z-index",c.opts.canvas.zindex));h=$.extend(!0,{},a.Fabric.opts,j.opts,g);for(g=0;g<b.length;g++){c=$.extend(!0,{},h,b[g]);f=a.Fabric._parseShapeOptions.call(this,d,c);if(f.remove){if(!0===f.remove||"true"===f.remove)f.remove="all";if(!1!==f.remove&&"false"!==f.remove){this.removeShapes(d,f.remove);continue}}if(f.shape){c=f.opts;p=f.params;p.id=++j.nshape;switch(f.shape){case "annulus":p.shape=
"annulus";f=c.top;q=c.left;c.top=0;c.left=0;if(p.radii)for(e=0;e<p.radii.length;e++)c.radius=p.radii[e],l.push(new fabric.Circle(c));c.top=f;c.left=q;c.width=2*c.radius;c.height=2*c.radius;e=new fabric.Group(l,c);break;case "box":p.shape="box";e=new fabric.Rect(c);break;case "circle":p.shape="circle";e=new fabric.Circle(c);break;case "ellipse":p.shape="ellipse";c.rx=p.r1;c.ry=p.r2;e=new fabric.Ellipse(c);break;case "point":p.shape="point";switch(p.ptshape){case "box":e=new fabric.Rect(c);break;case "circle":e=
new fabric.Circle(c);break;case "ellipse":e=new fabric.Ellipse(c);break;default:e=new fabric.Rect(c)}break;case "line":p.shape="line";e=new fabric.Polyline(c.points,c);break;case "polygon":p.shape="polygon";e=new fabric.Polygon(c.points,c,!0);break;case "text":p.shape="text";p.text=c.text||"Double-click to add text here";c.fill=c.stroke;c.strokeWidth=0;e=new fabric.Text(p.text,c);break;default:a.error("unknown shape: "+f.shape)}k.add(e);p.layerName=d;p.sw1=e.strokeWidth;p.listonchange=!1;e.params=
p;if(j.opts.panzoom)switch(p.shape){case "point":case "text":break;default:e.scale(m/n)}e.rescaleBorder();a.Fabric._updateShape.call(this,d,e,null,"add",p)}}(void 0===p.redraw||p.redraw)&&k.renderAll();return p.id}};a.Fabric.selectShapes=function(a,b,c){var e,f,g,h,j=this;if(!this.layers||!a||!this.layers[a])return null;b=b||"all";a=this.layers[a].canvas;f=a.getActiveGroup();g={group:null};switch(typeof b){case "object":b.params&&(g.group=f&&f.contains(b)?f:null,c.call(j,b,g));break;case "number":a.forEachObject(function(a){a.params&&
b===a.params.id&&(g.group=f&&f.contains(a)?f:null,c.call(j,a,g))});break;case "string":h=b.toLowerCase().replace("box","rect"),"selected"===b?a.getActiveObject()?(a=a.getActiveObject(),a.params&&(g.group=null,c.call(j,a,g))):f&&(g.group=f,f.forEachObject(function(a){a.params&&c.call(j,a,g)})):a.forEachObject(function(a){if(a.params)if(g.group=f&&f.contains(a)?f:null,"all"===b)c.call(j,a,g);else if(b===a.stroke)c.call(j,a,g);else if(h===a.type)c.call(j,a,g);else if(a.params.tags)for(e=0;e<a.params.tags.length;e++)b===
a.params.tags[e]&&c.call(j,a,g)})}return this};a.Fabric.updateShapes=function(d,b,c,e){var f=this;this.selectShapes(d,b,function(b,h){a.Fabric._updateShape.call(f,d,b,h,c,e)});return this};a.Fabric._updateShape=function(d,b,c,e,f){var g,h,j,k,m,n,q,l={},p=this.layers[d],r=function(a){return a.toFixed(1)};c=c||{};f=f||{};h="main"===this.display.layers[d].dtype?this.rgb.sect.zoom:1;l.mode=e||"update";l.id=b.params.id;l.shape=b.params.shape;l.layer=d;l.color=b.stroke;l.tags=b.params.tags;e=b.getCenterPoint();
c.group&&(m=c.group.getCenterPoint(),e={x:e.x+m.x,y:e.y+m.y});m=this.displayToImagePos(e);l.x=m.x;l.y=m.y;l.imsys="image";l.lcs=this.imageToLogicalPos(m);"image"===this.params.wcssys?(j=l.x,k=l.y):(j=l.lcs.x,k=l.lcs.y,l.imsys=l.lcs.sys);l.angle=-b.angle;c.group&&(l.angle-=c.group.angle);for(;0>l.angle;)l.angle+=360;for(;360<l.angle;)l.angle-=360;q=l.angle;this.raw.wcsinfo&&this.raw.wcsinfo.crot&&(l.angle-=this.raw.wcsinfo.crot);e=1*(b.scaleX/h);h=1*(b.scaleY/h);c.group&&(e*=c.group.scaleX,h*=c.group.scaleY);
switch(l.shape){case "annulus":l.shape="annulus";l.radii=[];l.imstr="annulus("+r(j)+", "+r(k)+", ";g="annulus "+l.x+" "+l.y+" ";n=b.getObjects();q=n.length;for(c=0;c<q;c++)h=n[c].radius*e,l.imstr+=r(h),g+=l.x+" "+l.y+" "+(l.x+h)+" "+l.y+" ",l.imstr=c===q-1?l.imstr+")":l.imstr+", ",l.radii.push(h);break;case "box":l.shape="box";l.width=b.width*e;l.height=b.height*h;l.imstr="box("+r(j)+", "+r(k)+", "+r(l.width)+", "+r(l.height)+", "+l.angle.toFixed(4)+")";g="box "+l.x+" "+l.y+" "+l.x+" "+l.y+" "+(l.x+
l.width)+" "+l.y+" "+l.x+" "+l.y+" "+l.x+" "+(l.y+l.height)+" "+l.angle*Math.PI/180;break;case "circle":l.radius=b.radius*e;l.imstr="circle("+r(j)+", "+r(k)+", "+r(l.radius)+")";g="circle "+l.x+" "+l.y+" "+l.x+" "+l.y+" "+(l.x+l.radius)+" "+l.y;break;case "ellipse":l.r1=b.width*e/2;l.r2=b.height*h/2;l.imstr="ellipse("+r(j)+", "+r(k)+", "+r(l.r1)+", "+r(l.r2)+", "+l.angle.toFixed(4)+")";g="ellipse "+l.x+" "+l.y+" "+l.x+" "+l.y+" "+(l.x+l.r1)+" "+l.y+" "+l.x+" "+l.y+" "+l.x+" "+(l.y+l.r2)+" "+l.angle*
Math.PI/180;break;case "point":l.width=b.width*e;l.height=b.height*h;l.imstr="point("+r(j)+", "+r(k)+")";g="point "+l.x+" "+l.y;break;case "line":case "polygon":l.imstr=l.shape+"(";g=l.shape+" ";l.pts=[];for(c=0;c<b.points.length;c++)0<c&&(l.imstr+=", ",g+=" "),j={x:l.x+b.points[c].x*e,y:l.y-b.points[c].y*h},j=a.rotatePoint(j,q,{x:l.x,y:l.y}),"image"===this.params.wcssys?l.imstr+=r(j.x)+", "+r(j.y):(k=this.imageToLogicalPos(j),l.imstr+=r(k.x)+", "+r(k.y)),g+=j.x+" "+j.y,l.pts.push(j),"line"===l.shape&&
(0===c?n=0:(k=l.pts[c-1],n+=Math.sqrt((j.x-k.x)*(j.x-k.x)+(j.y-k.y)*(j.y-k.y))));l.imstr="line"===l.shape?l.imstr+(') {"size":'+r(n)+',"units":"pixels"}'):l.imstr+")";break;case "text":l.imstr="text("+r(j)+", "+r(k)+', "'+b.text+'")',l.text=b.text,g="text "+l.x+" "+l.y+' "'+b.text+'"'}if(this.raw.wcs&&0<this.raw.wcs){if("regions"===d&&!1!==f.dowcsstr||"regions"!==d&&!0===f.dowcsstr)l.wcsstr=a.reg2wcs(this.raw.wcs,g).replace(/;$/,"");g=a.pix2wcs(this.raw.wcs,m.x,m.y).trim().split(/\s+/);l.ra=g[0];
l.dec=g[1];l.wcssys=g[2]}l.data=b.params.data;b.set("pub",l);b.params.winid&&($(b.params.winid).is(":visible")?a.Regions.initConfigForm.call(this,b):b.params.winid=null);if(f.nocb)return l;if("regions"===d&&this.params.xeqonchange&&p.show&&this.onregionschange)try{this.params.xeqonchange=!1,a.xeqByName(this.onregionschange,window,this,l)}catch(s){a.log("error in xeqonchange: %s [%s]\n%s",this.id,s.message,a.strace(s))}finally{this.params.xeqonchange=!0}if(this.params.xeqonchange&&p.show&&p.opts.onchange)try{this.params.xeqonchange=
!1,a.xeqByName(p.opts.onchange,window,this,l)}catch(t){a.log("error in onchange: %s [%s]\n%s",this.id,t.message,a.strace(t))}finally{this.params.xeqonchange=!0}this.xeqPlugins("shape","on"+d+"change",l);return l};a.Fabric.removeShapes=function(d,b){var c=this,e,f;if(e=this.getShapeLayer(d))return f=e.canvas,this.selectShapes(d,b,function(b,e){a.Fabric._updateShape.call(c,d,b,e,"remove");e&&e.group&&e.group.remove(b);b.params&&b.params.winid&&b.params.winid.close();f.remove(b)}),f.getActiveGroup()&&
f.discardActiveGroup(),f.renderAll(),this};a.Fabric.getShapes=function(a,b){var c=[];this.selectShapes(a,b,function(a){c.push(a.pub||{})});return c};a.Fabric.changeShapes=function(d,b,c){var e,f,g,h,j,k,m,n,q,l,p,r,s=this;if((j=this.getShapeLayer(d))&&c)return k=j.canvas,"main"===this.display.layers[d].dtype?(p=this.rgb.sect.zoom,r=this.binning.bin||1):r=p=1,m=k.getActiveObject(),this.selectShapes(d,b,function(b,w){h=$.extend(!0,{},b.params,c);g=a.Fabric._parseShapeOptions.call(this,d,h,b);if(g.remove){if(!0===
g.remove||"true"===g.remove)g.remove="all";if(!1!==g.remove&&"false"!==g.remove){this.removeShapes(d,g.remove||"all");return}}switch(b.params.shape){case "text":g.opts.stroke&&(g.opts.fill=g.opts.stroke),g.opts.strokeWidth=0}b.set(g.opts);b.params=$.extend(!1,{},b.params,g.params);switch(b.params.shape){case "annulus":if(c.radii&&c.radii.length){q=b.get("stroke");b.forEachObject(function(a){b.remove(a);k.remove(a)});n=b.params.radii.length;for(e=l=0;e<n;e++)f=new fabric.Circle({radius:b.params.radii[e],
stroke:q}),l=Math.max(l,b.params.radii[e]),b.add(f);b.scaleX=p/r;b.scaleY=p/r;b.width=2*l;b.height=2*l;m===b&&k.setActiveObject(b)}break;case "box":c.width&&(b.scaleX=p/r);c.height&&(b.scaleY=p/r);break;case "circle":c.radius&&(b.scaleX=p/r,b.scaleY=p/r);break;case "ellipse":c.r1&&(b.rx=c.r1,b.scaleX=p/r,b.width=2*b.rx);c.r2&&(b.ry=c.r2,b.scaleY=p/r,b.height=2*b.ry);break;case "line":case "polygon":c.points&&c.points.length&&(b.scaleX=p/r,b.scaleY=p/r),m===b&&(a.Fabric.removePolygonAnchors(j.dlayer,
b),a.Fabric.addPolygonAnchors(j.dlayer,b)),a.resetPolygonCenter(b)}b.rescaleBorder();b.setCoords();a.Fabric._updateShape.call(s,d,b,w,"update")}),(void 0===c.redraw||c.redraw)&&k.renderAll(),this};a.Fabric.refreshShapes=function(d){var b,c,e,f,g,h,j,k,m,n=!1,q=this;if(m=this.getShapeLayer(d))return"main"===this.display.layers[d].dtype&&(n=!0),n?(e=this.binning.bin,f=this.rgb.sect.zoom,g=this.binning.obin/this.rgb.sect.ozoom*f/e,h=this.binning.obin/this.rgb.sect.ozoom*f/e):(e=1,h=g=f=this.rgb.sect.zoom),
e=m.canvas,e.getActiveGroup()&&e.discardActiveGroup(),c=e.getActiveObject(),this.selectShapes(d,"all",function(d){b=q.logicalToDisplayPos(d.pub.lcs);d.setLeft(b.x);d.setTop(b.y);switch(d.params.shape){case "point":case "text":break;default:j=g,k=h,n&&(j*=d.scaleX,k*=d.scaleY),d.scaleX=j,d.scaleY=k,d.rescaleBorder()}d.setCoords();switch(d.type){case "polyline":case "polygon":c===d&&(a.Fabric.removePolygonAnchors(m.dlayer,d),a.Fabric.addPolygonAnchors(m.dlayer,d))}}),n&&(this.binning.obin=this.binning.bin,
this.rgb.sect.ozoom=this.rgb.sect.zoom),e&&e.renderAll(),this};a.Fabric.addPolygonPoint=function(d,b,c){var e,f,g,h,j,k,m,n,q,l={},p,r,s,t,w,u=Number.MAX_VALUE;if(b&&b.points){l=a.eventToDisplayPos(c);c=b.getCenterPoint().x;g=b.getCenterPoint().y;c=(l.x-c)/b.get("scaleX");p=(l.y-g)/b.get("scaleY");for(g=-b.get("angle")*Math.PI/180;g>2*Math.PI;)g-=2*Math.PI;l=Math.cos(g)*c-Math.sin(g)*p;p=Math.sin(g)*c+Math.cos(g)*p;c=b.points;for(g=0;g<c.length;g++)f=c[g],h=c[(g+1)%c.length],j=f.x<h.x?f.x:h.x,k=f.y<
h.y?f.y:h.y,m=f.x>h.x?f.x:h.x,n=f.y>h.y?f.y:h.y,e=f.x-h.x,f=f.y-h.y,q=Math.sqrt(e*e+f*f),0!==q&&(e/=q,f/=q),q=l-h.x,w=p-h.y,q=q*e+w*f,e=h.x+e*q,h=h.y+f*q,e<j?e=j:e>m&&(e=m),h<k?h=k:h>n&&(h=n),j=(e-l)*(e-l)+(h-p)*(h-p),j<u&&(u=j,r=e,s=h,t=g===c.length?0:g);d=this.getShapeLayer(d);a.Fabric.removePolygonAnchors(d.dlayer,b);c.splice(t+1,0,{x:r,y:s});d.canvas.setActiveObject(b)}};a.Fabric.removePolygonPoint=function(d,b){var c,e,f,g;b&&b.polyparams&&(e=b.polyparams.polygon,f=e.points,g=b.polyparams.point,
c=this.getShapeLayer(d),a.Fabric.removePolygonAnchors(c.dlayer,e),f.splice(g,1),a.resetPolygonCenter(e),c.canvas.setActiveObject(e))};a.Fabric.addPolygonAnchors=function(d,b){var c,e,f={},g=d.canvas,h=function(){var b=this.polyparams.polygon,c=this.polyparams.point,e=b.get("points"),h=d.display.image;b.angle?f=a.rotatePoint({x:this.left,y:this.top},-b.angle,{x:b.left,y:b.top}):(f.x=this.left,f.y=this.top);e[c].x=(f.x-b.left)/b.scaleX;e[c].y=(f.y-b.top)/b.scaleY;a.resetPolygonCenter(b);a.Fabric._updateShape.call(h,
b.params.layerName,b,null,"update");h&&(h.params.listonchange||b.params.listonchange)&&h.listRegions(b,2);g.renderAll()},j=function(b){var d,c={};for(d=0;d<b.params.anchors.length;d++)c.x=b.left+b.points[d].x*b.scaleX,c.y=b.top+b.points[d].y*b.scaleY,b.angle&&(c=a.rotatePoint(c,b.angle,{x:b.left,y:b.top})),b.params.anchors[d].set({left:c.x,top:c.y,angle:b.angle}),b.params.anchors[d].setCoords();b._calcDimensions(!0);g.renderAll()};if(!b.params.anchors){b.params.anchors=[];for(c=0;c<b.points.length;c++)f.x=
b.left+b.points[c].x*b.scaleX,f.y=b.top+b.points[c].y*b.scaleY,b.angle&&(f=a.rotatePoint(f,b.angle,b.getCenterPoint())),e=new fabric.Rect({left:f.x,top:f.y,hasControls:!1,hasRotatingPoint:!1,hasBorders:!1,selectable:!0,fill:b.get("stroke"),hoverCursor:"pointer",width:a.Fabric.opts.cornerSize,height:a.Fabric.opts.cornerSize,padding:2}),e.on("moving",h),e.polyparams={},e.polyparams.polygon=b,e.polyparams.point=c,b.params.anchors[c]=e,g.add(e);b.on("moving",function(){j(b)});b.on("rotating",function(){j(b)});
b.on("scaling",function(){j(b)});b.setCoords()}};a.Fabric.removePolygonAnchors=function(a,b){var c,e=a.canvas;if(b.params&&b.params.anchors){for(c=0;c<b.params.anchors.length;c++)e.remove(b.params.anchors[c]);delete b.params.anchors}};a.resetPolygonCenter=function(d){var b,c,e,f={};d._calcDimensions();c=(d.minX+d.width/2)*d.scaleX;b=(d.minY+d.height/2)*d.scaleY;d.angle?f=a.rotatePoint({x:d.left+c,y:d.top+b},d.angle,{x:d.left,y:d.top}):(f.x=d.left+c,f.y=d.top+b);if(5<=fabric.version.split(".")[1]){c/=
d.scaleX;e=b/d.scaleY;for(b=0;b<d.points.length;b++)d.points[b].x-=c,d.points[b].y-=e}d.left=f.x;d.top=f.y;d.setCoords()};a.Fabric.print=function(d){var b,c,e,f,g;c=sprintf("width=%s,height=%s,menubar=1,toolbar=1,status=0,scrollbars=1,resizable=1",this.display.canvasjq.attr("width"),this.display.canvasjq.attr("height"));d=d||{};g=0;if(c=window.open(null,this.id,c)){c.document.open();c.document.write("<html><body style='padding: 0px; margin: 0px' onload='window.print(); return false'>");e=this.display.canvas.toDataURL("image/png");
f=sprintf("<div style='position:absolute; left:%spx; top:%spx'>",0,g);c.document.write(f);c.document.write("<img src='");c.document.write(e);c.document.write("'>");c.document.write("</div>");for(b in this.layers)this.layers.hasOwnProperty(b)&&("main"===this.layers[b].dlayer.dtype&&this.layers[b].show)&&(f=sprintf("<div style='position:absolute; left:%spx; top:%spx'>",0,g),c.document.write(f),c.document.write(this.layers[b].dlayer.canvas.toSVG()),c.document.write("</div>"));if(void 0===d.colorbar||
d.colorbar)if((d=this.display.pluginInstances.JS9Colorbar)&&d.isActive())g+=2,e=d.colorbarjq[0].toDataURL("image/png"),g+=this.display.height,f=sprintf("<div style='position:absolute; left:%spx; top:%spx'>",0,g),c.document.write(f),c.document.write(sprintf("<img ")),c.document.write(sprintf(" src='%s'>",e)),c.document.write("</div>"),e=d.textjq[0].toDataURL("image/png"),g+=d.colorbarjq.height()+1,f=sprintf("<div style='position:absolute; left:%spx; top:%spx'>",0,g),c.document.write(f),c.document.write(sprintf("<img style='width:%spx;'",
this.display.width)),c.document.write(sprintf("src='%s'>",e)),c.document.write("</div>");c.document.write("</body></html>");c.document.close()}else a.error("could not create print window (check your pop-up blockers)")};a.Fabric.initGraphics=function(){var d;a.Display.prototype.newShapeLayer=a.Fabric.newShapeLayer;a.Image.prototype.addShapes=a.Fabric.addShapes;a.Image.prototype.selectShapes=a.Fabric.selectShapes;a.Image.prototype.updateShapes=a.Fabric.updateShapes;a.Image.prototype.updateShape=a.Fabric._updateShape;
a.Image.prototype.getShapes=a.Fabric.getShapes;a.Image.prototype.changeShapes=a.Fabric.changeShapes;a.Image.prototype.removeShapes=a.Fabric.removeShapes;a.Image.prototype.refreshShapes=a.Fabric.refreshShapes;a.Image.prototype.getShapeLayer=a.Fabric.getShapeLayer;a.Image.prototype.showShapeLayer=a.Fabric.showShapeLayer;a.Image.prototype.displayShapeLayers=a.Fabric.displayShapeLayers;a.Image.prototype.print=a.Fabric.print;for(d in a.Fabric.opts)a.Fabric.opts.hasOwnProperty(d)&&(fabric.Object.prototype[d]=
a.Fabric.opts[d])};a.Fabric.initGraphics();a.MouseTouch={};a.MouseTouch.CLASS="JS9";a.MouseTouch.NAME="MouseTouch";a.MouseTouch.WIDTH=512;a.MouseTouch.HEIGHT=220;a.MouseTouch.BASE=a.MouseTouch.CLASS+a.MouseTouch.NAME;a.MouseTouch.mouseText=[];a.MouseTouch.mouseText[0]="move mouse, no buttons pressed:";a.MouseTouch.mouseText[1]="move mouse, primary button pressed:";a.MouseTouch.mouseText[2]="move mouse, secondary button pressed:";a.MouseTouch.touchText=[];a.MouseTouch.touchText[0]="touch move, with one finger:";
a.MouseTouch.touchText[1]="touch move, with two fingers:";a.MouseTouch.touchText[2]="touch move, with three fingers:";a.MouseTouch.textHTML="<div style='float: left'>%s</div>";a.MouseTouch.actionHTML="<div style='float: left'><b>%s</b></div>";a.MouseTouch.actionid=function(a,b){return(a+"_"+b).replace(/[^A-Za-z0-9_]/g,"_")};a.MouseTouch.addText=function(d,b){var c;c=sprintf(a.MouseTouch.textHTML,b);return $("<div>").addClass(a.MouseTouch.BASE+"Text").html(c).appendTo(d)};a.MouseTouch.addAction=function(d,
b,c){b=a.MouseTouch.actionid(b,c);c=sprintf(a.MouseTouch.actionHTML,c);return $("<div>").addClass(a.MouseTouch.BASE+"Action").attr("id",b).html(c).appendTo(d)};a.MouseTouch.isPinch=function(d){var b=a.globalOpts.pinchWait,c=a.globalOpts.pinchThresh,e,f,g;if(!d)return-1;e=d.display;if(!e.mousetouchZoom||2!==d.pos.touches.length)return-1;switch(e.ispinch){case -1:case 1:return e.ispinch}d=Math.sqrt((d.pos.touches[0].x-d.pos.touches[1].x)*(d.pos.touches[0].x-d.pos.touches[1].x)+(d.pos.touches[0].y-d.pos.touches[1].y)*
(d.pos.touches[0].y-d.pos.touches[1].y));e.dist0||(e.dist0=d);e.deltas.push(Math.floor(d-e.dist0));if(e.deltas.length>=b){d=1;for(g=f=0;d<b;d++)e.deltas[d]>e.deltas[d-1]?f++:e.deltas[d]<e.deltas[d-1]&&g++;e.ispinch=f>=c||g>=c?1:-1;e.lastzoom=0;return e.ispinch}return 0};a.MouseTouch.Actions={};a.MouseTouch.Actions["display value/position"]=function(d,b,c){!a.specialKey(c)&&(a.globalOpts.internalValPos&&d&&b&&0<b.x&&0<b.y&&b.x<d.raw.width&&b.y<d.raw.height)&&(d.valpos=d.updateValpos(b,!0))};a.MouseTouch.Actions["change contrast/bias"]=
function(d,b,c){var e=d.display;if(a.globalOpts.internalContrastBias&&(d&&b)&&(!d.clickInRegion&&!a.specialKey(c)&&!d.rgbFile)&&(c=a.eventToDisplayPos(c,d.posOffset),b=Math.floor(c.x+0.5),c=Math.floor(c.y+0.5),!a.globalOpts.containContrastBias||!(0>b||0>c||b>=e.canvas.width||c>=e.canvas.height)))d.params.bias=b/e.canvas.width,d.params.contrast=10*(c/e.canvas.height),a.bugs.firefox_linux?window.setTimeout(function(){d.displayImage("scaled",{blendMode:!1})},0):d.displayImage("scaled",{blendMode:!1}),
a.globalOpts.extendedPlugins&&d.xeqPlugins("image","onchangecontrastbias")};a.MouseTouch.Actions["change contrast/bias"].stop=function(a){a.display.blendMode&&a.displayImage("rgb")};a.MouseTouch.Actions["wheel zoom"]=function(d,b){var c,e=b.originalEvent.deltaY;d&&(c=d.display,c.mousetouchZoom&&(c=0<e?Math.min(a.MAXZOOM,d.getZoom()+a.ADDZOOM):Math.max(a.MINZOOM,d.getZoom()-a.ADDZOOM),c=Math.round(100*(c+1E-5))/100,d.setZoom(c)))};a.MouseTouch.Actions["pan the image"]=function(a){var b,c;a&&(b=a.rgb.sect.xcen+
(a.pos0.x-a.pos.x)/a.rgb.sect.zoom,c=a.rgb.sect.ycen-(a.pos0.y-a.pos.y)/a.rgb.sect.zoom,a.setPan(b,c),a.pos0=a.pos)};a.MouseTouch.Actions.pinch=function(d){var b,c;d&&(b=d.display,c=Math.sqrt((d.pos.touches[0].x-d.pos.touches[1].x)*(d.pos.touches[0].x-d.pos.touches[1].x)+(d.pos.touches[0].y-d.pos.touches[1].y)*(d.pos.touches[0].y-d.pos.touches[1].y)),c=b.zoom0*c/b.dist0,c=Math.max(a.MINZOOM,Math.min(a.MAXZOOM,Math.round(100*(c+1E-5))/100)),c!==b.lastzoom&&d.setZoom(c),b.lastzoom=c)};a.MouseTouch.Actions.start=
function(d,b,c){d&&(b=d.display,b.ispinch=0,b.dist0=0,b.zoom0=d.rgb.sect.zoom,b.deltas=[]);b=a.MouseTouch.getAction(d,c);a.MouseTouch.Actions[b]&&a.MouseTouch.Actions[b].start&&a.MouseTouch.Actions[b].start(d,d.ipos,c)};a.MouseTouch.Actions.stop=function(d,b,c){b=a.MouseTouch.getAction(d,c);a.MouseTouch.Actions[b]&&a.MouseTouch.Actions[b].stop&&a.MouseTouch.Actions[b].stop(d,d.ipos,c)};a.MouseTouch.getAction=function(d,b){var c,e;if(!d)return c;e=d.display;switch(d.clickState){case 0:c=e.mouseActions[0];
break;case 1:c=e.mouseActions[1];break;case 2:c=e.mouseActions[2];break;case -1:c=e.touchActions[0];break;case -2:switch(a.MouseTouch.isPinch(d,b)){case -1:c=e.touchActions[1];break;case 1:c="pinch"}break;case -3:c=e.touchActions[2]}return c};a.MouseTouch.action=function(d,b,c){if((c=c||a.MouseTouch.getAction(d,b))&&a.MouseTouch.Actions[c])a.MouseTouch.Actions[c](d,d.ipos,b)};a.MouseTouch.mousetouchzoom=function(d,b){var c=a.lookupDisplay(d),e=b.checked;c&&(c.mousetouchZoom=e)};a.MouseTouch.init=
function(){var d,b,c=this;this.divjq.html("");this.divjq.addClass("JS9PluginScrolling");this.mousetouchContainer=$("<div>").addClass(a.MouseTouch.BASE+"Container").attr("id",this.id+"MouseTouchContainer").appendTo(this.divjq);b=sprintf("<div class='%s'><span><b>Drag an action to reconfigure JS9 mouse/touch events:</b></span><p>",a.MouseTouch.BASE+"Header");this.mousetouchHeadContainer=$("<span style='float: left'>").addClass(a.MouseTouch.BASE+"Container").attr("id",this.id+"MouseTouchHeadContainer").html(b).appendTo(this.mousetouchContainer);
this.mousetouchTextContainer=$("<span style='float: left'>").addClass(a.MouseTouch.BASE+"Container").attr("id",this.id+"MouseTouchTextContainer").appendTo(this.mousetouchContainer);this.mousetouchActionContainer=$("<span style='float: left'>").addClass(a.MouseTouch.BASE+"Container").attr("id",this.id+"MouseTouchActionContainer").appendTo(this.mousetouchContainer);if(a.TOUCHSUPPORTED){this.mousetouchTouchTextContainer=$("<div>").addClass(a.MouseTouch.BASE+"TextContainer").attr("id",this.id+"TouchTextContainer").html("").appendTo(this.mousetouchTextContainer);
for(d=0;d<a.MouseTouch.touchText.length;d++)a.MouseTouch.addText.call(this,this.mousetouchTouchTextContainer,a.MouseTouch.touchText[d]);for(d=a.MouseTouch.touchText.length;d<this.display.touchActions.length;d++)a.MouseTouch.addText.call(this,this.mousetouchMouseTextContainer,"&nbsp;");this.mousetouchTouchContainer=$("<div>").addClass(a.MouseTouch.BASE+"ActionContainer").attr("id",this.id+"TouchContainer").html("").appendTo(this.mousetouchActionContainer);for(d=0;d<this.display.touchActions.length;d++)b=
this.display.touchActions[d],a.MouseTouch.addAction.call(this,this.mousetouchTouchContainer,"touch",b);this.mousetouchTouchContainer.sortable({start:function(a,b){this.oidx=b.item.index()},stop:function(a,b){var d=b.item.index(),h=c.display.touchActions.splice(this.oidx,1)[0];c.display.touchActions.splice(d,0,h)}})}if(!/iPad|iPhone|iPod/.test(navigator.platform)){this.mousetouchMouseTextContainer=$("<div>").addClass(a.MouseTouch.BASE+"TextContainer").attr("id",this.id+"MouseTextContainer").appendTo(this.mousetouchTextContainer);
for(d=0;3>d;d++)a.MouseTouch.addText.call(this,this.mousetouchMouseTextContainer,a.MouseTouch.mouseText[d]);for(d=3;d<this.display.mouseActions.length;d++)a.MouseTouch.addText.call(this,this.mousetouchMouseTextContainer,"&nbsp;");this.mousetouchMouseContainer=$("<div>").addClass(a.MouseTouch.BASE+"ActionContainer").attr("id",this.id+"MouseContainer").html("").appendTo(this.mousetouchActionContainer);for(d=0;d<this.display.mouseActions.length;d++)b=this.display.mouseActions[d],a.MouseTouch.addAction.call(this,
this.mousetouchMouseContainer,"mouse",b);this.mousetouchMouseContainer.sortable({start:function(a,b){this.oidx=b.item.index()},stop:function(a,b){var d=b.item.index(),h=c.display.mouseActions.splice(this.oidx,1)[0];c.display.mouseActions.splice(d,0,h)}})}b=sprintf("<p><div class='%s'>use mouse wheel or pinch to zoom:&nbsp;&nbsp;<input type='checkbox' value='1' onclick='javascript:JS9.MouseTouch.mousetouchzoom(\"%s\", this);'></div>",a.MouseTouch.BASE+"Footer",this.display.id);this.mousetouchFootContainer=
$("<span style='float: left'>").addClass(a.MouseTouch.BASE+"Container").attr("id",this.id+"MouseTouchFootContainer").html(b).appendTo(this.mousetouchContainer);this.display.mousetouchZoom&&this.mousetouchContainer.find("input").attr("checked",!0)};a.Regions={};a.Regions.CLASS="JS9";a.Regions.NAME="Regions";a.Regions.opts={canvas:{zindex:a.SHAPEZINDEX+2},panzoom:!0,tags:"source,include",strokeWidth:2,iradius:0,oradius:30,nannuli:10,width:60,height:60,radius:30,r1:30,r2:20,ptshape:"box",ptsize:2,linepoints:[{x:-30,
y:30},{x:30,y:-30}],polypoints:[{x:-30,y:30},{x:30,y:30},{x:0,y:-30}],fontFamily:"Helvetica",fontSize:14,fontStyle:"normal",fontWeight:300,textAlign:"left",angle:0,aradius1:4,aradius2:8,configURL:"./params/regionsconfig.html",tagcolors:{include_source:"#00FF00",exclude_source:"#FF0000",include_background:"#FFD700",exclude_background:"#FF8C00",source:"#00FF00",background:"#FFD700",defcolor:"#00FF00"},onmousedown:function(d,b,c,e){var f;!a.specialKey(c)&&e.params&&(b=(new Date).getTime(),e.params.lasttime&&
b-e.params.lasttime<a.DBLCLICK&&(f=!0),e.params.lasttime=b);f?e.params.winid||($("#dhtmlwindowholder").arrive("#regionsConfigForm",{onceOnly:!0},function(){e.pub&&a.Regions.initConfigForm.call(d,e)}),e.params.winid=a.allinone?d.displayAnalysis("params",a.allinone.regionsConfigHTML,{title:"Region Configuration"}):d.displayAnalysis("params",a.InstallDir(a.Regions.opts.configURL),{title:"Region Configuration"})):a.specialKey(c)&&("polygon"===e.type||"polyline"===e.type?(a.Fabric.addPolygonPoint.call(d,
e.params.layerName,e,c),a.Fabric._updateShape.call(d,e.params.layerName,e,null,"update")):e.polyparams&&e.polyparams.polygon&&(c=e.polyparams.polygon,a.Fabric.removePolygonPoint.call(d,c.params.layerName,e),a.Fabric._updateShape.call(d,c.params.layerName,c,null,"update")))},onmouseup:function(){var a,b=[];this.getActiveObject()&&b.push(this.getActiveObject());this.getActiveGroup()&&(b=this.getActiveGroup().getObjects());for(a=0;a<b.length;a++)b[a].polyparams&&this.setActiveObject(b[a].polyparams.polygon)},
onchange:null};a.Regions.init=function(d){var b;a.Image.prototype.parseRegions=a.Regions.parseRegions;a.Image.prototype.saveRegions=a.Regions.saveRegions;a.Image.prototype.listRegions=a.Regions.listRegions;a.Image.prototype.copyRegions=a.Regions.copyRegions;b=this.display.newShapeLayer(d||"regions",a.Regions.opts);b.canvas.on("mouse:up",function(){var a,d,f=[];if(b.display.image){d=b.display.image;this.getActiveObject()&&f.push(this.getActiveObject());this.getActiveGroup()&&(f=this.getActiveGroup().getObjects());
for(a=0;a<f.length;a++)if(f[a].params){d.params.listonchange?d.listRegions("all",2):f[a].params.listonchange&&d.listRegions("selected",2);break}}});return this};a.Regions.onchange=function(d,b){if(a.Regions.opts.onchange&&"function"===typeof a.Regions.opts.onchange)try{a.Regions.opts.onchange(d,b)}catch(c){}};a.Regions.initConfigForm=function(a){var b,c,e=a.params.winid,f="#"+$(e).attr("id")+" #regionsConfigForm ";$(f+"."+a.pub.shape).each(function(){$(this).removeClass("nodisplay")});$(f+".val").each(function(){c=
"";b=$(this).attr("name");switch(b){case "radii":a.pub.radii&&a.pub.radii.forEach(function(a){c&&(c+=", ");c+=a.toFixed(1)});break;case "pts":a.pub.pts?a.pub.pts.forEach(function(a){c&&(c+=", ");c+=sprintf("%s, %s",a.x.toFixed(2),a.y.toFixed(2))}):a.pub.imstr&&(c=a.pub.imstr.replace(/^.*\(/,"").replace(/\)$/,""));break;default:void 0!==a.pub[b]&&(c=a.pub[b],"number"===typeof c&&0!==c%1&&(c=c.toFixed(2)))}$(this).val(c)});a.pub.wcsstr&&$(f+".wcs").removeClass("nodisplay");void 0===a.params.listonchange&&
(a.params.listonchange=!1);a.params.listonchange?$(f+"[name='listonchange']").prop("checked",!0):$(f+"[name='listonchange']").prop("checked",!1);void 0===a.params.fixinplace&&(a.params.fixinplace=!1);a.params.fixinplace?$(f+"[name='fixinplace']").prop("checked",!0):$(f+"[name='fixinplace']").prop("checked",!1);switch(a.pub.shape){case "box":case "ellipse":case "text":$(f+".angle").removeClass("nodisplay")}$(f).data("im",this);$(f).data("shape",a);$(f).data("winid",e)};a.Regions.processConfigForm=
function(d,b,c){var e,f,g,h=c.length,j={},k=function(a,b,d){return"remove"===b||void 0!==a.pub[b]&&String(a.pub[b])!==d||void 0!==a.params[b]&&String(a.params[b])!==d?!0:!1},m=function(a){return"true"===a?!0:"false"===a?!1:""===a||isNaN(a)?a:parseFloat(a)};for(e=0;e<h;e++)switch(f=c[e].name,g=c[e].value,f){case "x":k(d,f,g)&&(j[f]=m(g),void 0===j.y&&(j.y=d.pub.y));break;case "y":k(d,f,g)&&(j[f]=m(g),void 0===j.x&&(j.x=d.pub.x));break;default:k(d,f,g)&&(j[f]=m(g))}this.changeShapes(d.pub.layer,d,j);
a.Regions.initConfigForm.call(this,d,b)};a.Regions.listRegions=function(d,b){var c,e,f,g,h,j,k,m="",n="none",q=!1,l=[],p=[];void 0===b&&(b=2);p=this.getShapes("regions",d);f=p.length;if(b)for(c=0;c<f;c++)if(e=p[c],"source,include"!==e.tags.join(",")){q=!0;break}for(g in a.Regions.opts.tagcolors)a.Regions.opts.tagcolors.hasOwnProperty(g)&&l.push(a.Regions.opts.tagcolors[g]);for(c=0;c<f;c++)e=p[c],g=e.tags.join(","),j=0<=g.indexOf("exclude")?"-":"",k=e.color&&-1===l.indexOf(e.color)?' {"color": "'+
e.color+'"} ':"",q&&(h=" # "+g),e.wcsstr&&"image"!==this.params.wcssys&&"physical"!==this.params.wcssys?("wcs"!==n&&("none"!==n&&(m+="; "),m+=this.params.wcssys,n="wcs"),m+="; "+j+e.wcsstr):e.imstr&&(n!==e.imsys&&("none"!==n&&(m+="; "),m+=e.imsys,n=e.imsys),m+="; "+j+e.imstr),k&&(m+=k),h&&(m+=h);1<b&&this.displayMessage("regions",m);return m};a.Regions.copyRegions=function(d,b){var c,e,f=[];if("object"===typeof d)f.push(d);else if("all"===d)for(c=0;c<a.images.length;c++)this!==a.images[c]&&f.push(a.images[c]);
else(c=a.lookupImage(d))&&f.push(c);if(f.length){b||(e=this.listRegions("selected",1));e||(e=this.listRegions(b,1));for(c=0;c<f.length;c++)f[c].addShapes("regions",e);return this}};a.Regions.parseRegions=function(d){var b=[],c,e,f,g,h,j,k,m,n,q,l,p=/(annulus)|(box)|(circle)|(ellipse)|(line)|(polygon)|(point)|(text)/,r=/(fk4)|(fk5)|(icrs)|(galactic)|(ecliptic)|(image)|(physical)/,s=/\(\s*([^)]+?)\s*\)/,t=/(\{[^}]*\})/,w=/\s*,\s*/,u=function(b){b=a.saostrtod(b);var d=String.fromCharCode(a.saodtype());
switch(d){case '"':b/=3600;break;case "'":b/=60;break;case "r":b*=180/Math.PI}return{dval:b,dtype:d}},y=function(b,d){var c,e;e=u(b);c=u(d);if(":"===e.dtype||":"===c.dtype)n=!0;m||n?(":"===e.dtype&&("galactic"!==k&&"ecliptic"!==k)&&(e.dval*=15),c=a.wcs2pix(this.raw.wcs,e.dval,c.dval).split(/ +/),e=parseFloat(c[0]),c=parseFloat(c[1])):"physical"===k?(c=this.logicalToImagePos({x:e.dval,y:c.dval}),e=c.x,c=c.y):(e=e.dval,c=c.dval);return[e,c]},v=function(a,b){var d=u(a),c=this.raw.wcsinfo||{cdelt1:1,
cdelt2:1};if((m||n)&&d.dtype&&"."!==d.dtype)d.dval=Math.abs(d.dval/c["cdelt"+b]);return d.dval},x=function(a){a=u(a);var b=this.raw.wcsinfo||{crot:0};if((m||n)&&b.crot)a.dval+=b.crot;return a.dval};d=d.trim();if(!d.match(/(\(|\{|#|;|\n)/))return d;j=this.getWCSSys();k="physical";this.setWCSSys(k);m="image"!==k&&"physical"!==k;f=d.split(/\n|;/);for(d=0;d<f.length;d++)if("#"!==f[d].trim().substr(0,1)){n=!1;g=f[d];h=void 0;c={opts:{},args:[],isregion:0};c.cmd=0<=g.indexOf("(")?g.split("(")[0].trim().toLowerCase():
0<=g.indexOf("{")?g.split("{")[0].trim().toLowerCase():0<=g.indexOf("#")?g.split("#")[0].trim().toLowerCase():g.trim().toLowerCase();c.cmd&&(c.isregion=0<=c.cmd.search(p));c.comment=g.split("#")[1];c.comment&&(c.comment=c.comment.trim().toLowerCase());if((h=t.exec(g))&&h[1])try{c.opts=JSON.parse(h[1].trim())}catch(z){c.opts={}}if((h=s.exec(g))&&h[1])c.args=h[1].split(w);c.isregion&&0===c.cmd.indexOf("-")&&(c.cmd=c.cmd.slice(1),c.comment=c.comment?c.comment+",exclude":"exclude");h=c;l=h.args.length;
if(h.isregion){g=$.extend(!0,{},h.opts);g.shape=h.cmd;2<=l&&(q=y.call(this,h.args[0],h.args[1]),g.x=q[0],g.y=q[1]);switch(h.cmd){case "annulus":g.radii=[];for(c=2;c<l;c++)g.radii.push(v.call(this,h.args[c],1));break;case "box":3<=l&&(g.width=v.call(this,h.args[2],1));4<=l&&(g.height=v.call(this,h.args[3],2));5<=l&&(g.angle=x.call(this,h.args[4]));break;case "circle":3<=l&&(g.radius=v.call(this,h.args[2],1));break;case "ellipse":3<=l&&(g.r1=v.call(this,h.args[2],1));4<=l&&(g.r2=v.call(this,h.args[3],
2));5<=l&&(g.angle=x.call(this,h.args[4]));break;case "line":case "polygon":g.pts=[];for(e=c=0;c<l;c+=2,e++)q=y.call(this,h.args[c],h.args[c+1]),g.pts[e]={x:q[0],y:q[1]};delete g.x;delete g.y;break;case "text":3<=l&&(c=g,e=h.args[2].replace(/^['"]/,"").replace(/["']$/,""),c.text=e)}h.comment&&(g.tags=h.comment);b.push(g)}else h.cmd.match(r)?(this.setWCSSys(h.cmd),k=this.getWCSSys(),m="image"!==k&&"physical"!==k):("remove"===h.cmd||"delete"===h.cmd)&&b.push({remove:!0})}this.setWCSSys(j);return b};
a.Regions.saveRegions=function(d,b){var c=sprintf("# Region file format: JS9 version 1.0"),e=this.listRegions(b,1),c=sprintf("%s\n%s\n",c,e.replace(/; */g,"\n")),c=new Blob([c],{type:"text/plain;charset=utf-8"});d=d||"js9.reg";window.hasOwnProperty("saveAs")?saveAs(c,d):a.error("no saveAs function available to save region file");return d};a.Regions.keyDownCB=function(a,b,c){var e,f,g={evt:c},h=c.which||c.keyCode;if(a){b=a.layer||"regions";f=a.display.layers[b].canvas;switch(h){case 8:case 46:c.preventDefault();
e="removeRegion";break;case 37:c.preventDefault();e="editRegion";g.dx=-1;break;case 38:c.preventDefault();e="editRegion";g.dy=1;break;case 39:c.preventDefault();e="editRegion";g.dx=1;break;case 40:c.preventDefault();e="editRegion";g.dy=-1;break;case 68:e="downRegion";break;case 85:e="upRegion"}switch(e){case "removeRegion":a.removeShapes(b,"selected");a.clearMessage(b);f.fire("mouse:up");break;case "editRegion":a.changeShapes(b,"selected",g);f.fire("mouse:up");break;case "downRegion":a.selectShapes(b,
"selected",function(a){f.sendToBack(a)});break;case "upRegion":a.selectShapes(b,"selected",function(a){f.bringToFront(a)})}}};a.Catalogs={};a.Catalogs.CLASS="JS9";a.Catalogs.NAME="Catalogs";a.Catalogs.opts={hasControls:!1,hasRotatingPoint:!1,hasBorders:!1,evented:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,lockUniScaling:!0,selectable:!1,canvas:{selection:!1},panzoom:!0,shape:"circle",strokeWidth:2,width:10,height:10,radius:5,eradius:{x:5,y:3},angle:0,tagcolors:{defcolor:"#00FF00"}};
Math.log10=Math.log10||function(a){return Math.log(a)/Math.LN10};"function"!==typeof Object.create&&(Object.create=function(a){var b=function(){};b.prototype=a;return new b});Math.asinh=Math.asinh||function(a){return-Infinity===a?a:Math.log(a+Math.sqrt(a*a+1))};Math.sinh=Math.sinh||function(a){return(Math.exp(a)-Math.exp(-a))/2};a.jupyterFocus=function(a,b){var c;window.hasOwnProperty("Jupyter")&&(c=a instanceof jQuery?a:$(a),c.find(b||"input, textarea").each(function(){Jupyter.keyboard_manager.register_events($(this))}))};
a.getImageID=function(d,b,c){var e,f,g=0,h=1,j=a.images.length,k=/.*<([0-9][0-9]*)>$/;d=d.replace(/<[0-9][0-9]*>/,"");for(e=0;e<j;e++)f=a.images[e],f.display.id===b&&(f!==c&&d===f.id0)&&(0<=f.id.search(k)&&(f=f.id.replace(k,"$1"),h=Math.max(h,parseInt(f,10))),g++);return g?d+"<"+String(h+1)+">":d};var G=1;a.uniqueID=function(){return G++};a.waiting=function(d,b){var c;switch(d){case !0:window.hasOwnProperty("Spinner")&&"spinner"===a.globalOpts.waitType?(b=b||$("body").get(0),a.spinner||(a.spinner=
{},c={color:a.globalOpts.spinColor,opacity:a.globalOpts.spinOpacity},a.spinner.spinner=new Spinner(c)),a.spinner.spinner.spin(b)):$("body").addClass("waiting");break;case !1:window.hasOwnProperty("Spinner")&&"spinner"===a.globalOpts.waitType?a.spinner&&a.spinner.spinner.stop():$("body").removeClass("waiting")}};a.msgHandler=function(d,b){var c,e,f,g=[],h=d.cmd,j=d.id;b&&(a.globalOpts.alerts=!1);if(a.publics[h]){$.isArray(d.args)||(d.args=[d.args]);g=$.extend(!0,[],d.args);j&&g.push({display:j});"RunAnalysis"===
h&&b&&(1===g.length&&g.push(null),g.push(b),b=null);try{f=a.publics[h].apply(null,g)}catch(k){f=sprintf("ERROR: %s",k.message)}b&&(a.globalOpts.alerts=!0,b(f));return f}if(!h||"#"===h)b&&b(""),b&&(a.globalOpts.alerts=!0);else{c=a.lookupCommand(h);e=a.lookupDisplay(j);if(c&&e)switch(c.getDisplayInfo(e),d.args?g=$.extend(!0,[],d.args):d.paramlist&&(g=d.paramlist.split(/ +/)),c.getWhich(g)){case "get":try{f=c.get(g)||""}catch(m){f="ERROR: "+m.message}break;case "set":try{f=c.set(g)||"OK"}catch(n){f=
"ERROR: "+n.message}break;default:f=sprintf("ERROR: unknown cmd type for '%s'",h)}else c||(f=sprintf("ERROR: unknown cmd '%s'",h)),e||(f=sprintf("ERROR: unknown display (%s)",j));b&&(a.globalOpts.alerts=!0,b(f));return f}};a.lightWin=function(d,b,c,e,f){var g;switch(a.LIGHTWIN){case "dhtml":g=dhtmlwindow.open(d,b,c,e,f),/iPad|iPhone|iPod/.test(navigator.platform)&&$("#"+d+" "+a.lightOpts.dhtml.drag).css("-webkit-overflow-scrolling","touch").css("overflow-y","scroll"),$("#"+d+" ."+a.lightOpts.dhtml.dragBar).doubletap(function(){g.close()},
null,400),$("#"+d+" ."+a.lightOpts.dhtml.dragBar).on("touchend",this,function(){!dhtmlwindow.distancex&&!dhtmlwindow.distancey?2<=a.lightOpts.nclick?(alert("trouble closing this window? double-tap the window handle"),a.lightOpts.nclick=-1):0<=a.lightOpts.nclick&&a.lightOpts.nclick++:0<a.lightOpts.nclick&&(a.lightOpts.nclick=0)})}return g};a.checkNew=function(d){d||a.error("internal failure in a JS9 constructor")};a.specialKey=function(a){return a.metaKey||a.ctrlKey};a.strace=function(d){var b="";
1<a.DEBUG&&(b=d.stack||d.stacktrace||"");return b};a.floatPrecision=function(a,b){var c,e;c=Math.floor(Math.log10(Math.abs(a)));e=Math.floor(Math.log10(Math.abs(b)));return c!==e?c>e?c:e:1};a.floatFormattedString=function(a,b,c){var e="";if(void 0===a)return e;-2>b?(b="%."+Math.min(Math.abs(b),9)+"e",e=sprintf(b,a)):0>b?e=a.toFixed(Math.abs(b)+3):2>b?(b="%."+Math.abs(b)+"f",e=sprintf(b,a)):5>b?e=a.toFixed(c):(b="%."+Math.min(b,9)+"e",e=sprintf(b,a));return e};a.centerPolygon=function(a){var b,c,e,
f,g,h;if(a&&a.length){c=a.length;for(b=0;b<c;b++){if(void 0===e||a[b].x<e)e=a[b].x;if(void 0===f||a[b].x>f)f=a[b].x;if(void 0===g||a[b].y<g)g=a[b].y;if(void 0===h||a[b].y>h)h=a[b].y}return{x:(e+f)/2,y:(g+h)/2}}};a.centroidPolygon=function(a){var b,c,e=0,f=0;if(a&&a.length){c=a.length;for(b=0;b<c;b++)e+=a[b].x,f+=a[b].y;return{x:e/c,y:f/c}}};a.lookupImage=function(d,b){var c,e,f=a.images.length;if(!d)return null;for(c=0;c<f;c++)if(e=a.images[c],d===e||d===e.id||d===e.id0||d===e.file||d===e.file0||
d===a.TOROOT+e.file||e.fitsFile&&d===e.fitsFile)if(0<$("#"+e.display.id).length&&(!b||b===e.display.id))return e;return null};a.lookupDisplay=function(d){var b,c=RegExp(sprintf("[-_]?(%s)$",a.PLUGINS));if(d&&"*"!==d&&0>d.toString().search(a.SUPERMENU)){for(b=0;b<a.displays.length;b++)if(d===a.displays[b]||d===a.displays[b].id)return a.displays[b];if("string"===typeof d){d=d.replace(c,"");for(b=0;b<a.displays.length;b++)if(d===a.displays[b]||d===a.displays[b].id)return a.displays[b]}a.error("can't find JS9 display with id: "+
d)}return a.displays[0]};a.getImage=function(d){var b=null,c=null,b=a.lookupImage(d);if(!b&&(c=a.lookupDisplay(d)))b=c.image;return b};a.lookupVfile=function(d){var b,c,e,f,g=[];if(!d)return g;for(b=0;b<a.images.length;b++){e=a.images[b];for(c=0;c<e.raws.length;c++)f=e.raws[c],f.hdu&&(f.hdu.fits&&d===f.hdu.fits.vfile)&&g.push({im:e,raw:f,idx:c})}return g};a.onFileList=function(d,b,c){var e,f=function(e){var f;e=d[e];var j=$.extend({},b);if(a.fits.handleFITSFile){e.name&&(j.filename=e.name);j.display&&
(f=a.lookupDisplay(j.display))&&(f=f.divjq[0]);a.waiting(!0,f);try{a.fits.handleFITSFile(e,j,c)}catch(k){a.error("can't process FITS file from file list",k)}}else a.error("no FITS module available to load FITS file")};for(e=0;e<d.length;e++)if(-1!==d[e].type.indexOf("image/"))switch(d[e].type){case "image/fits":f(e);break;default:a.handleImageFile(d[e],b,c)}else f(e)};a.fetchURL=function(d,b,c,e){var f=new XMLHttpRequest,g;b||(b=d,d=/([^\\\/]+)$/.exec(b)[1]);g=$.extend(!0,{},c,a.fits.options);f.open("GET",
b,!0);f.responseType=c.responseType?c.responseType:"blob";a.globalOpts.xtimeout&&(f.timeout=a.globalOpts.xtimeout);f.onload=function(){var h;4===this.readyState&&(200===this.status||0===this.status?"blob"===f.responseType?(h=new Blob([this.response]),h.name=d.match("://")?d.split("/").reverse()[0].replace(/\?.*$/,""):d,"uc"===h.name&&(h.name="google_"+a.uniqueID()+".fits"),a.onFileList([h],g,e)):c.display?e(this.response,c,{display:c.display}):e(this.response,c):404===this.status?a.error("could not find "+
b):a.error(sprintf("can't load: %s %s (%s)  ",b,f.statusText,f.status)))};f.onerror=function(){a.error(sprintf("cannot load: %s %s .. please check the url/pathname",b,f.statusText))};f.ontimeout=function(){a.error("timeout awaiting response from server: "+b)};try{f.send()}catch(h){a.error("request to load "+b+" failed",h)}};a.fitsLibrary=function(d){var b;if(!d)return a.fits.name;b=d.toLowerCase();switch(b){case "fitsy":a.fits=Fitsy;a.fits.datahandler(a.NewFitsImage);a.fits.options=a.userOpts.fits||
a.fits.options||{};break;case "astroem":case "cfitsio":a.fits=Astroem;a.fits.options=a.fits.options||{};a.fits.options.handler=a.NewFitsImage;a.fits.options.error=a.error;a.userOpts.fits?(a.fits.options.extlist=a.userOpts.fits.extlist,a.fits.options.table={nx:a.userOpts.fits.xdim,ny:a.userOpts.fits.ydim}):(a.fits.options.extlist=a.globalOpts.extlist,a.fits.options.table={nx:a.globalOpts.dims[0],ny:a.globalOpts.dims[1]});a.fits.maxFITSMemory&&a.globalOpts.maxMemory&&a.fits.maxFITSMemory(a.globalOpts.maxMemory);
break;default:a.error("unknown fits library: "+d)}a.fits.name=b;a.fits.options.error=a.error;a.fits.options.waiting=a.waiting;return b};a.handleImageFile=function(d,b,c){var e=new FileReader;b=$.extend(!0,{},b,a.fits.options);void 0===c&&(c=a.Load);e.onload=function(a){var e=new Image,h,j,k;e.src=a.target.result;e.onload=function(){var a,f,q,l=0;a=document.createElement("canvas");f=a.getContext("2d");var p=e.height,r=e.width;a.width=r;a.height=p;f.drawImage(e,0,0);h=f.getImageData(0,0,r,p).data;j=
new Float32Array(p*r);for(f=0;f<p;f++)for(a=0;a<r;a++)q=0.299*h[l]+0.587*h[l+1]+0.114*h[l+2],j[(p-f)*r+a]=q,l+=4;k={head:{},name:d.name,filedata:j,naxis:2,axis:[0,r,p],bitpix:-32,data:j};k.dmin=Number.MAX_VALUE;k.dmax=Number.MIN_VALUE;for(l=0;l<p*r;l++)k.dmin=Math.min(k.dmin,k.data[l]),k.dmax=Math.max(k.dmax,k.data[l]);c(k,b)}};e.readAsDataURL(d)};a.lookupColormap=function(d){var b;d||(d=a.imageOpts.colormap);if(d)for(b=0;b<a.colormaps.length;b++)if(a.colormaps[b].name===d)return a.colormaps[b];a.error("unknown colormap '"+
d+"'")};a.lookupCommand=function(d){var b,c;if(d){c=d.toLowerCase();for(b=0;b<a.commands.length;b++)if(d=a.commands[b],d.name===c||d.alias===c||d.alias2===c)return d}return null};a.error=function(d,b,c){var e,f,g="",h="",j=!0;a.waiting(!1);"string"===typeof b?(f=d.match(b))?f[1]?d=f[1]:f[0]&&(d=f[0]):j=!1:"object"===typeof b&&(e=b);3>arguments.length&&(c=!0);if(j&&(e&&e.message?d+=sprintf(" (%s)",e.message):d&&(e=Error(d)),(f=a.strace(e))&&(h="\n\nStacktrace:\n"+f),a.globalOpts.alerts&&(d&&("string"===
typeof d&&0>d.search(/ERROR/))&&(g="JS9 ERROR: "),alert(g+(d+h))),c))throw e;};a.eventToCharStr=function(a){var b,c,e={37:"leftArrow",38:"upArrow",39:"rightArrow",40:"downArrow",8:"delete",46:"delete"},f={188:"44",109:"45",190:"46",191:"47",192:"96",220:"92",222:"39",221:"93",219:"91",173:"45",187:"61",186:"59",189:"45"},g={96:"~",49:"!",50:"@",51:"#",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",48:")",45:"_",61:"+",91:"{",93:"}",92:"|",59:":",39:'"',44:"<",46:">",47:"?"};b="number"===typeof a?a:a.which||
a.keyCode;c=String(b);f.hasOwnProperty(c)&&(b=f[c]);return b=!a.shiftKey&&65<=b&&90>=b?String.fromCharCode(b+32):!a.shiftKey&&e.hasOwnProperty(b)?e[b]:a.shiftKey&&g.hasOwnProperty(b)?g[b]:String.fromCharCode(b)};a.eventToDisplayPos=function(a,b){var c,e,f,g,h;a||(a=window.event);a.target?e=a.target:a.srcElement&&(e=a.srcElement);3===e.nodeType&&(e=e.parentNode);b=b||$(e).offset();a.originalEvent?a.originalEvent.touches&&a.originalEvent.touches.length?(h=a.originalEvent.touches,c=h[0].pageX,f=h[0].pageY):
a.originalEvent.changedTouches&&a.originalEvent.changedTouches.length?(h=a.originalEvent.changedTouches,c=h[0].pageX,f=h[0].pageY):(c=a.pageX,f=a.pageY):(c=a.pageX,f=a.pageY);e=b.left+1;g=b.top+1;f={x:Math.floor(c-e),y:Math.floor(f-g)};if(h&&h.length){f.touches=[{x:f.x,y:f.y}];for(c=1;c<h.length;c++)f.touches[c]={x:Math.floor(h[c].pageX-e),y:Math.floor(h[c].pageY-g)}}return f};a.rotatePoint=function(a,b,c){var e;c=c||{x:0,y:0};b=Math.PI*b/180;e=Math.cos(b);b=Math.sin(b);return{x:e*(a.x-c.x)-b*(a.y-
c.y)+c.x,y:b*(a.x-c.x)+e*(a.y-c.y)+c.y}};a.log=function(){var a;if(void 0!==window.console&&void 0!==window.console.log)try{console.log.apply(console,arguments)}catch(b){a=Function.prototype.bind.call(console.log,console),a.apply(console,arguments)}};a.isNumber=function(a){return!isNaN(parseFloat(a))&&isFinite(a)};a.notNull=function(a){return void 0!==a&&null!==a};a.cardpars=function(d){var b;if("="===d[8])return b=d.slice(0,8).trim(),d=d.slice(10).replace(/\'/g," ").replace(/\/.*/,"").trim(),"T"===
d?d=!0:"F"===d?d=!1:a.isNumber(d)&&(d=parseFloat(d)),[b,d]};a.raw2FITS=function(a,b){var c,e,f,g=!1,h="";if(!a)return h;if(a.card)for(c=0;c<a.card.length;c++)e=a.card[c],h+=e,"END "===e.substring(0,4)&&(g=!0),b&&(h+="\n");else if(a.cardstr)for(c=0;c<a.ncard;c++)e=a.cardstr.slice(80*c,80*(c+1)),e.match(/^BITPIX/)&&a.bitpix?(f=e.replace(/BITPIX *= *(-?[0-9][0-9]*) */,"$1"),f=parseInt(f,10),h=f!==a.bitpix?h+sprintf("BITPIX  = %20s / %-47s",a.bitpix,"bits/pixel"):h+e):h+=e,"END "===e.substring(0,4)&&
(g=!0),b&&(h+="\n");else if(a.header)for(e in c=a.header,c){if(c.hasOwnProperty(e)&&!("js9Protocol"===e||"js9Endian"===e))"END"===e&&(g=!0),f=c[e],!0===f&&(f="T"),h+=sprintf("%-8s%-2s%-70s",e,"=",f),b&&(h+="\n")}else if(a.BITPIX)for(e in c=a,c)if(c.hasOwnProperty(e)&&!("js9Protocol"===e||"js9Endian"===e))"END"===e&&(g=!0),f=c[e],!0===f&&(f="T"),h+=sprintf("%-8s%-2s%-70s",e,"=",f),b&&(h+="\n");g||(h+=sprintf("%-8s%-72s","END"," "),b&&(h+="\n"));return h};a.hdus2Str=function(a){var b,c,e,f="";if(!a)return f;
for(b=0;b<a.length;b++){e=a[b];c=e.name?e.name:0===b?"Primary":"N/A";f+=sprintf("<b>#%d</b>:&#09;<b>name</b>: %s&#09;<b>type</b>: %s",e.hdu,c,e.type);switch(e.type){case "image":f+=sprintf("&#09;<b>bitpix</b>: %d&#09;<b>naxis</b>: %d",e.bitpix,e.naxis);if(e.naxes.length){f+="&#09;<b>axes</b>: [";for(c=0;c<e.naxes.length;c++)f+=sprintf("%d",e.naxes[c]),c!==e.naxes.length-1&&(f+=", ");f+="]"}break;case "table":case "ascii":c="&#09;";9>=e.rows&&(c+="&#09;");f+=sprintf("&#09;<b>rows</b>: %d%s<b>cols</b>: [",
e.rows,c);for(c=0;c<e.cols.length;c++)f+=sprintf("%s",e.cols[c].name),c!==e.cols.length-1&&(f+=", ");f+="]"}f+="\n\n"}return f};CanvasRenderingContext2D.prototype.clear=CanvasRenderingContext2D.prototype.clear||function(a){a&&(this.save(),this.setTransform(1,0,0,1,0,0));this.clearRect(0,0,this.canvas.width,this.canvas.height);a&&this.restore()};a.tooltip=function(a,b,c,e,f,g){c?(c=c.replace(/\$([a-zA-Z0-9_.]+)/g,function(a,b){var c,d,n=b.split(".");switch(n[0]){case "im":d=e;break;case "xreg":d=f;
break;case "evt":d=g;break;default:return a}for(c=1;c<n.length;c++)d=d[n[c]];return d}),e.display.tooltip.html(c).css({left:a,top:b,display:"inline-block"})):e.display.tooltip.html("").css({left:-9999,display:"none"})};a.xeqByName=function(d,b){var c,e,f,g;e=Array.prototype.slice.call(arguments,2);c=typeof d;switch(c){case "function":return d.apply(b,e);case "string":f=d.split(".");g=f.pop();for(c=0;c<f.length;c++)b=b[f[c]];return b[g].apply(b,e);default:a.error("unknown function type: "+c)}};a.varByName=
function(d,b){var c,e,f;b=b||a;e=d.split(".");f=e.pop();for(c=0;c<e.length;c++)if(b=b[e[c]],!b)return null;return b[f]};a.loadPrefs=function(d,b){$.ajax({url:d,cache:!1,dataType:"json",mimeType:"application/json",async:!1,success:function(b){var d,f,g;for(g in b)if(b.hasOwnProperty(g)&&a.hasOwnProperty(g)&&(f=typeof a[g],d=typeof b[g],f===d||"string"===d))switch(f){case "object":$.isArray(b[g])?a[g]=b[g]:$.extend(!0,a[g],b[g]);break;case "number":case "string":a[g]=b[g]}},error:function(c,e,f){b&&
(a.CHROMEFILEWARNING&&"Chrome"===a.BROWSER[0]&&""===document.domain&&f&&f.message&&f.message.match(/Failed to execute 'send' on 'XMLHttpRequest'/)?(alert("When using the file:// URI, Chrome must be run with the --allow-file-access-from-files switch to permit JS9 to access the preference file (and data files)."),a.CHROMEFILEWARNING=!1):a.log("JS9 prefs file not available: %s",d))}})};a.isTypedArray=function(a){a=Object.prototype.toString.call(a);return{"[object Int8Array]":!0,"[object Uint8Array]":!0,
"[object Uint8ClampedArray]":!0,"[object Int16Array]":!0,"[object Uint16Array]":!0,"[object Int32Array]":!0,"[object Uint32Array]":!0,"[object Float32Array]":!0,"[object Float64Array]":!0}.hasOwnProperty(a)};a.mouseDownCB=function(d){var b=d.data,c=b.image;if(c){d.target&&(c.posOffset=$(d.target).offset());c.pos0=a.eventToDisplayPos(d,c.posOffset);c.pos=c.pos0;c.ipos0=c.displayToImagePos(c.pos);c.ipos=c.ipos0;b.resizing=b.inResize(c.pos);if(!b.resizing){d.preventDefault();a.hasOwnProperty("MouseTouch")&&
a.MouseTouch.action(c,d,"start");if(c.clickInRegion){c.clearMessage("regions");return}a.specialKey(d)||c.xeqPlugins("mouse","onmousedown",d)}c.clickState=d.which;switch(d.which){case 3:c.clickState=2}d.originalEvent&&(d.originalEvent.touches&&d.originalEvent.touches.length)&&(c.clickState=-d.originalEvent.touches.length);$(document).on("mousemove."+b.id,b,function(b){return a.mouseMoveCB(b)});$(document).on("mouseup."+b.id,b,function(b){return a.mouseUpCB(b)})}};a.mouseUpCB=function(d){var b,c,e=
d.data;if(b=e.image){b.pos=a.eventToDisplayPos(d,b.posOffset);b.ipos=b.displayToImagePos(b.pos);e.inResize(b.pos)||d.preventDefault();a.hasOwnProperty("MouseTouch")&&a.MouseTouch.action(b,d,"stop");b.clickInRegion&&(Math.abs(b.pos0.x-b.pos.x)<a.NOMOVE&&Math.abs(b.pos0.y-b.pos.y)<a.NOMOVE?b.updateShapes("regions","selected","select"):b.updateShapes("regions","selected","update"));a.specialKey(d)||b.xeqPlugins("mouse","onmouseup",d);b.clickInRegion=!1;b.clickState=0;b.posOffset=null;e.resizing&&(e.resizing=
!1,a.bugs.webkit_resize&&(d=parseInt(e.divjq.css("width"),10),c=parseInt(e.divjq.css("height"),10),d<e.owidth&&e.divjq.css("width",e.owidth+a.RESIZEFUDGE),c<e.oheight&&e.divjq.css("height",e.oheight+a.RESIZEFUDGE)),a.globalOpts.resizeRedisplay||(b.displayImage("all"),b.refreshLayers()));$(document).off("mouseup."+e.id);$(document).off("mousemove."+e.id);for(b=0;b<a.displays.length;b++)d=a.displays[b],d!==e&&(d.image&&d.image.clickState)&&d.divjq.trigger("mouseup")}};a.mouseMoveCB=function(d){var b;
b=d.data;var c=b.image;if(c&&(c.pos=a.eventToDisplayPos(d,c.posOffset),c.ipos=c.displayToImagePos(c.pos),c.pos0||(c.pos0=c.pos),c.ipos0||(c.ipos0=c.ipos),!b.resizing)){d.preventDefault();c.valpos=null;if(c.clickInRegion&&(b=c.display.layers.regions.params.sel)&&(c.params.listonchange||b.params.listonchange))c.updateShape("regions",b,null,"update",!0),c.listRegions("selected",2);a.hasOwnProperty("MouseTouch")&&a.MouseTouch.action(c,d);a.specialKey(d)||(c.valpos||(c.valpos=c.updateValpos(c.ipos,!1)),
a.specialKey(d)||c.xeqPlugins("mouse","onmousemove",d))}};a.mouseOverCB=function(d){var b=d.data.image,c=$(document).scrollLeft(),e=$(document).scrollTop();d.preventDefault();b&&(b.display.displayConjq.focus(),window.scrollTo(c,e),a.specialKey(d)||(b.pos=a.eventToDisplayPos(d),b.ipos=b.displayToImagePos(b.pos),a.specialKey(d)||b.xeqPlugins("mouse","onmouseover",d)))};a.mouseOutCB=function(d){var b=d.data.image;d.preventDefault();b&&(b.display.displayConjq.blur(),a.specialKey(d)||(b.pos=a.eventToDisplayPos(d),
b.ipos=b.displayToImagePos(b.pos),a.specialKey(d)||b.xeqPlugins("mouse","onmouseout",d)))};a.wheelCB=function(d){var b=d.data,c=b.image;b.mousetouchZoom&&(c&&a.hasOwnProperty("MouseTouch")&&a.MouseTouch.Actions["wheel zoom"])&&(a.MouseTouch.Actions["wheel zoom"](c,d),d.preventDefault())};a.keyPressCB=function(a){var b=a.data.image;a.preventDefault();b&&b.xeqPlugins("keypress","onkeypress",a)};a.keyDownCB=function(d){var b,c=d.data.image;a.hasOwnProperty("Keyboard")&&(b=c?c.ipos:{x:null,y:null},a.Keyboard.action(c,
b,d));c&&c.xeqPlugins("keypress","onkeydown",d)};a.dragenterCB=function(a,b){b.stopPropagation();b.preventDefault()};a.dragoverCB=function(a,b){b.stopPropagation();b.preventDefault()};a.dragexitCB=function(a,b){b.stopPropagation();b.preventDefault()};a.dragdropCB=function(d,b,c){var e;b.originalEvent&&(b=b.originalEvent);b.stopPropagation();b.preventDefault();b=b.target.files||b.dataTransfer.files;e=$.extend(!0,{},a.fits.options);void 0===e.display&&(e.display=d);void 0===e.extlist&&(e.extlist=a.globalOpts.extlist);
a.onFileList(b,e,c)};a.RegisterPlugin=function(d,b,c,e){var f,g;d&&(b&&c)&&(f=d+b,e?(e.viewMenuItem&&(e.menuItem=e.viewMenuItem),e.menuItem&&!e.menu&&(e.menu="view"),e.menu&&(e.menu=e.menu.toLowerCase())):e=[],a.PLUGINS&&(a.PLUGINS+="|"),a.PLUGINS+=f.replace(/JS9/,""),a.plugins.push({xclass:d,xname:b,name:f,opts:e,func:c,instances:[]}),e.help&&(c=e.help.match(/^.*[\\\/]/),c[0]&&(g="plugins/"+c[0].replace(/[\\\/]+$/,"")),c=e.help.replace(/^.*[\\\/]/,""),e=e.menuItem?e.menuItem:f,a.helpOpts[b]={type:g,
url:c,heading:d,title:e}))};a.instantiatePlugin=function(d,b,c,e){var f,g,h;if("string"===typeof b){for(f=0;f<a.plugins.length;f++)if(g=a.plugins[f],g.name===b){b=g;break}"string"===typeof b&&a.error("unknown plugin: "+b)}g=Object.create(b.func.prototype);g.name=b.name;g.isActive=function(a){if("active"!==this.status||a&&!this.plugin.opts.hasOwnProperty(a))return!1;switch(this.winType){case "virtual":return!0;default:return this.divjq.is(":visible")}};g.errLog=function(b,c){a.log("error in %s: %s [%s]\n%s",
b,this.name,c.message,a.strace(c))};if(d){h=d instanceof jQuery?d:"object"===typeof d?$(d):$("#"+d);for(f=0;f<b.instances.length;f++)if(h.is(b.instances[f].odivjq))return b.instances[f]}else h=$("div");if(d)if(c)g.id=h.attr("id")||b.name,g.winType="light",g.winHandle=c,g.odivjq=h,g.divjq=h,g.outerdivjq=g.divjq.closest(a.lightOpts[a.LIGHTWIN].top);else{if(g.id=h.attr("id")||b.name,g.winType="div",c=h.attr("id")||"JS9Plugin",h.wrap("<div class='JS9PluginContainer'>"),g.odivjq=h,g.divjq=h,g.divjq.addClass(b.xclass+
"Plugin").addClass("JS9Plugin"),g.odivjq.attr("id")||g.odivjq.attr("id",g.id),g.outerdivjq=g.divjq.closest(".JS9PluginContainer"),b.opts.toolbarSeparate||h.data("toolbarseparate"))c="<div class='"+a.lightOpts[a.LIGHTWIN].dragBar+"'>",$(c).insertBefore(g.divjq)}else g.id=b.name,g.winType="virtual";g.plugin=b;g.el=d;g.status="active";b.instances.push(g);if("virtual"===g.winType)for(f=0;f<a.displays.length;f++)a.displays[f].pluginInstances[b.name]||(g.div=null,g.display=a.displays[f],b.func.apply(g,
e),a.displays[f].pluginInstances[b.name]=g);else{g.div=g.divjq[0];g.outerdiv=g.outerdivjq[0];if(b.opts.winDims&&(!g.divjq.width()||!g.divjq.height()))g.divjq.css("width",b.opts.winDims[0]),g.divjq.css("height",b.opts.winDims[1]);c=g.divjq.data("js9id")||g.id;g.display=a.lookupDisplay(c);if(h=h.data("toolbarhtml")||b.opts.toolbarHTML)h=a.Image.prototype.expandMacro.call(null,h,[{name:"title",value:b.opts.winTitle||""}]),d=g.divjq.closest(a.lightOpts[a.LIGHTWIN].drag),0===d.length&&(d=g.divjq),$("<div class='JS9PluginToolbar-"+
g.winType+"'>").css("z-index",a.BTNZINDEX).html(h).data("displayid",g.display.id).insertAfter(d);g.display.pluginInstances[b.name]=g;b.func.apply(g,e)}return g};a.instantiatePlugins=function(){var d,b=function(b){$("div."+b.name).each(function(){a.instantiatePlugin($(this),b,null,b.opts.divArgs)});!b.opts.menuItem&&(b.opts.winDims&&!b.opts.winDims[0]&&!b.opts.winDims[1])&&a.instantiatePlugin(null,b,null,b.opts.divArgs)};for(d=0;d<a.plugins.length;d++)b(a.plugins[d])};a.init=function(){var d;window.HTMLCanvasElement||
a.error("sorry: your browser does not support JS9 (no HTML5 canvas support). Try a modern version of Firefox, Chrome, or Safari.");JSON||a.error("sorry: your browser does not support JS9 (no JSON support). Try a modern version of Firefox, Chrome, or Safari.");if(!a.INSTALLDIR){try{a.INSTALLDIR=$('link[href$="js9.css"]').attr("href").replace(/js9\.css$/,"")||""}catch(b){a.INSTALLDIR=""}a.TOROOT=a.INSTALLDIR.replace(/([^\/.])+/g,"..")}window.hasOwnProperty("Kinetic")&&!window.hasOwnProperty("fabric")&&
a.error("please load fabric.js instead of Kinetic.js");"dhtml"===a.LIGHTWIN&&($("<div>").attr("id","dhtmlwindowholder").appendTo($(document.body)).append("<span style='display:none'>.</span>"),dhtmlwindow.imagefiles=a.allinone?[a.allinone.min,a.allinone.close,a.allinone.restore,a.allinone.resize]:[a.InstallDir("images/min.gif"),a.InstallDir("images/close.gif"),a.InstallDir("images/restore.gif"),a.InstallDir("images/resize.gif")],window.hasOwnProperty("Jupyter")&&$("#dhtmlwindowholder").arrive("input",
function(){a.jupyterFocus($(this).parent())}));a.globalOpts.plotLibrary=a.globalOpts.plotLibrary||"flot";"plotly"===a.globalOpts.plotLibrary&&!window.hasOwnProperty("Plotly")&&(a.globalOpts.plotLibrary="flot");a.PREFSFILE&&(a.loadPrefs(a.InstallDir(a.PREFSFILE),1),a.loadPrefs(a.PREFSFILE,0),$.extend(!0,a.Regions.opts,a.regionOpts));"file:"===a.globalOpts.helperProtocol&&(a.globalOpts.helperProtocol="http:");a.globalOpts.resize||(a.globalOpts.resizeHandle=!1);a.BROWSER[3]&&(a.globalOpts.resizeHandle=
!1);a.globalOpts.helperProtocol+="//";if(window.hasOwnProperty("localStorage")){try{d=localStorage.getItem("images")}catch(c){d=null}if(d){try{a.userOpts.images=JSON.parse(d)}catch(e){}a.userOpts.images&&$.extend(!0,a.imageOpts,a.userOpts.images)}try{d=localStorage.getItem("regions")}catch(f){d=null}if(d){try{a.userOpts.regions=JSON.parse(d)}catch(g){}a.userOpts.regions&&$.extend(!0,a.Regions.opts,a.userOpts.regions)}try{d=localStorage.getItem("fits")}catch(h){d=null}if(d)try{a.userOpts.fits=JSON.parse(d)}catch(j){}try{d=
localStorage.getItem("displays")}catch(k){d=null}if(d){try{a.userOpts.displays=JSON.parse(d)}catch(m){}a.userOpts.displays&&$.extend(!0,a.globalOpts,a.userOpts.displays)}}window.addEventListener("message",function(b){var c,d=b.data;b=b.origin||b.originalEvent.origin;"null"===b&&(b="unknown");if(a.globalOpts.postMessage){if("string"===typeof d)try{c=JSON.parse(d)}catch(e){a.error("can't parse msg: "+d,e)}else"object"===typeof d?c=d:a.error("invalid msg from postMessage");a.msgHandler(c,function(a,
b,d,e){e=e||{};parent.postMessage({cmd:c.cmd,res:{name:e.name,rtype:e.rtype,rdata:a,stdout:a,stderr:b,errcode:d}},"*")})}else a.DEBUG&&(b=sprintf("JS9 ignoring postMessage, origin: %s",b),b="string"===typeof d?b+sprintf(" data: %s",d):"object"===typeof d?b+sprintf(" obj: %s",JSON.stringify(Object.keys(d))):b+sprintf(" typeof: %s",typeof d),a.log(b))},!1);a.DEBUG=a.DEBUG||a.globalOpts.debug||0;a.hasOwnProperty("Keyboard")&&(a.Keyboard.Actions["move selected region"]=function(b,c,d){a.Regions.keyDownCB(b,
c,d)},a.Keyboard.Actions["remove selected region"]=function(b,c,d){a.Regions.keyDownCB(b,c,d)});window.hasOwnProperty("ImageFilters")&&(a.ImageFilters=ImageFilters);window.hasOwnProperty("Astroem")&&(a.vmalloc=Astroem.vmalloc,a.vfree=Astroem.vfree,a.vheap=Astroem.vheap,a.vmemcpy=Astroem.vmemcpy,a.vfile=Astroem.vfile,a.vunlink=Astroem.vunlink,a.arrfile=Astroem.arrfile,a.listhdu=Astroem.listhdu,a.initwcs=Astroem.initwcs,a.wcsinfo=Astroem.wcsinfo,a.wcssys=Astroem.wcssys,a.wcsunits=Astroem.wcsunits,a.pix2wcs=
Astroem.pix2wcs,a.wcs2pix=Astroem.wcs2pix,a.reg2wcs=Astroem.reg2wcs,a.saostrtod=Astroem.saostrtod,a.saodtype=Astroem.saodtype,a.zscale=Astroem.zscale,a.tanhdr=Astroem.tanhdr,a.reproject=Astroem.reproject);window.hasOwnProperty("Fitsy")?(a.fitsLibrary("fitsy"),a.fits=Fitsy):window.hasOwnProperty("Astroem")&&(a.fitsLibrary("cfitsio"),a.fits=Astroem);$("div.JS9").each(function(){a.checkNew(new a.Display($(this)))});a.RegisterPlugin(a.MouseTouch.CLASS,a.MouseTouch.NAME,a.MouseTouch.init,{menuItem:"Mouse/Touch",
onplugindisplay:a.MouseTouch.init,help:"help/mousetouch.html",winTitle:"Mouse/Touch Actions",winResize:!0,winDims:[a.MouseTouch.WIDTH,a.MouseTouch.HEIGHT]});a.RegisterPlugin(a.Regions.CLASS,a.Regions.NAME,a.Regions.init,{onregionschange:a.Regions.onchange,divArgs:["regions"],winDims:[0,0]});a.instantiatePlugins();a.plugins.sort(function(a,b){var c=a.opts.menuItem,d=b.opts.menuItem;return!c?1:!d||c<d?-1:c>d?1:0});a.checkNew(new a.Colormap("grey",[[0,0],[1,1]],[[0,0],[1,1]],[[0,0],[1,1]]));a.checkNew(new a.Colormap("red",
[[0,0],[1,1]],[[0,0],[0,0]],[[0,0],[0,0]]));a.checkNew(new a.Colormap("green",[[0,0],[0,0]],[[0,0],[1,1]],[[0,0],[0,0]]));a.checkNew(new a.Colormap("blue",[[0,0],[0,0]],[[0,0],[0,0]],[[0,0],[1,1]]));a.checkNew(new a.Colormap("heat",[[0,0],[0.34,1],[1,1]],[[0,0],[1,1]],[[0,0],[0.65,0],[0.98,1],[1,1]]));a.checkNew(new a.Colormap("cool",[[0,0],[0.29,0],[0.76,0.1],[1,1]],[[0,0],[0.22,0],[0.96,1],[1,1]],[[0,0],[0.53,1],[1,1]]));a.checkNew(new a.Colormap("viridis",[[0.267004,0.004874,0.329415],[0.26851,
0.009605,0.335427],[0.269944,0.014625,0.341379],[0.271305,0.019942,0.347269],[0.272594,0.025563,0.353093],[0.273809,0.031497,0.358853],[0.274952,0.037752,0.364543],[0.276022,0.044167,0.370164],[0.277018,0.050344,0.375715],[0.277941,0.056324,0.381191],[0.278791,0.062145,0.386592],[0.279566,0.067836,0.391917],[0.280267,0.073417,0.397163],[0.280894,0.078907,0.402329],[0.281446,0.08432,0.407414],[0.281924,0.089666,0.412415],[0.282327,0.094955,0.417331],[0.282656,0.100196,0.42216],[0.28291,0.105393,0.426902],
[0.283091,0.110553,0.431554],[0.283197,0.11568,0.436115],[0.283229,0.120777,0.440584],[0.283187,0.125848,0.44496],[0.283072,0.130895,0.449241],[0.282884,0.13592,0.453427],[0.282623,0.140926,0.457517],[0.28229,0.145912,0.46151],[0.281887,0.150881,0.465405],[0.281412,0.155834,0.469201],[0.280868,0.160771,0.472899],[0.280255,0.165693,0.476498],[0.279574,0.170599,0.479997],[0.278826,0.17549,0.483397],[0.278012,0.180367,0.486697],[0.277134,0.185228,0.489898],[0.276194,0.190074,0.493001],[0.275191,0.194905,
0.496005],[0.274128,0.199721,0.498911],[0.273006,0.20452,0.501721],[0.271828,0.209303,0.504434],[0.270595,0.214069,0.507052],[0.269308,0.218818,0.509577],[0.267968,0.223549,0.512008],[0.26658,0.228262,0.514349],[0.265145,0.232956,0.516599],[0.263663,0.237631,0.518762],[0.262138,0.242286,0.520837],[0.260571,0.246922,0.522828],[0.258965,0.251537,0.524736],[0.257322,0.25613,0.526563],[0.255645,0.260703,0.528312],[0.253935,0.265254,0.529983],[0.252194,0.269783,0.531579],[0.250425,0.27429,0.533103],[0.248629,
0.278775,0.534556],[0.246811,0.283237,0.535941],[0.244972,0.287675,0.53726],[0.243113,0.292092,0.538516],[0.241237,0.296485,0.539709],[0.239346,0.300855,0.540844],[0.237441,0.305202,0.541921],[0.235526,0.309527,0.542944],[0.233603,0.313828,0.543914],[0.231674,0.318106,0.544834],[0.229739,0.322361,0.545706],[0.227802,0.326594,0.546532],[0.225863,0.330805,0.547314],[0.223925,0.334994,0.548053],[0.221989,0.339161,0.548752],[0.220057,0.343307,0.549413],[0.21813,0.347432,0.550038],[0.21621,0.351535,0.550627],
[0.214298,0.355619,0.551184],[0.212395,0.359683,0.55171],[0.210503,0.363727,0.552206],[0.208623,0.367752,0.552675],[0.206756,0.371758,0.553117],[0.204903,0.375746,0.553533],[0.203063,0.379716,0.553925],[0.201239,0.38367,0.554294],[0.19943,0.387607,0.554642],[0.197636,0.391528,0.554969],[0.19586,0.395433,0.555276],[0.1941,0.399323,0.555565],[0.192357,0.403199,0.555836],[0.190631,0.407061,0.556089],[0.188923,0.41091,0.556326],[0.187231,0.414746,0.556547],[0.185556,0.41857,0.556753],[0.183898,0.422383,
0.556944],[0.182256,0.426184,0.55712],[0.180629,0.429975,0.557282],[0.179019,0.433756,0.55743],[0.177423,0.437527,0.557565],[0.175841,0.44129,0.557685],[0.174274,0.445044,0.557792],[0.172719,0.448791,0.557885],[0.171176,0.45253,0.557965],[0.169646,0.456262,0.55803],[0.168126,0.459988,0.558082],[0.166617,0.463708,0.558119],[0.165117,0.467423,0.558141],[0.163625,0.471133,0.558148],[0.162142,0.474838,0.55814],[0.160665,0.47854,0.558115],[0.159194,0.482237,0.558073],[0.157729,0.485932,0.558013],[0.15627,
0.489624,0.557936],[0.154815,0.493313,0.55784],[0.153364,0.497,0.557724],[0.151918,0.500685,0.557587],[0.150476,0.504369,0.55743],[0.149039,0.508051,0.55725],[0.147607,0.511733,0.557049],[0.14618,0.515413,0.556823],[0.144759,0.519093,0.556572],[0.143343,0.522773,0.556295],[0.141935,0.526453,0.555991],[0.140536,0.530132,0.555659],[0.139147,0.533812,0.555298],[0.13777,0.537492,0.554906],[0.136408,0.541173,0.554483],[0.135066,0.544853,0.554029],[0.133743,0.548535,0.553541],[0.132444,0.552216,0.553018],
[0.131172,0.555899,0.552459],[0.129933,0.559582,0.551864],[0.128729,0.563265,0.551229],[0.127568,0.566949,0.550556],[0.126453,0.570633,0.549841],[0.125394,0.574318,0.549086],[0.124395,0.578002,0.548287],[0.123463,0.581687,0.547445],[0.122606,0.585371,0.546557],[0.121831,0.589055,0.545623],[0.121148,0.592739,0.544641],[0.120565,0.596422,0.543611],[0.120092,0.600104,0.54253],[0.119738,0.603785,0.5414],[0.119512,0.607464,0.540218],[0.119423,0.611141,0.538982],[0.119483,0.614817,0.537692],[0.119699,0.61849,
0.536347],[0.120081,0.622161,0.534946],[0.120638,0.625828,0.533488],[0.12138,0.629492,0.531973],[0.122312,0.633153,0.530398],[0.123444,0.636809,0.528763],[0.12478,0.640461,0.527068],[0.126326,0.644107,0.525311],[0.128087,0.647749,0.523491],[0.130067,0.651384,0.521608],[0.132268,0.655014,0.519661],[0.134692,0.658636,0.517649],[0.137339,0.662252,0.515571],[0.14021,0.665859,0.513427],[0.143303,0.669459,0.511215],[0.146616,0.67305,0.508936],[0.150148,0.676631,0.506589],[0.153894,0.680203,0.504172],[0.157851,
0.683765,0.501686],[0.162016,0.687316,0.499129],[0.166383,0.690856,0.496502],[0.170948,0.694384,0.493803],[0.175707,0.6979,0.491033],[0.180653,0.701402,0.488189],[0.185783,0.704891,0.485273],[0.19109,0.708366,0.482284],[0.196571,0.711827,0.479221],[0.202219,0.715272,0.476084],[0.20803,0.718701,0.472873],[0.214,0.722114,0.469588],[0.220124,0.725509,0.466226],[0.226397,0.728888,0.462789],[0.232815,0.732247,0.459277],[0.239374,0.735588,0.455688],[0.24607,0.73891,0.452024],[0.252899,0.742211,0.448284],
[0.259857,0.745492,0.444467],[0.266941,0.748751,0.440573],[0.274149,0.751988,0.436601],[0.281477,0.755203,0.432552],[0.288921,0.758394,0.428426],[0.296479,0.761561,0.424223],[0.304148,0.764704,0.419943],[0.311925,0.767822,0.415586],[0.319809,0.770914,0.411152],[0.327796,0.77398,0.40664],[0.335885,0.777018,0.402049],[0.344074,0.780029,0.397381],[0.35236,0.783011,0.392636],[0.360741,0.785964,0.387814],[0.369214,0.788888,0.382914],[0.377779,0.791781,0.377939],[0.386433,0.794644,0.372886],[0.395174,0.797475,
0.367757],[0.404001,0.800275,0.362552],[0.412913,0.803041,0.357269],[0.421908,0.805774,0.35191],[0.430983,0.808473,0.346476],[0.440137,0.811138,0.340967],[0.449368,0.813768,0.335384],[0.458674,0.816363,0.329727],[0.468053,0.818921,0.323998],[0.477504,0.821444,0.318195],[0.487026,0.823929,0.312321],[0.496615,0.826376,0.306377],[0.506271,0.828786,0.300362],[0.515992,0.831158,0.294279],[0.525776,0.833491,0.288127],[0.535621,0.835785,0.281908],[0.545524,0.838039,0.275626],[0.555484,0.840254,0.269281],
[0.565498,0.84243,0.262877],[0.575563,0.844566,0.256415],[0.585678,0.846661,0.249897],[0.595839,0.848717,0.243329],[0.606045,0.850733,0.236712],[0.616293,0.852709,0.230052],[0.626579,0.854645,0.223353],[0.636902,0.856542,0.21662],[0.647257,0.8584,0.209861],[0.657642,0.860219,0.203082],[0.668054,0.861999,0.196293],[0.678489,0.863742,0.189503],[0.688944,0.865448,0.182725],[0.699415,0.867117,0.175971],[0.709898,0.868751,0.169257],[0.720391,0.87035,0.162603],[0.730889,0.871916,0.156029],[0.741388,0.873449,
0.149561],[0.751884,0.874951,0.143228],[0.762373,0.876424,0.137064],[0.772852,0.877868,0.131109],[0.783315,0.879285,0.125405],[0.79376,0.880678,0.120005],[0.804182,0.882046,0.114965],[0.814576,0.883393,0.110347],[0.82494,0.88472,0.106217],[0.83527,0.886029,0.102646],[0.845561,0.887322,0.099702],[0.85581,0.888601,0.097452],[0.866013,0.889868,0.095953],[0.876168,0.891125,0.09525],[0.886271,0.892374,0.095374],[0.89632,0.893616,0.096335],[0.906311,0.894855,0.098125],[0.916242,0.896091,0.100717],[0.926106,
0.89733,0.104071],[0.935904,0.89857,0.108131],[0.945636,0.899815,0.112838],[0.9553,0.901065,0.118128],[0.964894,0.902323,0.123941],[0.974417,0.90359,0.130215],[0.983868,0.904867,0.136897],[0.993248,0.906157,0.143936]]));a.checkNew(new a.Colormap("magma",[[0.001462,4.66E-4,0.013866],[0.002258,0.001295,0.018331],[0.003279,0.002305,0.023708],[0.004512,0.00349,0.029965],[0.00595,0.004843,0.03713],[0.007588,0.006356,0.044973],[0.009426,0.008022,0.052844],[0.011465,0.009828,0.06075],[0.013708,0.011771,
0.068667],[0.016156,0.01384,0.076603],[0.018815,0.016026,0.084584],[0.021692,0.01832,0.09261],[0.024792,0.020715,0.100676],[0.028123,0.023201,0.108787],[0.031696,0.025765,0.116965],[0.03552,0.028397,0.125209],[0.039608,0.03109,0.133515],[0.04383,0.03383,0.141886],[0.048062,0.036607,0.150327],[0.05232,0.039407,0.158841],[0.056615,0.04216,0.167446],[0.060949,0.044794,0.176129],[0.06533,0.047318,0.184892],[0.069764,0.049726,0.193735],[0.074257,0.052017,0.20266],[0.078815,0.054184,0.211667],[0.083446,
0.056225,0.220755],[0.088155,0.058133,0.229922],[0.092949,0.059904,0.239164],[0.097833,0.061531,0.248477],[0.102815,0.06301,0.257854],[0.107899,0.064335,0.267289],[0.113094,0.065492,0.276784],[0.118405,0.066479,0.286321],[0.123833,0.067295,0.295879],[0.12938,0.067935,0.305443],[0.135053,0.068391,0.315],[0.140858,0.068654,0.324538],[0.146785,0.068738,0.334011],[0.152839,0.068637,0.343404],[0.159018,0.068354,0.352688],[0.165308,0.067911,0.361816],[0.171713,0.067305,0.370771],[0.178212,0.066576,0.379497],
[0.184801,0.065732,0.387973],[0.19146,0.064818,0.396152],[0.198177,0.063862,0.404009],[0.204935,0.062907,0.411514],[0.211718,0.061992,0.418647],[0.218512,0.061158,0.425392],[0.225302,0.060445,0.431742],[0.232077,0.059889,0.437695],[0.238826,0.059517,0.443256],[0.245543,0.059352,0.448436],[0.25222,0.059415,0.453248],[0.258857,0.059706,0.45771],[0.265447,0.060237,0.46184],[0.271994,0.060994,0.46566],[0.278493,0.061978,0.46919],[0.284951,0.063168,0.472451],[0.291366,0.064553,0.475462],[0.29774,0.066117,
0.478243],[0.304081,0.067835,0.480812],[0.310382,0.069702,0.483186],[0.316654,0.07169,0.48538],[0.322899,0.073782,0.487408],[0.329114,0.075972,0.489287],[0.335308,0.078236,0.491024],[0.341482,0.080564,0.492631],[0.347636,0.082946,0.494121],[0.353773,0.085373,0.495501],[0.359898,0.087831,0.496778],[0.366012,0.090314,0.49796],[0.372116,0.092816,0.499053],[0.378211,0.095332,0.500067],[0.384299,0.097855,0.501002],[0.390384,0.100379,0.501864],[0.396467,0.102902,0.502658],[0.402548,0.10542,0.503386],[0.408629,
0.10793,0.504052],[0.414709,0.110431,0.504662],[0.420791,0.11292,0.505215],[0.426877,0.115395,0.505714],[0.432967,0.117855,0.50616],[0.439062,0.120298,0.506555],[0.445163,0.122724,0.506901],[0.451271,0.125132,0.507198],[0.457386,0.127522,0.507448],[0.463508,0.129893,0.507652],[0.46964,0.132245,0.507809],[0.47578,0.134577,0.507921],[0.481929,0.136891,0.507989],[0.488088,0.139186,0.508011],[0.494258,0.141462,0.507988],[0.500438,0.143719,0.50792],[0.506629,0.145958,0.507806],[0.512831,0.148179,0.507648],
[0.519045,0.150383,0.507443],[0.52527,0.152569,0.507192],[0.531507,0.154739,0.506895],[0.537755,0.156894,0.506551],[0.544015,0.159033,0.506159],[0.550287,0.161158,0.505719],[0.556571,0.163269,0.50523],[0.562866,0.165368,0.504692],[0.569172,0.167454,0.504105],[0.57549,0.16953,0.503466],[0.581819,0.171596,0.502777],[0.588158,0.173652,0.502035],[0.594508,0.175701,0.501241],[0.600868,0.177743,0.500394],[0.607238,0.179779,0.499492],[0.613617,0.181811,0.498536],[0.620005,0.18384,0.497524],[0.626401,0.185867,
0.496456],[0.632805,0.187893,0.495332],[0.639216,0.189921,0.49415],[0.645633,0.191952,0.49291],[0.652056,0.193986,0.491611],[0.658483,0.196027,0.490253],[0.664915,0.198075,0.488836],[0.671349,0.200133,0.487358],[0.677786,0.202203,0.485819],[0.684224,0.204286,0.484219],[0.690661,0.206384,0.482558],[0.697098,0.208501,0.480835],[0.703532,0.210638,0.479049],[0.709962,0.212797,0.477201],[0.716387,0.214982,0.47529],[0.722805,0.217194,0.473316],[0.729216,0.219437,0.471279],[0.735616,0.221713,0.46918],[0.742004,
0.224025,0.467018],[0.748378,0.226377,0.464794],[0.754737,0.228772,0.462509],[0.761077,0.231214,0.460162],[0.767398,0.233705,0.457755],[0.773695,0.236249,0.455289],[0.779968,0.238851,0.452765],[0.786212,0.241514,0.450184],[0.792427,0.244242,0.447543],[0.798608,0.24704,0.444848],[0.804752,0.249911,0.442102],[0.810855,0.252861,0.439305],[0.816914,0.255895,0.436461],[0.822926,0.259016,0.433573],[0.828886,0.262229,0.430644],[0.834791,0.26554,0.427671],[0.840636,0.268953,0.424666],[0.846416,0.272473,0.421631],
[0.852126,0.276106,0.418573],[0.857763,0.279857,0.415496],[0.86332,0.283729,0.412403],[0.868793,0.287728,0.409303],[0.874176,0.291859,0.406205],[0.879464,0.296125,0.403118],[0.884651,0.30053,0.400047],[0.889731,0.305079,0.397002],[0.8947,0.309773,0.393995],[0.899552,0.314616,0.391037],[0.904281,0.31961,0.388137],[0.908884,0.324755,0.385308],[0.913354,0.330052,0.382563],[0.917689,0.3355,0.379915],[0.921884,0.341098,0.377376],[0.925937,0.346844,0.374959],[0.929845,0.352734,0.372677],[0.933606,0.358764,
0.370541],[0.937221,0.364929,0.368567],[0.940687,0.371224,0.366762],[0.944006,0.377643,0.365136],[0.94718,0.384178,0.363701],[0.95021,0.39082,0.362468],[0.953099,0.397563,0.361438],[0.955849,0.4044,0.360619],[0.958464,0.411324,0.360014],[0.960949,0.418323,0.35963],[0.96331,0.42539,0.359469],[0.965549,0.432519,0.359529],[0.967671,0.439703,0.35981],[0.96968,0.446936,0.360311],[0.971582,0.45421,0.36103],[0.973381,0.46152,0.361965],[0.975082,0.468861,0.363111],[0.97669,0.476226,0.364466],[0.97821,0.483612,
0.366025],[0.979645,0.491014,0.367783],[0.981,0.498428,0.369734],[0.982279,0.505851,0.371874],[0.983485,0.51328,0.374198],[0.984622,0.520713,0.376698],[0.985693,0.528148,0.379371],[0.9867,0.535582,0.38221],[0.987646,0.543015,0.38521],[0.988533,0.550446,0.388365],[0.989363,0.557873,0.391671],[0.990138,0.565296,0.395122],[0.990871,0.572706,0.398714],[0.991558,0.580107,0.402441],[0.992196,0.587502,0.406299],[0.992785,0.594891,0.410283],[0.993326,0.602275,0.41439],[0.993834,0.609644,0.418613],[0.994309,
0.616999,0.42295],[0.994738,0.62435,0.427397],[0.995122,0.631696,0.431951],[0.99548,0.639027,0.436607],[0.99581,0.646344,0.441361],[0.996096,0.653659,0.446213],[0.996341,0.660969,0.45116],[0.99658,0.668256,0.456192],[0.996775,0.675541,0.461314],[0.996925,0.682828,0.466526],[0.997077,0.690088,0.471811],[0.997186,0.697349,0.477182],[0.997254,0.704611,0.482635],[0.997325,0.711848,0.488154],[0.997351,0.719089,0.493755],[0.997351,0.726324,0.499428],[0.997341,0.733545,0.505167],[0.997285,0.740772,0.510983],
[0.997228,0.747981,0.516859],[0.997138,0.75519,0.522806],[0.997019,0.762398,0.528821],[0.996898,0.769591,0.534892],[0.996727,0.776795,0.541039],[0.996571,0.783977,0.547233],[0.996369,0.791167,0.553499],[0.996162,0.798348,0.55982],[0.995932,0.805527,0.566202],[0.99568,0.812706,0.572645],[0.995424,0.819875,0.57914],[0.995131,0.827052,0.585701],[0.994851,0.834213,0.592307],[0.994524,0.841387,0.598983],[0.994222,0.84854,0.605696],[0.993866,0.855711,0.612482],[0.993545,0.862859,0.619299],[0.99317,0.870024,
0.626189],[0.992831,0.877168,0.633109],[0.99244,0.88433,0.640099],[0.992089,0.89147,0.647116],[0.991688,0.898627,0.654202],[0.991332,0.905763,0.661309],[0.99093,0.912915,0.668481],[0.99057,0.920049,0.675675],[0.990175,0.927196,0.682926],[0.989815,0.934329,0.690198],[0.989434,0.94147,0.697519],[0.989077,0.948604,0.704863],[0.988717,0.955742,0.712242],[0.988367,0.962878,0.719649],[0.988033,0.970012,0.727077],[0.987691,0.977154,0.734536],[0.987387,0.984288,0.742002],[0.987053,0.991438,0.749504]]));a.checkNew(new a.Colormap("inferno",
[[0.001462,4.66E-4,0.013866],[0.002267,0.00127,0.01857],[0.003299,0.002249,0.024239],[0.004547,0.003392,0.030909],[0.006006,0.004692,0.038558],[0.007676,0.006136,0.046836],[0.009561,0.007713,0.055143],[0.011663,0.009417,0.06346],[0.013995,0.011225,0.071862],[0.016561,0.013136,0.080282],[0.019373,0.015133,0.088767],[0.022447,0.017199,0.097327],[0.025793,0.019331,0.10593],[0.029432,0.021503,0.114621],[0.033385,0.023702,0.123397],[0.037668,0.025921,0.132232],[0.042253,0.028139,0.141141],[0.046915,0.030324,
0.150164],[0.051644,0.032474,0.159254],[0.056449,0.034569,0.168414],[0.06134,0.03659,0.177642],[0.066331,0.038504,0.186962],[0.071429,0.040294,0.196354],[0.076637,0.041905,0.205799],[0.081962,0.043328,0.215289],[0.087411,0.044556,0.224813],[0.09299,0.045583,0.234358],[0.098702,0.046402,0.243904],[0.104551,0.047008,0.25343],[0.110536,0.047399,0.262912],[0.116656,0.047574,0.272321],[0.122908,0.047536,0.281624],[0.129285,0.047293,0.290788],[0.135778,0.046856,0.299776],[0.142378,0.046242,0.308553],[0.149073,
0.045468,0.317085],[0.15585,0.044559,0.325338],[0.162689,0.043554,0.333277],[0.169575,0.042489,0.340874],[0.176493,0.041402,0.348111],[0.183429,0.040329,0.354971],[0.190367,0.039309,0.361447],[0.197297,0.0384,0.367535],[0.204209,0.037632,0.373238],[0.211095,0.03703,0.378563],[0.217949,0.036615,0.383522],[0.224763,0.036405,0.388129],[0.231538,0.036405,0.3924],[0.238273,0.036621,0.396353],[0.244967,0.037055,0.400007],[0.25162,0.037705,0.403378],[0.258234,0.038571,0.406485],[0.26481,0.039647,0.409345],
[0.271347,0.040922,0.411976],[0.27785,0.042353,0.414392],[0.284321,0.043933,0.416608],[0.290763,0.045644,0.418637],[0.297178,0.04747,0.420491],[0.303568,0.049396,0.422182],[0.309935,0.051407,0.423721],[0.316282,0.05349,0.425116],[0.32261,0.055634,0.426377],[0.328921,0.057827,0.427511],[0.335217,0.06006,0.428524],[0.3415,0.062325,0.429425],[0.347771,0.064616,0.430217],[0.354032,0.066925,0.430906],[0.360284,0.069247,0.431497],[0.366529,0.071579,0.431994],[0.372768,0.073915,0.4324],[0.379001,0.076253,
0.432719],[0.385228,0.078591,0.432955],[0.391453,0.080927,0.433109],[0.397674,0.083257,0.433183],[0.403894,0.08558,0.433179],[0.410113,0.087896,0.433098],[0.416331,0.090203,0.432943],[0.422549,0.092501,0.432714],[0.428768,0.09479,0.432412],[0.434987,0.097069,0.432039],[0.441207,0.099338,0.431594],[0.447428,0.101597,0.43108],[0.453651,0.103848,0.430498],[0.459875,0.106089,0.429846],[0.4661,0.108322,0.429125],[0.472328,0.110547,0.428334],[0.478558,0.112764,0.427475],[0.484789,0.114974,0.426548],[0.491022,
0.117179,0.425552],[0.497257,0.119379,0.424488],[0.503493,0.121575,0.423356],[0.50973,0.123769,0.422156],[0.515967,0.12596,0.420887],[0.522206,0.12815,0.419549],[0.528444,0.130341,0.418142],[0.534683,0.132534,0.416667],[0.54092,0.134729,0.415123],[0.547157,0.136929,0.413511],[0.553392,0.139134,0.411829],[0.559624,0.141346,0.410078],[0.565854,0.143567,0.408258],[0.572081,0.145797,0.406369],[0.578304,0.148039,0.404411],[0.584521,0.150294,0.402385],[0.590734,0.152563,0.40029],[0.59694,0.154848,0.398125],
[0.603139,0.157151,0.395891],[0.60933,0.159474,0.393589],[0.615513,0.161817,0.391219],[0.621685,0.164184,0.388781],[0.627847,0.166575,0.386276],[0.633998,0.168992,0.383704],[0.640135,0.171438,0.381065],[0.64626,0.173914,0.378359],[0.652369,0.176421,0.375586],[0.658463,0.178962,0.372748],[0.66454,0.181539,0.369846],[0.670599,0.184153,0.366879],[0.676638,0.186807,0.363849],[0.682656,0.189501,0.360757],[0.688653,0.192239,0.357603],[0.694627,0.195021,0.354388],[0.700576,0.197851,0.351113],[0.7065,0.200728,
0.347777],[0.712396,0.203656,0.344383],[0.718264,0.206636,0.340931],[0.724103,0.20967,0.337424],[0.729909,0.212759,0.333861],[0.735683,0.215906,0.330245],[0.741423,0.219112,0.326576],[0.747127,0.222378,0.322856],[0.752794,0.225706,0.319085],[0.758422,0.229097,0.315266],[0.76401,0.232554,0.311399],[0.769556,0.236077,0.307485],[0.775059,0.239667,0.303526],[0.780517,0.243327,0.299523],[0.785929,0.247056,0.295477],[0.791293,0.250856,0.29139],[0.796607,0.254728,0.287264],[0.801871,0.258674,0.283099],[0.807082,
0.262692,0.278898],[0.812239,0.266786,0.274661],[0.817341,0.270954,0.27039],[0.822386,0.275197,0.266085],[0.827372,0.279517,0.26175],[0.832299,0.283913,0.257383],[0.837165,0.288385,0.252988],[0.841969,0.292933,0.248564],[0.846709,0.297559,0.244113],[0.851384,0.30226,0.239636],[0.855992,0.307038,0.235133],[0.860533,0.311892,0.230606],[0.865006,0.316822,0.226055],[0.869409,0.321827,0.221482],[0.873741,0.326906,0.216886],[0.878001,0.33206,0.212268],[0.882188,0.337287,0.207628],[0.886302,0.342586,0.202968],
[0.890341,0.347957,0.198286],[0.894305,0.353399,0.193584],[0.898192,0.358911,0.18886],[0.902003,0.364492,0.184116],[0.905735,0.37014,0.17935],[0.90939,0.375856,0.174563],[0.912966,0.381636,0.169755],[0.916462,0.387481,0.164924],[0.919879,0.393389,0.16007],[0.923215,0.399359,0.155193],[0.92647,0.405389,0.150292],[0.929644,0.411479,0.145367],[0.932737,0.417627,0.140417],[0.935747,0.423831,0.13544],[0.938675,0.430091,0.130438],[0.941521,0.436405,0.125409],[0.944285,0.442772,0.120354],[0.946965,0.449191,
0.115272],[0.949562,0.45566,0.110164],[0.952075,0.462178,0.105031],[0.954506,0.468744,0.099874],[0.956852,0.475356,0.094695],[0.959114,0.482014,0.089499],[0.961293,0.488716,0.084289],[0.963387,0.495462,0.079073],[0.965397,0.502249,0.073859],[0.967322,0.509078,0.068659],[0.969163,0.515946,0.063488],[0.970919,0.522853,0.058367],[0.97259,0.529798,0.053324],[0.974176,0.53678,0.048392],[0.975677,0.543798,0.043618],[0.977092,0.55085,0.03905],[0.978422,0.557937,0.034931],[0.979666,0.565057,0.031409],[0.980824,
0.572209,0.028508],[0.981895,0.579392,0.02625],[0.982881,0.586606,0.024661],[0.983779,0.593849,0.02377],[0.984591,0.601122,0.023606],[0.985315,0.608422,0.024202],[0.985952,0.61575,0.025592],[0.986502,0.623105,0.027814],[0.986964,0.630485,0.030908],[0.987337,0.63789,0.034916],[0.987622,0.64532,0.039886],[0.987819,0.652773,0.045581],[0.987926,0.66025,0.05175],[0.987945,0.667748,0.058329],[0.987874,0.675267,0.065257],[0.987714,0.682807,0.072489],[0.987464,0.690366,0.07999],[0.987124,0.697944,0.087731],
[0.986694,0.70554,0.095694],[0.986175,0.713153,0.103863],[0.985566,0.720782,0.112229],[0.984865,0.728427,0.120785],[0.984075,0.736087,0.129527],[0.983196,0.743758,0.138453],[0.982228,0.751442,0.147565],[0.981173,0.759135,0.156863],[0.980032,0.766837,0.166353],[0.978806,0.774545,0.176037],[0.977497,0.782258,0.185923],[0.976108,0.789974,0.196018],[0.974638,0.797692,0.206332],[0.973088,0.805409,0.216877],[0.971468,0.813122,0.227658],[0.969783,0.820825,0.238686],[0.968041,0.828515,0.249972],[0.966243,
0.836191,0.261534],[0.964394,0.843848,0.273391],[0.962517,0.851476,0.285546],[0.960626,0.859069,0.29801],[0.95872,0.866624,0.31082],[0.956834,0.874129,0.323974],[0.954997,0.881569,0.337475],[0.953215,0.888942,0.351369],[0.951546,0.896226,0.365627],[0.950018,0.903409,0.380271],[0.948683,0.910473,0.395289],[0.947594,0.917399,0.410665],[0.946809,0.924168,0.426373],[0.946392,0.930761,0.442367],[0.946403,0.937159,0.458592],[0.946903,0.943348,0.47497],[0.947937,0.949318,0.491426],[0.949545,0.955063,0.50786],
[0.95174,0.960587,0.524203],[0.954529,0.965896,0.540361],[0.957896,0.971003,0.556275],[0.961812,0.975924,0.571925],[0.966249,0.980678,0.587206],[0.971162,0.985282,0.602154],[0.976511,0.989753,0.61676],[0.982257,0.994109,0.631017],[0.988362,0.998364,0.644924]]));a.checkNew(new a.Colormap("plasma",[[0.050383,0.029803,0.527975],[0.063536,0.028426,0.533124],[0.075353,0.027206,0.538007],[0.086222,0.026125,0.542658],[0.096379,0.025165,0.547103],[0.10598,0.024309,0.551368],[0.115124,0.023556,0.555468],[0.123903,
0.022878,0.559423],[0.132381,0.022258,0.56325],[0.140603,0.021687,0.566959],[0.148607,0.021154,0.570562],[0.156421,0.020651,0.574065],[0.16407,0.020171,0.577478],[0.171574,0.019706,0.580806],[0.17895,0.019252,0.584054],[0.186213,0.018803,0.587228],[0.193374,0.018354,0.59033],[0.200445,0.017902,0.593364],[0.207435,0.017442,0.596333],[0.21435,0.016973,0.599239],[0.221197,0.016497,0.602083],[0.227983,0.016007,0.604867],[0.234715,0.015502,0.607592],[0.241396,0.014979,0.610259],[0.248032,0.014439,0.612868],
[0.254627,0.013882,0.615419],[0.261183,0.013308,0.617911],[0.267703,0.012716,0.620346],[0.274191,0.012109,0.622722],[0.280648,0.011488,0.625038],[0.287076,0.010855,0.627295],[0.293478,0.010213,0.62949],[0.299855,0.009561,0.631624],[0.30621,0.008902,0.633694],[0.312543,0.008239,0.6357],[0.318856,0.007576,0.63764],[0.32515,0.006915,0.639512],[0.331426,0.006261,0.641316],[0.337683,0.005618,0.643049],[0.343925,0.004991,0.64471],[0.35015,0.004382,0.646298],[0.356359,0.003798,0.64781],[0.362553,0.003243,
0.649245],[0.368733,0.002724,0.650601],[0.374897,0.002245,0.651876],[0.381047,0.001814,0.653068],[0.387183,0.001434,0.654177],[0.393304,0.001114,0.655199],[0.399411,8.59E-4,0.656133],[0.405503,6.78E-4,0.656977],[0.41158,5.77E-4,0.65773],[0.417642,5.64E-4,0.65839],[0.423689,6.46E-4,0.658956],[0.429719,8.31E-4,0.659425],[0.435734,0.001127,0.659797],[0.441732,0.00154,0.660069],[0.447714,0.00208,0.66024],[0.453677,0.002755,0.66031],[0.459623,0.003574,0.660277],[0.46555,0.004545,0.660139],[0.471457,0.005678,
0.659897],[0.477344,0.00698,0.659549],[0.48321,0.00846,0.659095],[0.489055,0.010127,0.658534],[0.494877,0.01199,0.657865],[0.500678,0.014055,0.657088],[0.506454,0.016333,0.656202],[0.512206,0.018833,0.655209],[0.517933,0.021563,0.654109],[0.523633,0.024532,0.652901],[0.529306,0.027747,0.651586],[0.534952,0.031217,0.650165],[0.54057,0.03495,0.64864],[0.546157,0.038954,0.64701],[0.551715,0.043136,0.645277],[0.557243,0.047331,0.643443],[0.562738,0.051545,0.641509],[0.568201,0.055778,0.639477],[0.573632,
0.060028,0.637349],[0.579029,0.064296,0.635126],[0.584391,0.068579,0.632812],[0.589719,0.072878,0.630408],[0.595011,0.07719,0.627917],[0.600266,0.081516,0.625342],[0.605485,0.085854,0.622686],[0.610667,0.090204,0.619951],[0.615812,0.094564,0.61714],[0.620919,0.098934,0.614257],[0.625987,0.103312,0.611305],[0.631017,0.107699,0.608287],[0.636008,0.112092,0.605205],[0.640959,0.116492,0.602065],[0.645872,0.120898,0.598867],[0.650746,0.125309,0.595617],[0.65558,0.129725,0.592317],[0.660374,0.134144,0.588971],
[0.665129,0.138566,0.585582],[0.669845,0.142992,0.582154],[0.674522,0.147419,0.578688],[0.67916,0.151848,0.575189],[0.683758,0.156278,0.57166],[0.688318,0.160709,0.568103],[0.69284,0.165141,0.564522],[0.697324,0.169573,0.560919],[0.701769,0.174005,0.557296],[0.706178,0.178437,0.553657],[0.710549,0.182868,0.550004],[0.714883,0.187299,0.546338],[0.719181,0.191729,0.542663],[0.723444,0.196158,0.538981],[0.72767,0.200586,0.535293],[0.731862,0.205013,0.531601],[0.736019,0.209439,0.527908],[0.740143,0.213864,
0.524216],[0.744232,0.218288,0.520524],[0.748289,0.222711,0.516834],[0.752312,0.227133,0.513149],[0.756304,0.231555,0.509468],[0.760264,0.235976,0.505794],[0.764193,0.240396,0.502126],[0.76809,0.244817,0.498465],[0.771958,0.249237,0.494813],[0.775796,0.253658,0.491171],[0.779604,0.258078,0.487539],[0.783383,0.2625,0.483918],[0.787133,0.266922,0.480307],[0.790855,0.271345,0.476706],[0.794549,0.27577,0.473117],[0.798216,0.280197,0.469538],[0.801855,0.284626,0.465971],[0.805467,0.289057,0.462415],[0.809052,
0.293491,0.45887],[0.812612,0.297928,0.455338],[0.816144,0.302368,0.451816],[0.819651,0.306812,0.448306],[0.823132,0.311261,0.444806],[0.826588,0.315714,0.441316],[0.830018,0.320172,0.437836],[0.833422,0.324635,0.434366],[0.836801,0.329105,0.430905],[0.840155,0.33358,0.427455],[0.843484,0.338062,0.424013],[0.846788,0.342551,0.420579],[0.850066,0.347048,0.417153],[0.853319,0.351553,0.413734],[0.856547,0.356066,0.410322],[0.85975,0.360588,0.406917],[0.862927,0.365119,0.403519],[0.866078,0.36966,0.400126],
[0.869203,0.374212,0.396738],[0.872303,0.378774,0.393355],[0.875376,0.383347,0.389976],[0.878423,0.387932,0.3866],[0.881443,0.392529,0.383229],[0.884436,0.397139,0.37986],[0.887402,0.401762,0.376494],[0.89034,0.406398,0.37313],[0.89325,0.411048,0.369768],[0.896131,0.415712,0.366407],[0.898984,0.420392,0.363047],[0.901807,0.425087,0.359688],[0.904601,0.429797,0.356329],[0.907365,0.434524,0.35297],[0.910098,0.439268,0.34961],[0.9128,0.444029,0.346251],[0.915471,0.448807,0.34289],[0.918109,0.453603,
0.339529],[0.920714,0.458417,0.336166],[0.923287,0.463251,0.332801],[0.925825,0.468103,0.329435],[0.928329,0.472975,0.326067],[0.930798,0.477867,0.322697],[0.933232,0.48278,0.319325],[0.93563,0.487712,0.315952],[0.93799,0.492667,0.312575],[0.940313,0.497642,0.309197],[0.942598,0.502639,0.305816],[0.944844,0.507658,0.302433],[0.947051,0.512699,0.299049],[0.949217,0.517763,0.295662],[0.951344,0.52285,0.292275],[0.953428,0.52796,0.288883],[0.95547,0.533093,0.28549],[0.957469,0.53825,0.282096],[0.959424,
0.543431,0.278701],[0.961336,0.548636,0.275305],[0.963203,0.553865,0.271909],[0.965024,0.559118,0.268513],[0.966798,0.564396,0.265118],[0.968526,0.5697,0.261721],[0.970205,0.575028,0.258325],[0.971835,0.580382,0.254931],[0.973416,0.585761,0.25154],[0.974947,0.591165,0.248151],[0.976428,0.596595,0.244767],[0.977856,0.602051,0.241387],[0.979233,0.607532,0.238013],[0.980556,0.613039,0.234646],[0.981826,0.618572,0.231287],[0.983041,0.624131,0.227937],[0.984199,0.629718,0.224595],[0.985301,0.63533,0.221265],
[0.986345,0.640969,0.217948],[0.987332,0.646633,0.214648],[0.98826,0.652325,0.211364],[0.989128,0.658043,0.2081],[0.989935,0.663787,0.204859],[0.990681,0.669558,0.201642],[0.991365,0.675355,0.198453],[0.991985,0.681179,0.195295],[0.992541,0.68703,0.19217],[0.993032,0.692907,0.189084],[0.993456,0.69881,0.186041],[0.993814,0.704741,0.183043],[0.994103,0.710698,0.180097],[0.994324,0.716681,0.177208],[0.994474,0.722691,0.174381],[0.994553,0.728728,0.171622],[0.994561,0.734791,0.168938],[0.994495,0.74088,
0.166335],[0.994355,0.746995,0.163821],[0.994141,0.753137,0.161404],[0.993851,0.759304,0.159092],[0.993482,0.765499,0.156891],[0.993033,0.77172,0.154808],[0.992505,0.777967,0.152855],[0.991897,0.784239,0.151042],[0.991209,0.790537,0.149377],[0.990439,0.796859,0.14787],[0.989587,0.803205,0.146529],[0.988648,0.809579,0.145357],[0.987621,0.815978,0.144363],[0.986509,0.822401,0.143557],[0.985314,0.828846,0.142945],[0.984031,0.835315,0.142528],[0.982653,0.841812,0.142303],[0.98119,0.848329,0.142279],[0.979644,
0.854866,0.142453],[0.977995,0.861432,0.142808],[0.976265,0.868016,0.143351],[0.974443,0.874622,0.144061],[0.97253,0.88125,0.144923],[0.970533,0.887896,0.145919],[0.968443,0.894564,0.147014],[0.966271,0.901249,0.14818],[0.964021,0.90795,0.14937],[0.961681,0.914672,0.15052],[0.959276,0.921407,0.151566],[0.956808,0.928152,0.152409],[0.954287,0.934908,0.152921],[0.951726,0.941671,0.152925],[0.949151,0.948435,0.152178],[0.946602,0.95519,0.150328],[0.944152,0.961916,0.146861],[0.941896,0.96859,0.140956],
[0.940015,0.975158,0.131326]]));a.checkNew(new a.Colormap("i8",[[0,0,0],[0,1,0],[0,0,1],[0,1,1],[1,0,0],[1,1,0],[1,0,1],[1,1,1]]));a.checkNew(new a.Colormap("aips0",[[0.196,0.196,0.196],[0.475,0,0.608],[0,0,0.785],[0.373,0.655,0.925],[0,0.596,0],[0,0.965,0],[1,1,0],[1,0.694,0],[1,0,0]]));a.checkNew(new a.Colormap("sls",[[0,0,0],[0.043442,0,0.052883],[0.086883,0,0.105767],[0.130325,0,0.15865],[0.173767,0,0.211533],[0.217208,0,0.264417],[0.26065,0,0.3173],[0.304092,0,0.370183],[0.347533,0,0.423067],
[0.390975,0,0.47595],[0.434417,0,0.528833],[0.477858,0,0.581717],[0.5213,0,0.6346],[0.506742,0,0.640217],[0.492183,0,0.645833],[0.477625,0,0.65145],[0.463067,0,0.657067],[0.448508,0,0.662683],[0.43395,0,0.6683],[0.419392,0,0.673917],[0.404833,0,0.679533],[0.390275,0,0.68515],[0.375717,0,0.690767],[0.361158,0,0.696383],[0.3466,0,0.702],[0.317717,0,0.712192],[0.288833,0,0.722383],[0.25995,0,0.732575],[0.231067,0,0.742767],[0.202183,0,0.752958],[0.1733,0,0.76315],[0.144417,0,0.773342],[0.115533,0,0.783533],
[0.08665,0,0.793725],[0.057767,0,0.803917],[0.028883,0,0.814108],[0,0,0.8243],[0,0.019817,0.838942],[0,0.039633,0.853583],[0,0.05945,0.868225],[0,0.079267,0.882867],[0,0.099083,0.897508],[0,0.1189,0.91215],[0,0.138717,0.926792],[0,0.158533,0.941433],[0,0.17835,0.956075],[0,0.198167,0.970717],[0,0.217983,0.985358],[0,0.2378,1],[0,0.268533,1],[0,0.299267,1],[0,0.33,1],[0,0.360733,1],[0,0.391467,1],[0,0.4222,1],[0,0.452933,1],[0,0.483667,1],[0,0.5144,1],[0,0.545133,1],[0,0.575867,1],[0,0.6066,1],[0,
0.631733,0.9753],[0,0.656867,0.9506],[0,0.682,0.9259],[0,0.707133,0.9012],[0,0.732267,0.8765],[0,0.7574,0.8518],[0,0.782533,0.8271],[0,0.807667,0.8024],[0,0.8328,0.7777],[0,0.857933,0.753],[0,0.883067,0.7283],[0,0.9082,0.7036],[0,0.901908,0.676675],[0,0.895617,0.64975],[0,0.889325,0.622825],[0,0.883033,0.5959],[0,0.876742,0.568975],[0,0.87045,0.54205],[0,0.864158,0.515125],[0,0.857867,0.4882],[0,0.851575,0.461275],[0,0.845283,0.43435],[0,0.838992,0.407425],[0,0.8327,0.3805],[0,0.832308,0.354858],
[0,0.831917,0.329217],[0,0.831525,0.303575],[0,0.831133,0.277933],[0,0.830742,0.252292],[0,0.83035,0.22665],[0,0.829958,0.201008],[0,0.829567,0.175367],[0,0.829175,0.149725],[0,0.828783,0.124083],[0,0.828392,0.098442],[0,0.828,0.0728],[0.033167,0.834167,0.066733],[0.066333,0.840333,0.060667],[0.0995,0.8465,0.0546],[0.132667,0.852667,0.048533],[0.165833,0.858833,0.042467],[0.199,0.865,0.0364],[0.232167,0.871167,0.030333],[0.265333,0.877333,0.024267],[0.2985,0.8835,0.0182],[0.331667,0.889667,0.012133],
[0.364833,0.895833,0.006067],[0.398,0.902,0],[0.43095,0.902,0],[0.4639,0.902,0],[0.49685,0.902,0],[0.5298,0.902,0],[0.56275,0.902,0],[0.5957,0.902,0],[0.62865,0.902,0],[0.6616,0.902,0],[0.69455,0.902,0],[0.7275,0.902,0],[0.76045,0.902,0],[0.7934,0.902,0],[0.810617,0.897133,0.003983],[0.827833,0.892267,0.007967],[0.84505,0.8874,0.01195],[0.862267,0.882533,0.015933],[0.879483,0.877667,0.019917],[0.8967,0.8728,0.0239],[0.913917,0.867933,0.027883],[0.931133,0.863067,0.031867],[0.94835,0.8582,0.03585],
[0.965567,0.853333,0.039833],[0.982783,0.848467,0.043817],[1,0.8436,0.0478],[0.995725,0.824892,0.0516],[0.99145,0.806183,0.0554],[0.987175,0.787475,0.0592],[0.9829,0.768767,0.063],[0.978625,0.750058,0.0668],[0.97435,0.73135,0.0706],[0.970075,0.712642,0.0744],[0.9658,0.693933,0.0782],[0.961525,0.675225,0.082],[0.95725,0.656517,0.0858],[0.952975,0.637808,0.0896],[0.9487,0.6191,0.0934],[0.952975,0.600408,0.085617],[0.95725,0.581717,0.077833],[0.961525,0.563025,0.07005],[0.9658,0.544333,0.062267],[0.970075,
0.525642,0.054483],[0.97435,0.50695,0.0467],[0.978625,0.488258,0.038917],[0.9829,0.469567,0.031133],[0.987175,0.450875,0.02335],[0.99145,0.432183,0.015567],[0.995725,0.413492,0.007783],[1,0.3948,0],[0.998342,0.3619,0],[0.996683,0.329,0],[0.995025,0.2961,0],[0.993367,0.2632,0],[0.991708,0.2303,0],[0.99005,0.1974,0],[0.988392,0.1645,0],[0.986733,0.1316,0],[0.985075,0.0987,0],[0.983417,0.0658,0],[0.981758,0.0329,0],[0.9801,0,0],[0.955925,0,0],[0.93175,0,0],[0.907575,0,0],[0.8834,0,0],[0.859225,0,0],
[0.83505,0,0],[0.810875,0,0],[0.7867,0,0],[0.762525,0,0],[0.73835,0,0],[0.714175,0,0],[0.69,0,0],[0.715833,0.083333,0.083333],[0.741667,0.166667,0.166667],[0.7675,0.25,0.25],[0.793333,0.333333,0.333333],[0.819167,0.416667,0.416667],[0.845,0.5,0.5],[0.870833,0.583333,0.583333],[0.896667,0.666667,0.666667],[0.9225,0.75,0.75],[0.948333,0.833333,0.833333],[0.974167,0.916667,0.916667],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1]]));a.checkNew(new a.Colormap("a",[[0,0],[0.25,0],[0.5,
1],[1,1]],[[0,0],[0.25,1],[0.5,0],[0.77,0],[1,1]],[[0,0],[0.125,0],[0.5,1],[0.64,0.5],[0.77,0],[1,0]]));a.checkNew(new a.Colormap("b",[[0,0],[0.25,0],[0.5,1],[1,1]],[[0,0],[0.5,0],[0.75,1],[1,1]],[[0,0],[0.25,1],[0.5,0],[0.75,0],[1,1]]));a.checkNew(new a.Colormap("bb",[[0,0],[0.5,1],[1,1]],[[0,0],[0.25,0],[0.75,1],[1,1]],[[0,0],[0.5,0],[1,1]]));a.checkNew(new a.Colormap("he",[[0,0],[0.015,0.5],[0.25,0.5],[0.5,0.75],[1,1]],[[0,0],[0.065,0],[0.125,0.5],[0.25,0.75],[0.5,0.81],[1,1]],[[0,0],[0.015,0.125],
[0.03,0.375],[0.065,0.625],[0.25,0.25],[1,1]]));a.checkNew(new a.Colormap("hsv",function(){var a,b,c,d,e,f,g,h=[],j=0;for(a=0;200>a;a++,j++){b=1-a/199;c=360*b+270;d=Math.abs(Math.sin(3.1416*b));for(b=Math.pow(1-b,1/3);360<=c;)c-=360;c/=60;g=Math.floor(c);e=c-g;c=b*(1-d);f=b*(1-d*e);d=b*(1-d*(1-e));h[j]=[];switch(g){case 0:h[j].push(b);h[j].push(d);h[j].push(c);break;case 1:h[j].push(f);h[j].push(b);h[j].push(c);break;case 2:h[j].push(c);h[j].push(b);h[j].push(d);break;case 3:h[j].push(c);h[j].push(f);
h[j].push(b);break;case 4:h[j].push(d);h[j].push(c);h[j].push(b);break;case 5:h[j].push(b),h[j].push(c),h[j].push(f)}}return h}()));a.checkNew(new a.Colormap("rainbow",[[0,1],[0.2,0],[0.6,0],[0.8,1],[1,1]],[[0,0],[0.2,0],[0.4,1],[0.8,1],[1,0]],[[0,1],[0.4,1],[0.6,0],[1,0]]));a.checkNew(new a.Colormap("standard",[[0,0],[0.333,0.3],[0.333,0],[0.666,0.3],[0.666,0.3],[1,1]],[[0,0],[0.333,0.3],[0.333,0.3],[0.666,1],[0.666,0],[1,0.3]],[[0,0],[0.333,1],[0.333,0],[0.666,0.3],[0.666,0],[1,0.3]]));a.checkNew(new a.Colormap("staircase",
function(){var a,b,c=[],d=0;for(a=1;5>=a;a++,d++)b=a/5,c[d]=[],c[d].push(0.3*b),c[d].push(0.3*b),c[d].push(b);for(a=1;5>=a;a++,d++)b=a/5,c[d]=[],c[d].push(0.3*b),c[d].push(b),c[d].push(0.3*b);for(a=1;5>=a;a++,d++)b=a/5,c[d]=[],c[d].push(b),c[d].push(0.3*b),c[d].push(0.3*b);return c}()));a.checkNew(new a.Colormap("color",[[0,0,0],[0.18431,0.18431,0.18431],[0.37255,0.37255,0.37255],[0.56078,0.56078,0.56078],[0.74902,0.74902,0.74902],[0.93725,0.93725,0.93725],[0,0.18431,0.93725],[0,0.37255,0.74902],
[0,0.49804,0.49804],[0,0.74902,0.3098],[0,0.93725,0],[0.3098,0.62353,0],[0.49804,0.49804,0],[0.62353,0.3098,0],[0.93725,0,0],[0.74902,0,0.3098]]));a.checkNew(new a.Command({name:"analysis",alias:"run",help:"list/run analysis for current image",get:function(){var a,b,c,d,e,f="",g=this.image;if(g&&g.analysisPackages)for(b=0;b<g.analysisPackages.length;b++){e=g.analysisPackages[b];for(a=0;a<e.length;a++)d=e[a],f&&(f+=", "),c=d.xclass?d.xclass+":"+d.name:d.name,f+=sprintf("%s (%s)",d.title,c);b<g.analysisPackages.length-
1&&(f+="\n")}return f},set:function(b){var c,d=this.image;d&&((c=d.lookupAnalysis(b[0]))?c.purl?(b=d.displayAnalysis("params",a.InstallDir(c.purl),{title:c.title+": "+d.fitsFile}),$(b).data("dispid",d.display.id).data("aname",c.name)):d.runAnalysis(c.name):a.error("unknown analysis command '"+b[0]+"'"))}}));a.checkNew(new a.Command({name:"colormap",alias:"cmap",help:"set/get colormap for current image",get:function(){var a;if(a=this.image)return a=a.getColormap(),sprintf("%s %s %s",a.colormap,a.contrast,
a.bias)},set:function(a){var b=this.image;b&&b.setColormap.apply(b,a)}}));a.checkNew(new a.Command({name:"colormaps",alias:"cmaps",help:"get list of available colormaps",get:function(){var b,c="";for(b=0;b<a.colormaps.length;b++)c&&(c+=", "),c+=a.colormaps[b].name;return c}}));a.checkNew(new a.Command({name:"help",help:"get list of available commmands",get:function(){var b,c,d;d="<table>";for(b=0;b<a.commands.length;b++)c=a.commands[b],d+="<tr><td>"+c.name+"</td><td>"+c.help,c.alias&&(d+=" ("+c.alias,
c.alias2&&(d+=", "+c.alias2),d+=")"),d+="</td></tr>";return d+"</table>"}}));a.checkNew(new a.Command({name:"helper",help:"get/set helper connection",get:function(){return a.helper.connectinfo()},set:function(b){a.helper.connect(b[0].trim())}}));a.checkNew(new a.Command({name:"image",help:"get name of currently loaded image or display specified image",get:function(){var a=this.image;if(a)return a.file},set:function(b){var c,d;for(c=0;c<a.images.length;c++)if(d=a.images[c],0<=d.file.search(b[0])&&
d.display===this.display){d.displayImage("display");break}}}));a.checkNew(new a.Command({name:"images",help:"get list of currently loaded images",get:function(){var b,c,d="";for(b=0;b<a.images.length;b++)c=a.images[b],c.display===this.display&&(d&&(d+=", "),d+=c.file);return d}}));a.checkNew(new a.Command({name:"load",help:"load image(s)",set:function(b){var c;for(c=0;c<b.length;c++)a.Load(b[c],{display:this.display.id})}}));a.checkNew(new a.Command({name:"pan",help:"set/get pan location for current image",
get:function(){var a;if(a=this.image)return a=a.getPan(),sprintf("%s %s",a.x,a.y)},set:function(a){var b=this.image;b&&b.setPan.apply(b,a)}}));a.checkNew(new a.Command({name:"pix2wcs",help:"get image pixel value for specified wcs position",set:function(b){var c=this.image;if(c)return b=a.Pix2WCS(parseFloat(b[0]),parseFloat(b[1]),{display:c}),b.str}}));a.checkNew(new a.Command({name:"print",help:"print image window",get:function(){var a=this.image;a&&a.print()}}));a.checkNew(new a.Command({name:"regions",
alias:"reg",alias2:"region",help:"add region to current image or list all regions",get:function(){var a=this.image;if(a)return a.listRegions("all",0)||""},set:function(a){var b=this.image;b&&("delete"===a[0]||"remove"===a[0]?(a=a.slice(1).join(" "),b.removeShapes("regions",a)):(a=a.join(" "),b.addShapes("regions",a)))}}));a.checkNew(new a.Command({name:"resize",help:"get/set display size for current image",get:function(){var a;if(a=this.image)return a=a.display,sprintf("%s %s",a.width,a.height)},
set:function(a){var b;b=this.image;var c;b&&a.length&&(b=b.display,c=parseInt(a[0],10),a=1<a.length?parseInt(a[1],10):c,b.resize(c,a))}}));a.checkNew(new a.Command({name:"scale",help:"set/get scaling for current image",get:function(){var a;if(a=this.image)return a=a.getScale(),sprintf("%s %s %s",a.scale,a.scalemin,a.scalemax)},set:function(a){var b=this.image;b&&b.setScale.apply(b,a)}}));a.checkNew(new a.Command({name:"scales",help:"get list of available scales",get:function(){return a.scales.join(", ")}}));
a.checkNew(new a.Command({name:"status",help:"get status for specified (or current) image",get:function(b){var c,d,e,f="";for(c=0;c<a.images.length;c++)if(d=a.images[c],0<=d.file.search(b[0])){e=d;break}e?c=1:(c=0,e=this.image);if(e){if(c>b.length)return e.status.load;for(;c<b.length;c++)switch(d=b[c].toLowerCase().trim(),d){case "load":f&&(f+="\n"),f+=e.status.load}}return f}}));a.checkNew(new a.Command({name:"url",help:"display a url",set:function(b){a.DisplayHelp(b[0])}}));a.checkNew(new a.Command({name:"wcssys",
help:"set/get wcs system for current image",get:function(){var a=this.image;if(a)return a.getWCSSys()},set:function(a){var b=this.image;b&&b.setWCSSys(a[0])}}));a.checkNew(new a.Command({name:"wcsu",help:"set/get wcs units used for current image",get:function(){var a=this.image;if(a)return a.getWCSUnits()},set:function(a){var b=this.image;b&&b.setWCSUnits(a[0])}}));a.checkNew(new a.Command({name:"wcssystems",help:"get list of available wcs systems",get:function(){return a.wcssyss.join(", ")}}));a.checkNew(new a.Command({name:"wcsunits",
help:"get list of available wcs units",get:function(){return a.wcsunitss.join(", ")}}));a.checkNew(new a.Command({name:"wcs2pix",help:"get wcs position for specified image pixel",set:function(b){var c=this.image;if(c)return b=a.WCS2Pix(parseFloat(b[0]),parseFloat(b[1]),{display:c}),b.str}}));a.checkNew(new a.Command({name:"zoom",help:"set/get zoom for current image",get:function(){var a=this.image;if(a)return a.getZoom()},set:function(a){var b=this.image;b&&b.setZoom(a[0])}}));a.helper=new a.Helper;
$(document).on("keyup keypress",".js9AnalysisForm",function(a){if(13===(a.which||a.keyCode))return a.preventDefault(),!1});$(document).scrollTop(0);$(document).trigger("JS9:init")};a.parsePublicArgs=function(a){var b=null;a=Array.prototype.slice.call(a);var c=a[a.length-1];c&&("object"===typeof c&&c.hasOwnProperty("display")&&1===Object.keys(c).length)&&(b=c.display,a.pop());return{argv:a,display:b}};a.mkPublic=function(d,b){"string"===typeof b?a.Image.prototype[b]?(a[d]=function(){var c;c=a.parsePublicArgs(arguments);
var d=a.getImage(c.display);if(d)return c=d[b].apply(d,c.argv),c===d||c===d.display?"OK":c},a.publics[d]=a[d]):a.error("unknown image function for mkPublic: "+b):"function"===typeof b?(a[d]=b,a.publics[d]=a[d]):a.error("unsupported type for mkPublic: "+typeof b)};a.mkPublic("CloseImage","closeImage");a.mkPublic("DisplayImage","displayImage");a.mkPublic("DisplayExtension","displayExtension");a.mkPublic("DisplaySlice","displaySlice");a.mkPublic("BlendImage","blendImage");a.mkPublic("GetColormap","getColormap");
a.mkPublic("SetColormap","setColormap");a.mkPublic("GetZoom","getZoom");a.mkPublic("SetZoom","setZoom");a.mkPublic("GetPan","getPan");a.mkPublic("SetPan","setPan");a.mkPublic("GetScale","getScale");a.mkPublic("SetScale","setScale");a.mkPublic("GetValPos","updateValpos");a.mkPublic("ImageToDisplayPos","imageToDisplayPos");a.mkPublic("DisplayToImagePos","displayToImagePos");a.mkPublic("ImageToLogicalPos","imageToLogicalPos");a.mkPublic("LogicalToImagePos","logicalToImagePos");a.mkPublic("GetWCSUnits",
"getWCSUnits");a.mkPublic("SetWCSUnits","setWCSUnits");a.mkPublic("GetWCS","getWCS");a.mkPublic("SetWCS","setWCS");a.mkPublic("GetWCSSys","getWCSSys");a.mkPublic("SetWCSSys","setWCSSys");a.mkPublic("ShowShapeLayer","showShapeLayer");a.mkPublic("AddShapes","addShapes");a.mkPublic("RemoveShapes","removeShapes");a.mkPublic("GetShapes","getShapes");a.mkPublic("ChangeShapes","changeShapes");a.mkPublic("Print","print");a.mkPublic("SavePNG","savePNG");a.mkPublic("SaveJPEG","saveJPEG");a.mkPublic("SaveFITS",
"saveFITS");a.mkPublic("RunAnalysis","runAnalysis");a.mkPublic("RawDataLayer","rawDataLayer");a.mkPublic("GaussBlurData","gaussBlurData");a.mkPublic("ImarithData","imarithData");a.mkPublic("ReprojectData","reprojectData");a.mkPublic("ShiftData","shiftData");a.mkPublic("FilterRGBImage","filterRGBImage");a.mkPublic("MoveToDisplay","moveToDisplay");a.mkPublic("SaveSession","saveSession");a.mkPublic("LookupImage",function(d){var b=a.parsePublicArgs(arguments);return a.lookupImage(b.argv[0],b.display)});
a.mkPublic("AddColormap",function(d,b,c,e){var f,g,h=a.parsePublicArgs(arguments),j=function(b){b.vertices?a.AddColormap(b.name,b.vertices[0],b.vertices[1],b.vertices[2]):b.colors?a.AddColormap(b.name,b.colors):a.error("invalid colormap object for JS9.AddColormap()")};if(h.argv[0]instanceof Blob)f=new FileReader,f.onload=function(b){try{g=JSON.parse(b.target.result)}catch(c){a.error("can't parse json colormap",c)}j(g)},f.readAsText(h.argv[0]);else if("object"===typeof h.argv[0])j(h.argv[0]);else switch(h.argv.length){case 1:try{g=
JSON.parse(d)}catch(k){a.error("can't parse JSON colormap",k)}j(g);break;case 2:a.checkNew(new a.Colormap(d,b));break;case 4:a.checkNew(new a.Colormap(d,b,c,e));break;default:a.error("AddColormap() requires a colormap name and 1 or 3 args")}});a.mkPublic("SetRGBMode",function(d,b){var c,e,f=["red","green","blue"],g=["rid","gid","bid"],h=a.parsePublicArgs(arguments);d=h.argv[0];if(b=h.argv[1])for(c=0;3>c;c++)e=b[g[c]],"string"===typeof e&&(e=a.LookupImage(e)),e&&e.setColormap(f[c]);a.globalOpts.rgb.active=
!!d;a.DisplayImage({display:h.display});return a.globalOpts.rgb.active});a.mkPublic("GetRGBMode",function(){return{active:a.globalOpts.rgb.active,rid:a.globalOpts.rgb.rim?a.globalOpts.rgb.rim.id:null,gid:a.globalOpts.rgb.gim?a.globalOpts.rgb.gim.id:null,bid:a.globalOpts.rgb.bim?a.globalOpts.rgb.bim.id:null}});a.mkPublic("SetValPos",function(d){var b=null,c=a.parsePublicArgs(arguments),e=a.getImage(c.display);e&&(d=c.argv[0],b=e.params.valpos,e.params.valpos=d);return b});a.mkPublic("Load",function(d,
b){var c,e,f;e=a.parsePublicArgs(arguments);d=e.argv[0];b=e.argv[1];if(d)if(e=e.display?e.display:0<a.displays.length?a.displays[0].id:a.DEFID,b=b||{},b.display=b.display||e,b.onload?f=b.onload:a.imageOpts.onload&&(f=a.imageOpts.onload,b.onload=f),d instanceof Blob){if(d.name){if(e=a.lookupImage(d.name,b.display)){e.displayImage("display",b);e.refreshLayers();e.clearMessage();a.waiting(!1);return}b.filename=d.name}b.filename||(b.filename=a.ANON+a.uniqueID());if(a.fits.handleFITSFile){e=$.extend(!0,
{},b,a.fits.options);try{a.fits.handleFITSFile(d,e,a.NewFitsImage)}catch(g){a.error("can't process FITS file",g)}}else a.error("no FITS module available to load this FITS blob")}else if("object"===typeof d)a.checkNew(new a.Image(d,b,f));else if("string"!==typeof d&&a.error("unknown file type for Load: "+typeof d),"U0lNUExFICA9"===d.slice(0,12)&&(d=window.atob(d)),"SIMPLE  ="===d.slice(0,9)){e=[];for(c=0;c<d.length;c++)e[c]=d.charCodeAt(c);c=new Blob([new Uint8Array(e)]);b.filename||(b.filename=a.ANON+
a.uniqueID());c.name=b.filename;if(a.fits.handleFITSFile){e=$.extend(!0,{},b,a.fits.options);try{a.fits.handleFITSFile(c,e,a.NewFitsImage)}catch(h){a.error("can't process FITS file",h)}}else a.error("no FITS module available to process this memory FITS")}else(e=a.lookupImage(d,b.display))?(e.displayImage("all",b),e.clearMessage(),a.waiting(!1)):(d=d.trim(),e=d.split(".").pop().toLowerCase(),"png"===e?a.globalOpts.pngisfits?a.checkNew(new a.Image(d,b,f)):a.fetchURL(null,d,b,a.NewFitsImage):b.fits2png||
void 0===b.fits2png&&a.globalOpts.fits2png?a.helper.connected?a.helper.send("fits2png",{fits:d},function(c){var d;c="object"===typeof c?c:0<=c.search(a.analOpts.epattern)?{stderr:c}:{stdout:c};c.stderr&&a.error(c.stderr,a.analOpts.epattern);c.stdout&&(c=c.stdout.replace(/\n*$/,"").split("\n").pop(),d=c.split(".").pop().toLowerCase(),"png"===d?a.checkNew(new a.Image(c,b,f)):a.error("fits2png conversion failed: "+c))}):a.error("no JS9 helper available to convert image: "+d):(b.display&&(c=a.lookupDisplay(b.display))&&
(c=c.divjq[0]),a.waiting(!0,c),c=d.replace(/\[.*\]/,""),a.fetchURL(d,c,b,a.NewFitsImage)));else a.error("JS9.Load: no file specified for image load")});a.mkPublic("LoadWindow",function(d,b,c,e,f){var g,h=(c||"")+"win";b=b||{};switch(c){case "light":return b.id?(g=b.id,delete b.id):g=h+a.uniqueID(),c="d"+g,e=e||sprintf("<hr class='hline0'><div class='JS9Menubar' id='%sMenubar'></div><div class='JS9' id='%s'></div><div style='margin-top: 2px;'><div class='JS9Colorbar' id='%sColorbar'></div></div>",
g,g,g),f=f||a.lightOpts[a.LIGHTWIN].imageWin,h=sprintf("JS9 Display"+a.IDFMT,g),e=a.lightWin(c,"inline",e,h,f),e.onclose=function(){var b,c,d=[];for(b=0;b<a.images.length;b++)c=a.images[b],c.display.id===g&&d.push(c);for(b=0;b<d.length;b++)try{d[b].closeImage()}catch(e){}return!0},a.checkNew(new a.Display(g)),a.helper.send("addDisplay",{display:g}),a.instantiatePlugins(),b.display=g,d&&a.Load(d,b),g;case "new":return b.id?(g=b.id,delete b.id):g=h+a.uniqueID(),f=document.getElementsByTagName("head")[0].innerHTML,
!f.match(/src=["'].*js9\.js/)&&!f.match(/src=["'].*js9\.min\.js/)&&(f+=sprintf('<%s type="text/javascript" src="js9.min.js"></%s>',"script","script")),c=e||sprintf("<div class='JS9Menubar' id='%sMenubar'></div><div class='JS9' id='%s'></div>",g,g),e=sprintf("<html><head>%s</head><body",f),d&&(e+=sprintf(" onload='JS9.Preload(\"%s\",%s);'",d,JSON.stringify(b))),e+=sprintf(">%s</body></html>\n",c),d=window.open(null,g,"width=540, height=560"),d=d.document,d.open(),d.write(e),d.close(),g}});a.mkPublic("LoadProxy",
function(d,b){var c,e,f=a.parsePublicArgs(arguments);d=f.argv[0];b=f.argv[1];a.globalOpts.loadProxy||a.error("proxy load not available for this server");a.globalOpts.workDir||a.error("proxy load requires a temp workDir this server");d||a.error("no url specified for proxy load");d=d.trim();d.match(/dropbox\.com/)?(d=d.replace("www.dropbox.com","dl.dropboxusercontent.com"),d=d.replace("?dl=0","")+"?raw=1"):d.match(/drive\.google\.com/)&&(d=d.replace(/\/file\/d\/(\w+)\/\w+\?usp=sharing/,"/uc?export=download&id=$1"));
f.display&&(e=a.lookupDisplay(f.display))&&(e=e.divjq[0]);a.waiting(!0,e);a.Send("loadproxy",{cmd:"js9Xeq loadproxy "+d},function(d){d="object"===typeof d?d:0<=d.search(a.analOpts.epattern)?{stderr:d}:{stdout:d};d.errcode=d.errcode||0;d.stderr?a.error(d.stderr):d.stdout?(b=b||{},void 0===b.fits2png&&(b.fits2png=!1),c=d.stdout.trim().replace(/\/\.\//,"/"),b.proxyFile=c,"/"!==c.charAt(0)&&(c=a.InstallDir(c)),a.Load(c,b,{display:f.display})):a.error("internal error: no return from load proxy command")})});
a.mkPublic("Preload",function(d){var b,c,e="",f=null,g=arguments.length;b=a.parsePublicArgs(arguments);d=b.argv[0];b.display&&(f={display:b.display},g-=1);switch(g){case 0:b=(null===a.helper.connected||a.helper.connected)&&0<a.preloads.length?2:3;break;case 1:b="boolean"===typeof d?0<a.preloads.length?2:3:null===a.helper.connected||a.helper.connected?1:0;break;default:b=null===a.helper.connected||a.helper.connected?1:0}switch(b){case 0:for(b=0;b<g;b++)c=b+1,c<g&&"object"===typeof arguments[c]?(a.preloads.push([arguments[b],
arguments[c],f]),b++):a.preloads.push([arguments[b],null,f]);break;case 1:a.globalOpts.alerts=!1;for(b=0;b<g;b++)if(c=b+1,c<g&&"object"===typeof arguments[c]){try{f?a.Load(arguments[b],arguments[c],f):a.Load(arguments[b],arguments[c])}catch(h){e=e+" "+arguments[b]}b++}else try{f?a.Load(arguments[b],null,f):a.Load(arguments[b],null)}catch(j){e=e+" "+arguments[b]}a.globalOpts.alerts=!0;e&&a.error("could not preload image(s): "+e);break;case 2:a.globalOpts.alerts=!1;for(b=0;b<a.preloads.length;b++)try{a.preloads[b][2]?
a.Load(a.preloads[b][0],a.preloads[b][1],a.preloads[b][2]):a.Load(a.preloads[b][0],a.preloads[b][1])}catch(k){e=e+" "+a.preloads[b][0]}a.globalOpts.alerts=!0;e&&a.error("could not preload image(s): "+e);a.preloads=[]}});a.mkPublic("RefreshImage",function(d,b){var c=a.parsePublicArgs(arguments),e=a.getImage(c.display),f=function(c){a.Image.prototype.refreshImage.call(e,c,b)};d=c.argv[0];b=c.argv[1]||{};if(e)if(d instanceof Blob)if(a.fits.handleFITSFile){!b.rawid&&(a.fits.cleanupFITSFile&&e.raw.hdu&&
e.raw.hdu.fits)&&a.fits.cleanupFITSFile(e.raw.hdu.fits,!0);try{a.fits.handleFITSFile(d,a.fits.options,f)}catch(g){a.error("can't refresh FITS file",g)}}else a.error("no FITS module available to refresh this image");else a.Image.prototype.refreshImage.apply(e,c.argv);else d instanceof Blob&&a.Load.apply(null,arguments)});a.mkPublic("GetLoadStatus",function(d){var b=a.parsePublicArgs(arguments),c=a.getImage(b.display);return c?(d=b.argv[0],!d||c.id0===d?c.status.load:"other"):"none"});a.mkPublic("CopyToClipboard",
function(d){var b,c,e=document.createElement("textarea");e.style.position="fixed";e.style.top=0;e.style.left=0;e.style.width="2em";e.style.height="2em";e.style.padding=0;e.style.border="none";e.style.outline="none";e.style.boxShadow="none";e.style.background="transparent";e.value=d;document.body.appendChild(e);e.select();try{(c=document.execCommand("copy"))?b="OK":(b="MANUAL",a.BROWSER[2].match(/Mac/)?window.prompt("copy to clipboard: Cmd+C",d):window.prompt("copy to clipboard: Ctrl+C",d))}catch(f){b=
"ERROR"}document.body.removeChild(e);return b});a.mkPublic("OpenFileMenu",function(){var d=a.parsePublicArgs(arguments);(d=a.lookupDisplay(d.display))&&$("#openLocalFile-"+d.id).click()});a.mkPublic("OpenRegionsMenu",function(){var d=a.parsePublicArgs(arguments);(d=a.lookupDisplay(d.display))&&$("#openLocalRegions-"+d.id).click()});a.mkPublic("OpenSessionMenu",function(){var d=a.parsePublicArgs(arguments);(d=a.lookupDisplay(d.display))&&$("#openLocalSession-"+d.id).click()});a.mkPublic("OpenColormapMenu",
function(){var d=a.parsePublicArgs(arguments);(d=a.lookupDisplay(d.display))&&$("#openLocalColormap-"+d.id).click()});a.mkPublic("SaveColormap",function(d){var b,c=a.parsePublicArgs(arguments);if(window.hasOwnProperty("saveAs")){if(b=a.getImage(c.display))d=c.argv[0]||"js9.cmap",b=$.extend(!0,{},b.cmapObj),delete b.type,b=JSON.stringify(b),b=new Blob([b],{type:"text/plain"}),saveAs(b,d)}else a.error("no saveAs function available to save colormap");return d});a.mkPublic("DisplayPlugin",function(d){var b,
c,e,f;b=a.parsePublicArgs(arguments);var g=a.lookupDisplay(b.display);if(g&&b.argv[0]){d=b.argv[0];f=d.toLowerCase();for(b=0;b<a.plugins.length;b++)if(c=a.plugins[b],e=c.name,e===d||e.toLowerCase().substr(-f.length)===f){g.displayPlugin(c);return}a.error("can't find plugin: "+d)}});a.mkPublic("NewFitsImage",function(d,b){var c;b&&b.onload&&(c=b.onload);a.checkNew(new a.Image(d,b,c))});a.mkPublic("GetImage",function(d){var b;d&&"string"!==typeof d&&(b=a.parsePublicArgs(arguments),d=b.display);return a.getImage(d)});
a.mkPublic("GetImageData",function(d){var b=a.parsePublicArgs(arguments),c=a.getImage(b.display);return c?(d=b.argv[0],c.getImageData(d)):null});a.mkPublic("GetDisplayData",function(d){var b,c,e,f=[];b=a.parsePublicArgs(arguments);c=b.display||a.displays[0].id;d=b.argv[0];for(b=0;b<a.images.length;b++)e=a.images[b],e.display.id===c&&f.push(e.getImageData(d));return f});a.mkPublic("GetFITSHeader",function(d){var b="",c=a.parsePublicArgs(arguments),e=a.getImage(c.display);e&&e.raw&&(d=c.argv[0],b=a.raw2FITS(e.raw,
d));return b});a.mkPublic("BlendDisplay",function(d){var b,c,e=[],f=a.parsePublicArgs(arguments).display||a.DEFID;(b=a.lookupDisplay(f))||a.error("no JS9 display found: "+f);if(void 0===d||"mode"===d)return b.blendMode;if("list"===d){for(b=0;b<a.images.length;b++)c=a.images[b],c.display.id===f&&c.blend.active&&e.push(c.id);return e}b.blendMode=!!d;b.image&&b.image.displayImage();return b.blendMode});a.mkPublic("LoadAuxFile",function(d,b){var c=a.parsePublicArgs(arguments),e=a.getImage(c.display);
e?(d=c.argv[0],b=c.argv[1],e.loadAuxFile(d,b)):a.error("could not find image for aux file: "+d)});a.mkPublic("SubmitAnalysis",function(d,b,c){var e,f,g;e=a.lightOpts[a.LIGHTWIN];var h=a.parsePublicArgs(arguments);d=h.argv[0];b=h.argv[1];c=h.argv[2];b?e=a.lookupDisplay(h.display).id:(e=$(d).closest(e.top),b=e.data("aname"),e=e.data("dispid"));b?e&&(f=a.getImage(e)):g="internal error: could not find analysis task name";if(f){e=$(d).closest("form");try{h=e.serializeArray()}catch(j){h=null}f.runAnalysis(b,
h,c)}else g="internal error: could not find image";g&&a.error(g);return!1});a.mkPublic("Send",function(d,b,c){a.helper.connected?a.helper.send(d,b,c):a.error("no JS9 helper available")});a.mkPublic("EventToDisplayPos",function(d){return a.eventToDisplayPos(d)});a.mkPublic("PixToWCS",function(d,b){var c,e,f=1;c=a.parsePublicArgs(arguments);var g=a.getImage(c.display);if(g&&(d=c.argv[0],b=c.argv[1],(!a.isNumber(d)||!a.isNumber(b))&&a.error("invalid input for PixToWCS"),0<g.raw.wcs))return c=a.pix2wcs(g.raw.wcs,
d,b).trim(),e=c.split(/ +/),"sexagesimal"===g.params.wcsunits&&("galactic"!==g.params.wcssys&&"ecliptic"!==g.params.wcssys)&&(f=15),{ra:a.saostrtod(e[0])*f,dec:a.saostrtod(e[1]),sys:e[2],str:c}});a.Pix2WCS=a.PixToWCS;a.mkPublic("WCSToPix",function(d,b){var c,e,f;e=a.parsePublicArgs(arguments);if(c=a.getImage(e.display))if(d=e.argv[0],b=e.argv[1],(!a.isNumber(d)||!a.isNumber(b))&&a.error("invalid input for WCSToPix"),0<c.raw.wcs)return c=a.wcs2pix(c.raw.wcs,d,b).trim().split(/ +/),e=parseFloat(c[0]),
f=parseFloat(c[1]),c=sprintf("%f %f",e,f),{x:e,y:f,str:c};return null});a.WCS2Pix=a.WCSToPix;a.mkPublic("DisplayHelp",function(d){var b,c,e=a.lightOpts.dhtml.textWin,f;d&&(c=d.split("/").reverse()[0],b="help_"+a.uniqueID(),(f=a.helpOpts[d])?(d=a.InstallDir(f.type+"/"+f.url),a.lightWin(b,"iframe",d,f.title||c,e)):a.lightWin(b,"iframe",d,c,e))});a.mkPublic("NewShapeLayer",function(d,b){var c=a.parsePublicArgs(arguments),e=a.getImage(c.display);return e?(d=c.argv[0],b=c.argv[1],e.display.newShapeLayer(d,
b)):null});a.mkPublic("AddRegions",function(d,b){var c=a.parsePublicArgs(arguments),e=a.getImage(c.display);return e?(d=c.argv[0],b=c.argv[1],d||a.error("no region specified for AddRegions"),b=c.argv[1],e.addShapes("regions",d,b)):null});a.mkPublic("RemoveRegions",function(d){var b=a.parsePublicArgs(arguments),c=a.getImage(b.display);return c?(d=b.argv[0],c.removeShapes("regions",d),c.clearMessage("regions"),"OK"):null});a.mkPublic("CopyRegions",function(d,b){var c=a.parsePublicArgs(arguments),e=
a.getImage(c.display);return e?(d=c.argv[0],b=c.argv[1],e.copyRegions(d,b),"OK"):null});a.mkPublic("GetRegions",function(d){var b=a.parsePublicArgs(arguments),c=a.getImage(b.display);return c?(b.argv.unshift("regions"),c.getShapes.apply(c,b.argv)):null});a.mkPublic("ChangeRegions",function(d,b){var c=a.parsePublicArgs(arguments),e=a.getImage(c.display);e&&((d=c.argv[0])||a.error("no region specified for GetRegions"),b=c.argv[1],e.changeShapes("regions",d,b));return null});a.mkPublic("SaveRegions",
function(d,b){var c,e,f;f=a.parsePublicArgs(arguments);c=f.argv[0];e=f.argv[1];return(f=a.getImage(f.display))?f.saveRegions(c,e):d});a.mkPublic("LoadRegions",function(d,b){var c,e;e=a.parsePublicArgs(arguments);d=e.argv[0];b=e.argv[1]||{};d||a.error("JS9.LoadRegions: no file specified for regions load");c=e.display?e.display:b.display?b.display:0<a.displays.length?a.displays[0].id:a.DEFID;"object"===typeof d?(e=new FileReader,e.onload=function(d){a.AddRegions(d.target.result,b,{display:c})},e.readAsText(d)):
"string"===typeof d?(b.responseType="text",b.display=c,a.fetchURL(null,d,b,a.AddRegions)):a.error("unknown file type for LoadRegions: "+typeof d)});a.mkPublic("InstallDir",function(d){return a.INSTALLDIR+d});a.mkPublic("AddDivs",function(){var d,b=a.parsePublicArgs(arguments);for(d=0;d<b.argv.length;d++)a.checkNew(new a.Display(b.argv[d]));a.instantiatePlugins()});a.mkPublic("ResizeDisplay",function(){var d;d=a.parsePublicArgs(arguments);var b=a.lookupDisplay(d.display);b||a.error("invalid display for resize");
d=a.Display.prototype.resize.apply(b,d.argv);d===b&&(d="OK");return d});a.mkPublic("LoadSession",function(d,b){var c,e;c=a.parsePublicArgs(arguments);d=c.argv[0];b=c.argv[1]||{};d||a.error("JS9.LoadSession: no file specified for load");e=a.lookupDisplay(c.display?c.display:b.display?b.display:0<a.displays.length?a.displays[0].id:a.DEFID);b.display=e.id;"object"===typeof d?(c=new FileReader,c.onload=function(a){a=JSON.parse(a.target.result);e.loadSession(a,b)},c.readAsText(d)):"string"===typeof d?
(b.responseType="text",b.display=e.id,a.fetchURL(null,d,b,function(a,b){var c=JSON.parse(a);e.loadSession(c,b)})):a.error("unknown file type for LoadSession: "+typeof d)});return a}();$(document).ready(function(){JS9.init()});
