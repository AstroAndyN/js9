var JS9;if(JS9&&("object"!==typeof JS9||JS9.NAME))throw Error("Namespace 'JS9' already exists");JS9={NAME:"JS9",VERSION:"1.8",COPYRIGHT:"Copyright (c) 2012-2016 Smithsonian Institution"};
JS9=function(a){a.DEFID="JS9";a.ANON="[anonymous]";a.PREFSFILE="js9Prefs.json";a.ZINDEX=0;a.SHAPEZINDEX=7;a.MESSZINDEX=8;a.BTNZINDEX=10;a.MENUZINDEX=1E3;a.COLORSIZE=1024;a.SCALESIZE=16384;a.INSTALLDIR="";a.TOROOT="";a.PLUGINS="";a.LIGHTWIN="dhtml";a.ANTIALIAS=!1;a.SCALEIREG=!0;a.NOMOVE=3;a.DBLCLICK=500;a.TIMEOUT=250;a.SPINOUT=250;a.SUPERMENU=/^SUPERMENU_/;a.RESIZEDIST=20;a.RESIZEFUDGE=5;a.RAWID0="raw0";a.RAWIDX="alt";a.REPROJDIM=2200;var C=a,z=navigator.platform,G=navigator.appName,D=navigator.userAgent,
E,A=D.match(/(opera|chrome|safari|firefox|msie)\/?\s*(\.?\d+(\.\d+)*)/i);E=D.match(/version\/([\.\d]+)/i);A&&null!==E&&(A[2]=E[1]);A=A?[A[1],A[2],z]:[G,navigator.appVersion,"-?",z];A.push(/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(D));C.BROWSER=A;C=a;z=document.createElement("canvas").getContext("2d");C.PIXEL_RATIO=(window.devicePixelRatio||1)/(z.webkitBackingStorePixelRatio||z.mozBackingStorePixelRatio||z.msBackingStorePixelRatio||z.oBackingStorePixelRatio||z.backingStorePixelRatio||1);a.globalOpts=
{helperType:"none",helperPort:2718,winType:"light",rgb:{active:!1,rim:null,gim:null,bim:null},defcolor:"#00FF00",pngisfits:!0,fits2png:!1,alerts:!0,internalValPos:!0,internalContrastBias:!0,htimeout:1E4,xtimeout:18E4,extlist:"EVENTS STDEVT",dims:[1024,1024],helperProtocol:location.protocol,maxMemory:75E7,corsURL:"params/loadcors.html",proxyURL:"params/loadproxy.html",loadProxy:!1,archivesURL:"help/archives.html",imsectionURL:"params/imsection.html",postMessage:!1,waitType:"spinner",spinColor:"#FF0000",
spinOpacity:0.35,resize:!0,resizeHandle:!0,debug:0};a.imageOpts={contrast:1,bias:0.5,invert:!1,exp:1E3,colormap:"grey",scale:"linear",scaleclipping:"dataminmax",zscalecontrast:0.25,zscalesamples:600,zscaleline:120,wcssys:"native",wcsunits:"sexagesimal",lcs:"physical",valpos:!0,opacity:1,sigma:"none",maskOpacity:0.4,alpha:255,alpha1:100,zoom:1,zooms:5,nancolor:"#000000",wcsalign:!0,listonchange:!1};a.regionOpts={};a.analOpts={epattern:/^(ERROR:[^\n]*)\n/,dpathURL:"params/datapath.html",prependJS9Dir:!0,
dataDir:null};a.lightOpts={nclick:0,dhtml:{top:".dhtmlwindow",drag:".drag-contentarea",dragBar:"drag-handle",format:"width=%spx,height=%spx,center=1,resize=%s,scrolling=0",textWin:"width=830px,height=400px,center=1,resize=1,scrolling=1",plotWin:"width=830px,height=420px,center=1,resize=1,scrolling=1",dpathWin:"width=830px,height=175px,center=1,resize=1,scrolling=1",paramWin:"width=830px,height=230px,center=1,resize=1,scrolling=1",imageWin:"width=512px,height=542px,center=1,resize=1,scrolling=1",lineWin:"width=400px,height=10px,center=1,resize=1,scrolling=1"}};
a.textColorOpts={regions:"#00FF00",info:"#00FF00",inimage:"#000000"};a.plotOpts={zoomStack:!0,selection:{mode:"xy"},series:{clickable:!0,hoverable:!0,lines:{show:!0},points:{show:!1}}};a.helpOpts={user:{type:"help",url:"user.html",title:"JS9 User Manual"},install:{type:"help",url:"install.html",title:"Installing JS9"},webpage:{type:"help",url:"webpage.html",title:"Adding JS9 To A Web Page"},yourdata:{type:"help",url:"yourdata.html",title:"Adding Data To A Web Page"},localtasks:{type:"help",url:"localtasks.html",
title:"Local Analysis with JS9"},publicapi:{type:"help",url:"publicapi.html",title:"The JS9 Public API"},helper:{type:"help",url:"helper.html",title:"Adding Server-side Analysis"},serverside:{type:"help",url:"serverside.html",title:"Server-side Analysis with JS9"},repfile:{type:"help",url:"repfile.html",title:"Dealing with Large Files"},regions:{type:"help",url:"regions.html",title:"JS9 Regions Format"},extmsg:{type:"help",url:"extmsg.html",title:"JS9 External Messaging"},python:{type:"help",url:"python.html",
title:"JS9 with Python and Jupyter"},preferences:{type:"help",url:"preferences.html",title:"JS9 Site Preferences"},changelog:{type:"help",url:"changelog.html",title:"JS9 ChangeLog"},issues:{type:"help",url:"knownissues.html",title:"Known Issues"}};a.menuButtonOptsArr=[{name:"file",label:"File"},{name:"view",label:"View"},{name:"zoom",label:"Zoom"},{name:"scale",label:"Scale"},{name:"color",label:"Color"},{name:"region",label:"Region"},{name:"wcs",label:"WCS"},{name:"analysis",label:"Analysis"},{name:"help",
label:"Help"}];a.images=[];a.displays=[];a.colormaps=[];a.commands=[];a.plugins=[];a.preloads=[];a.auxFiles=[];a.publics={};a.helper={};a.fits={};a.userOpts={};a.scales="linear log pow sqrt squared asinh sinh".split(" ");a.wcssyss="FK4 FK5 ICRS galactic ecliptic native image physical".split(" ");a.wcsunitss=["degrees","sexagesimal","pixels"];a.menubarHTML="";a.consoleHTML="<form name='form' onsubmit='return false;' class='JS9CmdForm' action=''><table class='JS9CmdTable'><tr class='JS9Tr'><td><div id='JS9CmdPrompt' class='JS9CmdPrompt'>@@PR@@</div></td><td class='JS9CmdTd'><input type='text' class='JS9CmdIn' autocapitalize='off' autocorrect='off' autocomplete='off' value='' /></td></tr></table></form>";
a.bugs={};a.bugs.hide_menu=!0;"Firefox"===a.BROWSER[0]&&0<=a.BROWSER[2].search(/Linux/)&&(a.bugs.firefox_linux=!0);if("Chrome"===a.BROWSER[0]||"Safari"===a.BROWSER[0])a.bugs.webkit_resize=!0;"Chrome"===a.BROWSER[0]&&(a.globalOpts.maxMemory=Math.min(a.globalOpts.maxMemory,45E7));a.Image=function(d,c,b){var e,f,g=this,h=null,j=function(a,d){var b,c=[];d&&void 0!==d.xcen&&c.push(d.xcen);d&&void 0!==d.ycen&&c.push(d.ycen);d&&void 0!==d.zoom&&(b=a.parseZoom(d.zoom))&&c.push(b);return c},k=function(d){var b,
c;this.clearMessage();a.images.push(this);if(d)try{a.xeqByName(d,window,this)}catch(e){a.error("in image onload callback",e,!1)}for(b in this.display.pluginInstances)if(this.display.pluginInstances.hasOwnProperty(b)&&(d=this.display.pluginInstances[b],c=d.plugin.opts,d.isActive("onimageload")))try{c.onimageload.call(d,this)}catch(f){d.errLog("onimageload",f)}this.updateshapes&&this.updateShapes("regions","all","update");this.status.load="complete";a.waiting(!1)};c&&("object"===typeof c?(h=c,h.display&&
(f=h.display)):f=c);f||(f=0<a.displays.length?a.displays[0].id:a.DEFID);this.type="image";this.display=a.lookupDisplay(f);this.params={};this.tmp={};this.params.scalemin=Number.Nan;this.params.scalemax=Number.Nan;this.params.xeqonchange=!0;this.params.plotOpts=$.extend(!0,{},a.plotOpts);this.params=$.extend(!0,this.params,a.imageOpts,h);this.setColormap(this.params.colormap);this.displayMode=!0;this.evstate=-1;this.rclick=0;this.queried=!1;h&&h.proxyFile&&(this.proxyFile=h.proxyFile);h&&h.parentFile&&
(this.parentFile=h.parentFile);h&&h.id&&(this.id=h.id);this.wcsiy=this.wcsix=this.iy=this.ix=0;this.png={};this.png.image=new Image;this.status={};this.rgb={};this.rgb.sect={zoom:1,ozoom:1};this.layers={};this.lcs={};this.aux={};this.binning={bin:1,obin:1};this.raws=[];this.blend={active:void 0,mode:"normal",opacity:1};this.updateshapes=!1;a.waiting(!0,this.display.divjq[0]);switch(typeof d){case "object":this.source="fits";this.mkRawDataFromHDU(d,{file:d.filename});"zscale"===this.params.scaleclipping&&
this.zscale(!0);this.mkSection();e=j(this,h);e.length&&this.mkSection.apply(this,e);h&&h.rgbFile?(this.rgbFile=h.rgbFile,$(this.png.image).on("load",function(){var d;if(g.png.image.width!==g.raw.width||g.png.image.height!==g.raw.height)d=sprintf("rgb dims [%s,%s] don't match image [%s,%s]",g.png.image.width,g.png.image.height,g.raw.width,g.raw.height),a.error(d);g.mkOffScreenCanvas();g.displayImage("all",h);k.call(g,b)}).on("error",function(){a.waiting(!1);g.status.load="error";a.error("could not load image: "+
g.id)}),this.png.image.src=this.rgbFile):(this.displayImage("all",h),k.call(this,b));break;case "string":this.source="fits2png";this.imtab="image";this.file=d;this.oid=this.file.split("/").reverse()[0];this.id=a.getImageID(this.oid,this.display.id);this.status.load="loading";$(this.png.image).on("load",function(){g.mkOffScreenCanvas();g.mkRawDataFromPNG();"zscale"===g.params.scaleclipping&&g.zscale(!0);g.mkSection();e=j(g,h);e.length&&g.mkSection.apply(g,e);g.displayImage("all",h);k.call(g,b);a.DEBUG&&
a.log("JS9 image: %s dims(%d,%d) min/max(%d,%d)",g.file,g.raw.width,g.raw.height,g.raw.dmin,g.raw.dmax)}).on("error",function(){a.waiting(!1);g.status.load="error";a.error("could not load image: "+g.id)});this.png.image.src=d;break;default:a.log("unknown specification type for Load: "+typeof d)}};a.Image.prototype.getImageData=function(a){var c=null;if(a)if("array"===a)c=Array.prototype.slice.call(this.raw.data);else if("base64"===a){var c="",b=new Uint8Array(this.raw.data.buffer),e=b.byteLength;
for(a=0;a<e;a++)c+=String.fromCharCode(b[a]);c=window.btoa(c)}else a&&"false"!==a&&(c=this.raw.data);return{id:this.id,file:this.file,fits:this.fitsFile||"",source:this.source,imtab:this.imtab,width:this.raw.width,height:this.raw.height,bitpix:this.raw.bitpix,header:this.raw.header,hdus:this.hdus,data:c}};a.Image.prototype.closeImage=function(){var d,c,b,e,f,g;b=a.images.length;var h=this.display,j=function(d){d.stderr?a.error(d.stderr):d.stdout&&a.log(d.stdout)};for(d=0;d<b;d++)if(this===a.images[d]){b=
a.images[d];b.clearMessage();b.display.context.clear();for(e in b.display.pluginInstances)if(b.display.pluginInstances.hasOwnProperty(e)&&(f=b.display.pluginInstances[e],g=f.plugin.opts,f.isActive("onimageclose")))try{g.onimageclose.call(f,b)}catch(k){f.errLog("onimageclose",k)}for(c in b.layers)b.layers.hasOwnProperty(c)&&b.layers[c].canvas.clear();b.display.image=null;switch(b.cmapObj.name){case "red":a.globalOpts.rgb.rim=null;break;case "green":a.globalOpts.rgb.gim=null;break;case "blue":a.globalOpts.rgb.bim=
null}if(a.fits.cleanupFITSFile)for(c=0;c<b.raws.length;c++)b.raws[c].hdu&&b.raws[c].hdu.fits&&(e=!0,"raw0"===b.raws[c].id&&(f=a.lookupVfile(b.raws[c].hdu.fits.vfile),1<f.length&&(e=!1)),a.fits.cleanupFITSFile(b.raws[c].hdu.fits,e));b.proxyFile&&a.Send("removeproxy",{cmd:"js9Xeq removeproxy "+b.proxyFile},j);b.rgb=null;b.offscreen=null;b.raw=null;b.colorData=null;b.colorCells=null;b.psColors=null;b=b.psInverse=null;a.images.splice(d,1);break}for(d=0;d<a.images.length;d++)if(b=a.images[d],h===b.display){b.displayImage("display");
b.refreshLayers();break}};a.Image.prototype.mkOffScreenCanvas=function(){if(!this.png||!this.png.image)return this;this.offscreen={};this.offscreen.canvas=document.createElement("canvas");this.offscreen.canvas.setAttribute("width",this.png.image.width);this.offscreen.canvas.setAttribute("height",this.png.image.height);this.offscreen.context=this.offscreen.canvas.getContext("2d");a.ANTIALIAS||(this.offscreen.context.imageSmoothingEnabled=!1,this.offscreen.context.mozImageSmoothingEnabled=!1,this.offscreen.context.webkitImageSmoothingEnabled=
!1);this.offscreen.context.drawImage(this.png.image,0,0);try{this.offscreen.img=this.offscreen.context.getImageData(0,0,this.png.image.width,this.png.image.height)}catch(d){"Chrome"===a.BROWSER[0]&&""===document.domain?alert("When using the file:// URI, Chrome must be run with the --allow-file-access-from-files switch to permit JS9 to access data."):alert("could not read off-screen image data [same-origin policy violation?]")}return this};a.Image.prototype.initLCS=function(a){var c=[[0,0,0],[0,0,
0],[0,0,0]],b=function(a){var d,b,c=0,j=0,k=[[0,0,0],[0,0,0],[0,0,0]],m=a[0][0]*a[1][1];for(d=0;3>d;d++)for(b=0;2>b;b++)if(void 0===a[d][b]||isNaN(a[d][b]))return null;0<=m?c+=m:j+=m;m=-a[0][1]*a[1][0];0<=m?c+=m:j+=m;d=c+j;if(0===d||1E-15>Math.abs(d/(c-j)))return null;d=1/d;k[0][0]=a[1][1]*d;k[1][0]=-a[1][0]*d;k[0][1]=-a[0][1]*d;k[1][1]=a[0][0]*d;k[2][0]=-(a[2][0]*k[0][0]+a[2][1]*k[1][0]);k[2][1]=-(a[2][0]*k[0][1]+a[2][1]*k[1][1]);return k};a&&(c[0][0]=a.LTM1_1||1,c[1][0]=a.LTM2_1||0,c[0][1]=a.LTM1_2||
0,c[1][1]=a.LTM2_2||1,c[2][0]=a.LTV1||0,c[2][1]=a.LTV2||0,this.lcs.physical={forward:$.extend(!0,[],c),reverse:b(c)},this.lcs.physical.reverse||delete this.lcs.physical,c[0][0]=a.DTM1_1||1,c[1][0]=a.DTM2_1||0,c[0][1]=a.DTM1_2||0,c[1][1]=a.DTM2_2||1,c[2][0]=a.DTV1||0,c[2][1]=a.DTV2||0,this.lcs.detector={forward:$.extend(!0,[],c),reverse:b(c)},this.lcs.detector.reverse||delete this.lcs.detector,c[0][0]=a.ATM1_1||1,c[1][0]=a.ATM2_1||0,c[0][1]=a.ATM1_2||0,c[1][1]=a.ATM2_2||1,c[2][0]=a.ATV1||0,c[2][1]=
a.ATV2||0,this.lcs.amplifier={forward:$.extend(!0,[],c),reverse:b(c)},this.lcs.amplifier.reverse||delete this.lcs.amplifier,this.lcs[this.params.lcs]||(this.params.lcs="image"),this.params.wcssys0||(this.setWCSSys("physical"),this.params.wcssys0=this.params.lcs))};a.Image.prototype.mkRawDataFromIMG=function(d){var c,b,e,f,g,h;if(d){c=d.height;b=d.width;e=d.data;this.raws.push({from:"img"});this.raw=this.raws[this.raws.length-1];this.raw.id=a.RAWID0;this.raw.data=new Float32Array(c*b);for(g=d=0;g<
c;g++)for(f=0;f<b;f++)h=0.299*e[d]+0.587*e[d+1]+0.114*e[d+2],this.raw.data[(c-g)*b+f]=h,d+=4;this.raw.width=b;this.raw.height=c;this.raw.bitpix=-32;this.raw.dmin=Number.MAX_VALUE;this.raw.dmax=Number.MIN_VALUE;for(d=0;d<c*b;d++)isNaN(this.raw.data[d])||(this.raw.dmin=Math.min(this.raw.dmin,this.raw.data[d]),this.raw.dmax=Math.max(this.raw.dmax,this.raw.data[d]));isNaN(this.params.scalemin)&&(this.params.scalemin=this.raw.dmin);isNaN(this.params.scalemax)&&(this.params.scalemax=this.raw.dmax);this.source=
"png";this.raw.header={SIMPLE:!0,NAXIS:2,NAXIS1:this.raw.width,NAXIS2:this.raw.height,BITPIX:this.raw.bitpix};return this}};a.Image.prototype.mkRawDataFromPNG=function(){var d,c,b,e,f,g,h,j;h=[];b=new ArrayBuffer(8);var k=new Uint8Array(b),m=new DataView(b);if(!this.offscreen.img)return this;this.raws.push({from:"png"});this.raw=this.raws[this.raws.length-1];this.raw.id=a.RAWID0;e=this.offscreen.img.data;for(d=b=0;b<e.length&&0!==e[b];b++)if(255!==e[b]&&(h[d]=String.fromCharCode(e[b]),d++),15===d&&
'{"js9Protocol":'!==h.join("")){f=!0;break}if(!(15>d||f)){d=h.join("");2<a.DEBUG&&a.log("jsonHeader: %s",d);try{c=JSON.parse(d)}catch(n){a.error("can't read FITS header from PNG file: "+d,n)}if(1===c.js9Protocol)this.raw.header=c,this.raw.endian=this.raw.header.js9Endian,this.raw.protocol=this.raw.header.js9Protocol;else{this.raw.endian=c.js9Endian;this.raw.protocol=c.js9Protocol;this.raw.cardstr=c.cardstr;this.raw.ncard=c.ncard;this.raw.header={};c=this.raw.ncard;for(d=0;d<c;d++)f=this.raw.cardstr.slice(80*
d,80*(d+1)),f=a.cardpars(f),void 0!==f&&(this.raw.header[f[0]]=f[1])}b+=1;this.raw.header.NAXIS1?this.raw.width=this.raw.header.NAXIS1:a.error("NAXIS1 missing from PNG-based FITS header");this.raw.header.NAXIS2?this.raw.height=this.raw.header.NAXIS2:a.error("NAXIS2 missing from PNG-based FITS header");this.raw.header.BITPIX?this.raw.bitpix=this.raw.header.BITPIX:a.error("BITPIX missing from PNG-based FITS header");"little"===this.raw.endian?j=!0:"big"===this.raw.endian?j=!1:a.error("js9Endian missing from PNG-based FITS header");
this.object=this.raw.header.OBJECT;this.raw.dmin=Number.MAX_VALUE;this.raw.dmax=Number.MIN_VALUE;c=this.raw.width*this.raw.height;f=b%4;switch(this.raw.bitpix){case 8:this.raw.data=new Uint8Array(c);for(d=0;d<c;d++){switch(f){case 0:g=e[b];b+=1;f=1;break;case 1:g=e[b];b+=1;f=2;break;case 2:g=e[b];b+=2;f=0;break;case 3:g=e[b+1],b+=2,f=1}this.raw.data[d]=g;isNaN(g)||(this.raw.dmin=Math.min(this.raw.dmin,g),this.raw.dmax=Math.max(this.raw.dmax,g))}break;case 16:case -16:16===this.raw.bitpix?(this.raw.data=
new Int16Array(c),h=DataView.prototype.getInt16):(this.raw.data=new Uint16Array(c),h=DataView.prototype.getUint16);for(d=0;d<c;d++){switch(f){case 0:k[0]=e[b];k[1]=e[b+1];g=h.call(m,0,j);b+=2;f=2;break;case 1:k[0]=e[b];k[1]=e[b+1];g=h.call(m,0,j);b+=3;f=0;break;case 2:k[0]=e[b];k[1]=e[b+2];g=h.call(m,0,j);b+=3;f=1;break;case 3:k[0]=e[b+1],k[1]=e[b+2],g=h.call(m,0,j),b+=3,f=2}this.raw.data[d]=g;isNaN(g)||(this.raw.dmin=Math.min(this.raw.dmin,g),this.raw.dmax=Math.max(this.raw.dmax,g))}break;case 32:case -32:32===
this.raw.bitpix?(this.raw.data=new Int32Array(c),h=DataView.prototype.getInt32):(this.raw.data=new Float32Array(c),h=DataView.prototype.getFloat32);for(d=0;d<c;d++){switch(f){case 0:k[0]=e[b];k[1]=e[b+1];k[2]=e[b+2];k[3]=e[b+4];g=h.call(m,0,j);b+=5;f=1;break;case 1:k[0]=e[b];k[1]=e[b+1];k[2]=e[b+3];k[3]=e[b+4];g=h.call(m,0,j);b+=5;f=2;break;case 2:k[0]=e[b];k[1]=e[b+2];k[2]=e[b+3];k[3]=e[b+4];g=h.call(m,0,j);b+=6;f=0;break;case 3:k[0]=e[b+1],k[1]=e[b+2],k[2]=e[b+3],k[3]=e[b+5],g=h.call(m,0,j),b+=
6,f=1}this.raw.data[d]=g;isNaN(g)||(this.raw.dmin=Math.min(this.raw.dmin,g),this.raw.dmax=Math.max(this.raw.dmax,g))}break;case -64:this.raw.data=new Float64Array(c);for(d=0;d<c;d++){switch(f){case 0:case 4:k[0]=e[b];k[1]=e[b+1];k[2]=e[b+2];k[3]=e[b+4];k[4]=e[b+5];k[5]=e[b+6];k[6]=e[b+8];k[7]=e[b+9];g=m.getFloat64(0,j);b+=10;f=2;break;case 1:case 5:k[0]=e[b];k[1]=e[b+1];k[2]=e[b+3];k[3]=e[b+4];k[4]=e[b+5];k[5]=e[b+7];k[6]=e[b+8];k[7]=e[b+9];g=m.getFloat64(0,j);b+=11;f=0;break;case 2:case 6:k[0]=e[b];
k[1]=e[b+2];k[2]=e[b+3];k[3]=e[b+4];k[4]=e[b+6];k[5]=e[b+7];k[6]=e[b+8];k[7]=e[b+10];g=m.getFloat64(0,j);b+=11;f=1;break;case 3:case 7:k[0]=e[b+1],k[1]=e[b+2],k[2]=e[b+3],k[3]=e[b+5],k[4]=e[b+6],k[5]=e[b+7],k[6]=e[b+9],k[7]=e[b+10],g=m.getFloat64(0,j),b+=11,f=2}this.raw.data[d]=g;isNaN(g)||(this.raw.dmin=Math.min(this.raw.dmin,g),this.raw.dmax=Math.max(this.raw.dmax,g))}break;default:a.error("unsupported bitpix in PNG file: "+this.raw.bitpix)}isNaN(this.params.scalemin)&&(this.params.scalemin=this.raw.dmin);
isNaN(this.params.scalemax)&&(this.params.scalemax=this.raw.dmax);this.offscreen.img=null;this.wcs=a.initwcs(a.raw2FITS(this.raw));0<this.wcs&&(this.setWCSSys(this.params.wcssys),this.params.wcssys0=this.params.wcssys.trim());this.initLCS(this.raw.header);return this}};a.Image.prototype.mkRawDataFromHDU=function(d,c){var b,e,f,g,h,j,k,m;c=c||{};$.isArray(d)||a.isTypedArray(d)||d instanceof ArrayBuffer?($.isArray(d[0])&&(d=d.reduce(function(a,d){return a.concat(d)})),g={image:d}):"object"===typeof d?
g=d:a.error("unknown or missing input for HDU creation");g.data&&!g.image&&(g.image=g.data);g.image||a.error("data missing from JS9 FITS object"+JSON.stringify(g));2>g.naxis&&a.error("can't image a FITS file with less than 2 dimensions");c.file?this.file=c.file:g.filename&&(this.file=g.filename);this.file=this.file||a.ANON;this.id||(this.oid=this.file.split("/").reverse()[0],this.id=a.getImageID(this.oid,this.display.id));this.raw&&(j=this.raw.width,k=this.raw.height,m=this.raw.bitpix);if(h=this.raws.length){c.rawid=
c.rawid||a.RAWIDX;for(b=f=0;b<h;b++)if(c.rawid===this.raws[b].id){this.raws[b]={};this.raw=this.raws[b];f++;break}f||(this.raws.push({from:"hdu",id:c.rawid}),this.raw=this.raws[h])}else this.raws.push({from:"hdu"}),this.raw=this.raws[h],this.raw.id=a.RAWID0;this.raw.hdu=g;g.axis?(this.raw.width=g.axis[1],this.raw.height=g.axis[2]):g.naxis1&&g.naxis2?(this.raw.width=g.naxis1,this.raw.height=g.naxis2):j&&k&&(this.raw.width=j,this.raw.height=k);g.bitpix?this.raw.bitpix=g.bitpix:m&&(this.raw.bitpix=m);
if("base64"===g.encoding){e=window.atob(g.image);g.image=new ArrayBuffer(e.length);f=new Uint8Array(g.image);for(b=0;b<e.length;b++)f[b]=e.charCodeAt(b)}$.isArray(g.image[0])&&(g.image=g.image.reduce(function(a,d){return a.concat(d)}));switch(this.raw.bitpix){case 8:this.raw.data=new Uint8Array(g.image);break;case 16:this.raw.data=new Int16Array(g.image);break;case -16:this.raw.data=new Uint16Array(g.image);break;case 32:this.raw.data=new Int32Array(g.image);break;case -32:this.raw.data=new Float32Array(g.image);
break;case -64:this.raw.data=new Float64Array(g.image)}this.raw.card=g.card;this.raw.cardstr=g.cardstr;this.raw.ncard=g.ncard;if(g.head)this.raw.header=g.head;else if(this.raw.card){this.raw.header={};f=this.raw.card.length;for(b=0;b<f;b++)h=a.cardpars(this.raw.card[b]),void 0!==h&&(this.raw.header[h[0]]=h[1])}else if(this.raw.cardstr){this.raw.header={};f=this.raw.ncard;for(b=0;b<f;b++)h=this.raw.cardstr.slice(80*b,80*(b+1)),h=a.cardpars(h),void 0!==h&&(this.raw.header[h[0]]=h[1])}else this.raw.header=
{},this.raw.header.SIMPLE=!0,this.raw.header.NAXIS=2,this.raw.header.NAXIS1=this.raw.width,this.raw.header.NAXIS2=this.raw.height,this.raw.header.BITPIX=this.raw.bitpix;if(g.dmin&&g.dmax)this.raw.dmin=g.dmin,this.raw.dmax=g.dmax;else{this.raw.dmin=Number.MAX_VALUE;this.raw.dmax=Number.MIN_VALUE;f=this.raw.width*this.raw.height;for(b=0;b<f;b++)isNaN(this.raw.data[b])||(this.raw.dmin=Math.min(this.raw.dmin,this.raw.data[b]),this.raw.dmax=Math.max(this.raw.dmax,this.raw.data[b]))}this.imtab=g.imtab?
g.imtab:g.table?"table":"image";this.object=this.raw.header.OBJECT;this.binning.bin="table"===this.imtab&&g.table?Number(g.table.bin)||1:1;this.wcs=a.initwcs(a.raw2FITS(this.raw));0<this.wcs&&(this.setWCSSys(this.params.wcssys),this.params.wcssys0=this.params.wcssys.trim(),this.setWCSUnits(this.params.wcsunits));this.initLCS(this.raw.header);isNaN(this.params.scalemin)&&(this.params.scalemin=this.raw.dmin);isNaN(this.params.scalemax)&&(this.params.scalemax=this.raw.dmax);try{e=a.listhdu(this.raw.hdu.fits.vfile),
this.hdus=JSON.parse(e)}catch(n){}return this};a.Image.prototype.mkSection=function(a,c,b){var e=this.rgb.sect;switch(arguments.length){case 0:e.xcen=Math.floor(this.raw.width/2);e.ycen=Math.floor(this.raw.height/2);e.width=Math.min(this.raw.width,this.display.canvas.width);e.height=Math.min(this.raw.height,this.display.canvas.height);break;case 1:e.ozoom=e.zoom;e.zoom=a;e.width=Math.min(this.raw.width*e.zoom,this.display.canvas.width);e.height=Math.min(this.raw.height*e.zoom,this.display.canvas.height);
break;case 2:e.xcen=parseInt(a,10);e.ycen=parseInt(c,10);break;case 3:e.xcen=parseInt(a,10),e.ycen=parseInt(c,10),e.ozoom=e.zoom,e.zoom=b,e.width=Math.min(this.raw.width*e.zoom,this.display.canvas.width),e.height=Math.min(this.raw.height*e.zoom,this.display.canvas.height)}e.width=Math.floor(e.width);e.height=Math.floor(e.height);e.x0=Math.floor(e.xcen-(e.width+1)/(2*e.zoom)+1);e.y0=Math.floor(e.ycen-(e.height+1)/(2*e.zoom)+1);e.x1=Math.floor(e.xcen+e.width/(2*e.zoom));e.y1=Math.floor(e.ycen+e.height/
(2*e.zoom));0>e.x0&&(e.x1-=e.x0,e.x0=0);0>e.y0&&(e.y1-=e.y0,e.y0=0);e.x1>this.raw.width&&(e.x0-=e.x1-this.raw.width,e.x1=this.raw.width);e.y1>this.raw.height&&(e.y0-=e.y1-this.raw.height,e.y1=this.raw.height);e.x0=Math.max(0,e.x0);e.y0=Math.max(0,e.y0);this.offscreenRGB=null;return this};a.Image.prototype.mkColorData=function(){var d,c,b=a.SCALESIZE,e=this.params.scalemin,f=this.params.scalemax,g=this.raw.width*this.raw.height,h=(b-1)/(f-e);this.colorData||(this.colorData=[]);for(d=0;d<g;d++)c=this.raw.data[d],
this.colorData[d]=c<=e?0:c>=f?b-1:Math.floor((c-e)*h+0.5);return this};a.Image.prototype.calcContrastBias=function(d){var c=a.COLORSIZE,b=this.params.bias,e=this.params.contrast;if(1E-4>b-0.5&&1E-4>e-1)return d;this.params.invert&&(b=1-b);d=Math.floor(((d/c-b)*e+0.5)*c);return 0>d?0:d>=c?c-1:d};a.Image.prototype.mkColorCells=function(){var d,c,b=a.COLORSIZE;this.colorCells||(this.colorCells=[]);for(d=0;d<b;d++)c=this.params.invert?b-d-1:d,c=this.calcContrastBias(c),this.colorCells[d]=this.cmapObj.mkColorCell(c);
return this};a.Image.prototype.mkScaledCells=function(){var d,c,b,e,f,g,h=a.COLORSIZE,j=a.SCALESIZE;if(!this.colorCells)return this;if(!this.psColors){d=this.psColors=[];c=this.params.nancolor;var k=[];"#"===c.charAt(0)&&(c=c.slice(1));c=c.toUpperCase();for(e=b=0;6>b;b+=2,e++)f="0123456789ABCDEF".indexOf(c.charAt(b)),g="0123456789ABCDEF".indexOf(c.charAt(b+1)),k[e]=16*f+g;d[NaN]=k}this.psInverse||(this.psInverse=[],this.psInverse[NaN]=0);c=this.params.scalemax-this.params.scalemin;g=this.params.scalemin;
switch(this.params.scale){case "linear":for(b=0;b<j;b++)d=b/j,e=Math.floor(d*h),this.psColors[b]=this.colorCells[e],this.psInverse[b]=d*c+g;break;case "log":f=this.params.exp;for(b=0;b<j;b++)d=Math.log(f*b/j+1)/Math.log(f),e=Math.floor(d*h),e>=h&&(e=h-1),this.psColors[b]=this.colorCells[e],d=(Math.pow(f,b/j)-1)/f,this.psInverse[b]=d*c+g;break;case "pow":f=this.params.exp;for(b=0;b<j;b++)d=(Math.pow(f,b/j)-1)/f,e=Math.floor(d*h),e>=h&&(e=h-1),this.psColors[b]=this.colorCells[e],d=Math.log(f*b/j+1)/
Math.log(f),this.psInverse[b]=d*c+g;break;case "sqrt":for(b=0;b<j;b++)d=b/j,e=Math.floor(Math.sqrt(d)*h),e>=h&&(e=h-1),this.psColors[b]=this.colorCells[e],this.psInverse[b]=d*d*c+g;break;case "squared":for(b=0;b<j;b++)d=b/j,e=Math.floor(d*d*h),e>=h&&(e=h-1),this.psColors[b]=this.colorCells[e],d=Math.sqrt(b/j),this.psInverse[b]=d*c+g;break;case "asinh":for(b=0;b<j;b++)d=b/j,e=Math.floor(Math.asinh(10*d)/3*h),e>=h&&(e=h-1),this.psColors[b]=this.colorCells[e],e=Math.sinh(3*d)/10,this.psInverse[b]=e*
c+g;break;case "sinh":for(b=0;b<j;b++)d=b/j,e=Math.floor(Math.sinh(3*d)/10*h),e>=h&&(e=h-1),this.psColors[b]=this.colorCells[e],e=Math.asinh(10*d)/3,this.psInverse[b]=e*c+g;break;default:a.log("unknown scale '"+this.params.scale+"'")}return this};a.Image.prototype.mkRGBImage=function(){var d,c,b,e,f,g,h,j,k,m,n,p,r,l,q,s,t,v,u,w,y=null,x=null,B=null,F=!1;if(!this.rgb)return this;if(a.globalOpts.rgb.active&&(this===a.globalOpts.rgb.rim||this===a.globalOpts.rgb.gim||this===a.globalOpts.rgb.bim))F=!0,
a.globalOpts.rgb.rim&&(y=a.globalOpts.rgb.rim),a.globalOpts.rgb.gim&&(x=a.globalOpts.rgb.gim),a.globalOpts.rgb.bim&&(B=a.globalOpts.rgb.bim);h=this.display.context;d=this.rgb;c=d.sect;if(this.MakeRGBImage&&"function"===typeof this.MakeRGBImage&&this.MakeRGBImage()||this.MakePrimaryImage&&"function"===typeof this.MakePrimaryImage&&this.MakePrimaryImage())return this;if(this.rgbFile){f=c.width/c.zoom;g=c.height/c.zoom;b=c.x0;e=this.offscreen.canvas.height-1-(c.y0+g);e=this.offscreen.context.getImageData(b,
e,f,g);if(1===c.zoom)d.img=e;else{d.img=h.createImageData(c.width,c.height);d=d.img;for(m=j=0;j<e.height;j++,m++){s=j*e.width;p=m*c.zoom;for(k=h=0;h<e.width;h++,k++){b=4*(s+h);n=k*c.zoom;for(r=0;r<c.zoom;r++){l=Math.floor(p+r);t=l*c.width;for(l=0;l<c.zoom;l++)q=Math.floor(n+l),q=4*(t+q),d.data[q]=e.data[b],d.data[q+1]=e.data[b+1],d.data[q+2]=e.data[b+2],d.data[q+3]=e.data[b+3]}}}}return this}if(!d.img||d.img.width!==c.width||d.img.height!==c.height)d.img=h.createImageData(c.width,c.height);d=d.img;
if(!this.psColors)return this;v=void 0!==this.params.opacity?255*this.params.opacity:void 0!==this.params.alpha?this.params.alpha:255;this.maskData&&(this.params.maskInvert?void 0!==this.params.opacity&&void 0!==this.params.maskOpacity?(e=255*this.params.opacity,f=255*this.params.maskOpacity):void 0!==this.params.alpha1&&void 0!==this.params.alpha2?(e=this.params.alpha2,f=this.params.alpha1):(e=0,f=255):void 0!==this.params.opacity&&void 0!==this.params.maskOpacity?(e=255*this.params.maskOpacity,
f=255*this.params.opacity):void 0!==this.params.alpha1&&void 0!==this.params.alpha2?(e=this.params.alpha1,f=this.params.alpha2):(e=255,f=0));j=c.y1-1;for(m=0;j>=c.y0;j--,m++){s=j*this.raw.width;p=m*c.zoom;h=c.x0;for(k=0;h<c.x1;h++,k++){if(F){if(g=y?y.colorData[s+h]:0,u=x?x.colorData[s+h]:0,w=B?B.colorData[s+h]:0,void 0===g||void 0===u||void 0===w)return a.globalOpts.rgb.active=!1,a.error("RGB images are incompatible. Turning off RGB mode.","",!1),a.Image.prototype.mkRGBImage.call(this),this}else b=
this.colorData[s+h];this.maskData&&(v=0<this.maskData[s+h]?e:f);n=k*c.zoom;for(r=0;r<c.zoom;r++){l=Math.floor(p+r);t=l*c.width;for(l=0;l<c.zoom;l++)q=Math.floor(n+l),q=4*(t+q),F?(d.data[q]=y?y.psColors[g][0]:0,d.data[q+1]=x?x.psColors[u][1]:0,d.data[q+2]=B?B.psColors[w][2]:0):(d.data[q]=this.psColors[b][0],d.data[q+1]=this.psColors[b][1],d.data[q+2]=this.psColors[b][2]),d.data[q+3]=v}}}return this};a.Image.prototype.blendImage=function(d,c,b){var e=/normal|multiply|screen|overlay|darken|lighten|color-dodge|color-burn|hard-light|soft-light|difference|exclusion|hue|saturation|color|luminosity|clear|copy|source-over|destination-over|source-in|destination-in|source-out|destination-out|source-atop|destination-atop|xor|lighter/i;
if(0===arguments.length)return this.blend;if(!0===d||!1===d)return this.blend.active=d,this.display.blendMode&&this.displayImage(),this;if(a.notNull(d)||a.notNull(c))a.notNull(d)&&(e.test(d)||a.error("invalid composite/blend operation: "+d),this.blend.mode=d),a.notNull(c)&&(this.blend.opacity=c),a.notNull(b)&&(this.blend.active=b),this.display.blendMode&&this.blend.active&&this.displayImage();return this};a.noff=0;a.Image.prototype.putImage=function(d){var c,b,e=this.rgb;c=this.display;var f=c.context,
g=function(d,b){var c,e;d.offscreenRGB||(e=document.createElement("canvas"),c=e.getContext("2d"),e.width=b.width,e.height=b.height,a.ANTIALIAS||(c.imageSmoothingEnabled=!1,c.mozImageSmoothingEnabled=!1,c.webkitImageSmoothingEnabled=!1),c.putImageData(b,0,0),d.offscreenRGB={canvas:e,context:c});return d.offscreenRGB.canvas};d=d||{};this.ix=Math.floor((c.canvas.width-e.img.width)/2);this.iy=Math.floor((c.canvas.height-e.img.height)/2);"reproject"===this.rawDataLayer()&&(d.wcsim&&this.params.wcsalign)&&
(c=d.wcsim.logicalToDisplayPos({x:d.wcsim.raw.header.CRPIX1,y:d.wcsim.raw.header.CRPIX2}),b=this.logicalToDisplayPos({x:this.raw.header.CRPIX1,y:this.raw.header.CRPIX2}),this.wcsix=c.x-b.x,this.wcsiy=c.y-b.y);this.params.wcsalign&&(this.ix+=this.wcsix*this.rgb.sect.zoom,this.iy+=this.wcsiy*this.rgb.sect.zoom);a.notNull(d.opacity)||a.notNull(d.blend)?(f.save(),void 0!==d.opacity&&(f.globalAlpha=d.opacity),void 0!==d.blend&&(f.globalCompositeOperation=d.blend),f.drawImage(g(this,e.img),this.ix,this.iy),
f.restore()):f.putImageData(e.img,this.ix,this.iy)};a.Image.prototype.displayImage=function(d,c){var b,e,f,g;g=0;var h=[],j={};if(!1===d)return this.displayMode=!1,this;!0===d&&(this.displayMode=!0,d="all");if(!this.displayMode)return this;"object"===typeof d&&(c=d,d=null);d?"all"===d?(d="colors,scaled,rgb,display,plugins",j.notify=!0):"rgbonly"===d?(d="rgb,nodisplay",j.notify=!0):"display"===d&&(j.notify=!0):d="rgb";d.split(",").forEach(function(a){a=a.trim();j[a]=!0;switch(a){case "colors":j.scaled=
!0;j.rgb=!0;break;case "scaled":j.rgb=!0}});j.display=!0;j.plugins=!0;this.rgbFile&&(d.colors=!1,d.scaled=!1);c=c||{};if(this.display.blendMode)for(b=0;b<a.images.length;b++)e=a.images[b],e.display===this.display&&e.blend.active&&(h.push(e),g++);j.colors&&(this.mkColorData(),this.offscreenRGB=null);j.scaled&&(this.mkColorCells(),this.mkScaledCells(),this.offscreenRGB=null);if(j.rgb&&(this.mkRGBImage(),this.offscreenRGB=null,g))for(b=h.length-1;0<=b;b--)e=h[b],e.mkRGBImage(),e.offscreenRGB=null;if(j.nodisplay)return this;
if(j.display){this.display.context.clear();if(g)for(b=h.length-1;0<=b;b--)e=h[b],g={blend:e.blend.mode,opacity:e.blend.opacity},e.putImage(g),e===this&&(e.displayShapeLayers(),j.notify&&e.notifyHelper());else this.putImage(c),this.displayShapeLayers(),j.notify&&this.notifyHelper();this.display.image=this}if(j.plugins)for(f in this.display.pluginInstances)if(this.display.pluginInstances.hasOwnProperty(f)&&(b=this.display.pluginInstances[f],e=b.plugin.opts,b.isActive("onimagedisplay")&&("JS9Panner"===
f||j.display)))try{e.onimagedisplay.call(b,this)}catch(k){b.errLog("onimagedisplay",k)}return this};a.Image.prototype.refreshImage=function(d,c){var b,e,f,g,h,j;c=c||{};c.rawid=c.rawid||a.RAWID0;"function"===typeof c&&(c={onrefresh:c});!c.onrefresh&&a.imageOpts.onrefresh&&(c.onrefresh=a.imageOpts.onrefresh);b=this.rgb.sect.xcen;e=this.rgb.sect.ycen;h=this.rgb.sect.zoom;f=this.raw.width;g=this.raw.height;this.binning.obin=this.binning.bin;this.mkRawDataFromHDU(d,c);this.raw.width===f&&this.raw.height===
g?this.mkSection(b,e,h):(this.mkSection(),this.mkSection(h));this.displayImage("colors",c);this.refreshLayers();this.updateShapes("regions","all","binning");if(c.onrefresh)try{a.xeqByName(c.onrefresh,window,this)}catch(k){a.error("in image refresh callback",k)}for(j in this.display.pluginInstances)if(this.display.pluginInstances.hasOwnProperty(j)&&(b=this.display.pluginInstances[j],e=b.plugin.opts,b.isActive("onimagerefresh")))try{e.onimagerefresh.call(b,this)}catch(m){b.errLog("onimagerefresh",m)}};
a.Image.prototype.displayExtension=function(d,c){var b,e,f=this,g=function(e){c.separate?(b=sprintf("[%s]",d),c.id=f.id.replace(/\[.*\]/,"")+b,e.filename=f.file.replace(/\[.*\]/,"")+b,a.Load(e,c,{display:c.display||f.display})):f.refreshImage(e,a.fits.options)};void 0===d&&a.error("missing extname/extnum for displayExtension()");c=c||{};this.raw.hdu&&this.raw.hdu.fits&&this.raw.hdu.fits.fptr?(e={fptr:this.raw.hdu.fits.fptr,vfile:this.raw.hdu.vfile},"string"===typeof d?e.extname=d:"number"===typeof d&&
(e.extnum=d),a.fits.handleFITSFile("",e,g)):a.error("virtual FITS file is missing for displayExtension()")};a.Image.prototype.toArray=function(){var d,c,b,e,f,g,h,j,k,m;k=this.raw.data.buffer;g=a.raw2FITS(this.raw);h=2880-g.length%2880;2880===h&&(h=0);for(d=0;d<h;d++)g+=" ";h=2880-k.byteLength%2880;2880===h&&(h=0);d=new ArrayBuffer(g.length+k.byteLength+h);j=new Uint8Array(d);for(d=0;d<g.length;d++)j[d]=g.charCodeAt(d);if(0<(new Int8Array((new Int16Array([1])).buffer))[0]){f=g.length;e=Math.abs(this.raw.bitpix)/
8;m=new Uint8Array(k);for(d=0;d<m.byteLength;d+=e){c=d+e-1;for(b=0;b<e;c--,b++)j[f++]=m[c]}}else j.set(new Uint8Array(k),g.length);f=g.length+k.byteLength;for(d=0;d<h;d++)j[f++]=0;return j};a.Image.prototype.getPan=function(){return{x:(this.rgb.sect.x0+this.rgb.sect.x1)/2+1,y:(this.rgb.sect.y0+this.rgb.sect.y1)/2+1}};a.Image.prototype.setPan=function(d,c){var b,e,f,g,h,j=this.raw.width/2,k=this.raw.height/2;0===arguments.length&&(d=j,c=k);this.mkSection(d,c);if(this.display.blendMode)for(b=0;b<a.images.length;b++)h=
a.images[b],h!==this&&(h.display===this.display&&h.blend.active)&&(f=h.raw.width/2,g=h.raw.height/2,0!==arguments.length&&(f-=j-d,g-=k-c),a.Image.prototype.mkSection.call(h,f,g));this.displayImage("rgb");for(e in this.layers)this.layers.hasOwnProperty(e)&&this.layers[e].show&&this.layers[e].opts.panzoom&&this.refreshShapes(e);return this};a.Image.prototype.getZoom=function(){return this.rgb.sect.zoom};a.Image.prototype.parseZoom=function(a){var c;c=this.rgb.sect.zoom;switch(typeof a){case "string":switch(a.charAt(0)){case "*":case "x":case "X":a=
c*parseFloat(a.slice(1));break;case "/":a=c/parseFloat(a.slice(1));break;case "I":case "i":a=2*c;break;case "O":case "o":a=c/2;break;case "T":case "t":a=Math.min(this.display.width,this.display.height)/Math.max(this.raw.width,this.raw.height);break;default:a=parseFloat(a)}break;case "number":break;default:return}return a};a.Image.prototype.setZoom=function(d){var c,b,e;if(c=this.parseZoom(d)){this.mkSection(c);if(this.display.blendMode)for(d=0;d<a.images.length;d++)e=a.images[d],e!==this&&(e.display===
this.display&&e.blend.active)&&a.Image.prototype.mkSection.call(e,c);this.displayImage("rgb");for(b in this.layers)this.layers.hasOwnProperty(b)&&this.layers[b].show&&this.layers[b].opts.panzoom&&this.refreshShapes(b);return this}};a.Image.prototype.refreshLayers=function(){this.setZoom(this.getZoom())};a.Image.prototype.imageToLogicalPos=function(a,c){var b,e=a.x,f=a.y,g="image";c=c||this.params.lcs||"image";switch(c){case "physical":this.lcs.physical&&(g=c,b=this.lcs.physical.reverse);break;case "detector":this.lcs.detector&&
(g=c,b=this.lcs.detector.reverse);break;case "amplifier":this.lcs.amplifier&&(g=c,b=this.lcs.amplifier.reverse)}b&&(e=a.x*b[0][0]+a.y*b[1][0]+b[2][0],f=a.x*b[0][1]+a.y*b[1][1]+b[2][1]);return{x:e,y:f,sys:g}};a.Image.prototype.logicalToImagePos=function(a,c){var b,e={x:a.x,y:a.y};c=c||this.params.lcs||"image";switch(c){case "physical":this.lcs.physical&&(b=this.lcs.physical.forward);break;case "detector":this.lcs.detector&&(b=this.lcs.detector.forward);break;case "amplifier":this.lcs.amplifier&&(b=
this.lcs.amplifier.forward)}b&&(e.x=a.x*b[0][0]+a.y*b[1][0]+b[2][0],e.y=a.x*b[0][1]+a.y*b[1][1]+b[2][1]);return e};a.Image.prototype.displayToImagePos=function(a){var c=this.rgb,b=this.rgb.sect,e={};1>=b.zoom?(e.x=(a.x-this.ix)/b.zoom+b.x0+1,e.y=(c.img.height-1-(a.y-this.iy))/b.zoom+b.y0+1):(e.x=(a.x-this.ix)/b.zoom+b.x0+1-0.5,e.y=(c.img.height-1-(a.y-this.iy))/b.zoom+b.y0+1-0.5);return e};a.Image.prototype.imageToDisplayPos=function(a){var c=this.rgb,b=this.rgb.sect,e={};1>=b.zoom?(e.x=(a.x-1-b.x0)*
b.zoom+this.ix,e.y=(b.y0-(a.y-1))*b.zoom+(c.img.height-1)+this.iy):(e.x=(a.x-1+0.5-b.x0)*b.zoom+this.ix,e.y=(b.y0-(a.y-1+0.5))*b.zoom+(c.img.height-1)+this.iy);return e};a.Image.prototype.logicalToDisplayPos=function(a){return this.imageToDisplayPos(this.logicalToImagePos(a))};a.Image.prototype.displayToLogicalPos=function(a){return this.imageToLogicalPos(this.displayToImagePos(a))};a.Image.prototype.getWCSSys=function(){if(this.params.wcssys)return this.params.wcssys};a.Image.prototype.setWCSSys=
function(d){if("image"===d)this.params.wcssys="image",this.params.wcsunits="pixels";else if("physical"===d)this.params.wcssys="physical",this.params.wcsunits="pixels";else if(this.wcs&&0<this.wcs){"native"===d&&(d=this.params.wcssys0);if(d=a.wcssys(this.wcs,d))this.params.wcssys=d.trim(),d="pixels"===this.params.wcsunits?a.imageOpts.wcsunits:this.params.wcsunits,this.setWCSUnits(d),this.updateShapes("regions","all","update");return this}};a.Image.prototype.getWCSUnits=function(){return this.params.wcsunits?
this.params.wcsunits:"pixels"};a.Image.prototype.setWCSUnits=function(d){var c;if("pixels"===d)this.params.wcssys="physical",this.params.wcsunits="pixels";else{if(this.wcs&&0<this.wcs){if("image"===this.params.wcssys||"physical"===this.params.wcssys)c=a.imageOpts.wcssys,this.setWCSSys(this.wcs,c);if(d=a.wcsunits(this.wcs,d))this.params.wcsunits=d.trim(),this.updateShapes("regions","all","update")}return this}};a.Image.prototype.notifyHelper=function(){var d,c=this;a.helper.connected&&this.file!==
a.ANON&&a.helper.send("image",{image:this.file},function(b){var e,f;"object"===typeof b?(e=b.stdout,b.stderr&&1<a.DEBUG&&a.log(b.stderr)):e=b;if(e){e=e.trim().split(/ +/);if((b=a.lookupImage(e[0],c.display.id||a.DEFID))&&!b.fitsFile)if(e=e[1],"?"!==e){if(a.analOpts.dataDir)f=e.lastIndexOf("/")+1,b.fitsFile=a.analOpts.dataDir+"/"+e.slice(f);else{b.fitsFile=e;if(0>b.fitsFile.indexOf("/")&&(d=b.file.match(/.*\//)))b.fitsFile=d+b.fitsFile;a.analOpts.prependJS9Dir&&(b.fitsFile&&"/"!==b.fitsFile.charAt(0)&&
(b.fitsFile="${JS9_DIR}/"+b.fitsFile),b.parentFile&&"/"!==b.parentFile.charAt(0)&&(b.parentFile="${JS9_DIR}/"+b.parentFile))}1<a.DEBUG&&a.log("JS9 fitsFile: %s %s",b.file,b.fitsFile)}c.queried||(c.queryHelper("all"),c.queried=!0)}});return this};a.Image.prototype.queryHelper=function(d){var c=this;d=d||"all";if(a.helper.connected&&("all"===d||"getAnalysis"===d))this.analysisPackages||a.helper.send("getAnalysis",{fits:this.fitsFile},function(d){if(d)try{c.analysisPackages=JSON.parse(d)}catch(e){a.log("can't get analysis",
e)}});return this};a.Image.prototype.expandMacro=function(d,c){var b,e,f=this;if(d)return b=d.replace(/\$([a-zA-Z0-9_()]+)/g,function(d,b){var j,k;j=function(a,d){var b=a.params.wcssys;if(d)switch(d){case "wcs":if("physical"===b||"image"===b)a.params.wcssys=a.params.wcssys0;break;case "physical":case "image":a.params.wcssys=d}return b};var m=b.split("(");m[1]&&(m[1]=m[1].replace(/\)$/,""));switch(m[0]){case "id":k=f.display.divjq.attr("id");break;case "image":case "png":k=f.id;break;case "filename":"parent"===
m[1]&&f.parentFile?k=f.parentFile:f.fitsFile?(k=f.fitsFile,"table"===f.imtab&&f.raw.hdu.table.filter&&(k+="[EVENTS]["+f.raw.hdu.table.filter+"]")):a.error("no FITS file for "+f.id);break;case "fits":f.fitsFile||a.error("no FITS file for "+f.id);k=f.fitsFile;"table"===f.imtab&&f.raw.hdu.table.filter&&(k+="[EVENTS]["+f.raw.hdu.table.filter+"]");break;case "parent":f.parentFile||a.error("no parent FITS file for "+f.id);k=f.parentFile;break;case "ext":f.fitsFile?k=f.fitsFile.match(/\[.*\]/):a.error("no FITS file for "+
f.id);break;case "sregions":j=j(f,m[1]);k=f.listRegions("source",0).replace(/\s+/g,"");j&&(f.params.wcssys=j);break;case "bregions":j=j(f,m[1]);k=f.listRegions("background",0).replace(/\s+/g,"");j&&(f.params.wcssys=j);break;case "regions":j=j(f,m[1]);k=f.listRegions("all",0).replace(/\s+/g,"");j&&(f.params.wcssys=j);break;default:if(c){e=c.length;for(j=0;j<e;j++)if(c[j].name===b){k=c[j].value;break}k||(k="false")}k||(k=d)}return k})};a.Image.prototype.lookupAnalysis=function(a){var c,b,e,f=null;if(this.analysisPackages){for(b=
0;b<this.analysisPackages.length&&!f;b++){e=this.analysisPackages[b];for(c=0;c<e.length;c++){f=e[c];if(f.xclass&&f.xclass+":"+f.name===a)break;f=null}}if(f)return f;for(b=0;b<this.analysisPackages.length&&!f;b++){e=this.analysisPackages[b];for(c=0;c<e.length;c++){f=e[c];if(f.name===a)break;f=null}}}return f};a.Image.prototype.runAnalysis=function(d,c,b){var e,f,g=this,h={};if(a.helper.connected&&this.analysisPackages)if(e=this.lookupAnalysis(d)){e.action&&(h.cmd=this.expandMacro(e.action,c));if(e.keys){h.keys=
{};for(d=0;d<e.keys.length;d++)h.keys[e.keys[d]]=this.expandMacro("$"+e.keys[d],c)}h.id=this.expandMacro("$id");h.image=this.file;h.fits=this.fitsFile;h.rtype=e.rtype;switch(a.helper.type){case "nodejs":case "socket.io":c=e.xclass?e.xclass+":"+e.name:e.name;break;default:c="runAnalysis"}a.waiting(!0,this.display.divjq[0]);a.helper.send(c,h,function(d){var c;a.waiting(!1);c="object"===typeof d?d:0<=d.search(a.analOpts.epattern)?{stderr:d}:{stdout:d};c.errcode=c.errcode||0;if(b)b(c.stdout,c.stderr,
c.errcode,e);else{if(c.errcode||c.stderr)d=c.stderr?c.stderr:sprintf("ERROR: while executing %s [%s]",e.name,c.errcode),0<=d.search(/WARNING/i)?a.log(d):a.error(d,a.analOpts.epattern);switch(e.rtype){case "text":case void 0:g.displayAnalysis("text",c.stdout);break;case "plot":g.displayAnalysis("plot",c.stdout);break;case "alert":c.stdout&&alert(c.stdout);break;case "fits":case "png":f=c.stdout.trim();"/"!==f.charAt(0)&&(f=a.InstallDir(f));a.Load(f,{proxyFile:f},{display:g.display});break;case "none":break;
default:a.error("unknown analysis result type: "+e.rtype)}}})}else a.error("could not find analysis task: "+d)};a.Image.prototype.displayAnalysis=function(d,c,b,e){var f,g,h,j=a.lightOpts[a.LIGHTWIN];!b&&this&&(b=this.fitsFile||this.id,b=b.split("/").reverse()[0],b="AnalysisResults: "+b);f="Analysis_"+a.uniqueID();switch(d){case "text":g="<div class='JS9Analysis'></div>";c&&(g+="<pre class='JS9AnalysisText'>"+c+"</pre>");g=a.lightWin(f,"inline",g+"</div>",b,e||j.textWin);break;case "plot":try{h=JSON.parse(c)}catch(k){a.error("can't plot return data: "+
c,k)}if(!h)return;g=sprintf("<div id='%s' class='JS9Analysis'><div id='%sPlot' class='JS9Plot' ></div></div>",f,f);g=a.lightWin(f,"inline",g,b,e||j.plotWin);c=$("#"+f+" #"+f+"Plot");if(h.data){e=this?this.params.plotOpts:a.plotOpts;try{$.plot(c,[h],e)}catch(m){a.error("can't plot data",m)}}break;case "params":g=a.allinone?a.lightWin(f,"inline",c,b,e||j.paramWin):a.lightWin(f,"ajax",c,b,e||j.paramWin);break;case "textline":g=a.allinone?a.lightWin(f,"inline",c,b,e||j.dpathWin):a.lightWin(f,"ajax",c,
b,e||j.dpathWin)}return g};a.Image.prototype.loadAuxFile=function(d,c){var b=this,e,f,g,h,j=a.auxFiles.length,k=[],m=function(){b.aux[f.name]=f;a.Image.prototype.mkOffScreenCanvas.call(h);a.Image.prototype.mkRawDataFromPNG.call(h);if(c)try{a.xeqByName(c,window,b,f)}catch(d){a.error("in aux mask onload callback",d)}a.DEBUG&&a.log("JS9 %s: %s dims(%d,%d) min/max(%d,%d)",h.type,h.file,h.raw.width,h.raw.height,h.raw.dmin,h.raw.dmax)},n=function(d){b.aux[f.name]=f;f.regions=d;if(c)try{a.xeqByName(c,window,
b,f)}catch(e){a.error("in aux region onload callback",e)}},p=function(d){b.aux[f.name]=f;f.text=d;if(c)try{a.xeqByName(c,window,b,f)}catch(e){a.error("in aux text onload callback",e)}},r=function(d,b){a.log(sprintf("could not load auxiliary file: %s [%s]",f.url,b))};if(d&&j){for(e=0;e<j;e++)f=a.auxFiles[e],f.image&&!f.regex&&(f.regex=RegExp(f.image));g=d.split(":");for(e=0;e<j;e++)if(f=a.auxFiles[e],g[0]===f.name&&this.id.match(f.regex)&&(1===g.length||g[1]===f.type))switch(f.type){case "mask":if(f.im){if(this.aux[f.name]=
f,c)try{a.xeqByName(c,window,this,f)}catch(l){a.error("in aux mask callback",l)}}else k.push(f);break;case "regions":if(f.layer){if(this.aux[f.name]=f,c)try{a.xeqByName(c,window,this,f)}catch(q){a.error("in aux regions callback",q)}}else k.push(f);break;case "text":if(f.text){if(this.aux[f.name]=f,c)try{a.xeqByName(c,window,this,f)}catch(s){a.error("in aux text callback",s)}}else k.push(f)}for(e=0;e<k.length;e++)switch(f=k[e],f.type){case "mask":f.im={};h=f.im;h.type="aux";h.file=f.url;h.id=h.file.split("/").reverse()[0];
h.params={};h.params.scalemin=Number.Nan;h.params.scalemax=Number.Nan;h.png={};h.png.image=new Image;$(h.png.image).on("load",m).on("error",r);h.png.image.src=a.InstallDir(f.url);break;case "regions":f.layer=this.display.newShapeLayer(d,a.Regions.opts);g=a.InstallDir(f.url);$.ajax({url:g,cache:!1,dataType:"json",success:n,error:r});break;case "text":g=a.InstallDir(f.url),$.ajax({url:g,cache:!1,dataType:"text",success:p,error:r})}}};a.Image.prototype.saveFITS=function(d){var c;window.hasOwnProperty("saveAs")?
(d=d||"js9.fits",c=this.toArray(),c=new Blob([c],{type:"application/octet-binary"}),saveAs(c,d)):a.error("no saveAs function available to save FITS file");return d};a.Image.prototype.saveIMG=function(d,c,b){var e,f,g;if(window.hasOwnProperty("saveAs")){d=d||"js9.png";f=document.createElement("canvas");f.setAttribute("width",this.display.width);f.setAttribute("height",this.display.height);g=f.getContext("2d");g.drawImage(this.display.canvas,0,0);for(e in this.layers)this.layers.hasOwnProperty(e)&&
"main"===this.layers[e].dlayer.dtype&&this.layers[e].show&&g.drawImage(this.layers[e].dlayer.canvasjq[0],0,0);if(void 0!==b&&(0>b||1<b))b=0.95;f.toBlob(function(a){saveAs(a,d)},c||"image/png",b)}else a.error("no saveAs function available for saving image");return d};a.Image.prototype.savePNG=function(a){this.saveIMG(a||"js9.png","image/png")};a.Image.prototype.saveJPEG=function(a,c){this.saveIMG(a||"js9.jpeg","image/jpeg",c)};a.Image.prototype.updateValpos=function(d,c){var b,e,f,g,h;b=null;f=a.floatPrecision(this.params.scalemin,
this.params.scalemax);e=function(a,d){return a.toFixed(d||3)};var j=function(a,d){var b="",c="";d=d||3;0>a&&(a=Math.abs(a),c="-");for(b+=a;b.length<d;)b="0"+b;return c+b};if(this.params.valpos){void 0===c&&(c=!0);if(this.valpos)return c&&this.displayMessage("info",this.valpos),this.valpos;g={x:d.x,y:d.y,sys:"image"};h="image"===this.params.wcssys?g:this.imageToLogicalPos(d);b=this.raw.data[Math.floor(d.y-0.5)*this.raw.width+Math.floor(d.x-0.5)];switch(this.raw.bitpix){case 8:case 16:case -16:case 32:f=
j(b);break;case -32:case -64:f=a.floatFormattedString(b,f,3);break;default:f=j(b)}e="value("+f+") "+h.sys+"("+e(h.x,3)+", "+e(h.y,3)+")";b={ix:g.x,iy:g.y,isys:"image",px:h.x,py:h.y,psys:h.sys,ra:"",dec:"",wcssys:"",val:b,val3:f,vstr:e,id:this.id,file:this.file,object:this.object};0<this.wcs&&("image"!==this.params.wcssys&&"physical"!==this.params.wcssys)&&(g=a.pix2wcs(this.wcs,d.x,d.y).trim().split(/\s+/),e=e+" "+g[2]+"("+g[0]+", "+g[1]+")",b.ra=g[0],b.dec=g[1],b.wcssys=g[2],b.vstr=e);c&&this.displayMessage("info",
b)}return b};a.Image.prototype.getColormap=function(){if(this.cmapObj)return{colormap:this.cmapObj.name,contrast:this.params.contrast,bias:this.params.bias}};a.Image.prototype.setColormap=function(d,c,b){switch(arguments.length){case 1:case 3:switch(d){case "rgb":a.globalOpts.rgb.active=!a.globalOpts.rgb.active;break;case "invert":this.params.invert=!this.params.invert;break;case "reset":this.params.invert=a.imageOpts.invert;this.params.contrast=a.imageOpts.contrast;this.params.bias=a.imageOpts.bias;
break;default:if(this.cmapObj)switch(this.cmapObj.name){case "red":a.globalOpts.rgb.rim=null;break;case "green":a.globalOpts.rgb.gim=null;break;case "blue":a.globalOpts.rgb.bim=null}this.cmapObj=a.lookupColormap(d);this.params.colormap=this.cmapObj.name;switch(d){case "red":a.globalOpts.rgb.rim=this;break;case "green":a.globalOpts.rgb.gim=this;break;case "blue":a.globalOpts.rgb.bim=this}}3===arguments.length&&(isNaN(c)||(this.params.contrast=c),isNaN(b)||(this.params.bias=b));break;case 2:isNaN(d)||
(this.params.contrast=d),isNaN(c)||(this.params.bias=c)}this.displayImage("colors");return this};a.Image.prototype.getScale=function(){if(this.params.scale)return{scale:this.params.scale,scalemin:this.params.scalemin,scalemax:this.params.scalemax}};a.Image.prototype.setScale=function(d,c,b){var e=this,f=function(d){0<=a.scales.indexOf(d)?e.params.scale=d:a.error("unknown scale: "+d)};if(arguments.length){switch(arguments.length){case 1:f(d);break;case 2:this.params.scalemin=parseInt(d,10);this.params.scalemax=
parseInt(c,10);this.mkColorData();break;default:f(d),this.params.scalemin=parseInt(c,10),this.params.scalemax=parseInt(b,10),this.mkColorData()}this.displayImage("scaled")}return this};a.Image.prototype.zscale=function(d){var c,b,e;if(!a.zscale||!this.raw||!this.raw.data)return this;c=this.raw.data;b=c.length*c.BYTES_PER_ELEMENT;try{e=a.vmalloc(b)}catch(f){a.error("image too large for zscale malloc: "+b,f)}try{a.vmemcpy(new Uint8Array(c.buffer),e)}catch(g){a.error("can't copy image to zscale heap: "+
b,g)}c=a.zscale(e,this.raw.width,this.raw.height,this.raw.bitpix,this.params.zscalecontrast,this.params.zscalesamples,this.params.zscaleline);a.vfree(e);e=c.trim().split(" ");this.params.z1=parseFloat(e[0]);this.params.z2=parseFloat(e[1]);d&&(this.params.scalemin=this.params.z1,this.params.scalemax=this.params.z2);return this};a.Image.prototype.rawDataLayer=function(d,c){var b,e,f,g,h,j;if(!arguments.length)return this.raw.id;if("string"===typeof d)if("function"===typeof c)d={rawid:d};else{for(b=
0;b<this.raws.length;b++)if(d===this.raws[b].id){if("remove"===c)return"raw0"===d&&a.error("can't remove raw0 data layer"),this.raw=this.raws[b].current0&&this.raws[b].current0.id?this.raws[b].current0:this.raws[0],this.raws.splice(b,1),this.displayImage("all",d),!0;this.raw=this.raws[b];this.mkSection();this.displayImage("all",d);return!0}return!1}if("function"!==typeof c)return!1;d=d||{};g=d.rawid||a.RAWIDX;void 0===d.oraw&&(d.oraw="current0");if("current"===d.oraw)e=this.raw;else if("current0"===
d.oraw){for(b=0;b<this.raws.length;b++)if(g===this.raws[b].id){e=this.raws[b].current0;break}e||(e=this.raw)}else for(b=0;b<this.raws.length;b++)if(d.oraw===this.raws[b].id){e=this.raws[b];break}e||(e=this.raws[0]);h=-1;for(b=0;b<this.raws.length;b++)if(g===this.raws[b].id){f=this.raws[b];h=b;break}if(0>h||d.alwaysCopy){f=$.extend(!0,{},e);f.current0||(f.current0=e);if(d.bitpix){switch(d.bitpix){case 8:f.data=new Uint8Array(e.height*e.width);break;case 16:f.data=new Int16Array(e.height*e.width);break;
case -16:f.data=new Uint16Array(e.height*e.width);break;case 32:f.data=new Int32Array(e.height*e.width);break;case -32:f.data=new Float32Array(e.height*e.width);break;case -64:f.data=new Float64Array(e.height*e.width)}j=f.width*f.height;for(b=0;b<j;b++)f.data[b]=e.data[b];f.bitpix=d.bitpix}else switch(e.bitpix){case 8:f.data=new Uint8Array(e.data);break;case 16:f.data=new Int16Array(e.data);break;case -16:f.data=new Uint16Array(e.data);break;case 32:f.data=new Int32Array(e.data);break;case -32:f.data=
new Float32Array(e.data);break;case -64:f.data=new Float64Array(e.data)}f.id=g;f.from=d.from||f.from||"func"}c.call(this,e,f,d)&&(0<=h?this.raws[h]=f:this.raws.push(f),this.raw=f,this.displayImage("all",d));return!0};a.Image.prototype.gaussBlurData=function(d){var c={};void 0===d&&a.error("missing sigma value for gaussBlurData");c=c||{};c.bitpix=-64===this.raw.bitpix?-64:-32;c.oraw="current0";c.alwaysCopy=!0;c.rawid="gaussBlur";c.sigma=d;this.rawDataLayer(c,function(b,c){var f;switch(c.bitpix){case -32:f=
new Float32Array(c.data);break;case -64:f=new Float64Array(c.data);break;default:a.error("invalid temp bitpix for gaussBlur: "+c.bitpix)}gaussBlur(f,c.data,c.width,c.height,d);return!0})};a.Image.prototype.shiftData=function(d,c,b){(void 0===d||void 0===c)&&a.error("missing translation value(s) for shiftData");b=b||{};b.rawid="shift";b.x=d;b.y=c;this.rawDataLayer(b,function(a,d,b){var c,j,k,m,n=a.data.BYTES_PER_ELEMENT;void 0===d.xoff&&(d.xoff=0);void 0===d.yoff&&(d.yoff=0);d.xoff+=b.x;d.yoff+=b.y;
if(!b.fill||"clear"===b.fill)if("function"===typeof d.data.fill)d.data.fill(0);else for(b=0;b<d.data.length;b++)d.data[b]=0;for(b=0;b<a.height;b++)if(k=b+d.yoff,!(0>k||k>=a.height)){c=0;j=c+d.xoff;m=a.width;0>j&&(c-=j,m+=j,j=0);j+m>a.width&&(m-=j+m-a.width);if(0>=m)return!1;c=(b*a.width+c)*n;c=new Uint8Array(a.data.buffer,c,m*n);j=(k*a.width+j)*n;m=new Uint8Array(d.data.buffer,j,m*n);m.set(c)}return!0})};a.Image.prototype.reprojectData=function(d,c){var b=this,e={},f=!1,g,h,j,k,m,n,p,r,l;l=/NAXIS|NAXIS[1-4]|AMDX|AMDY|CD[1-2]_[1-2]|CDELT[1-4]|CNPIX[1-4]|CO1_[1-9][0-9]|CO2_[1-9][0-9]|CROTA[1-4]|CRPIX[1-4]|CRVAL[1-4]|CTYPE[1-4]|CUNIT[1-4]|DATE|DATE_OBS|DC-FLAG|DEC|DETSEC|DETSIZE|EPOCH|EQUINOX|EQUINOX[a-z]|IMAGEH|IMAGEW|LATPOLE|LONGPOLE|MJD-OBS|PC00[1-4]00[1-4]|PC[1-4]_[1-4]|PIXSCALE|PIXSCAL[1-2]|PLTDECH|PLTDECM|PLTDECS|PLTDECSN|PLTRAH|PLTRAM|PLTRAS|PPO|PROJP[1-9]|PROJR0|PV[1-3]_[1-3]|PV[1-4]_[1-4]|RA|RADECSYS|SECPIX|SECPIX|SECPIX[1-2]|UT|UTMID|VELOCITY|VSOURCE|WCSAXES|WCSDEP|WCSDIM|WCSNAME|XPIXSIZE|YPIXSIZE|ZSOURCE|LTM|LTV/;
var q=function(d){b.refreshImage(d,n);a.waiting(!1)};if(this.wcs&&d&&a.reproject&&a.fits.handleFITSFile){c=c||{};a.waiting(!0,this.display.divjq[0]);"string"===typeof d&&((h=a.getImage(d))?d=h:a.error("unknown WCS for reproject: "+d));h=$.extend(!0,{},this.raw.header);for(r in h)h.hasOwnProperty(r)&&l.test(r)&&delete h[r];d.raw&&d.raw.header?j=d.raw.header:d.BITPIX&&d.NAXIS1&&d.NAXIS2?j=d:a.error("invalid wcs object input to reproject()");for(r in j)j.hasOwnProperty(r)&&l.test(r)&&(e[r]=j[r]);e=$.extend(!0,
{},h,e);(!e.NAXIS||!e.NAXIS1||!e.NAXIS2)&&a.error("invalid FITS image header");e.NAXIS1*e.NAXIS2>a.REPROJDIM*a.REPROJDIM&&a.error("for now, the maximum image size for reprojection is approximately "+a.REPROJDIM+" * "+a.REPROJDIM);e=a.raw2FITS(e,!0);g="wcs_"+a.uniqueID()+".txt";a.vfile(g,e);this.raw.hdu&&this.raw.hdu.vfile?k=this.raw.hdu.vfile:(e=this.toArray(),k=this.id.replace(/\.png$/,"_png.fits"),a.vfile(k,e));e=this.id.replace(/\.png$/,".fits").replace(/\.gz$/,"");m="reprojected_"+a.uniqueID()+
"_"+e;"table"===this.imtab&&(l=this.raw.hdu.table,e=Math.floor(l.cx-(l.nx+1)/2+1),j=Math.floor(l.cx+l.nx/2),r=Math.floor(l.cy-(l.ny+1)/2+1),l=Math.floor(l.cy+l.ny/2),e=sprintf("[EVENTS][bin X=%s:%s,Y=%s:%s]",e,j,r,l),k+=e);window.setTimeout(function(){var b,e,h,j;try{b=m.lastIndexOf("."),0<=b&&(e=m.substring(0,b)+"_area"+m.substring(b)),j=c.cmdswitches||"",p=a.reproject(k,m,g,j),1<a.DEBUG&&a.log("reproject: %s %s %s -> %s",k,m,g,p),a.vunlink(e),a.vunlink(g),0>p.search(/\[struct stat="OK"/)&&(f=!0,
(h=p.match(/msg="([^"]*)"/))&&h[1]?a.error(h[1]+" (from mProjectPP)"):a.error(p))}catch(l){if(f)return;a.vunlink(e);a.vunlink(g);p?a.error(p):a.error("WCS reproject failed",l)}n=$.extend(!0,{},c||{},a.fits.options);n.rawid=n.rawid||"reproject";n.wcsim=d;try{a.fits.handleFITSFile(m,n,q)}catch(r){a.error("can't process reprojected FITS file",r)}},a.SPINOUT)}};a.Image.prototype.filterRGBImage=function(d){var c,b=[],e=Array.prototype.slice.call(arguments);if(!d){for(c in a.ImageFilters)a.ImageFilters.hasOwnProperty(c)&&
b.push(c);return b}"reset"!==d&&!a.ImageFilters[d]&&a.error("JS9 image filter '"+d+"' not available");if("reset"===d)return this.setColormap("reset"),this;e.shift();e.unshift(this.rgb.img);try{a.ImageFilters[d].apply(null,e)}catch(f){a.error("JS9 image filter '"+d+"' failed",f)}this.displayImage("display");return this};a.Image.prototype.moveToDisplay=function(d){var c,b,e,f=this.display;b=a.lookupDisplay(d);if(!d||!b)return a.error("could not find display: "+d),null;this.clearMessage();this.display.context.clear();
for(c in f.layers)f.layers.hasOwnProperty(c)&&"main"===f.layers[c].dtype&&!b.layers[c]&&b.newShapeLayer(c,f.layers[c].opts);for(c in this.layers)this.layers.hasOwnProperty(c)&&(d=this.layers[c],(e=b.layers[c])&&"main"===e.dtype?(b.image&&b.image.showShapeLayer(c,!1),this.showShapeLayer(c,!1),d.dlayer=e,d.divjq=e.divjq,d.canvasjq=e.canvasjq,d.canvas=e.canvas,this.showShapeLayer(c,!0)):delete this.layers[c]);this.display=b;this.display.image=this;this.mkSection();this.displayImage("all");this.refreshLayers();
f.image=null;for(c=0;c<a.images.length;c++)if(b=a.images[c],f===b.display){b.display.image=null;b.displayImage("all");b.refreshLayers();break}};a.Colormap=function(d,c,b,e){this.name=d;switch(arguments.length){case 2:this.type="lut";this.colors=c;break;case 4:this.type="sao";this.vertices=[c,b,e];break;default:a.error("colormap requires a colormap name and 1 or 3 array args")}a.colormaps.push(this);1<a.DEBUG&&a.log("JS9 colormap:  %s",this.name)};a.Colormap.prototype.mkColorCell=function(d){var c,
b=a.COLORSIZE,e=[0,0,0];switch(this.type){case "sao":var f,g;d/=b;for(f=0;3>f;f++){g=this.vertices[f];c=g.length;for(b=0;b<c&&!(g[b][0]>d);b++);b=0===b?g[0][1]:b===c?g[c-1][1]:(c=(g[b][1]-g[b-1][1])/(g[b][0]-g[b-1][0]))?c*(d-g[b-1][0])+g[b-1][1]:g[b][1];e[f]=255*b}break;case "lut":f=this.colors.length;d=Math.floor(d*f/b);0>d?(e[0]=255*this.colors[0][0],e[1]=255*this.colors[0][1],e[2]=255*this.colors[0][2]):d<f?(e[0]=255*this.colors[d][0],e[1]=255*this.colors[d][1],e[2]=255*this.colors[d][2]):(e[0]=
255*this.colors[f-1][0],e[1]=255*this.colors[f-1][1],e[2]=255*this.colors[f-1][2]);break;default:a.error("unknown colormap type")}return e};a.Display=function(d){var c=this;this.divjq=d instanceof jQuery?d:"object"===typeof d?$(d):$("#"+d);this.divjq.attr("id")||this.divjq.attr("id",a.DEFID);this.id=this.divjq.attr("id");this.divjq.addClass("JS9");this.width=this.divjq.attr("data-width");this.width||(this.width=a.WIDTH);this.divjq.css("width",this.width);this.width=parseInt(this.divjq.css("width"),
10);this.height=this.divjq.attr("data-height");this.height||(this.height=a.HEIGHT);this.divjq.css("height",this.height);this.height=parseInt(this.divjq.css("height"),10);this.canvas=document.createElement("canvas");this.canvasjq=$(this.canvas).addClass("JS9Image").attr("id",this.id+"Image").attr("width",this.width).attr("height",this.height).css("z-index",a.ZINDEX);this.displayConjq=$("<div>").addClass("JS9Container").css("z-index",a.ZINDEX).attr("tabindex","0").append(this.canvasjq).appendTo(this.divjq);
a.globalOpts.resizeHandle&&window.hasOwnProperty("ResizeSensor")&&(this.divjq.css("resize","both").css("overflow","hidden"),a.bugs.webkit_resize&&(this.owidth=parseInt(this.divjq.css("width"),10),this.oheight=parseInt(this.divjq.css("height"),10),this.divjq.css("width",this.width+a.RESIZEFUDGE).css("height",this.height+a.RESIZEFUDGE)),this.resizeSensor=new ResizeSensor(this.divjq,function(){var d=c.divjq.width(),e=c.divjq.height();a.bugs.webkit_resize&&(d-=a.RESIZEFUDGE,e-=a.RESIZEFUDGE);c.resizing=
1;c.resize(d,e)}));this.context=this.canvas.getContext("2d");a.ANTIALIAS||(this.context.imageSmoothingEnabled=!1,this.context.mozImageSmoothingEnabled=!1,this.context.webkitImageSmoothingEnabled=!1);this.tooltip=$("<div>").attr("id","tooltip_"+this.id).addClass("JS9Tooltip").appendTo(this.divjq);this.image=null;this.pluginInstances={};this.layers={};this.initMessages();this.blendMode=!1;this.divjq.on("mouseover",this,function(d){return a.mouseOverCB(d)});this.divjq.on("mousedown touchstart",this,
function(d){return a.mouseDownCB(d)});this.divjq.on("mousemove touchmove",this,function(d){return a.mouseMoveCB(d)});this.divjq.on("mouseup touchend",this,function(d){return a.mouseUpCB(d)});this.divjq.on("mouseout",this,function(d){return a.mouseOutCB(d)});this.divjq.on("keypress",this,function(d){return a.keyPressCB(d)});this.divjq.on("keydown",this,function(d){return a.keyDownCB(d)});this.divjq.on("dragenter",this,function(d){return a.dragenter(this.id,d.originalEvent)});this.divjq.on("dragover",
this,function(d){return a.dragover(this.id,d.originalEvent)});this.divjq.on("dragexit",this,function(d){return a.dragexit(this.id,d.originalEvent)});this.divjq.on("drop",this,function(d){return a.dragdrop(this.id,d.originalEvent,a.NewFITSImage)});this.divjq.append('<div style="visibility:hidden; position:relative; top:-50;left:-50"> <input type="file" id="openLocalFile-'+this.id+'" multiple="true" onchange="javascript:for(var i=0; i<this.files.length; i++){JS9.Load(this.files[i], {display:\''+this.id+
"'}); }\"> </div>");this.divjq.append('<div style="visibility:hidden; position:relative; top:-50;left:-50"> <input type="file" id="refreshLocalFile-'+this.id+'" multiple="true" onchange="javascript:for(var i=0; i<this.files.length; i++){JS9.RefreshImage(this.files[i], {display:\''+this.id+"'}); }\"> </div>");this.divjq.append('<div style="visibility:hidden; position:relative; top:-50;left:-50"> <input type="file" id="openLocalRegions-'+this.id+'" multiple="true" onchange="javascript:for(var i=0; i<this.files.length; i++){JS9.LoadRegions(this.files[i], {display:\''+
this.id+"'}); }\"> </div>");this.divjq.append('<div style="visibility:hidden; position:relative; top:-50;left:-50"> <input type="file" id="openLocalColormap-'+this.id+'" multiple="true" onchange="javascript:for(var i=0; i<this.files.length; i++){JS9.AddColormap(this.files[i], {display:\''+this.id+"'}); }\"> </div>");a.displays.push(this);a.DEBUG&&a.log("JS9 display:  %s (%d,%d)",this.id,this.x,this.y)};a.Display.prototype.initMessages=function(){this.messageContainer=$("<div>").addClass("JS9Container").css("z-index",
a.MESSZINDEX).appendTo(this.divjq);this.infoArea=$("<div>").addClass("JS9Message").appendTo(this.messageContainer);this.regionsArea=$("<div>").addClass("JS9Message").appendTo(this.messageContainer);return this};a.Display.prototype.displayPlugin=function(d){var c,b,e,f,g,h,j,k;h=this.pluginInstances[d.name];switch(a.globalOpts.winType){case "light":c=a.lightOpts[a.LIGHTWIN];if(!h||!h.status){if(b=d.name.replace(/\s/g,"_"),e=this.id+"_"+b+"_lightDiv",f=this.id+"_"+b+"_outerDiv",b=this.id+"_"+b+"_innerDiv",
h||(g=$("<div>").attr("id",f).css("display","none").appendTo($(this.divjq)),$("<div>").addClass(d.name).attr("id",b).attr("data-js9id",this.divjq.attr("id")).css("height","100%").css("width","100%").appendTo(g)),g=d.opts.winDims[0]||a.WIDTH,j=d.opts.winDims[1]||a.HEIGHT,k=d.opts.winResize?"1":"0",c=sprintf(c.format,g,j,k),g=d.opts.toolbarHTML&&0<=d.opts.toolbarHTML.search(/\$title/)?"":d.opts.winTitle||"",f=a.lightWin(e,"div",f,g,c),e=$("#"+e+" #"+b),h=a.instantiatePlugin(e,d,f),h.winHandle.onclose=
function(){h.winHandle.hide();h.status="inactive";return!1},h.status="active",d.opts.plugindisplay)try{d.opts.plugindisplay.call(h,this.image)}catch(m){a.log("plugindisplayCB: %s [%s]\n%s",d.name,m.message,a.strace(m))}}else if("inactive"===h.status){if(h.winHandle&&(h.winHandle.show(),h.status="active",d.opts.plugindisplay))try{d.opts.plugindisplay.call(h,this.image)}catch(n){a.log("plugindisplayCB: %s [%s]\n%s",d.name,n.message,a.strace(n))}}else"active"===h.status&&h.winHandle&&(h.winHandle.hide(),
h.status="inactive");break;case "new":a.error("external window support for plugins not yet implemented")}};a.Display.prototype.resize=function(d,c,b){var e,f,g,h,j=function(a){a.left+=g;a.top+=h;a.setCoords()};a.globalOpts.resize||a.error("display resize not enabled");if(!d&&!c)return{width:this.width,height:this.height};d=Math.floor(d);c=c?Math.floor(c):d;(10>d||10>c)&&a.error("invalid dimension(s) passed to display resize");if(d===this.width&&c===this.height)return this;b=b||{};e=c;g=(d-this.width)/
2;h=(e-this.height)/2;this.width=d;this.height=e;this.divjq.css("width",d);this.divjq.css("height",e);this.canvasjq.attr("width",d);this.canvasjq.attr("height",e);a.bugs.webkit_resize&&!this.resizing&&(this.owidth=Math.min(this.owidth,d),this.oheight=Math.min(this.oheight,e));(void 0===b.resizeMenubar||b.resizeMenubar)&&$("#"+this.id+"Menubar").css("width",d);for(f in this.layers)this.layers.hasOwnProperty(f)&&(c=this.layers[f],"main"===c.dtype&&(c.divjq.css("width",d),c.divjq.css("height",e),c.canvasjq.attr("width",
d),c.canvasjq.attr("height",e),c.canvas.setWidth(d),c.canvas.setHeight(e),c.canvas.calcOffset()));for(d=0;d<a.images.length;d++)if(e=a.images[d],e.mkSection(),e.display&&this===e.display&&(e.resize?(e.resize.left+=g,e.resize.top+=h):e.resize={left:g,top:h},e===e.display.image))for(f in e.layers)e.layers.hasOwnProperty(f)&&(c=e.layers[f],c.json||(c.canvas.getObjects().forEach(j),c.canvas.renderAll()));a.bugs.webkit_resize&&this.divjq.css("width",this.width+a.RESIZEFUDGE).css("height",this.height+a.RESIZEFUDGE);
this.image&&(this.image.displayImage("all",b),this.image.refreshLayers());return this};a.Display.prototype.inResize=function(d){return a.globalOpts.resizeHandle&&d.x+a.RESIZEDIST>=this.divjq.width()&&d.y+a.RESIZEDIST>=this.divjq.height()?!0:!1};a.Command=function(d){for(var c in d)d.hasOwnProperty(c)&&(this[c]=d[c]);d.name||a.error("command has no name");!d.get&&!d.set&&a.error("command requires get and/or set routine");a.commands.push(this);1<a.DEBUG&&a.log("JS9 command:  %s",this.name)};a.Command.prototype.getDisplayInfo=
function(a){a&&a.id&&(this.display=a,this.image=a.image);return this};a.Command.prototype.getWhich=function(a){return this.get&&!this.set?"get":this.set&&!this.get?"set":this.which?this.which(a):0===a.length?"get":"set"};a.Console=function(d,c){this.display.conMode=2;this.hist=[];this.histtemp=this.histpos=0;this.histused=!1;this.consoleConjq=$("<div>").addClass("JS9ConsoleContainer").appendTo(this.divjq);"light"!==this.winType&&(this.width=this.divjq.attr("data-width"),this.width||(this.width=d||
a.CONWIDTH),this.divjq.css("width",this.width),this.width=parseInt(this.divjq.css("width"),10),this.height=this.divjq.attr("data-height"),this.height||(this.height=c||a.CONHEIGHT),this.divjq.css("height",this.height),this.height=parseInt(this.divjq.css("height"),10),this.consoleConjq.css("width",this.width).css("height",this.height));this.consoleConjq.attr("tabindex","0");this.consoleConjq.on("keydown",this,function(d){return a.consoleKeyDownCB(d)});this.out("Type 'help' for a list of commands","info");
this.inp()};a.Console.prototype.inp=function(){var d;this.consoleConjq.find(".JS9CmdIn:last").attr("readonly","readonly");this.consoleConjq.append(a.consoleHTML.replace(/@@PR@@/g,"js9>"));d=this.consoleConjq.find(".JS9CmdIn:last");d.focus().attr("autocapitalize","off").attr("autocorrect","off").attr("autocomplete","off");a.jupyterFocus(d.parent());return this};a.Console.prototype.out=function(a,c){switch(c.toLowerCase()){case "error":a="ERROR: "+a;c="Error";break;case "info":c="Info";break;case "out":c=
"Out";break;default:c="Out"}$("<div>").addClass("JS9Cmd"+c).html(a).appendTo(this.consoleConjq);return this};a.Console.prototype.xeq=function(){var d,c,b,e,f=this.consoleConjq.find(".JS9CmdIn:last").val(),g=f.replace(/ {2,}/g," ").split(" "),h=[];if(!g[0])return this;c=g[0];for(d=1;d<g.length;d++)h.push(g[d]);this.histused||(this.hist[this.hist.length]=f);this.histpos=this.hist.length;this.histused=!1;try{if(b=a.lookupCommand(c))switch(b.getDisplayInfo(this.display),b.getWhich(h)){case "get":e=b.get(h)||
"";this.out(e,"ok");break;case "set":(e=b.set(h))&&this.out(e,"ok");break;default:e=sprintf("unknown cmd type for '%s'",c),a.error(e)}else e=sprintf("unknown command '%s'",c),0<h.length&&(e=e+" "+h),a.error(e)}catch(j){this.out(j.message,"error")}return this};a.Info={};a.Info.CLASS="JS9";a.Info.NAME="Info";a.Info.opts={infoURL:"./params/info.html",infoHTML:'<table id="info" class="js9InfoTable"><tr><td>file:</td><td colspan="2"><input type="text" id="id" size="28" value="" readonly="readonly" /></td></tr> <tr><td>object:</td><td colspan="2"><input type="text" id="object" size="28" value="" readonly="readonly" /></td></tr> <tr><td>value:</td><td colspan="2"><input type="text" id="val3" size="28" value="" readonly="readonly" /></td></tr> <tr><td><input type="text" id="isys" size="10" value="" readonly="readonly" /></td><td><input type="text" id="ix" size="13" value="" readonly="readonly" /></td><td><input type="text" id="iy" size="13" value="" readonly="readonly" /></td></tr> <tr><td><input type="text" id="psys" size="10" value="" readonly="readonly" /></td><td><input type="text" id="px" size="13" value="" readonly="readonly" /></td><td><input type="text" id="py" size="13" value="" readonly="readonly" /></td></tr> <tr><td><input type="text" id="wcssys" size="10" value="" readonly="readonly" /></span></td><td><input type="text" id="ra" size="13" value="" readonly="readonly" /></td><td><input type="text" id="dec" size="13" value="" readonly="readonly" /></td></tr> <tr><td colspan="3"><textarea style="background: #E9E9E9; border: #CCCCCC solid 1px" id="regions" rows="4" cols="40" value="" readonly="readonly" /></td></tr></table>'};
a.Info.init=function(){this.infoConjq=$("<div>").addClass("JS9Container").append(a.Info.opts.infoHTML).appendTo(this.divjq);this.jq=this.infoConjq.find("#info")};a.Info.display=function(d,c,b){var e,f,g,h;this.display&&this.display.pluginInstances&&(f=this.display.pluginInstances.JS9Info);b=b?b:f&&"active"===f.status?f:this.display?this.display:this;if(b===f){switch(typeof c){case "string":g=f.jq.find("#"+d);0<g.length&&g.val(c);break;case "object":for(h in c)if(c.hasOwnProperty(h)){switch(h){case "wcssys":c[h]||
(c[h]="wcs")}g=f.jq.find("#"+h);0<g.length&&g.val(c[h])}}return this}b.infoheight=b.infoArea.height()+4;b.regheight=Math.max(2*b.infoheight+10,b.infoheight+b.regionsArea.height()+10);switch(d){case "regions":f=b.regionsArea;h=!this.display.image||this.display.image.iy>b.regheight?a.textColorOpts.inimage:a.textColorOpts.regions;e=";";break;case "info":f=b.infoArea;h=!this.display.image||this.display.image.iy>b.infoheight?a.textColorOpts.inimage:a.textColorOpts.info;e="";break;default:f=b.infoArea,
h=!this.display.image||this.display.image.iy>b.infoheight?a.textColorOpts.inimage:a.textColorOpts.info}switch(typeof c){case "string":g=c;break;case "object":g=c.vstr}""!==e&&(c=g.split(e),2<c.length&&(c=RegExp(e,"g"),g=g.replace(c,"<br>")));f.css("color",h).html(g);return this};a.Image.prototype.displayMessage=a.Info.display;a.Info.clear=function(a){a?this.displayMessage(a,""):(this.displayMessage("info",""),this.displayMessage("regions",""));return this};a.Image.prototype.clearMessage=a.Info.clear;
a.Info.clearMain=function(a){a&&(a.displayMessage("info","",a.display),a.displayMessage("regions","",a.display))};a.Menubar=function(d,c){var b,e,f,g=this;this.width=this.divjq.attr("data-width");this.width||(this.width=d||a.MENUWIDTH);this.divjq.css("width",this.width);this.width=parseInt(this.divjq.css("width"),10);this.height=this.divjq.attr("data-height");this.height||(this.height=c||a.MENUHEIGHT);this.divjq.css("height",this.height);this.height=parseInt(this.divjq.css("height"),10);if(""===a.menubarHTML){a.menubarHTML=
"<span id='JS9Menus_@@ID@@'>";for(b=0;b<a.menuButtonOptsArr.length;b++)e=a.menuButtonOptsArr[b].name,f=a.menuButtonOptsArr[b].label,a.allinone&&"help"===e||("#"===e[0]?(e=e.slice(1),a.menubarHTML+="<button type='button' id='"+e+"Menu@@ID@@' class='JS9Button' disabled='disabled'>"+f+" </button>"):a.menubarHTML+="<button type='button' id='"+e+"Menu@@ID@@' class='JS9Button'>"+f+"</button>");a.menubarHTML+="<button type='button' id='hiddenRegionMenu@@ID@@'class='JS9Button' style='display:none'>R</button>";
a.menubarHTML+="<button type='button' id='hiddenAnchorMenu@@ID@@'class='JS9Button' style='display:none'>R</button>";a.menubarHTML+="</span>"}this.display=a.lookupDisplay(this.id);this.display.menubar=this;b=a.menubarHTML.replace(/@@ID@@/g,this.id);this.menuConjq=$("<div>").addClass("JS9MenubarContainer").attr("width",this.width).attr("height",this.height).html(b).appendTo(this.divjq);$(function(){function d(){var c=g.display;a.bugs.hide_menu&&c.image&&c.image.displayImage("rgb")}function c(){var d,
b,e,f=[];if(0<=g.id.search(a.SUPERMENU))if(b=g.divjq.data("displays").split(","),"*"===b[0])for(d=0;d<a.displays.length;d++)f.push(a.displays[d]);else for(d=0;d<b.length;d++)(e=a.lookupDisplay(b[d]))&&f.push(e);f.length||f.push(g.display);return f}$("#fileMenu"+g.id).on("mousedown",function(a){a.preventDefault();$("#fileMenu"+g.id).contextMenu()});$.contextMenu({selector:"#fileMenu"+g.id,zIndex:a.MENUZINDEX,events:{hide:d},build:function(){var d,b,e,f,g=0,h={},q=c()[0],s=q.image;f=a.images.length;
for(d=0;d<f;d++)b=a.images[d],b.display===q&&(e=b.id,a.globalOpts.rgb.active&&(b===a.globalOpts.rgb.rim&&(e+=" (red)"),b===a.globalOpts.rgb.gim&&(e+=" (green)"),b===a.globalOpts.rgb.bim&&(e+=" (blue)")),h[e]={name:e},q.image&&q.image.id===b.id&&(h[e].icon="sun"),g++);g||(h.noimg={name:"[no images]",events:{keyup:function(){}}});h["sep"+g++]="------";h.open={name:"open local file ..."};h.archives={name:" accessing data archives ..."};h.archives.disabled=a.allinone?!0:!1;h.loadproxy={name:"open link via proxy ..."};
h.loadproxy.disabled=!a.allinone&&"none"!==a.globalOpts.helperType&&a.globalOpts.workDir&&a.globalOpts.loadProxy?!1:!0;h.loadcors={name:"open link via CORS ..."};h.loadcors.disabled=window.hasOwnProperty("Jupyter")?!0:!1;h.imsection={name:"extract image section ..."};h.imsection.disabled=!a.allinone&&"none"!==a.globalOpts.helperType&&a.globalOpts.workDir&&s&&s.parentFile?!1:!0;h["sep"+g++]="------";h.print={name:"print ..."};h.header={name:"display FITS header"};h.hdus={name:"display FITS HDUs"};
if(!s||!s.hdus)h.hdus.disabled=!0;h.pageid={name:"display pageid"};h.savefits={name:"save image as FITS"};h.savepng={name:"save image as PNG"};h.savejpeg={name:"save image as JPEG"};h.moveto={name:"move image to",items:{movetotitle:{name:"choose display:",disabled:!0}}};if(s){h.moveto.disabled=!1;for(d=0;d<a.displays.length;d++)0<$("#"+a.displays[d].id).length&&q!==a.displays[d]&&(b="moveto_"+a.displays[d].id,h.moveto.items[b]={name:a.displays[d].id});h.moveto.items.moveto_newdisp={name:"new display"}}else h.moveto.disabled=
!0;h.close={name:"close image"};h["sep"+g++]="------";h.lite={name:"new JS9 light window"};h.xnew={name:"new JS9 separate window"};2<a.DEBUG&&(h["sep"+g++]="------",h.refresh={name:"debug: refresh ..."});return{callback:function(d){c().forEach(function(c){var b,e,f,g,k=c.image;switch(d){case "close":k&&k.closeImage();break;case "header":k&&(k.raw.header?k.displayAnalysis("text",a.raw2FITS(k.raw,!0),"FITSHeader_"+k.id):a.error("no FITS header for "+k.id));break;case "hdus":k&&(k.hdus?k.displayAnalysis("text",
a.hdus2Str(k.hdus),"FITSHDUs_"+k.id,"width=800px,height=200px,center=1,resize=1,scrolling=1"):a.error("no FITS header for "+k.id));break;case "lite":a.LoadWindow(null,null,"light");break;case "xnew":a.LoadWindow(null,null,"new");break;case "pageid":c="<center><p>Usage: js9 -pageid [pageid] ...<p>"+a.helper.pageid||"none</center>";a.lightWin("fileid"+a.uniqueID(),"inline",c,"page ID",a.lightOpts[a.LIGHTWIN].lineWin);break;case "open":a.OpenFileMenu({display:c});break;case "loadcors":b=a.allinone?a.Image.prototype.displayAnalysis.call(null,
"textline",a.allinone.loadCorsHTML,"Open a shared CORS link"):a.Image.prototype.displayAnalysis.call(null,"textline",a.InstallDir(a.globalOpts.corsURL),"Open a shared CORS link");$(b).data("dispid",c.id);break;case "archives":a.DisplayHelp(a.InstallDir(a.globalOpts.archivesURL));break;case "loadproxy":b=a.Image.prototype.displayAnalysis.call(null,"textline",a.InstallDir(a.globalOpts.proxyURL),"Open a link via server proxy");$(b).data("dispid",c.id).data("aname","loadproxy");break;case "imsection":e=
a.Regions.opts.onchange;$("#dhtmlwindowholder").arrive("#imageSectionForm",{onceOnly:!0},function(){a.Regions.opts.onchange=function(a,d){var c,b;e&&e(a,d);a.parentFile&&("region"===$("#imageSectionForm input:radio[name=imode]:checked").val()&&"box"===d.shape)&&(c=a.raw.header.LTM1_1||1,c=d.width/c,b=a.raw.header.LTM2_2||1,b=d.height/b,$("#imageSectionForm #xcen").val(Math.floor(d.lcs.x)),$("#imageSectionForm #ycen").val(Math.floor(d.lcs.y)),$("#imageSectionForm #xdim").val(Math.floor(c)),$("#imageSectionForm #ydim").val(Math.floor(b)))}});
$("#dhtmlwindowholder").leave("#imageSectionForm",{onceOnly:!0},function(){a.Regions.opts.onchange=e});b=a.Image.prototype.displayAnalysis.call(null,"params",a.InstallDir(a.globalOpts.imsectionURL),"Extract Image Section From a 'Parent' File","width=440px,height=230px,center=1,resize=1,scrolling=1");$(b).data("dispid",c.id).data("aname","imsection");break;case "refresh":$("#refreshLocalFile-"+c.id).click();break;case "savefits":k&&(c=k.id.replace(/\.png/i,".fits").replace(/\.gz$/i,"").replace(/\[.*\]/,
""),k.saveFITS(c));break;case "savepng":k&&(c=k.id.replace(/\.fit[s]?/i,".png").replace(/\.gz$/i,"").replace(/\[.*\]/,""),k.savePNG(c));break;case "savejpeg":k&&(c=k.id.replace(/\.fit[s]?/i,".jpeg").replace(/\.png$/i,".jpeg").replace(/\.gz$/i,"").replace(/\[.*\]/,""),k.saveJPEG(c));break;case "print":k&&k.print();break;default:if(d.match(/^moveto_/)){c=d.replace(/^moveto_/,"");"newdisp"===c?(g="lightwin"+a.uniqueID(),$("#dhtmlwindowholder").arrive("#"+g,{onceOnly:!0},function(){k.moveToDisplay(g)}),
a.LoadWindow(null,{id:g},"light")):k.moveToDisplay(c);break}for(b=0;b<a.images.length;b++)if(k=a.images[b],f=d.replace(/ *\((red|green|blue)\)/,""),c.id===k.display.id&&k.id===f){k.displayImage("display");k.refreshLayers();k.clearMessage();break}}})},items:h}}});$("#viewMenu"+g.id).on("mousedown",function(a){a.preventDefault();$("#viewMenu"+g.id).contextMenu()});$.contextMenu({selector:"#viewMenu"+g.id,zIndex:a.MENUZINDEX,events:{hide:d},build:function(){var d,b,e,f,h,l="",q=0,s=0,t={},v=c()[0],u=
v.image,w=function(d,c){var b,e;if(c.resize)switch(e=c.resize.split(/[\s,\/]+/),e.length){case 0:break;case 1:a.isNumber(e[0])&&(b=parseInt(e[0],10),d.resize(b,b));break;default:a.isNumber(e[0])&&a.isNumber(e[1])&&(b=parseInt(e[0],10),e=parseInt(e[1],10),d.resize(b,e))}},y=function(a){var d=$.contextMenu.getInputValues(a.data),c=g.display;switch(a.which||a.keyCode){case 9:case 13:w(c,d);a.data.edited=!1;break;default:a.data.edited=!0}};for(d=0;d<a.plugins.length;d++)if(b=a.plugins[d],e=b.name,b.opts.menuItem&&
"view"===b.opts.menu&&(f=v.pluginInstances[e],!f||f.winHandle))b.xclass!==l&&(q+=1),l=b.xclass,t[e]={name:b.opts.menuItem},f&&"active"===f.status&&(t[e].icon="sun");t["sep"+q++]="------";if(u){for(h in u.layers)u.layers.hasOwnProperty(h)&&"main"===u.layers[h].dlayer.dtype&&(s++,t[h]={name:h},u.layers[h].show&&(t[h].icon="sun"));1<s&&(t.hide={name:"HideAll"},t.show={name:"ShowAll"},t["sep"+q++]="------")}t.valpos={name:"display value/position"};v.image&&v.image.params.valpos&&(t.valpos.icon="sun");
if(u&&1<u.raws.length){t["sep"+q++]="------";t.rawlayer={name:"raw data layers",items:{}};for(d=0;d<u.raws.length;d++)h="rawlayer_"+u.raws[d].id,t.rawlayer.items[h]={name:u.raws[d].id},u.raw===u.raws[d]&&(t.rawlayer.items[h].icon="sun")}a.globalOpts.resize&&(t["sep"+q++]="------",t.resize={events:{keyup:y},name:"change width/height:",type:"text"});return{callback:function(d){c().forEach(function(c){var b,e,f,g=c.image;switch(d){case "valpos":g&&(g.params.valpos=!g.params.valpos,g.params.valpos||g.clearMessage());
break;case "show":case "hide":if(g)for(e in g.layers)g.layers.hasOwnProperty(e)&&"main"===g.layers[e].dlayer.dtype&&(g.showShapeLayer(e,d),"show"===d&&g.refreshLayers());break;default:for(b=0;b<a.plugins.length;b++)if(f=a.plugins[b],f.name===d){c.displayPlugin(f);return}if(g)for(e in g.layers)if(g.layers.hasOwnProperty(e)&&d===e){c=g.layers[e].show?"hide":"show";g.showShapeLayer(e,c);"show"===c&&g.refreshLayers();return}u&&d.match(/^rawlayer_/)&&u.rawDataLayer(d.replace(/^rawlayer_/,""))}})},events:{show:function(d){var c=
g.display,b={};c&&(b.resize=sprintf("%d %d",c.width,c.height),$.contextMenu.setInputValues(d,b),a.jupyterFocus(".context-menu-item"))},hide:function(a){var d=g.display;d&&a.edited&&(delete a.edited,a=$.contextMenu.getInputValues(a),w(d,a))}},items:t}}});$("#zoomMenu"+g.id).on("mousedown",function(a){a.preventDefault();$("#zoomMenu"+g.id).contextMenu()});$.contextMenu({selector:"#zoomMenu"+g.id,zIndex:a.MENUZINDEX,events:{hide:d},build:function(){var d,b,e,f,h=0,l=c()[0].image,q={zoomtitle:{name:"Zoom Factors:",
disabled:!0}};for(d=a.imageOpts.zooms;1<=d;d--)b=Math.pow(2,-d),e=Math.pow(2,d),f=sprintf("zoom%s",b),e=sprintf("zoom 1/%s",e),q[f]={name:e},l&&l.rgb.sect.zoom===b&&(q[f].icon="sun");for(d=0;d<=a.imageOpts.zooms;d++)b=Math.pow(2,d),f=sprintf("zoom%s",b),e=sprintf("zoom %s",b),q[f]={name:e},l&&l.rgb.sect.zoom===b&&(q[f].icon="sun");q["sep"+h++]="------";q.zoomiotitle={name:"Zoom In/Out:",disabled:!0};q.zoomIn={name:"zoom in"};q.zoomOut={name:"zoom out"};q.zoomToFit={name:"zoom to fit"};q["sep"+h++]=
"------";q.zoom={events:{keyup:function(a){var d=$.contextMenu.getInputValues(a.data),b=g.display.image;switch(a.which||a.keyCode){case 9:case 13:b&&(isNaN(d.zoom)||b.setZoom(d.zoom),a.data.edited=!1);break;default:a.data.edited=!0}}},name:"numeric zoom value:",type:"text"};q["sep"+h++]="------";q.center={name:"pan to center"};q.reset={name:"reset zoom/pan"};return{callback:function(a){c().forEach(function(d){if(d=d.image)switch(a){case "zoomIn":d.setZoom("x2");break;case "zoomOut":d.setZoom("/2");
break;case "zoomToFit":d.setZoom("tofit");break;case "center":d.setPan();break;case "reset":d.setZoom("1");d.setPan();break;default:a.match(/^zoom/)&&d.setZoom(a.slice(4))}})},events:{show:function(d){var b=g.display.image,c={};b&&(c.zoom=String(b.rgb.sect.zoom));$.contextMenu.setInputValues(d,c);a.jupyterFocus(".context-menu-item")},hide:function(a){var d=g.display.image;d&&a.edited&&(delete a.edited,a=$.contextMenu.getInputValues(a),isNaN(a.zoom)||d.setZoom(a.zoom))}},items:q}}});$("#scaleMenu"+
g.id).on("mousedown",function(a){a.preventDefault();$("#scaleMenu"+g.id).contextMenu()});$.contextMenu({selector:"#scaleMenu"+g.id,zIndex:a.MENUZINDEX,events:{hide:d},build:function(){var d,b,e,f=0,h={},l=c()[0],q=function(d,b){a.isNumber(b.scalemin)&&(d.params.scalemin=parseFloat(b.scalemin));a.isNumber(b.scalemax)&&(d.params.scalemax=parseFloat(b.scalemax));d.displayImage("colors")},s=function(a){var d=$.contextMenu.getInputValues(a.data),b=g.display.image;switch(a.which||a.keyCode){case 9:case 13:q(b,
d);a.data.edited=!1;break;default:a.data.edited=!0}};h.scaletitle={name:"Scaling Algorithms:",disabled:!0};for(d=0;d<a.scales.length;d++)e=b=a.scales[d],h[b]={name:e},l.image&&l.image.params.scale===b&&(h[b].icon="sun");h["sep"+f++]="------";h.scalemin={events:{keyup:s},name:"low limit for clipping:",type:"text"};h.scalemax={events:{keyup:s},name:"high limit for clipping:",type:"text"};h["sep"+f++]="------";h.dminmax={name:"set limits to data min/max"};h.zscale={name:"set limits to zscale z1/z2"};
return{callback:function(a,d){c().forEach(function(b){if(b=b.image)switch(a){case "dminmax":return b.params.scaleclipping="dataminmax",b.params.scalemin=b.raw.dmin,b.params.scalemax=b.raw.dmax,$.contextMenu.setInputValues(d,{scalemin:String(b.params.scalemin),scalemax:String(b.params.scalemax)}),b.displayImage("colors"),!1;case "zscale":return(!b.params.z1||b.params.z2)&&b.zscale(!1),b.params.scaleclipping="zscale",b.params.scalemin=b.params.z1,b.params.scalemax=b.params.z2,$.contextMenu.setInputValues(d,
{scalemin:String(b.params.scalemin),scalemax:String(b.params.scalemax)}),b.displayImage("colors"),!1;default:b.setScale(a)}})},events:{show:function(d){var b=g.display.image,c={};b&&(c.scalemin=String(b.params.scalemin),c.scalemax=String(b.params.scalemax));$.contextMenu.setInputValues(d,c);a.jupyterFocus(".context-menu-item")},hide:function(a){var d=g.display.image;d&&a.edited&&(delete a.edited,a=$.contextMenu.getInputValues(a),q(d,a))}},items:h}}});$("#colorMenu"+g.id).on("mousedown",function(a){a.preventDefault();
$("#colorMenu"+g.id).contextMenu()});$.contextMenu({selector:"#colorMenu"+g.id,zIndex:a.MENUZINDEX,events:{hide:d},build:function(){var d,b,e,f=0,h={},l=c()[0],q=function(a,d){d.contrast&&!isNaN(d.contrast)&&(a.params.contrast=parseFloat(d.contrast));d.bias&&!isNaN(d.bias)&&(a.params.bias=parseFloat(d.bias));isNaN(d.opacity)||(a.params.opacity=""!==d.opacity?parseFloat(d.opacity):1);a.displayImage("colors")},s=function(a){var d=$.contextMenu.getInputValues(a.data),b=g.display.image;switch(a.which||
a.keyCode){case 9:case 13:q(b,d);a.data.edited=!1;break;default:a.data.edited=!0}};h.cmaptitle={name:"Colormaps:",disabled:!0};for(d=0;d<a.colormaps.length;d++)e=b=a.colormaps[d].name,h[b]={name:e},l.image&&l.image.cmapObj.name===b&&(h[b].icon="sun");h["sep"+f++]="------";h.contrast={events:{keyup:s},name:"contrast value:",type:"text"};h.bias={events:{keyup:s},name:"bias value:",type:"text"};h.opacity={events:{keyup:s},name:"opacity value:",type:"text"};h["sep"+f++]="------";h.reset={name:"reset contrast/bias"};
h["sep"+f++]="------";h.loadcmap={name:"load colormap"};h.savecmap={name:"save colormap"};h.invert={name:"invert colormap"};l.image&&l.image.params.invert&&(h.invert.icon="sun");h["sep"+f++]="------";h.rgb={name:"RGB mode"};a.globalOpts.rgb.active&&(h.rgb.icon="sun");return{callback:function(d){c().forEach(function(b){var c=b.image;if(c)switch(d){case "loadcmap":a.OpenColormapMenu({display:b});break;case "savecmap":a.SaveColormap({display:b});break;default:c.setColormap(d)}})},events:{show:function(d){var b=
g.display.image,c={};b&&(c.contrast=String(b.params.contrast),c.bias=String(b.params.bias),c.opacity=String(b.params.opacity),c.sigma=String(b.params.sigma));$.contextMenu.setInputValues(d,c);a.jupyterFocus(".context-menu-item")},hide:function(a){var d=g.display.image;d&&a.edited&&(delete a.edited,a=$.contextMenu.getInputValues(a),q(d,a))}},items:h}}});$("#regionMenu"+g.id).on("mousedown",function(a){a.preventDefault();$("#regionMenu"+g.id).contextMenu()});$.contextMenu({selector:"#regionMenu"+g.id,
zIndex:a.MENUZINDEX,events:{hide:d},build:function(){var d=c()[0].image,b={regiontitle:{name:"Regions:",disabled:!0},annulus:{name:"annulus"},box:{name:"box"},circle:{name:"circle"},ellipse:{name:"ellipse"},line:{name:"line"},point:{name:"point"},polygon:{name:"polygon"},text:{name:"text"},sep2:"------",loadRegions:{name:"load regions"},saveRegions:{name:"save regions"},listRegions:{name:"list regions"},deleteRegions:{name:"delete regions"},listonchange:{name:"list on change"},xeqonchange:{name:"xeq on change"}};
d&&d.params.listonchange&&(b.listonchange.icon="sun");d&&d.params.xeqonchange&&(b.xeqonchange.icon="sun");return{callback:function(d){c().forEach(function(b){var c=b.image;if(c)switch(d){case "deleteRegions":c.removeShapes("regions","all");c.clearMessage("regions");break;case "loadRegions":a.OpenRegionsMenu({display:b});break;case "saveRegions":c.saveRegions("js9.reg","all");break;case "listRegions":c.listRegions("all",2);break;case "xeqonchange":c.params.xeqonchange=!c.params.xeqonchange;break;case "listonchange":c.params.listonchange=
!c.params.listonchange;break;default:c.addShapes("regions",d,{ireg:!0})}})},items:b}}});$("#wcsMenu"+g.id).on("mousedown",function(a){a.preventDefault();$("#wcsMenu"+g.id).contextMenu()});$.contextMenu({selector:"#wcsMenu"+g.id,zIndex:a.MENUZINDEX,events:{hide:d},build:function(){var d,b,e,f=0,g=0,h={},q=c()[0],s=q.image;h.wcssystitle={name:"WCS Systems:",disabled:!0};for(d=0;d<a.wcssyss.length;d++)e=b=a.wcssyss[d],h[b]={name:e},q.image&&q.image.params.wcssys===b&&(h[b].icon="sun");h["sep"+f++]="------";
h.wcsutitle={name:"WCS Units:",disabled:!0};for(d=0;d<a.wcsunitss.length;d++)e=b=a.wcsunitss[d],h[b]={name:e},q.image&&q.image.params.wcsunits===b&&(h[b].icon="sun");h["sep"+f++]="------";h.reproject={name:"reproject",items:{reprojtitle:{name:"wcs from:",disabled:!0}}};for(d=0;d<a.images.length;d++)s!==a.images[d]&&a.images[d].wcs&&(b="reproject_"+a.images[d].id,h.reproject.items[b]={name:a.images[d].id},g++);0===g?(h.reproject.disabled=!0,h.reproject.items.notasks={name:"[none]",disabled:!0,events:{keyup:function(){}}}):
(h.reproject.disabled=!1,h.reproject.items["sep"+f++]="------",h.reproject.items.reproject_wcsalign={name:"display wcs-aligned"},q.image&&q.image.params.wcsalign&&(h.reproject.items.reproject_wcsalign.icon="sun"));return{callback:function(d){c().forEach(function(b){var c;c=RegExp(d);if(b=b.image)d.match(/^reproject_/)?"reproject_wcsalign"===d?(b.params.wcsalign=!b.params.wcsalign,b.displayImage("display")):(c=d.replace(/^reproject_/,""),b.reprojectData(c)):0<=a.wcssyss.join("@").search(c)?b.setWCSSys(d):
0<=a.wcsunitss.join("@").search(c)?b.setWCSUnits(d):a.error("unknown wcs sys/units: "+d)})},items:h}}});$("#analysisMenu"+g.id).on("mousedown",function(a){a.preventDefault();$("#analysisMenu"+g.id).contextMenu()});$.contextMenu({selector:"#analysisMenu"+g.id,zIndex:a.MENUZINDEX,events:{hide:d},build:function(){var d,b,e,f,h,l=0,q=0,s={};h=c()[0];var t=h.image,v="",u=function(a,d){d.sigma||(d.sigma="none");"none"===d.sigma?(a.params.sigma=d.sigma,a.rawDataLayer("gaussBlur","remove")):(a.params.sigma=
parseFloat(d.sigma),a.gaussBlurData(a.params.sigma))},w=function(a){var d=$.contextMenu.getInputValues(a.data),b=g.display.image;switch(a.which||a.keyCode){case 9:case 13:u(b,d);a.data.edited=!1;break;default:a.data.edited=!0}};for(d=0;d<a.plugins.length;d++)if(b=a.plugins[d],f=b.name,b.opts.menuItem&&"analysis"===b.opts.menu&&(e=h.pluginInstances[f],!e||e.winHandle))b.xclass!==v&&(s["sep"+q++]="------",s["sep"+q++]={name:b.xclass+" Plugins:"},s["sep"+(q-1)].disabled=!0),v=b.xclass,s[f]={name:b.opts.menuItem},
e&&"active"===e.status&&(s[f].icon="sun"),q++;if(!a.allinone){0<q&&(s["sep"+q++]="------");s.remotetitle={name:"Server-side Tasks:",disabled:!0};if(t&&t.analysisPackages){f=t.analysisPackages;for(b=0;b<f.length;b++){h=f[b];for(d=0;d<h.length;d++)if(!h[d].hidden&&("fits"!==h[d].files||t.fitsFile)&&!("png"===h[d].files&&"fits2png"!==t.source))e=h[d].title,h[d].purl&&(e+=" ..."),s[h[d].name]={name:e},l++}}l||(s.notasks={name:"[none]",disabled:!0,events:{keyup:function(){}}});s["sep"+q++]="------";s.sigma=
{events:{keyup:w},name:"gaussian blur sigma:",type:"text"};s.dpath={name:"set data path ..."}}return{callback:function(d){c().forEach(function(b){var c,e,f;e=b.image;for(c=0;c<a.plugins.length;c++)if(f=a.plugins[c],f.name===d){b.displayPlugin(f);return}if(e)switch(d){case "dpath":$("#dhtmlwindowholder").arrive("#dataPathForm",{onceOnly:!0},function(){$("#dataPath").val(a.globalOpts.dataPath)});e=e.displayAnalysis("textline",a.InstallDir(a.analOpts.dpathURL),"Data Path for Drag and Drop");$(e).data("dispid",
b.id);break;default:if(c=e.lookupAnalysis(d))c.purl?(e=e.displayAnalysis("params",a.InstallDir(c.purl),c.title+": "+e.fitsFile),$(e).data("dispid",b.id).data("aname",c.name)):e.runAnalysis(c.name)}})},events:{show:function(d){var b=g.display.image,c={};b&&(c.sigma=String(b.params.sigma));$.contextMenu.setInputValues(d,c);a.jupyterFocus(".context-menu-item")},hide:function(a){var d=g.display.image;d&&a.edited&&(delete a.edited,a=$.contextMenu.getInputValues(a),u(d,a))}},items:s}}});$("#helpMenu"+g.id).on("mousedown",
function(a){a.preventDefault();$("#helpMenu"+g.id).contextMenu()});$.contextMenu({selector:"#helpMenu"+g.id,zIndex:a.MENUZINDEX,events:{hide:d},build:function(){var d,b,c=1,e="",f={helptitle:{name:"JS9 Help:",disabled:!0}};for(d in a.helpOpts)a.helpOpts.hasOwnProperty(d)&&(b=a.helpOpts[d],""!==e&&b.type!==e&&(f["sep"+c++]="------",b.heading&&(f["sep"+c++]={name:b.heading+" Help:"},f["sep"+(c-1)].disabled=!0)),e=b.type,f[d]={name:b.title});f["sep"+c++]="------";f.about={name:"About JS9"};return{callback:function(d){switch(d){case "about":alert(sprintf("JS9: image display right in your browser\nversion: %s\nprincipals: Eric Mandel (lead), Alexey Vikhlinin (science,management)\ncontact: saord@cfa.harvard.edu\n%s",
a.VERSION,a.COPYRIGHT));break;default:a.DisplayHelp(d)}},items:f}}})})};a.Helper=function(){this.helper=this.connected=!1;this.type=a.globalOpts.helperType||"sock.io";this.pageid=null;this.connect()};a.Helper.prototype.connectinfo=function(){if(null===a.helper.connected)return"notConfigured";if(a.helper.connected){var d=sprintf("connected %s %s",a.helper.type,a.helper.url);a.helper.pageid&&(d+="<p>"+a.helper.pageid);return d}return sprintf("notConnected %s",a.helper.type)};a.Helper.prototype.connect=
function(d){var c=this;d&&(this.type=d);if(this.socket){try{this.socket.disconnect()}catch(b){a.log("warning: can't disconnect from socket")}this.socket=null}this.url=a.globalOpts.helperURL?0<=a.globalOpts.helperURL.search(/:\/\//)?a.globalOpts.helperURL:a.globalOpts.helperProtocol+a.globalOpts.helperURL:document.domain?a.globalOpts.helperProtocol+document.domain:a.globalOpts.helperProtocol+"localhost";switch(this.type){case "none":this.connected=null;a.Preload(!0);break;case "get":case "post":a.globalOpts.helperCGI||
a.error("cgi script name missing for helper");this.url+="/"+a.globalOpts.helperCGI;this.helper=this.connected=!0;a.DEBUG&&a.log("JS9 helper: connect: "+this.type);a.Preload(!0);break;case "sock.io":case "nodejs":a.globalOpts.helperPort||a.error("port missing for helper");this.url+=":"+a.globalOpts.helperPort;this.sockurl=this.url+"/socket.io/socket.io.js";$.ajax({url:this.sockurl,dataType:"script",timeout:a.globalOpts.htimeout,success:function(){var d,b;c.socket=io.connect(c.url,{reconnection:!0,
reconnectionDelay:1E4,reconnectionDelayMax:1E4,reconnectionAttempts:6,timeout:a.globalOpts.htimeout});c.socket.on("connect",function(){c.connected=!0;c.helper=!0;b=[];for(d=0;d<a.displays.length;d++)b.push(a.displays[d].id);c.socket.emit("displays",{displays:b},function(a){c.pageid=a});a.Preload(!0);a.DEBUG&&a.log("JS9 helper: connect: "+c.type)});c.socket.on("connect_error",function(){c.connected=!1;c.helper=!1;a.Preload(!0);1<a.DEBUG&&a.log("JS9 helper: connect error")});c.socket.on("connect_timeout",
function(){c.connected=!1;c.helper=!1;a.Preload(!0);1<a.DEBUG&&a.log("JS9 helper: connect timeout")});c.socket.on("disconnect",function(){c.connected=!1;c.helper=!1;1<a.DEBUG&&a.log("JS9 helper: disconnect")});c.socket.on("reconnect",function(){c.connected=!0;c.helper=!0;1<a.DEBUG&&a.log("JS9 helper: reconnect")});c.socket.on("msg",a.msgHandler)},error:function(d,b,g){c.connected=!1;c.helper=!1;a.Preload(!0);a.DEBUG&&a.log("JS9 helper: connect failure: "+b+" "+g)}});break;default:a.error("unknown helper type: "+
this.type)}};a.Helper.prototype.send=function(d,c,b){if(!this.connected)return null;c&&"object"===typeof c?(c.cookie=document.cookie,a.globalOpts.dataPath&&!c.dataPath&&(c.dataPath=a.globalOpts.dataPath+":.")):c={dataPath:"."};a.TOROOT&&(c.dataPath+=":"+a.TOROOT);switch(this.type){case "get":case "post":c.key=d;a.DEBUG&&a.log("JS9 cgi helper [%s, %s]: %s",this.type,JSON.stringify(c),this.url);$.ajax({url:this.url,type:this.type.toUpperCase(),data:c,dataType:"text",success:function(d){"string"===typeof d&&
0<=d.search(a.analOpts.epattern)&&a.log(d);b&&b(d)},error:function(d,b,c){a.DEBUG&&a.log("JS9 helper: "+this.type+" failure: "+b+" "+c)}});break;case "sock.io":case "nodejs":a.helper.socket.emit(d,c,b)}return this};a.Fabric={};a.Fabric.elements="cornerSize cornerColor borderColor transparentCorners selectionLineWidth centeredScaling hasControls hasRotatingPoint hasBorders params pub".split(" ");a.Fabric.opts={originX:"center",originY:"center",strokeWidth:2,selectionLineWidth:2,borderColor:"#00FF00",
cornerColor:"#00FF00",cornerSize:fabric.isTouchSupported?12:8,hasControls:!0,hasRotatingPoint:!0,hasBorders:!0,transparentCorners:!1,centeredScaling:!0,selectable:!0,padding:0,canvas:{selection:!0,zindex:a.SHAPEZINDEX},fill:"transparent"};a.Fabric.rescaleStrokeWidth=function(d,c){var b=(this.scaleX+this.scaleY)/2;d=d||1;d*=b;!c&&this.params&&(c=this.params.sw1);c&&("group"===this.type?this.forEachObject(function(b){a.Fabric.rescaleStrokeWidth.call(b,d,c)}):this.setStrokeWidth(c/d))};a.Fabric.rescaleEvenly=
function(){var a;if(this.params&&this.scaleX!==this.scaleY)switch(this.params.shape){case "annulus":case "circle":a=this.params.lastscale||1,this.scaleX!==a?this.scaleY=this.scaleX:this.scaleY!==a&&(this.scaleX=this.scaleY),this.params.lastscale=this.scaleX}};fabric.Object.prototype.rescaleBorder=a.Fabric.rescaleStrokeWidth;fabric.Object.prototype.rescaleEvenly=a.Fabric.rescaleEvenly;a.Fabric.newShapeLayer=function(d,c,b){var e,f;if(this&&d){if(this.layers[d])return this.layers[d];this.layers[d]=
{};f=this.layers[d];f.params=[];f.params.sel=null;f.params.sellayer=null;b?f.dtype="other":(f.dtype="main",b=this.divjq);e=b.attr("id")+"-"+d.replace(/\s+/,"_")+"-shapeLayer";f.display=this;f.opts=$.extend(!0,{},c);f.opts.canvas=f.opts.canvas||{};void 0===f.opts.canvas.selection&&(f.opts.canvas.selection=!0);f.opts.canvas.zindex=f.opts.canvas.zindex||a.SHAPEZINDEX;f.el=a.Fabric.elements;f.divjq=$("<div>").addClass("JS9Container").css("z-index",0).appendTo(b);f.canvasjq=$("<canvas>").addClass("JS9Layer").attr("id",
e).attr("width",b.css("width")).attr("height",b.css("height")).appendTo(f.divjq);a.bugs.webkit_resize&&"main"===f.dtype&&f.canvasjq.attr("width",this.width).attr("height",this.height);f.canvas=new fabric.Canvas(f.canvasjq[0]);f.canvas.renderOnAddRemove=!1;f.opts.movable&&(f.opts.hasControls=!0,f.opts.hasRotatingPoint=!0,f.opts.hasBorders=!0,f.opts.lockMovementX=!1,f.opts.lockMovementY=!1,f.opts.lockRotation=!1,f.opts.lockScalingX=!1,f.opts.lockScalingY=!1,f.opts.lockUniScaling=!1,f.opts.selectable=
!0,f.opts.evented=!0,f.opts.usekeyboard=!0);f.opts.selectable&&(f.opts.canvas.selection=!0);if(f.opts.onmousedown||f.opts.onmouseup||f.opts.onmousemove||f.opts.tooltip||f.opts.onmouseover||f.opts.onmouseout){f.opts.evented=!0;if(f.opts.onmousedown)f.canvas.on("mouse:down",function(d){if(f.display.image&&d.target)"main"===f.dtype&&(f.display.image.rclick=1),f.opts.onmousedown.call(this,f.display.image,d.target.pub,d.e,d.target);else if(this._selection=this.selection)this.selection=a.specialKey(d.e)});
else f.canvas.on("mouse:down",function(d){if(this._selection=this.selection)this.selection=a.specialKey(d.e)});if(f.opts.onmouseup)f.canvas.on("mouse:up",function(a){f.display.image&&a.target&&f.opts.onmouseup.call(this,f.display.image,a.target.pub,a.e,a.target);this.selection=this._selection||this.selection});else f.canvas.on("mouse:up",function(){this.selection=this._selection||this.selection});if(f.opts.onmousemove)f.canvas.on("mouse:move",function(a){f.display.image&&a.target&&f.opts.onmousemove.call(this,
f.display.image,a.target.pub,a.e,a.target)});if(f.opts.onmouseover)f.canvas.on("mouse:over",function(a){f.display.image&&a.target&&f.opts.onmouseover.call(this,f.display.image,a.target.pub,a.e,a.target)});if(f.opts.onmouseout)f.canvas.on("mouse:out",function(a){f.display.image&&a.target&&f.opts.onmouseout.call(this,f.display.image,a.target.pub,a.e,a.target)});f.opts.tooltip&&(f.canvas.on("mouse:over",function(d){f.display.image&&d.target&&a.tooltip(d.target.left,d.target.top,f.opts.tooltip,f.display.image,
d.target.pub,d.e,d.target)}),f.canvas.on("mouse:out",function(d){f.display.image&&d.target&&a.tooltip(d.target.left,d.target.top,null,f.display.image,d.target.pub,d.e,d.target)}))}else f.canvas.on("mouse:down",function(d){if(this._selection=this.selection)this.selection=a.specialKey(d.e)}),f.canvas.on("mouse:up",function(){this.selection=this._selection||this.selection});if(f.opts.ongroupcreate&&(f.opts.canvas.selection=!0,f.opts.selectable=!0,f.opts.ongroupcreate))f.canvas.on("selection:created",
function(a){var d=[],b=[];f.display.image&&"group"===a.target.type&&(a.target.forEachObject(function(a){a.pub&&(b.push(a),d.push(a.pub))}),f.opts.ongroupcreate.call(this,f.display.image,d,a.e,b))});f.canvas.on("object:scaling",function(a){a.target.rescaleEvenly();a.target.rescaleBorder()});f.canvas.on("object:selected",function(b){f.params.sel&&(b.target.params&&f.params.sel!==b.target)&&f.canvas.fire("before:selection:cleared",{target:f.params.sel});switch(b.target.type){case "polyline":case "polygon":a.Fabric.addPolygonAnchors(f,
b.target),f.canvas.renderAll()}b.target.polyparams?f.params.sel=b.target.polyparams.polygon:b.target.params&&(f.params.sel=b.target);f.display.image&&(f.display.image.layer=d)});f.canvas.on("before:selection:cleared",function(d){f.params.sel=null;f.display.image&&(f.display.image.layer=null);switch(d.target.type){case "polyline":case "polygon":a.Fabric.removePolygonAnchors(f,d.target),f.canvas.renderAll()}});if(f.divjq.closest(a.lightOpts[a.LIGHTWIN].drag).length)if(fabric.isTouchSupported)f.divjq.on("touchstart",
function(){f.canvas.calcOffset()});else f.divjq.on("mouseenter",function(){f.canvas.calcOffset()});return f}};a.Fabric.showShapeLayer=function(d,c){var b=this,e=0,f,g,h,j;if(g=this.getShapeLayer(d)){j=g.canvas;h=this.display.layers[d];if("show"===c||!0===c){"show"===c&&(g.show=!0);g.json&&g.show&&j.loadFromJSON(g.json,function(){var c,e,f,p;b.resize&&(j.getObjects().forEach(function(a){a.left+=b.resize.left;a.top+=b.resize.top;a.setCoords()}),j.calcOffset());j.renderAll();j.selection=g.opts.canvas.selection;
e=h.opts.canvas.zindex;h.divjq.css("z-index",e);for(c in b.layers)if(b.layers.hasOwnProperty(c)&&(d!==c&&b.layers[c].show)&&(f=b.display.layers[c],f.divjq.css("z-index")<e&&(p=f.canvas.getActiveObject())))a.Fabric.removePolygonAnchors(f,p),f.canvas.discardActiveObject()});for(f in this.layers)this.layers.hasOwnProperty(f)&&this.layers[f].json&&e++;e||(this.resize=null)}else if("hide"===c||!1===c)g.show&&(j.forEachObject(function(d){a.Fabric.removePolygonAnchors(h,d);d.params&&d.params.winid&&(d.params.winid.close(),
d.params.winid=null)}),e=j.toJSON(g.dlayer.el),g.json=JSON.stringify(e),j.selection=!1,h&&h.divjq.css("z-index",0),j.clear()),"hide"===c&&(g.show=!1);return this}};a.Fabric.displayShapeLayers=function(){var a;if(this!==this.display.image){if(this.display.image&&this.display.image.layers)for(a in this.display.image.layers)this.display.image.layers.hasOwnProperty(a)&&this.display.image.showShapeLayer(a,!1);if(this.layers)for(a in this.layers)this.layers.hasOwnProperty(a)&&this.showShapeLayer(a,!0)}};
a.Fabric.getShapeLayer=function(a){var c,b;if(!a)return null;b=this.layers[a];if(!b){c=this.display.layers[a];if(!c)return null;this.layers[a]={};b=this.layers[a];b.show=!0;b.nshape=0;b.dlayer=c;b.opts=b.dlayer.opts;b.canvas=b.dlayer.canvas;b.canvas.calcOffset()}return b};a.Fabric._parseShapeOptions=function(d,c,b){var e,f,g,h,j,k,m,n={},p={};h="main"===this.display.layers[d].dtype?this.rgb.sect.zoom:1;j=h/("main"===this.display.layers[d].dtype?this.binning.bin||1:1);if(c.remove)return{remove:c.remove};
p.tags=[];if(c.tags)if("string"===typeof c.tags){f=c.tags.toLowerCase().split(",");for(d=0;d<f.length;d++)p.tags[d]=f[d].trim()}else if($.isArray(c.tags))for(d=0;d<c.tags.length;d++)p.tags[d]=c.tags[d].trim();void 0!==c.angle&&(n.angle=-c.angle);void 0!==c.x&&void 0!==c.y&&(e=this.imageToDisplayPos(c),n.left=e.x,n.top=e.y);void 0!==c.left&&(n.left=c.left);void 0!==c.top&&(n.top=c.top);void 0===n.left&&(n.left=b&&void 0!==b.left?b.left:this.display.canvasjq.attr("width")/2-1);void 0===n.top&&(n.top=
b&&void 0!==b.top?b.top:this.display.canvasjq.attr("height")/2-1+1);c.dx&&(n.left+=c.dx);c.dy&&(n.top-=c.dy);switch(c.shape){case "annulus":p.radii=[];if(void 0!==c.radii)if("string"===typeof c.radii){p.radii=c.radii.replace(/ /g,"").split(",");for(e=d=0;d<p.radii.length;d++)""!==p.radii[d]&&(p.radii[e++]=parseInt(p.radii[d],10))}else p.radii=c.radii;else{c.ireg&&a.SCALEIREG&&(c.iradius&&(c.iradius/=j),c.oradius&&(c.oradius/=j));h=(c.oradius-c.iradius)/c.nannuli;j=c.nannuli+1;for(d=0;d<j;d++)f=c.iradius+
h*d,p.radii.push(f)}break;case "box":c.ireg&&a.SCALEIREG&&(c.width&&(c.width/=j),c.height&&(c.height/=j));break;case "circle":c.ireg&&a.SCALEIREG&&c.radius&&(c.radius/=j);break;case "ellipse":c.ireg&&a.SCALEIREG&&(c.r1&&(c.r1/=j),c.r2&&(c.r2/=j));break;case "point":switch(c.ptshape){case "box":c.width=2*c.ptsize;c.height=2*c.ptsize;break;case "circle":c.radius=c.ptsize;break;case "ellipse":c.rx=c.ptsize,c.ry=c.ptsize/2}c.lockRotation=!0;c.lockScalingX=!0;c.lockScalingY=!0;c.lockUniScaling=!0;c.hasControls=
!1;c.hasRotatingPoint=!1;c.hasBorders=!0;break;case "line":case "polygon":if(c.pts&&c.pts.length){if("string"===typeof c.pts){g=c.pts.replace(/ /g,"").split(",");f=g.length;if("string"===typeof g[0])for(d=0;d<f;d++)g[d]=parseFloat(g[d]);c.pts=[];for(e=d=0;d<f;d+=2,e++)c.pts[e]={x:g[d],y:g[d+1]}}f=c.pts.length;for(d=0;d<f;d++)c.pts[d]=this.imageToDisplayPos(c.pts[d]);c.left&&c.top?g={x:c.left,y:c.top}:(g=a.centroidPolygon(c.pts),n.left=g.x,n.top=g.y);c.points=[];for(d=0;d<f;d++)e={x:(c.pts[d].x-g.x)/
h,y:(c.pts[d].y-g.y)/h},c.points.push(e)}else"polygon"===c.shape&&c.polypoints?c.points=c.polypoints:"line"===c.shape&&c.linepoints&&(c.points=c.linepoints);if(c.ireg&&a.SCALEIREG){f=c.points.length;for(d=0;d<f;d++)c.points[d].x/=j,c.points[d].y/=j}}for(k in c)if(c.hasOwnProperty(k))switch(k){case "tags":case "x":case "y":case "dx":case "dy":case "pts":case "left":case "top":case "angle":case "radii":case "ireg":break;case "type":case "originX":case "originY":case "width":case "height":case "scaleX":case "scaleY":case "flipX":case "flipY":case "opacity":case "cornerSize":case "transparentCorners":case "hoverCursor":case "padding":case "borderColor":case "cornerColor":case "centeredScaling":case "centeredRotation":case "fill":case "fillRule":case "backgroundColor":case "stroke":case "strokeWidth":case "strokeDashArray":case "strokeLineCap":case "strokeLineJoin":case "strokeMiterLimit":case "shadow":case "borderOpacityWhenMoving":case "borderScaleFactor":case "transformMatrix":case "minScaleLimit":case "selectable":case "evented":case "visible":case "hasControls":case "hasBorders":case "hasRotatingPoint":case "rotatingPointOffset":case "perPixelTargetFind":case "includeDefaultValues":case "clipTo":case "lockMovementX":case "lockMovementY":case "lockRotation":case "lockScalingX":case "lockScalingY":case "lockUniScaling":case "radius":case "rx":case "ry":case "points":case "selectionLineWidth":case "fontFamily":case "fontSize":case "fontStyle":case "fontWeight":case "text":case "textDecoration":case "textAlign":case "lineHeight":case "textBackgroundColor":n[k]=
c[k];break;case "shape":m=c[k];break;default:p[k]=c[k]}if(!(c=p.color)){c=p.tags;k=p.tagcolors;var r,l;k=k||{};for(r in k)if(k.hasOwnProperty(r)&&(d=r.split("_"),0===$(c).not(d).length&&0===$(d).not(c).length)){l=k[r];break}if(!l)for(r in k)if(k.hasOwnProperty(r)&&(d=r.split("_"),0===$(c).not(d).length)){l=k[r];break}if(!l)for(r in k)if(k.hasOwnProperty(r)&&(d=r.split("_"),0===$(d).not(c).length)){l=k[r];break}c=l=l||b&&b.get("stroke")||k.defcolor||a.globalOpts.defcolor||"#000000"}n.stroke=c;n.selectColor=
n.stroke;n.cornerColor=n.stroke;n.borderColor=n.stroke;void 0!==p.fixinplace&&(b=p.fixinplace,void 0===n.lockMovementX&&(n.lockMovementX=b),void 0===n.lockMovementY&&(n.lockMovementY=b),void 0===n.lockRotation&&(n.lockRotation=b),void 0===n.lockScalingX&&(n.lockScalingX=b),void 0===n.lockScalingY&&(n.lockScalingY=b),void 0===n.hasControls&&(n.hasControls=!b),void 0===n.hasRotatingPoint&&(n.hasRotatingPoint=!b),void 0===n.hasBorders&&(n.hasBorders=!b));return{shape:m,opts:n,params:p}};a.Fabric.addShapes=
function(d,c,b){var e,f,g,h,j,k,m,n,p,r=[],l={};if((j=this.getShapeLayer(d))&&j.show){k=j.canvas;"main"===this.display.layers[d].dtype?(m=this.rgb.sect.zoom,n=this.binning.bin||1):n=m=1;if("string"===typeof c)e=this.parseRegions(c),c="string"===typeof e?[{shape:e}]:e;else if(!$.isArray(c))if("object"===typeof c)c=[c];else return;if("string"===typeof b)try{g=JSON.parse(b)}catch(q){return a.error("can't parse shape opts: "+b,q),null}else g=b;k.size()||(b=this.display.layers[d],"regions"===d&&b.opts.canvas.zindex++,
b.divjq.css("z-index",b.opts.canvas.zindex));h=$.extend(!0,{},a.Fabric.opts,j.opts,g);for(g=0;g<c.length;g++){b=$.extend(!0,{},h,c[g]);f=a.Fabric._parseShapeOptions.call(this,d,b);if(f.remove){if(!0===f.remove||"true"===f.remove)f.remove="all";if(!1!==f.remove&&"false"!==f.remove){this.removeShapes(d,f.remove);continue}}if(f.shape){b=f.opts;l=f.params;l.id=++j.nshape;switch(f.shape){case "annulus":l.shape="annulus";f=b.top;p=b.left;b.top=0;b.left=0;if(l.radii)for(e=0;e<l.radii.length;e++)b.radius=
l.radii[e],r.push(new fabric.Circle(b));b.top=f;b.left=p;b.width=2*b.radius;b.height=2*b.radius;e=new fabric.Group(r,b);break;case "box":l.shape="box";e=new fabric.Rect(b);break;case "circle":l.shape="circle";e=new fabric.Circle(b);break;case "ellipse":l.shape="ellipse";b.rx=l.r1;b.ry=l.r2;e=new fabric.Ellipse(b);break;case "point":l.shape="point";switch(l.ptshape){case "box":e=new fabric.Rect(b);break;case "circle":e=new fabric.Circle(b);break;case "ellipse":e=new fabric.Ellipse(b);break;default:e=
new fabric.Rect(b)}break;case "line":l.shape="line";e=new fabric.Polyline(b.points,b);break;case "polygon":l.shape="polygon";e=new fabric.Polygon(b.points,b,!0);break;case "text":l.shape="text";l.text=b.text||"Double-click to add text here";b.fill=b.stroke;b.strokeWidth=0;e=new fabric.Text(l.text,b);break;default:a.error("unknown shape: "+f.shape)}k.add(e);l.layerName=d;l.sw1=e.strokeWidth;l.listonchange=!1;e.params=l;if(j.opts.panzoom)switch(l.shape){case "point":case "text":break;default:e.scale(m/
n)}e.rescaleBorder();a.Fabric._updateShape.call(this,d,e,null,"add",l)}}(void 0===l.redraw||l.redraw)&&k.renderAll();return l.id}};a.Fabric.selectShapes=function(a,c,b){var e,f,g,h,j=this;if(!this.layers||!a||!this.layers[a])return null;c=c||"all";a=this.layers[a].canvas;f=a.getActiveGroup();g={group:null};switch(typeof c){case "object":c.params&&(g.group=f&&f.contains(c)?f:null,b.call(j,c,g));break;case "number":a.forEachObject(function(a){a.params&&c===a.params.id&&(g.group=f&&f.contains(a)?f:null,
b.call(j,a,g))});break;case "string":h=c.toLowerCase().replace("box","rect"),"selected"===c?a.getActiveObject()?(a=a.getActiveObject(),a.params&&(g.group=null,b.call(j,a,g))):f&&(g.group=f,f.forEachObject(function(a){a.params&&b.call(j,a,g)})):a.forEachObject(function(a){if(a.params)if(g.group=f&&f.contains(a)?f:null,"all"===c)b.call(j,a,g);else if(c===a.stroke)b.call(j,a,g);else if(h===a.type)b.call(j,a,g);else if(a.params.tags)for(e=0;e<a.params.tags.length;e++)c===a.params.tags[e]&&b.call(j,a,
g)})}return this};a.Fabric.updateShapes=function(d,c,b,e){var f=this;this.selectShapes(d,c,function(c,h){a.Fabric._updateShape.call(f,d,c,h,b,e)});return this};a.Fabric._updateShape=function(d,c,b,e,f){var g,h,j,k,m,n,p,r,l={},q=this.layers[d],s=function(a){return a.toFixed(1)};b=b||{};f=f||{};n=this.display;j="main"===this.display.layers[d].dtype?this.rgb.sect.zoom:1;l.mode=e||"update";l.id=c.params.id;l.shape=c.params.shape;l.layer=d;l.color=c.stroke;l.tags=c.params.tags;e=c.getCenterPoint();b.group&&
(p=b.group.getCenterPoint(),e={x:e.x+p.x,y:e.y+p.y});p=this.displayToImagePos(e);l.x=p.x;l.y=p.y;l.imsys="image";l.lcs=this.imageToLogicalPos(p);"image"===this.params.wcssys?(k=l.x,m=l.y):(k=l.lcs.x,m=l.lcs.y,l.imsys=l.lcs.sys);l.angle=-c.angle;b.group&&(l.angle-=b.group.angle);for(;0>l.angle;)l.angle+=360;for(;360<l.angle;)l.angle-=360;e=1*(c.scaleX/j);j=1*(c.scaleY/j);b.group&&(e*=b.group.scaleX,j*=b.group.scaleY);switch(l.shape){case "annulus":l.shape="annulus";l.radii=[];l.imstr="annulus("+s(k)+
", "+s(m)+", ";h="annulus "+l.x+" "+l.y+" ";r=c.getObjects();j=r.length;for(b=0;b<j;b++)k=r[b].radius*e,l.imstr+=s(k),h+=l.x+" "+l.y+" "+(l.x+k)+" "+l.y+" ",l.imstr=b===j-1?l.imstr+")":l.imstr+", ",l.radii.push(k);break;case "box":l.shape="box";l.width=c.width*e;l.height=c.height*j;l.imstr="box("+s(k)+", "+s(m)+", "+s(l.width)+", "+s(l.height)+", "+l.angle.toFixed(4)+")";h="box "+l.x+" "+l.y+" "+l.x+" "+l.y+" "+(l.x+l.width)+" "+l.y+" "+l.x+" "+l.y+" "+l.x+" "+(l.y+l.height)+" "+l.angle*Math.PI/180;
break;case "circle":l.radius=c.radius*e;l.imstr="circle("+s(k)+", "+s(m)+", "+s(l.radius)+")";h="circle "+l.x+" "+l.y+" "+l.x+" "+l.y+" "+(l.x+l.radius)+" "+l.y;break;case "ellipse":l.r1=c.width*e/2;l.r2=c.height*j/2;l.imstr="ellipse("+s(k)+", "+s(m)+", "+s(l.r1)+", "+s(l.r2)+", "+l.angle.toFixed(4)+")";h="ellipse "+l.x+" "+l.y+" "+l.x+" "+l.y+" "+(l.x+l.r1)+" "+l.y+" "+l.x+" "+l.y+" "+l.x+" "+(l.y+l.r2)+" "+l.angle*Math.PI/180;break;case "point":l.width=c.width*e;l.height=c.height*j;l.imstr="point("+
s(k)+", "+s(m)+")";h="point "+l.x+" "+l.y;break;case "line":case "polygon":l.imstr=l.shape+"(";h=l.shape+" ";l.pts=[];for(b=0;b<c.points.length;b++)0<b&&(l.imstr+=", ",h+=" "),k={x:l.x+c.points[b].x*e,y:l.y-c.points[b].y*j},k=a.rotatePoint(k,l.angle,{x:l.x,y:l.y}),"image"===this.params.wcssys?l.imstr+=s(k.x)+", "+s(k.y):(m=this.imageToLogicalPos(k),l.imstr+=s(m.x)+", "+s(m.y)),h+=k.x+" "+k.y,l.pts.push(k),"line"===l.shape&&(0===b?r=0:(m=l.pts[b-1],r+=Math.sqrt((k.x-m.x)*(k.x-m.x)+(k.y-m.y)*(k.y-m.y))));
l.imstr="line"===l.shape?l.imstr+(') {"size":'+s(r)+',"units":"pixels"}'):l.imstr+")";break;case "text":l.imstr="text("+s(k)+", "+s(m)+', "'+c.text+'")',l.text=c.text,h="text "+l.x+" "+l.y+' "'+c.text+'"'}if(this.wcs&&0<this.wcs){if("regions"===d&&!1!==f.dowcsstr||"regions"!==d&&!0===f.dowcsstr)l.wcsstr=a.reg2wcs(this.wcs,h).replace(/;$/,"");h=a.pix2wcs(this.wcs,p.x,p.y).trim().split(/\s+/);l.ra=h[0];l.dec=h[1];l.wcssys=h[2]}l.data=c.params.data;c.set("pub",l);c.params.winid&&($(c.params.winid).is(":visible")?
a.Regions.initConfigForm.call(this,c):c.params.winid=null);if(f.nocb)return l;if("regions"===d&&this.params.xeqonchange&&q.show&&this.onregionschange)try{this.params.xeqonchange=!1,a.xeqByName(this.onregionschange,window,this,l)}catch(t){a.log("error in xeqonchange: %s [%s]\n%s",this.id,t.message,a.strace(t))}finally{this.params.xeqonchange=!0}if(this.params.xeqonchange&&q.show&&q.opts.onchange)try{this.params.xeqonchange=!1,a.xeqByName(q.opts.onchange,window,this,l)}catch(v){a.log("error in onchange: %s [%s]\n%s",
this.id,v.message,a.strace(v))}finally{this.params.xeqonchange=!0}f="on"+d+"change";for(g in n.pluginInstances)if(n.pluginInstances.hasOwnProperty(g)&&(d=n.pluginInstances[g],c=d.plugin.opts,d.isActive(f)))try{c[f].call(d,this,l)}catch(u){d.errLog(f,u)}return l};a.Fabric.removeShapes=function(d,c){var b=this,e,f;if(e=this.getShapeLayer(d))return f=e.canvas,this.selectShapes(d,c,function(c,e){a.Fabric._updateShape.call(b,d,c,e,"remove");e&&e.group&&e.group.remove(c);c.params&&c.params.winid&&c.params.winid.close();
f.remove(c)}),f.getActiveGroup()&&f.discardActiveGroup(),f.renderAll(),this};a.Fabric.getShapes=function(a,c){var b=[];this.selectShapes(a,c,function(a){b.push(a.pub||{})});return b};a.Fabric.changeShapes=function(d,c,b){var e,f,g,h,j,k,m,n,p,r,l,q,s=this;if((j=this.getShapeLayer(d))&&b)return k=j.canvas,"main"===this.display.layers[d].dtype?(l=this.rgb.sect.zoom,q=this.binning.bin||1):q=l=1,m=k.getActiveObject(),this.selectShapes(d,c,function(c,v){h=$.extend(!0,{},c.params,b);g=a.Fabric._parseShapeOptions.call(this,
d,h,c);if(g.remove){if(!0===g.remove||"true"===g.remove)g.remove="all";if(!1!==g.remove&&"false"!==g.remove){this.removeShapes(d,g.remove||"all");return}}switch(c.params.shape){case "text":g.opts.stroke&&(g.opts.fill=g.opts.stroke),g.opts.strokeWidth=0}c.set(g.opts);c.params=$.extend(!1,{},c.params,g.params);switch(c.params.shape){case "annulus":if(b.radii&&b.radii.length){p=c.get("stroke");c.forEachObject(function(a){c.remove(a);k.remove(a)});n=c.params.radii.length;for(e=r=0;e<n;e++)f=new fabric.Circle({radius:c.params.radii[e],
stroke:p}),r=Math.max(r,c.params.radii[e]),c.add(f);c.scaleX=l/q;c.scaleY=l/q;c.width=2*r;c.height=2*r;m===c&&k.setActiveObject(c)}break;case "box":b.width&&(c.scaleX=l/q);b.height&&(c.scaleY=l/q);break;case "circle":b.radius&&(c.scaleX=l/q,c.scaleY=l/q);break;case "ellipse":b.r1&&(c.rx=b.r1,c.scaleX=l/q,c.width=2*c.rx);b.r2&&(c.ry=b.r2,c.scaleY=l/q,c.height=2*c.ry);break;case "line":case "polygon":b.points&&b.points.length&&(c.scaleX=l/q,c.scaleY=l/q),m===c&&(a.Fabric.removePolygonAnchors(j.dlayer,
c),a.Fabric.addPolygonAnchors(j.dlayer,c)),a.resetPolygonCenter(c)}c.rescaleBorder();c.setCoords();a.Fabric._updateShape.call(s,d,c,v,"update")}),(void 0===b.redraw||b.redraw)&&k.renderAll(),this};a.Fabric.refreshShapes=function(d){var c,b,e,f,g,h,j,k,m,n=!1,p=this;if(m=this.getShapeLayer(d))return"main"===this.display.layers[d].dtype&&(n=!0),n?(e=this.binning.bin,f=this.rgb.sect.zoom,g=this.binning.obin/this.rgb.sect.ozoom*f/e,h=this.binning.obin/this.rgb.sect.ozoom*f/e):(e=1,h=g=f=this.rgb.sect.zoom),
e=m.canvas,e.getActiveGroup()&&e.discardActiveGroup(),b=e.getActiveObject(),this.selectShapes(d,"all",function(d){c=p.logicalToDisplayPos(d.pub.lcs);d.setLeft(c.x);d.setTop(c.y);switch(d.params.shape){case "point":case "text":break;default:j=g,k=h,n&&(j*=d.scaleX,k*=d.scaleY),d.scaleX=j,d.scaleY=k,d.rescaleBorder()}d.setCoords();switch(d.type){case "polyline":case "polygon":b===d&&(a.Fabric.removePolygonAnchors(m.dlayer,d),a.Fabric.addPolygonAnchors(m.dlayer,d))}}),n&&(this.binning.obin=this.binning.bin,
this.rgb.sect.ozoom=this.rgb.sect.zoom),e&&e.renderAll(),this};a.Fabric.addPolygonPoint=function(d,c,b){var e,f,g,h,j,k,m,n,p,r={},l,q,s,t,v,u=Number.MAX_VALUE;if(c&&c.points){r=a.eventToDisplayPos(b);b=c.getCenterPoint().x;g=c.getCenterPoint().y;b=(r.x-b)/c.get("scaleX");l=(r.y-g)/c.get("scaleY");for(g=-c.get("angle")*Math.PI/180;g>2*Math.PI;)g-=2*Math.PI;r=Math.cos(g)*b-Math.sin(g)*l;l=Math.sin(g)*b+Math.cos(g)*l;b=c.points;for(g=0;g<b.length;g++)f=b[g],h=b[(g+1)%b.length],j=f.x<h.x?f.x:h.x,k=f.y<
h.y?f.y:h.y,m=f.x>h.x?f.x:h.x,n=f.y>h.y?f.y:h.y,e=f.x-h.x,f=f.y-h.y,p=Math.sqrt(e*e+f*f),0!==p&&(e/=p,f/=p),p=r-h.x,v=l-h.y,p=p*e+v*f,e=h.x+e*p,h=h.y+f*p,e<j?e=j:e>m&&(e=m),h<k?h=k:h>n&&(h=n),j=(e-r)*(e-r)+(h-l)*(h-l),j<u&&(u=j,q=e,s=h,t=g===b.length?0:g);d=this.getShapeLayer(d);a.Fabric.removePolygonAnchors(d.dlayer,c);b.splice(t+1,0,{x:q,y:s});d.canvas.setActiveObject(c)}};a.Fabric.removePolygonPoint=function(d,c){var b,e,f,g;c&&c.polyparams&&(e=c.polyparams.polygon,f=e.points,g=c.polyparams.point,
b=this.getShapeLayer(d),a.Fabric.removePolygonAnchors(b.dlayer,e),f.splice(g,1),a.resetPolygonCenter(e),b.canvas.setActiveObject(e))};a.Fabric.addPolygonAnchors=function(d,c){var b,e,f={},g=d.canvas,h=function(){var b=this.polyparams.polygon,c=this.polyparams.point,e=b.get("points"),h=d.display.image;b.angle?f=a.rotatePoint({x:this.left,y:this.top},-b.angle,{x:b.left,y:b.top}):(f.x=this.left,f.y=this.top);e[c].x=(f.x-b.left)/b.scaleX;e[c].y=(f.y-b.top)/b.scaleY;a.resetPolygonCenter(b);a.Fabric._updateShape.call(h,
b.params.layerName,b,null,"update");h&&(h.params.listonchange||b.params.listonchange)&&h.listRegions(b,2);g.renderAll()},j=function(d){var b,c={};for(b=0;b<d.params.anchors.length;b++)c.x=d.left+d.points[b].x*d.scaleX,c.y=d.top+d.points[b].y*d.scaleY,d.angle&&(c=a.rotatePoint(c,d.angle,{x:d.left,y:d.top})),d.params.anchors[b].set({left:c.x,top:c.y,angle:d.angle}),d.params.anchors[b].setCoords();d._calcDimensions(!0);g.renderAll()};if(!c.params.anchors){c.params.anchors=[];for(b=0;b<c.points.length;b++)f.x=
c.left+c.points[b].x*c.scaleX,f.y=c.top+c.points[b].y*c.scaleY,c.angle&&(f=a.rotatePoint(f,c.angle,c.getCenterPoint())),e=new fabric.Rect({left:f.x,top:f.y,hasControls:!1,hasRotatingPoint:!1,hasBorders:!1,selectable:!0,fill:c.get("stroke"),hoverCursor:"pointer",width:a.Fabric.opts.cornerSize,height:a.Fabric.opts.cornerSize,padding:2}),e.on("moving",h),e.polyparams={},e.polyparams.polygon=c,e.polyparams.point=b,c.params.anchors[b]=e,g.add(e);c.on("moving",function(){j(c)});c.on("rotating",function(){j(c)});
c.on("scaling",function(){j(c)});c.setCoords()}};a.Fabric.removePolygonAnchors=function(a,c){var b,e=a.canvas;if(c.params&&c.params.anchors){for(b=0;b<c.params.anchors.length;b++)e.remove(c.params.anchors[b]);delete c.params.anchors}};a.resetPolygonCenter=function(d){var c,b,e,f={};d._calcDimensions();b=(d.minX+d.width/2)*d.scaleX;c=(d.minY+d.height/2)*d.scaleY;d.angle?f=a.rotatePoint({x:d.left+b,y:d.top+c},d.angle,{x:d.left,y:d.top}):(f.x=d.left+b,f.y=d.top+c);if(5<=fabric.version.split(".")[1]){b/=
d.scaleX;e=c/d.scaleY;for(c=0;c<d.points.length;c++)d.points[c].x-=b,d.points[c].y-=e}d.left=f.x;d.top=f.y;d.setCoords()};a.Fabric.print=function(d){var c,b,e,f,g;b=sprintf("width=%s,height=%s,menubar=1,toolbar=1,status=0,scrollbars=1,resizable=1",this.display.canvasjq.attr("width"),this.display.canvasjq.attr("height"));d=d||{};g=0;if(b=window.open(null,this.id,b)){b.document.open();b.document.write("<html><body style='padding: 0px; margin: 0px' onload='window.print(); return false'>");e=this.display.canvas.toDataURL("image/png");
f=sprintf("<div style='position:absolute; left:%spx; top:%spx'>",0,g);b.document.write(f);b.document.write("<img src='");b.document.write(e);b.document.write("'>");b.document.write("</div>");for(c in this.layers)this.layers.hasOwnProperty(c)&&("main"===this.layers[c].dlayer.dtype&&this.layers[c].show)&&(f=sprintf("<div style='position:absolute; left:%spx; top:%spx'>",0,g),b.document.write(f),b.document.write(this.layers[c].dlayer.canvas.toSVG()),b.document.write("</div>"));if(void 0===d.colorbar||
d.colorbar)if((d=this.display.pluginInstances.JS9Colorbar)&&d.isActive())g+=2,e=d.colorbarjq[0].toDataURL("image/png"),g+=this.display.height,f=sprintf("<div style='position:absolute; left:%spx; top:%spx'>",0,g),b.document.write(f),b.document.write(sprintf("<img ")),b.document.write(sprintf(" src='%s'>",e)),b.document.write("</div>"),e=d.textjq[0].toDataURL("image/png"),g+=d.colorbarjq.height()+1,f=sprintf("<div style='position:absolute; left:%spx; top:%spx'>",0,g),b.document.write(f),b.document.write(sprintf("<img style='width:%spx;'",
this.display.width)),b.document.write(sprintf("src='%s'>",e)),b.document.write("</div>");b.document.write("</body></html>");b.document.close()}else a.error("could not create print window (check your pop-up blockers)")};a.Fabric.initGraphics=function(){var d;a.Display.prototype.newShapeLayer=a.Fabric.newShapeLayer;a.Image.prototype.addShapes=a.Fabric.addShapes;a.Image.prototype.selectShapes=a.Fabric.selectShapes;a.Image.prototype.updateShapes=a.Fabric.updateShapes;a.Image.prototype.updateShape=a.Fabric._updateShape;
a.Image.prototype.getShapes=a.Fabric.getShapes;a.Image.prototype.changeShapes=a.Fabric.changeShapes;a.Image.prototype.removeShapes=a.Fabric.removeShapes;a.Image.prototype.refreshShapes=a.Fabric.refreshShapes;a.Image.prototype.getShapeLayer=a.Fabric.getShapeLayer;a.Image.prototype.showShapeLayer=a.Fabric.showShapeLayer;a.Image.prototype.displayShapeLayers=a.Fabric.displayShapeLayers;a.Image.prototype.print=a.Fabric.print;for(d in a.Fabric.opts)a.Fabric.opts.hasOwnProperty(d)&&(fabric.Object.prototype[d]=
a.Fabric.opts[d])};a.Fabric.initGraphics();a.Regions={};a.Regions.CLASS="JS9";a.Regions.NAME="Regions";a.Regions.opts={canvas:{zindex:a.SHAPEZINDEX+2},panzoom:!0,tags:"source,include",strokeWidth:2,iradius:0,oradius:30,nannuli:10,width:60,height:60,radius:30,r1:30,r2:20,ptshape:"box",ptsize:2,linepoints:[{x:-30,y:30},{x:30,y:-30}],polypoints:[{x:-30,y:30},{x:30,y:30},{x:0,y:-30}],fontFamily:"Helvetica",fontSize:14,fontStyle:"normal",fontWeight:300,textAlign:"left",angle:0,aradius1:4,aradius2:8,configURL:"./params/regionsconfig.html",
tagcolors:{include_source:"#00FF00",exclude_source:"#FF0000",include_background:"#FFD700",exclude_background:"#FF8C00",source:"#00FF00",background:"#FFD700",defcolor:"#00FF00"},onmousedown:function(d,c,b,e){var f;!a.specialKey(b)&&e.params&&(c=(new Date).getTime(),e.params.lasttime&&c-e.params.lasttime<a.DBLCLICK&&(f=!0),e.params.lasttime=c);f?e.params.winid||($("#dhtmlwindowholder").arrive("#regionsConfigForm",{onceOnly:!0},function(){e.pub&&a.Regions.initConfigForm.call(d,e)}),e.params.winid=a.allinone?
d.displayAnalysis("params",a.allinone.regionsConfigHTML,"Region Configuration"):d.displayAnalysis("params",a.InstallDir(a.Regions.opts.configURL),"Region Configuration")):a.specialKey(b)&&("polygon"===e.type||"polyline"===e.type?(a.Fabric.addPolygonPoint.call(d,e.params.layerName,e,b),a.Fabric._updateShape.call(d,e.params.layerName,e,null,"update")):e.polyparams&&e.polyparams.polygon&&(f=e.polyparams.polygon,a.Fabric.removePolygonPoint.call(d,f.params.layerName,e,b),a.Fabric._updateShape.call(d,f.params.layerName,
f,null,"update")))},onmouseup:function(){var a,c=[];this.getActiveObject()&&c.push(this.getActiveObject());this.getActiveGroup()&&(c=this.getActiveGroup().getObjects());for(a=0;a<c.length;a++)c[a].polyparams&&this.setActiveObject(c[a].polyparams.polygon)},onchange:null};a.Regions.init=function(d){var c;a.Image.prototype.parseRegions=a.Regions.parseRegions;a.Image.prototype.saveRegions=a.Regions.saveRegions;a.Image.prototype.listRegions=a.Regions.listRegions;c=this.display.newShapeLayer(d||"regions",
a.Regions.opts);c.canvas.on("mouse:up",function(){var a,d,f=[];if(c.display.image){d=c.display.image;this.getActiveObject()&&f.push(this.getActiveObject());this.getActiveGroup()&&(f=this.getActiveGroup().getObjects());for(a=0;a<f.length;a++)if(f[a].params){d.params.listonchange?d.listRegions("all",2):f[a].params.listonchange&&d.listRegions("selected",2);break}}});return this};a.Regions.onchange=function(d,c){if(a.Regions.opts.onchange&&"function"===typeof a.Regions.opts.onchange)try{a.Regions.opts.onchange(d,
c)}catch(b){}};a.Regions.initConfigForm=function(a){var c,b,e=a.params.winid,f="#"+$(e).attr("id")+" #regionsConfigForm ";$(f+"."+a.pub.shape).each(function(){$(this).removeClass("nodisplay")});$(f+".val").each(function(){b="";c=$(this).attr("name");switch(c){case "pts":a.pub.pts?a.pub.pts.forEach(function(a){b&&(b+=", ");b+=sprintf("%s, %s",a.x,a.y)}):a.pub.imstr&&(b=a.pub.imstr.replace(/^.*\(/,"").replace(/\)$/,""));break;default:void 0!==a.pub[c]&&(b=a.pub[c])}$(this).val(b)});a.pub.wcsstr&&$(f+
".wcs").removeClass("nodisplay");void 0===a.params.listonchange&&(a.params.listonchange=!1);a.params.listonchange?$(f+"[name='listonchange']").attr("checked","checked"):$(f+"[name='listonchange']").removeAttr("checked");void 0===a.params.fixinplace&&(a.params.fixinplace=!1);a.params.fixinplace?$(f+"[name='fixinplace']").attr("checked","checked"):$(f+"[name='fixinplace']").removeAttr("checked");switch(a.pub.shape){case "box":case "ellipse":case "line":case "polygon":case "text":$(f+".angle").removeClass("nodisplay")}$(f).data("im",
this);$(f).data("shape",a);$(f).data("winid",e)};a.Regions.processConfigForm=function(d,c,b){var e,f,g,h=b.length,j={},k=function(a,d,b){return"remove"===d||void 0!==a.pub[d]&&String(a.pub[d])!==b||void 0!==a.params[d]&&String(a.params[d])!==b?!0:!1},m=function(a){return"true"===a?!0:"false"===a?!1:""===a||isNaN(a)?a:parseFloat(a)};for(e=0;e<h;e++)switch(f=b[e].name,g=b[e].value,f){case "x":k(d,f,g)&&(j[f]=m(g),void 0===j.y&&(j.y=d.pub.y));break;case "y":k(d,f,g)&&(j[f]=m(g),void 0===j.x&&(j.x=d.pub.x));
break;default:k(d,f,g)&&(j[f]=m(g))}this.changeShapes(d.pub.layer,d,j);a.Regions.initConfigForm.call(this,d,c)};a.Regions.listRegions=function(a,c){var b,e,f,g,h,j,k="",m="none",n=!1,p=[];void 0===c&&(c=2);p=this.getShapes("regions",a);f=p.length;if(c)for(b=0;b<f;b++)if(e=p[b],"source,include"!==e.tags.join(",")){n=!0;break}for(b=0;b<f;b++)e=p[b],h=e.tags.join(","),j=0<=h.indexOf("exclude")?"-":"",n&&(g=" # "+h),e.wcsstr&&"image"!==this.params.wcssys&&"physical"!==this.params.wcssys?("wcs"!==m&&("none"!==
m&&(k+="; "),k+=this.params.wcssys,m="wcs"),k+="; "+j+e.wcsstr):e.imstr&&(m!==e.imsys&&("none"!==m&&(k+="; "),k+=e.imsys,m=e.imsys),k+="; "+j+e.imstr),n&&(k+=g);1<c&&this.displayMessage("regions",k);return k};a.Regions.parseRegions=function(d){var c=[],b,e,f,g,h,j,k,m,n,p,r,l,q=/(annulus)|(box)|(circle)|(ellipse)|(line)|(polygon)|(point)|(text)/,s=/(fk4)|(fk5)|(icrs)|(galactic)|(ecliptic)|(image)|(physical)/,t=/\(\s*([^)]+?)\s*\)/,v=/(\{[^}]*\})/,u=/\s*,\s*/,w=function(d){d=a.saostrtod(d);var b=String.fromCharCode(a.saodtype());
switch(b){case '"':d/=3600;break;case "'":d/=60;break;case "r":d*=180/Math.PI}return{dval:d,dtype:b}},y=function(d,b){var c,e;e=w(d);c=w(b);if(":"===e.dtype||":"===c.dtype)n=!0;m||n?(":"===e.dtype&&("galactic"!==k&&"ecliptic"!==k)&&(e.dval*=15),c=a.wcs2pix(this.wcs,e.dval,c.dval).split(/ +/),e=parseFloat(c[0])-1,c=parseFloat(c[1])-1):"physical"===k?(c=this.logicalToImagePos({x:e.dval,y:c.dval}),e=c.x,c=c.y):(e=e.dval,c=c.dval);return[e,c]},x=function(a,d){var b=w(a);if((m||n)&&b.dtype&&"."!==b.dtype)b.dval=
Math.abs(b.dval/r["cdelt"+d]);return b.dval};d=d.trim();if(!d.match(/(\(|\{|#|;|\n)/))return d;try{r=JSON.parse(a.wcsinfo(this.wcs))}catch(z){r={cdelt1:1,cdelt2:1,crot:0,imflip:0}}j=this.getWCSSys();k="physical";this.setWCSSys(k);m="image"!==k&&"physical"!==k;f=d.split(/\n|;/);for(d=0;d<f.length;d++)if("#"!==f[d].trim().substr(0,1)){n=!1;g=f[d];h=void 0;b={opts:{},args:[],isregion:0};b.cmd=0<=g.indexOf("(")?g.split("(")[0].trim().toLowerCase():0<=g.indexOf("{")?g.split("{")[0].trim().toLowerCase():
0<=g.indexOf("#")?g.split("#")[0].trim().toLowerCase():g.trim().toLowerCase();b.cmd&&(b.isregion=0<=b.cmd.search(q));b.comment=g.split("#")[1];b.comment&&(b.comment=b.comment.trim().toLowerCase());if((h=v.exec(g))&&h[1])try{b.opts=JSON.parse(h[1].trim())}catch(A){b.opts={}}if((h=t.exec(g))&&h[1])b.args=h[1].split(u);b.isregion&&0===b.cmd.indexOf("-")&&(b.cmd=b.cmd.slice(1),b.comment=b.comment?b.comment+",exclude":"exclude");h=b;l=h.args.length;if(h.isregion){g=$.extend(!0,{},h.opts);g.shape=h.cmd;
2<=l&&(p=y.call(this,h.args[0],h.args[1]),g.x=p[0],g.y=p[1]);switch(h.cmd){case "annulus":g.radii=[];for(b=2;b<l;b++)g.radii.push(x.call(this,h.args[b],1));break;case "box":3<=l&&(g.width=x.call(this,h.args[2],1));4<=l&&(g.height=x.call(this,h.args[3],2));5<=l&&(g.angle=w(h.args[4]).dval);break;case "circle":3<=l&&(g.radius=x.call(this,h.args[2],1));break;case "ellipse":3<=l&&(g.r1=x.call(this,h.args[2],1));4<=l&&(g.r2=x.call(this,h.args[3],2));5<=l&&(g.angle=w(h.args[4]).dval);break;case "line":case "polygon":g.pts=
[];for(e=b=0;b<l;b+=2,e++)p=y.call(this,h.args[b],h.args[b+1]),g.pts[e]={x:p[0],y:p[1]};delete g.x;delete g.y;break;case "text":3<=l&&(b=g,e=h.args[2].replace(/^['"]/,"").replace(/['"]$/,""),b.text=e)}h.comment&&(g.tags=h.comment);c.push(g)}else h.cmd.match(s)?(this.setWCSSys(h.cmd),k=this.getWCSSys(),m="image"!==k&&"physical"!==k):("remove"===h.cmd||"delete"===h.cmd)&&c.push({remove:!0})}this.setWCSSys(j);return c};a.Regions.saveRegions=function(d,c){var b=sprintf("# Region file format: JS9 version 1.0"),
e=this.listRegions(c,1),b=sprintf("%s\n%s\n",b,e.replace(/; */g,"\n")),b=new Blob([b],{type:"text/plain;charset=utf-8"});d=d||"js9.reg";window.hasOwnProperty("saveAs")?saveAs(b,d):a.error("no saveAs function available to save region file");return d};a.Regions.keyDownCB=function(a,c,b,e){var f,g;c={evt:b};var h=b.which||b.keyCode;e=e||"regions";g=a.display.layers[e].canvas;switch(h){case 8:case 46:b.preventDefault();f="removeRegion";break;case 37:b.preventDefault();f="editRegion";c.dx=-1;break;case 38:b.preventDefault();
f="editRegion";c.dy=1;break;case 39:b.preventDefault();f="editRegion";c.dx=1;break;case 40:b.preventDefault();f="editRegion";c.dy=-1;break;case 68:f="downRegion";break;case 85:f="upRegion"}switch(f){case "removeRegion":a.removeShapes(e,"selected");a.clearMessage(e);g.fire("mouse:up");break;case "editRegion":a.changeShapes(e,"selected",c);g.fire("mouse:up");break;case "downRegion":a.selectShapes(e,"selected",function(a){g.sendToBack(a)});break;case "upRegion":a.selectShapes(e,"selected",function(a){g.bringToFront(a)})}};
a.Magnifier={};a.Magnifier.CLASS="JS9";a.Magnifier.NAME="Magnifier";a.Magnifier.opts={originX:"left",originY:"top",hasControls:!1,hasRotatingPoint:!1,hasBorders:!1,selectable:!1,zoom:4,canvas:{selection:!1},tagcolors:{defcolor:"#00FF00"}};a.Magnifier.HTML="<span><button type='button' class='JS9Button' onClick='JS9.bcall(this, \"zoomMagnifier\", \"x2\"); return false'>x2</button><button type='button' class='JS9Button' onClick='JS9.bcall(this, \"zoomMagnifier\", \"/2\"); return false'>/2</button><button type='button' class='JS9Button' onClick='JS9.bcall(this, \"zoomMagnifier\", \""+
a.Magnifier.opts.zoom+"\"); return false'>"+a.Magnifier.opts.zoom+"</button></span>";a.Magnifier.init=function(d,c){this.width=this.divjq.attr("data-width");this.width||(this.width=d||a.MAGWIDTH);this.divjq.css("width",this.width);this.width=parseInt(this.divjq.css("width"),10);this.height=this.divjq.attr("data-height");this.height||(this.height=c||a.MAGHEIGHT);this.divjq.css("height",this.height);this.height=parseInt(this.divjq.css("height"),10);this.canvas=document.createElement("canvas");this.canvasjq=
$(this.canvas);this.canvasjq.addClass("JS9Magnifier");this.canvasjq.css("z-index",a.ZINDEX);this.canvasjq.attr("width",this.width);this.canvasjq.attr("height",this.height);this.context=this.canvas.getContext("2d");a.ANTIALIAS||(this.context.imageSmoothingEnabled=!1,this.context.mozImageSmoothingEnabled=!1,this.context.webkitImageSmoothingEnabled=!1);this.containerjq=$("<div>").addClass("JS9Container").append(this.canvasjq).appendTo(this.divjq);this.display.newShapeLayer("magnifier",a.Magnifier.opts,
this.divjq)};a.Magnifier.display=function(d,c){var b,e,f,g,h,j,k,m,n,p,r,l;d&&(d.display.pluginInstances.JS9Magnifier&&"active"===d.display.pluginInstances.JS9Magnifier.status)&&(d.magnifier||(d.magnifier={zoom:a.Magnifier.opts.zoom,posx:0,posy:0}),e=d.display.pluginInstances.JS9Magnifier,g=d.display.canvas,f=d.magnifier.zoom,k=Math.floor(e.width/f),m=Math.floor(e.height/f),c?(b=d.imageToDisplayPos(c),h=b.x-k/2,j=b.y-m/2,d.magnifier.posx=h,d.magnifier.posy=j):(h=d.magnifier.posx,j=d.magnifier.posy),
p=n=0,r=e.canvas.width,l=e.canvas.height,0>h&&(k+=h,n-=h*f,r+=h*f,h=0),b=h+k-g.width,0<b&&(k-=b,r=k*f),0>j&&(m+=j,p-=j*f,l+=j*f,j=0),b=j+m-g.height,0<b&&(m-=b,l=m*f),e.context.clear(),e.context.drawImage(g,h,j,k,m,n,p,r,l),d.magnifier.boxid||(d.magnifier.boxid=d.addShapes("magnifier","box"),$(e.canvas).css("background-color","black")),g=e.width/2,e=e.height/2,d.changeShapes("magnifier",d.magnifier.boxid,{left:g,top:e,width:f,height:f}))};a.Magnifier.zoom=function(d,c){var b,e;if(d&&d.magnifier){b=
d.magnifier;e=b.zoom;switch(c.charAt(0)){case "x":case "*":e*=parseFloat(c.slice(1));break;case "/":e/=parseFloat(c.slice(1));break;default:e=parseFloat(c)}if(!e||1>e)e=1;b.zoom=e;a.Magnifier.display(d)}};a.Magnifier.close=function(a){var c=a.display.pluginInstances.JS9Magnifier;c&&(c.context.clear(),a.removeShapes("magnifier","all"));return a};a.Panner={};a.Panner.CLASS="JS9";a.Panner.NAME="Panner";a.Panner.opts={hasControls:!1,hasRotatingPoint:!1,hasBorders:!1,zoom:4,canvas:{selection:!0},tagcolors:{defcolor:"#00FF00"}};
a.Panner.HTML="<span><button type='button' class='JS9Button' onClick='JS9.bcall(this, \"zoomPanner\", \"x2\"); return false'>x2</button><button type='button' class='JS9Button' onClick='JS9.bcall(this, \"zoomPanner\", \"/2\"); return false'>/2</button><button type='button' class='JS9Button' onClick='JS9.bcall(this, \"zoomPanner\", \"1\"); return false'>Zoom1</button><button type='button' class='JS9Button' onClick='JS9.bcall(this, \"panImage\"); return false'>Center</button></span>";a.Panner.init=function(d,
c){var b,e=this;this.width=this.divjq.attr("data-width");this.width||(this.width=d||a.PANWIDTH);this.divjq.css("width",this.width);this.width=parseInt(this.divjq.css("width"),10);this.height=this.divjq.attr("data-height");this.height||(this.height=c||a.PANHEIGHT);this.divjq.css("height",this.height);this.height=parseInt(this.divjq.css("height"),10);this.canvas=document.createElement("canvas");this.canvasjq=$(this.canvas);this.canvasjq.addClass("JS9Panner");this.canvasjq.css("z-index",a.ZINDEX);this.canvasjq.attr("width",
this.width);this.canvasjq.attr("height",this.height);this.context=this.canvas.getContext("2d");a.ANTIALIAS||(this.context.imageSmoothingEnabled=!1,this.context.mozImageSmoothingEnabled=!1,this.context.webkitImageSmoothingEnabled=!1);this.containerjq=$("<div>").addClass("JS9Container").append(this.canvasjq).appendTo(this.divjq);b=this.display.newShapeLayer("panner",a.Panner.opts,this.divjq);b.canvas.on("object:modified",function(d){var c=e.display.image;if(c){var h=d.target.getCenterPoint();d=(h.x-
c.panner.ix)*c.panner.xblock/c.panner.zoom+c.panner.x0;h=(b.canvas.height-(h.y+c.panner.iy))*c.panner.yblock/c.panner.zoom+c.panner.y0;try{c.display.pluginInstances.JS9Panner.status="inactive",c.setPan(d,h)}catch(j){a.log("couldn't pan image",j)}finally{c.display.pluginInstances.JS9Panner.status="active"}}});this.display.image&&a.Panner.display(this.display.image)};a.Panner.create=function(a){var c,b,e,f,g,h,j,k,m,n,p,r,l;if(a&&a.raw&&a.display.pluginInstances.JS9Panner){a.panner||(a.panner={});a.panner.zoom||
(a.panner.zoom=1);c=a.display.pluginInstances.JS9Panner;b=a.panner;e=a.rgb.sect;r=Math.min(a.raw.width,c.width);l=Math.min(a.raw.height,c.height);b.xblock=a.raw.width/r;b.yblock=a.raw.height/l;b.xblock>b.yblock?(l=Math.floor(l/b.xblock*b.yblock+0.5),b.yblock=b.xblock):b.yblock>b.xblock&&(r=Math.floor(r/b.yblock*b.xblock+0.5),b.xblock=b.yblock);c=a.display.context.createImageData(r,l);1===b.zoom?(g=b.xblock,h=b.yblock,e=f=0):(g=b.xblock/b.zoom,h=b.yblock/b.zoom,f=Math.max(0,(e.x0+e.x1-r*g)/2),e=Math.max(0,
(e.y0+e.y1-l*h)/2));b.x0=f;b.y0=e;b.img=c;b.ix=0;b.iy=0;if(a.rgbFile){for(j=0;j<l;j++){m=Math.floor(e+j*h)*a.offscreen.img.width;n=j*r;for(b=0;b<r;b++)k=Math.floor(f+b*g),k=4*(k+m),p=4*(n+b),c.data[p]=a.offscreen.img.data[k],c.data[p+1]=a.offscreen.img.data[k+1],c.data[p+2]=a.offscreen.img.data[k+2],c.data[p+3]=255}return a}for(j=0;j<l;j++){m=Math.floor(e+(l-j-1)*h)*a.raw.width;n=j*r;for(b=0;b<r;b++)k=Math.floor(f+b*g),k=a.colorData[k+m],p=4*(n+b),a.psColors[k]&&(c.data[p]=a.psColors[k][0],c.data[p+
1]=a.psColors[k][1],c.data[p+2]=a.psColors[k][2],c.data[p+3]=255)}return a}};a.Panner.display=function(d){var c,b,e,f,g,h,j;if(d&&(d.display.pluginInstances.JS9Panner&&"active"===d.display.pluginInstances.JS9Panner.status)&&(a.Panner.create(d),b=d.panner,c=d.display.pluginInstances.JS9Panner,e=d.rgb.sect,b.img))return b.img.width<c.canvas.width&&(b.ix=Math.floor((c.canvas.width-b.img.width)/2)),b.img.height<c.canvas.height&&(b.iy=Math.floor((c.canvas.height-b.img.height)/2)),c.context.clear(),c.context.putImageData(b.img,
b.ix,b.iy),f=b.zoom/b.xblock,g=b.zoom/b.yblock,h=e.width*f/e.zoom,j=e.height*g/e.zoom,f=(e.x0-b.x0)*f+b.ix,c=c.height-1-((e.y1-b.y0)*g+b.iy),f=f+1+h/2,c=c+1+j/2,f=Math.floor(f),c=Math.floor(c),h=Math.floor(h),j=Math.floor(j),h={left:f,top:c,width:h,height:j},d.panner.boxid?d.changeShapes("panner",d.panner.boxid,h):d.panner.boxid=d.addShapes("panner","box",h),d};a.Panner.zoom=function(d,c){var b,e,f;if(d&&d.panner&&d.display.pluginInstances.JS9Panner){e=d.panner;b=d.display.pluginInstances.JS9Panner;
f=e.zoom;switch(c.charAt(0)){case "*":case "x":case "X":b=Math.min(Math.min(b.width,b.height),f*parseFloat(c.slice(1)));break;case "/":b=Math.max(1,f/parseFloat(c.slice(1)));break;default:b=parseFloat(c)}if(!b||1>b)b=1;e.zoom=b;a.Panner.display(d);return d}};a.Panner.close=function(a){var c=a.display.pluginInstances.JS9Panner;c&&(c.context.clear(),a.removeShapes("panner","all"));return a};a.Catalogs={};a.Catalogs.CLASS="JS9";a.Catalogs.NAME="Catalogs";a.Catalogs.opts={hasControls:!1,hasRotatingPoint:!1,
hasBorders:!1,evented:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,lockUniScaling:!0,selectable:!1,canvas:{selection:!1},panzoom:!0,shape:"circle",strokeWidth:2,width:10,height:10,radius:5,eradius:{x:5,y:3},angle:0,tagcolors:{defcolor:"#00FF00"}};"function"!==typeof Object.create&&(Object.create=function(a){var c=function(){};c.prototype=a;return new c});Math.asinh=Math.asinh||function(a){return-Infinity===a?a:Math.log(a+Math.sqrt(a*a+1))};Math.sinh=Math.sinh||
function(a){return(Math.exp(a)-Math.exp(-a))/2};a.jupyterFocus=function(a,c){var b;window.hasOwnProperty("Jupyter")&&(b=a instanceof jQuery?a:$(a),b.find(c||"input, textarea").each(function(){Jupyter.keyboard_manager.register_events($(this))}))};a.getImageID=function(d,c){var b,e,f=0,g=1,h=a.images.length,j=/.*<([0-9][0-9]*)>$/;for(b=0;b<h;b++)e=a.images[b],e.display.id===c&&d===e.oid&&(0<=e.id.search(j)&&(e=e.id.replace(j,"$1"),g=Math.max(g,parseInt(e,10))),f++);return f?d+"<"+String(g+1)+">":d};
var H=1;a.uniqueID=function(){return H++};a.waiting=function(d,c){var b;switch(d){case !0:window.hasOwnProperty("Spinner")&&"spinner"===a.globalOpts.waitType?(c=c||$("body").get(0),a.spinner||(a.spinner={},b={color:a.globalOpts.spinColor,opacity:a.globalOpts.spinOpacity},a.spinner.spinner=new Spinner(b)),a.spinner.spinner.spin(c)):$("body").addClass("waiting");break;case !1:window.hasOwnProperty("Spinner")&&"spinner"===a.globalOpts.waitType?a.spinner&&a.spinner.spinner.stop():$("body").removeClass("waiting")}};
a.msgHandler=function(d,c){var b,e,f,g=[],h=d.cmd,j=d.id;c&&(a.globalOpts.alerts=!1);if(a.publics[h]){$.isArray(d.args)||(d.args=[d.args]);g=$.extend(!0,[],d.args);j&&g.push({display:j});try{f=a.publics[h].apply(null,g)}catch(k){f=sprintf("ERROR: %s",k.message)}c&&(a.globalOpts.alerts=!0,c(f));return f}if(!h||"#"===h)c&&c(""),c&&(a.globalOpts.alerts=!0);else{b=a.lookupCommand(h);e=a.lookupDisplay(j);if(b&&e)switch(b.getDisplayInfo(e),d.args?g=$.extend(!0,[],d.args):d.paramlist&&(g=d.paramlist.split(/ +/)),
b.getWhich(g)){case "get":try{f=b.get(g)||""}catch(m){f="ERROR: "+m.message}break;case "set":try{f=b.set(g)||"OK"}catch(n){f="ERROR: "+n.message}break;default:f=sprintf("ERROR: unknown cmd type for '%s'",h)}else b||(f=sprintf("ERROR: unknown cmd '%s'",h)),e||(f=sprintf("ERROR: unknown display (%s)",j));c&&(a.globalOpts.alerts=!0,c(f));return f}};a.lightWin=function(d,c,b,e,f){var g;switch(a.LIGHTWIN){case "dhtml":g=dhtmlwindow.open(d,c,b,e,f),/iPad|iPhone|iPod/.test(navigator.platform)&&$("#"+d+" "+
a.lightOpts.dhtml.drag).css("-webkit-overflow-scrolling","touch").css("overflow-y","scroll"),$("#"+d+" ."+a.lightOpts.dhtml.dragBar).doubletap(function(){g.close()},null,400),$("#"+d+" ."+a.lightOpts.dhtml.dragBar).on("touchend",this,function(){!dhtmlwindow.distancex&&!dhtmlwindow.distancey?2<=a.lightOpts.nclick?(alert("trouble closing this window? double-tap the window handle"),a.lightOpts.nclick=-1):0<=a.lightOpts.nclick&&a.lightOpts.nclick++:0<a.lightOpts.nclick&&(a.lightOpts.nclick=0)})}return g};
a.checkNew=function(d){d||a.error("internal failure in a JS9 constructor")};a.specialKey=function(a){return a.metaKey||a.ctrlKey};a.strace=function(d){var c="";1<a.DEBUG&&(c=d.stack||d.stacktrace||"");return c};a.bcall=function(d,c,b){var e,f;(e=$(d).closest("div[class^=JS9PluginToolbar]").data("displayid"))?f=a.getImage(e):a.error("can't find display for cmd: "+c);f||a.error("can't find image for cmd: "+c);switch(c){case "zoomPanner":3>arguments.length&&a.error("missing argument(s) for cmd: "+c);
try{a.Panner.zoom(f,b)}catch(g){a.error("error calling zoomPanner()",g)}break;case "zoomMagnifier":3>arguments.length&&a.error("missing argument(s) for cmd: "+c);try{a.Magnifier.zoom(f,b)}catch(h){a.error("error calling zoomMagnifier()",h)}break;case "panImage":try{f.setPan()}catch(j){a.error("error calling setPan()",j)}}};a.floatPrecision=function(a,c){var b,e;b=Math.floor(Math.log10(a));e=Math.floor(Math.log10(c));return b!==e?b>e?b:e:1};a.floatFormattedString=function(a,c,b){-2>c?a=sprintf("%.2e",
a):0>c?a=a.toFixed(Math.abs(c)+3):2>c?(c="%."+Math.abs(c)+"f",a=sprintf(c,a)):a=5>c?a.toFixed(b):sprintf("%.2e",a);return a};a.centroidPolygon=function(a){var c,b,e=0,f=0;if(a&&a.length){b=a.length;for(c=0;c<b;c++)e+=a[c].x,f+=a[c].y;return{x:e/b,y:f/b}}};a.lookupImage=function(d,c){var b,e,f=a.images.length;for(b=0;b<f;b++)if(e=a.images[b],d===e||d===e.id||d===e.file||d===a.TOROOT+e.file||e.fitsFile&&d===e.fitsFile)if(0<$("#"+e.display.id).length&&(!c||c===e.display.id))return e;return null};a.lookupDisplay=
function(d){var c,b=RegExp(sprintf("[-_]?(%s)$",a.PLUGINS));if(d&&"*"!==d&&0>d.toString().search(a.SUPERMENU)){for(c=0;c<a.displays.length;c++)if(d===a.displays[c]||d===a.displays[c].id)return a.displays[c];if("string"===typeof d){d=d.replace(b,"");for(c=0;c<a.displays.length;c++)if(d===a.displays[c]||d===a.displays[c].id)return a.displays[c]}a.error("can't find JS9 display with id: "+d)}return a.displays[0]};a.getImage=function(d){var c=null,b=null,c=a.lookupImage(d);if(!c&&(b=a.lookupDisplay(d)))c=
b.image;return c};a.lookupVfile=function(d){var c,b,e=[];if(!d)return e;for(c=0;c<a.images.length;c++)b=a.images[c].raws[0],b.hdu&&(b.hdu.fits&&d===b.hdu.fits.vfile)&&e.push(a.images[c].id);return e};a.onFileList=function(d,c,b){var e,f=function(e){var f;e=d[e];var j=$.extend({},c);if(a.fits.handleFITSFile){e.name&&(j.filename=e.name);j.display&&(f=a.lookupDisplay(j.display))&&(f=f.divjq[0]);a.waiting(!0,f);try{a.fits.handleFITSFile(e,j,b)}catch(k){a.error("can't process FITS file from file list",
k)}}else a.error("no FITS module available to load FITS file")};for(e=0;e<d.length;e++)if(-1!==d[e].type.indexOf("image/"))switch(d[e].type){case "image/fits":f(e);break;default:a.handleImageFile(d[e],c,b)}else f(e)};a.fetchURL=function(d,c,b,e){var f=new XMLHttpRequest,g;c||(c=d,d=/([^\\\/]+)$/.exec(c)[1]);g=$.extend(!0,{},b,a.fits.options);f.open("GET",c,!0);f.responseType=b.responseType?b.responseType:"blob";a.globalOpts.xtimeout&&(f.timeout=a.globalOpts.xtimeout);f.onload=function(){var h;4===
this.readyState&&(200===this.status||0===this.status?"blob"===f.responseType?(h=new Blob([this.response]),h.name=d.match("://")?d.split("/").reverse()[0].replace(/\?.*$/,""):d,"uc"===h.name&&(h.name="google_"+a.uniqueID()+".fits"),a.onFileList([h],g,e)):b.display?e(this.response,b,{display:b.display}):e(this.response,b):404===this.status?a.error("could not find "+c):a.error(sprintf("can't load: %s %s (%s)  ",c,f.statusText,f.status)))};f.onerror=function(){a.error(sprintf("cannot load: %s %s (%s)  ",
c,f.statusText,f.status))};f.ontimeout=function(){a.error("timeout awaiting response from server: "+c)};try{f.send()}catch(h){a.error("request to load "+c+" failed",h)}};a.fitsLibrary=function(d){var c;if(!d)return a.fits.name;c=d.toLowerCase();switch(c){case "fitsy":a.fits=Fitsy;a.fits.datahandler(a.NewFitsImage);a.fits.options=a.userOpts.fits||a.fits.options||{};break;case "astroem":case "cfitsio":a.fits=Astroem;a.fits.options=a.fits.options||{};a.fits.options.handler=a.NewFitsImage;a.fits.options.error=
a.error;a.userOpts.fits?(a.fits.options.extlist=a.userOpts.fits.extlist,a.fits.options.table={nx:a.userOpts.fits.table.nx,ny:a.userOpts.fits.table.ny}):(a.fits.options.extlist=a.globalOpts.extlist,a.fits.options.table={nx:a.globalOpts.dims[0],ny:a.globalOpts.dims[1]});a.fits.maxFITSMemory&&a.globalOpts.maxMemory&&a.fits.maxFITSMemory(a.globalOpts.maxMemory);break;default:a.error("unknown fits library: "+d)}a.fits.name=c;a.fits.options.error=a.error;a.fits.options.waiting=a.waiting;return c};a.handleImageFile=
function(d,c,b){c=$.extend(!0,{},c,a.fits.options);void 0===b&&(b=a.Load);var e=new FileReader;e.onload=function(a){var e=new Image;e.src=a.target.result;e.onload=function(){var a,f,k,m=0;a=document.createElement("canvas");f=a.getContext("2d");var n=e.height,p=e.width;a.width=p;a.height=n;f.drawImage(e,0,0);var r=f.getImageData(0,0,p,n).data,l=new Float32Array(n*p);for(f=0;f<n;f++)for(a=0;a<p;a++)k=0.299*r[m]+0.587*r[m+1]+0.114*r[m+2],l[(n-f)*p+a]=k,m+=4;a={head:{},name:d.name,filedata:l,naxis:2,
axis:[0,p,n],bitpix:-32,data:l};a.dmin=Number.MAX_VALUE;a.dmax=Number.MIN_VALUE;for(m=0;m<n*p;m++)a.dmin=Math.min(a.dmin,a.data[m]),a.dmax=Math.max(a.dmax,a.data[m]);b(a,c)}};e.readAsDataURL(d)};a.lookupColormap=function(d){var c;d||(d=a.imageOpts.colormap);if(d)for(c=0;c<a.colormaps.length;c++)if(a.colormaps[c].name===d)return a.colormaps[c];a.error("unknown colormap '"+d+"'")};a.lookupCommand=function(d){var c,b;if(d){b=d.toLowerCase();for(c=0;c<a.commands.length;c++)if(d=a.commands[c],d.name===
b||d.alias===b||d.alias2===b)return d}return null};a.error=function(d,c,b){var e,f,g="",h="",j=!0;a.waiting(!1);"string"===typeof c?(f=d.match(c))?f[1]?d=f[1]:f[0]&&(d=f[0]):j=!1:"object"===typeof c&&(e=c);3>arguments.length&&(b=!0);if(j&&(e&&e.message?d+=sprintf(" (%s)",e.message):d&&(e=Error(d)),(f=a.strace(e))&&(h="\n\nStacktrace:\n"+f),a.globalOpts.alerts&&(d&&("string"===typeof d&&0>d.search(/ERROR/))&&(g="JS9 ERROR: "),alert(g+(d+h))),b))throw e;};a.eventToDisplayPos=function(a){var c,b;a||
(a=window.event);a.target?c=a.target:a.srcElement&&(c=a.srcElement);3===c.nodeType&&(c=c.parentNode);a.originalEvent&&a.originalEvent.changedTouches&&a.originalEvent.changedTouches.length?(b=a.originalEvent.changedTouches[0].pageX,a=a.originalEvent.changedTouches[0].pageY):(b=a.pageX,a=a.pageY);b-=$(c).offset().left;c=a-$(c).offset().top;return{x:Math.floor(b-1),y:Math.floor(c-1)}};a.rotatePoint=function(a,c,b){var e;b=b||{x:0,y:0};c=Math.PI*c/180;e=Math.cos(c);c=Math.sin(c);return{x:e*(a.x-b.x)-
c*(a.y-b.y)+b.x,y:c*(a.x-b.x)+e*(a.y-b.y)+b.y}};a.log=function(){if(void 0!==window.console&&void 0!==window.console.log)try{console.log.apply(console,arguments)}catch(a){Function.prototype.bind.call(console.log,console).apply(console,arguments)}};a.isNumber=function(a){return!isNaN(parseFloat(a))&&isFinite(a)};a.notNull=function(a){return void 0!==a&&null!==a};a.cardpars=function(d){var c;if("="===d[8])return c=d.slice(0,8).trim(),d=d.slice(10).replace(/\'/g," ").replace(/\/.*/,"").trim(),"T"===
d?d=!0:"F"===d?d=!1:a.isNumber(d)&&(d=parseFloat(d)),[c,d]};a.raw2FITS=function(a,c){var b,e,f,g=!1,h="";if(!a)return h;if(a.card)for(b=0;b<a.card.length;b++)e=a.card[b],h+=e,"END "===e.substring(0,4)&&(g=!0),c&&(h+="\n");else if(a.cardstr)for(b=0;b<a.ncard;b++)e=a.cardstr.slice(80*b,80*(b+1)),h+=e,"END "===e.substring(0,4)&&(g=!0),c&&(h+="\n");else if(a.header)for(e in b=a.header,b){if(b.hasOwnProperty(e)&&!("js9Protocol"===e||"js9Endian"===e))"END"===e&&(g=!0),f=b[e],!0===f&&(f="T"),h+=sprintf("%-8s%-2s%-70s",
e,"=",f),c&&(h+="\n")}else if(a.BITPIX)for(e in b=a,b)if(b.hasOwnProperty(e)&&!("js9Protocol"===e||"js9Endian"===e))"END"===e&&(g=!0),f=b[e],!0===f&&(f="T"),h+=sprintf("%-8s%-2s%-70s",e,"=",f),c&&(h+="\n");g||(h+=sprintf("%-8s%-72s","END"," "),c&&(h+="\n"));return h};a.hdus2Str=function(a){var c,b,e,f="";if(!a)return f;for(c=0;c<a.length;c++){e=a[c];b=e.name?e.name:0===c?"Primary":"N/A";f+=sprintf("<b>#%d</b>:&#09;<b>name</b>: %s&#09;<b>type</b>: %s",e.hdu,b,e.type);switch(e.type){case "image":f+=
sprintf("&#09;<b>bitpix</b>: %d&#09;<b>naxis</b>: %d",e.bitpix,e.naxis);if(e.naxes.length){f+="&#09;<b>axes</b>: [";for(b=0;b<e.naxes.length;b++)f+=sprintf("%d",e.naxes[b]),b!==e.naxes.length-1&&(f+=", ");f+="]"}break;case "table":case "ascii":b="&#09;";9>=e.rows&&(b+="&#09;");f+=sprintf("&#09;<b>rows</b>: %d%s<b>cols</b>: [",e.rows,b);for(b=0;b<e.cols.length;b++)f+=sprintf("%s",e.cols[b].name),b!==e.cols.length-1&&(f+=", ");f+="]"}f+="\n\n"}return f};CanvasRenderingContext2D.prototype.clear=CanvasRenderingContext2D.prototype.clear||
function(a){a&&(this.save(),this.setTransform(1,0,0,1,0,0));this.clearRect(0,0,this.canvas.width,this.canvas.height);a&&this.restore()};a.tooltip=function(a,c,b,e,f,g){b?(b=b.replace(/\$([a-zA-Z0-9_.]+)/g,function(a,b){var c,d,n=b.split(".");switch(n[0]){case "im":d=e;break;case "xreg":d=f;break;case "evt":d=g;break;default:return a}for(c=1;c<n.length;c++)d=d[n[c]];return d}),e.display.tooltip.html(b).css({left:a,top:c,display:"inline-block"})):e.display.tooltip.html("").css({left:-9999,display:"none"})};
a.xeqByName=function(d,c){var b,e,f,g;e=Array.prototype.slice.call(arguments,2);b=typeof d;switch(b){case "function":return d.apply(c,e);case "string":f=d.split(".");g=f.pop();for(b=0;b<f.length;b++)c=c[f[b]];return c[g].apply(c,e);default:a.error("unknown function type: "+b)}};a.loadPrefs=function(d,c){$.ajax({url:d,dataType:"json",async:!1,success:function(b){var c,d,g;for(g in b)if(b.hasOwnProperty(g)&&a.hasOwnProperty(g)&&(d=typeof a[g],c=typeof b[g],d===c||"string"===c))switch(d){case "object":$.isArray(b[g])?
a[g]=b[g]:$.extend(!0,a[g],b[g]);break;case "number":case "string":a[g]=b[g]}},error:function(){c&&("Chrome"===a.BROWSER[0]&&""===document.domain?a.log("When using the file:// URI, Chrome must be run with the --allow-file-access-from-files switch to permit JS9 to access the preference file."):a.log("JS9 prefs file not available: %s",d))}})};a.isTypedArray=function(a){a=Object.prototype.toString.call(a);return{"[object Int8Array]":!0,"[object Uint8Array]":!0,"[object Uint8ClampedArray]":!0,"[object Int16Array]":!0,
"[object Uint16Array]":!0,"[object Int32Array]":!0,"[object Uint32Array]":!0,"[object Float32Array]":!0,"[object Float64Array]":!0}.hasOwnProperty(a)};a.mouseDownCB=function(d){var c,b,e,f,g=d.data,h=g.image;if(h)if(b=a.eventToDisplayPos(d),g.inResize(b)||d.preventDefault(),2<a.DEBUG&&a.log("m-down: %d %d %s",b.x,b.y,h.rclick),f=h.displayToImagePos(b),h.dnpos=b,h.rclick)h.clearMessage("regions");else{g.blendMode&&(g.blendMode=0);if(!a.specialKey(d))for(c in g.pluginInstances)if(g.pluginInstances.hasOwnProperty(c)&&
(b=g.pluginInstances[c],e=b.plugin.opts,b.isActive("onmousedown")&&(!h.rclick||e.mousedownRegions)))try{e.onmousedown.call(b,h,f,d.originalEvent||d)}catch(j){b.errLog("onmousedown",j)}h.evstate=d.button;d.originalEvent&&(d.originalEvent.touches&&d.originalEvent.touches.length)&&(h.evstate=d.originalEvent.touches.length-2);$("body").on("mousemove",g,function(b){return a.mouseMoveCB(b)});$("body").on("mouseup",g,function(b){return a.mouseUpCB(b)})}};a.mouseUpCB=function(d){var c,b,e,f,g=d.data,h=g.image;
if(h){c=a.eventToDisplayPos(d);g.inResize(c)||d.preventDefault();2<a.DEBUG&&a.log("m-up: %d %d %s",c.x,c.y,h.rclick);b=h.displayToImagePos(c);h.rclick?h.dnpos&&Math.abs(h.dnpos.x-c.x)<a.NOMOVE&&Math.abs(h.dnpos.y-c.y)<a.NOMOVE?h.updateShapes("regions","selected","select"):h.updateShapes("regions","selected","update"):a.specialKey(d)&&(h.dnpos&&Math.abs(h.dnpos.x-c.x)<a.NOMOVE&&Math.abs(h.dnpos.y-c.y)<a.NOMOVE)&&h.setPan(b.x,b.y);0===g.blendMode&&(g.blendMode=!0,h.displayImage("rgb"));if(!a.specialKey(d))for(e in g.pluginInstances)if(g.pluginInstances.hasOwnProperty(e)&&
(c=g.pluginInstances[e],f=c.plugin.opts,c.isActive("onmouseup")&&(!h.rclick||f.mouseupRegions)))try{f.onmouseup.call(c,h,b,d.originalEvent||d)}catch(j){c.errLog("onmouseup",j)}h.rclick=0;h.evstate=-1;g.resizing&&(g.resizing=0,a.bugs.webkit_resize&&(d=parseInt(g.divjq.css("width"),10),b=parseInt(g.divjq.css("height"),10),d<g.owidth&&g.divjq.css("width",g.owidth+a.RESIZEFUDGE),b<g.oheight&&g.divjq.css("height",g.oheight+a.RESIZEFUDGE)));$("body").off("mouseup");$("body").off("mousemove")}};a.mouseMoveCB=
function(d){var c,b,e,f,g=d.data,h=g.image;if(h&&!g.resizing){c=a.eventToDisplayPos(d);g.inResize(c)||d.preventDefault();3<a.DEBUG&&a.log("m-move: %d %d %s",c.x,c.y,h.rclick);b=h.displayToImagePos(c);h.valpos=null;if(h.rclick&&(h.rclick=2,(f=h.display.layers.regions.params.sel)&&(h.params.listonchange||f.params.listonchange)))h.updateShape("regions",f,null,"update",!0),h.listRegions("selected",2);switch(h.evstate){case -1:if(0<b.x&&(0<b.y&&b.x<h.raw.width&&b.y<h.raw.height)&&!a.specialKey(d))for(e in a.globalOpts.internalValPos&&
(h.valpos=h.updateValpos(b)),g.pluginInstances)if(g.pluginInstances.hasOwnProperty(e)&&(c=g.pluginInstances[e],f=c.plugin.opts,c.isActive("onmousemove")&&(!h.rclick||f.mousemoveRegions)))try{f.onmousemove.call(c,h,b,d.originalEvent||d)}catch(j){c.errLog("onmousemove",j)}break;case 0:case 1:if(!a.globalOpts.internalContrastBias)break;if(h.rclick||a.specialKey(d))break;if(h.rgbFile)break;if(h.dnpos&&Math.abs(h.dnpos.x-c.x)<a.NOMOVE&&Math.abs(h.dnpos.y-c.y)<a.NOMOVE)break;b.x=Math.floor(c.x+0.5);b.y=
Math.floor(c.y+0.5);if(0>b.x||0>b.y||b.x>=g.canvas.width||b.y>=g.canvas.height)break;h.params.bias=b.x/g.canvas.width;h.params.contrast=10*(b.y/g.canvas.height);a.bugs.firefox_linux?window.setTimeout(function(){h.displayImage("scaled")},0):h.displayImage("scaled")}}};a.mouseOverCB=function(d){var c,b,e,f,g=d.data,h=g.image;c=$(document).scrollLeft();e=$(document).scrollTop();d.preventDefault();if(h&&(h.display.displayConjq.focus(),window.scrollTo(c,e),!a.specialKey(d)))for(b in c=a.eventToDisplayPos(d),
c=h.displayToImagePos(c),g.pluginInstances)if(g.pluginInstances.hasOwnProperty(b)&&(e=g.pluginInstances[b],f=e.plugin.opts,e.isActive("onmouseover")&&(!h.rclick||f.mouseoverRegions)))try{f.onmouseover.call(e,h,c,d.originalEvent||d)}catch(j){e.errLog("onmouseover",j)}};a.mouseOutCB=function(d){var c,b,e,f,g=d.data,h=g.image;d.preventDefault();if(h&&(h.display.displayConjq.blur(),!a.specialKey(d)))for(b in c=a.eventToDisplayPos(d),c=h.displayToImagePos(c),g.pluginInstances)if(g.pluginInstances.hasOwnProperty(b)&&
(e=g.pluginInstances[b],f=e.plugin.opts,e.isActive("onmouseout")&&(!h.rclick||f.mouseoutRegions)))try{f.onmouseout.call(e,h,c,d.originalEvent||d)}catch(j){e.errLog("onmouseout",j)}};a.keyPressCB=function(d){var c,b,e,f,g=d.data,h=g.image;c=d.which||d.keyCode;d.preventDefault();3<a.DEBUG&&a.log("keypress: %d ",c);c=a.eventToDisplayPos(d);c=h.displayToImagePos(c);for(b in g.pluginInstances)if(g.pluginInstances.hasOwnProperty(b)&&(e=g.pluginInstances[b],f=e.plugin.opts,e.isActive("onkeypress")))try{f.onkeypress.call(e,
h,c,d.originalEvent||d)}catch(j){e.errLog("onkeypress",j)}};a.keyDownCB=function(d){var c,b,e,f,g=d.data,h=g.image;c=d.which||d.keyCode;3<a.DEBUG&&a.log("keydown: %d ",c);c=a.eventToDisplayPos(d);c=h.displayToImagePos(c);for(b in g.pluginInstances)if(g.pluginInstances.hasOwnProperty(b)&&(e=g.pluginInstances[b],f=e.plugin.opts,e.isActive("onkeydown")))try{f.onkeydown.call(e,h,c,d.originalEvent||d)}catch(j){e.errLog("onkeydown",j)}h.layer&&h.layers[h.layer].opts.usekeyboard&&a.Regions.keyDownCB(h,c,
d,h.layer)};a.dragenter=function(a,c){c.stopPropagation();c.preventDefault()};a.dragover=function(a,c){c.stopPropagation();c.preventDefault()};a.dragexit=function(a,c){c.stopPropagation();c.preventDefault()};a.dragdrop=function(d,c,b){var e=c.target.files||c.dataTransfer.files,f=$.extend(!0,{},a.fits.options);c.stopPropagation();c.preventDefault();void 0===f.display&&(f.display=d);void 0===f.extlist&&(f.extlist=a.globalOpts.extlist);a.onFileList(e,f,b)};a.consoleKeyDownCB=function(d){var c=d.data,
b=d.which||d.keyCode;if(!a.specialKey(d)){d=c.consoleConjq.find(".JS9CmdIn:last");d.focus();if(c.hist.length&&(38===b||40===b)){c.hist[c.histpos]?c.hist[c.histpos]=d.val():c.histtemp=d.val();switch(b){case 38:c.histpos--;0>c.histpos&&(c.histpos=0);break;case 40:c.histpos++;c.histpos>c.hist.length&&(c.histpos=c.hist.length);break;default:a.error("internal keycode switch mixup")}c.hist[c.histpos]?(d.val(c.hist[c.histpos]),c.histused=c.histpos!==c.hist.length?!0:!1):(d.val(c.histtemp),c.histused=!1)}13===
b&&(a.globalOpts.alerts=!1,c.xeq(),a.globalOpts.alerts=!0,c.inp())}};a.RegisterPlugin=function(d,c,b,e){var f;if(d&&(c&&b)&&(f=d+c,e?(e.viewMenuItem&&(e.menuItem=e.viewMenuItem),e.menuItem&&!e.menu&&(e.menu="view"),e.menu&&(e.menu=e.menu.toLowerCase())):e=[],a.PLUGINS&&(a.PLUGINS+="|"),a.PLUGINS+=f.replace(/JS9/,""),a.plugins.push({xclass:d,xname:c,name:f,opts:e,func:b,instances:[]}),e.help)){var g;b=e.help.match(/^.*[\\\/]/);b[0]&&(g="plugins/"+b[0].replace(/[\\\/]+$/,""));b=e.help.replace(/^.*[\\\/]/,
"");a.helpOpts[c]={type:g,url:b,heading:d,title:e.menuItem?e.menuItem:f}}};a.instantiatePlugin=function(d,c,b,e){var f,g,h;if("string"===typeof c){for(f=0;f<a.plugins.length;f++)if(g=a.plugins[f],g.name===c){c=g;break}"string"===typeof c&&a.error("unknown plugin: "+c)}g=Object.create(c.func.prototype);g.name=c.name;g.isActive=function(a){if("active"!==this.status||a&&!this.plugin.opts.hasOwnProperty(a))return!1;switch(this.winType){case "virtual":return!0;default:return this.divjq.is(":visible")}};
g.errLog=function(b,c){a.log("error in %s: %s [%s]\n%s",b,this.name,c.message,a.strace(c))};if(d){h=d instanceof jQuery?d:"object"===typeof d?$(d):$("#"+d);for(f=0;f<c.instances.length;f++)if(h.is(c.instances[f].odivjq))return c.instances[f]}else h=$("div");if(d)if(b)g.id=h.attr("id")||c.name,g.winType="light",g.winHandle=b,g.odivjq=h,g.divjq=h,g.outerdivjq=g.divjq.closest(a.lightOpts[a.LIGHTWIN].top);else{if(g.id=h.attr("id")||c.name,g.winType="div",b=h.attr("id")||"JS9Plugin",h.wrap("<div class='JS9PluginContainer'>"),
g.odivjq=h,g.divjq=h,g.divjq.addClass(c.xclass+"Plugin").addClass("JS9Plugin"),g.odivjq.attr("id")||g.odivjq.attr("id",g.id),g.outerdivjq=g.divjq.closest(".JS9PluginContainer"),c.opts.toolbarSeparate||h.data("toolbarseparate"))b="<div class='"+a.lightOpts[a.LIGHTWIN].dragBar+"'>",$(b).insertBefore(g.divjq)}else g.id=c.name,g.winType="virtual";g.plugin=c;g.el=d;g.status="active";c.instances.push(g);if("virtual"===g.winType)for(f=0;f<a.displays.length;f++)a.displays[f].pluginInstances[c.name]||(g.div=
null,g.display=a.displays[f],c.func.apply(g,e),a.displays[f].pluginInstances[c.name]=g);else{g.div=g.divjq[0];g.outerdiv=g.outerdivjq[0];if(c.opts.winDims&&(!g.divjq.width()||!g.divjq.height()))g.divjq.css("width",c.opts.winDims[0]),g.divjq.css("height",c.opts.winDims[1]);b=g.divjq.data("js9id")||g.id;g.display=a.lookupDisplay(b);if(h=h.data("toolbarhtml")||c.opts.toolbarHTML)h=a.Image.prototype.expandMacro.call(null,h,[{name:"title",value:c.opts.winTitle||""}]),d=g.divjq.closest(a.lightOpts[a.LIGHTWIN].drag),
0===d.length&&(d=g.divjq),$("<div class='JS9PluginToolbar-"+g.winType+"'>").css("z-index",a.BTNZINDEX).html(h).data("displayid",g.display.id).insertAfter(d);g.display.pluginInstances[c.name]=g;c.func.apply(g,e)}return g};a.instantiatePlugins=function(){var d,c=function(b){$("div."+b.name).each(function(){a.instantiatePlugin($(this),b,null,b.opts.divArgs)});!b.opts.menuItem&&(b.opts.winDims&&!b.opts.winDims[0]&&!b.opts.winDims[1])&&a.instantiatePlugin(null,b,null,b.opts.divArgs)};for(d=0;d<a.plugins.length;d++)c(a.plugins[d])};
a.init=function(){var d;window.HTMLCanvasElement||a.error("sorry: your browser does not support JS9 (no HTML5 canvas support). Try a modern version of Firefox, Chrome, or Safari.");JSON||a.error("sorry: your browser does not support JS9 (no JSON support). Try a modern version of Firefox, Chrome, or Safari.");if(!a.INSTALLDIR){try{a.INSTALLDIR=$('link[href$="js9.css"]').attr("href").replace(/js9\.css$/,"")||""}catch(c){a.INSTALLDIR=""}a.TOROOT=a.INSTALLDIR.replace(/([^\/.])+/g,"..")}window.hasOwnProperty("Kinetic")&&
!window.hasOwnProperty("fabric")&&a.error("please load fabric.js instead of Kinetic.js");a.WIDTH=a.WIDTH||512;a.HEIGHT=a.HEIGHT||512;a.INFOWIDTH=a.INFOWIDTH||345;a.INFOHEIGHT=a.INFOHEIGHT||265;a.MENUWIDTH=a.MENUWIDTH||a.WIDTH;a.MENUHEIGHT=a.MENUHEIGHT||"auto";a.CONWIDTH=a.CONWIDTH||a.WIDTH;a.CONHEIGHT=a.CONHEIGHT||180;a.MAGWIDTH=a.MAGWIDTH||a.WIDTH/2;a.MAGHEIGHT=a.MAGHEIGHT||a.HEIGHT/2;a.PANWIDTH=a.PANWIDTH||320;a.PANHEIGHT=a.PANHEIGHT||320;a.DS9WIDTH=a.DS9WIDTH||250;a.DS9HEIGHT=a.DS9HEIGHT||250;
"dhtml"===a.LIGHTWIN&&($("<div>").attr("id","dhtmlwindowholder").appendTo($(document.body)).append("<span style='display:none'>.</span>"),dhtmlwindow.imagefiles=a.allinone?[a.allinone.min,a.allinone.close,a.allinone.restore,a.allinone.resize]:[a.InstallDir("images/min.gif"),a.InstallDir("images/close.gif"),a.InstallDir("images/restore.gif"),a.InstallDir("images/resize.gif")],window.hasOwnProperty("Jupyter")&&$("#dhtmlwindowholder").arrive("input",function(){a.jupyterFocus($(this).parent())}));a.PREFSFILE&&
(a.loadPrefs(a.InstallDir(a.PREFSFILE),1),a.loadPrefs(a.PREFSFILE,0),$.extend(!0,a.Regions.opts,a.regionOpts));"file:"===a.globalOpts.helperProtocol&&(a.globalOpts.helperProtocol="http:");a.globalOpts.resize||(a.globalOpts.resizeHandle=!1);a.BROWSER[3]&&(a.globalOpts.resizeHandle=!1);a.globalOpts.helperProtocol+="//";if(window.hasOwnProperty("localStorage")){try{d=localStorage.getItem("images")}catch(b){d=null}if(d){try{a.userOpts.images=JSON.parse(d)}catch(e){}a.userOpts.images&&$.extend(!0,a.imageOpts,
a.userOpts.images)}try{d=localStorage.getItem("regions")}catch(f){d=null}if(d){try{a.userOpts.regions=JSON.parse(d)}catch(g){}a.userOpts.regions&&$.extend(!0,a.Regions.opts,a.userOpts.regions)}try{d=localStorage.getItem("fits")}catch(h){d=null}if(d)try{a.userOpts.fits=JSON.parse(d)}catch(j){}}a.globalOpts.postMessage&&window.addEventListener("message",function(b){var c;b=b.data;if("string"===typeof b)try{c=JSON.parse(b)}catch(d){a.error("can't parse msg: "+b,d)}else"object"===typeof b?c=b:a.error("invalid msg from postMessage");
(b=a.msgHandler(c))&&parent.postMessage({cmd:c.cmd,res:b},"*")},!1);a.DEBUG=a.DEBUG||a.globalOpts.debug||0;window.hasOwnProperty("ImageFilters")&&(a.ImageFilters=ImageFilters);window.hasOwnProperty("Astroem")&&(a.vmalloc=Astroem.vmalloc,a.vfree=Astroem.vfree,a.vheap=Astroem.vheap,a.vmemcpy=Astroem.vmemcpy,a.vfile=Astroem.vfile,a.vunlink=Astroem.vunlink,a.arrfile=Astroem.arrfile,a.listhdu=Astroem.listhdu,a.initwcs=Astroem.initwcs,a.wcsinfo=Astroem.wcsinfo,a.wcssys=Astroem.wcssys,a.wcsunits=Astroem.wcsunits,
a.pix2wcs=Astroem.pix2wcs,a.wcs2pix=Astroem.wcs2pix,a.reg2wcs=Astroem.reg2wcs,a.saostrtod=Astroem.saostrtod,a.saodtype=Astroem.saodtype,a.zscale=Astroem.zscale,a.reproject=Astroem.reproject);window.hasOwnProperty("Fitsy")?(a.fitsLibrary("fitsy"),a.fits=Fitsy):window.hasOwnProperty("Astroem")&&(a.fitsLibrary("cfitsio"),a.fits=Astroem);$("div.JS9").each(function(){a.checkNew(new a.Display($(this)))});a.RegisterPlugin("JS9","Menubar",a.Menubar);a.RegisterPlugin("JS9","Console",a.Console,{menuItem:"Console",
winTitle:"JS9 Console",winResize:!0,winDims:[a.WIDTH,180]});a.RegisterPlugin("JS9","Info",a.Info.init,{menuItem:"InfoBox",plugindisplay:a.Info.clearMain,winTitle:"JS9 Info",winResize:!0,winDims:[a.INFOWIDTH,a.INFOHEIGHT]});a.RegisterPlugin(a.Regions.CLASS,a.Regions.NAME,a.Regions.init,{onkeydown:a.Regions.keyDownCB,onregionschange:a.Regions.onchange,divArgs:["regions"],winDims:[0,0]});a.RegisterPlugin(a.Magnifier.CLASS,a.Magnifier.NAME,a.Magnifier.init,{menuItem:"Magnifier",toolbarSeparate:!1,toolbarHTML:a.Magnifier.HTML,
onmousemove:a.Magnifier.display,onimageclose:a.Magnifier.close,winTitle:"JS9 Magnifier",winDims:[a.MAGWIDTH,a.MAGHEIGHT],divArgs:[a.DS9WIDTH,a.DS9HEIGHT]});a.RegisterPlugin(a.Panner.CLASS,a.Panner.NAME,a.Panner.init,{menuItem:"Panner",toolbarSeparate:!1,toolbarHTML:a.Panner.HTML,onimagedisplay:a.Panner.display,onimageclose:a.Panner.close,winTitle:"JS9 Panner",winDims:[a.PANWIDTH,a.PANHEIGHT],divArgs:[a.DS9WIDTH,a.DS9HEIGHT]});a.instantiatePlugins();a.checkNew(new a.Colormap("grey",[[0,0],[1,1]],[[0,
0],[1,1]],[[0,0],[1,1]]));a.checkNew(new a.Colormap("red",[[0,0],[1,1]],[[0,0],[0,0]],[[0,0],[0,0]]));a.checkNew(new a.Colormap("green",[[0,0],[0,0]],[[0,0],[1,1]],[[0,0],[0,0]]));a.checkNew(new a.Colormap("blue",[[0,0],[0,0]],[[0,0],[0,0]],[[0,0],[1,1]]));a.checkNew(new a.Colormap("a",[[0,0],[0.25,0],[0.5,1],[1,1]],[[0,0],[0.25,1],[0.5,0],[0.77,0],[1,1]],[[0,0],[0.125,0],[0.5,1],[0.64,0.5],[0.77,0],[1,0]]));a.checkNew(new a.Colormap("b",[[0,0],[0.25,0],[0.5,1],[1,1]],[[0,0],[0.5,0],[0.75,1],[1,1]],
[[0,0],[0.25,1],[0.5,0],[0.75,0],[1,1]]));a.checkNew(new a.Colormap("bb",[[0,0],[0.5,1],[1,1]],[[0,0],[0.25,0],[0.75,1],[1,1]],[[0,0],[0.5,0],[1,1]]));a.checkNew(new a.Colormap("he",[[0,0],[0.015,0.5],[0.25,0.5],[0.5,0.75],[1,1]],[[0,0],[0.065,0],[0.125,0.5],[0.25,0.75],[0.5,0.81],[1,1]],[[0,0],[0.015,0.125],[0.03,0.375],[0.065,0.625],[0.25,0.25],[1,1]]));a.checkNew(new a.Colormap("i8",[[0,0,0],[0,1,0],[0,0,1],[0,1,1],[1,0,0],[1,1,0],[1,0,1],[1,1,1]]));a.checkNew(new a.Colormap("aips0",[[0.196,0.196,
0.196],[0.475,0,0.608],[0,0,0.785],[0.373,0.655,0.925],[0,0.596,0],[0,0.965,0],[1,1,0],[1,0.694,0],[1,0,0]]));a.checkNew(new a.Colormap("sls",[[0,0,0],[0.043442,0,0.052883],[0.086883,0,0.105767],[0.130325,0,0.15865],[0.173767,0,0.211533],[0.217208,0,0.264417],[0.26065,0,0.3173],[0.304092,0,0.370183],[0.347533,0,0.423067],[0.390975,0,0.47595],[0.434417,0,0.528833],[0.477858,0,0.581717],[0.5213,0,0.6346],[0.506742,0,0.640217],[0.492183,0,0.645833],[0.477625,0,0.65145],[0.463067,0,0.657067],[0.448508,
0,0.662683],[0.43395,0,0.6683],[0.419392,0,0.673917],[0.404833,0,0.679533],[0.390275,0,0.68515],[0.375717,0,0.690767],[0.361158,0,0.696383],[0.3466,0,0.702],[0.317717,0,0.712192],[0.288833,0,0.722383],[0.25995,0,0.732575],[0.231067,0,0.742767],[0.202183,0,0.752958],[0.1733,0,0.76315],[0.144417,0,0.773342],[0.115533,0,0.783533],[0.08665,0,0.793725],[0.057767,0,0.803917],[0.028883,0,0.814108],[0,0,0.8243],[0,0.019817,0.838942],[0,0.039633,0.853583],[0,0.05945,0.868225],[0,0.079267,0.882867],[0,0.099083,
0.897508],[0,0.1189,0.91215],[0,0.138717,0.926792],[0,0.158533,0.941433],[0,0.17835,0.956075],[0,0.198167,0.970717],[0,0.217983,0.985358],[0,0.2378,1],[0,0.268533,1],[0,0.299267,1],[0,0.33,1],[0,0.360733,1],[0,0.391467,1],[0,0.4222,1],[0,0.452933,1],[0,0.483667,1],[0,0.5144,1],[0,0.545133,1],[0,0.575867,1],[0,0.6066,1],[0,0.631733,0.9753],[0,0.656867,0.9506],[0,0.682,0.9259],[0,0.707133,0.9012],[0,0.732267,0.8765],[0,0.7574,0.8518],[0,0.782533,0.8271],[0,0.807667,0.8024],[0,0.8328,0.7777],[0,0.857933,
0.753],[0,0.883067,0.7283],[0,0.9082,0.7036],[0,0.901908,0.676675],[0,0.895617,0.64975],[0,0.889325,0.622825],[0,0.883033,0.5959],[0,0.876742,0.568975],[0,0.87045,0.54205],[0,0.864158,0.515125],[0,0.857867,0.4882],[0,0.851575,0.461275],[0,0.845283,0.43435],[0,0.838992,0.407425],[0,0.8327,0.3805],[0,0.832308,0.354858],[0,0.831917,0.329217],[0,0.831525,0.303575],[0,0.831133,0.277933],[0,0.830742,0.252292],[0,0.83035,0.22665],[0,0.829958,0.201008],[0,0.829567,0.175367],[0,0.829175,0.149725],[0,0.828783,
0.124083],[0,0.828392,0.098442],[0,0.828,0.0728],[0.033167,0.834167,0.066733],[0.066333,0.840333,0.060667],[0.0995,0.8465,0.0546],[0.132667,0.852667,0.048533],[0.165833,0.858833,0.042467],[0.199,0.865,0.0364],[0.232167,0.871167,0.030333],[0.265333,0.877333,0.024267],[0.2985,0.8835,0.0182],[0.331667,0.889667,0.012133],[0.364833,0.895833,0.006067],[0.398,0.902,0],[0.43095,0.902,0],[0.4639,0.902,0],[0.49685,0.902,0],[0.5298,0.902,0],[0.56275,0.902,0],[0.5957,0.902,0],[0.62865,0.902,0],[0.6616,0.902,
0],[0.69455,0.902,0],[0.7275,0.902,0],[0.76045,0.902,0],[0.7934,0.902,0],[0.810617,0.897133,0.003983],[0.827833,0.892267,0.007967],[0.84505,0.8874,0.01195],[0.862267,0.882533,0.015933],[0.879483,0.877667,0.019917],[0.8967,0.8728,0.0239],[0.913917,0.867933,0.027883],[0.931133,0.863067,0.031867],[0.94835,0.8582,0.03585],[0.965567,0.853333,0.039833],[0.982783,0.848467,0.043817],[1,0.8436,0.0478],[0.995725,0.824892,0.0516],[0.99145,0.806183,0.0554],[0.987175,0.787475,0.0592],[0.9829,0.768767,0.063],[0.978625,
0.750058,0.0668],[0.97435,0.73135,0.0706],[0.970075,0.712642,0.0744],[0.9658,0.693933,0.0782],[0.961525,0.675225,0.082],[0.95725,0.656517,0.0858],[0.952975,0.637808,0.0896],[0.9487,0.6191,0.0934],[0.952975,0.600408,0.085617],[0.95725,0.581717,0.077833],[0.961525,0.563025,0.07005],[0.9658,0.544333,0.062267],[0.970075,0.525642,0.054483],[0.97435,0.50695,0.0467],[0.978625,0.488258,0.038917],[0.9829,0.469567,0.031133],[0.987175,0.450875,0.02335],[0.99145,0.432183,0.015567],[0.995725,0.413492,0.007783],
[1,0.3948,0],[0.998342,0.3619,0],[0.996683,0.329,0],[0.995025,0.2961,0],[0.993367,0.2632,0],[0.991708,0.2303,0],[0.99005,0.1974,0],[0.988392,0.1645,0],[0.986733,0.1316,0],[0.985075,0.0987,0],[0.983417,0.0658,0],[0.981758,0.0329,0],[0.9801,0,0],[0.955925,0,0],[0.93175,0,0],[0.907575,0,0],[0.8834,0,0],[0.859225,0,0],[0.83505,0,0],[0.810875,0,0],[0.7867,0,0],[0.762525,0,0],[0.73835,0,0],[0.714175,0,0],[0.69,0,0],[0.715833,0.083333,0.083333],[0.741667,0.166667,0.166667],[0.7675,0.25,0.25],[0.793333,0.333333,
0.333333],[0.819167,0.416667,0.416667],[0.845,0.5,0.5],[0.870833,0.583333,0.583333],[0.896667,0.666667,0.666667],[0.9225,0.75,0.75],[0.948333,0.833333,0.833333],[0.974167,0.916667,0.916667],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1]]));a.checkNew(new a.Colormap("hsv",function(){var a,b,c,d,e,f,g,h=[],j=0;for(a=0;200>a;a++,j++){b=1-a/199;c=360*b+270;d=Math.abs(Math.sin(3.1416*b));for(b=Math.pow(1-b,1/3);360<=c;)c-=360;c/=60;g=Math.floor(c);e=c-g;c=b*(1-d);f=b*(1-d*e);d=b*(1-d*
(1-e));h[j]=[];switch(g){case 0:h[j].push(b);h[j].push(d);h[j].push(c);break;case 1:h[j].push(f);h[j].push(b);h[j].push(c);break;case 2:h[j].push(c);h[j].push(b);h[j].push(d);break;case 3:h[j].push(c);h[j].push(f);h[j].push(b);break;case 4:h[j].push(d);h[j].push(c);h[j].push(b);break;case 5:h[j].push(b),h[j].push(c),h[j].push(f)}}return h}()));a.checkNew(new a.Colormap("heat",[[0,0],[0.34,1],[1,1]],[[0,0],[1,1]],[[0,0],[0.65,0],[0.98,1],[1,1]]));a.checkNew(new a.Colormap("cool",[[0,0],[0.29,0],[0.76,
0.1],[1,1]],[[0,0],[0.22,0],[0.96,1],[1,1]],[[0,0],[0.53,1],[1,1]]));a.checkNew(new a.Colormap("rainbow",[[0,1],[0.2,0],[0.6,0],[0.8,1],[1,1]],[[0,0],[0.2,0],[0.4,1],[0.8,1],[1,0]],[[0,1],[0.4,1],[0.6,0],[1,0]]));a.checkNew(new a.Colormap("standard",[[0,0],[0.333,0.3],[0.333,0],[0.666,0.3],[0.666,0.3],[1,1]],[[0,0],[0.333,0.3],[0.333,0.3],[0.666,1],[0.666,0],[1,0.3]],[[0,0],[0.333,1],[0.333,0],[0.666,0.3],[0.666,0],[1,0.3]]));a.checkNew(new a.Colormap("staircase",function(){var a,b,c=[],d=0;for(a=
1;5>=a;a++,d++)b=a/5,c[d]=[],c[d].push(0.3*b),c[d].push(0.3*b),c[d].push(b);for(a=1;5>=a;a++,d++)b=a/5,c[d]=[],c[d].push(0.3*b),c[d].push(b),c[d].push(0.3*b);for(a=1;5>=a;a++,d++)b=a/5,c[d]=[],c[d].push(b),c[d].push(0.3*b),c[d].push(0.3*b);return c}()));a.checkNew(new a.Colormap("color",[[0,0,0],[0.18431,0.18431,0.18431],[0.37255,0.37255,0.37255],[0.56078,0.56078,0.56078],[0.74902,0.74902,0.74902],[0.93725,0.93725,0.93725],[0,0.18431,0.93725],[0,0.37255,0.74902],[0,0.49804,0.49804],[0,0.74902,0.3098],
[0,0.93725,0],[0.3098,0.62353,0],[0.49804,0.49804,0],[0.62353,0.3098,0],[0.93725,0,0],[0.74902,0,0.3098]]));a.checkNew(new a.Colormap("viridis",[[0.26700401,0.00487433,0.32941519],[0.26851048,0.00960483,0.33542652],[0.26994384,0.01462494,0.34137895],[0.27130489,0.01994186,0.34726862],[0.27259384,0.02556309,0.35309303],[0.27380934,0.03149748,0.35885256],[0.27495242,0.03775181,0.36454323],[0.27602238,0.04416723,0.37016418],[0.2770184,0.05034437,0.37571452],[0.27794143,0.05632444,0.38119074],[0.27879067,
0.06214536,0.38659204],[0.2795655,0.06783587,0.39191723],[0.28026658,0.07341724,0.39716349],[0.28089358,0.07890703,0.40232944],[0.28144581,0.0843197,0.40741404],[0.28192358,0.08966622,0.41241521],[0.28232739,0.09495545,0.41733086],[0.28265633,0.10019576,0.42216032],[0.28291049,0.10539345,0.42690202],[0.28309095,0.11055307,0.43155375],[0.28319704,0.11567966,0.43611482],[0.28322882,0.12077701,0.44058404],[0.28318684,0.12584799,0.44496],[0.283072,0.13089477,0.44924127],[0.28288389,0.13592005,0.45342734],
[0.28262297,0.14092556,0.45751726],[0.28229037,0.14591233,0.46150995],[0.28188676,0.15088147,0.46540474],[0.28141228,0.15583425,0.46920128],[0.28086773,0.16077132,0.47289909],[0.28025468,0.16569272,0.47649762],[0.27957399,0.17059884,0.47999675],[0.27882618,0.1754902,0.48339654],[0.27801236,0.18036684,0.48669702],[0.27713437,0.18522836,0.48989831],[0.27619376,0.19007447,0.49300074],[0.27519116,0.1949054,0.49600488],[0.27412802,0.19972086,0.49891131],[0.27300596,0.20452049,0.50172076],[0.27182812,0.20930306,
0.50443413],[0.27059473,0.21406899,0.50705243],[0.26930756,0.21881782,0.50957678],[0.26796846,0.22354911,0.5120084],[0.26657984,0.2282621,0.5143487],[0.2651445,0.23295593,0.5165993],[0.2636632,0.23763078,0.51876163],[0.26213801,0.24228619,0.52083736],[0.26057103,0.2469217,0.52282822],[0.25896451,0.25153685,0.52473609],[0.25732244,0.2561304,0.52656332],[0.25564519,0.26070284,0.52831152],[0.25393498,0.26525384,0.52998273],[0.25219404,0.26978306,0.53157905],[0.25042462,0.27429024,0.53310261],[0.24862899,
0.27877509,0.53455561],[0.2468114,0.28323662,0.53594093],[0.24497208,0.28767547,0.53726018],[0.24311324,0.29209154,0.53851561],[0.24123708,0.29648471,0.53970946],[0.23934575,0.30085494,0.54084398],[0.23744138,0.30520222,0.5419214],[0.23552606,0.30952657,0.54294396],[0.23360277,0.31382773,0.54391424],[0.2316735,0.3181058,0.54483444],[0.22973926,0.32236127,0.54570633],[0.22780192,0.32659432,0.546532],[0.2258633,0.33080515,0.54731353],[0.22392515,0.334994,0.54805291],[0.22198915,0.33916114,0.54875211],
[0.22005691,0.34330688,0.54941304],[0.21812995,0.34743154,0.55003755],[0.21620971,0.35153548,0.55062743],[0.21429757,0.35561907,0.5511844],[0.21239477,0.35968273,0.55171011],[0.2105031,0.36372671,0.55220646],[0.20862342,0.36775151,0.55267486],[0.20675628,0.37175775,0.55311653],[0.20490257,0.37574589,0.55353282],[0.20306309,0.37971644,0.55392505],[0.20123854,0.38366989,0.55429441],[0.1994295,0.38760678,0.55464205],[0.1976365,0.39152762,0.55496905],[0.19585993,0.39543297,0.55527637],[0.19410009,0.39932336,
0.55556494],[0.19235719,0.40319934,0.55583559],[0.19063135,0.40706148,0.55608907],[0.18892259,0.41091033,0.55632606],[0.18723083,0.41474645,0.55654717],[0.18555593,0.4185704,0.55675292],[0.18389763,0.42238275,0.55694377],[0.18225561,0.42618405,0.5571201],[0.18062949,0.42997486,0.55728221],[0.17901879,0.43375572,0.55743035],[0.17742298,0.4375272,0.55756466],[0.17584148,0.44128981,0.55768526],[0.17427363,0.4450441,0.55779216],[0.17271876,0.4487906,0.55788532],[0.17117615,0.4525298,0.55796464],[0.16964573,
0.45626209,0.55803034],[0.16812641,0.45998802,0.55808199],[0.1666171,0.46370813,0.55811913],[0.16511703,0.4674229,0.55814141],[0.16362543,0.47113278,0.55814842],[0.16214155,0.47483821,0.55813967],[0.16066467,0.47853961,0.55811466],[0.15919413,0.4822374,0.5580728],[0.15772933,0.48593197,0.55801347],[0.15626973,0.4896237,0.557936],[0.15481488,0.49331293,0.55783967],[0.15336445,0.49700003,0.55772371],[0.1519182,0.50068529,0.55758733],[0.15047605,0.50436904,0.55742968],[0.14903918,0.50805136,0.5572505],
[0.14760731,0.51173263,0.55704861],[0.14618026,0.51541316,0.55682271],[0.14475863,0.51909319,0.55657181],[0.14334327,0.52277292,0.55629491],[0.14193527,0.52645254,0.55599097],[0.14053599,0.53013219,0.55565893],[0.13914708,0.53381201,0.55529773],[0.13777048,0.53749213,0.55490625],[0.1364085,0.54117264,0.55448339],[0.13506561,0.54485335,0.55402906],[0.13374299,0.54853458,0.55354108],[0.13244401,0.55221637,0.55301828],[0.13117249,0.55589872,0.55245948],[0.1299327,0.55958162,0.55186354],[0.12872938,0.56326503,
0.55122927],[0.12756771,0.56694891,0.55055551],[0.12645338,0.57063316,0.5498411],[0.12539383,0.57431754,0.54908564],[0.12439474,0.57800205,0.5482874],[0.12346281,0.58168661,0.54744498],[0.12260562,0.58537105,0.54655722],[0.12183122,0.58905521,0.54562298],[0.12114807,0.59273889,0.54464114],[0.12056501,0.59642187,0.54361058],[0.12009154,0.60010387,0.54253043],[0.11973756,0.60378459,0.54139999],[0.11951163,0.60746388,0.54021751],[0.11942341,0.61114146,0.53898192],[0.11948255,0.61481702,0.53769219],[0.11969858,
0.61849025,0.53634733],[0.12008079,0.62216081,0.53494633],[0.12063824,0.62582833,0.53348834],[0.12137972,0.62949242,0.53197275],[0.12231244,0.63315277,0.53039808],[0.12344358,0.63680899,0.52876343],[0.12477953,0.64046069,0.52706792],[0.12632581,0.64410744,0.52531069],[0.12808703,0.64774881,0.52349092],[0.13006688,0.65138436,0.52160791],[0.13226797,0.65501363,0.51966086],[0.13469183,0.65863619,0.5176488],[0.13733921,0.66225157,0.51557101],[0.14020991,0.66585927,0.5134268],[0.14330291,0.66945881,0.51121549],
[0.1466164,0.67304968,0.50893644],[0.15014782,0.67663139,0.5065889],[0.15389405,0.68020343,0.50417217],[0.15785146,0.68376525,0.50168574],[0.16201598,0.68731632,0.49912906],[0.1663832,0.69085611,0.49650163],[0.1709484,0.69438405,0.49380294],[0.17570671,0.6978996,0.49103252],[0.18065314,0.70140222,0.48818938],[0.18578266,0.70489133,0.48527326],[0.19109018,0.70836635,0.48228395],[0.19657063,0.71182668,0.47922108],[0.20221902,0.71527175,0.47608431],[0.20803045,0.71870095,0.4728733],[0.21400015,0.72211371,
0.46958774],[0.22012381,0.72550945,0.46622638],[0.2263969,0.72888753,0.46278934],[0.23281498,0.73224735,0.45927675],[0.2393739,0.73558828,0.45568838],[0.24606968,0.73890972,0.45202405],[0.25289851,0.74221104,0.44828355],[0.25985676,0.74549162,0.44446673],[0.26694127,0.74875084,0.44057284],[0.27414922,0.75198807,0.4366009],[0.28147681,0.75520266,0.43255207],[0.28892102,0.75839399,0.42842626],[0.29647899,0.76156142,0.42422341],[0.30414796,0.76470433,0.41994346],[0.31192534,0.76782207,0.41558638],[0.3198086,
0.77091403,0.41115215],[0.3277958,0.77397953,0.40664011],[0.33588539,0.7770179,0.40204917],[0.34407411,0.78002855,0.39738103],[0.35235985,0.78301086,0.39263579],[0.36074053,0.78596419,0.38781353],[0.3692142,0.78888793,0.38291438],[0.37777892,0.79178146,0.3779385],[0.38643282,0.79464415,0.37288606],[0.39517408,0.79747541,0.36775726],[0.40400101,0.80027461,0.36255223],[0.4129135,0.80304099,0.35726893],[0.42190813,0.80577412,0.35191009],[0.43098317,0.80847343,0.34647607],[0.44013691,0.81113836,0.3409673],
[0.44936763,0.81376835,0.33538426],[0.45867362,0.81636288,0.32972749],[0.46805314,0.81892143,0.32399761],[0.47750446,0.82144351,0.31819529],[0.4870258,0.82392862,0.31232133],[0.49661536,0.82637633,0.30637661],[0.5062713,0.82878621,0.30036211],[0.51599182,0.83115784,0.29427888],[0.52577622,0.83349064,0.2881265],[0.5356211,0.83578452,0.28190832],[0.5455244,0.83803918,0.27562602],[0.55548397,0.84025437,0.26928147],[0.5654976,0.8424299,0.26287683],[0.57556297,0.84456561,0.25641457],[0.58567772,0.84666139,
0.24989748],[0.59583934,0.84871722,0.24332878],[0.60604528,0.8507331,0.23671214],[0.61629283,0.85270912,0.23005179],[0.62657923,0.85464543,0.22335258],[0.63690157,0.85654226,0.21662012],[0.64725685,0.85839991,0.20986086],[0.65764197,0.86021878,0.20308229],[0.66805369,0.86199932,0.19629307],[0.67848868,0.86374211,0.18950326],[0.68894351,0.86544779,0.18272455],[0.69941463,0.86711711,0.17597055],[0.70989842,0.86875092,0.16925712],[0.72039115,0.87035015,0.16260273],[0.73088902,0.87191584,0.15602894],
[0.74138803,0.87344918,0.14956101],[0.75188414,0.87495143,0.14322828],[0.76237342,0.87642392,0.13706449],[0.77285183,0.87786808,0.13110864],[0.78331535,0.87928545,0.12540538],[0.79375994,0.88067763,0.12000532],[0.80418159,0.88204632,0.11496505],[0.81457634,0.88339329,0.11034678],[0.82494028,0.88472036,0.10621724],[0.83526959,0.88602943,0.1026459],[0.84556056,0.88732243,0.09970219],[0.8558096,0.88860134,0.09745186],[0.86601325,0.88986815,0.09595277],[0.87616824,0.89112487,0.09525046],[0.88627146,0.89237353,
0.09537439],[0.89632002,0.89361614,0.09633538],[0.90631121,0.89485467,0.09812496],[0.91624212,0.89609127,0.1007168],[0.92610579,0.89732977,0.10407067],[0.93590444,0.8985704,0.10813094],[0.94563626,0.899815,0.11283773],[0.95529972,0.90106534,0.11812832],[0.96489353,0.90232311,0.12394051],[0.97441665,0.90358991,0.13021494],[0.98386829,0.90486726,0.13689671],[0.99324789,0.90615657,0.1439362]]));a.checkNew(new a.Command({name:"analysis",alias:"run",help:"list/run analysis for current image",get:function(){var a,
b,c,d,e,f="",g=this.image;if(g&&g.analysisPackages)for(b=0;b<g.analysisPackages.length;b++){e=g.analysisPackages[b];for(a=0;a<e.length;a++)d=e[a],f&&(f+=", "),c=d.xclass?d.xclass+":"+d.name:d.name,f+=sprintf("%s (%s)",d.title,c);b<g.analysisPackages.length-1&&(f+="\n")}return f},set:function(b){var c,d=this.image;d&&((c=d.lookupAnalysis(b[0]))?c.purl?(b=d.displayAnalysis("params",a.InstallDir(c.purl),c.title+": "+d.fitsFile),$(b).data("dispid",d.display.id).data("aname",c.name)):d.runAnalysis(c.name):
a.error("unknown analysis command '"+b[0]+"'"))}}));a.checkNew(new a.Command({name:"colormap",alias:"cmap",help:"set/get colormap for current image",get:function(){var a;if(a=this.image)return a=a.getColormap(),sprintf("%s %s %s",a.colormap,a.contrast,a.bias)},set:function(a){var b=this.image;b&&b.setColormap.apply(b,a)}}));a.checkNew(new a.Command({name:"colormaps",alias:"cmaps",help:"get list of available colormaps",get:function(){var b,c="";for(b=0;b<a.colormaps.length;b++)c&&(c+=", "),c+=a.colormaps[b].name;
return c}}));a.checkNew(new a.Command({name:"help",help:"get list of available commmands",get:function(){var b,c,d;d="<table>";for(b=0;b<a.commands.length;b++)c=a.commands[b],d+="<tr><td>"+c.name+"</td><td>"+c.help,c.alias&&(d+=" ("+c.alias,c.alias2&&(d+=", "+c.alias2),d+=")"),d+="</td></tr>";return d+"</table>"}}));a.checkNew(new a.Command({name:"helper",help:"get/set helper connection",get:function(){return a.helper.connectinfo()},set:function(b){a.helper.connect(b[0].trim())}}));a.checkNew(new a.Command({name:"image",
help:"get name of currently loaded image or display specified image",get:function(){var a=this.image;if(a)return a.file},set:function(b){var c,d;for(c=0;c<a.images.length;c++)if(d=a.images[c],0<=d.file.search(b[0])&&d.display===this.display){d.displayImage("display");break}}}));a.checkNew(new a.Command({name:"images",help:"get list of currently loaded images",get:function(){var b,c,d="";for(b=0;b<a.images.length;b++)c=a.images[b],c.display===this.display&&(d&&(d+=", "),d+=c.file);return d}}));a.checkNew(new a.Command({name:"load",
help:"load image(s)",set:function(b){var c;for(c=0;c<b.length;c++)a.Load(b[c],{display:this.display.id})}}));a.checkNew(new a.Command({name:"pan",help:"set/get pan location for current image",get:function(){var a;if(a=this.image)return a=a.getPan(),sprintf("%s %s",a.x,a.y)},set:function(a){var b=this.image;b&&b.setPan.apply(b,a)}}));a.checkNew(new a.Command({name:"pix2wcs",help:"get image pixel value for specified wcs position",set:function(b){var c=this.image;if(c)return b=a.Pix2WCS(parseFloat(b[0]),
parseFloat(b[1]),{display:c}),b.str}}));a.checkNew(new a.Command({name:"print",help:"print image window",get:function(){var a=this.image;a&&a.print()}}));a.checkNew(new a.Command({name:"regions",alias:"reg",alias2:"region",help:"add region to current image or list all regions",get:function(){var a=this.image;if(a)return a.listRegions("all",0)||""},set:function(a){var b=this.image;b&&("delete"===a[0]||"remove"===a[0]?(a=a.slice(1).join(" "),b.removeShapes("regions",a)):(a=a.join(" "),b.addShapes("regions",
a)))}}));a.checkNew(new a.Command({name:"resize",help:"get/set display size for current image",get:function(){var a;if(a=this.image)return a=a.display,sprintf("%s %s",a.width,a.height)},set:function(a){var b;b=this.image;var c;b&&a.length&&(b=b.display,c=parseInt(a[0],10),a=1<a.length?parseInt(a[1],10):c,b.resize(c,a))}}));a.checkNew(new a.Command({name:"scale",help:"set/get scaling for current image",get:function(){var a;if(a=this.image)return a=a.getScale(),sprintf("%s %s %s",a.scale,a.scalemin,
a.scalemax)},set:function(a){var b=this.image;b&&b.setScale.apply(b,a)}}));a.checkNew(new a.Command({name:"scales",help:"get list of available scales",get:function(){return a.scales.join(", ")}}));a.checkNew(new a.Command({name:"status",help:"get status for specified (or current) image",get:function(b){var c,d,e,f="";for(c=0;c<a.images.length;c++)if(d=a.images[c],0<=d.file.search(b[0])){e=d;break}e?c=1:(c=0,e=this.image);if(e){if(c>b.length)return e.status.load;for(;c<b.length;c++)switch(d=b[c].toLowerCase().trim(),
d){case "load":f&&(f+="\n"),f+=e.status.load}}return f}}));a.checkNew(new a.Command({name:"url",help:"display a url",set:function(b){a.DisplayHelp(b[0])}}));a.checkNew(new a.Command({name:"wcssys",help:"set/get wcs system for current image",get:function(){var a=this.image;if(a)return a.getWCSSys()},set:function(a){var b=this.image;b&&b.setWCSSys(a[0])}}));a.checkNew(new a.Command({name:"wcsu",help:"set/get wcs units used for current image",get:function(){var a=this.image;if(a)return a.getWCSUnits()},
set:function(a){var b=this.image;b&&b.setWCSUnits(a[0])}}));a.checkNew(new a.Command({name:"wcssystems",help:"get list of available wcs systems",get:function(){return a.wcssyss.join(", ")}}));a.checkNew(new a.Command({name:"wcsunits",help:"get list of available wcs units",get:function(){return a.wcsunitss.join(", ")}}));a.checkNew(new a.Command({name:"wcs2pix",help:"get wcs position for specified image pixel",set:function(b){var c=this.image;if(c)return b=a.WCS2Pix(parseFloat(b[0]),parseFloat(b[1]),
{display:c}),b.str}}));a.checkNew(new a.Command({name:"zoom",help:"set/get zoom for current image",get:function(){var a=this.image;if(a)return a.getZoom()},set:function(a){var b=this.image;b&&b.setZoom(a[0])}}));a.helper=new a.Helper;$(document).on("keyup keypress",".js9AnalysisForm",function(a){if(13===(a.keyCode||a.which))return a.preventDefault(),!1});$(document).scrollTop(0)};a.parsePublicArgs=function(a){var c=null;a=Array.prototype.slice.call(a);var b=a[a.length-1];b&&("object"===typeof b&&
b.hasOwnProperty("display")&&1===Object.keys(b).length)&&(c=b.display,a.pop());return{argv:a,display:c}};a.mkPublic=function(d,c){"string"===typeof c?a.Image.prototype[c]?(a[d]=function(){var b;b=a.parsePublicArgs(arguments);var d=a.getImage(b.display);if(d)return b=d[c].apply(d,b.argv),b===d||b===d.display?"OK":b},a.publics[d]=a[d]):a.error("unknown image function for mkPublic: "+c):"function"===typeof c?(a[d]=c,a.publics[d]=a[d]):a.error("unsupported type for mkPublic: "+typeof c)};a.mkPublic("CloseImage",
"closeImage");a.mkPublic("DisplayImage","displayImage");a.mkPublic("DisplayExtension","displayExtension");a.mkPublic("BlendImage","blendImage");a.mkPublic("GetColormap","getColormap");a.mkPublic("SetColormap","setColormap");a.mkPublic("GetZoom","getZoom");a.mkPublic("SetZoom","setZoom");a.mkPublic("GetPan","getPan");a.mkPublic("SetPan","setPan");a.mkPublic("GetScale","getScale");a.mkPublic("SetScale","setScale");a.mkPublic("GetValPos","updateValpos");a.mkPublic("ImageToDisplayPos","imageToDisplayPos");
a.mkPublic("DisplayToImagePos","displayToImagePos");a.mkPublic("ImageToLogicalPos","imageToLogicalPos");a.mkPublic("LogicalToImagePos","logicalToImagePos");a.mkPublic("GetWCSUnits","getWCSUnits");a.mkPublic("SetWCSUnits","setWCSUnits");a.mkPublic("GetWCSSys","getWCSSys");a.mkPublic("SetWCSSys","setWCSSys");a.mkPublic("ShowShapeLayer","showShapeLayer");a.mkPublic("AddShapes","addShapes");a.mkPublic("RemoveShapes","removeShapes");a.mkPublic("GetShapes","getShapes");a.mkPublic("ChangeShapes","changeShapes");
a.mkPublic("Print","print");a.mkPublic("SavePNG","savePNG");a.mkPublic("SaveJPEG","saveJPEG");a.mkPublic("SaveFITS","saveFITS");a.mkPublic("RunAnalysis","runAnalysis");a.mkPublic("DisplayMessage","displayMessage");a.mkPublic("RawDataLayer","rawDataLayer");a.mkPublic("ShiftData","shiftData");a.mkPublic("GaussBlurData","gaussBlurData");a.mkPublic("ReprojectData","reprojectData");a.mkPublic("FilterRGBImage","filterRGBImage");a.mkPublic("MoveToDisplay","moveToDisplay");a.mkPublic("AddColormap",function(d,
c,b,e){var f,g,h=a.parsePublicArgs(arguments),j=function(b){b.vertices?a.AddColormap(b.name,b.vertices[0],b.vertices[1],b.vertices[2]):b.colors?a.AddColormap(b.name,b.colors):a.error("invalid colormap object for JS9.AddColormap()")};if(h.argv[0]instanceof Blob)f=new FileReader,f.onload=function(b){try{g=JSON.parse(b.target.result)}catch(c){a.error("can't parse json colormap",c)}j(g)},f.readAsText(h.argv[0]);else if("object"===typeof h.argv[0])j(h.argv[0]);else switch(h.argv.length){case 1:try{g=JSON.parse(d)}catch(k){a.error("can't parse JSON colormap",
k)}j(g);break;case 2:a.checkNew(new a.Colormap(d,c));break;case 4:a.checkNew(new a.Colormap(d,c,b,e));break;default:a.error("AddColormap() requires a colormap name and 1 or 3 args")}});a.mkPublic("SetValPos",function(d){var c=null,b=a.parsePublicArgs(arguments),e=a.getImage(b.display);e&&(d=b.argv[0],c=e.params.valpos,e.params.valpos=d);return c});a.mkPublic("Load",function(d,c){var b,e,f;e=a.parsePublicArgs(arguments);d=e.argv[0];c=e.argv[1];if(d)if(e=e.display?e.display:0<a.displays.length?a.displays[0].id:
a.DEFID,c=c||{},c.display=c.display||e,c.onload?f=c.onload:a.imageOpts.onload&&(f=a.imageOpts.onload,c.onload=f),d instanceof Blob){if(d.name){if(e=a.lookupImage(d.name,e)){e.displayImage("display",c);e.refreshLayers();e.clearMessage();return}c.filename=d.name}c.filename||(c.filename=a.ANON);if(a.fits.handleFITSFile){e=$.extend(!0,{},c,a.fits.options);try{a.fits.handleFITSFile(d,e,a.NewFitsImage)}catch(g){a.error("can't process FITS file",g)}}else a.error("no FITS module available to load this FITS blob")}else if("object"===
typeof d)a.checkNew(new a.Image(d,c,f));else if("string"!==typeof d&&a.error("unknown file type for Load: "+typeof d),"U0lNUExFICA9"===d.slice(0,12)&&(d=window.atob(d)),"SIMPLE  ="===d.slice(0,9)){e=[];for(b=0;b<d.length;b++)e[b]=d.charCodeAt(b);b=new Blob([new Uint8Array(e)]);c.filename||(c.filename=a.ANON);b.name=c.filename;if(a.fits.handleFITSFile){e=$.extend(!0,{},c,a.fits.options);try{a.fits.handleFITSFile(b,e,a.NewFitsImage)}catch(h){a.error("can't process FITS file",h)}}else a.error("no FITS module available to process this memory FITS")}else(e=
a.lookupImage(d,e))?(e.displayImage("display",c),e.clearMessage()):(d=d.trim(),e=d.split(".").pop().toLowerCase(),"png"===e?a.globalOpts.pngisfits?a.checkNew(new a.Image(d,c,f)):a.fetchURL(null,d,c,a.NewFitsImage):c.fits2png||void 0===c.fits2png&&a.globalOpts.fits2png?a.helper.connected?a.helper.send("fits2png",{fits:d},function(b){var d;b="object"===typeof b?b:0<=b.search(a.analOpts.epattern)?{stderr:b}:{stdout:b};b.stderr&&a.error(b.stderr,a.analOpts.epattern);b.stdout&&(b=b.stdout.replace(/\n*$/,
"").split("\n").pop(),d=b.split(".").pop().toLowerCase(),"png"===d?a.checkNew(new a.Image(b,c,f)):a.error("fits2png conversion failed: "+b))}):a.error("no JS9 helper available to convert image: "+d):(c.display&&(b=a.lookupDisplay(c.display))&&(b=b.divjq[0]),a.waiting(!0,b),b=d.replace(/\[.*\]/,""),a.fetchURL(d,b,c,a.NewFitsImage)));else a.error("JS9.Load: no file specified for image load")});a.mkPublic("SaveRegions",function(d,c){var b;b=a.parsePublicArgs(arguments);return(b=a.getImage(b.display))?
b.saveRegions(d,c):d});a.mkPublic("LoadRegions",function(d,c){var b,e;e=a.parsePublicArgs(arguments);d=e.argv[0];c=e.argv[1]||{};d||a.error("JS9.LoadRegions: no file specified for regions load");b=e.display?e.display:c.display?c.display:0<a.displays.length?a.displays[0].id:a.DEFID;"object"===typeof d?(e=new FileReader,e.onload=function(d){a.AddRegions(d.target.result,c,{display:b})},e.readAsText(d)):"string"===typeof d?(c.responseType="text",c.display=b,a.fetchURL(null,d,c,a.AddRegions)):a.error("unknown file type for LoadRegions: "+
typeof d)});a.mkPublic("LoadWindow",function(d,c,b,e,f){var g;g=(b||"")+"win";c=c||{};switch(b){case "light":return c.id?(b=c.id,delete c.id):b=g+a.uniqueID(),g="d"+b,e=e||sprintf("<hr class='hline0'><div class='JS9Menubar' id='%sMenubar'></div><div class='JS9' id='%s'></div>",b,b),f=f||a.lightOpts[a.LIGHTWIN].imageWin,a.lightWin(g,"inline",e,d,f),a.checkNew(new a.Display(b)),a.helper.send("addDisplay",{display:b}),a.instantiatePlugins(),c.display=b,d&&a.Load(d,c),b;case "new":return c.id?(b=c.id,
delete c.id):b=g+a.uniqueID(),f=document.getElementsByTagName("head")[0].innerHTML,!f.match(/src=["'].*js9\.js/)&&!f.match(/src=["'].*js9\.min\.js/)&&(f+=sprintf('<%s type="text/javascript" src="js9.min.js"></%s>',"script","script")),g=e||sprintf("<div class='JS9Menubar' id='%sMenubar'></div><div class='JS9' id='%s'></div>",b,b),e=sprintf("<html><head>%s</head><body",f),d&&(e+=sprintf(" onload='JS9.Preload(\"%s\",%s);'",d,JSON.stringify(c))),e+=sprintf(">%s</body></html>\n",g),d=window.open(null,
b,"width=540, height=560"),d=d.document,d.open(),d.write(e),d.close(),b}});a.mkPublic("LoadProxy",function(d,c){var b,e,f=a.parsePublicArgs(arguments);d=f.argv[0];c=f.argv[1];a.globalOpts.loadProxy||a.error("proxy load not available for this server");a.globalOpts.workDir||a.error("proxy load requires a temp workDir this server");d||a.error("no url specified for proxy load");d=d.trim();d.match(/dropbox\.com/)?(d=d.replace("www.dropbox.com","dl.dropboxusercontent.com"),d=d.replace("?dl=0","")+"?raw=1"):
d.match(/drive\.google\.com/)&&(d=d.replace(/\/file\/d\/(\w+)\/\w+\?usp=sharing/,"/uc?export=download&id=$1"));f.display&&(e=a.lookupDisplay(f.display))&&(e=e.divjq[0]);a.waiting(!0,e);a.Send("loadproxy",{cmd:"js9Xeq loadproxy "+d},function(d){d="object"===typeof d?d:0<=d.search(a.analOpts.epattern)?{stderr:d}:{stdout:d};d.errcode=d.errcode||0;d.stderr?a.error(d.stderr):d.stdout?(c=c||{},void 0===c.fits2png&&(c.fits2png=!1),b=d.stdout.trim(),"/"!==b.charAt(0)&&(b=a.InstallDir(b)),c.proxyFile=b,a.Load(b,
c,{display:f.display})):a.error("internal error: no return from load proxy command")})});a.mkPublic("Preload",function(d){var c,b,e="",f=null,g=arguments.length;c=a.parsePublicArgs(arguments);d=c.argv[0];c.display&&(f={display:c.display},g-=1);switch(g){case 0:c=(null===a.helper.connected||a.helper.connected)&&0<a.preloads.length?2:3;break;case 1:c="boolean"===typeof d?0<a.preloads.length?2:3:null===a.helper.connected||a.helper.connected?1:0;break;default:c=null===a.helper.connected||a.helper.connected?
1:0}switch(c){case 0:for(c=0;c<g;c++)b=c+1,b<g&&"object"===typeof arguments[b]?(a.preloads.push([arguments[c],arguments[b],f]),c++):a.preloads.push([arguments[c],null,f]);break;case 1:a.globalOpts.alerts=!1;for(c=0;c<g;c++)if(b=c+1,b<g&&"object"===typeof arguments[b]){try{f?a.Load(arguments[c],arguments[b],f):a.Load(arguments[c],arguments[b])}catch(h){e=e+" "+arguments[c]}c++}else try{f?a.Load(arguments[c],null,f):a.Load(arguments[c],null)}catch(j){e=e+" "+arguments[c]}a.globalOpts.alerts=!0;e&&a.error("could not preload image(s): "+
e);break;case 2:a.globalOpts.alerts=!1;for(c=0;c<a.preloads.length;c++)try{a.preloads[c][2]?a.Load(a.preloads[c][0],a.preloads[c][1],a.preloads[c][2]):a.Load(a.preloads[c][0],a.preloads[c][1])}catch(k){e=e+" "+a.preloads[c][0]}a.globalOpts.alerts=!0;e&&a.error("could not preload image(s): "+e);a.preloads=[]}});a.mkPublic("RefreshImage",function(d,c){var b=a.parsePublicArgs(arguments),e=a.getImage(b.display),f=function(b){a.Image.prototype.refreshImage.call(e,b,c)};d=b.argv[0];c=b.argv[1]||{};if(e)if(d instanceof
Blob)if(a.fits.handleFITSFile){!c.rawid&&(a.fits.cleanupFITSFile&&e.raw.hdu&&e.raw.hdu.fits)&&a.fits.cleanupFITSFile(e.raw.hdu.fits,!0);try{a.fits.handleFITSFile(d,a.fits.options,f)}catch(g){a.error("can't refresh FITS file",g)}}else a.error("no FITS module available to refresh this image");else a.Image.prototype.refreshImage.apply(e,b.argv);else d instanceof Blob&&a.Load.apply(null,arguments)});a.mkPublic("GetLoadStatus",function(d){var c=a.parsePublicArgs(arguments),b=a.getImage(c.display);return b?
(d=c.argv[0],!d||b.oid===d?b.status.load:"other"):"none"});a.mkPublic("OpenFileMenu",function(){var d=a.parsePublicArgs(arguments);(d=a.lookupDisplay(d.display))&&$("#openLocalFile-"+d.id).click()});a.mkPublic("OpenRegionsMenu",function(){var d=a.parsePublicArgs(arguments);(d=a.lookupDisplay(d.display))&&$("#openLocalRegions-"+d.id).click()});a.mkPublic("OpenColormapMenu",function(){var d=a.parsePublicArgs(arguments);(d=a.lookupDisplay(d.display))&&$("#openLocalColormap-"+d.id).click()});a.mkPublic("SaveColormap",
function(d){var c,b=a.parsePublicArgs(arguments);if(window.hasOwnProperty("saveAs")){if(c=a.getImage(b.display))d=b.argv[0]||"js9.cmap",c=$.extend(!0,{},c.cmapObj),delete c.type,c=JSON.stringify(c),c=new Blob([c],{type:"text/plain"}),saveAs(c,d)}else a.error("no saveAs function available to save colormap");return d});a.mkPublic("DisplayPlugin",function(d){var c,b,e,f;c=a.parsePublicArgs(arguments);var g=a.lookupDisplay(c.display);if(g&&c.argv[0]){d=c.argv[0];f=d.toLowerCase();for(c=0;c<a.plugins.length;c++)if(b=
a.plugins[c],e=b.name,e===d||e.toLowerCase().substr(-f.length)===f){g.displayPlugin(b);return}a.error("can't find plugin: "+d)}});a.mkPublic("NewFitsImage",function(d,c){var b;c&&c.onload&&(b=c.onload);a.checkNew(new a.Image(d,c,b))});a.mkPublic("GetImage",function(d){var c;d&&"string"!==typeof d&&(c=a.parsePublicArgs(arguments),d=c.display);return a.getImage(d)});a.mkPublic("GetImageData",function(d){var c=a.parsePublicArgs(arguments),b=a.getImage(c.display);return b?(d=c.argv[0],b.getImageData(d)):
null});a.mkPublic("GetDisplayData",function(d){var c,b,e,f=[];c=a.parsePublicArgs(arguments);b=c.display||a.displays[0].id;d=c.argv[0];for(c=0;c<a.images.length;c++)e=a.images[c],e.display.id===b&&f.push(e.getImageData(d));return f});a.mkPublic("GetFITSHeader",function(d){var c="",b=a.parsePublicArgs(arguments),e=a.getImage(b.display);e&&e.raw&&(d=b.argv[0],c=a.raw2FITS(e.raw,d));return c});a.mkPublic("BlendDisplay",function(d){var c,b,e=[],f=a.parsePublicArgs(arguments).display||a.DEFID;(c=a.lookupDisplay(f))||
a.error("no JS9 display found: "+f);if(void 0===d||"mode"===d)return c.blendMode;if("list"===d){for(c=0;c<a.images.length;c++)b=a.images[c],b.display.id===f&&b.blend.active&&e.push(b.id);return e}c.blendMode=!!d;c.image&&c.image.displayImage();return c.blendMode});a.mkPublic("LoadAuxFile",function(d,c){var b=a.parsePublicArgs(arguments),e=a.getImage(b.display);e?(d=b.argv[0],c=b.argv[1],e.loadAuxFile(d,c)):a.error("could not find image for aux file: "+d)});a.mkPublic("SubmitAnalysis",function(d,c,
b){var e,f,g;e=a.lightOpts[a.LIGHTWIN];var h=a.parsePublicArgs(arguments);d=h.argv[0];c=h.argv[1];b=h.argv[2];c?e=a.lookupDisplay(h.display).id:(e=$(d).closest(e.top),c=e.data("aname"),e=e.data("dispid"));c?e&&(f=a.getImage(e)):g="internal error: could not find analysis task name";if(f){e=$(d).closest("form");try{h=e.serializeArray()}catch(j){h=null}f.runAnalysis(c,h,b)}else g="internal error: could not find image";g&&a.error(g);return!1});a.mkPublic("Send",function(d,c,b){a.helper.connected?a.helper.send(d,
c,b):a.error("no JS9 helper available")});a.mkPublic("EventToDisplayPos",function(d){return a.eventToDisplayPos(d)});a.mkPublic("PixToWCS",function(d,c){var b,e,f=1;b=a.parsePublicArgs(arguments);var g=a.getImage(b.display);if(g&&(d=b.argv[0],c=b.argv[1],(!a.isNumber(d)||!a.isNumber(c))&&a.error("invalid input for PixToWCS"),0<g.wcs))return b=a.pix2wcs(g.wcs,d,c).trim(),e=b.split(/ +/),"sexagesimal"===g.params.wcsunits&&("galactic"!==g.params.wcssys&&"ecliptic"!==g.params.wcssys)&&(f=15),{ra:a.saostrtod(e[0])*
f,dec:a.saostrtod(e[1]),sys:e[2],str:b}});a.Pix2WCS=a.PixToWCS;a.mkPublic("WCSToPix",function(d,c){var b,e,f;e=a.parsePublicArgs(arguments);if(b=a.getImage(e.display))if(d=e.argv[0],c=e.argv[1],(!a.isNumber(d)||!a.isNumber(c))&&a.error("invalid input for WCSToPix"),0<b.wcs)return b=a.wcs2pix(b.wcs,d,c).trim().split(/ +/),e=parseFloat(b[0]),f=parseFloat(b[1]),b=sprintf("%f %f",e,f),{x:e,y:f,str:b};return null});a.WCS2Pix=a.WCSToPix;a.mkPublic("DisplayHelp",function(d){var c,b,e=a.lightOpts.dhtml.textWin,
f;d&&(b=d.split("/").reverse()[0],c="help_"+a.uniqueID(),(f=a.helpOpts[d])?(d=a.InstallDir(f.type+"/"+f.url),a.lightWin(c,"iframe",d,f.title||b,e)):a.lightWin(c,"iframe",d,b,e))});a.mkPublic("NewShapeLayer",function(d,c){var b=a.parsePublicArgs(arguments),e=a.getImage(b.display);return e?(d=b.argv[0],c=b.argv[1],e.display.newShapeLayer(d,c)):null});a.mkPublic("AddRegions",function(d,c){var b=a.parsePublicArgs(arguments),e=a.getImage(b.display);return e?(d=b.argv[0],c=b.argv[1],d||a.error("no region specified for AddRegions"),
c=b.argv[1],e.addShapes("regions",d,c)):null});a.mkPublic("RemoveRegions",function(d){var c=a.parsePublicArgs(arguments),b=a.getImage(c.display);return b?(d=c.argv[0],b.removeShapes("regions",d),b.clearMessage("regions"),"OK"):null});a.mkPublic("GetRegions",function(d){var c=a.parsePublicArgs(arguments),b=a.getImage(c.display);return b?(c.argv.unshift("regions"),b.getShapes.apply(b,c.argv)):null});a.mkPublic("ChangeRegions",function(d,c){var b=a.parsePublicArgs(arguments),e=a.getImage(b.display);
e&&((d=b.argv[0])||a.error("no region specified for GetRegions"),c=b.argv[1],e.changeShapes("regions",d,c));return null});a.mkPublic("InstallDir",function(d){return a.INSTALLDIR+d});a.mkPublic("AddDivs",function(){var d,c=a.parsePublicArgs(arguments);for(d=0;d<c.argv.length;d++)a.checkNew(new a.Display(c.argv[d]));a.instantiatePlugins()});a.mkPublic("ResizeDisplay",function(){var d;d=a.parsePublicArgs(arguments);var c=a.lookupDisplay(d.display);c||a.error("invalid display for resize");d=a.Display.prototype.resize.apply(c,
d.argv);d===c&&(d="OK");return d});return a}(JS9);$(document).ready(function(){JS9.init()});
